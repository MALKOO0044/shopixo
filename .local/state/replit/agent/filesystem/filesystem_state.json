{"file_contents":{"src/app/api/admin/cj/import/commit/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { isKillSwitchOn } from '@/lib/settings'\nimport { createClient } from '@supabase/supabase-js'\nimport { mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { calculateRetailSar, usdToSar } from '@/lib/pricing'\nimport { hasTable } from '@/lib/db-features'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) return NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n    if (await isKillSwitchOn()) return NextResponse.json({ ok: false, error: 'Kill switch is ON' }, { status: 423 })\n\n    const admin = getAdmin()\n    if (!admin) return NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n    const db = admin\n\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const items: Array<{ cj_product_id: string; includeSkus?: string[]; category?: string; margin?: number; handlingSar?: number; cjCurrency?: 'USD'|'SAR' }> = Array.isArray(body?.selected) ? body.selected : []\n    if (!items || items.length === 0) return NextResponse.json({ ok: false, error: 'selected array required' }, { status: 400 })\n\n    const results: any[] = []\n\n    for (const it of items) {\n      try {\n        const pid = String(it.cj_product_id)\n        const raw = await queryProductByPidOrKeyword({ pid })\n        const base = Array.isArray((raw as any)?.data?.content) ? (raw as any).data.content[0] : ((raw as any).data || raw)\n        const cj = mapCjItemToProductLike(base)\n        if (!cj) throw new Error('CJ map failed')\n\n        // Collect product payload\n        const images = cj.images || []\n        const video = cj.videoUrl || null\n        const category = it.category || 'General'\n        const origin_area = (cj as any).originArea ?? null\n        const origin_country_code = (cj as any).originCountryCode ?? null\n        const delivery_time_hours = (cj as any).deliveryTimeHours ?? null\n        const processing_time_hours = (cj as any).processingTimeHours ?? null\n        // Try to derive a description from raw CJ base object\n        const description = (() => {\n          const fields = ['description','detail','details','productDescription','desc','salePoint','sellingPoint','sellingPoints'];\n          for (const k of fields) {\n            const v: any = (base as any)?.[k as any];\n            if (typeof v === 'string' && v.trim()) return v.trim();\n            if (Array.isArray(v)) {\n              const s = v.map(x => (typeof x === 'string' ? x : '')).filter(Boolean).join('\\n');\n              if (s.trim()) return s.trim();\n            }\n          }\n          return '';\n        })()\n\n        // Compute variant-level retail and totals\n        const variants = (cj.variants || [])\n        const rows: any[] = []\n        let stockSum = 0\n        let minRetailSansShip: number | null = null\n        for (const v of variants) {\n          // Filter by includeSkus if provided\n          if (Array.isArray(it.includeSkus) && it.includeSkus.length > 0) {\n            const sku = v.cjSku || null\n            if (!sku || !it.includeSkus.includes(sku)) continue\n          }\n          const costUSD = typeof v.price === 'number' ? v.price : undefined\n          const supplierCostSar = typeof costUSD === 'number' ? (it.cjCurrency === 'USD' ? usdToSar(costUSD) : costUSD) : undefined\n          // build conservative dims/weights if absent\n          const weightG = typeof v.weightGrams === 'number' ? Math.max(0, v.weightGrams) : undefined\n          const L = typeof v.lengthCm === 'number' ? v.lengthCm : 25\n          const W = typeof v.widthCm === 'number' ? v.widthCm : 20\n          const H = typeof v.heightCm === 'number' ? v.heightCm : 3\n          const actualKg = typeof weightG === 'number' ? Math.max(0.05, weightG / 1000) : 0.3\n\n          let retailSar: number | null = null\n          let ddpShippingSar: number | null = null\n          let landedCostSar: number | null = null\n          if (typeof supplierCostSar === 'number' && supplierCostSar > 0) {\n            const calc = calculateRetailSar(supplierCostSar, { actualKg, lengthCm: L, widthCm: W, heightCm: H }, { margin: it.margin ?? 0.35, handlingSar: it.handlingSar ?? 0 })\n            retailSar = calc.retailSar\n            ddpShippingSar = calc.ddpShippingSar\n            landedCostSar = calc.landedCostSar\n            const sansShip = Math.max(0, retailSar - ddpShippingSar)\n            if (minRetailSansShip === null || sansShip < minRetailSansShip) minRetailSansShip = sansShip\n          }\n\n          const stock = typeof v.stock === 'number' ? v.stock : 0\n          stockSum += stock\n\n          const color = (v as any).color || null\n          const size = (v as any).size || null\n          const optionValue = color ? (size ? `${color} / ${size}` : color) : (size || '-')\n          rows.push({\n            option_name: 'Variant',\n            option_value: optionValue,\n            cj_sku: v.cjSku || null,\n            price: typeof retailSar === 'number' ? retailSar : null,\n            stock,\n            weight_grams: typeof weightG === 'number' ? Math.round(weightG) : null,\n            length_cm: typeof v.lengthCm === 'number' ? v.lengthCm : null,\n            width_cm: typeof v.widthCm === 'number' ? v.widthCm : null,\n            height_cm: typeof v.heightCm === 'number' ? v.heightCm : null,\n            supplier_cost_sar: typeof supplierCostSar === 'number' ? supplierCostSar : null,\n            ddp_shipping_sar: typeof ddpShippingSar === 'number' ? ddpShippingSar : null,\n            landed_cost_sar: typeof landedCostSar === 'number' ? landedCostSar : null,\n            retail_sar: typeof retailSar === 'number' ? retailSar : null,\n            retail_updated_at: new Date().toISOString(),\n          })\n        }\n\n        // Upsert product\n        const { data: existing } = await db.from('products').select('id, slug').eq('cj_product_id', cj.productId).maybeSingle()\n        // Ensure unique slug, prefer existing slug else cj.productId\n        async function ensureUniqueSlug(base: string): Promise<string> {\n          let s = base.toLowerCase().replace(/[^a-z0-9\\-]+/g, '-').replace(/^-+|-+$/g, '') || base;\n          let candidate = s; let i = 2;\n          while (true) {\n            const { data } = await db.from('products').select('id').eq('slug', candidate).maybeSingle();\n            if (!data) return candidate;\n            candidate = `${s}-${i++}`;\n          }\n        }\n        const slug = existing?.slug || await ensureUniqueSlug(cj.productId)\n        const basePayload: any = {\n          title: cj.name,\n          slug,\n          description,\n          price: typeof minRetailSansShip === 'number' ? minRetailSansShip : 0,\n          images,\n          category,\n          stock: stockSum,\n          video_url: video,\n          processing_time_hours,\n          delivery_time_hours,\n          origin_area,\n          origin_country_code,\n          cj_product_id: cj.productId,\n          is_active: true,\n        }\n        let productId: number\n        if (existing?.id) {\n          const { data: upd, error } = await db.from('products').update(basePayload).eq('id', existing.id).select('id').single()\n          if (error || !upd) throw error || new Error('Update failed')\n          productId = upd.id as number\n          await db.from('product_variants').delete().eq('product_id', productId)\n        } else {\n          const { data: ins, error } = await db.from('products').insert(basePayload).select('id').single()\n          if (error || !ins) throw error || new Error('Insert failed')\n          productId = ins.id as number\n        }\n\n        const hasVariants = await hasTable('product_variants').catch(() => true)\n        if (hasVariants && rows.length > 0) {\n          const finalRows = rows.map(r => ({ ...r, product_id: productId }))\n          const { error } = await db.from('product_variants').insert(finalRows)\n          if (error) throw error\n        }\n        try { await db.rpc('recompute_product_stock', { product_id_in: productId }) } catch {}\n\n        results.push({ ok: true, productId, cjPid: cj.productId, title: cj.name })\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e) })\n      }\n    }\n\n    return NextResponse.json({ ok: true, results })\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'commit failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":8923,"size_tokens":null},"src/app/layout.tsx":{"content":"import \"@/app/globals.css\";\nimport type { Metadata } from \"next\";\nimport { Inter, Playfair_Display } from \"next/font/google\";\nimport Header from \"@/components/header\";\nimport AnnouncementBar from \"@/components/announcement-bar\";\nimport NavigationBar from \"@/components/navigation-bar\";\nimport Footer from \"@/components/footer\";\nimport CookieConsent from \"@/components/cookie-consent\";\nimport { ThemeProvider } from \"@/components/theme-provider\";\nimport { Suspense } from \"react\";\nimport { ToastProvider } from \"@/components/ui/toast-provider\";\nimport { getSiteUrl } from \"@/lib/site\";\nimport Script from \"next/script\";\nimport { headers } from \"next/headers\";\nimport ChatWidget from \"@/components/chat-widget\";\n\nconst inter = Inter({ subsets: [\"latin\"], variable: \"--font-inter\" });\nconst playfair = Playfair_Display({ subsets: [\"latin\"], weight: [\"400\",\"600\",\"700\"], variable: \"--font-playfair\" });\nconst rawSiteUrl =\n  process.env.NEXT_PUBLIC_SITE_URL ||\n  (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"http://localhost:3000\");\nconst siteUrl = (() => {\n  try {\n    // Ensure an absolute, valid URL string (includes protocol)\n    return new URL(rawSiteUrl).toString();\n  } catch {\n    return \"http://localhost:3000\";\n  }\n})();\n\n// Use the composite header logo (star + wordmark) as brand image in meta\nconst brandLogo = \"/logo-header.svg\";\nconst absoluteBrandLogo = `${getSiteUrl()}${brandLogo}`;\n\nexport const metadata: Metadata = {\n  metadataBase: new URL(siteUrl),\n  title: {\n    default: \"Shopixo — Modern Online Store\",\n    template: \"%s — Shopixo\",\n  },\n  description: \"Shopixo is a modern, professional online store.\",\n  // Use dedicated icons in public/ for favicon + apple\n  icons: {\n    icon: [\n      \"/favicon.ico\",\n      { url: \"/favicon-32x32.png\", type: \"image/png\", sizes: \"32x32\" },\n      { url: \"/favicon-16x16.png\", type: \"image/png\", sizes: \"16x16\" },\n    ],\n    apple: \"/apple-touch-icon.png\",\n  },\n  manifest: \"/manifest.webmanifest\",\n  openGraph: {\n    type: \"website\",\n    url: siteUrl,\n    siteName: \"Shopixo\",\n    title: \"Shopixo — Modern Online Store\",\n    description: \"Shopixo is a modern, professional online store.\",\n    images: [brandLogo],\n  },\n  twitter: {\n    card: \"summary_large_image\",\n    title: \"Shopixo — Modern Online Store\",\n    description: \"Shopixo is a modern, professional online store.\",\n    images: [brandLogo],\n  },\n};\n\nexport const viewport = {\n  themeColor: \"#0b2c4f\",\n};\n\nexport const runtime = \"nodejs\";\n\nexport default function RootLayout({ children }: { children: React.ReactNode }) {\n  const nonce = headers().get('x-csp-nonce') || undefined;\n  return (\n    <html lang=\"en\" dir=\"ltr\" suppressHydrationWarning>\n      <body className={`${inter.variable} ${playfair.variable} ${inter.className} min-h-screen flex flex-col`}>\n        {/* Analytics: Plausible (loads only in production if domain is set) */}\n        {(() => {\n          try {\n            const analyticsDomain = process.env.NEXT_PUBLIC_PLAUSIBLE_DOMAIN || new URL(getSiteUrl()).hostname;\n            if (!analyticsDomain) return null;\n            return (\n              <Script\n                src=\"https://plausible.io/js/script.js\"\n                strategy=\"afterInteractive\"\n                data-domain={analyticsDomain as any}\n                nonce={nonce as any}\n              />\n            );\n          } catch {\n            return null;\n          }\n        })()}\n        <ThemeProvider>\n          <ToastProvider>\n            {/* Skip to content for accessibility */}\n            <a href=\"#main-content\" className=\"skip-link\">Skip to content</a>\n            {/* Announcement Bar */}\n            <AnnouncementBar />\n            {/* Site-wide Structured Data: Organization + WebSite with SearchAction */}\n            <script\n              nonce={nonce}\n              type=\"application/ld+json\"\n              dangerouslySetInnerHTML={{\n                __html: JSON.stringify({\n                  \"@context\": \"https://schema.org\",\n                  \"@type\": \"Organization\",\n                  name: process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\",\n                  url: getSiteUrl(),\n                  logo: absoluteBrandLogo,\n                  sameAs: [\n                    process.env.NEXT_PUBLIC_SOCIAL_FACEBOOK,\n                    process.env.NEXT_PUBLIC_SOCIAL_INSTAGRAM,\n                    process.env.NEXT_PUBLIC_SOCIAL_TWITTER,\n                    process.env.NEXT_PUBLIC_SOCIAL_YOUTUBE,\n                  ].filter(Boolean),\n                }),\n              }}\n            />\n            <script\n              nonce={nonce}\n              type=\"application/ld+json\"\n              dangerouslySetInnerHTML={{\n                __html: JSON.stringify({\n                  \"@context\": \"https://schema.org\",\n                  \"@type\": \"WebSite\",\n                  name: process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\",\n                  url: getSiteUrl(),\n                  potentialAction: {\n                    \"@type\": \"SearchAction\",\n                    target: `${getSiteUrl()}/search?q={search_term_string}`,\n                    \"query-input\": \"required name=search_term_string\",\n                  },\n                }),\n              }}\n            />\n            <Suspense fallback={null}>\n              <Header />\n            </Suspense>\n            <Suspense fallback={null}>\n              <NavigationBar />\n            </Suspense>\n            <Suspense fallback={null}>\n              <main id=\"main-content\" className=\"flex-1\">{children}</main>\n            </Suspense>\n            <Suspense fallback={null}>\n              <Footer />\n            </Suspense>\n            <Suspense fallback={null}>\n              <ChatWidget />\n            </Suspense>\n            <CookieConsent />\n          </ToastProvider>\n        </ThemeProvider>\n      </body>\n    </html>\n  );\n}\n","path":null,"size_bytes":5823,"size_tokens":null},"src/components/search-bar.tsx":{"content":"\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Input } from \"./ui/input\";\nimport { SearchIcon } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ntype Item = { id: number; slug: string; title: string; price: number; images?: string[] };\n\nfunction useDebouncedValue<T>(value: T, delay = 250) {\n  const [debounced, setDebounced] = useState(value);\n  useEffect(() => {\n    const id = setTimeout(() => setDebounced(value), delay);\n    return () => clearTimeout(id);\n  }, [value, delay]);\n  return debounced;\n}\n\nexport default function SearchBar() {\n  const router = useRouter();\n  const [q, setQ] = useState(\"\");\n  const [open, setOpen] = useState(false);\n  const [items, setItems] = useState<Item[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [active, setActive] = useState(-1);\n  const debounced = useDebouncedValue(q, 250);\n  const listRef = useRef<HTMLUListElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    let cancelled = false;\n    async function run() {\n      if (!debounced || debounced.trim().length < 2) {\n        setItems([]);\n        setOpen(false);\n        return;\n      }\n      setLoading(true);\n      try {\n        const res = await fetch(`/api/search?q=${encodeURIComponent(debounced.trim())}`);\n        const json = await res.json();\n        if (!cancelled) {\n          setItems((json?.items || []) as Item[]);\n          setOpen(true);\n          setActive(-1);\n        }\n      } catch {\n        if (!cancelled) {\n          setItems([]);\n          setOpen(false);\n        }\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    }\n    run();\n    return () => {\n      cancelled = true;\n    };\n  }, [debounced]);\n\n  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\n    e.preventDefault();\n    if (open && active >= 0 && items[active]) {\n      router.push(`/product/${items[active].slug}`);\n      setOpen(false);\n      return;\n    }\n    const formData = new FormData(e.currentTarget);\n    const query = (formData.get(\"q\") as string) || q;\n    router.push(query ? `/search?q=${encodeURIComponent(query)}` : `/search`);\n    setOpen(false);\n  }\n\n  function onKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (!open) return;\n    if (e.key === \"ArrowDown\") {\n      e.preventDefault();\n      setActive((prev) => Math.min(prev + 1, items.length - 1));\n    } else if (e.key === \"ArrowUp\") {\n      e.preventDefault();\n      setActive((prev) => Math.max(prev - 1, 0));\n    } else if (e.key === \"Enter\") {\n      if (active >= 0 && items[active]) {\n        e.preventDefault();\n        router.push(`/product/${items[active].slug}`);\n        setOpen(false);\n      }\n    } else if (e.key === \"Escape\") {\n      setOpen(false);\n    }\n  }\n\n  function onBlur() {\n    setTimeout(() => setOpen(false), 120);\n  }\n\n  return (\n    <form onSubmit={handleSubmit} className=\"relative w-full max-w-md\" role=\"search\">\n      <SearchIcon className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n      <Input\n        ref={inputRef}\n        type=\"search\"\n        name=\"q\"\n        placeholder=\"Search products...\"\n        aria-label=\"Search\"\n        autoComplete=\"off\"\n        className=\"w-full rounded-md bg-background pl-9 pr-4 py-2 text-sm\"\n        value={q}\n        onChange={(e) => setQ(e.target.value)}\n        onKeyDown={onKeyDown}\n        onFocus={() => items.length > 0 && setOpen(true)}\n        onBlur={onBlur}\n      />\n      {open && (\n        <div className=\"absolute left-0 right-0 top-[calc(100%+6px)] z-40 overflow-hidden rounded-md border bg-background shadow-xl\">\n          <ul ref={listRef} role=\"listbox\" aria-label=\"Suggestions\" className=\"max-h-80 overflow-auto\">\n            {loading && <li className=\"p-3 text-sm text-muted-foreground\">Searching...</li>}\n            {!loading && items.length === 0 && (\n              <li className=\"p-3 text-sm text-muted-foreground\">No results found</li>\n            )}\n            {items.map((it, idx) => (\n              <li\n                key={it.id}\n                role=\"option\"\n                aria-selected={active === idx}\n                className={cn(\n                  \"cursor-pointer px-3 py-2 text-sm hover:bg-muted\",\n                  active === idx && \"bg-muted\"\n                )}\n                onMouseEnter={() => setActive(idx)}\n                onMouseDown={(e) => {\n                  e.preventDefault();\n                  router.push(`/product/${it.slug}`);\n                  setOpen(false);\n                }}\n                title={it.title}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"relative h-9 w-9 overflow-hidden rounded bg-muted\">\n                    {/* eslint-disable-next-line @next/next/no-img-element */}\n                    <img\n                      src={(it.images && it.images[0]) || \"/placeholder.svg\"}\n                      alt={it.title}\n                      className=\"h-full w-full object-cover\"\n                      loading=\"lazy\"\n                      decoding=\"async\"\n                      onError={(e) => {\n                        const el = e.currentTarget as HTMLImageElement;\n                        if (!el.src.endsWith('/placeholder.svg')) el.src = '/placeholder.svg';\n                      }}\n                    />\n                  </div>\n                  <div className=\"min-w-0 flex-1\">\n                    <div className=\"truncate font-medium text-foreground\">{it.title}</div>\n                    <div className=\"text-xs text-muted-foreground\">\n                      {new Intl.NumberFormat(undefined, { style: 'currency', currency: (process.env.NEXT_PUBLIC_CURRENCY || 'USD') as any }).format(it.price || 0)}\n                    </div>\n                  </div>\n                </div>\n              </li>\n            ))}\n          </ul>\n        </div>\n      )}\n    </form>\n  );\n}\n","path":null,"size_bytes":5949,"size_tokens":null},"src/app/admin/console/scanner/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype ScannerSettings = {\n  enabled: boolean;\n  daily_report_time?: string | null;\n  low_stock_threshold?: number | null;\n  price_change_threshold?: number | null;\n};\n\ntype GetResp = { ok: boolean; settings?: ScannerSettings; error?: string };\n\ntype SaveResp = { ok: boolean; settings?: ScannerSettings; error?: string };\n\ntype WatchItem = {\n  id: number;\n  cj_product_id: string;\n  cj_sku: string | null;\n  threshold_low: number;\n  watch_price: boolean;\n  watch_stock: boolean;\n  created_at: string;\n};\n\ntype WatchListResp = { ok: boolean; watch?: WatchItem[]; error?: string };\n\ntype ActionResp = { ok: boolean; error?: string };\n\nexport default function ScannerSettingsPage() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [settings, setSettings] = useState<ScannerSettings>({ enabled: false, daily_report_time: \"09:00\", low_stock_threshold: 5, price_change_threshold: 5 });\n\n  const [watch, setWatch] = useState<WatchItem[]>([]);\n  const [wPid, setWPid] = useState(\"\");\n  const [wSku, setWSku] = useState(\"\");\n  const [wLow, setWLow] = useState(0);\n  const [wPrice, setWPrice] = useState(true);\n  const [wStock, setWStock] = useState(true);\n\n  async function loadAll() {\n    setLoading(true); setError(null);\n    try {\n      const [a, b] = await Promise.all([\n        fetch('/api/admin/scanner/settings', { cache: 'no-store' }),\n        fetch('/api/admin/scanner/watch', { cache: 'no-store' }),\n      ]);\n      const j1: GetResp = await a.json();\n      const j2: WatchListResp = await b.json();\n      if (!a.ok || !j1.ok) throw new Error(j1.error || `HTTP ${a.status}`);\n      if (!b.ok || !j2.ok) throw new Error(j2.error || `HTTP ${b.status}`);\n      setSettings(j1.settings!);\n      setWatch(j2.watch || []);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to load scanner');\n      setWatch([]);\n    } finally { setLoading(false); }\n  }\n\n  async function save() {\n    setSaving(true); setError(null);\n    try {\n      const r = await fetch('/api/admin/scanner/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(settings) });\n      const j: SaveResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n    } catch (e: any) {\n      setError(e?.message || 'Save failed');\n    } finally { setSaving(false); }\n  }\n\n  async function addWatch() {\n    setSaving(true); setError(null);\n    try {\n      const r = await fetch('/api/admin/scanner/watch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ cj_product_id: wPid, cj_sku: wSku || null, threshold_low: wLow, watch_price: wPrice, watch_stock: wStock }) });\n      const j: ActionResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setWPid(\"\"); setWSku(\"\"); setWLow(0); setWPrice(true); setWStock(true);\n      await loadAll();\n    } catch (e: any) {\n      setError(e?.message || 'Add failed');\n    } finally { setSaving(false); }\n  }\n\n  async function removeWatch(pid: string, sku?: string | null) {\n    setSaving(true); setError(null);\n    try {\n      const u = new URL('/api/admin/scanner/watch', window.location.origin);\n      u.searchParams.set('cj_product_id', pid);\n      if (sku) u.searchParams.set('cj_sku', sku);\n      const r = await fetch(u.toString(), { method: 'DELETE' });\n      const j: ActionResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await loadAll();\n    } catch (e: any) {\n      setError(e?.message || 'Delete failed');\n    } finally { setSaving(false); }\n  }\n\n  useEffect(() => { loadAll(); }, []);\n\n  return (\n    <div className=\"space-y-8\">\n      <header className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Scanner Settings</h1>\n        <Link href=\"/admin/console\" className=\"text-sm text-blue-600 hover:underline\">Back to Console</Link>\n      </header>\n\n      {error && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <section className=\"rounded border bg-white p-4 space-y-4\">\n        <div className=\"flex items-center gap-3\">\n          <label className=\"inline-flex items-center gap-2\">\n            <input type=\"checkbox\" checked={!!settings.enabled} onChange={e => setSettings(s => ({ ...s, enabled: e.target.checked }))} />\n            <span>Enable 24/7 Scanner</span>\n          </label>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Daily report time (HH:MM)</div>\n            <input className=\"w-full rounded border px-2 py-1\" value={settings.daily_report_time || ''} onChange={e => setSettings(s => ({ ...s, daily_report_time: e.target.value }))} placeholder=\"09:00\" />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Low stock threshold</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={settings.low_stock_threshold ?? 0} onChange={e => setSettings(s => ({ ...s, low_stock_threshold: Math.max(0, Number(e.target.value||0)) }))} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Price change threshold (%)</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={settings.price_change_threshold ?? 0} onChange={e => setSettings(s => ({ ...s, price_change_threshold: Math.max(0, Number(e.target.value||0)) }))} />\n          </label>\n        </div>\n        <div>\n          <button onClick={save} disabled={saving} className=\"rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700\">Save</button>\n        </div>\n      </section>\n\n      <section className=\"rounded border bg-white p-4 space-y-3\">\n        <h2 className=\"text-lg font-medium\">Watch List</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-3\">\n          <input className=\"rounded border px-2 py-1\" placeholder=\"CJ Product ID\" value={wPid} onChange={e => setWPid(e.target.value)} />\n          <input className=\"rounded border px-2 py-1\" placeholder=\"CJ SKU (optional)\" value={wSku} onChange={e => setWSku(e.target.value)} />\n          <input type=\"number\" className=\"rounded border px-2 py-1\" placeholder=\"Low stock\" value={wLow} onChange={e => setWLow(Math.max(0, Number(e.target.value||0)))} />\n          <label className=\"inline-flex items-center gap-2 text-sm\"><input type=\"checkbox\" checked={wPrice} onChange={e => setWPrice(e.target.checked)} /> Watch Price</label>\n          <label className=\"inline-flex items-center gap-2 text-sm\"><input type=\"checkbox\" checked={wStock} onChange={e => setWStock(e.target.checked)} /> Watch Stock</label>\n        </div>\n        <div>\n          <button onClick={addWatch} disabled={saving || !wPid} className=\"rounded bg-green-600 px-3 py-1.5 text-white hover:bg-green-700\">Add/Update</button>\n        </div>\n\n        <div className=\"rounded border bg-muted/20 overflow-auto\">\n          <table className=\"min-w-full text-sm\">\n            <thead>\n              <tr className=\"bg-muted\">\n                <th className=\"p-2 text-left\">CJ Product</th>\n                <th className=\"p-2 text-left\">CJ SKU</th>\n                <th className=\"p-2 text-left\">Low</th>\n                <th className=\"p-2 text-left\">Price</th>\n                <th className=\"p-2 text-left\">Stock</th>\n                <th className=\"p-2 text-right\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {(watch || []).map(w => (\n                <tr key={w.id} className=\"border-t\">\n                  <td className=\"p-2 font-mono text-xs\">{w.cj_product_id}</td>\n                  <td className=\"p-2 font-mono text-xs\">{w.cj_sku || '-'}</td>\n                  <td className=\"p-2\">{w.threshold_low}</td>\n                  <td className=\"p-2\">{w.watch_price ? 'Yes' : 'No'}</td>\n                  <td className=\"p-2\">{w.watch_stock ? 'Yes' : 'No'}</td>\n                  <td className=\"p-2 text-right\">\n                    <button onClick={() => removeWatch(w.cj_product_id, w.cj_sku || undefined)} className=\"rounded bg-rose-600 px-2 py-1 text-white text-xs hover:bg-rose-700\">Remove</button>\n                  </td>\n                </tr>\n              ))}\n              {(!watch || watch.length===0) && !loading && (\n                <tr><td colSpan={6} className=\"p-4 text-center text-sm text-muted-foreground\">Empty</td></tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n      </section>\n\n      {loading && <div className=\"text-sm text-gray-500\">Loading…</div>}\n    </div>\n  );\n}\n","path":null,"size_bytes":8949,"size_tokens":null},"src/app/admin/pricing/page.tsx":{"content":"\"use client\";\n\nimport React, { useState } from 'react';\n\nexport default function AdminPricingCalculatorPage() {\n  const [supplierCostSar, setSupplierCostSar] = useState(10);\n  const [actualKg, setActualKg] = useState(0.4);\n  const [lengthCm, setLengthCm] = useState(25);\n  const [widthCm, setWidthCm] = useState(20);\n  const [heightCm, setHeightCm] = useState(3);\n  const [margin, setMargin] = useState(0.35);\n  const [handlingSar, setHandlingSar] = useState(0);\n  const [result, setResult] = useState<any>(null);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  async function handleCalc(e: React.FormEvent) {\n    e.preventDefault();\n    setLoading(true);\n    setError(null);\n    setResult(null);\n    try {\n      const res = await fetch('/api/admin/pricing/calc', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ supplierCostSar, actualKg, lengthCm, widthCm, heightCm, margin, handlingSar }),\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data?.error || res.statusText);\n      setResult(data);\n    } catch (e: any) {\n      setError(e?.message || 'Failed');\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"max-w-3xl mx-auto p-6 space-y-6\">\n      <h1 className=\"text-2xl font-semibold\">Pricing Calculator (KSA DDP)</h1>\n      <form onSubmit={handleCalc} className=\"grid gap-4 sm:grid-cols-2\">\n        <label className=\"block\">\n          <span className=\"text-sm\">Supplier Cost (SAR)</span>\n          <input type=\"number\" step=\"0.01\" className=\"mt-1 w-full border rounded p-2\" value={supplierCostSar}\n            onChange={(e) => setSupplierCostSar(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Actual Weight (kg)</span>\n          <input type=\"number\" step=\"0.01\" className=\"mt-1 w-full border rounded p-2\" value={actualKg}\n            onChange={(e) => setActualKg(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Length (cm)</span>\n          <input type=\"number\" className=\"mt-1 w-full border rounded p-2\" value={lengthCm}\n            onChange={(e) => setLengthCm(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Width (cm)</span>\n          <input type=\"number\" className=\"mt-1 w-full border rounded p-2\" value={widthCm}\n            onChange={(e) => setWidthCm(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Height (cm)</span>\n          <input type=\"number\" className=\"mt-1 w-full border rounded p-2\" value={heightCm}\n            onChange={(e) => setHeightCm(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Margin (0-1)</span>\n          <input type=\"number\" step=\"0.01\" min={0} max={0.95} className=\"mt-1 w-full border rounded p-2\" value={margin}\n            onChange={(e) => setMargin(parseFloat(e.target.value))} />\n        </label>\n        <label className=\"block\">\n          <span className=\"text-sm\">Handling (SAR)</span>\n          <input type=\"number\" step=\"0.01\" className=\"mt-1 w-full border rounded p-2\" value={handlingSar}\n            onChange={(e) => setHandlingSar(parseFloat(e.target.value))} />\n        </label>\n        <div className=\"sm:col-span-2\">\n          <button type=\"submit\" disabled={loading} className=\"px-4 py-2 rounded bg-indigo-600 text-white disabled:opacity-50\">\n            {loading ? 'Calculating…' : 'Calculate'}\n          </button>\n        </div>\n      </form>\n\n      {error && <div className=\"text-red-600 text-sm\">{error}</div>}\n\n      {result && (\n        <div className=\"rounded border p-4 space-y-2\">\n          <div className=\"font-medium\">Result</div>\n          <div className=\"grid grid-cols-2 gap-2 text-sm\">\n            <div>Billed Weight (kg)</div>\n            <div className=\"text-right\">{result.billedWeightKg}</div>\n            <div>DDP Shipping (SAR)</div>\n            <div className=\"text-right\">{result.ddpShippingSar}</div>\n            <div>Landed Cost (SAR)</div>\n            <div className=\"text-right\">{result.landedCostSar}</div>\n            <div>Retail (SAR)</div>\n            <div className=\"text-right font-semibold\">{result.retailSar}</div>\n            <div>Packaging</div>\n            <div className=\"text-right\">{result.packaging?.option?.code} → billed {result.packaging?.billedWeightKg}kg</div>\n          </div>\n          <pre className=\"bg-black text-green-300 text-xs p-3 rounded overflow-auto\">{JSON.stringify(result, null, 2)}</pre>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4799,"size_tokens":null},"src/components/logo.tsx":{"content":"import Link from \"next/link\";\n\nexport default function Logo() {\n  const name = process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\";\n  return (\n    <Link href=\"/\" className=\"block select-none min-w-0\">\n      <span className=\"block truncate text-lg font-semibold tracking-tight\">{name}</span>\n    </Link>\n  );\n}\n","path":null,"size_bytes":306,"size_tokens":null},"src/app/terms/page.tsx":{"content":"export const metadata = { title: \"Terms of Service\" };\n\nexport default function TermsPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Terms of Service</h1>\n      <p className=\"mt-4 text-slate-700 text-sm\">\n        This is a placeholder page. The final terms of service will be updated before the official launch.\n      </p>\n    </div>\n  );\n}\n","path":null,"size_bytes":402,"size_tokens":null},"e2e/cj-smoke.spec.ts":{"content":"import { test, expect } from '@playwright/test'\n\n// Skip CJ-dependent tests when CJ envs are not present\nconst hasCj = !!process.env.CJ_API_BASE && (!!process.env.CJ_API_KEY || !!process.env.CJ_ACCESS_TOKEN)\n\ntest.describe('CJ smoke', () => {\n  test('home page renders', async ({ page }) => {\n    await page.goto('/')\n    await expect(page).toHaveTitle(/shop/i)\n  })\n\n  test.skip(!hasCj, 'CJ env not configured')('shipping calc returns structured JSON', async ({ request }) => {\n    const res = await request.post('/api/cj/shipping/calc', {\n      data: { countryCode: 'SA', pid: 'dummy', quantity: 1 },\n    })\n    // May not be 200 if PID invalid; just ensure JSON with keys\n    const j = await res.json()\n    expect(j).toBeTruthy()\n    expect(j).toHaveProperty('ok')\n  })\n\n  test('sync product requires admin', async ({ request }) => {\n    const res = await request.get('/api/cj/sync/product/xxx')\n    expect([401, 500]).toContain(res.status())\n  })\n})\n","path":null,"size_bytes":954,"size_tokens":null},"src/instrumentation.ts":{"content":"export async function register() {\n  // Only initialize Sentry if DSN is configured\n  if (!process.env.SENTRY_DSN) return;\n  \n  try {\n    const Sentry = await import('@sentry/nextjs');\n    if (!Sentry || typeof Sentry.init !== 'function') return;\n    \n    Sentry.init({\n      dsn: process.env.SENTRY_DSN,\n      tracesSampleRate: 0.1,\n      environment: process.env.REPLIT_DEPLOYMENT ? 'production' : (process.env.VERCEL_ENV || process.env.NODE_ENV),\n      enabled: true,\n    });\n  } catch {\n    // Sentry not installed or initialization failed; continue without it\n  }\n}\n","path":null,"size_bytes":571,"size_tokens":null},"src/app/account/addresses/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport type { Address } from \"@/lib/types\";\nimport { createAddress, deleteAddress, setDefaultAddress, updateAddress } from \"@/lib/address-actions\";\nimport SubmitButton from \"@/components/submit-button\";\nimport ConfirmSubmitButton from \"@/components/confirm-submit-button\";\nimport FormStatusToast from \"@/components/form-status-toast\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function AddressesPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    redirect(\"/login?redirect=/account/addresses\");\n  }\n\n  const { data } = await supabase\n    .from(\"addresses\")\n    .select(\"id,user_id,full_name,phone,line1,line2,city,state,postal_code,country,is_default,created_at\")\n    .eq(\"user_id\", user.id)\n    .order(\"is_default\", { ascending: false })\n    .order(\"id\", { ascending: true });\n\n  const addresses = (data || []) as Address[];\n\n  return (\n    <div className=\"max-w-4xl mx-auto py-12 px-4\">\n      <h1 className=\"text-2xl font-bold mb-6\">Addresses</h1>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6 mb-10\">\n        <div className=\"rounded-lg border bg-white p-6\">\n          <h2 className=\"text-lg font-semibold mb-4\">Add New Address</h2>\n          <form action={createAddress} className=\"space-y-3\">\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Full Name</label>\n              <input name=\"full_name\" autoComplete=\"name\" required className=\"w-full rounded border px-3 py-2\" placeholder=\"Your name\" />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Phone Number</label>\n              <input name=\"phone\" type=\"tel\" autoComplete=\"tel\" inputMode=\"tel\" pattern=\"^\\+?[0-9\\s\\-]{6,}$\" className=\"w-full rounded border px-3 py-2\" placeholder=\"Optional\" />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Address Line 1</label>\n              <input name=\"line1\" autoComplete=\"address-line1\" required className=\"w-full rounded border px-3 py-2\" placeholder=\"Street and house number\" />\n            </div>\n            <div>\n              <label className=\"block text-sm font-medium mb-1\">Address Line 2</label>\n              <input name=\"line2\" autoComplete=\"address-line2\" className=\"w-full rounded border px-3 py-2\" placeholder=\"Apartment, suite, etc. (optional)\" />\n            </div>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n              <div>\n                <label className=\"block text-sm font-medium mb-1\">City</label>\n                <input name=\"city\" autoComplete=\"address-level2\" required className=\"w-full rounded border px-3 py-2\" />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium mb-1\">State/Province</label>\n                <input name=\"state\" autoComplete=\"address-level1\" className=\"w-full rounded border px-3 py-2\" />\n              </div>\n            </div>\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n              <div>\n                <label className=\"block text-sm font-medium mb-1\">Postal Code</label>\n                <input name=\"postal_code\" autoComplete=\"postal-code\" inputMode=\"numeric\" className=\"w-full rounded border px-3 py-2\" />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium mb-1\">Country</label>\n                <input name=\"country\" autoComplete=\"country\" required className=\"w-full rounded border px-3 py-2\" placeholder=\"e.g., US, UK, CA\" />\n              </div>\n            </div>\n            <label className=\"inline-flex items-center gap-2 text-sm\">\n              <input type=\"checkbox\" name=\"is_default\" className=\"h-4 w-4\" />\n              Set as default\n            </label>\n            <div>\n              <SubmitButton label=\"Save Address\" pendingLabel=\"Saving...\" />\n            </div>\n            <FormStatusToast successMessage=\"Address saved successfully\" />\n          </form>\n        </div>\n\n        <div className=\"rounded-lg border bg-white p-6\">\n          <h2 className=\"text-lg font-semibold mb-4\">Saved Addresses</h2>\n          {addresses.length === 0 ? (\n            <p className=\"text-gray-600\">No saved addresses yet.</p>\n          ) : (\n            <ul className=\"space-y-4\">\n              {addresses.map((addr) => (\n                <li key={addr.id} className=\"border rounded-lg p-4\">\n                  <div className=\"flex items-start justify-between gap-3\">\n                    <div>\n                      <p className=\"font-medium\">{addr.full_name} {addr.is_default && <span className=\"ml-2 inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-semibold text-green-800\">Default</span>}</p>\n                      <p className=\"text-sm text-gray-700\">{addr.line1}{addr.line2 ? `, ${addr.line2}` : \"\"}</p>\n                      <p className=\"text-sm text-gray-700\">{addr.city}{addr.state ? `, ${addr.state}` : \"\"}{addr.postal_code ? `, ${addr.postal_code}` : \"\"}</p>\n                      <p className=\"text-sm text-gray-700\">{addr.country}{addr.phone ? ` • ${addr.phone}` : \"\"}</p>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      {!addr.is_default && (\n                        <form action={setDefaultAddress}>\n                          <input type=\"hidden\" name=\"id\" value={String(addr.id)} />\n                          <SubmitButton label=\"Set Default\" pendingLabel=\"Setting...\" variant=\"secondary\" className=\"px-3 py-1.5 text-sm\" />\n                          <FormStatusToast successMessage=\"Address set as default\" />\n                        </form>\n                      )}\n                      <form action={deleteAddress}>\n                        <input type=\"hidden\" name=\"id\" value={String(addr.id)} />\n                        <ConfirmSubmitButton label=\"Delete\" pendingLabel=\"Deleting...\" confirmMessage=\"Are you sure you want to delete this address?\" className=\"px-3 py-1.5 text-sm\" />\n                        <FormStatusToast successMessage=\"Address deleted\" />\n                      </form>\n                    </div>\n                  </div>\n                  <details className=\"mt-3\">\n                    <summary className=\"cursor-pointer text-sm text-gray-700 hover:text-black\">Edit Address</summary>\n                    <form action={updateAddress} className=\"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                      <input type=\"hidden\" name=\"id\" value={String(addr.id)} />\n                      <div className=\"sm:col-span-2\">\n                        <label className=\"block text-sm font-medium mb-1\">Full Name</label>\n                        <input name=\"full_name\" autoComplete=\"name\" defaultValue={addr.full_name} required className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div className=\"sm:col-span-2\">\n                        <label className=\"block text-sm font-medium mb-1\">Phone Number</label>\n                        <input name=\"phone\" type=\"tel\" autoComplete=\"tel\" inputMode=\"tel\" pattern=\"^\\+?[0-9\\s\\-]{6,}$\" defaultValue={addr.phone ?? \"\"} className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div className=\"sm:col-span-2\">\n                        <label className=\"block text-sm font-medium mb-1\">Address Line 1</label>\n                        <input name=\"line1\" autoComplete=\"address-line1\" defaultValue={addr.line1} required className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div className=\"sm:col-span-2\">\n                        <label className=\"block text-sm font-medium mb-1\">Address Line 2</label>\n                        <input name=\"line2\" autoComplete=\"address-line2\" defaultValue={addr.line2 ?? \"\"} className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium mb-1\">City</label>\n                        <input name=\"city\" autoComplete=\"address-level2\" defaultValue={addr.city} required className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium mb-1\">State/Province</label>\n                        <input name=\"state\" autoComplete=\"address-level1\" defaultValue={addr.state ?? \"\"} className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium mb-1\">Postal Code</label>\n                        <input name=\"postal_code\" autoComplete=\"postal-code\" inputMode=\"numeric\" defaultValue={addr.postal_code ?? \"\"} className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div>\n                        <label className=\"block text-sm font-medium mb-1\">Country</label>\n                        <input name=\"country\" autoComplete=\"country\" defaultValue={addr.country} required className=\"w-full rounded border px-3 py-2\" />\n                      </div>\n                      <div className=\"sm:col-span-2\">\n                        <label className=\"inline-flex items-center gap-2 text-sm\">\n                          <input type=\"checkbox\" name=\"is_default\" defaultChecked={addr.is_default} className=\"h-4 w-4\" />\n                          Set as default\n                        </label>\n                      </div>\n                      <div className=\"sm:col-span-2\">\n                        <SubmitButton label=\"Save Changes\" pendingLabel=\"Saving...\" />\n                      </div>\n                      <FormStatusToast successMessage=\"Address updated\" />\n                    </form>\n                  </details>\n                </li>\n              ))}\n            </ul>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10160,"size_tokens":null},"src/app/api/chat/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\nimport { chatLimiter, getClientIp } from '@/lib/ratelimit';\nimport { loggerForRequest } from '@/lib/log';\nimport { fetchWithMeta } from '@/lib/http';\nimport { ensureEnv, getEnv } from '@/lib/env';\n\nexport const runtime = 'nodejs';\n\nconst OPENAI_URL = 'https://api.openai.com/v1/chat/completions';\n\nconst KNOWLEDGE = `\nYou are Shopixo Assistant. Language: English primarily.\nPolicies:\n- US shipping: Fast delivery with DDP (Delivered Duty Paid) when available.\n- Packaging: Neutral outer packaging. Allowed inserts: unbranded packing slip + neutral thank-you card.\n- Sizes: Provide clear guidance; if unsure, suggest checking size charts.\n- Order status: Ask user to log in and visit /order-tracking or share order number to check.\n- Returns: Follow the return policy page at /return-policy.\n`;\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req);\n  log.info('chat_start');\n  // Rate limit per IP to protect provider costs\n  try {\n    const ip = getClientIp(req as unknown as Request);\n    const lim = await chatLimiter.limit(`chat:${ip}`);\n    if (!lim.success) {\n      log.warn('chat_rate_limited', { ip });\n      const r = NextResponse.json({ error: 'rate_limited' }, { status: 429 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n  } catch {/* noop if limiter not configured */}\n  let body: any;\n  try { body = await req.json(); } catch {\n    log.warn('chat_invalid_json');\n    const r = NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const messages = Array.isArray(body.messages) ? body.messages : [];\n  // Try to enrich with user context (recent orders / tracking)\n  let userFacts = '';\n  try {\n    const supabase = createRouteHandlerClient({ cookies });\n    const { data: { user } } = await supabase.auth.getUser();\n    if (user) {\n      const { data: orders } = await supabase\n        .from('orders')\n        .select('id, created_at, total_amount, status, tracking_number, carrier, shipping_status')\n        .eq('user_id', user.id)\n        .order('created_at', { ascending: false })\n        .limit(5);\n      if (orders && orders.length > 0) {\n        userFacts = `User has ${orders.length} recent orders. Top 1: #${orders[0].id} status=${orders[0].status} tracking=${orders[0].tracking_number || 'N/A'} carrier=${orders[0].carrier || 'N/A'} ship_status=${orders[0].shipping_status || 'N/A'}.`;\n      }\n    }\n  } catch {}\n  // Prefer centralized env access\n  const key = (getEnv('OPENAI_API_KEY') as string | undefined) || process.env.OPENAI_API_KEY;\n  if (!key) {\n    const fallback = 'Hello! I am the store assistant. For smart responses, enable the OPENAI_API_KEY on the server. Feel free to ask your questions and I will try to help.';\n    log.info('chat_no_api_key');\n    const r = NextResponse.json({ reply: fallback });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  try {\n    const meta = await fetchWithMeta<any>(OPENAI_URL, {\n      method: 'POST',\n      headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        model: (getEnv('AI_MODEL_TEXT') as string | undefined) || process.env.AI_MODEL_TEXT || 'gpt-4o-mini',\n        temperature: 0.2,\n        messages: [\n          { role: 'system', content: KNOWLEDGE + (userFacts ? `\\nContext: ${userFacts}` : '') },\n          ...messages,\n        ],\n      }),\n      timeoutMs: 18000,\n      retries: 2,\n    });\n    if (!meta.ok) {\n      log.warn('chat_provider_error', { status: meta.status });\n      const r = NextResponse.json({ error: typeof meta.body === 'string' ? meta.body : (meta.body?.error?.message || 'Upstream failed') }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const data = meta.body;\n    const reply = data?.choices?.[0]?.message?.content || '';\n    const r = NextResponse.json({ reply });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    log.error('chat_exception', { error: e?.message || String(e) });\n    const r = NextResponse.json({ error: e?.message || 'Chat failed' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":4433,"size_tokens":null},"src/lib/address-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\n\nfunction boolFromForm(value: FormDataEntryValue | null): boolean {\n  if (!value) return false;\n  const v = String(value).toLowerCase();\n  return v === \"true\" || v === \"on\" || v === \"1\";\n}\n\nexport async function createAddress(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/addresses\");\n\n  const full_name = String(formData.get(\"full_name\") || \"\").trim();\n  const phone = String(formData.get(\"phone\") || \"\").trim() || null;\n  const line1 = String(formData.get(\"line1\") || \"\").trim();\n  const line2Raw = String(formData.get(\"line2\") || \"\").trim();\n  const line2 = line2Raw.length ? line2Raw : null;\n  const city = String(formData.get(\"city\") || \"\").trim();\n  const stateRaw = String(formData.get(\"state\") || \"\").trim();\n  const state = stateRaw.length ? stateRaw : null;\n  const postal_codeRaw = String(formData.get(\"postal_code\") || \"\").trim();\n  const postal_code = postal_codeRaw.length ? postal_codeRaw : null;\n  const country = String(formData.get(\"country\") || \"\").trim();\n  const is_default = boolFromForm(formData.get(\"is_default\"));\n\n  if (!full_name || !line1 || !city || !country) {\n    throw new Error(\"Please provide full name, address line 1, city and country.\");\n  }\n\n  if (is_default) {\n    await supabase.from(\"addresses\").update({ is_default: false }).eq(\"user_id\", user.id);\n  }\n\n  const { error } = await supabase.from(\"addresses\").insert({\n    user_id: user.id,\n    full_name,\n    phone,\n    line1,\n    line2,\n    city,\n    state,\n    postal_code,\n    country,\n    is_default,\n  });\n\n  if (error) {\n    console.error(\"createAddress error\", error);\n    throw new Error(\"Failed to create address.\");\n  }\n  revalidatePath(\"/account/addresses\");\n}\n\nexport async function updateAddress(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/addresses\");\n\n  const id = Number(formData.get(\"id\"));\n  if (!id) throw new Error(\"Invalid address id\");\n\n  const full_name = String(formData.get(\"full_name\") || \"\").trim();\n  const phone = String(formData.get(\"phone\") || \"\").trim() || null;\n  const line1 = String(formData.get(\"line1\") || \"\").trim();\n  const line2Raw = String(formData.get(\"line2\") || \"\").trim();\n  const line2 = line2Raw.length ? line2Raw : null;\n  const city = String(formData.get(\"city\") || \"\").trim();\n  const stateRaw = String(formData.get(\"state\") || \"\").trim();\n  const state = stateRaw.length ? stateRaw : null;\n  const postal_codeRaw = String(formData.get(\"postal_code\") || \"\").trim();\n  const postal_code = postal_codeRaw.length ? postal_codeRaw : null;\n  const country = String(formData.get(\"country\") || \"\").trim();\n  const is_default = boolFromForm(formData.get(\"is_default\"));\n\n  if (!full_name || !line1 || !city || !country) {\n    throw new Error(\"Please provide full name, address line 1, city and country.\");\n  }\n\n  if (is_default) {\n    await supabase.from(\"addresses\").update({ is_default: false }).eq(\"user_id\", user.id);\n  }\n\n  const { error } = await supabase\n    .from(\"addresses\")\n    .update({\n      full_name,\n      phone,\n      line1,\n      line2,\n      city,\n      state,\n      postal_code,\n      country,\n      is_default,\n    })\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id);\n\n  if (error) {\n    console.error(\"updateAddress error\", error);\n    throw new Error(\"Failed to update address.\");\n  }\n  revalidatePath(\"/account/addresses\");\n}\n\nexport async function deleteAddress(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/addresses\");\n\n  const id = Number(formData.get(\"id\"));\n  if (!id) throw new Error(\"Invalid address id\");\n\n  // If this is default, pick another as default afterwards.\n  const { data: addr } = await supabase\n    .from(\"addresses\")\n    .select(\"id,is_default\")\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id)\n    .single();\n\n  const { error } = await supabase.from(\"addresses\").delete().eq(\"id\", id).eq(\"user_id\", user.id);\n  if (error) {\n    console.error(\"deleteAddress error\", error);\n    throw new Error(\"Failed to delete address.\");\n  }\n\n  if (addr?.is_default) {\n    const { data: other } = await supabase\n      .from(\"addresses\")\n      .select(\"id\")\n      .eq(\"user_id\", user.id)\n      .order(\"id\", { ascending: true })\n      .limit(1)\n      .maybeSingle();\n    if (other?.id) {\n      await supabase.from(\"addresses\").update({ is_default: true }).eq(\"id\", other.id);\n    }\n  }\n  revalidatePath(\"/account/addresses\");\n}\n\nexport async function setDefaultAddress(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/addresses\");\n\n  const id = Number(formData.get(\"id\"));\n  if (!id) throw new Error(\"Invalid address id\");\n\n  await supabase.from(\"addresses\").update({ is_default: false }).eq(\"user_id\", user.id);\n  const { error } = await supabase.from(\"addresses\").update({ is_default: true }).eq(\"id\", id).eq(\"user_id\", user.id);\n  if (error) {\n    console.error(\"setDefaultAddress error\", error);\n    throw new Error(\"Failed to set default address.\");\n  }\n  revalidatePath(\"/account/addresses\");\n}\n","path":null,"size_bytes":5657,"size_tokens":null},"src/lib/scanner.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js'\nimport { queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { saveNotification } from '@/lib/notify'\n\nfunction getAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function runScannerJob(jobId: number): Promise<{ watched: number; updated: number; notifications: number }> {\n  const db = getAdmin()\n  if (!db) return { watched: 0, updated: 0, notifications: 0 }\n\n  // Load watch list (cap to 100 per run)\n  const { data: watch } = await db.from('cj_inventory_watch').select('*').order('created_at', { ascending: true }).limit(100)\n  const watches = watch || []\n\n  // Also include CJ PIDs from your catalog (limited)\n  const { data: prod } = await db.from('products').select('id, cj_product_id').not('cj_product_id', 'is', null).order('id', { ascending: true }).limit(100)\n  const extraPids = new Set<string>((prod || []).map(p => String(p.cj_product_id)))\n  for (const w of watches) extraPids.add(String(w.cj_product_id))\n\n  let updated = 0\n  let notes = 0\n\n  for (const pid of Array.from(extraPids)) {\n    try {\n      const raw = await queryProductByPidOrKeyword({ pid })\n      const item = Array.isArray((raw as any)?.data?.content) ? (raw as any).data.content[0] : ((raw as any).data || raw)\n      const variants: any[] = Array.isArray((item as any)?.variantList) ? (item as any).variantList : (Array.isArray((item as any)?.skuList) ? (item as any).skuList : [])\n\n      // Build snapshot rows \n      const rows = [] as Array<{ cj_product_id: string; cj_sku: string | null; price: number | null; currency: string | null; stock: number | null; warehouse: string | null }>\n      for (const v of variants) {\n        const sku = String(v.cjSku || v.sku || v.skuId || v.barcode || '') || null\n        const price = typeof v.price === 'number' ? v.price : (typeof v.sellPrice === 'number' ? v.sellPrice : null)\n        const stock = typeof v.stock === 'number' ? v.stock : (typeof v.availableStock === 'number' ? v.availableStock : null)\n        const wh = (v.warehouse || v.warehouseName || v.areaName || null) as string | null\n        rows.push({ cj_product_id: pid, cj_sku: sku, price, currency: (v.currency || 'USD') as string, stock, warehouse: wh })\n      }\n\n      // Insert snapshots\n      if (rows.length > 0) {\n        const payload = rows.map(r => ({ cj_product_id: r.cj_product_id, cj_sku: r.cj_sku, price: r.price, currency: r.currency, stock: r.stock, warehouse: r.warehouse }))\n        await db.from('inventory_snapshots').insert(payload as any)\n      }\n\n      // Update product_variants stock by cj_sku when possible\n      if (rows.length > 0) {\n        for (const r of rows) {\n          if (!r.cj_sku || typeof r.stock !== 'number') continue\n          try { await db.from('product_variants').update({ stock: Math.max(0, r.stock) }).eq('cj_sku', r.cj_sku as any) } catch {}\n        }\n      }\n\n      // Evaluate watches for this pid\n      const watchRows = (watches || []).filter(w => String(w.cj_product_id) === pid)\n      for (const w of watchRows) {\n        const lastSeen = (w.last_seen || {}) as any\n        // price change detection (use first variant if sku not specified)\n        const match = rows.find(r => (w.cj_sku ? r.cj_sku === w.cj_sku : true)) || rows[0]\n        if (!match) continue\n        let bumped = false\n\n        if (w.watch_stock && typeof match.stock === 'number' && typeof w.threshold_low === 'number') {\n          if (match.stock <= Math.max(0, w.threshold_low)) {\n            await saveNotification({ type: 'stock_low', title: `Low stock for ${pid}${w.cj_sku ? ' / '+w.cj_sku : ''}`, body: `Stock: ${match.stock} ≤ threshold ${w.threshold_low}`, meta: { pid, sku: w.cj_sku, stock: match.stock } })\n            notes++\n            bumped = true\n          }\n        }\n        if (w.watch_price && typeof match.price === 'number') {\n          const prev = typeof lastSeen.price === 'number' ? lastSeen.price : null\n          const pct = typeof w.price_change_threshold === 'number' ? w.price_change_threshold : 5\n          if (prev !== null && prev > 0) {\n            const delta = ((match.price - prev) / prev) * 100\n            if (Math.abs(delta) >= pct) {\n              await saveNotification({ type: 'price_change', title: `Price change for ${pid}${w.cj_sku ? ' / '+w.cj_sku : ''}`, body: `Δ ${delta.toFixed(2)}% (${prev}→${match.price})`, meta: { pid, sku: w.cj_sku, prev, next: match.price, delta } })\n              notes++\n              bumped = true\n            }\n          }\n        }\n        // Update last_seen snapshot\n        const nextSeen = { price: match.price ?? null, stock: match.stock ?? null, ts: new Date().toISOString() }\n        try { await db.from('cj_inventory_watch').update({ last_seen: nextSeen }).eq('id', w.id) } catch {}\n        if (bumped) updated++\n      }\n    } catch {\n      // continue\n    }\n  }\n\n  return { watched: watches.length, updated, notifications: notes }\n}\n","path":null,"size_bytes":5083,"size_tokens":null},"src/app/api/admin/cj/finder/start/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { createJob } from '@/lib/jobs'\nimport { hasTable } from '@/lib/db-features'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    \n    const hasJobsTable = await hasTable('admin_jobs')\n    if (!hasJobsTable) {\n      const r = NextResponse.json({ \n        ok: false, \n        error: 'Database tables missing. Please run migrations: admin_jobs, admin_job_items tables required.',\n        tablesMissing: true \n      }, { status: 503 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    \n    let body: any = {}\n    try { body = await req.json() } catch {}\n\n    const keywords: string[] = Array.isArray(body.keywords)\n      ? body.keywords.map((s: any) => String(s).trim()).filter(Boolean)\n      : String(body.keywords || '').split(',').map((s) => s.trim()).filter(Boolean)\n\n    const targetQuantity = Math.max(1, Math.min(2000, Number(body.targetQuantity || 50)))\n    const pageSize = Math.max(1, Math.min(50, Number(body.pageSize || 20)))\n    const maxPagesPerKeyword = Math.max(1, Math.min(40, Number(body.maxPagesPerKeyword || 5)))\n\n    const params = {\n      keywords,\n      targetQuantity,\n      pageSize,\n      maxPagesPerKeyword,\n      filters: {\n        minRating: body.minRating ? Number(body.minRating) : undefined,\n        priceRange: body.priceRange || undefined,\n        warehouses: Array.isArray(body.warehouses) ? body.warehouses : undefined,\n        sizes: Array.isArray(body.sizes) ? body.sizes : undefined,\n        colors: Array.isArray(body.colors) ? body.colors : undefined,\n      },\n      pricing: {\n        margin: typeof body.margin === 'number' ? body.margin : 0.35,\n        handlingSar: typeof body.handlingSar === 'number' ? body.handlingSar : 0,\n        cjCurrency: (body.cjCurrency || 'USD').toUpperCase(),\n      },\n      cursor: { kwIndex: 0, pageNum: 1, collected: 0 },\n    }\n\n    const job = await createJob('finder', params)\n    if (!job) {\n      const r = NextResponse.json({ ok: false, error: 'Failed to create job. Ensure database tables exist.' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const r = NextResponse.json({ ok: true, jobId: job.id })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'finder start failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2923,"size_tokens":null},"src/app/admin/pricing/actions.ts":{"content":"\"use server\";\n\nimport { calculateRetailSar, recommendPackaging } from '@/lib/pricing';\n\nexport type LandedCostInput = {\n  supplierCostSar: number;\n  actualKg: number;\n  lengthCm: number;\n  widthCm: number;\n  heightCm: number;\n  margin?: number;       // default 0.35\n  handlingSar?: number;  // default 0\n};\n\nexport async function calculateLandedCost(input: LandedCostInput) {\n  const { supplierCostSar, actualKg, lengthCm, widthCm, heightCm, margin, handlingSar } = input;\n  if (!(supplierCostSar >= 0)) throw new Error('supplierCostSar must be >= 0');\n  if (!(actualKg > 0)) throw new Error('actualKg must be > 0');\n  if (!(lengthCm > 0 && widthCm > 0 && heightCm > 0)) throw new Error('invalid dimensions');\n\n  const calc = calculateRetailSar(supplierCostSar, { actualKg, lengthCm, widthCm, heightCm }, { margin, handlingSar });\n  const pack = recommendPackaging(actualKg, { L: lengthCm, W: widthCm, H: heightCm });\n  return { ...calc, packaging: pack };\n}\n","path":null,"size_bytes":960,"size_tokens":null},"branding/suppliers/ddp-all-in-pricing-request-ar.md":{"content":"# طلب تسعير شامل DDP — إلى السعودية (Shopixo)\n\nنرجو تزويدنا بعرض سعر \"شامل/قطعة\" Delivered Duty Paid (DDP) إلى السعودية، بحيث يشمل:\n- تكلفة الشحن الدولي إلى KSA\n- الرسوم الجمركية حسب بند التعرفة HS (Customs Duty)\n- ضريبة القيمة المضافة السعودية 15% (Import VAT)\n- رسوم الخدمات الجمركية وأجور التخليص وأي رسوم ناقل إضافية (Fuel/Remote/Address correction…)\n- التسليم باب العميل (Door-to-Door)\n\nالمتطلبات التشغيلية:\n- الشحن الأعمى (Blind Shipping) — اسم المرسل على الملصق: Shopixo\n- تضمين قسيمة التغليف (Packing Slip) + بطاقة الشكر داخل كل طرد (سنرسل PDF/HTML)\n- تزويد رقم التتبع خلال 24 ساعة من التسليم لشركة النقل\n- توضيح زمن التوصيل المعتاد إلى KSA لكل خدمة (Economy/Express)\n- تحديد المستورد القانوني Importer of Record (المورد أم Shopixo)\n- توضيح قاسم الوزن الحجمي (Dimensional Divisor) المستخدم (مثلاً 5000)\n\nالرجاء تزويدنا بمصفوفة أسعار واضحة أو سعر نهائي/قطعة لكل منتج وفق المواصفات المرفقة.\n\nيرجى الإشارة في العرض إلى:\n- الشمول الضريبي: هل السعر يشمل Import VAT 15% KSA بشكل صريح؟\n- الشمول الجمركي: هل السعر يشمل Customs Duty حسب HS؟ اذكروا نسبة/آلية الاحتساب.\n- الشمول الرسومي: هل السعر يشمل رسوم الخدمات الجمركية وأجور التخليص والرسوم الإضافية؟\n- IOR: تحديد الطرف (Supplier أو Shopixo). في حال Supplier، يرجى توضيح سياسة الفواتير/الإثباتات.\n- خدمات الشحن: Economy/Express + زمن التوصيل.\n\nسنزوّدكم بملف مواصفات المنتجات (SKU Sheet) يتضمن HS، الوزن، الأبعاد بعد التغليف، وعدد القطع في الشحنة النموذجية.\n\nشكرًا لتعاونكم.\n","path":null,"size_bytes":2270,"size_tokens":null},"src/app/blog/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nexport const metadata = { title: \"Blog\" };\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function BlogPage() {\n  let posts: Array<{ id: number; title: string; slug: string; excerpt: string | null; created_at: string | null }> = [];\n  try {\n    const supabase = createServerComponentClient({ cookies });\n    const { data } = await supabase\n      .from(\"blog_posts\")\n      .select(\"id, title, slug, excerpt, created_at\")\n      .eq(\"published\", true)\n      .order(\"created_at\", { ascending: false })\n      .limit(24);\n    posts = (data as any[]) || [];\n  } catch {}\n\n  const hasPosts = Array.isArray(posts) && posts.length > 0;\n\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Blog</h1>\n      {!hasPosts && (\n        <p className=\"mt-2 text-slate-600\">No posts yet. Updates and articles will be published soon.</p>\n      )}\n      {hasPosts && (\n        <div className=\"mt-6 grid gap-6 md:grid-cols-2 lg:grid-cols-3\">\n          {posts.map((p) => (\n            <article key={p.id} className=\"rounded-xl border bg-white p-6 shadow-sm\">\n              <div className=\"text-xs text-slate-500\">{p.created_at ? new Date(p.created_at).toLocaleDateString() : \"\"}</div>\n              <h2 className=\"mt-2 text-lg font-semibold\">{p.title}</h2>\n              {p.excerpt && <p className=\"mt-2 text-sm text-slate-600\">{p.excerpt}</p>}\n            </article>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1599,"size_tokens":null},"src/lib/ops/tracking.ts":{"content":"import { createClient } from '@supabase/supabase-js';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\n/**\n * Persist CJ tracking payload to orders table when possible.\n * Tries best-effort mappings because exact payload schema may vary until docs are confirmed.\n */\nexport async function persistCjTracking(payload: any): Promise<{ ok: boolean; reason?: string }>{\n  const admin = getSupabaseAdmin();\n  if (!admin) return { ok: false, reason: 'Supabase not configured' };\n\n  // Extract identifiers\n  const event = payload?.event || payload?.type || 'unknown';\n  const data = payload?.data || payload || {};\n  const orderId = Number(data.orderId || data.order_id || data.shopixoOrderId || 0) || undefined;\n  const orderNo = String(data.orderNo || data.order_no || data.cjOrderNo || '') || undefined;\n  const trackingNumber = data.trackingNo || data.tracking_number || data.tracking || undefined;\n  const carrier = data.carrier || data.lastmile || data.express || undefined;\n  const status = data.status || data.event || payload?.event || undefined;\n\n  // Prefer direct order id; else try match by cj_order_no column if exists\n  try {\n    if (orderId) {\n      const update: any = {};\n      if (trackingNumber) update.tracking_number = trackingNumber;\n      if (carrier) update.carrier = carrier;\n      if (status) update.shipping_status = status;\n      if (orderNo) update.cj_order_no = orderNo;\n      if (Object.keys(update).length === 0) return { ok: true };\n      const { error } = await admin\n        .from('orders')\n        .update(update)\n        .eq('id', orderId);\n      if (error) {\n        console.warn('persistCjTracking: update by order id failed', error);\n      }\n      return { ok: true };\n    }\n  } catch (e) {\n    console.warn('persistCjTracking error id path:', e);\n  }\n\n  try {\n    if (orderNo) {\n      const update: any = {};\n      if (trackingNumber) update.tracking_number = trackingNumber;\n      if (carrier) update.carrier = carrier;\n      if (status) update.shipping_status = status;\n      const { error } = await admin\n        .from('orders')\n        .update(update)\n        .eq('cj_order_no', orderNo);\n      if (error) {\n        console.warn('persistCjTracking: update by cj_order_no failed', error);\n        return { ok: false, reason: error.message };\n      }\n      return { ok: true };\n    }\n  } catch (e: any) {\n    return { ok: false, reason: e?.message || 'update failed' };\n  }\n\n  return { ok: false, reason: 'no identifiers found' };\n}\n","path":null,"size_bytes":2625,"size_tokens":null},"src/lib/audit.ts":{"content":"import { createClient } from '@supabase/supabase-js'\nimport { hasTable } from '@/lib/db-features'\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport type AuditEvent = {\n  action: string\n  entity?: string\n  entityId?: string | number | null\n  userEmail?: string | null\n  userId?: string | null\n  payload?: any\n}\n\nexport async function recordAudit(evt: AuditEvent): Promise<boolean> {\n  const admin = getSupabaseAdmin()\n  if (!admin) return false\n  if (!(await hasTable('audit_logs'))) return false\n  try {\n    const row = {\n      action: String(evt.action || '').slice(0, 120),\n      entity: evt.entity ? String(evt.entity).slice(0, 80) : null,\n      entity_id: evt.entityId ?? null,\n      user_email: evt.userEmail ?? null,\n      user_id: evt.userId ?? null,\n      payload: evt.payload ?? null,\n      created_at: new Date().toISOString(),\n    }\n    await admin.from('audit_logs').insert(row)\n    return true\n  } catch {\n    return false\n  }\n}\n","path":null,"size_bytes":1100,"size_tokens":null},"src/components/theme-provider.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { ThemeProvider as NextThemesProvider } from \"next-themes\"\n\ntype Props = React.ComponentProps<typeof NextThemesProvider>\n\nexport function ThemeProvider({ children, ...props }: Props) {\n  return (\n    <NextThemesProvider attribute=\"class\" defaultTheme=\"system\" enableSystem {...props}>\n      {children}\n    </NextThemesProvider>\n  )\n}\n","path":null,"size_bytes":386,"size_tokens":null},"e2e/theme-toggle.spec.ts":{"content":"import { test, expect } from '@playwright/test';\n\ntest.describe('Theme Toggle Feature', () => {\n  test.beforeEach(async ({ page }) => {\n    // Navigate to the homepage before each test\n    await page.goto('/');\n  });\n\n  test('should allow toggling between light and dark themes', async ({ page }) => {\n    // Locate the theme toggle button (Arabic or English accessible name)\n    const themeToggleButton = page.getByRole('button', { name: /(?:تبديل السمة|toggle theme)/i });\n    await expect(themeToggleButton).toBeVisible();\n\n    // Check initial state: the <html> element should not have the 'dark' class\n    const htmlElement = page.locator('html');\n    await expect(htmlElement).not.toHaveClass('dark');\n\n    // --- Switch to Dark Mode ---\n    // Click the button to open the dropdown menu\n    await themeToggleButton.click();\n\n    // Click the 'Dark' menu item (Arabic or English)\n    await page.getByRole('menuitem', { name: /(?:الوضع الداكن|dark)/i }).click();\n\n    // Assert that the html element now has the 'dark' class\n    await expect(htmlElement).toHaveClass('dark');\n\n    // --- Switch back to Light Mode ---\n    // Click the button again to reopen the menu\n    await themeToggleButton.click();\n\n    // Click the 'Light' menu item (Arabic or English)\n    await page.getByRole('menuitem', { name: /(?:الوضع الفاتح|light)/i }).click();\n\n    // Assert that the 'dark' class has been removed\n    await expect(htmlElement).not.toHaveClass('dark');\n  });\n});\n","path":null,"size_bytes":1499,"size_tokens":null},"src/app/api/health/route.ts":{"content":"import { loggerForRequest } from '@/lib/log';\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  const env = {\n    NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\n    STRIPE_SECRET_KEY: !!process.env.STRIPE_SECRET_KEY,\n    STRIPE_WEBHOOK_SECRET: !!process.env.STRIPE_WEBHOOK_SECRET,\n    NEXT_PUBLIC_SITE_URL: !!process.env.NEXT_PUBLIC_SITE_URL,\n    VERCEL_URL: !!process.env.VERCEL_URL,\n  } as const;\n\n  const deployment = {\n    vercel: !!process.env.VERCEL,\n    vercelEnv: process.env.VERCEL_ENV || null,\n  } as const;\n\n  const r = Response.json({\n    ok: true,\n    node: process.version,\n    runtime: 'nodejs',\n    env,\n    deployment,\n    timestamp: new Date().toISOString(),\n  });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":1050,"size_tokens":null},"src/components/account/password-form.tsx":{"content":"\"use client\";\n\nimport React, { useCallback, useRef, useState } from \"react\";\nimport { useToast } from \"@/components/ui/toast-provider\";\nimport SubmitButton from \"@/components/submit-button\";\nimport FormStatusToast from \"@/components/form-status-toast\";\n\ninterface PasswordFormProps {\n  action: (formData: FormData) => Promise<void> | void;\n}\n\nexport default function PasswordForm({ action }: PasswordFormProps) {\n  const { toast } = useToast();\n  const formRef = useRef<HTMLFormElement>(null);\n  const [show, setShow] = useState(false);\n\n  const onSubmit = useCallback((e: React.FormEvent<HTMLFormElement>) => {\n    const form = e.currentTarget;\n    const newPassword = (form.elements.namedItem(\"new_password\") as HTMLInputElement)?.value || \"\";\n    const confirm = (form.elements.namedItem(\"confirm_password\") as HTMLInputElement)?.value || \"\";\n\n    if (newPassword.length < 8) {\n      e.preventDefault();\n      toast({ variant: \"error\", description: \"Password must be at least 8 characters.\" });\n      return;\n    }\n    if (newPassword !== confirm) {\n      e.preventDefault();\n      toast({ variant: \"error\", description: \"Passwords do not match.\" });\n      return;\n    }\n  }, [toast]);\n\n  return (\n    <form ref={formRef} action={action} className=\"space-y-3 max-w-md\" noValidate onSubmit={onSubmit}>\n      <div>\n        <label className=\"block text-sm font-medium mb-1\">New Password</label>\n        <div className=\"relative\">\n          <input\n            name=\"new_password\"\n            type={show ? \"text\" : \"password\"}\n            required\n            minLength={8}\n            autoComplete=\"new-password\"\n            className=\"w-full rounded border px-3 py-2 pr-16\"\n            placeholder=\"••••••••\"\n          />\n          <button\n            type=\"button\"\n            onClick={() => setShow((s) => !s)}\n            className=\"absolute right-2 top-1/2 -translate-y-1/2 text-xs text-gray-600 hover:text-black\"\n            aria-label={show ? \"Hide\" : \"Show\"}\n          >\n            {show ? \"Hide\" : \"Show\"}\n          </button>\n        </div>\n      </div>\n      <div>\n        <label className=\"block text-sm font-medium mb-1\">Confirm Password</label>\n        <input\n          name=\"confirm_password\"\n          type={show ? \"text\" : \"password\"}\n          required\n          minLength={8}\n          autoComplete=\"new-password\"\n          className=\"w-full rounded border px-3 py-2\"\n          placeholder=\"••••••••\"\n        />\n      </div>\n      <SubmitButton label=\"Update Password\" pendingLabel=\"Updating...\" />\n      <FormStatusToast successMessage=\"Password updated\" />\n    </form>\n  );\n}\n","path":null,"size_bytes":2628,"size_tokens":null},"src/app/api/admin/products/clear/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function doClear(_req: Request) {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) {\n    return NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n  }\n\n  // Count products before\n  const before = await supabase.from('products').select('id', { count: 'exact', head: true });\n  const productsCount = before.count ?? 0;\n\n  // 1) Clear cart_items to avoid FK restrictions when deleting products\n  try { await supabase.from('cart_items').delete().neq('id', 0); } catch {}\n\n  // 2) Determine which products are referenced by order_items (keep history)\n  const { data: refs } = await supabase.from('order_items').select('product_id');\n  const referenced = new Set<number>();\n  for (const r of (refs || [])) {\n    const id = (r as any)?.product_id;\n    if (typeof id === 'number') referenced.add(id);\n  }\n\n  // 3) Fetch all product ids\n  const { data: prods } = await supabase.from('products').select('id');\n  const allIds = (prods || []).map((p: any) => p.id as number).filter((n: any) => typeof n === 'number');\n  const toDelete = allIds.filter((id) => !referenced.has(id));\n  const toDeactivate = allIds.filter((id) => referenced.has(id));\n\n  // 4) Hard-delete unreferenced products\n  let deleted = 0;\n  if (toDelete.length > 0) {\n    const { data: delRows } = await supabase\n      .from('products')\n      .delete()\n      .in('id', toDelete)\n      .select('id');\n    deleted = delRows?.length ?? 0;\n  }\n\n  // 5) Soft-deactivate referenced products if column exists\n  let deactivated = 0;\n  try {\n    const hasActive = await hasColumn('products', 'is_active');\n    if (hasActive && toDeactivate.length > 0) {\n      const { data: updRows } = await supabase\n        .from('products')\n        .update({ is_active: false, stock: 0 })\n        .in('id', toDeactivate)\n        .select('id');\n      deactivated = updRows?.length ?? 0;\n    }\n  } catch {}\n\n  return NextResponse.json({ ok: true, productsBefore: productsCount, deleted, deactivated, referencedCount: referenced.size });\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req);\n  const guard = await ensureAdmin();\n  if (!guard.ok) {\n    const r = NextResponse.json({ ok: false, error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  if (await isKillSwitchOn()) {\n    const r = NextResponse.json({ ok: false, error: 'Kill switch is ON. Clear operation is disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const r = await doClear(req);\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n\n// Convenience GET with confirm=1 for quick manual triggering from browser\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  const guard = await ensureAdmin();\n  if (!guard.ok) {\n    const r = NextResponse.json({ ok: false, error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const url = new URL(req.url);\n  const confirm = (url.searchParams.get('confirm') || '').toLowerCase();\n  if (confirm !== '1' && confirm !== 'true' && confirm !== 'yes') {\n    const r = NextResponse.json({ ok: false, error: 'Confirm with ?confirm=1' }, { status: 400, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  if (await isKillSwitchOn()) {\n    const r = NextResponse.json({ ok: false, error: 'Kill switch is ON. Clear operation is disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const r = await doClear(req);\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":4459,"size_tokens":null},"middleware.ts":{"content":"import { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\nimport crypto from 'crypto'\n\nexport function middleware(req: NextRequest) {\n  // Generate a per-request nonce\n  const nonce = crypto.randomBytes(16).toString('base64')\n  // Generate a per-request id for logging correlation\n  const reqId = (req.headers.get('x-request-id') || req.headers.get('x-correlation-id')) ?? crypto.randomUUID()\n\n  // Pass nonce to downstream server components via request headers\n  const requestHeaders = new Headers(req.headers)\n  requestHeaders.set('x-csp-nonce', nonce)\n  requestHeaders.set('x-request-id', reqId)\n\n  const res = NextResponse.next({ request: { headers: requestHeaders } })\n\n  // Build CSP with nonce (remove 'unsafe-inline')\n  const stripe = \"https://*.stripe.com https://m.stripe.network\"\n  const plausible = \"https://plausible.io https://events.plausible.io\"\n  const supabase = \"https://*.supabase.co wss://*.supabase.co https://*.supabase.in wss://*.supabase.in\"\n  const cloudinary = \"https://api.cloudinary.com\"\n  const sentry = \"https://*.sentry.io\"\n\n  const csp = [\n    \"default-src 'self'\",\n    `script-src 'self' 'nonce-${nonce}' ${stripe} ${plausible}`,\n    \"style-src 'self' 'unsafe-inline'\",\n    \"img-src 'self' data: blob: https:\",\n    \"media-src 'self' data: blob: https:\",\n    \"font-src 'self'\",\n    `connect-src 'self' ${supabase} ${stripe} ${cloudinary} ${plausible} ${sentry} https://api.openai.com`,\n    \"frame-src https://*.stripe.com\",\n    \"object-src 'none'\",\n    \"base-uri 'self'\",\n    \"form-action 'self' https://hooks.stripe.com\",\n    \"frame-ancestors 'none'\",\n  ].join('; ')\n\n  res.headers.set('Content-Security-Policy', csp.replace(/\\s{2,}/g, ' ').trim())\n  res.headers.set('x-request-id', reqId)\n\n  return res\n}\n\nexport const config = {\n  matcher: [\n    // Apply to all paths except static assets and API routes that may need streaming\n    '/((?!_next/static|_next/image|favicon.ico|.*\\.(png|jpg|jpeg|svg|webp|gif)|api/stripe/webhook|api/cj/webhook).*)',\n  ],\n}\n","path":null,"size_bytes":2022,"size_tokens":null},"src/components/add-to-cart.tsx":{"content":"\"use client\";\n\nimport { addItem } from \"@/lib/cart-actions\";\nimport { useFormState, useFormStatus } from \"react-dom\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\n\nfunction SubmitButton({ disabled }: { disabled: boolean }) {\n  const { pending } = useFormStatus();\n  const isDisabled = disabled || pending;\n\n  return (\n    <Button\n      type=\"submit\"\n      disabled={isDisabled}\n      variant=\"gradient\"\n      size=\"pill\"\n      className=\"w-full sm:w-auto\"\n      aria-label={disabled ? \"Out of Stock\" : pending ? \"Adding...\" : \"Add to Cart — Fast & Secure\"}\n    >\n      {disabled ? \"Out of Stock\" : pending ? \"Adding...\" : \"Add to Cart — Fast & Secure\"}\n    </Button>\n  );\n}\n\nexport default function AddToCart({ \n  productId,\n  productSlug,\n  selectedOptions, \n  disabled = false,\n  quantity,\n  onQuantityChange,\n}: { \n  productId: number,\n  productSlug?: string,\n  selectedOptions: Record<string, string>, \n  disabled?: boolean,\n  quantity?: number,\n  onQuantityChange?: (q: number) => void,\n}) {\n  const [state, formAction] = useFormState(addItem, null);\n\n  return (\n    <form action={formAction} className=\"mt-6 flex items-stretch gap-4\">\n      <input type=\"hidden\" name=\"productId\" value={productId} />\n      {productSlug ? <input type=\"hidden\" name=\"productSlug\" value={productSlug} /> : null}\n      {Object.entries(selectedOptions).map(([name, value]) => (\n        <input key={name} type=\"hidden\" name={name} value={value} />\n      ))}\n      <Input\n        type=\"number\"\n        name=\"quantity\"\n        value={typeof quantity === 'number' ? quantity : undefined}\n        defaultValue={typeof quantity === 'number' ? undefined : 1}\n        onChange={onQuantityChange ? (e) => onQuantityChange(Math.max(1, Number(e.currentTarget.value || '1'))) : undefined}\n        min={1}\n        className=\"w-20 text-center\"\n      />\n      <SubmitButton disabled={disabled} />\n      {state?.error && <p className=\"mt-2 text-sm text-red-500\">{state.error}</p>}\n      {state?.success && <p className=\"mt-2 text-sm text-green-500\">{state.success}</p>}\n    </form>\n  );\n}\n","path":null,"size_bytes":2112,"size_tokens":null},"src/lib/site.ts":{"content":"export function getSiteUrl(): string {\n  const publicUrl = process.env.NEXT_PUBLIC_SITE_URL;\n  const vercelUrl = process.env.VERCEL_URL;\n\n  const raw =\n    publicUrl && publicUrl.trim().length > 0\n      ? publicUrl\n      : vercelUrl && vercelUrl.trim().length > 0\n      ? (vercelUrl.startsWith(\"http://\") || vercelUrl.startsWith(\"https://\") ? vercelUrl : `https://${vercelUrl}`)\n      : \"http://localhost:3000\";\n\n  try {\n    const normalized = new URL(raw);\n    const href = normalized.toString();\n    return href.endsWith(\"/\") ? href.slice(0, -1) : href;\n  } catch {\n    // Fallback in case of invalid URL\n    return \"http://localhost:3000\";\n  }\n}\n","path":null,"size_bytes":649,"size_tokens":null},"src/components/__tests__/theme-toggle.test.tsx":{"content":"// Mock dropdown menu for this test file to avoid Radix complexity\nimport React from 'react'\njest.mock('@/components/ui/dropdown-menu', () => {\n  return {\n    __esModule: true,\n    DropdownMenu: ({ children }: any) => React.createElement(React.Fragment, null, children),\n    DropdownMenuTrigger: ({ asChild, children }: any) => React.cloneElement(children, {}),\n    DropdownMenuContent: ({ children }: any) => React.createElement('div', { role: 'menu' }, children),\n    DropdownMenuItem: ({ children, onClick }: any) => React.createElement('div', { role: 'menuitem', onClick }, children),\n  };\n});\n\n// Mock next-themes module and control its return per-test\njest.mock('next-themes', () => ({\n  __esModule: true,\n  useTheme: jest.fn(),\n}));\n\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react'\nimport userEvent from '@testing-library/user-event'\nimport * as nextThemes from 'next-themes'\nimport { ThemeToggle } from '../theme-toggle'\n\ndescribe('ThemeToggle Component', () => {\n  let setTheme: jest.Mock;\n\n  beforeEach(() => {\n    setTheme = jest.fn();\n    const mockedUseTheme = (nextThemes as any).useTheme as jest.Mock;\n    mockedUseTheme.mockReset();\n    mockedUseTheme.mockReturnValue({\n      setTheme,\n      theme: 'light',\n      themes: ['light', 'dark', 'system'],\n    } as any);\n  });\n\n  it('should render the toggle button', () => {\n    render(<ThemeToggle />)\n    const button = screen.getByRole('button', { name: /toggle theme/i })\n    expect(button).toBeInTheDocument()\n  })\n\n  it('should open the dropdown and show theme options on click', async () => {\n    const user = userEvent.setup()\n    render(<ThemeToggle />)\n    const button = screen.getByRole('button', { name: /toggle theme/i })\n    await user.click(button)\n\n    expect(await screen.findByRole('menuitem', { name: /light/i })).toBeInTheDocument()\n    expect(await screen.findByRole('menuitem', { name: /dark/i })).toBeInTheDocument()\n    expect(await screen.findByRole('menuitem', { name: /system/i })).toBeInTheDocument()\n  })\n\n  it('should call setTheme with \"light\" when light option is clicked', async () => {\n    render(<ThemeToggle />)\n    fireEvent.click(screen.getByRole('button', { name: /toggle theme/i }))\n    const lightItem = await screen.findByRole('menuitem', { name: /light/i })\n    fireEvent.click(lightItem)\n\n    await waitFor(() => expect(setTheme).toHaveBeenCalledWith('light'))\n  })\n\n  it('should call setTheme with \"dark\" when dark option is clicked', async () => {\n    render(<ThemeToggle />)\n    fireEvent.click(screen.getByRole('button', { name: /toggle theme/i }))\n    const darkItem = await screen.findByRole('menuitem', { name: /dark/i })\n    fireEvent.click(darkItem)\n\n    await waitFor(() => expect(setTheme).toHaveBeenCalledWith('dark'))\n  })\n\n  it('should call setTheme with \"system\" when system option is clicked', async () => {\n    render(<ThemeToggle />)\n    fireEvent.click(screen.getByRole('button', { name: /toggle theme/i }))\n    const systemItem = await screen.findByRole('menuitem', { name: /system/i })\n    fireEvent.click(systemItem)\n\n    await waitFor(() => expect(setTheme).toHaveBeenCalledWith('system'))\n  })\n})\n","path":null,"size_bytes":3156,"size_tokens":null},"src/app/admin/cj/refresh/page.tsx":{"content":"\"use client\"\n\nimport { useState } from 'react'\n\nexport default function CjRefreshPage() {\n  const [catLoading, setCatLoading] = useState(false)\n  const [catResp, setCatResp] = useState<any>(null)\n  const [prodLoading, setProdLoading] = useState(false)\n  const [prodResp, setProdResp] = useState<any>(null)\n  const [quickLoading, setQuickLoading] = useState(false)\n  const [quickResp, setQuickResp] = useState<any>(null)\n\n  async function runCatalog(formData: FormData) {\n    setCatLoading(true)\n    setCatResp(null)\n    const pageNum = Number(formData.get('pageNum') || 1)\n    const pageSize = Number(formData.get('pageSize') || 20)\n    const keyword = String(formData.get('keyword') || '')\n    const updateImages = formData.get('updateImages') === 'on'\n    const updateVideo = formData.get('updateVideo') === 'on'\n    const updatePrice = formData.get('updatePrice') === 'on'\n    const qs = new URLSearchParams({\n      pageNum: String(pageNum),\n      pageSize: String(pageSize),\n      ...(keyword ? { keyword } : {}),\n      updateImages: String(updateImages),\n      updateVideo: String(updateVideo),\n      updatePrice: String(updatePrice),\n    })\n    try {\n      const res = await fetch(`/api/cj/sync/catalog?${qs.toString()}`, { cache: 'no-store' })\n      const j = await res.json()\n      setCatResp({ status: res.status, body: j })\n    } catch (e: any) {\n      setCatResp({ error: e?.message || String(e) })\n    } finally {\n      setCatLoading(false)\n    }\n  }\n\n  async function runProduct(formData: FormData) {\n    setProdLoading(true)\n    setProdResp(null)\n    const pid = String(formData.get('pid') || '').trim()\n    const updateImages = formData.get('p_updateImages') === 'on'\n    const updateVideo = formData.get('p_updateVideo') === 'on'\n    const updatePrice = formData.get('p_updatePrice') === 'on'\n    if (!pid) { setProdResp({ error: 'pid required' }); setProdLoading(false); return }\n    const qs = new URLSearchParams({\n      updateImages: String(updateImages),\n      updateVideo: String(updateVideo),\n      updatePrice: String(updatePrice),\n    })\n    try {\n      const res = await fetch(`/api/cj/sync/product/${encodeURIComponent(pid)}?${qs.toString()}`, { cache: 'no-store' })\n      const j = await res.json()\n      setProdResp({ status: res.status, body: j })\n    } catch (e: any) {\n      setProdResp({ error: e?.message || String(e) })\n    } finally {\n      setProdLoading(false)\n    }\n  }\n\n  async function quickImport(formData: FormData) {\n    setQuickLoading(true)\n    setQuickResp(null)\n    const pages = Math.max(1, Number(formData.get('q_pages') || 1))\n    const pageSize = Math.min(50, Math.max(1, Number(formData.get('q_pageSize') || 12)))\n    const keyword = String(formData.get('q_keyword') || 'women dress')\n    const updateImages = true\n    const updateVideo = true\n    const updatePrice = true\n    const results: any[] = []\n    try {\n      for (let i = 1; i <= pages; i++) {\n        const qs = new URLSearchParams({\n          pageNum: String(i),\n          pageSize: String(pageSize),\n          keyword,\n          updateImages: String(updateImages),\n          updateVideo: String(updateVideo),\n          updatePrice: String(updatePrice),\n        })\n        // eslint-disable-next-line no-await-in-loop\n        const res = await fetch(`/api/cj/sync/catalog?${qs.toString()}`, { cache: 'no-store' })\n        // eslint-disable-next-line no-await-in-loop\n        const j = await res.json()\n        results.push({ status: res.status, body: j })\n      }\n      const okCount = results.reduce((acc, r) => acc + (Number(r?.body?.count) || 0), 0)\n      setQuickResp({ ok: true, imported: okCount, pages, pageSize, keyword, results })\n    } catch (e: any) {\n      setQuickResp({ ok: false, error: e?.message || String(e), pages, pageSize, keyword, results })\n    } finally {\n      setQuickLoading(false)\n    }\n  }\n\n  return (\n    <main className=\"mx-auto max-w-3xl p-6 space-y-8\">\n      <h1 className=\"text-2xl font-semibold\">Catalog Refresh</h1>\n\n      <section className=\"space-y-3 border rounded p-4\">\n        <h2 className=\"text-lg font-medium\">Quick Import: Women Dresses</h2>\n        <form action={quickImport} className=\"grid grid-cols-2 gap-3\">\n          <label className=\"col-span-2 flex flex-col text-sm\">Keyword<input name=\"q_keyword\" defaultValue=\"women dress\" className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">Pages<input name=\"q_pages\" type=\"number\" defaultValue={2} min={1} className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">Page Size<input name=\"q_pageSize\" type=\"number\" defaultValue={12} min={1} max={50} className=\"border rounded px-2 py-1\"/></label>\n          <div className=\"col-span-2\">\n            <button type=\"submit\" disabled={quickLoading} className=\"bg-green-600 text-white px-4 py-2 rounded disabled:opacity-50\">{quickLoading ? 'Importing…' : 'Import Dresses Now'}</button>\n          </div>\n        </form>\n        {quickResp && (\n          <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-80\">{JSON.stringify(quickResp, null, 2)}</pre>\n        )}\n      </section>\n\n      <section className=\"space-y-3 border rounded p-4\">\n        <h2 className=\"text-lg font-medium\">Batch Catalog Sync</h2>\n        <form action={runCatalog} className=\"grid grid-cols-2 gap-3\">\n          <label className=\"flex flex-col text-sm\">Page Number<input name=\"pageNum\" type=\"number\" defaultValue={1} min={1} className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">Page Size<input name=\"pageSize\" type=\"number\" defaultValue={20} min={1} max={50} className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"col-span-2 flex flex-col text-sm\">Keyword (optional)<input name=\"keyword\" placeholder=\"e.g. women dress\" className=\"border rounded px-2 py-1\"/></label>\n          <div className=\"col-span-2 flex items-center gap-6 text-sm\">\n            <label className=\"inline-flex items-center gap-2\"><input name=\"updateImages\" type=\"checkbox\" defaultChecked/>Update Images</label>\n            <label className=\"inline-flex items-center gap-2\"><input name=\"updateVideo\" type=\"checkbox\" defaultChecked/>Update Video</label>\n            <label className=\"inline-flex items-center gap-2\"><input name=\"updatePrice\" type=\"checkbox\" defaultChecked/>Update Price</label>\n          </div>\n          <div className=\"col-span-2\">\n            <button type=\"submit\" disabled={catLoading} className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\">{catLoading ? 'Working...' : 'Run Batch'}</button>\n          </div>\n        </form>\n        {catResp && (\n          <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-80\">{JSON.stringify(catResp, null, 2)}</pre>\n        )}\n      </section>\n\n      <section className=\"space-y-3 border rounded p-4\">\n        <h2 className=\"text-lg font-medium\">Re-sync Single Product (by Product ID)</h2>\n        <form action={runProduct} className=\"grid grid-cols-2 gap-3\">\n          <label className=\"col-span-2 flex flex-col text-sm\">Product ID<input name=\"pid\" placeholder=\"e.g. GUID pid\" className=\"border rounded px-2 py-1\"/></label>\n          <div className=\"col-span-2 flex items-center gap-6 text-sm\">\n            <label className=\"inline-flex items-center gap-2\"><input name=\"p_updateImages\" type=\"checkbox\" defaultChecked/>Update Images</label>\n            <label className=\"inline-flex items-center gap-2\"><input name=\"p_updateVideo\" type=\"checkbox\" defaultChecked/>Update Video</label>\n            <label className=\"inline-flex items-center gap-2\"><input name=\"p_updatePrice\" type=\"checkbox\" defaultChecked/>Update Price</label>\n          </div>\n          <div className=\"col-span-2\">\n            <button type=\"submit\" disabled={prodLoading} className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\">{prodLoading ? 'Working...' : 'Re-sync Product'}</button>\n          </div>\n        </form>\n        {prodResp && (\n          <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-80\">{JSON.stringify(prodResp, null, 2)}</pre>\n        )}\n      </section>\n    </main>\n  )\n}\n","path":null,"size_bytes":8164,"size_tokens":null},"branding/suppliers/ddp-all-in-pricing-request-en.md":{"content":"# DDP All-In Pricing Request — Saudi Arabia (Shopixo)\n\nWe request a per-unit “All-In” Delivered Duty Paid (DDP) quotation to Saudi Arabia that includes:\n- International freight to KSA (door-to-door)\n- Customs duty according to HS code (Customs Duty)\n- Saudi import VAT 15%\n- Customs services/clearance fees and any carrier surcharges (Fuel/Remote/Address correction…)\n- Final delivery to consignee (door delivery)\n\nOperational requirements:\n- Blind shipping — Shipper name on label: Shopixo\n- Include Shopixo packing slip + thank-you insert in every parcel (we provide PDF/HTML)\n- Share tracking within 24 hours of handover\n- State typical transit time to KSA for Economy/Express\n- Identify the Importer of Record (Supplier vs Shopixo)\n- State the dimensional divisor used (e.g., 5000)\n\nPlease provide a clear rate matrix or a final per-unit price for each product per the attached SKU specs.\n\nIn your quotation, explicitly confirm:\n- VAT inclusion: Does the price explicitly include Saudi import VAT 15%?\n- Duty inclusion: Does the price include Customs Duty as per HS? State rate/basis.\n- Customs/clearance inclusion: Are customs service fees, brokerage, and surcharges included?\n- IOR: Identify the party (Supplier or Shopixo). If Supplier, clarify invoicing/evidence policy.\n- Services: Economy/Express + typical door-to-door transit time.\n\nWe will share the SKU specification sheet (HS, weights, final packed dimensions, and typical shipment quantity).\n\nThank you.\n","path":null,"size_bytes":1480,"size_tokens":null},"src/app/admin/layout.tsx":{"content":"import { ReactNode } from \"react\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { AdminLayoutClient } from \"./AdminLayoutClient\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function AdminLayout({ children }: { children: ReactNode }) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    redirect(\"/login?next=/admin\");\n  }\n\n  const adminEmails = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((e) => e.trim().toLowerCase())\n    .filter(Boolean);\n  const adminDomains = (process.env.ADMIN_EMAIL_DOMAINS || \"\")\n    .split(\",\")\n    .map((d) => d.trim().toLowerCase().replace(/^@/, \"\"))\n    .filter(Boolean);\n  const email = (user.email || \"\").toLowerCase();\n\n  if (adminEmails.length > 0 || adminDomains.length > 0) {\n    const matchesEmail = email && adminEmails.includes(email);\n    const matchesDomain = email.includes(\"@\") && adminDomains.includes(email.split(\"@\")[1]);\n    if (!(matchesEmail || matchesDomain)) redirect(\"/\");\n  }\n\n  return (\n    <AdminLayoutClient email={email}>\n      {children}\n    </AdminLayoutClient>\n  );\n}\n","path":null,"size_bytes":1303,"size_tokens":null},"src/app/auth/debug/route.ts":{"content":"import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'\nimport { cookies } from 'next/headers'\nimport { NextResponse } from 'next/server'\n\nexport const dynamic = 'force-dynamic'\nexport const runtime = 'nodejs'\n\nexport async function GET() {\n  const supabase = createRouteHandlerClient({ cookies })\n  const { data: { user }, error } = await supabase.auth.getUser()\n  return NextResponse.json({\n    ok: !!user && !error,\n    user: user ? { id: user.id, email: user.email, provider: (user.app_metadata as any)?.provider } : null,\n    error: error?.message || null,\n  })\n}\n","path":null,"size_bytes":586,"size_tokens":null},"src/app/api/search/route.ts":{"content":"import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { getClientIp, searchLimiter } from \"@/lib/ratelimit\";\nimport { loggerForRequest } from \"@/lib/log\";\n\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  const { searchParams } = new URL(req.url);\n  const q = (searchParams.get(\"q\") || \"\").trim();\n  // Rate limit (Upstash Redis)\n  try {\n    const ip = getClientIp(req);\n    const { success } = await searchLimiter.limit(ip);\n    if (!success) {\n      const r = NextResponse.json({ items: [], error: 'rate_limited' }, { status: 429 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n  } catch (e) {\n    // if rate limit infra fails, do not block search\n  }\n\n  // Minimal input validation\n  if (!q) {\n    const r = NextResponse.json({ items: [] });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  if (q.length < 2) {\n    const r = NextResponse.json({ items: [] });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  if (!url || !anon) {\n    // Gracefully degrade if env missing during build or misconfiguration\n    const r = NextResponse.json({ items: [], error: \"Supabase env not configured\" }, { status: 200 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const supabase = createClient(url, anon);\n  // Basic search on title (ilike). In production consider full-text indexes.\n  // Prefer active products; gracefully fallback if column is missing (pre-migration).\n  let query = supabase\n    .from(\"products\")\n    .select(\"id, slug, title, price, images\")\n    .ilike(\"title\", `%${q}%`)\n    .or(\"is_active.is.null,is_active.eq.true\")\n    .limit(8) as any;\n\n  const { data, error } = await query;\n  if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n    // Fallback: same query without the is_active filter\n    const { data: fbData, error: fbErr } = await supabase\n      .from(\"products\")\n      .select(\"id, slug, title, price, images\")\n      .ilike(\"title\", `%${q}%`)\n      .limit(8);\n    if (fbErr) {\n      const r = NextResponse.json({ items: [], error: fbErr.message }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const r = NextResponse.json({ items: fbData ?? [] });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  if (error) {\n    const r = NextResponse.json({ items: [], error: error.message }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const r = NextResponse.json({ items: data ?? [] });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":2926,"size_tokens":null},"src/lib/types.ts":{"content":"export type ProductVariant = {\n  id: number;\n  product_id: number;\n  option_name: string; // e.g., \"Size\"\n  option_value: string; // e.g., S | M | L | XL | XXL | XXXL\n  cj_sku: string | null;\n  cj_variant_id?: string | null;\n  price: number | null; // if null, fallback to product.price\n  stock: number | null; // null = unknown (CJ didn't provide), 0 = truly zero, positive = known\n  // CJ-specific variant data\n  variant_key?: string | null; // Short variant name from CJ (e.g., \"Black And Silver-2XL\")\n  cj_stock?: number | null; // Stock in CJ warehouse (verified, ready to ship)\n  factory_stock?: number | null; // Stock at supplier factory (may require 1-3 days processing)\n  // Optional shipping metadata (if available from CJ)\n  weight_grams?: number | null;\n  length_cm?: number | null;\n  width_cm?: number | null;\n  height_cm?: number | null;\n};\n\nexport type Product = {\n  id: number;\n  title: string;\n  slug: string;\n  description: string;\n  price: number;\n  images: string[];\n  category: string;\n  rating: number;\n  stock: number | null; // null = all variants have unknown stock\n  // UI-oriented variants selector (kept for backward compatibility)\n  variants: { name: string; options: string[] }[];\n  is_active?: boolean; // soft delete flag (optional to avoid breaking existing code)\n\n  // Product codes\n  product_code?: string | null; // Shopixo public code (XO00001 format) - visible to customers\n  supplier_sku?: string | null; // Supplier SKU from CJ - admin only\n\n  // Shipping and CJ linkage metadata (optional)\n  video_url?: string | null;\n  processing_time_hours?: number | null;\n  delivery_time_hours?: number | null;\n  origin_area?: string | null;\n  origin_country_code?: string | null;\n  free_shipping?: boolean;\n  inventory_shipping_fee?: number | null;\n  last_mile_fee?: number | null;\n  cj_product_id?: string | null;\n  shipping_from?: string | null;\n};\n\nexport type OrderItem = {\n  id: number;\n  quantity: number;\n  price: number;\n  product: Product;\n};\n\nexport type Order = {\n  id: number;\n  created_at: string;\n  total_amount: number;\n  status: string;\n  user_id: string;\n  order_items: OrderItem[];\n  // This will be populated after joining with the users table\n  user_email?: string;\n  // Stripe metadata\n  stripe_session_id?: string | null;\n  // CJ fulfillment and tracking\n  cj_order_no?: string | null;\n  shipping_status?: string | null;\n  tracking_number?: string | null;\n  carrier?: string | null;\n};\n\nexport type CartItem = {\n  id: number;\n  quantity: number;\n  product: Product | null;\n  variant?: ProductVariant | null;\n};\n\nexport type Address = {\n  id: number;\n  user_id: string;\n  full_name: string;\n  phone: string | null;\n  line1: string;\n  line2: string | null;\n  city: string;\n  state: string | null;\n  postal_code: string | null;\n  country: string;\n  is_default: boolean;\n  created_at?: string;\n};\n\nexport type Review = {\n  id: number;\n  user_id: string;\n  product_id: number;\n  rating: number; // 1..5\n  title: string | null;\n  body: string | null;\n  created_at?: string;\n};\n","path":null,"size_bytes":3024,"size_tokens":null},"src/app/brand/thank-you-insert/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport default function ThankYouInsertRedirect() {\n  redirect(\"/brand/thank-you-insert.html\");\n}\n","path":null,"size_bytes":142,"size_tokens":null},"src/app/brand/layout.tsx":{"content":"import \"@/app/globals.css\";\nimport type { Metadata } from \"next\";\n\nexport const metadata: Metadata = {\n  title: \"Brand Review — Shopixo\",\n  description: \"Internal brand preview for Shopixo (logos, colors, packaging).\",\n};\n\nexport default function BrandLayout({ children }: { children: React.ReactNode }) {\n  return (\n    <section id=\"brand-preview\" className=\"min-h-screen\">\n      {children}\n    </section>\n  );\n}\n","path":null,"size_bytes":416,"size_tokens":null},"src/app/auth/signout/route.ts":{"content":"import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'\nimport { cookies } from 'next/headers'\nimport { NextResponse } from 'next/server'\n\nimport type { NextRequest } from 'next/server'\n \n export const dynamic = 'force-dynamic'\n export const runtime = 'nodejs'\n\nexport async function POST(request: NextRequest) {\n  const requestUrl = new URL(request.url)\n  const supabase = createRouteHandlerClient({ cookies })\n\n  await supabase.auth.signOut()\n\n  return NextResponse.redirect(`${requestUrl.origin}/login`, {\n    status: 302,\n  })\n}\n","path":null,"size_bytes":550,"size_tokens":null},"src/app/api/admin/cj/products/import/quick/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, type CjProductLike } from '@/lib/cj/v2';\nimport { slugify } from '@/lib/utils/slug';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { hasTable, hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function columnExists(_admin: any, table: string, col: string): Promise<boolean> {\n  // Backward-compatible wrapper around centralized feature detection\n  return await hasColumn(table, col);\n}\n\nasync function omitMissingProductColumns(_admin: any, payload: Record<string, any>, cols: string[]) {\n  for (const c of cols) {\n    if (!(c in payload)) continue;\n    try {\n      const exists = await hasColumn('products', c);\n      if (!exists) delete payload[c];\n    } catch {\n      delete payload[c];\n    }\n  }\n}\n\nasync function productVariantsTableExists(_admin: any): Promise<boolean> {\n  return await hasTable('product_variants');\n}\n\nfunction extractPidFromUrl(u?: string | null): string | undefined {\n  if (!u) return undefined;\n  try {\n    const url = new URL(u);\n    const cand = url.searchParams.get('pid') || url.searchParams.get('productId') || url.searchParams.get('id');\n    if (cand) return cand;\n    const m = url.href.match(/[0-9A-Fa-f-]{16,}/);\n    return m?.[0];\n  } catch {\n    return undefined;\n  }\n}\n\nasync function ensureUniqueSlug(admin: any, base: string): Promise<string> {\n  const s = slugify(base);\n  let candidate = s;\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin\n      .from('products')\n      .select('id')\n      .eq('slug', candidate)\n      .maybeSingle();\n    if (!data) return candidate;\n    candidate = `${s}-${i}`;\n  }\n  return `${s}-${Date.now()}`;\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'quick-v2', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Global kill-switch enforcement\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, version: 'quick-v2', error: 'Kill switch is ON. Import is disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const { searchParams } = new URL(req.url);\n\n    // Collect PIDs from multiple forms: pid=, pids=csv, url=, urls=csv\n    const pids = new Set<string>();\n\n    const pidParams = searchParams.getAll('pid');\n    for (const p of pidParams) if (p && p.trim()) pids.add(p.trim());\n\n    const pidsCsv = searchParams.get('pids');\n    if (pidsCsv) {\n      for (const p of pidsCsv.split(',').map((s) => s.trim()).filter(Boolean)) pids.add(p);\n    }\n\n    const urlParams = searchParams.getAll('url');\n    for (const u of urlParams) {\n      const pid = extractPidFromUrl(u);\n      if (pid) pids.add(pid);\n    }\n\n    const urlsCsv = searchParams.get('urls');\n    if (urlsCsv) {\n      for (const u of urlsCsv.split(',').map((s) => s.trim()).filter(Boolean)) {\n        const pid = extractPidFromUrl(u);\n        if (pid) pids.add(pid);\n      }\n    }\n\n    if (pids.size === 0) {\n      const r = NextResponse.json({ ok: false, error: 'Provide pid=... or url=... (supports multiple)' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Optional pricing params\n    const marginPct = Math.max(0, Number(searchParams.get('marginPct') || '0'));\n    const shippingSar = Math.max(0, Number(searchParams.get('shippingSar') || '0'));\n\n    // 1) Fetch CJ items by PID\n    const fetched: CjProductLike[] = [];\n    for (const pid of Array.from(pids)) {\n      try {\n        const raw = await queryProductByPidOrKeyword({ pid });\n        const itemRaw = Array.isArray(raw?.data?.list)\n          ? raw.data.list[0]\n          : Array.isArray(raw?.data?.content)\n            ? raw.data.content[0]\n            : Array.isArray(raw?.content)\n              ? raw.content[0]\n              : Array.isArray(raw?.data)\n                ? raw.data[0]\n                : (raw?.data || raw);\n        const mapped = mapCjItemToProductLike(itemRaw);\n        if (mapped) fetched.push(mapped);\n      } catch (e) {\n        // continue\n      }\n    }\n\n    if (fetched.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'No CJ products found for provided inputs' }, { status: 404 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // 2) Import\n    const results: any[] = [];\n\n    for (const cj of fetched) {\n      try {\n        let existing: any = null;\n        if (await columnExists(supabase, 'products', 'cj_product_id')) {\n          const resp = await supabase\n            .from('products')\n            .select('id, slug')\n            .eq('cj_product_id', cj.productId)\n            .maybeSingle();\n          existing = resp.data || null;\n        }\n\n        const baseSlug = await ensureUniqueSlug(supabase, cj.name);\n        const priceCandidates = (cj.variants || []).map((v) => (typeof v.price === 'number' ? v.price : NaN)).filter((n) => !isNaN(n));\n        const baseCost = priceCandidates.length > 0 ? Math.min(...priceCandidates) : 0;\n        const defaultPrice = marginPct > 0 || shippingSar > 0\n          ? Math.round((baseCost + shippingSar) * (1 + marginPct))\n          : baseCost;\n        const totalStock = (cj.variants || []).reduce((acc, v) => acc + (typeof v.stock === 'number' ? v.stock : 0), 0);\n\n        let productPayload: any = {\n          title: cj.name,\n          slug: existing?.slug || baseSlug,\n          price: defaultPrice,\n          category: 'Women',\n          stock: totalStock,\n        };\n\n        // optional fields\n        const optional: Record<string, any> = {\n          description: '',\n          images: cj.images || [],\n          video_url: cj.videoUrl || null,\n          processing_time_hours: null,\n          delivery_time_hours: cj.deliveryTimeHours ?? null,\n          origin_area: cj.originArea ?? null,\n          origin_country_code: cj.originCountryCode ?? null,\n          free_shipping: true,\n          inventory_shipping_fee: 0,\n          last_mile_fee: 0,\n          cj_product_id: cj.productId,\n          shipping_from: cj.originArea ?? null,\n          is_active: true,\n        };\n\n        // Prune optional fields that do not exist in schema\n        await omitMissingProductColumns(supabase, optional, [\n          'description','images','video_url','processing_time_hours','delivery_time_hours','origin_area','origin_country_code',\n          'free_shipping','inventory_shipping_fee','last_mile_fee','shipping_from','cj_product_id','is_active'\n        ]);\n\n        let productId: number;\n        if (existing?.id) {\n          const { data: upd, error: upErr } = await supabase\n            .from('products')\n            .update({ ...productPayload, ...optional })\n            .eq('id', existing.id)\n            .select('id')\n            .single();\n          if (upErr || !upd) throw upErr || new Error('Failed to update product');\n          productId = upd.id as number;\n        } else {\n          // Insert with basic idempotency on slug conflicts\n          let insResult: any = null;\n          try {\n            const { data: ins, error: insErr } = await supabase\n              .from('products')\n              .insert(productPayload)\n              .select('id')\n              .single();\n            if (insErr || !ins) throw insErr || new Error('Failed to insert product');\n            insResult = ins;\n          } catch (e: any) {\n            const msg = String(e?.message || e || '');\n            if (/duplicate key|unique constraint|unique violation|already exists/i.test(msg)) {\n              const base = productPayload.slug || slugify(cj.name);\n              productPayload.slug = await ensureUniqueSlug(supabase, base);\n              const { data: ins2, error: err2 } = await supabase\n                .from('products')\n                .insert(productPayload)\n                .select('id')\n                .single();\n              if (err2 || !ins2) throw err2 || new Error('Failed to insert product (retry)');\n              insResult = ins2;\n            } else {\n              throw e;\n            }\n          }\n          productId = insResult.id as number;\n        }\n\n        // Optional update with pruned optional fields\n        if (Object.keys(optional).length > 0) {\n          await supabase.from('products').update(optional).eq('id', productId);\n        }\n\n        // Variants: only if table exists\n        if (await productVariantsTableExists(supabase)) {\n          const variantsRows = (cj.variants || [])\n            .filter((v) => v && (v.size || v.cjSku))\n            .map((v) => ({\n              product_id: productId,\n              option_name: 'Size',\n              option_value: v.size || '-',\n              cj_sku: v.cjSku || null,\n              price: typeof v.price === 'number' ? v.price : null,\n              stock: typeof v.stock === 'number' ? v.stock : 0,\n            }));\n          if (variantsRows.length > 0) {\n            const { error: vErr } = await supabase.from('product_variants').insert(variantsRows);\n            if (vErr) throw vErr;\n          }\n        }\n\n        try {\n          await supabase.rpc('recompute_product_stock', { product_id_in: productId });\n        } catch {}\n\n        results.push({ ok: true, productId, title: cj.name });\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e), title: cj?.name });\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, version: 'quick-v2', imported: results.filter(r => r.ok).length, results }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, version: 'quick-v2', error: e?.message || 'Quick import failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":10822,"size_tokens":null},"src/app/api/cj/shipping/calc/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { shippingLimiter, getClientIp } from '@/lib/ratelimit'\nimport { loggerForRequest } from '@/lib/log'\nimport { freightCalculate } from '@/lib/cj/v2'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const ip = getClientIp(req)\n    const { success } = await shippingLimiter.limit(`ship:${ip}`)\n    if (!success) {\n      const r = NextResponse.json({ ok: false, error: 'Too many requests' }, { status: 429 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Uses CJ's \"According to Shipping Method\" - exact pre-calculated shipping options\n    const Body = z.object({\n      countryCode: z.string().min(2).max(3),\n      quantity: z.number().int().positive().default(1),\n      vid: z.string().min(1), // variant ID (UUID) - required for exact CJ shipping data\n    })\n    let parsed: z.infer<typeof Body>\n    try {\n      const json = await req.json()\n      parsed = Body.parse(json)\n    } catch (e: any) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid body - vid (variant UUID) is required', details: e?.errors || String(e) }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const res = await freightCalculate({\n      countryCode: parsed.countryCode.toUpperCase(),\n      quantity: parsed.quantity,\n      vid: parsed.vid,\n    })\n    \n    if (!res.ok) {\n      const r = NextResponse.json({ ok: false, error: res.message, reason: res.reason }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    \n    const r = NextResponse.json({ ok: true, options: res.options })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'shipping calc failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2066,"size_tokens":null},"src/app/admin/blog/delete-button.tsx":{"content":"\"use client\";\n\nimport { useFormState } from \"react-dom\";\nimport { deleteBlogPost } from \"@/app/admin/blog/actions\";\n\ntype DeleteState = { error?: string | null; success?: boolean };\n\nconst initialState: DeleteState = { error: null, success: false };\n\nexport default function DeleteBlogPostButton({ postId }: { postId: number }) {\n  const [state, formAction] = useFormState(deleteBlogPost, initialState);\n\n  return (\n    <form\n      action={formAction}\n      onSubmit={(e) => {\n        if (!window.confirm(\"Are you sure you want to delete this post?\")) {\n          e.preventDefault();\n        }\n      }}\n      className=\"inline-block\"\n    >\n      <input type=\"hidden\" name=\"id\" value={postId} />\n      <button type=\"submit\" className=\"text-sm font-medium text-red-600 hover:underline\">\n        Delete\n      </button>\n      {state?.error && <p className=\"mt-1 text-xs text-red-600\">{state.error}</p>}\n    </form>\n  );\n}\n","path":null,"size_bytes":918,"size_tokens":null},"src/app/api/cj/seed/many/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { loggerForRequest } from '@/lib/log'\nimport { createClient } from '@supabase/supabase-js'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, type CjProductLike } from '@/lib/cj/v2'\nimport { upsertProductFromCj, persistRawCj } from '@/lib/ops/cj-sync'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const Q = z.object({\n      keywords: z.string().min(1), // comma-separated list\n      limit: z.coerce.number().min(1).max(20).default(6),\n      token: z.string().optional(),\n    })\n    const { searchParams } = new URL(req.url)\n    const q = Q.parse({\n      keywords: searchParams.get('keywords') || '',\n      limit: searchParams.get('limit') || '6',\n      token: searchParams.get('token') || undefined,\n    })\n\n    const db = getAdmin()\n    if (!db) {\n      const r = NextResponse.json({ ok: false, error: 'Supabase not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Access policy similar to seed/one: allow if products=0 else require token match\n    const { count: productsCountRaw } = await db.from('products').select('id', { count: 'exact', head: true })\n    const productsCount = typeof productsCountRaw === 'number' ? productsCountRaw : 0\n    const tokenEnv = String(process.env.SEED_IMPORT_TOKEN || '')\n    const disabled = String(process.env.SEED_IMPORT_DISABLED || '').toLowerCase() === 'true'\n    const allowWithoutToken = productsCount === 0\n    const tokenOk = !!tokenEnv && q.token === tokenEnv\n    if (disabled || (!allowWithoutToken && !tokenOk)) {\n      const r = NextResponse.json({ ok: false, error: 'Seed not allowed' }, { status: 403 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const keywords = q.keywords\n      .split(',')\n      .map((s) => s.trim())\n      .filter(Boolean)\n      .slice(0, 10)\n\n    if (keywords.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'Provide ?keywords=women%20dress,women%20blouse&limit=6' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // 1) Query CJ for each keyword and map\n    const pool: CjProductLike[] = []\n    for (const kw of keywords) {\n      try {\n        const raw = await queryProductByPidOrKeyword({ keyword: kw })\n        const itemsRaw = Array.isArray(raw?.data?.list)\n          ? raw.data.list\n          : Array.isArray(raw?.data?.content)\n            ? raw.data.content\n            : Array.isArray(raw?.content)\n              ? raw.content\n              : Array.isArray(raw?.data)\n                ? raw.data\n                : []\n        for (const it of itemsRaw) {\n          const mapped = mapCjItemToProductLike(it)\n          if (mapped) pool.push(mapped)\n        }\n      } catch {}\n    }\n\n    // 2) Deduplicate by productId and select first N\n    const seen = new Set<string>()\n    const selected: CjProductLike[] = []\n    for (const it of pool) {\n      if (!it.productId) continue\n      if (seen.has(it.productId)) continue\n      seen.add(it.productId)\n      selected.push(it)\n      if (selected.length >= q.limit) break\n    }\n\n    if (selected.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'No CJ products found from given keywords' }, { status: 404 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // 3) Import each\n    const results: any[] = []\n    for (const cj of selected) {\n      try {\n        // Enrich via detail fetch by PID for better media/variants\n        let enriched = cj\n        try {\n          const d = await queryProductByPidOrKeyword({ pid: cj.productId })\n          const dlist: any[] = Array.isArray(d?.data?.content)\n            ? d.data.content\n            : Array.isArray(d?.data?.list)\n              ? d.data.list\n              : Array.isArray(d?.content)\n                ? d.content\n                : Array.isArray(d?.data)\n                  ? d.data\n                  : []\n          if (dlist && dlist[0]) {\n            const remap = mapCjItemToProductLike(dlist[0])\n            if (remap) enriched = remap\n          }\n        } catch {}\n\n        const up = await upsertProductFromCj(enriched, { updateImages: true, updateVideo: true, updatePrice: true })\n        if (!('ok' in up) || !up.ok) {\n          results.push({ ok: false, error: (up as any).error || 'Upsert failed', productId: null })\n          continue\n        }\n        try { await persistRawCj(up.productId, cj as any) } catch {}\n\n        // fetch slug for convenience\n        let slug: string | undefined\n        try {\n          const { data } = await db.from('products').select('slug').eq('id', up.productId).maybeSingle()\n          slug = data?.slug || undefined\n        } catch {}\n\n        results.push({ ok: true, productId: up.productId, slug })\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e), productId: null })\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, imported: results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'batch seed failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":5606,"size_tokens":null},"src/app/success/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default function LegacySuccessPage({\n  searchParams,\n}: {\n  searchParams?: Record<string, string | string[] | undefined>;\n}) {\n  const params = new URLSearchParams();\n  for (const [k, v] of Object.entries(searchParams || {})) {\n    if (Array.isArray(v)) v.forEach((val) => params.append(k, val));\n    else if (v != null) params.set(k, v);\n  }\n  redirect(`/checkout/success${params.toString() ? `?${params.toString()}` : \"\"}`);\n}\n","path":null,"size_bytes":551,"size_tokens":null},"src/lib/settings.ts":{"content":"import { createClient } from '@supabase/supabase-js'\nimport { hasTable } from '@/lib/db-features'\n\nexport type OperatingMode = 'monitor' | 'copilot' | 'autopilot'\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function hasSettingsTable(): Promise<boolean> {\n  return await hasTable('kv_settings')\n}\n\nexport async function getSetting<T = any>(key: string, fallback?: T): Promise<T | undefined> {\n  const admin = getSupabaseAdmin()\n  if (!admin) return fallback\n  if (!(await hasTable('kv_settings'))) return fallback\n  try {\n    const { data } = await admin.from('kv_settings').select('value').eq('key', key).maybeSingle()\n    if (data && typeof data.value !== 'undefined') return data.value as T\n  } catch {}\n  return fallback\n}\n\nexport async function setSetting<T = any>(key: string, value: T): Promise<{ ok: boolean; tablesMissing?: boolean }> {\n  const admin = getSupabaseAdmin()\n  if (!admin) return { ok: false, tablesMissing: true }\n  if (!(await hasTable('kv_settings'))) return { ok: false, tablesMissing: true }\n  try {\n    const row = { key, value, updated_at: new Date().toISOString() }\n    await admin.from('kv_settings').upsert(row, { onConflict: 'key' })\n    return { ok: true }\n  } catch {\n    return { ok: false }\n  }\n}\n\nexport async function getOperatingMode(): Promise<OperatingMode> {\n  const v = await getSetting<OperatingMode>('operating_mode', 'monitor')\n  return (v === 'copilot' || v === 'autopilot') ? v : 'monitor'\n}\n\nexport async function setOperatingMode(mode: OperatingMode): Promise<boolean> {\n  const result = await setSetting('operating_mode', mode)\n  return result.ok\n}\n\nexport async function isKillSwitchOn(): Promise<boolean> {\n  const v = await getSetting<boolean>('kill_switch', false)\n  return !!v\n}\n\nexport async function setKillSwitch(on: boolean): Promise<boolean> {\n  const result = await setSetting('kill_switch', !!on)\n  return result.ok\n}\n","path":null,"size_bytes":2051,"size_tokens":null},"src/app/healthz/route.ts":{"content":"export const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\nexport async function GET() {\n  const env = {\n    NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\n    STRIPE_SECRET_KEY: !!process.env.STRIPE_SECRET_KEY,\n    STRIPE_WEBHOOK_SECRET: !!process.env.STRIPE_WEBHOOK_SECRET,\n    NEXT_PUBLIC_SITE_URL: !!process.env.NEXT_PUBLIC_SITE_URL,\n    VERCEL_URL: !!process.env.VERCEL_URL,\n  } as const;\n\n  const deployment = {\n    vercel: !!process.env.VERCEL,\n    vercelEnv: process.env.VERCEL_ENV || null,\n  } as const;\n\n  return Response.json({\n    ok: true,\n    node: process.version,\n    runtime: 'nodejs',\n    env,\n    deployment,\n    timestamp: new Date().toISOString(),\n  });\n}\n","path":null,"size_bytes":892,"size_tokens":null},"src/app/sitemap.ts":{"content":"import { MetadataRoute } from \"next\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { getSiteUrl } from \"@/lib/site\";\n\nconst baseUrl = getSiteUrl();\n\n// Regenerate sitemap periodically to include new products\nexport const revalidate = 3600; // 1 hour\n\nexport default async function sitemap(): Promise<MetadataRoute.Sitemap> {\n  const staticPaths = [\n    \"\",\n    \"/shop\",\n    \"/about\",\n    \"/contact\",\n    \"/faq\",\n    \"/privacy-policy\",\n    \"/return-policy\",\n    \"/terms\",\n    \"/blog\",\n    \"/search\",\n  ];\n  const now = new Date();\n  const staticEntries = staticPaths.map((path) => ({ url: `${baseUrl}${path}`, lastModified: now }));\n  // Fetch dynamic product slugs using server-side Supabase anon client (no cookies)\n  const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const SUPABASE_ANON_KEY = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  let products: { slug: string; updated_at: string }[] | null = null;\n  if (SUPABASE_URL && SUPABASE_ANON_KEY) {\n    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);\n    // Prefer active products; gracefully fallback if column is missing (pre-migration)\n    const { data, error } = await supabase\n      .from(\"products\")\n      .select(\"slug, updated_at\")\n      .or(\"is_active.is.null,is_active.eq.true\");\n    if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n      const { data: fbData } = await supabase\n        .from(\"products\")\n        .select(\"slug, updated_at\");\n      products = fbData as any;\n    } else {\n      products = data as any;\n    }\n  }\n\n  const productEntries = products?.map(({ slug, updated_at }) => ({\n    url: `${baseUrl}/product/${slug}`,\n    lastModified: new Date(updated_at),\n  })) ?? [];\n\n  return [...staticEntries, ...productEntries];\n}\n","path":null,"size_bytes":1808,"size_tokens":null},"src/app/global-error.tsx":{"content":"\"use client\";\n\nimport { useEffect } from \"react\";\n\nexport default function GlobalError({ error, reset }: { error: Error & { digest?: string }; reset: () => void }) {\n  useEffect(() => {\n    (async () => {\n      try {\n        const mod: any = await import(\"@sentry/nextjs\");\n        if (mod && typeof mod.captureException === \"function\") {\n          mod.captureException(error);\n        }\n      } catch {}\n    })();\n  }, [error]);\n\n  return (\n    <html lang=\"en\" dir=\"ltr\">\n      <body>\n        <div className=\"container mx-auto max-w-2xl py-16\">\n          <h1 className=\"text-2xl font-bold text-red-600\">An Unexpected Error Occurred</h1>\n          <p className=\"mt-2 text-slate-600\">We're working on fixing the issue. You can try again.</p>\n          <div className=\"mt-6\">\n            <button\n              className=\"rounded-md bg-primary px-4 py-2 text-primary-foreground hover:opacity-90\"\n              onClick={() => reset()}\n            >\n              Try Again\n            </button>\n          </div>\n          {process.env.NODE_ENV !== 'production' && (\n            <pre className=\"mt-6 overflow-auto rounded bg-muted p-4 text-xs\">{String(error?.stack || error?.message || \"\")}</pre>\n          )}\n        </div>\n      </body>\n    </html>\n  );\n}\n","path":null,"size_bytes":1253,"size_tokens":null},"src/lib/cj/api.ts":{"content":"type HttpMethod = 'GET' | 'POST' | 'PUT' | 'DELETE';\n\nexport class CjApi {\n  private appKey: string;\n  private appSecret: string;\n  private baseUrl: string;\n\n  constructor(opts?: { sandbox?: boolean }) {\n    this.appKey = process.env.CJ_APP_KEY || '';\n    this.appSecret = process.env.CJ_APP_SECRET || '';\n    this.baseUrl = (opts?.sandbox ? process.env.CJ_API_BASE_SANDBOX : process.env.CJ_API_BASE) || '';\n  }\n\n  isConfigured(): boolean {\n    return !!(this.appKey && this.appSecret && this.baseUrl);\n  }\n\n  // Placeholder signing. Replace with CJ's official signature method.\n  private sign(params: Record<string, any>): Record<string, any> {\n    return { ...params, appKey: this.appKey, ts: Date.now() };\n  }\n\n  async request<T>(path: string, method: HttpMethod = 'GET', body?: any): Promise<T> {\n    if (!this.isConfigured()) throw new Error('CJ API not configured');\n    const url = new URL(path, this.baseUrl);\n    const headers: Record<string, string> = { 'Content-Type': 'application/json' };\n    const payload = body ? this.sign(body) : this.sign({});\n    const res = await fetch(url.toString(), {\n      method,\n      headers,\n      body: method === 'GET' ? undefined : JSON.stringify(payload),\n      cache: 'no-store',\n    });\n    if (!res.ok) {\n      const text = await res.text();\n      throw new Error(`CJ API error ${res.status}: ${text}`);\n    }\n    return res.json() as Promise<T>;\n  }\n\n  // Example endpoints (to be wired to CJ docs)\n  async listServices(): Promise<any> {\n    return this.request('/shipping/services', 'POST', {});\n  }\n\n  async createOrder(payload: any): Promise<any> {\n    return this.request('/order/create', 'POST', payload);\n  }\n}\n","path":null,"size_bytes":1670,"size_tokens":null},"src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName = DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName = DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName = DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", inset && \"pl-8\", className)}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubTrigger,\n  DropdownMenuSubContent,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":5956,"size_tokens":null},"src/app/auth/callback/route.ts":{"content":"import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs'\nimport { cookies } from 'next/headers'\nimport { NextResponse } from 'next/server'\n\nimport type { NextRequest } from 'next/server'\n\nexport const dynamic = 'force-dynamic'\nexport const runtime = 'nodejs'\n\nexport async function GET(request: NextRequest) {\n  const requestUrl = new URL(request.url)\n  const code = requestUrl.searchParams.get('code')\n  const linkType = (requestUrl.searchParams.get('type') || '').toLowerCase()\n  const nextParam = requestUrl.searchParams.get('next') || requestUrl.searchParams.get('redirect') || '/'\n  const safeNext = typeof nextParam === 'string' && nextParam.startsWith('/') && !nextParam.startsWith('//') ? nextParam : '/'\n\n  if (code) {\n    const supabase = createRouteHandlerClient({ cookies })\n    await supabase.auth.exchangeCodeForSession(code)\n    try {\n      const { data: { user } } = await supabase.auth.getUser()\n      if (user) {\n        const shouldNotify = linkType === 'signup' || linkType === 'invite'\n        // Do not notify on recovery or email-change flows\n        if (!shouldNotify) {\n          // Skip notification, still proceed to redirect later\n        } else {\n        const admins = (process.env.ADMIN_EMAILS || '')\n          .split(',')\n          .map((e) => e.trim())\n          .filter(Boolean)\n        const apiKey = process.env.RESEND_API_KEY\n        if (admins.length && apiKey) {\n          // Send a brief admin notification (no passwords are ever accessible)\n          const html = `\n            <div style=\"font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; line-height:1.6\">\n              <h2 style=\"margin:0 0 12px\">New User Signed Up</h2>\n              <p style=\"margin:0 0 8px\"><strong>Email:</strong> ${user.email || ''}</p>\n              <p style=\"margin:0 0 8px\"><strong>Provider:</strong> ${(user.app_metadata as any)?.provider || 'email'}</p>\n              <p style=\"color:#6b7280; font-size:12px\">Sent automatically by ${process.env.NEXT_PUBLIC_STORE_NAME || 'Shopixo'}</p>\n            </div>\n          `\n          await fetch('https://api.resend.com/emails', {\n            method: 'POST',\n            headers: {\n              'Authorization': `Bearer ${apiKey}`,\n              'Content-Type': 'application/json',\n            },\n            body: JSON.stringify({\n              from: `${process.env.NEXT_PUBLIC_STORE_NAME || 'Shopixo'} <no-reply@${(process.env.NEXT_PUBLIC_SITE_URL || 'shopixo.vercel.app').replace(/^https?:\\/\\//,'')}>`,\n              to: admins,\n              subject: `New signup — ${(user.email || '').toString()}`,\n              html,\n            }),\n          }).catch(() => {})\n        }\n        }\n      }\n    } catch {}\n  }\n\n  // Prefer deep redirect if present\n  const target = safeNext === '/' ? requestUrl.origin : `${requestUrl.origin}${safeNext}`\n  return NextResponse.redirect(target)\n}\n","path":null,"size_bytes":2893,"size_tokens":null},"src/__tests__/robots.test.ts":{"content":"import robots from '@/app/robots'\n\nfunction withEnv<T>(env: Record<string, string | undefined>, fn: () => T): T {\n  const prev = { ...process.env };\n  try {\n    for (const k of Object.keys(env)) {\n      const v = env[k];\n      if (typeof v === 'undefined') delete (process.env as any)[k];\n      else (process.env as any)[k] = v;\n    }\n    return fn();\n  } finally {\n    process.env = prev as any;\n  }\n}\n\ndescribe('robots() environment behavior', () => {\n  test('non-production disallows all', () => {\n    const out = withEnv({ VERCEL_ENV: 'preview', NEXT_PUBLIC_SITE_URL: 'https://example.com' }, () => robots());\n    expect(out.rules).toHaveLength(1);\n    const rule = out.rules[0] as any;\n    expect(rule.disallow).toEqual(['/']);\n  });\n\n  test('production allows with sensitive paths disallowed and correct sitemap/host', () => {\n    const out = withEnv({ NODE_ENV: 'production', VERCEL_ENV: undefined, NEXT_PUBLIC_SITE_URL: 'https://example.com' }, () => robots());\n    expect(out.rules).toHaveLength(1);\n    const rule = out.rules[0] as any;\n    expect(rule.allow).toBe('/');\n    expect(rule.disallow).toEqual(expect.arrayContaining(['/cart', '/checkout', '/order-tracking', '/account']));\n    expect(out.sitemap).toBe('https://example.com/sitemap.xml');\n    expect(out.host).toBe('https://example.com');\n  });\n});\n","path":null,"size_bytes":1320,"size_tokens":null},"src/app/checkout/canceled/page.tsx":{"content":"import Link from \"next/link\";\n\nexport default function CheckoutCanceledPage() {\n  return (\n    <div className=\"container text-center py-12\">\n      <h1 className=\"text-3xl font-bold text-red-600\">Payment Canceled</h1>\n      <p className=\"mt-4\">Your order was not processed.</p>\n      <p className=\"mt-2\">You have not been charged. Please try again or contact support if you are having trouble.</p>\n      <Link href=\"/cart\" className=\"btn-secondary mt-6 inline-block\">Return to Cart</Link>\n    </div>\n  );\n}\n","path":null,"size_bytes":506,"size_tokens":null},"branding/suppliers/supplier-agreement-template-ar.md":{"content":"# اتفاقية خدمات المورد (نموذج) — Shopixo\n\nالأطراف:\n- المشتري: Shopixo (\"المشتري\")\n- المورد: [الاسم القانوني للشركة] (\"المورد\")\n\nتاريخ النفاذ: [YYYY-MM-DD] — المدة: 12 شهرًا (تتجدد تلقائيًا ما لم يُنهَ وفق البند 14)\n\n1) النطاق\n- يقدّم المورد منتجات وخدمات تنفيذ للطلبات إلى السعودية بنظام الدروبشيب.\n- الشحن الأعمى إلزامي. اسم المرسل على الملصق يجب أن يكون \"Shopixo\".\n\n2) الطلبات والتنفيذ\n- تقديم الطلب عبر [بوابة/واجهة API/بريد]. مهلة المعالجة: [X] ساعات.\n- تضمين قسيمة التغليف وبطاقة الشكر الخاصة بالمشتري في كل شحنة.\n- يُمنع وضع أي مواد تسويقية تخص المورد داخل الطرد.\n\n3) الهوية والتغليف\n- عند اللزوم، استخدام مواد البراند (polybag/hangtag/sticker) التي يوفرها المشتري. الحد الأدنى/التكلفة ضمن الملحق (ج).\n- يجب أن يحمي التغليف المنتجات؛ الملابس مطوية داخل أكياس بولي نظيفة.\n\n4) ضبط الجودة\n- AQL: [المستوى]. صور/فيديو قبل الشحن لأول 3 دفعات وعند الطلب.\n- معالجة العيوب/النواقص وفق البند (8).\n\n5) التسعير والمدفوعات\n- الأسعار وفق الملحق (ب) — بطاقة الأسعار. العملة: [USD]. السداد: [بطاقة/حوالة].\n- قد يطبق المشتري هامش تقلب عملة [X%]. أي تغيير يحتاج إشعار 7 أيام.\n\n6) الشحن والتسليم\n- الخدمات وفق الملحق (ب) (اقتصادي/سريع)، نفضّل DDP. توفير زمن توصيل للسعودية.\n- مشاركة رقم التتبع خلال 24 ساعة من تسليم الشحنة لشركة النقل.\n\n7) الامتثال والضمان\n- يضمن المورد مطابقة المنتجات للأنظمة السعودية (بما فيها متطلبات منسوجات الأطفال عند الاقتضاء).\n- يتحمّل المورد أي مسائل جمركية ناتجة عن تصاريح خاطئة.\n\n8) المرتجعات والعيوب\n- حد أعلى لنسبة العيوب: [X%]. المعالجة: استبدال/إعادة شحن/رد خلال [X] أيام.\n- إجراءات RMA في الملحق (د).\n\n9) البيانات والخصوصية\n- استخدام بيانات الطلب للتنفيذ فقط. يُمنع التسويق لعملاء المشتري.\n\n10) السرية والملكية الفكرية\n- NDA متبادل يغطي معلومات المنتجات والتسعير وبيانات العملاء وأصول العلامة.\n\n11) المسؤولية\n- حدود واستثناءات المسؤولية ضمن الملحق (هـ). لا تعويضات غير مباشرة.\n\n12) الإنهاء\n- يحق لأي طرف الإنهاء بإشعار 14 يومًا، أو فورًا عند الإخلال الجسيم.\n\n13) القانون المختص\n- [تحديد الولاية القضائية]. تسوية النزاعات عبر [تحكيم/محاكم].\n\n14) الملاحق\n- (أ) رد الـ RFI\n- (ب) بطاقات الأسعار وجدول الشحن\n- (ج) مواد البراند ومواصفات التغليف\n- (د) اتفاقيات مستوى الخدمة (SLA)\n- (هـ) تفاصيل الامتثال والمسؤولية\n\nالتوقيعات:\n- المورد: __________________  التاريخ:_____\n- المشتري (Shopixo): ________ التاريخ:_____\n","path":null,"size_bytes":3757,"size_tokens":null},"src/app/checkout/success/page.tsx":{"content":"import { getStripe } from \"@/lib/stripe\";\nimport { cookies } from \"next/headers\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { clearCart } from \"@/lib/cart-actions\";\nimport Link from \"next/link\";\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\nexport default async function CheckoutSuccessPage({ searchParams }: { searchParams?: { [key: string]: string | string[] | undefined } }) {\n  const sessionIdParam = searchParams?.session_id;\n  const sessionId = Array.isArray(sessionIdParam) ? sessionIdParam[0] : sessionIdParam;\n\n  if (!sessionId) {\n    return (\n      <div className=\"container text-center py-12\">\n        <h1 className=\"text-2xl font-bold text-red-600\">Error</h1>\n        <p className=\"mt-2\">No session ID found.</p>\n      </div>\n    );\n  }\n\n  try {\n    const session = await getStripe().checkout.sessions.retrieve(sessionId);\n    const supabase = createServerComponentClient({ cookies });\n    const { data: { user } } = await supabase.auth.getUser();\n\n    if (user) {\n      await clearCart();\n    }\n\n    return (\n      <div className=\"container text-center py-12\">\n        <h1 className=\"text-3xl font-bold text-green-600\">Payment Successful!</h1>\n        <p className=\"mt-4\">Thank you for your order, {session.customer_details?.email}.</p>\n        <p className=\"mt-2\">A confirmation email has been sent to your email address.</p>\n        <Link href=\"/\" className=\"btn-primary mt-6 inline-block\">Continue Shopping</Link>\n      </div>\n    );\n  } catch (error) {\n    return (\n      <div className=\"container text-center py-12\">\n        <h1 className=\"text-2xl font-bold text-red-600\">Error</h1>\n        <p className=\"mt-2\">Invalid session. Please try again.</p>\n      </div>\n    );\n  }\n}\n","path":null,"size_bytes":1795,"size_tokens":null},"src/app/api/admin/db/status/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { hasTable } from '@/lib/db-features'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const [kv, proposals, audit, policies] = await Promise.all([\n      hasTable('kv_settings'),\n      hasTable('proposals'),\n      hasTable('audit_logs'),\n      hasTable('pricing_policies'),\n    ])\n    const r = NextResponse.json({ ok: true, tables: { kv_settings: kv, proposals, audit_logs: audit, pricing_policies: policies } })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'db status failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":1198,"size_tokens":null},"docs/DEPLOYMENT.md":{"content":"# Shopixo Deployment Guide (Production)\n\nThis guide walks you step‑by‑step to deploy Shopixo as a real store (with payments, orders, and stock management).\n\nImportant: Never share your secrets (e.g., SUPABASE_SERVICE_ROLE_KEY, STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET) in chat. Set them only in your hosting platform’s encrypted environment settings.\n\n---\n\n## Prerequisites\n- A Supabase project (free plan is OK to start).\n- A Stripe account (Test Mode first, then Live).\n- A hosting provider (Vercel recommended) and your domain.\n- Node 18+ locally if you want to run and test.\n\n---\n\n## Step 1 — Supabase Setup\n1) Create a new Supabase project (or open an existing one).\n2) Get keys from: Project Settings → API\n   - NEXT_PUBLIC_SUPABASE_URL\n   - NEXT_PUBLIC_SUPABASE_ANON_KEY\n   - SUPABASE_SERVICE_ROLE_KEY (server only)\n3) Run database migrations (order matters):\n   - Open Database → SQL Editor → paste and run the contents of `supabase/migrations/ALL.sql`, or run the following files one by one in this order:\n     - `supabase/migrations/0000_schema-products.sql`\n     - `supabase/migrations/0001_schema-cart.sql`\n     - `supabase/migrations/0002_rpc-decrement_stock.sql`\n     - `supabase/migrations/0003_orders-policies.sql`\n     - `supabase/migrations/0004_rpc-decrement_stock-hardened.sql`\n4) Verify tables and policies in Table Editor:\n   - `products` (public read RLS; write only via service_role)\n   - `cart_sessions`, `cart_items` (all operations restricted to service_role)\n   - `orders`, `order_items` (service_role can manage for webhooks/admin; users can read their own orders)\n   - RPC `decrement_stock` exists and is Security Definer.\n\n### Optional: Blog Posts Table (for Admin Blog CRUD)\nIf you want to publish real blog posts from the Admin panel (`/admin/blog`), create a `blog_posts` table and policies.\n\nRun this SQL in Supabase → SQL Editor:\n\n```sql\n-- Table: blog_posts\ncreate table if not exists public.blog_posts (\n  id bigserial primary key,\n  created_at timestamptz not null default now(),\n  title text not null,\n  slug text not null unique,\n  excerpt text,\n  content text,\n  published boolean not null default true\n);\n\n-- RLS: Allow the public (anon) to read only published posts\nalter table public.blog_posts enable row level security;\ndo $$ begin\n  if not exists (\n    select 1 from pg_policies where schemaname = 'public' and tablename = 'blog_posts' and policyname = 'Public read published'\n  ) then\n    create policy \"Public read published\" on public.blog_posts\n      for select using (published = true);\n  end if;\nend $$;\n\n-- Helpful indexes\ncreate index if not exists blog_posts_created_at_idx on public.blog_posts (created_at desc);\ncreate index if not exists blog_posts_published_idx on public.blog_posts (published);\n```\n\nNotes:\n- Admin writes (add/edit/delete) are executed server-side using the Supabase Service Role key, which bypasses RLS. No additional write policies are required.\n- The public site (`/blog`) reads only `published = true` posts thanks to the RLS policy above.\n\n### Products Soft Delete (Archive/Restore)\nTo allow archiving products instead of hard-deleting them (useful when products are referenced by orders), run the following SQL in Supabase → SQL Editor:\n\n```sql\nalter table if exists public.products\n  add column if not exists is_active boolean not null default true;\n\ncreate index if not exists idx_products_active_created\n  on public.products (is_active, created_at desc);\n```\n\nAfter running this, the Admin panel will show an \"Archive/Restore\" action. Archived products will be hidden from:\n- Home `/`\n- Shop `/shop`\n- Category pages `/category/[slug]`\n- Search `/search`\n- Product details `/product/[slug]`\n- Sitemap `/sitemap.xml`\n\nAlso, cart operations will prevent adding or updating quantities for inactive products.\n\n### Branding (Footer)\nConfigure these environment variables to brand your store footer without code changes:\n\n- `NEXT_PUBLIC_STORE_NAME` — your public store name (e.g., `هيا`).\n- Optional social links (icons render only if set):\n  - `NEXT_PUBLIC_SOCIAL_FACEBOOK`\n  - `NEXT_PUBLIC_SOCIAL_INSTAGRAM`\n  - `NEXT_PUBLIC_SOCIAL_TWITTER`\n  - `NEXT_PUBLIC_SOCIAL_YOUTUBE`\n\n---\n\n## Step 2 — Stripe Setup\n1) Create or open your Stripe account. Start with Test Mode.\n2) Get your API key: Developers → API keys → Secret key → set `STRIPE_SECRET_KEY` (server only)\n3) Create a Webhook endpoint:\n   - URL: `https://<your-domain>/api/stripe/webhook`\n   - Events: at least `checkout.session.completed`\n   - Copy the Signing secret → set `STRIPE_WEBHOOK_SECRET` (server only)\n4) Checkout Redirect URLs:\n   - Success: `https://<your-domain>/checkout/success?session_id={CHECKOUT_SESSION_ID}`\n   - Cancel: `https://<your-domain>/cart`\n\n---\n\n## Step 3 — Environment Variables (Production)\nSet these in your hosting platform (e.g., Vercel → Project Settings → Environment Variables):\n\nPublic\n- `NEXT_PUBLIC_SUPABASE_URL`\n- `NEXT_PUBLIC_SUPABASE_ANON_KEY`\n- `NEXT_PUBLIC_SITE_URL` = `https://<your-domain>`\n\nServer-only (never expose to the client)\n- `SUPABASE_SERVICE_ROLE_KEY`\n- `STRIPE_SECRET_KEY`\n- `STRIPE_WEBHOOK_SECRET`\n\nOptional\n- `ADMIN_EMAILS` = `admin@example.com,owner@example.com`\n\nDo not commit real secrets to git. Use the platform’s encrypted store.\n\n---\n\n## Step 4 — Deploy (Vercel recommended)\n1) Import your repo into Vercel and connect the project.\n2) Add all environment variables listed above.\n3) Configure domains (apex and www) and update DNS records as instructed by Vercel.\n4) Deploy. Vercel will build and host your app.\n\nSecurity headers are already configured in `next.config.mjs`.\n\n---\n\n## Step 5 — Production Webhook Check\n- In Stripe Dashboard → Webhooks, ensure your production endpoint is enabled and points to your real domain.\n- Confirm the webhook signing secret matches your `STRIPE_WEBHOOK_SECRET` in production.\n\n---\n\n## Step 6 — Admin Setup and Test Data\n- Set `ADMIN_EMAILS` to your admin emails.\n- Add a product (via Supabase Table Editor or the Admin UI once deployed):\n  - `title`, `slug`, `price`, `images` (array of URLs), `stock`.\n- Visit `/admin` with an admin email to manage products/orders.\n\n---\n\n## Step 7 — End-to-End Test (Test Mode)\n1) Add the product to cart and go to checkout.\n2) Pay with Stripe test card `4242 4242 4242 4242`, any future date, any CVC.\n3) After success:\n   - Check `orders` and `order_items` inserted.\n   - `products.stock` decremented by purchased quantities.\n   - `cart_items` cleared for that session.\n4) Check the admin orders page: `/admin/orders`.\n\n---\n\n## Notes on Security and Idempotency\n- Webhook handler uses Supabase service-role on the server only.\n- Webhook is idempotent using `stripe_session_id` upsert and an early-exit if items already exist.\n- Cart cookie `cart_id` is `secure` in production.\n- RPC `decrement_stock` is SECURITY DEFINER with `search_path = public` and ignores non‑positive quantities.\n\n---\n\n## Troubleshooting\n- If orders aren’t appearing, check:\n  - Stripe Webhook logs → delivery attempts and response status.\n  - Your `STRIPE_WEBHOOK_SECRET` value.\n  - Supabase policies: confirm service_role access and that your server uses the service key for webhooks.\n- If images don’t show, add your CDN domain to `next.config.mjs → images.remotePatterns`.\n\n---\n\n## Local Development (optional)\n- Copy `.env.example` to `.env.local` and fill keys.\n- Install deps and run dev:\n  ```bash\n  npm install\n  npm run dev\n  ```\n- For local webhook testing:\n  ```bash\n  stripe listen --forward-to localhost:3000/api/stripe/webhook\n  ```\n\n---\n\nYou’re ready to launch. Follow the steps above in order, and verify at each step. If you need hands-on help, provide your domain and confirm when each step is done; do not share secrets. I can then double-check logs, endpoints, and flows.\n","path":null,"size_bytes":7814,"size_tokens":null},"src/app/collections/page.tsx":{"content":"import Link from \"next/link\"\nimport Image from \"next/image\"\nimport { FULL_CATEGORIES } from \"@/lib/categories\"\n\nexport const metadata = { title: \"Collections\", description: \"Explore our collections\" }\n\nexport default function CollectionsPage() {\n  const groups = FULL_CATEGORIES\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Collections</h1>\n      <p className=\"mt-2 text-slate-600\">Explore main categories and shop by your interests.</p>\n      <div className=\"mt-6 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6\">\n        {groups.map((c) => (\n          <Link\n            key={c.slug}\n            href={`/category/${c.slug}`}\n            className=\"group overflow-hidden rounded-xl border bg-card shadow-soft transition hover:-translate-y-[2px] hover:shadow\"\n          >\n            <div className=\"relative aspect-[4/3] w-full overflow-hidden bg-muted\">\n              <Image\n                src={c.image || \"/placeholder.svg\"}\n                alt={c.label}\n                fill\n                sizes=\"(max-width: 640px) 50vw, (max-width: 1024px) 33vw, 16vw\"\n                className=\"object-cover transition-transform duration-300 group-hover:scale-[1.03]\"\n                priority={false}\n              />\n            </div>\n            <div className=\"p-3 text-center text-sm font-medium\">{c.label}</div>\n          </Link>\n        ))}\n      </div>\n    </div>\n  )\n}\n","path":null,"size_bytes":1434,"size_tokens":null},"src/components/ui/radio-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      ref={ref}\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <div className=\"h-2.5 w-2.5 rounded-full bg-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1414,"size_tokens":null},"branding/brand-guidelines.md":{"content":"# Shopixo Brand Guidelines\n\n- **Brand name**: Shopixo (English only)\n- **Support WhatsApp**: 00962781637033\n\n## Colors\n- **Primary (Text/Logo)**: #111111\n- **Background**: #FFFFFF\n- **Accent (CTAs/links)**: #2563EB\n- **Gray Dark**: #374151\n- **Gray Mid**: #9CA3AF\n- **Sale/Warning**: #F59E0B\n\n## Typography\n- **Latin**: Inter (Headings 700–800, Body 400–500)\n- **Arabic**: Cairo or Tajawal (Headings 700, Body 400–500)\n\n## Logo Usage\n- Use `public/brand/logo-shopixo-wordmark.svg` on light backgrounds.\n- Use the inverse (same wordmark in white) on dark backgrounds (site can invert via CSS fill).\n- Alternative mark with bag icon: `public/brand/logo-shopixo-bag.svg`.\n- Clear space: keep padding >= 10% of logo width around the mark.\n\n## Tone and Imagery\n- Minimal, clean, high-contrast (black/white) with blue accent for actions.\n- Product photos on white or very light backgrounds.\n\n## Packaging\n- Shipper Name: Shopixo\n- Include branded packing slip and thank-you insert in every parcel.\n- No supplier logos or marketing inside parcels (Blind Shipping).\n","path":null,"size_bytes":1064,"size_tokens":null},"src/app/admin/orders/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Fetching orders...\" />;\n}\n","path":null,"size_bytes":153,"size_tokens":null},"src/app/admin/console/setup/page.tsx":{"content":"import Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function DbSetupPage() {\n  async function dbStatus() {\n    try {\n      const r = await fetch(`${process.env.NEXT_PUBLIC_SITE_URL || ''}/api/admin/db/status`, { cache: 'no-store' });\n      if (!r.ok) return null;\n      return await r.json();\n    } catch { return null; }\n  }\n  const status = await dbStatus();\n\n  const sqlKv = `-- Key-Value settings (operating_mode, kill_switch, etc.)\ncreate table if not exists kv_settings (\n  key text primary key,\n  value jsonb not null default '{}'::jsonb,\n  updated_at timestamptz not null default now()\n);\n`;\n\n  const sqlProposals = `-- Proposals queue for Monitor/Copilot/Autopilot\n-- Requires pgcrypto for gen_random_uuid(); run once:\ncreate extension if not exists pgcrypto;\n\ncreate table if not exists proposals (\n  id uuid primary key default gen_random_uuid(),\n  created_at timestamptz not null default now(),\n  status text not null default 'pending' check (status in ('pending','approved','rejected','executed')),\n  action_type text,             -- e.g., 'price_update', 'archive', 'media_update'\n  entity_type text,             -- e.g., 'product', 'variant'\n  entity_id text,               -- e.g., product id or variant id\n  score numeric,                -- quality/priority score (0..5)\n  reasons jsonb,                -- list of reasons/policies triggered\n  impact jsonb,                 -- expected impact (e.g., margin, CVR)\n  payload jsonb,                -- full proposal payload (before/after)\n  proposed_by text,             -- generator id ('system')\n  mode text,                    -- 'monitor'|'copilot'|'autopilot' at creation\n  tags text[]\n);\n\ncreate index if not exists proposals_status_created_at_idx on proposals(status, created_at desc);\n`;\n\n  const sqlAudit = `-- Audit trail of administrative actions\ncreate table if not exists audit_logs (\n  id bigserial primary key,\n  created_at timestamptz not null default now(),\n  action text not null,\n  entity text,\n  entity_id text,\n  user_email text,\n  user_id text,\n  payload jsonb\n);\n\ncreate index if not exists audit_logs_action_created_idx on audit_logs(action, created_at desc);\n`;\n\n  return (\n    <div className=\"space-y-8\">\n      <header className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Database Setup</h1>\n        <Link href=\"/admin/console\" className=\"text-sm text-blue-600 hover:underline\">Back to Console</Link>\n      </header>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-2\">Current Status</h2>\n        <div className=\"text-sm text-muted-foreground\">\n          {status && status.ok ? (\n            <ul className=\"list-disc pl-5\">\n              <li>kv_settings: <span className=\"font-medium\">{String(status.tables.kv_settings)}</span></li>\n              <li>proposals: <span className=\"font-medium\">{String(status.tables.proposals)}</span></li>\n              <li>audit_logs: <span className=\"font-medium\">{String(status.tables.audit_logs)}</span></li>\n              <li>pricing_policies: <span className=\"font-medium\">{String(status.tables.pricing_policies)}</span></li>\n            </ul>\n          ) : <div>Open <Link href=\"/api/admin/db/status\" className=\"text-blue-600 hover:underline\">DB Status</Link></div>}\n        </div>\n      </section>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-2\">1) kv_settings</h2>\n        <p className=\"text-sm text-muted-foreground mb-2\">Run in Supabase SQL editor:</p>\n        <pre className=\"overflow-auto rounded bg-slate-950 p-3 text-slate-50 text-xs\"><code>{sqlKv}</code></pre>\n      </section>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-2\">2) proposals</h2>\n        <p className=\"text-sm text-muted-foreground mb-2\">Run in Supabase SQL editor:</p>\n        <pre className=\"overflow-auto rounded bg-slate-950 p-3 text-slate-50 text-xs\"><code>{sqlProposals}</code></pre>\n      </section>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-2\">3) audit_logs</h2>\n        <p className=\"text-sm text-muted-foreground mb-2\">Run in Supabase SQL editor:</p>\n        <pre className=\"overflow-auto rounded bg-slate-950 p-3 text-slate-50 text-xs\"><code>{sqlAudit}</code></pre>\n      </section>\n\n      <section className=\"rounded border bg-yellow-100 p-4\">\n        <h3 className=\"font-medium mb-1\">Notes</h3>\n        <ul className=\"list-disc pl-5 text-sm text-yellow-900 space-y-1\">\n          <li>No destructive changes are executed automatically. You apply SQL explicitly in Supabase.</li>\n          <li>After creating the tables, revisit <Link href=\"/admin/console/proposals\" className=\"underline\">Proposals</Link> and <Link href=\"/admin/console/settings\" className=\"underline\">Settings</Link>.</li>\n        </ul>\n      </section>\n    </div>\n  );\n}\n","path":null,"size_bytes":4994,"size_tokens":null},"src/components/cart-badge.tsx":{"content":"import Link from \"next/link\";\nimport { ShoppingCart } from \"lucide-react\";\nimport { getCart } from \"@/lib/cart-actions\";\n\nexport default async function CartBadge() {\n  const cart = await getCart();\n  const totalQuantity = cart?.reduce((acc, item) => acc + item.quantity, 0) ?? 0;\n\n  return (\n    <Link\n      href=\"/cart\"\n      className=\"relative flex items-center gap-2 text-sm font-medium hover:text-primary\"\n    >\n      <ShoppingCart className=\"h-6 w-6\" />\n      {totalQuantity > 0 && (\n        <span className=\"absolute -right-2 -top-2 flex h-5 w-5 items-center justify-center rounded-full bg-primary text-xs text-primary-foreground\">\n          {totalQuantity}\n        </span>\n      )}\n      <span className=\"sr-only\">Shopping cart, {totalQuantity} items</span>\n    </Link>\n  );\n}\n","path":null,"size_bytes":785,"size_tokens":null},"ops/shipping/shipping-matrix-request-en.md":{"content":"# Shipping Matrix Request — KSA (Shopixo)\n\nHi, we would like your KSA shipping rate cards for dropship parcels with Blind Shipping under Shipper Name: \"Shopixo\".\n\nPlease provide for each service (Economy / Express):\n- DDP included? (duties/taxes prepaid) Yes/No. If No, explain who pays and how much (examples).\n- Door-to-door transit time (typical) to KSA.\n- Weight tiers (actual or volumetric) and prices in USD:\n  - 0–0.25 kg\n  - 0.25–0.5 kg\n  - 0.5–1.0 kg\n  - 1.0–1.5 kg\n  - 1.5–2.0 kg\n  - 2.0–3.0 kg\n  - 3.0–5.0 kg\n- Volumetric formula used (e.g., L×W×H / 5000).\n- Any remote area surcharges or fuel adjustments.\n- COD label handling (for future): supported? fees?\n\nRequired handling for every parcel:\n- Shipper name on label: Shopixo\n- Include our branded packing slip + thank-you insert inside the parcel (PDF/HTML provided)\n- No supplier logos or marketing materials inside\n\nPlease reply with your latest rate sheet and service descriptions. Thank you!\n","path":null,"size_bytes":979,"size_tokens":null},"src/components/pro/FiltersPanel.tsx":{"content":"\"use client\"\n\nimport { useState } from \"react\"\n\nexport default function FiltersPanel({\n  basePath,\n  sort,\n  min,\n  max,\n  labels = { title: \"Filter\" }\n}: {\n  basePath: string\n  sort?: string\n  min?: string\n  max?: string\n  labels?: { title?: string }\n}) {\n  const [open, setOpen] = useState(false)\n  return (\n    <div className=\"mb-4\">\n      {/* Mobile toggle */}\n      <div className=\"flex items-center gap-3 lg:hidden\">\n        <button type=\"button\" onClick={() => setOpen(v => !v)} className=\"rounded-md border px-3 py-2 text-sm\">\n          {labels.title}\n        </button>\n      </div>\n      <div className={`mt-3 ${open ? '' : 'hidden'} lg:block`}>\n        <form method=\"get\" action={basePath} className=\"flex flex-wrap items-center gap-2 text-sm\">\n          <span className=\"text-muted-foreground\">Sort by:</span>\n          <div className=\"flex items-center gap-2\">\n            <a className={`rounded-md border px-3 py-1 ${sort === 'price-asc' ? 'bg-accent text-accent-foreground' : ''}`} href={`${basePath}?sort=price-asc${min?`&min=${encodeURIComponent(min)}`:''}${max?`&max=${encodeURIComponent(max)}`:''}`}>\n              Price ↑\n            </a>\n            <a className={`rounded-md border px-3 py-1 ${sort === 'price-desc' ? 'bg-accent text-accent-foreground' : ''}`} href={`${basePath}?sort=price-desc${min?`&min=${encodeURIComponent(min)}`:''}${max?`&max=${encodeURIComponent(max)}`:''}`}>\n              Price ↓\n            </a>\n          </div>\n          <div className=\"ml-auto flex items-center gap-2\">\n            <label className=\"text-muted-foreground\" htmlFor=\"min\">Price from</label>\n            <input id=\"min\" name=\"min\" inputMode=\"numeric\" pattern=\"[0-9]*\" defaultValue={min || ''} className=\"h-9 w-24 rounded-md border px-2\" />\n            <label className=\"text-muted-foreground\" htmlFor=\"max\">to</label>\n            <input id=\"max\" name=\"max\" inputMode=\"numeric\" pattern=\"[0-9]*\" defaultValue={max || ''} className=\"h-9 w-24 rounded-md border px-2\" />\n            {sort && <input type=\"hidden\" name=\"sort\" value={sort} />}\n            <button className=\"rounded-[var(--radius-sm)] border px-3 py-1\">Apply</button>\n            {(min || max) && (\n              <a className=\"text-primary underline\" href={`${basePath}${sort?`?sort=${encodeURIComponent(sort)}`:''}`}>Clear</a>\n            )}\n          </div>\n        </form>\n      </div>\n    </div>\n  )\n}\n","path":null,"size_bytes":2386,"size_tokens":null},"src/components/ProductCard.tsx":{"content":"// DEPRECATED: Use '@/components/product-card' instead. This wrapper delegates to the canonical component.\nimport { Product } from '@/lib/types';\nimport RealProductCard from './product-card';\n\ninterface ProductCardProps {\n  product: Product;\n}\n\nexport default function ProductCard({ product }: ProductCardProps) {\n  return <RealProductCard product={product} />;\n}\n","path":null,"size_bytes":364,"size_tokens":null},"README.md":{"content":"# Shopixo\n\nProfessional e-commerce starter built with Next.js 14, TypeScript, and Tailwind CSS.\n\n## Getting Started\n\n1. Install dependencies:\n   ```bash\n   npm install\n   ```\n2. Run the development server:\n   ```bash\n   npm run dev\n   ```\n3. Open http://localhost:3000 in your browser.\n\n## Tech Stack\n- Next.js 14 (App Router) + TypeScript\n- Tailwind CSS\n\n## Next Steps\n- Add pages: Shop, Product, Cart, Checkout, Order Tracking, About, Contact, FAQ, Privacy, Returns, Terms, Blog.\n- Integrate database (Prisma + PostgreSQL), auth, payments, SEO, analytics, and vendor features.\n\n## Brand Kit Icons\n\nUse the brand kit script to generate all favicons and PWA icons into `public/`.\n\nPrerequisites:\n\n- Place one of the following in `public/`:\n  - `public/logo-icon.svg` (preferred, high quality), or\n  - `public/logo-icon.png` (will be masked/rounded automatically)\n\nRun the generator:\n\n```bash\nnpm install  # installs dev deps: sharp, fs-extra, png-to-ico\nnpm run icons:generate\n```\n\nThis will generate:\n\n- `favicon.ico`, `favicon-16x16.png`, `favicon-32x32.png`, `favicon-48x48.png`\n- `apple-touch-icon.png`\n- `android-chrome-192x192.png`, `android-chrome-256x256.png`, `android-chrome-384x384.png`, `android-chrome-512x512.png`\n- `maskable-icon-512.png`\n\nScript location: `scripts/brand-kit/generate-icons.mjs`\n","path":null,"size_bytes":1311,"size_tokens":null},"e2e/example.spec.ts":{"content":"import { test, expect } from '@playwright/test';\n\ntest('has title', async ({ page }) => {\n  await page.goto('https://playwright.dev/');\n\n  // Expect a title \"to contain\" a substring.\n  await expect(page).toHaveTitle(/Playwright/);\n});\n\ntest('get started link', async ({ page }) => {\n  await page.goto('https://playwright.dev/');\n\n  // Click the get started link.\n  await page.getByRole('link', { name: 'Get started' }).click();\n\n  // Expects page to have a heading with the name of Installation.\n  await expect(page.getByRole('heading', { name: 'Installation' })).toBeVisible();\n});\n","path":null,"size_bytes":583,"size_tokens":null},"src/app/admin/blog/new/page.tsx":{"content":"import BlogForm from \"@/app/admin/blog/_components/blog-form\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default function NewBlogPostPage() {\n  return (\n    <div>\n      <h1 className=\"mb-6 text-2xl font-bold\">New Blog Post</h1>\n      <BlogForm mode=\"create\" />\n    </div>\n  );\n}\n","path":null,"size_bytes":315,"size_tokens":null},"src/components/contact-form.tsx":{"content":"\"use client\";\n\nimport React, { useCallback } from \"react\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\nexport default function ContactForm() {\n  const onSubmit = useCallback((e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const form = e.currentTarget;\n    const name = (form.elements.namedItem(\"name\") as HTMLInputElement)?.value || \"\";\n    const email = (form.elements.namedItem(\"email\") as HTMLInputElement)?.value || \"\";\n    const message = (form.elements.namedItem(\"message\") as HTMLTextAreaElement)?.value || \"\";\n\n    const subject = encodeURIComponent(`Message from ${name || \"Visitor\"}`);\n    const body = encodeURIComponent([\n      `Name: ${name}`,\n      `Email: ${email}`,\n      \"\",\n      message,\n    ].join(\"\\n\"));\n\n    const mailto = `mailto:support@shopixo.com?subject=${subject}&body=${body}`;\n    window.location.href = mailto;\n  }, []);\n\n  return (\n    <form onSubmit={onSubmit} className=\"mt-6 grid gap-4 max-w-2xl\">\n      <Input name=\"name\" placeholder=\"Full Name\" required />\n      <Input name=\"email\" type=\"email\" placeholder=\"Email Address\" required />\n      <Textarea name=\"message\" placeholder=\"Your Message\" rows={6} required />\n      <button type=\"submit\" className=\"btn-primary w-fit\">Send Message</button>\n    </form>\n  );\n}\n","path":null,"size_bytes":1332,"size_tokens":null},"src/app/admin/cj/product/[pid]/page.tsx":{"content":"\"use client\"\n\nimport { useEffect, useMemo, useState } from 'react'\nimport Link from 'next/link'\n\nfunction isBadgeUrl(u: string): boolean {\n  return /(hot|badge|icon|favicon|logo|flag|qr|coupon|discount|sale|activity|cart|bag|money|usd|payment|sizechart|size\\s*chart|guide|tips)/i.test(u)\n}\n\nexport default function CjProductAdminPage({ params }: { params: { pid: string } }) {\n  const pid = decodeURIComponent(params.pid)\n  const [loading, setLoading] = useState(true)\n  const [data, setData] = useState<any>(null)\n  const [err, setErr] = useState<string | null>(null)\n  const [syncing, setSyncing] = useState(false)\n  const [shipLoading, setShipLoading] = useState(false)\n  const [shipResp, setShipResp] = useState<any>(null)\n\n  useEffect(() => {\n    let mounted = true\n    async function load() {\n      setLoading(true); setErr(null)\n      try {\n        const res = await fetch(`/api/cj/inspect/${encodeURIComponent(pid)}`, { cache: 'no-store' })\n        const j = await res.json()\n        if (!mounted) return\n        if (!res.ok) setErr(j?.error || 'Failed to load'); else setData(j)\n      } catch (e: any) {\n        if (!mounted) return\n        setErr(e?.message || String(e))\n      } finally {\n        if (mounted) setLoading(false)\n      }\n    }\n    load()\n    return () => { mounted = false }\n  }, [pid])\n\n  const flaggedImages: string[] = useMemo(() => {\n    const raw = data?.raw || {}\n    const list: string[] = Array.isArray(raw.imageList) ? raw.imageList.filter((x: any) => typeof x === 'string') : []\n    return list.filter(isBadgeUrl)\n  }, [data])\n\n  async function forceResync() {\n    setSyncing(true)\n    try {\n      const res = await fetch(`/api/cj/sync/product/${encodeURIComponent(pid)}?updateImages=true&updateVideo=true&updatePrice=true`, { cache: 'no-store' })\n      const j = await res.json()\n      alert(res.ok ? 'Re-sync complete' : `Re-sync failed: ${j?.error || res.status}`)\n    } catch (e: any) {\n      alert(`Re-sync error: ${e?.message || String(e)}`)\n    } finally {\n      setSyncing(false)\n    }\n  }\n\n  async function calcShipping(formData: FormData) {\n    setShipLoading(true)\n    setShipResp(null)\n    try {\n      const body = {\n        countryCode: String(formData.get('countryCode') || 'SA').toUpperCase(),\n        pid,\n        sku: String(formData.get('sku') || ''),\n        quantity: Number(formData.get('quantity') || 1),\n      }\n      const res = await fetch('/api/cj/shipping/calc', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) })\n      const j = await res.json()\n      setShipResp({ status: res.status, body: j })\n    } catch (e: any) {\n      setShipResp({ error: e?.message || String(e) })\n    } finally {\n      setShipLoading(false)\n    }\n  }\n\n  return (\n    <main className=\"mx-auto max-w-5xl p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-semibold\">CJ Product • {pid}</h1>\n        <Link className=\"text-blue-600 underline\" href=\"/admin/cj\">Back</Link>\n      </div>\n\n      {loading && <p>Loading…</p>}\n      {err && <p className=\"text-red-600\">{err}</p>}\n\n      {data?.mapped && (\n        <section className=\"grid md:grid-cols-2 gap-6\">\n          <div className=\"space-y-2\">\n            <h2 className=\"text-lg font-medium\">Mapped</h2>\n            <div className=\"border rounded p-3\">\n              <p className=\"font-semibold\">Title:</p>\n              <p className=\"mb-2\">{data.mapped.name}</p>\n              <p className=\"font-semibold\">Images:</p>\n              <div className=\"grid grid-cols-3 gap-2 mb-2\">\n                {(data.mapped.images || []).slice(0, 12).map((u: string) => (\n                  // eslint-disable-next-line @next/next/no-img-element\n                  <img key={u} src={u} alt=\"img\" className=\"w-full h-24 object-cover rounded border\" />\n                ))}\n              </div>\n              <p className=\"font-semibold\">Variants:</p>\n              <ul className=\"text-sm list-disc pl-6\">\n                {(data.mapped.variants || []).slice(0, 10).map((v: any, i: number) => (\n                  <li key={i}>{v.cjSku || '—'} • {v.size || '-'} • price: {v.price ?? '-'} • stock: {v.stock ?? '-'}</li>\n                ))}\n              </ul>\n            </div>\n          </div>\n          <div className=\"space-y-2\">\n            <h2 className=\"text-lg font-medium\">Raw (first 1)</h2>\n            <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-96\">{JSON.stringify(data.raw, null, 2)}</pre>\n          </div>\n        </section>\n      )}\n\n      <section className=\"space-y-2 border rounded p-4\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-medium\">Actions</h2>\n          <button onClick={forceResync} disabled={syncing} className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\">{syncing ? 'Resyncing…' : 'Force Re-sync (images+video+price)'}</button>\n        </div>\n        <div className=\"text-xs opacity-70\">Flagged images (likely badges/logos): {flaggedImages.length}</div>\n        {flaggedImages.length > 0 && (\n          <div className=\"grid grid-cols-4 gap-2 mt-2\">\n            {flaggedImages.map((u) => (\n              // eslint-disable-next-line @next/next/no-img-element\n              <img key={u} src={u} alt=\"flagged\" className=\"w-full h-20 object-cover rounded border\" />\n            ))}\n          </div>\n        )}\n      </section>\n\n      <section className=\"space-y-2 border rounded p-4\">\n        <h2 className=\"text-lg font-medium\">Shipping Preview</h2>\n        <form action={calcShipping} className=\"grid grid-cols-2 gap-3\">\n          <label className=\"flex flex-col text-sm\">Country<input name=\"countryCode\" defaultValue=\"SA\" className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">Variant SKU<input name=\"sku\" className=\"border rounded px-2 py-1\" placeholder=\"optional\"/></label>\n          <label className=\"flex flex-col text-sm\">Quantity<input name=\"quantity\" type=\"number\" defaultValue={1} min={1} className=\"border rounded px-2 py-1\"/></label>\n          <div className=\"col-span-2\"><button disabled={shipLoading} className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\">{shipLoading ? 'Calculating…' : 'Calculate'}</button></div>\n        </form>\n        {shipResp && (\n          <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-80\">{JSON.stringify(shipResp, null, 2)}</pre>\n        )}\n      </section>\n    </main>\n  )\n}\n","path":null,"size_bytes":6516,"size_tokens":null},"src/components/price-comparison.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport { ExternalLink } from \"lucide-react\";\n\ntype CompetitorPrice = {\n  id: number;\n  competitor_name: string;\n  price: number;\n  url: string | null;\n  last_updated: string;\n};\n\nasync function getCompetitorPrices(productId: number) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data, error } = await supabase\n    .from(\"competitor_prices\")\n    .select<\"*\", CompetitorPrice>(\"*\")\n    .eq(\"product_id\", productId)\n    .order(\"price\", { ascending: true });\n\n  if (error) {\n    console.error(\"Error fetching competitor prices:\", error);\n    return [];\n  }\n  return data;\n}\n\nexport default async function PriceComparison({ productId }: { productId: number }) {\n  const prices = await getCompetitorPrices(productId);\n\n  if (prices.length === 0) {\n    return null; // Don't render anything if there are no prices to compare\n  }\n\n  return (\n    <div className=\"mt-8 rounded-lg border bg-card p-4\">\n      <h3 className=\"text-lg font-semibold text-foreground\">Price Comparison</h3>\n      <ul className=\"mt-4 space-y-3\">\n        {prices.map((item) => (\n          <li key={item.id} className=\"flex items-center justify-between text-sm\">\n            <span className=\"text-muted-foreground\">{item.competitor_name}</span>\n            <div className=\"flex items-center gap-2\">\n              <span className=\"font-medium text-foreground\">{formatCurrency(item.price)}</span>\n              {item.url && item.url !== '#' && (\n                <a href={item.url} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-primary hover:underline\">\n                  <ExternalLink className=\"h-4 w-4\" />\n                  <span className=\"sr-only\">Visit site</span>\n                </a>\n              )}\n            </div>\n          </li>\n        ))}\n      </ul>\n    </div>\n  );\n}\n","path":null,"size_bytes":1948,"size_tokens":null},"src/components/pro/Hero.tsx":{"content":"import Image from \"next/image\"\nimport Link from \"next/link\"\n\nexport default function Hero() {\n  return (\n    <section className=\"relative overflow-hidden bg-[hsl(var(--bg))]\" aria-label=\"Hero section\">\n      <div className=\"container grid gap-6 py-12 md:grid-cols-2 md:py-16 lg:py-20\">\n        <div className=\"flex flex-col items-start justify-center md:order-1\">\n          <h1 className=\"mb-3 text-2xl sm:text-4xl lg:text-5xl font-bold\" style={{ fontFamily: 'var(--font-playfair), Playfair Display, serif' }}>\n            Premium Shopping Experience with Curated Selection\n          </h1>\n          <p className=\"mb-6 max-w-prose text-muted-foreground text-sm sm:text-base\">\n            High-quality products with fast shipping and secure payment. Discover the latest collections and deals today.\n          </p>\n          <div className=\"flex w-full flex-wrap items-center gap-3\">\n            <Link href=\"/shop\" className=\"inline-flex w-full sm:w-auto items-center justify-center rounded-[var(--radius-btn)] bg-[hsl(var(--primary))] px-6 py-3 text-white shadow-soft transition hover:brightness-95 text-base\">\n              Shop Now\n            </Link>\n            <Link href=\"/collections\" className=\"inline-flex w-full sm:w-auto items-center justify-center rounded-[var(--radius-btn)] border-2 border-[hsl(var(--secondary))] px-5 py-2.5 text-[hsl(var(--secondary))] transition hover:bg-[hsl(var(--secondary))]/10 text-base\">\n              Collections\n            </Link>\n          </div>\n        </div>\n        <div className=\"relative aspect-[16/10] w-full overflow-hidden rounded-image md:order-2\">\n          <Image\n            src=\"https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=1600&auto=format&fit=crop\"\n            alt=\"Premium product showcase\"\n            fill\n            sizes=\"(max-width: 768px) 100vw, 50vw\"\n            className=\"object-cover\"\n            priority\n          />\n        </div>\n      </div>\n    </section>\n  )\n}\n","path":null,"size_bytes":1963,"size_tokens":null},"src/lib/checkout-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { getStripe } from \"@/lib/stripe\";\nimport { getCart } from \"@/lib/cart-actions\";\nimport { getSiteUrl } from \"@/lib/site\";\n\nexport async function createCheckoutSession() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { session } } = await supabase.auth.getSession();\n\n  if (!session) {\n    redirect(\"/login\");\n  }\n\n  const cart = await getCart();\n\n  if (!cart || cart.length === 0) {\n    throw new Error(\"Cart is empty.\");\n  }\n\n  const lineItems = cart\n    .filter(item => item.product !== null)\n    .map((item) => {\n      const product = item.product!;\n      const hasVariantPrice = !!item.variant && item.variant.price !== null && item.variant.price !== undefined;\n      const unit = hasVariantPrice ? (item.variant!.price as number) : product.price;\n      const firstImage = product.images.length > 0 ? product.images[0] : undefined;\n      const absImage = firstImage && /^https?:\\/\\//i.test(firstImage) ? firstImage : (firstImage ? `${getSiteUrl()}${firstImage}` : undefined);\n      return {\n        price_data: {\n          currency: (process.env.NEXT_PUBLIC_CURRENCY || \"SAR\").toLowerCase(),\n          product_data: {\n            name: product.title,\n            images: absImage ? [absImage] : [],\n            metadata: {\n              productId: product.id,\n              variantId: item.variant?.id || '',\n            },\n          },\n          unit_amount: Math.round(unit * 100),\n        },\n        quantity: item.quantity,\n      };\n    });\n\n  const siteUrl = getSiteUrl();\n  const checkoutSession = await getStripe().checkout.sessions.create({\n    payment_method_types: [\"card\"],\n    line_items: lineItems,\n    mode: \"payment\",\n    success_url: `${siteUrl}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,\n    cancel_url: `${siteUrl}/cart`,\n    customer_email: session.user.email,\n    allow_promotion_codes: true,\n    metadata: {\n      userId: session.user.id,\n      cart: JSON.stringify(\n        cart.map(item => ({\n          productId: item.product!.id,\n          variantId: item.variant?.id || null,\n          quantity: item.quantity,\n          price: (item.variant && item.variant.price !== null && item.variant.price !== undefined) ? (item.variant.price as number) : item.product!.price,\n        }))\n      ),\n      cartSessionId: cookies().get(\"cart_id\")?.value || \"\",\n    },\n  });\n\n  if (!checkoutSession.url) {\n    throw new Error(\"Could not create checkout session.\");\n  }\n\n  redirect(checkoutSession.url);\n}\n","path":null,"size_bytes":2644,"size_tokens":null},"src/app/account/coupons/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading your coupons...\" />;\n}\n","path":null,"size_bytes":158,"size_tokens":null},"src/app/admin/products/actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport { revalidatePath } from \"next/cache\";\nimport { redirect } from \"next/navigation\";\nimport { z } from \"zod\";\nimport { productSchema } from \"@/lib/schemas/product\";\n\n// productSchema is now defined in '@/lib/schemas/product' to avoid exporting\n// non-async values from a 'use server' module.\n\nexport async function getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function getCurrentUser() {\n  const supabaseAuth = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabaseAuth.auth.getUser();\n  return user;\n}\n\nasync function canManageProduct(productId: number | null) {\n  // Admins can always manage\n  const adminCheck = await requireAdmin();\n  if (adminCheck.allowed) return true;\n\n  // If no productId, only allow if admin\n  if (!productId) return false;\n\n  const supabaseAdmin = await getSupabaseAdmin();\n  if (!supabaseAdmin) return false;\n  const user = await getCurrentUser();\n  if (!user) return false;\n\n  // Try to read owner column; if missing, fallback to admin-only\n  const { data, error } = await supabaseAdmin\n    .from(\"products\")\n    .select(\"user_id\")\n    .eq(\"id\", productId)\n    .single();\n  if (error && ((error as any).code === \"42703\" || String(error.message || \"\").includes(\"user_id\"))) {\n    // No owner column; cannot verify ownership\n    return false;\n  }\n  const ownerId = (data as any)?.user_id as string | null;\n  return !!ownerId && ownerId === user.id;\n}\n\nconst setActiveSchema = z.object({\n  id: z.coerce.number(),\n  is_active: z\n    .union([z.literal(\"true\"), z.literal(\"false\"), z.boolean()])\n    .transform((v) => (v === \"true\" || v === true ? true : false)),\n});\n\nexport async function setProductActive(prevState: { error: string | null; success: boolean }, formData: FormData) {\n  const supabaseAdmin = await getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { error: \"Server misconfiguration: missing Supabase service role envs\", success: false };\n  }\n\n  const validated = setActiveSchema.safeParse({\n    id: formData.get(\"id\"),\n    is_active: formData.get(\"is_active\"),\n  });\n  if (!validated.success) {\n    return { error: \"Invalid input.\", success: false };\n  }\n\n  const { id, is_active } = validated.data;\n\n  if (!(await canManageProduct(id))) {\n    return { error: \"Not authorized\", success: false };\n  }\n\n  const { error } = await supabaseAdmin.from(\"products\").update({ is_active }).eq(\"id\", id);\n  if (error) {\n    console.error(\"setProductActive failed:\", error);\n    return { error: \"Database error: Could not update product status.\", success: false };\n  }\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/products\");\n  revalidatePath(\"/\");\n  revalidatePath(\"/shop\");\n  revalidatePath(\"/search\");\n  redirect(\"/admin/products\");\n}\n\nasync function requireAdmin() {\n  const supabaseAuth = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabaseAuth.auth.getUser();\n  if (!user) {\n    return { allowed: false as const };\n  }\n  const adminEmails = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((e) => e.trim().toLowerCase())\n    .filter(Boolean);\n  if (adminEmails.length === 0) {\n    // Default deny in production when unset; allow in development for DX\n    return { allowed: process.env.NODE_ENV !== \"production\" } as const;\n  }\n  const email = (user.email || \"\").toLowerCase();\n  return { allowed: !!email && adminEmails.includes(email) } as const;\n}\n\nexport async function addProduct(prevState: any, formData: FormData) {\n  const user = await getCurrentUser();\n  if (!user) {\n    return { message: \"Not authorized\", fieldErrors: null };\n  }\n  const supabaseAdmin = await getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { message: \"Server misconfiguration: missing Supabase service role envs\", fieldErrors: null };\n  }\n  const validatedFields = productSchema.safeParse(Object.fromEntries(formData.entries()));\n\n  if (!validatedFields.success) {\n    return {\n      message: \"Invalid data\",\n      fieldErrors: validatedFields.error.flatten().fieldErrors,\n    };\n  }\n\n  // Attach owner if products.user_id column exists\n  let insertPayload: any = validatedFields.data;\n  try {\n    const probe = await supabaseAdmin.from(\"products\").select(\"user_id\").limit(1);\n    if (!probe.error) {\n      insertPayload = { ...insertPayload, user_id: user.id };\n    }\n  } catch {}\n\n  // Probe for is_active column existence; omit it from payload if column is missing\n  try {\n    const probeActive = await supabaseAdmin.from(\"products\").select(\"is_active\").limit(1);\n    if (probeActive.error) {\n      const { is_active, ...rest } = insertPayload;\n      insertPayload = rest;\n    }\n  } catch {\n    const { is_active, ...rest } = insertPayload;\n    insertPayload = rest;\n  }\n\n  const { error } = await supabaseAdmin.from(\"products\").insert(insertPayload);\n\n  if (error) {\n    // Provide a clearer, admin-friendly message (e.g., unique violation on slug)\n    console.error(\"Add product failed:\", error);\n    const friendlyMessage =\n      error.code === \"23505\"\n        ? \"Slug already exists. Please use a unique slug.\"\n        : error.message || \"Database error: Could not add product.\";\n    return { message: friendlyMessage, fieldErrors: null };\n  }\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/products\");\n  redirect(\"/admin/products\");\n}\n\nconst productUpdateSchema = productSchema.extend({\n  id: z.coerce.number(),\n});\n\nexport async function updateProduct(prevState: any, formData: FormData) {\n  const user = await getCurrentUser();\n  if (!user) {\n    return { message: \"Not authorized\", fieldErrors: null };\n  }\n  const supabaseAdmin = await getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { message: \"Server misconfiguration: missing Supabase service role envs\", fieldErrors: null };\n  }\n  const validatedFields = productUpdateSchema.safeParse(Object.fromEntries(formData.entries()));\n\n  if (!validatedFields.success) {\n    return {\n      message: \"Invalid data\",\n      fieldErrors: validatedFields.error.flatten().fieldErrors,\n    };\n  }\n\n  const { id, ...productData } = validatedFields.data;\n\n  if (!(await canManageProduct(id))) {\n    return { message: \"Not authorized\", fieldErrors: null };\n  }\n\n  // Omit is_active if column missing\n  try {\n    const probeActive = await supabaseAdmin.from(\"products\").select(\"is_active\").limit(1);\n    if (probeActive.error) {\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      const { is_active, ...rest } = productData as any;\n      (productData as any) = rest;\n    }\n  } catch {\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    const { is_active, ...rest } = productData as any;\n    (productData as any) = rest;\n  }\n\n  const { error } = await supabaseAdmin.from(\"products\").update(productData).eq(\"id\", id);\n\n  if (error) {\n    console.error(\"Update product failed:\", error);\n    const friendlyMessage =\n      error.code === \"23505\"\n        ? \"Slug already exists. Please use a unique slug.\"\n        : error.message || \"Database error: Could not update product.\";\n    return { message: friendlyMessage, fieldErrors: null };\n  }\n\n  revalidatePath(\"/admin\");\n  revalidatePath(`/admin/products/${id}/edit`);\n  redirect(\"/admin\");\n}\n\nconst deleteProductSchema = z.object({\n  id: z.coerce.number(),\n});\n\nexport async function deleteProduct(prevState: { error: string | null; success: boolean }, formData: FormData) {\n  const supabaseAdmin = await getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { error: \"Server misconfiguration: missing Supabase service role envs\", success: false };\n  }\n  const validatedFields = deleteProductSchema.safeParse(Object.fromEntries(formData.entries()));\n\n  if (!validatedFields.success) {\n    return { error: \"Invalid product ID.\", success: false };\n  }\n\n  const { id } = validatedFields.data;\n\n  if (!(await canManageProduct(id))) {\n    return { error: \"Not authorized\", success: false };\n  }\n\n  // First, remove any cart_items referencing this product to avoid FK restrict\n  const cartDel = await supabaseAdmin.from(\"cart_items\").delete().eq(\"product_id\", id);\n  if (cartDel.error) {\n    console.error(\"Failed to delete cart_items for product\", id, cartDel.error);\n  }\n\n  // Attempt to delete the product\n  const { error } = await supabaseAdmin.from(\"products\").delete().eq(\"id\", id);\n\n  if (error) {\n    console.error(\"Delete product failed:\", error);\n    // 23503 is foreign_key_violation in Postgres\n    if ((error as any).code === \"23503\") {\n      return { error: \"Cannot delete: product is referenced by existing orders. Consider setting stock to 0 instead.\", success: false };\n    }\n    return { error: \"Database error: Could not delete product.\", success: false };\n  }\n\n  revalidatePath(\"/admin\");\n  revalidatePath(\"/admin/products\");\n  redirect(\"/admin/products\");\n}\n","path":null,"size_bytes":9074,"size_tokens":null},"src/components/search-modal.tsx":{"content":"\"use client\";\n\nimport { useEffect, useRef, useState } from \"react\";\nimport { SearchIcon, X } from \"lucide-react\";\nimport Link from \"next/link\";\n\nfunction useDebouncedValue<T>(value: T, delay = 300) {\n  const [debounced, setDebounced] = useState(value);\n  useEffect(() => {\n    const id = setTimeout(() => setDebounced(value), delay);\n    return () => clearTimeout(id);\n  }, [value, delay]);\n  return debounced;\n}\n\nexport default function SearchModal({ renderTrigger }: { renderTrigger?: (open: () => void) => React.ReactNode }) {\n  const [open, setOpen] = useState(false);\n  const [query, setQuery] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  type SearchItem = { id: number; slug: string; title: string; price: number; images?: string[] };\n  const [items, setItems] = useState<SearchItem[]>([]);\n  const debounced = useDebouncedValue(query, 300);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  useEffect(() => {\n    if (!open) return;\n    const onKey = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setOpen(false);\n    };\n    document.addEventListener(\"keydown\", onKey);\n    requestAnimationFrame(() => inputRef.current?.focus());\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [open]);\n\n  useEffect(() => {\n    let cancelled = false;\n    async function run() {\n      if (!debounced) {\n        setItems([]);\n        return;\n      }\n      setLoading(true);\n      try {\n        const res = await fetch(`/api/search?q=${encodeURIComponent(debounced)}`);\n        const json = await res.json();\n        if (!cancelled) setItems(json.items || []);\n      } catch {\n        if (!cancelled) setItems([]);\n      } finally {\n        if (!cancelled) setLoading(false);\n      }\n    }\n    run();\n    return () => {\n      cancelled = true;\n    };\n  }, [debounced]);\n\n  return (\n    <>\n      {renderTrigger ? (\n        <>{renderTrigger(() => setOpen(true))}</>\n      ) : (\n        <button\n          aria-label=\"Open search\"\n          className=\"inline-flex items-center justify-center rounded-md border px-2 py-2 text-sm hover:bg-muted lg:hidden\"\n          onClick={() => setOpen(true)}\n        >\n          <SearchIcon className=\"h-4 w-4\" />\n        </button>\n      )}\n\n      {open && (\n        <div aria-modal=\"true\" role=\"dialog\" className=\"fixed inset-0 z-50\">\n          <div\n            className=\"absolute inset-0 bg-black/40 backdrop-blur-sm\"\n            onClick={() => setOpen(false)}\n          />\n          <div className=\"absolute inset-x-0 top-0 mx-auto w-full max-w-2xl rounded-b-2xl border bg-background p-4 shadow-xl\">\n            <div className=\"flex items-center gap-2\">\n              <SearchIcon className=\"h-5 w-5 text-muted-foreground\" />\n              <input\n                ref={inputRef}\n                placeholder=\"Search products...\"\n                value={query}\n                onChange={(e) => setQuery(e.target.value)}\n                className=\"flex-1 bg-transparent text-base outline-none placeholder:text-muted-foreground\"\n                aria-label=\"Search products\"\n              />\n              <button aria-label=\"Close\" className=\"rounded-md p-1 hover:bg-muted\" onClick={() => setOpen(false)}>\n                <X className=\"h-5 w-5\" />\n              </button>\n            </div>\n            <div className=\"mt-3 max-h-[60vh] overflow-auto\">\n              {loading && <div className=\"p-3 text-sm text-muted-foreground\">Searching...</div>}\n              {!loading && items.length === 0 && debounced && (\n                <div className=\"p-3 text-sm text-muted-foreground\">No results for \"{debounced}\".</div>\n              )}\n              <ul className=\"divide-y\">\n                {items.map((it: SearchItem) => (\n                  <li key={it.id} className=\"py-2\">\n                    <Link\n                      href={`/product/${it.slug}`}\n                      className=\"flex items-center gap-3 rounded-md px-2 py-2 hover:bg-muted\"\n                      onClick={() => setOpen(false)}\n                    >\n                      <div className=\"relative h-12 w-12 overflow-hidden rounded-md bg-muted\">\n                        {/* eslint-disable-next-line @next/next/no-img-element */}\n                        <img\n                          src={it.images?.[0] || '/placeholder.svg'}\n                          alt={it.title}\n                          loading=\"lazy\"\n                          decoding=\"async\"\n                          className=\"h-full w-full object-cover\"\n                          onError={(e) => {\n                            const el = e.currentTarget as HTMLImageElement;\n                            if (el.src.endsWith('/placeholder.svg')) return;\n                            el.src = '/placeholder.svg';\n                          }}\n                        />\n                      </div>\n                      <div className=\"min-w-0 flex-1\">\n                        <div className=\"truncate text-sm font-medium text-foreground\">{it.title}</div>\n                        <div className=\"text-xs text-muted-foreground\">{new Intl.NumberFormat(undefined, { style: 'currency', currency: (process.env.NEXT_PUBLIC_CURRENCY || 'USD') as any }).format(it.price || 0)}</div>\n                      </div>\n                    </Link>\n                  </li>\n                ))}\n              </ul>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":5369,"size_tokens":null},"src/app/account/coupons/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { getStripe } from \"@/lib/stripe\";\nimport { format } from \"date-fns\";\nimport { formatCurrency } from \"@/lib/utils\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype CouponUsage = {\n  orderId: number;\n  createdAt: string;\n  code: string;\n  label: string;\n  amountSaved: number;\n  currency: string;\n};\n\nexport default async function CouponsPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/coupons\");\n\n  const { data: orders } = await supabase\n    .from(\"orders\")\n    .select(\"id, created_at, stripe_session_id\")\n    .eq(\"user_id\", user.id)\n    .order(\"created_at\", { ascending: false });\n\n  const hasStripeKey = !!process.env.STRIPE_SECRET_KEY;\n  const stripe = hasStripeKey ? getStripe() : null;\n\n  const usages: CouponUsage[] = [];\n  for (const o of orders || []) {\n    const sessionId = (o as any).stripe_session_id as string | null;\n    if (!sessionId || !stripe) continue;\n    try {\n      const session: any = await stripe.checkout.sessions.retrieve(sessionId, {\n        expand: [\n          \"total_details.breakdown.discounts.discount.coupon\",\n          \"total_details.breakdown.discounts.discount.promotion_code\",\n        ],\n      });\n\n      const currency: string = session.currency || \"usd\";\n      const totalDetails = session.total_details || {};\n      const amountDiscountCents: number = totalDetails.amount_discount || 0;\n      const amountSaved = amountDiscountCents / 100;\n\n      let code = \"\";\n      let label = \"Discount\";\n      const breakdownDiscounts = totalDetails.breakdown?.discounts || [];\n      if (breakdownDiscounts.length > 0) {\n        const first = breakdownDiscounts[0];\n        const discount = first.discount;\n        const pc = discount?.promotion_code;\n        const coupon = discount?.coupon;\n        if (pc && typeof pc === \"object\" && pc.code) {\n          code = pc.code;\n          label = coupon?.name || pc.code || \"Promotion\";\n        } else if (coupon && typeof coupon === \"object\") {\n          label = coupon.name || \"Coupon\";\n          code = coupon.id || label;\n        }\n      }\n\n      if (amountSaved > 0) {\n        usages.push({\n          orderId: (o as any).id as number,\n          createdAt: (o as any).created_at as string,\n          code: code || label,\n          label: label || \"Discount\",\n          amountSaved,\n          currency,\n        });\n      }\n    } catch (e) {\n      console.warn(\"Failed to retrieve Stripe session for coupons page\", { sessionId, e });\n    }\n  }\n\n  return (\n    <div className=\"max-w-3xl mx-auto py-12 px-4\">\n      <h1 className=\"text-2xl font-bold mb-6\">Coupons & Offers</h1>\n      {!hasStripeKey ? (\n        <div className=\"rounded-lg border bg-white p-6\">\n          <p className=\"text-gray-700\">You can use discount codes at checkout. Coupon history is not available because Stripe is not configured in this environment.</p>\n        </div>\n      ) : usages.length === 0 ? (\n        <div className=\"rounded-lg border bg-white p-6\">\n          <p className=\"text-gray-700\">No discount codes used yet. You can enter a code during checkout when available.</p>\n        </div>\n      ) : (\n        <div className=\"rounded-lg border bg-white p-6\">\n          <h2 className=\"text-lg font-semibold mb-4\">Applied Offers</h2>\n          <ul className=\"divide-y\">\n            {usages.map((u) => (\n              <li key={u.orderId} className=\"py-3 flex items-center justify-between gap-4\">\n                <div>\n                  <p className=\"font-medium\">{u.label}</p>\n                  <p className=\"text-sm text-gray-600\">Order #{u.orderId} • {format(new Date(u.createdAt), \"MMM d, yyyy\")}</p>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm text-gray-600\">Code</p>\n                  <p className=\"font-semibold\">{u.code}</p>\n                  <p className=\"text-sm text-green-700\">Saved {formatCurrency(u.amountSaved, (u.currency || \"USD\").toUpperCase())}</p>\n                </div>\n              </li>\n            ))}\n          </ul>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4331,"size_tokens":null},"src/sentry.client.config.ts":{"content":"// Client-side Sentry initialization with optional dynamic import.\n// If the package is not installed, we skip initialization gracefully.\nif (process.env.SENTRY_DSN) {\n  (async () => {\n    try {\n      const mod: any = await import('@sentry/nextjs');\n      if (!mod || typeof mod.init !== 'function') return;\n      mod.init({\n        dsn: process.env.SENTRY_DSN,\n        tracesSampleRate: 0.1,\n        enabled: true,\n        environment: process.env.VERCEL_ENV || process.env.NODE_ENV,\n      });\n    } catch {\n      // Sentry not installed; skip\n    }\n  })();\n}\n","path":null,"size_bytes":561,"size_tokens":null},"src/app/admin/cj/page.tsx":{"content":"export const dynamic = 'force-dynamic'\n\nexport default function CjAdminPage() {\n  return (\n    <main className=\"mx-auto max-w-3xl p-6 space-y-6\">\n      <h1 className=\"text-2xl font-semibold\">Supplier Admin</h1>\n      <p className=\"text-sm opacity-80\">Admin tools for syncing supplier catalog, refreshing products, and calculating shipping.</p>\n\n      <ul className=\"list-disc pl-6 space-y-2\">\n        <li>\n          <a className=\"text-blue-600 underline\" href=\"/admin/cj/refresh\">Refresh catalog (batch) + single product</a>\n        </li>\n        <li>\n          <a className=\"text-blue-600 underline\" href=\"/admin/cj/shipping\">Shipping calculator</a>\n        </li>\n        <li>\n          <a className=\"text-blue-600 underline\" href=\"/admin/cj/health\">Health dashboard</a>\n        </li>\n      </ul>\n\n      <div className=\"text-xs opacity-75\">\n        <p>Ensure environment variables are correctly set:</p>\n        <pre className=\"whitespace-pre-wrap\">{`CJ_API_BASE, CJ_API_KEY (or CJ_ACCESS_TOKEN), CJ_EMAIL, CJ_WEBHOOK_SECRET,\nNEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY,\nOPENAI_API_KEY (optional), AI_MODEL_TEXT (optional)`}</pre>\n      </div>\n    </main>\n  )\n}\n","path":null,"size_bytes":1171,"size_tokens":null},"src/app/api/cj/sync/catalog/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { z } from 'zod'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { listCjProductsPage, mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { persistRawCj, upsertProductFromCj } from '@/lib/ops/cj-sync'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const { searchParams } = new URL(req.url)\n    const Q = z.object({\n      pageNum: z.string().optional(),\n      pageSize: z.string().optional(),\n      keyword: z.string().optional(),\n      updateImages: z.string().optional(),\n      updateVideo: z.string().optional(),\n      updatePrice: z.string().optional(),\n    })\n    const q = Q.parse({\n      pageNum: searchParams.get('pageNum') || undefined,\n      pageSize: searchParams.get('pageSize') || undefined,\n      keyword: searchParams.get('keyword') || undefined,\n      updateImages: searchParams.get('updateImages') || undefined,\n      updateVideo: searchParams.get('updateVideo') || undefined,\n      updatePrice: searchParams.get('updatePrice') || undefined,\n    })\n    const pageNum = Math.max(1, Number(q.pageNum || '1'))\n    const pageSize = Math.min(50, Math.max(1, Number(q.pageSize || '20')))\n    const keyword = q.keyword || ''\n    const toBool = (v: string | undefined, d: boolean) => v ? v.toLowerCase() === 'true' : d\n    const updateImages = toBool(q.updateImages, true)\n    const updateVideo = toBool(q.updateVideo, true)\n    const updatePrice = toBool(q.updatePrice, true)\n\n    // 1) List a catalog page\n    const list = await listCjProductsPage({ pageNum, pageSize, keyword: keyword || undefined })\n    const arr: any[] = Array.isArray(list?.data?.list)\n      ? list.data.list\n      : Array.isArray(list?.data?.content)\n        ? list.data.content\n        : Array.isArray(list?.list)\n          ? list.list\n          : Array.isArray(list?.data)\n            ? list.data\n            : Array.isArray(list)\n              ? list\n              : []\n\n    if (arr.length === 0) {\n      const r = NextResponse.json({ ok: true, pageNum, pageSize, count: 0, results: [] })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // 2) For each item, resolve full details then map + upsert\n    const results: any[] = []\n    const db = (() => {\n      const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n      const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n      if (!url || !key) return null\n      return createClient(url, key)\n    })()\n    for (const it of arr) {\n      try {\n        const pid = String(it.pid || it.productId || it.id || '')\n        if (!pid) { results.push({ ok: false, reason: 'no pid' }); continue }\n        const raw = await queryProductByPidOrKeyword({ pid })\n        const itemRaw = Array.isArray(raw?.data?.list)\n          ? raw.data.list[0]\n          : Array.isArray(raw?.data?.content)\n            ? raw.data.content[0]\n            : Array.isArray(raw?.content)\n              ? raw.content[0]\n              : Array.isArray(raw?.data)\n                ? raw.data[0]\n                : (raw?.data || raw)\n        const mapped = mapCjItemToProductLike(itemRaw)\n        if (!mapped) { results.push({ ok: false, pid, reason: 'map failed' }); continue }\n        const up = await upsertProductFromCj(mapped, { updateImages, updateVideo, updatePrice })\n        if (up.ok) {\n          try { await persistRawCj(up.productId, itemRaw) } catch {}\n          let slug: string | undefined = undefined\n          if (db) {\n            try {\n              const { data } = await db.from('products').select('slug').eq('id', up.productId).maybeSingle()\n              slug = data?.slug || undefined\n            } catch {}\n          }\n          results.push({ ok: true, pid, productId: up.productId, slug, updated: up.updated })\n        } else {\n          results.push({ ok: false, pid, error: up.error })\n        }\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e) })\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, pageNum, pageSize, count: results.filter(r => r.ok).length, results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'catalog sync failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4774,"size_tokens":null},"src/app/admin/products/delete-button.tsx":{"content":"\"use client\";\n\nimport { useFormState } from \"react-dom\";\nimport { deleteProduct } from \"@/app/admin/products/actions\";\n\ntype DeleteState = { error: string | null; success: boolean };\n\nconst initialState: DeleteState = { error: null, success: false };\n\nexport default function DeleteProductButton({ productId, doubleConfirm = false, formId }: { productId: number; doubleConfirm?: boolean; formId?: string }) {\n  const [state, formAction] = useFormState<DeleteState, FormData>(deleteProduct as any, initialState);\n\n  function handleSubmit(e: React.FormEvent<HTMLFormElement>) {\n    const first = window.confirm(\"Are you sure you want to delete this product?\");\n    if (!first) {\n      e.preventDefault();\n      return;\n    }\n    if (doubleConfirm) {\n      const second = window.confirm(\"Warning: This action is permanent and cannot be undone. Do you want to proceed?\");\n      if (!second) {\n        e.preventDefault();\n        return;\n      }\n    }\n  }\n\n  return (\n    <form id={formId} action={formAction} onSubmit={handleSubmit} className=\"inline-block\">\n      <input type=\"hidden\" name=\"id\" value={productId} />\n      <button type=\"submit\" className=\"text-sm font-medium text-red-600 hover:underline\">\n        Delete\n      </button>\n      {state?.error && <p className=\"mt-1 text-xs text-red-600\">{state.error}</p>}\n    </form>\n  );\n}\n","path":null,"size_bytes":1336,"size_tokens":null},"branding/suppliers/po-trial-order-ar.md":{"content":"# أمر شراء تجريبي (PO) — Shopixo\n\nرقم الطلب: [PO-2025-001]\nالتاريخ: [YYYY-MM-DD]\nالمورد: [الشركة]\nالجهة المسؤولة: [الاسم، البريد، واتساب]\n\nشروط التنفيذ:\n- شحن أعمى. اسم المرسل على الملصق: Shopixo\n- تضمين قسيمة التغليف + بطاقة الشكر الخاصة بـ Shopixo داخل الطرد\n- الخدمة: [اقتصادي/سريع]، DDP: [نعم/لا]\n- زمن التوصيل المستهدف للسعودية: [X–Y] يومًا. رقم تتبع خلال 24 ساعة\n\nعنوان الشحن: عميل نهائي داخل السعودية. سنرسل العنوان بالعربية لكل طلب\n\nالعناصر:\n| SKU | الاسم | المتغيرات | الكمية | التكلفة للوحدة (USD) | الوزن التقديري (كغ) | ملاحظات |\n|---|---|---|---:|---:|---:|---|\n\nتعليمات التغليف: الملابس مطوية داخل أكياس بولي نظيفة. يُمنع وضع أي مواد تخص المورد داخل الطرد\n\nإثبات قبل الشحن: صورة/فيديو لملصق (Shopixo) + بطاقة الشكر + قسيمة التغليف داخل الطرد\n\nالدفع: [بطاقة/حوالة] — العملة: USD — Incoterms: نفضّل DDP\n\nمخول من Shopixo: __________________ التاريخ: _____\n","path":null,"size_bytes":1388,"size_tokens":null},"src/app/admin/blog/page.tsx":{"content":"import Link from \"next/link\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport DeleteBlogPostButton from \"@/app/admin/blog/delete-button\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nasync function getPosts() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return [] as any[];\n  const supabase = createClient(url, key);\n  const { data, error } = await supabase\n    .from(\"blog_posts\")\n    .select(\"id, title, slug, published, created_at\")\n    .order(\"created_at\", { ascending: false })\n    .limit(100);\n  if (error) return [] as any[];\n  return data || [];\n}\n\nexport default async function AdminBlogPage() {\n  const posts = await getPosts();\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">Blog</h1>\n        <Link href={{ pathname: \"/admin/blog/new\" }} className=\"btn-primary px-4 py-2 rounded-md bg-black text-white\">\n          New Post\n        </Link>\n      </div>\n\n      {posts.length === 0 ? (\n        <p className=\"text-slate-600\">No posts yet.</p>\n      ) : (\n        <div className=\"overflow-x-auto rounded-lg border bg-white\">\n          <table className=\"min-w-full text-sm\">\n            <thead className=\"bg-slate-50 text-left text-slate-600\">\n              <tr>\n                <th className=\"p-3\">Title</th>\n                <th className=\"p-3\">Slug</th>\n                <th className=\"p-3\">Published</th>\n                <th className=\"p-3\">Created</th>\n                <th className=\"p-3 text-right\">Actions</th>\n              </tr>\n            </thead>\n            <tbody>\n              {posts.map((p) => (\n                <tr key={p.id} className=\"border-t\">\n                  <td className=\"p-3 font-medium\">{p.title}</td>\n                  <td className=\"p-3 text-slate-600\">{p.slug}</td>\n                  <td className=\"p-3\">{p.published ? \"Yes\" : \"No\"}</td>\n                  <td className=\"p-3\">{p.created_at ? new Date(p.created_at).toLocaleString() : \"\"}</td>\n                  <td className=\"p-3 text-right space-x-2\">\n                    <Link href={{ pathname: \"/admin/blog/[id]/edit\", query: { id: String(p.id) } }} className=\"text-blue-600 hover:underline\">\n                      Edit\n                    </Link>\n                    <DeleteBlogPostButton postId={p.id} />\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":2560,"size_tokens":null},"src/lib/ops/cj-sync.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js'\nimport { slugify } from '@/lib/utils/slug'\nimport { hasTable, hasColumn } from '@/lib/db-features'\nimport type { CjProductLike } from '@/lib/cj/v2'\nimport { freightCalculate } from '@/lib/cj/v2'\nimport { loadPricingPolicy } from '@/lib/pricing-policy'\nimport { computeRetailFromLanded, convertToSar, maybeUsdToSar } from '@/lib/pricing'\n\nfunction getSupabaseAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL as string | undefined\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY as string | undefined\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function productVariantsTableExists(): Promise<boolean> {\n  return await hasTable('product_variants')\n}\n\nasync function ensureUniqueSlug(admin: SupabaseClient, base: string): Promise<string> {\n  const s = slugify(base)\n  let candidate = s\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin.from('products').select('id').eq('slug', candidate).maybeSingle()\n    if (!data) return candidate\n    candidate = `${s}-${i}`\n  }\n  return `${s}-${Date.now()}`\n}\n\nexport type UpsertOptions = {\n  updateImages?: boolean\n  updateVideo?: boolean\n  updatePrice?: boolean\n}\n\nexport async function upsertProductFromCj(cj: CjProductLike, options: UpsertOptions = {}): Promise<{ ok: true; productId: number; updated: string[] } | { ok: false; error: string }>{\n  const admin = getSupabaseAdmin()\n  if (!admin) return { ok: false, error: 'Supabase not configured' }\n\n  try {\n    // Find existing by cj_product_id when column exists\n    let existing: any = null\n    if (await hasColumn('products', 'cj_product_id')) {\n      const resp = await admin.from('products').select('id, slug, price').eq('cj_product_id', cj.productId).maybeSingle()\n      existing = resp.data || null\n    }\n\n    const baseSlug = await ensureUniqueSlug(admin, cj.name)\n    const priceCandidates = (cj.variants || []).map((v) => (typeof v.price === 'number' ? v.price : NaN)).filter((n) => !isNaN(n))\n    const minVariantPrice = priceCandidates.length > 0 ? Math.min(...priceCandidates) : 0\n    const minVariant = (cj.variants || []).reduce<{ price: number; sku?: string } | null>((best, v) => {\n      const p = typeof v.price === 'number' ? v.price : NaN\n      if (isNaN(p)) return best\n      if (!best || p < best.price) return { price: p, sku: v.cjSku }\n      return best\n    }, null)\n\n    const totalStock = (cj.variants || []).reduce((acc, v) => acc + (typeof v.stock === 'number' ? v.stock : 0), 0)\n\n    const productPayload: any = {\n      title: cj.name,\n      slug: existing?.slug || baseSlug,\n      price: existing?.price ?? minVariantPrice,\n      category: 'Women',\n      stock: totalStock,\n    }\n\n    const optional: Record<string, any> = {\n      images: options.updateImages ? (cj.images || []) : undefined,\n      video_url: options.updateVideo ? (cj.videoUrl || null) : undefined,\n      is_active: true,\n      cj_product_id: cj.productId,\n      processing_time_hours: (cj as any).processingTimeHours ?? null,\n      delivery_time_hours: (cj as any).deliveryTimeHours ?? null,\n      origin_area: (cj as any).originArea ?? null,\n      origin_country_code: (cj as any).originCountryCode ?? null,\n      shipping_from: (cj as any).originArea ?? null,\n    }\n\n    // Prune undefineds and columns that don't exist\n    const toPrune = Object.keys(optional)\n    for (const c of toPrune) {\n      if (optional[c] === undefined) delete optional[c]\n      else {\n        const exists = await hasColumn('products', c)\n        if (!exists) delete optional[c]\n      }\n    }\n\n    const updated: string[] = []\n\n    let productId: number\n    if (existing?.id) {\n      const { data: upd, error: upErr } = await admin\n        .from('products')\n        .update({ ...productPayload, ...optional })\n        .eq('id', existing.id)\n        .select('id')\n        .single()\n      if (upErr || !upd) throw upErr || new Error('Failed to update product')\n      productId = upd.id as number\n      updated.push('product')\n    } else {\n      // Insert with slug conflict retry (include optional columns on insert)\n      let insRes: any = null\n      try {\n        const { data: ins, error: insErr } = await admin\n          .from('products')\n          .insert({ ...productPayload, ...optional })\n          .select('id')\n          .single()\n        if (insErr || !ins) throw insErr || new Error('Failed to insert product')\n        insRes = ins\n      } catch (e: any) {\n        const msg = String(e?.message || e || '')\n        if (/duplicate key|unique constraint|unique violation|already exists/i.test(msg)) {\n          const base = productPayload.slug || slugify(cj.name)\n          productPayload.slug = await ensureUniqueSlug(admin, base)\n          const { data: ins2, error: err2 } = await admin\n            .from('products')\n            .insert({ ...productPayload, ...optional })\n            .select('id')\n            .single()\n          if (err2 || !ins2) throw err2 || new Error('Failed to insert product (retry)')\n          insRes = ins2\n        } else {\n          throw e\n        }\n      }\n      productId = insRes.id as number\n      updated.push('product')\n    }\n\n    // Recalculate retail price with shipping + margin when requested\n    if (options.updatePrice) {\n      try {\n        const policy = await loadPricingPolicy()\n        let shippingSar = 0\n        try {\n          // Use variant vid for exact CJ \"According to Shipping Method\" data\n          const variantVid = (minVariant as any)?.vid || minVariant?.sku || cj.productId;\n          \n          const fc = await freightCalculate({ \n            countryCode: 'US', \n            vid: variantVid, \n            quantity: 1\n          })\n          if (fc.ok) {\n            const cheapest = (fc.options || []).reduce<{ price: number; currency?: string; aging?: { min?: number; max?: number } } | null>((best: { price: number; currency?: string; aging?: { min?: number; max?: number } } | null, opt: any) => {\n              const p = Number(opt.price || 0)\n              if (!best || p < best.price) return { price: p, currency: opt.currency, aging: opt.logisticAgingDays }\n              return best\n            }, null)\n            if (cheapest) {\n              shippingSar = convertToSar(cheapest.price, cheapest.currency)\n              // If we have an aging estimate in days, persist to product\n              try {\n                const aging = cheapest.aging\n                if (aging && (typeof aging.min === 'number' || typeof aging.max === 'number')) {\n                  const avgDays = typeof aging.min === 'number' && typeof aging.max === 'number' ? (aging.min + aging.max) / 2\n                    : (typeof aging.min === 'number' ? aging.min : (aging.max as number))\n                  const hours = Math.max(1, Math.round(avgDays * 24))\n                  await admin.from('products').update({ delivery_time_hours: hours }).eq('id', productId)\n                  updated.push('delivery_time_hours')\n                }\n              } catch {}\n            }\n          }\n        } catch {}\n\n        const baseCostSar = typeof minVariantPrice === 'number' ? maybeUsdToSar(minVariantPrice) : 0\n        const landed = Math.max(0, baseCostSar) + Math.max(0, shippingSar)\n        let retail = computeRetailFromLanded(landed, { margin: policy.margin, roundTo: policy.roundTo, prettyEnding: policy.endings })\n        if (retail < policy.floorSar) retail = policy.floorSar\n        await admin.from('products').update({ price: retail }).eq('id', productId)\n        updated.push('price')\n      } catch {}\n    }\n\n    // Variants table\n    if (await productVariantsTableExists()) {\n      const variants = (cj.variants || []).filter((v) => v && (v.size || (v as any).color || v.cjSku))\n      const hasSize = variants.some((v) => !!(v as any).size)\n      const hasColor = variants.some((v: any) => !!(v as any).color)\n      const both = hasSize && hasColor\n      const optionName = both ? 'Variant' : (hasSize ? 'Size' : (hasColor ? 'Color' : 'Variant'))\n\n      const rows = variants.map((v: any) => ({\n        product_id: productId,\n        option_name: optionName,\n        option_value: both ? `${(v.color as string) || '-'} / ${(v.size as string) || '-'}` : (hasSize ? (v.size || '-') : ((v.color as string) || '-')),\n        cj_sku: v.cjSku || null,\n        price: typeof v.price === 'number' ? v.price : null,\n        stock: typeof v.stock === 'number' ? v.stock : 0,\n        // Shipping metadata when available\n        weight_grams: typeof v.weightGrams === 'number' ? v.weightGrams : null,\n        length_cm: typeof v.lengthCm === 'number' ? v.lengthCm : null,\n        width_cm: typeof v.widthCm === 'number' ? v.widthCm : null,\n        height_cm: typeof v.heightCm === 'number' ? v.heightCm : null,\n      }))\n      await admin.from('product_variants').delete().eq('product_id', productId)\n      if (rows.length > 0) await admin.from('product_variants').insert(rows)\n      updated.push('variants')\n    }\n\n    try { await admin.rpc('recompute_product_stock', { product_id_in: productId }) } catch {}\n\n    return { ok: true, productId, updated }\n  } catch (e: any) {\n    return { ok: false, error: e?.message || 'upsert failed' }\n  }\n}\n\nexport async function persistRawCj(productId: number, raw: any): Promise<void> {\n  const admin = getSupabaseAdmin()\n  if (!admin) return\n  if (!(await hasTable('raw_cj_responses'))) return\n  try {\n    await admin.from('raw_cj_responses').insert({ product_id: productId, source: 'cj', payload: raw })\n  } catch {}\n}\n\nexport async function logSync(event: string, meta: Record<string, any>) {\n  const admin = getSupabaseAdmin()\n  if (!admin) return\n  if (!(await hasTable('sync_logs'))) return\n  try {\n    await admin.from('sync_logs').insert({ event, meta })\n  } catch {}\n}\n","path":null,"size_bytes":9797,"size_tokens":null},"src/app/product/[slug]/opengraph-image.tsx":{"content":"import { ImageResponse } from \"next/og\";\n\nexport const runtime = \"edge\";\nexport const size = { width: 1200, height: 630 };\nexport const contentType = \"image/png\";\n\nexport default async function Image({\n  params,\n}: {\n  params: { slug: string };\n}) {\n  const title = decodeURIComponent(params.slug).replace(/[-_]/g, \" \") || \"Product\";\n  const price = \"\";\n\n  return new ImageResponse(\n    (\n      <div\n        style={{\n          height: \"100%\",\n          width: \"100%\",\n          display: \"flex\",\n          flexDirection: \"column\",\n          justifyContent: \"center\",\n          alignItems: \"flex-start\",\n          background: \"linear-gradient(135deg, #EEF2FF 0%, #ECFEFF 100%)\",\n          padding: 80,\n        }}\n      >\n        <div style={{ fontSize: 48, color: \"#4f46e5\", fontWeight: 800 }}>Shopixo</div>\n        <div style={{ marginTop: 12, fontSize: 56, color: \"#111827\", fontWeight: 800, maxWidth: 980 }}>\n          {title}\n        </div>\n        {price && (\n          <div style={{ marginTop: 16, fontSize: 40, color: \"#1f2937\", fontWeight: 700 }}>{price}</div>\n        )}\n        <div style={{ marginTop: 18, fontSize: 24, color: \"#374151\" }}>\n          Modern Online Store • Fast Delivery • Secure Checkout\n        </div>\n      </div>\n    ),\n    { ...size }\n  );\n}\n","path":null,"size_bytes":1276,"size_tokens":null},"src/app/admin/products/new/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport ProductForm from \"@/app/admin/products/product-form\";\n\nexport const metadata = {\n  title: \"Add New Product\",\n};\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function NewProductPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { session } } = await supabase.auth.getSession();\n\n  if (!session) {\n    redirect(\"/login\");\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Add New Product</h1>\n      <div className=\"mt-6 max-w-2xl\">\n        <ProductForm />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":780,"size_tokens":null},"src/lib/log.ts":{"content":"import crypto from 'crypto';\nimport { NextResponse } from 'next/server';\n\nexport type Logger = {\n  requestId: string;\n  info: (msg: string, meta?: Record<string, any>) => void;\n  warn: (msg: string, meta?: Record<string, any>) => void;\n  error: (msg: string, meta?: Record<string, any>) => void;\n};\n\nexport function getRequestIdFromHeaders(h: Headers | null | undefined): string | null {\n  if (!h) return null;\n  return (\n    h.get('x-request-id') ||\n    h.get('x-correlation-id') ||\n    h.get('cf-ray') ||\n    h.get('x-vercel-id') ||\n    null\n  );\n}\n\nexport function newRequestId(): string {\n  try {\n    return crypto.randomUUID();\n  } catch {\n    return Math.random().toString(36).slice(2) + Date.now().toString(36);\n  }\n}\n\nexport function loggerForRequest(req?: Request): Logger {\n  const fromHeader = getRequestIdFromHeaders(req?.headers);\n  const requestId = fromHeader || newRequestId();\n\n  function base(level: 'INFO'|'WARN'|'ERROR', msg: string, meta?: Record<string, any>) {\n    const line = {\n      level,\n      requestId,\n      msg,\n      ...(meta || {}),\n    };\n    // eslint-disable-next-line no-console\n    if (level === 'ERROR') console.error(JSON.stringify(line));\n    else if (level === 'WARN') console.warn(JSON.stringify(line));\n    else console.log(JSON.stringify(line));\n  }\n\n  return {\n    requestId,\n    info: (m, meta) => base('INFO', m, meta),\n    warn: (m, meta) => base('WARN', m, meta),\n    error: (m, meta) => base('ERROR', m, meta),\n  };\n}\n\n// Convenience helper: returns a logger and response helpers bound to this request\nexport function withLogger(req: Request) {\n  const log = loggerForRequest(req);\n  return {\n    log,\n    requestId: log.requestId,\n    // Create a NextResponse.json with x-request-id attached\n    json: (data: any, init?: Parameters<typeof NextResponse.json>[1]) => {\n      const r = NextResponse.json(data, init as any);\n      try { r.headers.set('x-request-id', log.requestId); } catch {}\n      return r;\n    },\n    // Attach x-request-id to an existing Response/NextResponse\n    attach: <T extends Response>(res: T): T => {\n      try { res.headers.set('x-request-id', log.requestId); } catch {}\n      return res;\n    },\n  };\n}\n","path":null,"size_bytes":2182,"size_tokens":null},"src/components/confirm-submit-button.tsx":{"content":"\"use client\";\n\nimport React from \"react\";\nimport { useFormStatus } from \"react-dom\";\nimport { cn } from \"@/lib/utils\";\n\ninterface ConfirmSubmitButtonProps\n  extends Omit<React.ButtonHTMLAttributes<HTMLButtonElement>, \"formAction\"> {\n  label: string;\n  pendingLabel?: string;\n  confirmMessage?: string;\n  variant?: \"primary\" | \"secondary\" | \"danger\";\n  // Allow Next.js server actions\n  formAction?: any;\n}\n\nexport default function ConfirmSubmitButton({\n  label,\n  pendingLabel = \"Processing...\",\n  confirmMessage = \"Are you sure?\",\n  variant = \"danger\",\n  className,\n  disabled,\n  type,\n  onClick,\n  ...rest\n}: ConfirmSubmitButtonProps) {\n  const { pending } = useFormStatus();\n\n  const base =\n    \"inline-flex items-center gap-2 justify-center rounded px-3 py-2 text-sm transition focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed\";\n  const variants: Record<string, string> = {\n    primary: \"bg-black text-white hover:bg-gray-800 focus:ring-black\",\n    secondary: \"bg-white text-gray-800 border hover:bg-gray-50 focus:ring-gray-400\",\n    danger:\n      \"bg-white text-red-600 border border-red-200 hover:bg-red-50 focus:ring-red-500\",\n  };\n\n  const handleClick = (e: React.MouseEvent<HTMLButtonElement>) => {\n    if (pending || disabled) return;\n    // If custom onClick provided, allow it to run first.\n    if (onClick) onClick(e);\n    if (e.defaultPrevented) return;\n    const ok = window.confirm(confirmMessage);\n    if (!ok) {\n      e.preventDefault();\n      e.stopPropagation();\n    }\n  };\n\n  return (\n    <button\n      type={type || \"submit\"}\n      aria-disabled={pending || disabled}\n      disabled={pending || disabled}\n      onClick={handleClick}\n      className={cn(base, variants[variant] || variants.danger, className)}\n      {...rest}\n    >\n      {pending && (\n        <span\n          className=\"inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\"\n          aria-hidden=\"true\"\n        />\n      )}\n      {pending ? pendingLabel : label}\n    </button>\n  );\n}\n","path":null,"size_bytes":2061,"size_tokens":null},"src/app/brand/packing-slip/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport default function PackingSlipRedirect() {\n  redirect(\"/brand/packing-slip.html\");\n}\n","path":null,"size_bytes":135,"size_tokens":null},"src/app/admin/orders/status-form.tsx":{"content":"\"use client\";\n\nimport { useFormState, useFormStatus } from \"react-dom\";\nimport { updateOrderStatus, type UpdateOrderState } from \"@/app/admin/orders/actions\";\nimport { Button } from \"@/components/ui/button\";\n\nconst initialState: UpdateOrderState = { error: null, success: false };\nconst statuses = [\"pending\", \"processing\", \"shipped\", \"delivered\", \"cancelled\", \"paid\"] as const;\n\nfunction Submit() {\n  const { pending } = useFormStatus();\n  return (\n    <Button type=\"submit\" size=\"sm\" disabled={pending} className=\"ml-2\">\n      {pending ? \"Saving...\" : \"Save\"}\n    </Button>\n  );\n}\n\nexport default function OrderStatusForm({ orderId, current }: { orderId: number; current: string }) {\n  const [state, formAction] = useFormState(updateOrderStatus, initialState);\n  return (\n    <form action={formAction} className=\"inline-flex items-center\">\n      <input type=\"hidden\" name=\"id\" value={orderId} />\n      <select\n        name=\"status\"\n        defaultValue={current}\n        className=\"rounded border px-2 py-1 text-sm\"\n        aria-label=\"Order status\"\n      >\n        {statuses.map((s) => (\n          <option key={s} value={s}>\n            {s}\n          </option>\n        ))}\n      </select>\n      <Submit />\n      {state?.error && <span className=\"ml-2 text-xs text-red-600\">{state.error}</span>}\n      {state?.success && <span className=\"ml-2 text-xs text-emerald-600\">Saved</span>}\n    </form>\n  );\n}\n","path":null,"size_bytes":1404,"size_tokens":null},"src/app/login/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport AuthForm from \"./auth-form\";\n\nexport const metadata = {\n  title: \"Sign In or Create Account\",\n};\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function LoginPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data } = await supabase.auth.getSession();\n\n  if (data?.session) {\n    redirect(\"/\");\n  }\n\n  return (\n    <div className=\"container flex min-h-[70vh] w-full flex-col items-center justify-center py-10\">\n      <div className=\"w-full max-w-md rounded-xl border bg-white p-8 shadow-sm\">\n        <AuthForm />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":786,"size_tokens":null},"src/app/cart/page.tsx":{"content":"import { getCart } from \"@/lib/cart-actions\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport Link from \"next/link\";\nimport CartItem from \"@/app/cart/cart-item\";\nimport CheckoutButton from \"./checkout-button\";\n\nexport const metadata = {\n  title: \"Shopping Cart\",\n};\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function CartPage() {\n  const cartItems = await getCart();\n\n  const subtotal = cartItems.reduce((acc, item) => {\n    if (item.product) {\n      const unit = (item.variant && item.variant.price !== null && item.variant.price !== undefined)\n        ? item.variant.price!\n        : item.product.price;\n      return acc + item.quantity * unit;\n    }\n    return acc;\n  }, 0);\n\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Shopping Cart</h1>\n      {cartItems.length === 0 ? (\n        <div className=\"mt-6 text-slate-600\">\n          Your cart is empty.{\" \"}\n          <Link href=\"/shop\" className=\"underline\">\n            Continue Shopping\n          </Link>\n        </div>\n      ) : (\n        <div className=\"mt-8 grid gap-8 lg:grid-cols-3\">\n          <div className=\"lg:col-span-2 space-y-4\">\n            {cartItems.map((item) => (\n              <CartItem key={item.id} item={item} />\n            ))}\n          </div>\n          <div className=\"rounded-xl border bg-white p-6 shadow-sm h-fit\">\n            <h2 className=\"text-lg font-semibold\">Order Summary</h2>\n            <div className=\"mt-3 flex justify-between text-sm text-slate-700\">\n              <span>Subtotal</span>\n              <span>{formatCurrency(subtotal)}</span>\n            </div>\n            <p className=\"mt-2 text-xs text-slate-500\">Free shipping on all products. Taxes calculated at checkout.</p>\n            <div className=\"mt-4\">\n              <CheckoutButton />\n            </div>\n            <div className=\"mt-4 text-xs text-slate-500\">Have a coupon? You can apply it at checkout.</div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":2025,"size_tokens":null},"src/app/data-deletion/page.tsx":{"content":"export const metadata = { title: \"Data Deletion | Shopixo\" };\n\nexport default function DataDeletionPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Data Deletion Policy</h1>\n      <p className=\"mt-4 text-slate-700\">\n        At <strong>Shopixo</strong>, we are committed to protecting your privacy. This document explains the methods\n        available to you to request deletion of your personal data associated with your account or purchases.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Data Deletion Methods</h2>\n      <ol className=\"list-decimal pl-6 mt-3 space-y-3 text-slate-700\">\n        <li>\n          Self-service account deletion: If you have a registered account with us, you can request deletion of your account\n          and all associated data from the security page in your account: <a className=\"text-primary underline\" href=\"/account/security\">/account/security</a>.\n        </li>\n        <li>\n          Via email: If you cannot log in or do not have an account, you can send a data deletion request to:\n          <a className=\"text-primary underline\" href=\"mailto:support@shopixo.com\">support@shopixo.com</a>\n          including the following information:\n          <ul className=\"list-disc pl-6 mt-2\">\n            <li>Full name.</li>\n            <li>Email address used for registration (if any).</li>\n            <li>Brief description of the data to be deleted.</li>\n          </ul>\n        </li>\n        <li>\n          You can also use our contact page: <a className=\"text-primary underline\" href=\"/contact\">/contact</a> to open a support ticket regarding data deletion.\n        </li>\n      </ol>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">What Gets Deleted?</h2>\n      <p className=\"mt-3 text-slate-700\">\n        Upon approval of your request, we will delete or anonymize personal data associated with your account,\n        which may include profile information, contact methods, and address history. We may retain certain financial,\n        tax, or fraud-related records as required by applicable legal obligations.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Request Processing Time</h2>\n      <p className=\"mt-3 text-slate-700\">\n        Data deletion requests are typically processed within 7 to 30 days after verifying the identity of the requester.\n        We will notify you when the process is complete.\n      </p>\n\n      <p className=\"mt-10 text-xs text-slate-500\">Last updated: September 14, 2025</p>\n    </div>\n  );\n}\n","path":null,"size_bytes":2548,"size_tokens":null},"playwright.prod.config.ts":{"content":"import { defineConfig, devices } from '@playwright/test';\n\nexport default defineConfig({\n  testDir: './e2e',\n  fullyParallel: true,\n  forbidOnly: !!process.env.CI,\n  retries: 0,\n  workers: process.env.CI ? 1 : undefined,\n  reporter: 'line',\n  use: {\n    baseURL: process.env.E2E_BASE_URL || 'https://shopixo.vercel.app',\n    trace: 'on-first-retry',\n  },\n  projects: [\n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n    },\n  ],\n  // No local webServer in prod testing; we hit the live site directly.\n});\n","path":null,"size_bytes":532,"size_tokens":null},"branding/suppliers/rfi-supplier-ar.md":{"content":"# طلب معلومات مورد (RFI) — Shopixo\n\nالهدف: اختيار موردين موثوقين بأسعار منخفضة وجودة عالية وتسليم سريع إلى السعودية، مع دعم الشحن الأعمى (Blind Shipping) تحت علامة Shopixo.\n\n## بيانات الشركة\n- الاسم القانوني للشركة:\n- الموقع الإلكتروني:\n- العنوان المسجل:\n- دولة التشغيل:\n- شهادة التسجيل (رابط/ملف):\n- سنوات الخبرة:\n- أهم العملاء أو المنصات التي تتعاملون معها:\n\n## القدرات والامتثال\n- هل تدعمون الشحن الأعمى؟ (نعم/لا)\n- هل يمكن إظهار اسم المرسل على الملصق: Shopixo؟ (نعم/لا)\n- تضمين قسيمة تغليف (Packing Slip) خاصة بنا (PDF/HTML)؟ (نعم/لا)\n- تضمين بطاقة شكر خاصة بنا داخل الطرد؟ (نعم/لا)\n- مواد براندينغ اختيارية (Polybag/Hangtag/Sticker) — الحد الأدنى للتصنيع (MOQ) والتكلفة:\n- آلية ضبط الجودة (مستوى AQL، صور قبل الشحن):\n- سياسة المرتجعات/العيوب وشروط التعويض:\n- تأكيد عدم وضع أي مواد تسويقية خاصة بالمورد داخل الطرد:\n\n## نطاق المنتجات والتسعير\n- الفئات المتوفرة (حدّد المناسب): أزياء (رجالي/نسائي/أطفال)، أحذية، إكسسوارات، حقائب، منزل ومطبخ، ألعاب، إلخ.\n- يرجى إرسال ملف تسعير عيّنة (CSV/XLS) يتضمن: SKU، الاسم، الوصف، الخامة، المتغيرات، التكلفة، وزن/أبعاد التغليف.\n- الحد الأدنى للطلب لكل SKU في طلبات الدروبشيب:\n- شرائح التسعير بحسب الحجم (100/500/1000+ قطعة):\n- شهادات للمنتجات الحسّاسة (منسوجات أطفال، ملحقات إلكترونيات) إن وجدت:\n- سياسة العينات (المدة والتكلفة):\n\n## الشحن إلى السعودية\n- شركات/خيارات الشحن المتاحة إلى KSA (DHL، Aramex، SF، بريد، Express):\n- زمن التوصيل المعتاد (باب لباب) إلى KSA:\n  - أزياء/أطفال: __–__ أيام\n  - أحذية: __–__ أيام\n  - إكسسوارات/أخرى: __–__ أيام\n- دعم كتابة العناوين بالعربية؟ (نعم/لا)\n- توفير أرقام تتبع + الصيغة (رابط/API):\n- التعامل مع ملصقات الدفع عند الاستلام (COD) لاحقاً إن لزم:\n\n## الأنظمة والتكامل\n- قنوات تغذية المنتجات: CSV / XML / API (المواصفات وتواتر التحديث)\n- وتيرة تحديث المخزون/الأسعار:\n- آلية إرسال الطلب: بوابة / بريد / API\n- Webhooks/تنبيهات عند الشحن/التسليم:\n- اتفاقية مستوى الخدمة (SLA) لوقت معالجة الطلب:\n\n## المدفوعات والشروط\n- طرق الدفع المقبولة (بطاقة، PayPal، حوالة):\n- العملة والتعامل مع فروقات الصرف:\n- آلية التعامل مع المنازعات/الاستردادات:\n- شروط ائتمانية إن وجدت:\n\n## طلب اختبار (إلزامي)\n- الموافقة على إرسال صور/فيديو قبل الشحن تظهر:\n  - ملصق الشحن مع اسم المرسل: Shopixo\n  - بطاقة الشكر + قسيمة التغليف داخل الطرد\n- زمن التسليم المتوقع لطلب الاختبار إلى KSA:\n\n---\nيرجى الرد بهذا النموذج مملوءاً مع ملف/ملفات الكتالوج والاتفاقية القياسية لديكم. البريد: support@shopixo.com\n","path":null,"size_bytes":3918,"size_tokens":null},"src/components/product-details-client.tsx":{"content":"\"use client\";\n\nimport { useState, useRef, useMemo, useEffect } from \"react\";\nimport { formatCurrency, cn } from \"@/lib/utils\";\nimport type { Product, ProductVariant } from \"@/lib/types\";\nimport AddToCart from \"@/components/add-to-cart\";\nimport SmartImage from \"@/components/smart-image\";\nimport { Heart, Star, ChevronUp, ChevronDown, X, Plus, Minus, Truck, Shield, RotateCcw } from \"lucide-react\";\nimport { computeBilledWeightKg, resolveDdpShippingSar } from \"@/lib/pricing\";\n\nfunction isLikelyImageUrl(s: string): boolean {\n  if (!s) return false;\n  if (s.startsWith('http://') || s.startsWith('https://')) return true;\n  if (s.startsWith('/')) return true;\n  if (s.startsWith('data:image/')) return true;\n  return false;\n}\n\nfunction isLikelyVideoUrl(s: string): boolean {\n  if (!s) return false;\n  const str = s.trim().toLowerCase();\n  if (str.startsWith('data:video/')) return true;\n  if (/(\\.mp4|\\.webm|\\.ogg|\\.m3u8)(\\?|#|$)/.test(str)) return true;\n  if (str.includes('res.cloudinary.com') && (str.includes('/video/upload/') || str.includes('/video/fetch/'))) return true;\n  if (str.startsWith('/storage/v1/object/public/') || /^\\/?[^:\\/]+\\/.+/.test(str)) {\n    return /(\\.mp4|\\.webm|\\.ogg|\\.m3u8)(\\?|#|$)/.test(str);\n  }\n  return false;\n}\n\nfunction buildSupabasePublicUrl(path: string): string {\n  const base = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  if (!base) return path;\n  const cleaned = path.replace(/^\\/+/, \"\");\n  return `${base.replace(/\\/$/, \"\")}/storage/v1/object/public/${cleaned}`;\n}\n\nfunction videoMimeFromUrl(url: string): string | undefined {\n  try {\n    const u = normalizeImageUrl(url).toLowerCase();\n    if (u.includes('.mp4')) return 'video/mp4';\n    if (u.includes('.webm')) return 'video/webm';\n    if (u.includes('.ogg')) return 'video/ogg';\n    if (u.includes('.m3u8')) return 'application/vnd.apple.mpegURL';\n  } catch {}\n  return undefined;\n}\n\nfunction transformVideo(url: string): string {\n  try {\n    url = normalizeImageUrl(url);\n    if (typeof url === 'string' && url.includes('res.cloudinary.com') && url.includes('/video/')) {\n      const isUpload = url.includes('/video/upload/');\n      const isFetch = url.includes('/video/fetch/');\n      const marker = isUpload ? '/video/upload/' : (isFetch ? '/video/fetch/' : null);\n      if (!marker) return url;\n      const idx = url.indexOf(marker);\n      const before = url.slice(0, idx + marker.length);\n      const after = url.slice(idx + marker.length);\n      const hasTransforms = after && !after.startsWith('v');\n      const inject = 'f_mp4,vc_h264/';\n      const core = hasTransforms ? after : (inject + after);\n      return (before + core).replace(/\\.(mp4|webm|ogg|m3u8)(\\?.*)?$/i, '.mp4');\n    }\n    const cloud = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;\n    const isHttp = typeof url === 'string' && /^https?:\\/\\//i.test(url);\n    const isMp4 = typeof url === 'string' && /\\.mp4(\\?|#|$)/i.test(url);\n    if (cloud && isHttp && !isMp4) {\n      return `https://res.cloudinary.com/${cloud}/video/fetch/f_mp4,vc_h264/${encodeURIComponent(url)}`;\n    }\n  } catch {}\n  return url;\n}\n\nfunction normalizeImageUrl(url: string): string {\n  try {\n    if (!url) return url;\n    if (url.startsWith('http://')) return 'https://' + url.slice('http://'.length);\n    if (url.startsWith('https://') || url.startsWith('data:')) return url;\n    if (url.startsWith('/storage/v1/object/public/')) {\n      const base = process.env.NEXT_PUBLIC_SUPABASE_URL || '';\n      return `${base.replace(/\\/$/, '')}${url}`;\n    }\n    if (/^\\/(?!storage\\/v1\\/object\\/public\\/)[^:\\/]+\\/.+/.test(url)) {\n      return buildSupabasePublicUrl(url.slice(1));\n    }\n    if (/^[^:\\/]+\\/.+/.test(url)) {\n      return buildSupabasePublicUrl(url);\n    }\n  } catch {}\n  return url;\n}\n\nfunction getCloudinaryVideoPoster(url: string): string | null {\n  try {\n    const u = normalizeImageUrl(url);\n    if (typeof u === 'string' && u.includes('res.cloudinary.com') && (u.includes('/video/upload/') || u.includes('/video/fetch/'))) {\n      const markerUpload = '/video/upload/';\n      const markerFetch = '/video/fetch/';\n      const marker = u.includes(markerUpload) ? markerUpload : (u.includes(markerFetch) ? markerFetch : null);\n      if (!marker) return null;\n      const idx = u.indexOf(marker);\n      if (idx === -1) return null;\n      const before = u.slice(0, idx + marker.length);\n      const after = u.slice(idx + marker.length);\n      const inject = 'so_0/';\n      const core = after.replace(/\\.(mp4|webm|ogg|m3u8)(\\?.*)?$/i, '');\n      return `${before}${inject}${core}.jpg`;\n    }\n  } catch {}\n  return null;\n}\n\nfunction transformImage(url: string): string {\n  try {\n    url = normalizeImageUrl(url);\n    if (typeof url === 'string' && url.includes('res.cloudinary.com') && url.includes('/image/')) {\n      const isUpload = url.includes('/image/upload/');\n      const isFetch = url.includes('/image/fetch/');\n      const marker = isUpload ? '/image/upload/' : (isFetch ? '/image/fetch/' : null);\n      if (!marker) return url;\n      const idx = url.indexOf(marker);\n      const after = url.slice(idx + marker.length);\n      const hasTransforms = after && !after.startsWith('v');\n      if (hasTransforms) return url;\n      const inject = 'f_auto,q_auto,c_fill,g_auto,w_800,h_800/';\n      return url.replace(marker, marker + inject);\n    }\n  } catch {}\n  return url;\n}\n\ninterface MediaGalleryProps {\n  images: string[];\n  title: string;\n  videoUrl?: string | null;\n  selectedColor?: string;\n}\n\nfunction MediaGallery({ images, title, videoUrl }: MediaGalleryProps) {\n  const media = (Array.isArray(images) ? images : [])\n    .map((s) => (typeof s === 'string' ? normalizeImageUrl(s) : s))\n    .filter((s) => typeof s === 'string') as string[];\n  \n  const items = (() => {\n    const arr = [...media];\n    if (videoUrl && typeof videoUrl === 'string' && videoUrl.trim()) arr.unshift(videoUrl.trim());\n    return arr.length > 0 ? arr : [\"/placeholder.svg\"];\n  })();\n\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const selected = items[selectedIndex] || items[0];\n  const thumbnailContainerRef = useRef<HTMLDivElement>(null);\n\n  const [zoomOpen, setZoomOpen] = useState(false);\n  const [scale, setScale] = useState(1);\n  const [tx, setTx] = useState(0);\n  const [ty, setTy] = useState(0);\n  const [dragging, setDragging] = useState(false);\n  const dragStart = useRef<{ x: number; y: number; tx: number; ty: number } | null>(null);\n\n  function openZoom() {\n    setScale(1); setTx(0); setTy(0); setZoomOpen(true);\n  }\n  function closeZoom() { setZoomOpen(false); }\n\n  function onWheel(e: React.WheelEvent) {\n    e.preventDefault();\n    const delta = e.deltaY < 0 ? 0.1 : -0.1;\n    setScale((s) => Math.min(4, Math.max(1, +(s + delta).toFixed(2))));\n  }\n\n  function onPointerDown(e: React.PointerEvent) {\n    (e.currentTarget as HTMLElement).setPointerCapture(e.pointerId);\n    setDragging(true);\n    dragStart.current = { x: e.clientX, y: e.clientY, tx, ty };\n  }\n\n  function onPointerMove(e: React.PointerEvent) {\n    if (!dragging || !dragStart.current) return;\n    const dx = e.clientX - dragStart.current.x;\n    const dy = e.clientY - dragStart.current.y;\n    setTx(dragStart.current.tx + dx);\n    setTy(dragStart.current.ty + dy);\n  }\n\n  function onPointerUp(e: React.PointerEvent) {\n    (e.currentTarget as HTMLElement).releasePointerCapture(e.pointerId);\n    setDragging(false);\n    dragStart.current = null;\n  }\n\n  const scrollThumbnails = (direction: 'up' | 'down') => {\n    if (thumbnailContainerRef.current) {\n      const scrollAmount = 80;\n      thumbnailContainerRef.current.scrollBy({\n        top: direction === 'up' ? -scrollAmount : scrollAmount,\n        behavior: 'smooth'\n      });\n    }\n  };\n\n  return (\n    <div className=\"flex gap-3 h-full\" dir=\"ltr\">\n      <div\n        className=\"relative flex-1 aspect-[3/4] md:aspect-square rounded-lg overflow-hidden bg-muted cursor-zoom-in\"\n        onClick={() => !isLikelyVideoUrl(selected) && openZoom()}\n        role={!isLikelyVideoUrl(selected) ? 'button' : undefined}\n        aria-label={!isLikelyVideoUrl(selected) ? 'Zoom image' : undefined}\n      >\n        {isLikelyVideoUrl(selected) ? (\n          <video\n            className=\"h-full w-full object-cover\"\n            controls\n            playsInline\n            preload=\"metadata\"\n            crossOrigin=\"anonymous\"\n            poster={getCloudinaryVideoPoster(selected) || undefined}\n          >\n            <source src={transformVideo(selected)} type={videoMimeFromUrl(selected)} />\n          </video>\n        ) : (\n          <SmartImage\n            src={transformImage(selected)}\n            alt={title}\n            fill\n            className=\"object-cover\"\n            loading=\"eager\"\n            onError={(e: any) => {\n              try {\n                const el = e.currentTarget as HTMLImageElement;\n                if (el && !el.src.endsWith('/placeholder.svg')) {\n                  el.src = '/placeholder.svg';\n                }\n              } catch {}\n            }}\n          />\n        )}\n      </div>\n\n      <div className=\"flex flex-col items-center gap-2 w-16 md:w-20 shrink-0\">\n        {items.length > 4 && (\n          <button\n            onClick={() => scrollThumbnails('up')}\n            className=\"w-full flex items-center justify-center py-1 text-muted-foreground hover:text-foreground transition-colors\"\n            aria-label=\"Scroll up\"\n          >\n            <ChevronUp className=\"w-5 h-5\" />\n          </button>\n        )}\n        \n        <div\n          ref={thumbnailContainerRef}\n          className=\"flex flex-col gap-2 overflow-y-auto scrollbar-hide max-h-[400px] md:max-h-[500px]\"\n          style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}\n        >\n          {items.map((item, index) => (\n            <button\n              key={index}\n              onClick={() => setSelectedIndex(index)}\n              className={cn(\n                \"relative w-14 h-14 md:w-16 md:h-16 rounded-md overflow-hidden border-2 transition-all shrink-0\",\n                selectedIndex === index \n                  ? \"border-primary ring-1 ring-primary\" \n                  : \"border-transparent hover:border-muted-foreground/30\"\n              )}\n            >\n              {isLikelyVideoUrl(item) ? (\n                <div className=\"w-full h-full bg-muted flex items-center justify-center\">\n                  <div className=\"w-0 h-0 border-l-[8px] border-l-foreground border-y-[5px] border-y-transparent\" />\n                </div>\n              ) : (\n                <SmartImage\n                  src={transformImage(item)}\n                  alt={`Image ${index + 1}`}\n                  fill\n                  className=\"object-cover\"\n                  loading=\"lazy\"\n                  onError={(e: any) => {\n                    try {\n                      const el = e.currentTarget as HTMLImageElement;\n                      if (el && !el.src.endsWith('/placeholder.svg')) {\n                        el.src = '/placeholder.svg';\n                      }\n                    } catch {}\n                  }}\n                />\n              )}\n            </button>\n          ))}\n        </div>\n\n        {items.length > 4 && (\n          <button\n            onClick={() => scrollThumbnails('down')}\n            className=\"w-full flex items-center justify-center py-1 text-muted-foreground hover:text-foreground transition-colors\"\n            aria-label=\"Scroll down\"\n          >\n            <ChevronDown className=\"w-5 h-5\" />\n          </button>\n        )}\n      </div>\n\n      {zoomOpen && !isLikelyVideoUrl(selected) && (\n        <div className=\"fixed inset-0 z-50\" aria-modal=\"true\" role=\"dialog\">\n          <div className=\"absolute inset-0 bg-black/80\" onClick={closeZoom} />\n          <button\n            aria-label=\"Close\"\n            onClick={closeZoom}\n            className=\"absolute top-4 right-4 z-10 rounded-full bg-white/90 p-2 hover:bg-white transition-colors\"\n          >\n            <X className=\"w-6 h-6\" />\n          </button>\n          <div className=\"absolute top-4 left-4 z-10 flex gap-2\">\n            <button onClick={() => setScale((s) => Math.min(4, +(s + 0.2).toFixed(2)))} className=\"rounded-full bg-white/90 p-2 hover:bg-white transition-colors\">\n              <Plus className=\"w-5 h-5\" />\n            </button>\n            <button onClick={() => setScale((s) => Math.max(1, +(s - 0.2).toFixed(2)))} className=\"rounded-full bg-white/90 p-2 hover:bg-white transition-colors\">\n              <Minus className=\"w-5 h-5\" />\n            </button>\n          </div>\n          <div\n            className=\"absolute inset-0 flex items-center justify-center touch-pan-y\"\n            onWheel={onWheel}\n            onPointerDown={onPointerDown}\n            onPointerMove={onPointerMove}\n            onPointerUp={onPointerUp}\n            onPointerCancel={onPointerUp}\n          >\n            {/* eslint-disable-next-line @next/next/no-img-element */}\n            <img\n              src={transformImage(selected)}\n              alt={title}\n              className=\"pointer-events-none select-none max-w-[90vw] max-h-[90vh]\"\n              style={{\n                transform: `translate(${tx}px, ${ty}px) scale(${scale})`,\n                transformOrigin: 'center center',\n              }}\n            />\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\ninterface DetailHeaderProps {\n  title: string;\n  productCode?: string | null;\n  rating: number;\n  reviewCount?: number;\n}\n\nfunction DetailHeader({ title, productCode, rating, reviewCount = 0 }: DetailHeaderProps) {\n  const displayRating = Math.min(5, Math.max(0, rating));\n  const fullStars = Math.floor(displayRating);\n  const hasHalfStar = displayRating % 1 >= 0.5;\n\n  return (\n    <div className=\"space-y-2\">\n      <h1 className=\"text-lg md:text-xl font-bold text-foreground leading-tight\">\n        {title}\n      </h1>\n      \n      {productCode && (\n        <p className=\"text-sm text-muted-foreground\">\n          Product Code: <span className=\"font-mono text-foreground\">{productCode}</span>\n        </p>\n      )}\n\n      <div className=\"flex items-center gap-2\">\n        <div className=\"flex items-center gap-0.5\">\n          {[...Array(5)].map((_, i) => (\n            <Star\n              key={i}\n              className={cn(\n                \"w-4 h-4\",\n                i < fullStars \n                  ? \"fill-amber-400 text-amber-400\" \n                  : i === fullStars && hasHalfStar\n                    ? \"fill-amber-400/50 text-amber-400\"\n                    : \"fill-muted text-muted\"\n              )}\n            />\n          ))}\n        </div>\n        <span className=\"text-sm text-muted-foreground\">\n          {reviewCount > 0 ? `${reviewCount.toLocaleString('en-US')}+ reviews` : 'No reviews yet'}\n        </span>\n      </div>\n    </div>\n  );\n}\n\ninterface PriceBlockProps {\n  price: number;\n  originalPrice?: number;\n  isAvailable: boolean;\n}\n\nfunction PriceBlock({ price, originalPrice, isAvailable }: PriceBlockProps) {\n  const hasDiscount = originalPrice && originalPrice > price;\n  const discountPercent = hasDiscount ? Math.round((1 - price / originalPrice) * 100) : 0;\n\n  return (\n    <div className=\"space-y-1\">\n      <div className=\"flex items-baseline gap-3 flex-wrap\">\n        <span className=\"text-xl md:text-2xl font-bold text-foreground\">\n          {formatCurrency(price)}\n        </span>\n        {hasDiscount && (\n          <>\n            <span className=\"text-base text-muted-foreground line-through\">\n              {formatCurrency(originalPrice)}\n            </span>\n            <span className=\"px-2 py-0.5 bg-red-100 text-red-700 text-sm font-medium rounded\">\n              -{discountPercent}%\n            </span>\n          </>\n        )}\n      </div>\n      <div className={cn(\n        \"text-sm font-medium\",\n        isAvailable ? \"text-green-600\" : \"text-red-600\"\n      )}>\n        {isAvailable ? 'In Stock' : 'Out of Stock'}\n      </div>\n    </div>\n  );\n}\n\ninterface ColorSelectorProps {\n  colors: string[];\n  selectedColor: string;\n  onColorChange: (color: string) => void;\n  colorImages?: Record<string, string>;\n  hotColors?: string[];\n}\n\nfunction ColorSelector({ colors, selectedColor, onColorChange, colorImages = {}, hotColors = [] }: ColorSelectorProps) {\n  if (colors.length === 0) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex items-center gap-2\">\n        <span className=\"text-sm font-medium text-foreground\">Color:</span>\n        <span className=\"text-sm text-muted-foreground\">{selectedColor}</span>\n      </div>\n      <div className=\"flex flex-wrap gap-2\">\n        {colors.map((color) => {\n          const isSelected = color === selectedColor;\n          const isHot = hotColors.includes(color);\n          const imageUrl = colorImages[color];\n\n          return (\n            <button\n              key={color}\n              onClick={() => onColorChange(color)}\n              className={cn(\n                \"relative w-12 h-12 md:w-14 md:h-14 rounded-md overflow-hidden border-2 transition-all\",\n                isSelected \n                  ? \"border-primary ring-2 ring-primary ring-offset-2\" \n                  : \"border-muted hover:border-muted-foreground/50\"\n              )}\n              title={color}\n            >\n              {imageUrl ? (\n                <SmartImage\n                  src={transformImage(imageUrl)}\n                  alt={color}\n                  fill\n                  className=\"object-cover\"\n                  loading=\"lazy\"\n                />\n              ) : (\n                <div className=\"w-full h-full bg-muted flex items-center justify-center text-xs text-muted-foreground\">\n                  {color.slice(0, 2)}\n                </div>\n              )}\n              {isHot && (\n                <span className=\"absolute -top-1 -right-1 px-1 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded\">\n                  HOT\n                </span>\n              )}\n            </button>\n          );\n        })}\n      </div>\n    </div>\n  );\n}\n\ninterface SizeSelectorProps {\n  sizes: string[];\n  selectedSize: string;\n  onSizeChange: (size: string) => void;\n  sizeStock?: Record<string, number>;\n}\n\nfunction SizeSelector({ sizes, selectedSize, onSizeChange, sizeStock = {} }: SizeSelectorProps) {\n  if (sizes.length === 0) return null;\n\n  return (\n    <div className=\"space-y-3\">\n      <div className=\"flex items-center gap-2\">\n        <span className=\"text-sm font-medium text-foreground\">Size:</span>\n        <span className=\"text-sm text-muted-foreground\">{selectedSize}</span>\n      </div>\n      <div className=\"flex flex-wrap gap-2\">\n        {sizes.map((size) => {\n          const isSelected = size === selectedSize;\n          const stock = sizeStock[size] ?? 0;\n          const isOutOfStock = stock <= 0;\n          const isLowStock = stock > 0 && stock <= 3;\n\n          return (\n            <button\n              key={size}\n              onClick={() => !isOutOfStock && onSizeChange(size)}\n              disabled={isOutOfStock}\n              className={cn(\n                \"relative min-w-[48px] px-4 py-2 rounded-md text-sm font-medium transition-all\",\n                isSelected\n                  ? \"bg-primary text-primary-foreground\"\n                  : isOutOfStock\n                    ? \"bg-muted text-muted-foreground cursor-not-allowed line-through\"\n                    : \"bg-card border border-border hover:border-primary text-foreground\"\n              )}\n            >\n              {size}\n              {isLowStock && !isSelected && (\n                <span className=\"absolute -top-1 -right-1 w-2 h-2 bg-amber-500 rounded-full\" />\n              )}\n            </button>\n          );\n        })}\n      </div>\n      {sizeStock[selectedSize] !== undefined && sizeStock[selectedSize] > 0 && sizeStock[selectedSize] <= 3 && (\n        <p className=\"text-sm text-amber-600\">\n          Only {sizeStock[selectedSize]} left!\n        </p>\n      )}\n    </div>\n  );\n}\n\ninterface ActionPanelProps {\n  productId: number;\n  productSlug: string;\n  selectedOptions: Record<string, string>;\n  disabled: boolean;\n  onWishlistToggle?: () => void;\n  isWishlisted?: boolean;\n}\n\nfunction ActionPanel({ productId, productSlug, selectedOptions, disabled, onWishlistToggle, isWishlisted = false }: ActionPanelProps) {\n  return (\n    <div className=\"flex gap-3\">\n      <div className=\"flex-1\">\n        <AddToCart \n          productId={productId} \n          productSlug={productSlug as any} \n          selectedOptions={selectedOptions} \n          disabled={disabled} \n        />\n      </div>\n      {onWishlistToggle && (\n        <button\n          onClick={onWishlistToggle}\n          className={cn(\n            \"w-12 h-12 flex items-center justify-center rounded-md border transition-colors\",\n            isWishlisted \n              ? \"bg-red-50 border-red-200 text-red-500\" \n              : \"bg-card border-border text-muted-foreground hover:text-red-500 hover:border-red-200\"\n          )}\n          aria-label={isWishlisted ? \"Remove from wishlist\" : \"Add to wishlist\"}\n        >\n          <Heart className={cn(\"w-5 h-5\", isWishlisted && \"fill-current\")} />\n        </button>\n      )}\n    </div>\n  );\n}\n\ninterface ShippingInfoProps {\n  cjPid?: string;\n  quote: { retailSar: number; shippingSar: number; options: any[] } | null;\n  quoteLoading: boolean;\n  selectedVariant: ProductVariant | null;\n  product: Product;\n}\n\nfunction ShippingInfo({ cjPid, quote, quoteLoading, selectedVariant, product }: ShippingInfoProps) {\n  const hasLiveQuote = cjPid && quote;\n  \n  const fallbackShipping = useMemo(() => {\n    if (!selectedVariant) return null;\n    const actualKg = typeof selectedVariant.weight_grams === 'number' && selectedVariant.weight_grams > 0 \n      ? selectedVariant.weight_grams / 1000 \n      : 0.4;\n    const L = typeof selectedVariant.length_cm === 'number' ? selectedVariant.length_cm : 30;\n    const W = typeof selectedVariant.width_cm === 'number' ? selectedVariant.width_cm : 25;\n    const H = typeof selectedVariant.height_cm === 'number' ? selectedVariant.height_cm : 5;\n    const billedKg = computeBilledWeightKg({ actualKg, lengthCm: L, widthCm: W, heightCm: H });\n    const ddp = resolveDdpShippingSar(billedKg);\n    return { ddp, total: (selectedVariant.price ?? product.price) + ddp };\n  }, [selectedVariant, product.price]);\n\n  return (\n    <div className=\"space-y-4 rounded-lg border bg-card p-4\">\n      <div className=\"grid grid-cols-3 gap-4 pb-3 border-b\">\n        <div className=\"flex flex-col items-center gap-1 text-center\">\n          <Truck className=\"w-5 h-5 text-muted-foreground\" />\n          <span className=\"text-xs text-muted-foreground\">Fast Shipping</span>\n        </div>\n        <div className=\"flex flex-col items-center gap-1 text-center\">\n          <Shield className=\"w-5 h-5 text-muted-foreground\" />\n          <span className=\"text-xs text-muted-foreground\">Secure Payment</span>\n        </div>\n        <div className=\"flex flex-col items-center gap-1 text-center\">\n          <RotateCcw className=\"w-5 h-5 text-muted-foreground\" />\n          <span className=\"text-xs text-muted-foreground\">Easy Returns</span>\n        </div>\n      </div>\n      \n      <div className=\"space-y-2 text-sm\">\n        <div className=\"font-medium\">Shipping & Delivery (Estimated)</div>\n        \n        {((product as any).origin_area || (product as any).origin_country_code) && (\n          <div className=\"text-xs text-muted-foreground\">\n            Ships from: {(product as any).origin_area || '-'}\n            {(product as any).origin_country_code ? `, ${(product as any).origin_country_code}` : ''}\n          </div>\n        )}\n        \n        {!selectedVariant && (\n          <p className=\"text-muted-foreground\">Select a size to view shipping and total.</p>\n        )}\n        \n        {selectedVariant && quoteLoading && (\n          <p className=\"text-muted-foreground\">Calculating shipping cost...</p>\n        )}\n        \n        {selectedVariant && !quoteLoading && hasLiveQuote && quote && (\n          <div className=\"space-y-2\">\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div>\n                <div className=\"text-muted-foreground\">Cheapest Shipping</div>\n                <div className=\"font-medium\">{formatCurrency(quote.shippingSar)}</div>\n              </div>\n              <div>\n                <div className=\"text-muted-foreground\">Delivery Price</div>\n                <div className=\"font-medium\">{formatCurrency(quote.retailSar)}</div>\n              </div>\n            </div>\n            {quote.options.length > 0 && (\n              <div>\n                <div className=\"text-muted-foreground mb-1\">Shipping Options</div>\n                <ul className=\"list-disc pr-5 text-xs space-y-1\">\n                  {quote.options.slice(0, 3).map((o: any, i: number) => {\n                    const rng = o.logisticAgingDays;\n                    const days = rng ? (rng.max ? `${rng.min || rng.max}-${rng.max} days` : `${rng.min} days`) : null;\n                    return (\n                      <li key={i}>{o.name || o.code}: {formatCurrency(Number(o.price || 0))}{days ? ` · ${days}` : ''}</li>\n                    );\n                  })}\n                </ul>\n              </div>\n            )}\n          </div>\n        )}\n        \n        {selectedVariant && !quoteLoading && !hasLiveQuote && fallbackShipping && (\n          <div className=\"grid grid-cols-2 gap-2\">\n            <div>\n              <div className=\"text-muted-foreground\">Shipping Fee (DDP)</div>\n              <div className=\"font-medium\">{formatCurrency(fallbackShipping.ddp)}</div>\n            </div>\n            <div>\n              <div className=\"text-muted-foreground\">Total</div>\n              <div className=\"font-medium\">{formatCurrency(fallbackShipping.total)}</div>\n            </div>\n          </div>\n        )}\n        \n        {selectedVariant && !quoteLoading && (\n          <div className=\"grid grid-cols-2 gap-2 pt-2 border-t\">\n            <div>\n              <div className=\"text-muted-foreground\">Processing Time</div>\n              <div className=\"text-foreground\">\n                {typeof (product as any).processing_time_hours === 'number' \n                  ? `${Math.max(1, Math.round((product as any).processing_time_hours / 24))}–${Math.max(1, Math.ceil(((product as any).processing_time_hours + 24) / 24))} days` \n                  : '—'}\n              </div>\n            </div>\n            <div>\n              <div className=\"text-muted-foreground\">Delivery Time</div>\n              <div className=\"text-foreground\">\n                {typeof (product as any).delivery_time_hours === 'number' \n                  ? `${Math.max(1, Math.round((product as any).delivery_time_hours / 24))}–${Math.max(1, Math.ceil(((product as any).delivery_time_hours + 24) / 24))} days` \n                  : '—'}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport default function ProductDetailsClient({ \n  product, \n  variantRows, \n  children \n}: { \n  product: Product; \n  variantRows?: ProductVariant[]; \n  children?: React.ReactNode;\n}) {\n  function splitColorSize(v: string): { color?: string; size?: string } {\n    if (!v) return {};\n    const parts = String(v).split('/').map(s => s.trim()).filter(Boolean);\n    if (parts.length >= 2) return { color: parts[0] || undefined, size: parts[1] || undefined };\n    const parts2 = String(v).split('-').map(s => s.trim()).filter(Boolean);\n    if (parts2.length >= 2) return { color: parts2[0] || undefined, size: parts2[1] || undefined };\n    return { size: v };\n  }\n\n  const hasRows = Array.isArray(variantRows) && variantRows.length > 0;\n  \n  const bothDims = useMemo(() => {\n    if (!hasRows) return false;\n    const withSep = (variantRows || []).filter(r => /\\s\\/\\s|\\s-\\s/.test(String(r.option_value)));\n    return withSep.length >= Math.max(1, Math.floor((variantRows || []).length * 0.6));\n  }, [hasRows, variantRows]);\n\n  const colorOptions = useMemo(() => {\n    if (!hasRows || !bothDims) return [] as string[];\n    const set = new Set<string>();\n    for (const r of variantRows!) {\n      const cs = splitColorSize(r.option_value || '');\n      if (cs.color) set.add(cs.color);\n    }\n    return Array.from(set);\n  }, [hasRows, bothDims, variantRows]);\n\n  const sizeOptionsByColor = useMemo(() => {\n    if (!hasRows || !bothDims) return {} as Record<string, string[]>;\n    const map: Record<string, Set<string>> = {};\n    for (const r of variantRows!) {\n      const cs = splitColorSize(r.option_value || '');\n      if (!cs.color || !cs.size) continue;\n      if (!map[cs.color]) map[cs.color] = new Set<string>();\n      map[cs.color].add(cs.size);\n    }\n    const out: Record<string, string[]> = {};\n    for (const k of Object.keys(map)) out[k] = Array.from(map[k]);\n    return out;\n  }, [hasRows, bothDims, variantRows]);\n\n  const singleDimOptions = useMemo(() => {\n    if (!hasRows || bothDims) return [] as string[];\n    return Array.from(new Set(variantRows!.map(v => v.option_value))).filter(Boolean);\n  }, [hasRows, bothDims, variantRows]);\n\n  const singleDimName = useMemo(() => {\n    if (!hasRows || bothDims) return 'Size';\n    return variantRows![0]?.option_name || 'Size';\n  }, [hasRows, bothDims, variantRows]);\n\n  const twoDimNames = useMemo(() => {\n    if (!hasRows || !bothDims) return { color: 'Color', size: 'Size' };\n    const first = variantRows![0];\n    const optName = first?.option_name || '';\n    if (optName.includes('/')) {\n      const parts = optName.split('/').map(s => s.trim());\n      return { color: parts[0] || 'Color', size: parts[1] || 'Size' };\n    }\n    if (optName.includes('-')) {\n      const parts = optName.split('-').map(s => s.trim());\n      return { color: parts[0] || 'Color', size: parts[1] || 'Size' };\n    }\n    return { color: 'Color', size: 'Size' };\n  }, [hasRows, bothDims, variantRows]);\n\n  const [selectedColor, setSelectedColor] = useState(() => colorOptions[0] || '');\n  const [selectedSize, setSelectedSize] = useState(() => {\n    if (bothDims && colorOptions[0]) {\n      return (sizeOptionsByColor[colorOptions[0]] || [])[0] || '';\n    }\n    return singleDimOptions[0] || '';\n  });\n\n  useEffect(() => {\n    if (selectedColor && sizeOptionsByColor[selectedColor]) {\n      const sizes = sizeOptionsByColor[selectedColor];\n      if (!sizes.includes(selectedSize)) {\n        setSelectedSize(sizes[0] || '');\n      }\n    }\n  }, [selectedColor, sizeOptionsByColor, selectedSize]);\n\n  const selectedOptions = useMemo(() => {\n    const opts: Record<string, string> = {};\n    if (bothDims) {\n      if (selectedColor) opts[twoDimNames.color] = selectedColor;\n      if (selectedSize) opts[twoDimNames.size] = selectedSize;\n    } else if (singleDimOptions.length > 0) {\n      opts[singleDimName] = selectedSize;\n    }\n    return opts;\n  }, [bothDims, selectedColor, selectedSize, singleDimOptions.length, singleDimName, twoDimNames]);\n\n  const selectedVariant = useMemo(() => {\n    if (!variantRows || variantRows.length === 0) return null;\n    if (bothDims) {\n      if (!selectedColor || !selectedSize) return null;\n      return variantRows.find(v => {\n        const cs = splitColorSize(v.option_value || '');\n        return cs.color === selectedColor && cs.size === selectedSize;\n      }) || null;\n    }\n    if (!selectedSize) return null;\n    return variantRows.find(v => v.option_value === selectedSize) || null;\n  }, [variantRows, selectedColor, selectedSize, bothDims]);\n\n  const sizeStockMap = useMemo(() => {\n    if (!variantRows) return {};\n    const map: Record<string, number> = {};\n    if (bothDims && selectedColor) {\n      for (const r of variantRows) {\n        const cs = splitColorSize(r.option_value || '');\n        if (cs.color === selectedColor && cs.size) {\n          map[cs.size] = r.stock ?? 0; // null stock treated as 0 for UI\n        }\n      }\n    } else {\n      for (const r of variantRows) {\n        map[r.option_value] = r.stock ?? 0; // null stock treated as 0 for UI\n      }\n    }\n    return map;\n  }, [variantRows, bothDims, selectedColor]);\n\n  const colorImageMap = useMemo(() => {\n    if (!variantRows || !bothDims) return {};\n    const map: Record<string, string> = {};\n    for (const color of colorOptions) {\n      const variant = variantRows.find(v => {\n        const cs = splitColorSize(v.option_value || '');\n        return cs.color === color;\n      });\n      if (variant) {\n        map[color] = product.images[0] || '';\n      }\n    }\n    return map;\n  }, [variantRows, bothDims, colorOptions, product.images]);\n\n  const currentSizes = bothDims \n    ? (sizeOptionsByColor[selectedColor] || [])\n    : singleDimOptions;\n\n  const cjPid = (product as any)?.cj_product_id as string | undefined;\n  const [quote, setQuote] = useState<{ retailSar: number; shippingSar: number; options: any[] } | null>(null);\n  const [quoteLoading, setQuoteLoading] = useState(false);\n\n  useEffect(() => {\n    let cancelled = false;\n    async function run() {\n      if (!cjPid || !selectedVariant?.cj_sku) { \n        setQuote(null); \n        setQuoteLoading(false);\n        return; \n      }\n      setQuoteLoading(true);\n      try {\n        const res = await fetch('/api/cj/pricing/quote', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ pid: cjPid, sku: selectedVariant.cj_sku, countryCode: 'SA', quantity: 1 }),\n          cache: 'no-store',\n        });\n        const j = await res.json();\n        if (cancelled) return;\n        if (res.ok && j && j.ok) setQuote({ retailSar: j.retailSar, shippingSar: j.shippingSar, options: j.options || [] });\n        else setQuote(null);\n      } catch {\n        if (!cancelled) setQuote(null);\n      } finally {\n        if (!cancelled) setQuoteLoading(false);\n      }\n    }\n    run();\n    return () => { cancelled = true; };\n  }, [cjPid, selectedVariant?.cj_sku]);\n\n  const isOutOfStock = (product.stock ?? 0) <= 0;\n  const variantOutOfStock = selectedVariant ? (selectedVariant.stock ?? 0) <= 0 : false;\n  const addToCartDisabled = isOutOfStock || (hasRows && (selectedVariant ? variantOutOfStock : true));\n\n  const currentPrice = selectedVariant?.price ?? product.price;\n\n  return (\n    <div className=\"w-full\">\n      <div className=\"flex flex-col lg:flex-row gap-6 lg:gap-10\">\n        <div className=\"w-full lg:w-[55%] xl:w-[60%]\">\n          <MediaGallery \n            images={product.images} \n            title={product.title}\n            videoUrl={(product as any).video_url}\n          />\n        </div>\n\n        <div className=\"w-full lg:w-[45%] xl:w-[40%] space-y-6\">\n          <DetailHeader\n            title={product.title}\n            productCode={product.product_code}\n            rating={product.rating}\n            reviewCount={0}\n          />\n\n          <PriceBlock\n            price={currentPrice}\n            isAvailable={!isOutOfStock && !variantOutOfStock}\n          />\n\n          {bothDims && colorOptions.length > 0 && (\n            <ColorSelector\n              colors={colorOptions}\n              selectedColor={selectedColor}\n              onColorChange={setSelectedColor}\n              colorImages={colorImageMap}\n              hotColors={colorOptions.slice(0, 2)}\n            />\n          )}\n\n          {currentSizes.length > 0 && (\n            <SizeSelector\n              sizes={currentSizes}\n              selectedSize={selectedSize}\n              onSizeChange={setSelectedSize}\n              sizeStock={sizeStockMap}\n            />\n          )}\n\n          <div className=\"hidden md:block\">\n            <ActionPanel\n              productId={product.id}\n              productSlug={product.slug}\n              selectedOptions={selectedOptions}\n              disabled={addToCartDisabled}\n            />\n          </div>\n\n          <ShippingInfo \n            cjPid={cjPid}\n            quote={quote}\n            quoteLoading={quoteLoading}\n            selectedVariant={selectedVariant}\n            product={product}\n          />\n\n          {product.description && (\n            <div className=\"space-y-2\">\n              <h3 className=\"text-sm font-medium text-foreground\">Product Description</h3>\n              <p className=\"text-sm text-muted-foreground leading-relaxed\">\n                {product.description}\n              </p>\n            </div>\n          )}\n\n          {children}\n        </div>\n      </div>\n\n      <div className=\"md:hidden fixed bottom-0 left-0 right-0 z-30 border-t bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 p-3 safe-area-inset-bottom\">\n        <div className=\"mx-auto flex max-w-md items-center gap-3\">\n          <div className=\"shrink-0\">\n            <div className=\"text-xs text-muted-foreground\">Price</div>\n            <div className=\"text-lg font-bold text-primary\">{formatCurrency(currentPrice)}</div>\n          </div>\n          <div className=\"flex-1\">\n            <AddToCart \n              productId={product.id} \n              productSlug={product.slug as any} \n              selectedOptions={selectedOptions} \n              disabled={addToCartDisabled} \n            />\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":37022,"size_tokens":null},"src/lib/supabase.ts":{"content":"\"use client\";\n\nimport { createPagesBrowserClient } from '@supabase/auth-helpers-nextjs';\n\n// Lazily initialize client on first use to avoid touching env at module import time.\nlet _client: ReturnType<typeof createPagesBrowserClient> | null = null;\nexport function getSupabaseBrowser() {\n  if (!_client) {\n    _client = createPagesBrowserClient();\n  }\n  return _client;\n}\n","path":null,"size_bytes":371,"size_tokens":null},"src/components/product-card.tsx":{"content":"import Link from \"next/link\";\nimport Ratings from \"@/components/ratings\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport type { Product } from \"@/lib/types\";\nimport SmartImage from \"@/components/smart-image\";\n\nfunction isLikelyImageUrl(s: string): boolean {\n  if (!s) return false;\n  const str = s.trim();\n  if (str.startsWith('data:image/')) return true;\n  // Accept any absolute http(s) URL – many CJ image URLs lack file extensions\n  if (/^https?:\\/\\//i.test(str)) return true;\n  const imageExt = /\\.(png|jpe?g|webp|gif|avif|svg)(\\?|#|$)/i;\n  // Accept both Cloudinary upload and fetch delivery types\n  if (str.includes('res.cloudinary.com') && str.includes('/image/')) return true;\n  if (str.startsWith('/storage/v1/object/public/')) return imageExt.test(str);\n  if (/^\\/?[^:\\/]+\\/.+/.test(str)) return imageExt.test(str); // bucket/path with image ext\n  return false;\n}\n\nfunction transformVideoForCard(url: string): string {\n  try {\n    url = normalizeImageUrl(url);\n    // Cloudinary native video: inject f_mp4,vc_h264 if missing transforms\n    if (typeof url === 'string' && url.includes('res.cloudinary.com') && url.includes('/video/')) {\n      const marker = url.includes('/video/upload/') ? '/video/upload/' : (url.includes('/video/fetch/') ? '/video/fetch/' : null);\n      if (!marker) return url;\n      const idx = url.indexOf(marker);\n      const before = url.slice(0, idx + marker.length);\n      const after = url.slice(idx + marker.length);\n      const hasTransforms = after && !after.startsWith('v');\n      const inject = 'f_mp4,vc_h264/';\n      const core = hasTransforms ? after : (inject + after);\n      return (before + core).replace(/\\.(mp4|webm|ogg|m3u8|mov)(\\?.*)?$/i, '.mp4');\n    }\n    // Non-Cloudinary: wrap with Cloudinary fetch to deliver MP4 universally when cloud is set\n    const cloud = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME as string | undefined;\n    const isHttp = typeof url === 'string' && /^https?:\\/\\//i.test(url);\n    if (cloud && isHttp) {\n      return `https://res.cloudinary.com/${cloud}/video/fetch/f_mp4,vc_h264/${encodeURIComponent(url)}`;\n    }\n  } catch {}\n  return url;\n}\nfunction isLikelyVideoUrl(s: string): boolean {\n  if (!s) return false;\n  const str = s.trim().toLowerCase();\n  if (str.startsWith('data:video/')) return true;\n  if (/(\\.mp4|\\.webm|\\.ogg|\\.m3u8|\\.mov)(\\?|#|$)/.test(str)) return true;\n  if (str.includes('res.cloudinary.com') && str.includes('/video/')) return true;\n  if (str.startsWith('/storage/v1/object/public/') || /^\\/?[^:\\/]+\\/.+/.test(str)) {\n    return /(\\.mp4|\\.webm|\\.ogg|\\.m3u8|\\.mov)(\\?|#|$)/.test(str);\n  }\n  return false;\n}\n\nfunction pickPrimaryImage(images: any): string | null {\n  try {\n    if (!images) return null;\n    if (Array.isArray(images)) {\n      const v = images.find((s) => typeof s === 'string' && isLikelyImageUrl(s.trim())) as string | undefined;\n      return v || null;\n    }\n    if (typeof images === 'string') {\n      const s = images.trim();\n      if (!s) return null;\n      if (s.startsWith('[') && s.endsWith(']')) {\n        const parsed = JSON.parse(s);\n        if (Array.isArray(parsed)) {\n          const v = parsed.find((x) => typeof x === 'string' && isLikelyImageUrl(x.trim()));\n          return (v as string) || null;\n        }\n      }\n      if (s.includes(',')) {\n        const v = s.split(',').map((x) => x.trim()).find((x) => isLikelyImageUrl(x));\n        return v || null;\n      }\n      return isLikelyImageUrl(s) ? s : null; // single value must look like URL\n    }\n  } catch {}\n  return null;\n}\n\nfunction pickPrimaryMedia(images: any): string | null {\n  // Returns first image; if none, returns first video. Accepts array/JSON/comma-separated/string.\n  try {\n    const tryParse = (raw: any): string[] => {\n      if (!raw) return [];\n      if (Array.isArray(raw)) return raw.filter((s) => typeof s === 'string');\n      if (typeof raw === 'string') {\n        const s = raw.trim();\n        if (!s) return [];\n        if (s.startsWith('[') && s.endsWith(']')) {\n          try { const arr = JSON.parse(s); return Array.isArray(arr) ? arr.filter((x: any) => typeof x === 'string') : []; } catch { return []; }\n        }\n        if (s.includes(',')) return s.split(',').map((x) => x.trim()).filter(Boolean);\n        return [s];\n      }\n      return [];\n    };\n    const arr = tryParse(images);\n    const img = arr.find((u) => isLikelyImageUrl(u));\n    if (img) return img;\n    const vid = arr.find((u) => isLikelyVideoUrl(u));\n    return vid || null;\n  } catch {}\n  return null;\n}\n\nfunction buildSupabasePublicUrl(path: string): string {\n  const base = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  if (!base) return path;\n  const cleaned = path.replace(/^\\/+/, \"\");\n  return `${base.replace(/\\/$/, \"\")}/storage/v1/object/public/${cleaned}`;\n}\n\nfunction normalizeImageUrl(url: string): string {\n  try {\n    if (!url) return url;\n    if (url.startsWith('http://')) return 'https://' + url.slice('http://'.length);\n    if (url.startsWith('https://') || url.startsWith('data:')) return url;\n    // '/storage/v1/object/public/...' -> prefix Supabase base URL\n    if (url.startsWith('/storage/v1/object/public/')) {\n      const base = process.env.NEXT_PUBLIC_SUPABASE_URL || '';\n      return `${base.replace(/\\/$/, '')}${url}`;\n    }\n    // '/bucket/dir/file.jpg' -> treat as Supabase public bucket path\n    if (/^\\/(?!storage\\/v1\\/object\\/public\\/)[^:\\/]+\\/.+/.test(url)) {\n      return buildSupabasePublicUrl(url.slice(1));\n    }\n    // Already handled: absolute http(s), data URLs. For relative without leading '/', try Supabase bucket form\n    // Treat plain 'bucket/dir/file.jpg' as Supabase public storage object\n    if (/^[^:\\/]+\\/.+/.test(url)) {\n      return buildSupabasePublicUrl(url);\n    }\n  } catch {}\n  return url;\n}\n\nfunction transformCardImage(url: string): string {\n  try {\n    url = normalizeImageUrl(url);\n    // Video -> choose a poster\n    if (isLikelyVideoUrl(url)) {\n      // If it's a Cloudinary video, derive a poster from first frame\n      if (url.includes('res.cloudinary.com') && url.includes('/video/')) {\n        const marker = url.includes('/video/upload/') ? '/video/upload/' : (url.includes('/video/fetch/') ? '/video/fetch/' : null);\n        if (!marker) return '/placeholder.svg';\n        const idx = url.indexOf(marker);\n        if (idx !== -1) {\n          const before = url.slice(0, idx + marker.length);\n          const after = url.slice(idx + marker.length);\n          const inject = 'so_0/';\n          const core = after.replace(/\\.(mp4|webm|ogg|m3u8|mov)(\\?.*)?$/i, '');\n          return `${before}${inject}${core}.jpg`;\n        }\n      }\n      // Non-Cloudinary video: if Cloudinary cloud is available, use fetch to generate first-frame jpg\n      const cloud = (process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME || process.env.CLOUDINARY_CLOUD_NAME) as string | undefined;\n      if (cloud) {\n        const abs = url; // url is normalized above; should be absolute for supabase paths\n        if (/^https?:\\/\\//i.test(abs)) {\n          return `https://res.cloudinary.com/${cloud}/video/fetch/so_0/${encodeURIComponent(abs)}.jpg`;\n        }\n      }\n      return '/placeholder.svg';\n    }\n    if (typeof url === 'string' && url.includes('res.cloudinary.com') && url.includes('/image/')) {\n      const isUpload = url.includes('/image/upload/');\n      const isFetch = url.includes('/image/fetch/');\n      const marker = isUpload ? '/image/upload/' : (isFetch ? '/image/fetch/' : null);\n      if (!marker) return url;\n      const idx = url.indexOf(marker);\n      const after = url.slice(idx + marker.length);\n      const hasTransforms = after && !after.startsWith('v');\n      if (hasTransforms) return url;\n      // 4:3 aspect for grid thumbnails\n      const inject = 'f_auto,q_auto,c_fill,g_auto,w_640,h_480/';\n      return url.replace(marker, marker + inject);\n    }\n  } catch {}\n  return url || '/placeholder.svg';\n}\n\nfunction getImageField(p: any): any {\n  return typeof p?.images !== 'undefined' && p?.images !== null && p?.images !== ''\n    ? p.images\n    : p?.image ?? null;\n}\n\nexport default function ProductCard({ product }: { product: Product }) {\n  return (\n    <Link\n      href={`/product/${product.slug || (product.id as any)}`}\n      className=\"group block rounded-[var(--radius-lg)] border bg-card p-5 shadow-soft transition will-change-transform hover:-translate-y-[6px] hover:shadow-soft\"\n    >\n      <div className=\"relative mb-3 aspect-[4/3] w-full overflow-hidden rounded-image bg-slate-100\">\n        {(() => {\n          const media = pickPrimaryMedia(getImageField(product as any)) || \"/placeholder.svg\";\n          const normalized = normalizeImageUrl(media);\n          const thumb = transformCardImage(normalized);\n          return (\n            <SmartImage\n              src={thumb}\n              alt={`Product image: ${product.title}`}\n              loading=\"lazy\"\n              className=\"h-full w-full object-cover transition-transform duration-200 ease-out group-hover:scale-[1.03]\"\n              fill\n            />\n          );\n        })()}\n      </div>\n      <div className=\"flex items-center justify-between gap-2\">\n        <h3 className=\"truncate text-base font-semibold text-foreground\" title={product.title}>{product.title}</h3>\n        <div className=\"text-lg font-bold text-foreground\">{formatCurrency(product.price)}</div>\n      </div>\n      <div className=\"mt-1 text-sm text-muted-foreground\">{product.category}</div>\n      <div className=\"mt-2\"><Ratings value={product.rating} /></div>\n    </Link>\n  );\n}\n","path":null,"size_bytes":9497,"size_tokens":null},"src/components/header.tsx":{"content":"import Link from \"next/link\";\nimport Logo from \"@/components/logo\";\nimport UserNav from \"./user-nav\";\nimport SearchBar from \"./search-bar\";\nimport CartBadge from \"./cart-badge\";\nimport { Suspense } from \"react\";\nimport { ThemeToggle } from \"./theme-toggle\";\nimport { Button } from \"@/components/ui/button\";\nimport CategoriesMenu from \"@/components/categories-menu\";\n\n// Trigger new deployment\nexport default function Header() {\n  const name = process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\";\n  return (\n    <header className=\"sticky top-0 z-40 w-full border-b bg-background\">\n      <div className=\"container flex h-16 items-center overflow-hidden\">\n        {/* Left: Logo (desktop/tablet only) */}\n        <div className=\"hidden md:flex items-center gap-2\">\n          {/* Logo component already renders a Link to home */}\n          <Logo />\n          {/* Desktop: open categories menu */}\n          <CategoriesMenu />\n        </div>\n\n        {/* Center: Search Bar (desktop/tablet) */}\n        <div className=\"hidden flex-1 justify-center px-4 sm:px-8 lg:flex lg:px-16\">\n          <Suspense fallback={null}>\n            <SearchBar />\n          </Suspense>\n        </div>\n\n        {/* Mobile: exact layout — right brand text, center search pill, left 3 icons */}\n        <div className=\"grid w-full grid-cols-[auto_minmax(0,_1fr)_auto] items-center gap-2 md:hidden\">\n          {/* Right (start in RTL): brand text only */}\n          <div className=\"justify-self-start min-w-0\">\n            <Link href=\"/\" className=\"block truncate text-2xl md:text-3xl leading-none font-semibold tracking-tight\">{name}</Link>\n          </div>\n          {/* Center: search pill (placeholder like Temu) */}\n          <div className=\"justify-self-center w-full flex items-center justify-center\">\n            <Link\n              href=\"/search\"\n              aria-label=\"Search products\"\n              className=\"inline-flex w-[230px] items-center gap-2 rounded-full bg-muted px-8 py-2.5 text-[16px] text-muted-foreground\"\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"currentColor\" className=\"h-5 w-5\">\n                <path fillRule=\"evenodd\" d=\"M10 3.75a6.25 6.25 0 104.76 10.41l3.54 3.54a.75.75 0 101.06-1.06l-3.54-3.54A6.25 6.25 0 0010 3.75zm-4.75 6.25a4.75 4.75 0 119.5 0 4.75 4.75 0 01-9.5 0z\" clipRule=\"evenodd\" />\n              </svg>\n              <span>Search</span>\n            </Link>\n          </div>\n          {/* Left (end in RTL): three icons — cart, user, menu */}\n          <div className=\"justify-self-end flex items-center gap-2\">\n            <CartBadge />\n            <UserNav />\n            <CategoriesMenu />\n          </div>\n        </div>\n\n        {/* Right: CTA + Icons (desktop/tablet only) */}\n        <div className=\"ml-auto hidden md:flex items-center gap-2 sm:gap-4 flex-wrap overflow-hidden\">\n          {/* Desktop CTA */}\n          <Link href=\"/shop\" className=\"hidden md:inline-flex\">\n            <Button variant=\"cta\" size=\"default\" aria-label=\"Shop Now\">\n              Shop Now\n            </Button>\n          </Link>\n          {/* Mobile menu is handled inside the left group above via <CategoriesMenu /> */}\n          <div className=\"hidden md:block\">\n            <ThemeToggle />\n          </div>\n          <UserNav />\n          <CartBadge />\n        </div>\n      </div>\n      {/* No separate mobile pill row; pill is integrated above */}\n    </header>\n  );\n}\n","path":null,"size_bytes":3428,"size_tokens":null},"src/app/api/admin/import-products/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { productSchema } from '@/lib/schemas/product';\nimport { calculateRetailSar, usdToSar, computeVolumetricWeightKg, detectPricingAnomalies } from '@/lib/pricing';\nimport { slugify } from '@/lib/utils/slug';\nimport { generateTitle, generateDescription, translateAr } from '@/lib/ai/enrich';\nimport { mapCategory } from '@/lib/ai/category-map';\nimport { hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { isKillSwitchOn } from '@/lib/settings';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { getSupabaseAdmin } from '@/app/admin/products/actions';\n\nexport const runtime = 'nodejs';\n\ntype ImportItem = {\n  name: string;\n  supplierCost: number;        // numeric in SAR or USD (see currency)\n  currency?: 'SAR' | 'USD';\n  lengthCm?: number;\n  widthCm?: number;\n  heightCm?: number;\n  weightKg?: number;\n  imagesCsv?: string;          // comma-separated URLs (required by schema)\n  videoUrl?: string;           // optional single video URL if available from CJ\n  category?: string;           // optional\n  stock?: number;              // default 100\n  margin?: number;             // default 0.35\n};\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req);\n  // Require admin user via centralized guard\n  {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ error: 'Not authorized' }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n  }\n\n  const supabase = await getSupabaseAdmin();\n  if (!supabase) {\n    const r = NextResponse.json({ error: 'Server misconfiguration: missing Supabase envs' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  // Global kill-switch enforcement: block write operations\n  if (await isKillSwitchOn()) {\n    const r = NextResponse.json({ error: 'Kill switch is ON. Import is temporarily disabled.' }, { status: 423 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  // Probe optional columns once (e.g., products.video_url) using centralized db-features\n  const hasVideoColumn = await hasColumn('products', 'video_url');\n\n  let body: { items: ImportItem[]; preview?: boolean; draftOnAnomalies?: boolean };\n  try { body = await req.json(); } catch {\n    const r = NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const items = Array.isArray(body.items) ? body.items : [];\n  const preview = !!body.preview;\n  const draftOnAnomalies = !!body.draftOnAnomalies;\n  if (items.length === 0) {\n    const r = NextResponse.json({ error: 'No items provided' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const results: any[] = [];\n  const toInsert: any[] = [];\n\n  for (const it of items) {\n    const currency = it.currency || 'SAR';\n    const supplierSar = currency === 'USD' ? usdToSar(it.supplierCost) : it.supplierCost;\n    const lengthCm = it.lengthCm ?? 25;\n    const widthCm = it.widthCm ?? 20;\n    const heightCm = it.heightCm ?? 3;\n    const weightKg = it.weightKg ?? 0.4;\n\n    const retailCalc = calculateRetailSar(supplierSar, {\n      actualKg: weightKg,\n      lengthCm,\n      widthCm,\n      heightCm,\n    }, { margin: it.margin ?? 0.35 });\n    const volumetricKg = computeVolumetricWeightKg({ actualKg: weightKg, lengthCm, widthCm, heightCm });\n    const anomalies = detectPricingAnomalies({\n      actualKg: weightKg,\n      volumetricKg,\n      billedKg: retailCalc.billedWeightKg,\n      ddpShippingSar: retailCalc.ddpShippingSar,\n      landedCostSar: retailCalc.landedCostSar,\n      retailSar: retailCalc.retailSar,\n    });\n\n    let title = it.name?.trim() || 'Untitled Product';\n    // AI enrichment (optional)\n    try {\n      title = await generateTitle(title);\n    } catch {}\n    const slug = slugify(title);\n    // Require real product media; do NOT fallback to placeholder\n    if (!it.imagesCsv || it.imagesCsv.trim().length === 0) {\n      results.push({\n        title,\n        ok: false,\n        errors: { images: ['Images are required. Provide at least one image URL from your source (e.g., CJ).'] },\n      });\n      continue;\n    }\n    const images = it.imagesCsv;\n    let desc = `${title} — auto-imported. Landed SAR: ${retailCalc.landedCostSar}.`;\n    try {\n      const gen = await generateDescription(title);\n      if (gen) desc = gen;\n    } catch {}\n    let descAr = '';\n    try { descAr = await translateAr(desc); } catch {}\n\n    // Category mapping with confidence; honor provided category when present\n    let finalCategory = (it.category && it.category.trim().length > 0) ? it.category.trim() : '';\n    if (!finalCategory || finalCategory.toLowerCase() === 'general') {\n      const mapped = mapCategory({ cjCategory: it.category, title, description: desc });\n      finalCategory = mapped.category;\n    }\n\n    const formLike = {\n      title,\n      slug,\n      description: desc,\n      price: retailCalc.retailSar,\n      stock: it.stock ?? 100,\n      category: finalCategory || 'General',\n      images,\n      ...(draftOnAnomalies && anomalies.length > 0 ? { is_active: false } : {}),\n    } as Record<string, any>;\n\n    const validated = productSchema.safeParse(formLike);\n    if (!validated.success) {\n      results.push({ title, ok: false, errors: validated.error.flatten().fieldErrors });\n      continue;\n    }\n\n    // Include optional video_url in insertion only if the DB column exists\n    const insertRow = hasVideoColumn && it.videoUrl\n      ? { ...validated.data, video_url: it.videoUrl }\n      : validated.data;\n    toInsert.push(insertRow);\n    results.push({\n      title,\n      slug,\n      ok: true,\n      pricing: retailCalc,\n      volumetricKg,\n      anomalies,\n      category: finalCategory || 'General',\n      description: desc,\n      description_ar: descAr,\n      images: images.split(',').map((s) => s.trim()).filter(Boolean),\n      ...(it.videoUrl ? { videoUrl: it.videoUrl } : {}),\n    });\n  }\n\n  if (!preview && toInsert.length > 0) {\n    const { error } = await supabase.from('products').insert(toInsert);\n    if (error) {\n      const r = NextResponse.json({ error: error.message, results }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n  }\n\n  const r = NextResponse.json({ inserted: preview ? 0 : toInsert.length, preview, results });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":6537,"size_tokens":null},"jest.setup.ts":{"content":"// Optional: configure or set up a testing framework before each test.\n// If you delete this file, remove `setupFilesAfterEnv` from `jest.config.js`\n\n// Used for __tests__/testing-library.js\n// Learn more: https://github.com/testing-library/jest-dom\nimport '@testing-library/jest-dom'\n\n// Mock next/link to a standard anchor for unit tests\nimport React from 'react';\njest.mock('next/link', () => {\n  return {\n    __esModule: true,\n    default: ({ href, children, ...rest }: any) => React.createElement('a', { href, ...rest }, children),\n  };\n});\n\n// Mock next/image to a standard img for unit tests\njest.mock('next/image', () => {\n  return {\n    __esModule: true,\n    default: (props: any) => {\n      const { fill, priority, quality, ...rest } = props || {};\n      return React.createElement('img', { ...rest });\n    },\n  };\n});\n\n// Radix UI dropdowns render their content in a Portal by default.\n// Mock Portal to render children inline for jsdom tests.\njest.mock('@radix-ui/react-portal', () => {\n  return {\n    __esModule: true,\n    Root: ({ children }: any) => children,\n  };\n});\n\n// Mock our Radix UI dropdown wrappers to simplify interactions in tests\njest.mock('@/components/ui/dropdown-menu', () => {\n  const React = require('react');\n  return {\n    __esModule: true,\n    DropdownMenu: ({ children }: any) => React.createElement(React.Fragment, null, children),\n    DropdownMenuTrigger: ({ asChild, children }: any) => {\n      // pass through without portals/complex logic\n      return React.cloneElement(children, {});\n    },\n    DropdownMenuContent: ({ children }: any) => React.createElement('div', { role: 'menu' }, children),\n    DropdownMenuItem: ({ children, onClick }: any) => React.createElement('div', { role: 'menuitem', onClick }, children),\n  };\n});\n","path":null,"size_bytes":1771,"size_tokens":null},"src/components/loading-spinner.tsx":{"content":"export default function LoadingSpinner({ text = \"Loading...\" }: { text?: string }) {\n  return (\n    <div className=\"flex flex-col items-center justify-center h-full p-8\">\n      <div className=\"w-16 h-16 border-4 border-blue-500 border-dashed rounded-full animate-spin\"></div>\n      <p className=\"mt-4 text-lg text-gray-600\">{text}</p>\n    </div>\n  );\n}\n","path":null,"size_bytes":353,"size_tokens":null},"src/app/account/page.tsx":{"content":"import Link from \"next/link\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport type { Order } from \"@/lib/types\";\n\nexport const metadata = { title: \"Account\" };\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function AccountPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    redirect(\"/login?redirect=/account\");\n  }\n\n  const { data: orders } = await supabase\n    .from(\"orders\")\n    .select(\"id,created_at,total_amount,status\")\n    .eq(\"user_id\", user.id)\n    .order(\"created_at\", { ascending: false });\n\n  const allOrders = (orders || []) as Order[];\n  const counts = allOrders.reduce(\n    (acc, o) => {\n      acc.all += 1;\n      acc[o.status as keyof typeof acc] = (acc[o.status as keyof typeof acc] || 0) + 1;\n      return acc;\n    },\n    { all: 0, paid: 0, processing: 0, shipped: 0, delivered: 0, returned: 0 } as Record<string, number>\n  );\n\n  const lastOrder = allOrders[0];\n\n  const tiles: { href: any; label: string; value: number }[] = [\n    { href: { pathname: \"/account/orders\" }, label: \"All Orders\", value: counts.all },\n    { href: { pathname: \"/account/orders\", query: { status: \"paid\" } }, label: \"Paid\", value: counts.paid || 0 },\n    { href: { pathname: \"/account/orders\", query: { status: \"processing\" } }, label: \"Processing\", value: counts.processing || 0 },\n    { href: { pathname: \"/account/orders\", query: { status: \"shipped\" } }, label: \"Shipped\", value: counts.shipped || 0 },\n    { href: { pathname: \"/account/orders\", query: { status: \"delivered\" } }, label: \"Delivered\", value: counts.delivered || 0 },\n    { href: { pathname: \"/account/orders\", query: { status: \"returned\" } }, label: \"Returned\", value: counts.returned || 0 },\n  ];\n\n  return (\n    <div className=\"py-10\">\n      <h1 className=\"text-3xl font-bold mb-2\">Account Overview</h1>\n      <p className=\"text-slate-600 mb-6\">Welcome back! Manage your orders and settings.</p>\n\n      <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 mb-8\">\n        {tiles.map((t) => (\n          <Link key={t.label} href={t.href} className=\"rounded-xl border bg-white p-5 hover:shadow-sm transition\">\n            <div className=\"text-sm text-gray-500\">{t.label}</div>\n            <div className=\"text-2xl font-bold\">{t.value}</div>\n          </Link>\n        ))}\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n        <div className=\"rounded-xl border bg-white p-6\">\n          <h3 className=\"text-lg font-semibold mb-1\">Signed In</h3>\n          <p className=\"text-slate-700\">{user.email}</p>\n        </div>\n\n        <div className=\"rounded-xl border bg-white p-6\">\n          <h3 className=\"text-lg font-semibold mb-3\">Last Order</h3>\n          {lastOrder ? (\n            <div className=\"space-y-1\">\n              <p className=\"text-sm text-gray-600\">Order #{lastOrder.id}</p>\n              <p className=\"text-sm text-gray-600\">{format(new Date(lastOrder.created_at), \"MMMM d, yyyy\")}</p>\n              <p className=\"font-medium\">{formatCurrency(lastOrder.total_amount)}</p>\n              <Link className=\"text-sm text-blue-600 hover:underline\" href={{ pathname: \"/account/orders\", query: { status: lastOrder.status } }}>View similar orders</Link>\n            </div>\n          ) : (\n            <p className=\"text-gray-600\">No orders yet.</p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3648,"size_tokens":null},"src/lib/auth/admin-guard.ts":{"content":"import { cookies } from 'next/headers';\nimport { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';\n\nexport type AdminGuard = { ok: true; user: any } | { ok: false; reason: string };\n\nexport async function ensureAdmin(): Promise<AdminGuard> {\n  try {\n    const supabaseAuth = createRouteHandlerClient({ cookies });\n    const { data: { user } } = await supabaseAuth.auth.getUser();\n    if (!user) return { ok: false, reason: 'Not authenticated' };\n\n    const email = String(user.email || '').toLowerCase();\n    const allowEmails = (process.env.ADMIN_EMAILS || '')\n      .split(',')\n      .map((s) => s.trim().toLowerCase())\n      .filter(Boolean);\n    const allowDomains = (process.env.ADMIN_EMAIL_DOMAINS || '')\n      .split(',')\n      .map((s) => s.trim().toLowerCase().replace(/^@/, ''))\n      .filter(Boolean);\n\n    // If no explicit allow lists are configured:\n    // - In development: allow any authenticated user (for local testing)\n    // - In production: deny access (security requirement - must configure ADMIN_EMAILS or ADMIN_EMAIL_DOMAINS)\n    if (allowEmails.length === 0 && allowDomains.length === 0) {\n      if (process.env.NODE_ENV === 'production') {\n        return { ok: false, reason: 'Admin access not configured. Set ADMIN_EMAILS or ADMIN_EMAIL_DOMAINS.' };\n      }\n      return { ok: true, user };\n    }\n\n    const appMeta = (user as any).app_metadata || {};\n    const userMeta = (user as any).user_metadata || {};\n    const roles = new Set<string>([\n      ...((Array.isArray(appMeta.roles) ? appMeta.roles : []) as string[]),\n      ...((Array.isArray(userMeta.roles) ? userMeta.roles : []) as string[]),\n      String(appMeta.role || '').toLowerCase(),\n      String(userMeta.role || '').toLowerCase(),\n    ].filter(Boolean));\n\n    const isAdminFlag = Boolean(appMeta.is_admin || userMeta.is_admin);\n\n    const emailAllowed = allowEmails.length > 0 ? allowEmails.includes(email) : false;\n    const domainAllowed = allowDomains.length > 0 && email.includes('@')\n      ? allowDomains.includes(email.split('@')[1])\n      : false;\n    const roleAllowed = roles.has('admin');\n\n    if (!(emailAllowed || domainAllowed || roleAllowed || isAdminFlag)) {\n      return { ok: false, reason: 'Not authorized' };\n    }\n\n    return { ok: true, user };\n  } catch (e: any) {\n    return { ok: false, reason: e?.message || 'Auth error' };\n  }\n}\n","path":null,"size_bytes":2361,"size_tokens":null},"src/lib/utils/slug.ts":{"content":"export function slugify(input: string): string {\n  return input\n    .normalize('NFKD')\n    .replace(/[\\u0300-\\u036f]/g, '') // strip diacritics\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9]+/g, '-') // non-alphanumeric to dash\n    .replace(/-{2,}/g, '-') // collapse multiple dashes\n    .replace(/^-+|-+$/g, ''); // trim leading/trailing dashes\n}\n","path":null,"size_bytes":356,"size_tokens":null},"src/app/checkout/page.tsx":{"content":"export const metadata = { title: \"Checkout\" };\n\nexport default function CheckoutPage() {\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Checkout</h1>\n      <p className=\"mt-2 text-slate-600\">To complete your secure payment, go to your cart and click the checkout button.</p>\n      <div className=\"mt-6\">\n        <a href=\"/cart\" className=\"btn-primary inline-block\">Go to Cart</a>\n        <p className=\"mt-3 text-sm text-slate-600\">You will be redirected to secure payment.</p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":551,"size_tokens":null},"src/components/categories-bar.tsx":{"content":"\"use client\";\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport Link from \"next/link\";\nimport { CATEGORIES } from \"@/lib/categories\";\nimport { usePathname } from \"next/navigation\";\nimport { ChevronRight, ChevronLeft } from \"lucide-react\";\n\nexport default function CategoriesBar() {\n  const pathname = usePathname();\n  const activeSlug = useMemo(() => {\n    if (!pathname) return null;\n    const m = pathname.match(/\\/category\\/([^/?#]+)/);\n    return m ? decodeURIComponent(m[1]) : null;\n  }, [pathname]);\n\n  const scrollerRef = useRef<HTMLUListElement>(null);\n  const [atStart, setAtStart] = useState(true);\n  const [atEnd, setAtEnd] = useState(false);\n\n  function normalizeScrollLeft(el: HTMLElement) {\n    const raw = el.scrollLeft;\n    // In RTL on Chrome/Webkit scrollLeft is negative range [-max, 0]. Normalize to [0..max].\n    if (raw < 0) return -raw;\n    return raw; // LTR or Firefox RTL\n  }\n\n  function updateArrows() {\n    const el = scrollerRef.current;\n    if (!el) return;\n    const max = Math.max(0, el.scrollWidth - el.clientWidth);\n    const n = normalizeScrollLeft(el);\n    setAtStart(n <= 1);\n    setAtEnd(n >= max - 1);\n  }\n\n  useEffect(() => {\n    const el = scrollerRef.current;\n    if (!el) return;\n    updateArrows();\n    const onScroll = () => updateArrows();\n    el.addEventListener(\"scroll\", onScroll, { passive: true });\n    const r = new ResizeObserver(() => updateArrows());\n    r.observe(el);\n    return () => {\n      el.removeEventListener(\"scroll\", onScroll);\n      r.disconnect();\n    };\n  }, []);\n\n  function scrollByDir(sign: 1 | -1) {\n    const el = scrollerRef.current;\n    if (!el) return;\n    const step = 260;\n    // If RTL with negative scrollLeft, invert direction\n    const factor = el.scrollLeft < 0 ? -1 : 1;\n    el.scrollBy({ left: sign * step * factor, behavior: \"smooth\" });\n  }\n\n  return (\n    <nav className=\"w-full border-t bg-background/95\" dir=\"ltr\" aria-label=\"Store Categories\">\n      <div className=\"container relative\">\n        {/* Left/Right arrows */}\n        <button\n          type=\"button\"\n          onClick={() => scrollByDir(-1)}\n          className=\"absolute left-2 top-1/2 z-10 -translate-y-1/2 rounded-full border bg-background p-1 shadow-sm disabled:opacity-30\"\n          aria-label=\"Scroll left\"\n          disabled={atStart}\n        >\n          {/* In RTL, left button shows ChevronRight for visual cue */}\n          <ChevronRight className=\"h-4 w-4\" />\n        </button>\n        <button\n          type=\"button\"\n          onClick={() => scrollByDir(1)}\n          className=\"absolute right-2 top-1/2 z-10 -translate-y-1/2 rounded-full border bg-background p-1 shadow-sm disabled:opacity-30\"\n          aria-label=\"Scroll right\"\n          disabled={atEnd}\n        >\n          {/* In RTL, right button shows ChevronLeft for visual cue */}\n          <ChevronLeft className=\"h-4 w-4\" />\n        </button>\n\n        {/* Gradient edges */}\n        <div className=\"pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-background to-transparent\" />\n        <div className=\"pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-background to-transparent\" />\n\n        <ul\n          ref={scrollerRef}\n          className=\"flex gap-2 overflow-x-auto overscroll-x-contain touch-pan-x scroll-smooth py-2 whitespace-nowrap scrollbar-hide pr-10 pl-10\"\n        >\n          {CATEGORIES.map((c) => {\n            const isActive = activeSlug === c.slug;\n            return (\n              <li key={c.slug}>\n                <Link\n                  href={`/category/${c.slug}`}\n                  className={\n                    \"text-sm px-3 py-1 rounded-full transition-colors \" +\n                    (isActive\n                      ? \"bg-primary text-primary-foreground\"\n                      : \"text-foreground/80 hover:text-foreground hover:bg-accent\")\n                  }\n                >\n                  {c.label}\n                </Link>\n              </li>\n            );\n          })}\n        </ul>\n      </div>\n    </nav>\n  );\n}\n","path":null,"size_bytes":4044,"size_tokens":null},"netlify.toml":{"content":"[build]\n  command = \"npm run build\"\n  publish = \".next\"\n\n[build.environment]\n  # Set NEXT_PUBLIC_SITE_URL in the Netlify dashboard for each environment\n  # Example: https://<your-site>.netlify.app or your custom domain\n  # NEXT_PUBLIC_SITE_URL = \"https://your-domain.example\"\n\n# Enable Next.js SSR on Netlify\n[[plugins]]\n  package = \"@netlify/plugin-nextjs\"\n","path":null,"size_bytes":358,"size_tokens":null},"src/app/api/admin/cj/health/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { hasColumn, hasTable } from '@/lib/db-features'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const db = getSupabaseAdmin()\n    if (!db) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const metrics: Record<string, any> = {}\n\n    // Products\n    const { data: prodCount } = await db.from('products').select('id', { count: 'exact', head: true })\n    metrics.productsTotal = (prodCount as any)?.length ?? undefined // Supabase head doesn't return length in SDK; skip exact\n    try {\n      const { data } = await db.from('products').select('id').eq('price', 0).limit(1)\n      metrics.productsZeroPrice = Array.isArray(data) ? data.length : undefined // indicative only\n    } catch {}\n\n    if (await hasColumn('products', 'is_active')) {\n      try {\n        const { data } = await db.from('products').select('id').eq('is_active', false).limit(1)\n        metrics.productsInactive = Array.isArray(data) ? data.length : undefined\n      } catch {}\n    }\n\n    // Variants (optional table)\n    if (await hasTable('product_variants')) {\n      try {\n        const { data } = await db.from('product_variants').select('id').limit(1)\n        metrics.variantsPresent = Array.isArray(data) ? data.length : 0\n      } catch {}\n    }\n\n    // Logs (optional)\n    if (await hasTable('sync_logs')) {\n      try {\n        const { data } = await db.from('sync_logs').select('*').order('created_at', { ascending: false }).limit(20)\n        metrics.latestSyncLogs = data || []\n      } catch {}\n    }\n\n    const r = NextResponse.json({ ok: true, metrics })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'health failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2678,"size_tokens":null},"src/app/page.tsx":{"content":"import Link from \"next/link\";\nimport type { Metadata } from \"next\";\nimport ProductCard from \"@/components/product-card\";\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\";\nimport type { Product } from \"@/lib/types\";\nimport { CATEGORIES } from \"@/lib/categories\";\nimport Hero from \"@/components/pro/Hero\";\nimport ValueProps from \"@/components/pro/ValueProps\";\nimport Newsletter from \"@/components/pro/Newsletter\";\n\nconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL || \"http://localhost:3000\";\n\nexport const metadata: Metadata = {\n  title: \"Shopixo — Modern Online Store\",\n  description: \"Shopixo is a modern, professional online store.\",\n  openGraph: {\n    type: \"website\",\n    url: siteUrl,\n    title: \"Shopixo — Modern Online Store\",\n    description: \"Shopixo is a modern, professional online store.\",\n    siteName: \"Shopixo\",\n  },\n  twitter: {\n    card: \"summary_large_image\",\n    title: \"Shopixo — Modern Online Store\",\n    description: \"Shopixo is a modern, professional online store.\",\n  },\n  alternates: { canonical: \"/\" },\n};\n\nexport const revalidate = 60;\n\nexport default async function HomePage() {\n  const hasSupabaseEnv = !!process.env.NEXT_PUBLIC_SUPABASE_URL && !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  let products: any[] | null = null;\n  const categories = CATEGORIES;\n\n  if (hasSupabaseEnv) {\n    try {\n      const supabase = getSupabaseAnonServer()!;\n      const { data, error } = await supabase.from(\"products\").select(\"*\").eq(\"is_active\", true);\n      if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n        // Column not found yet (migration not applied) → fallback to unfiltered query\n        const fb = await supabase.from(\"products\").select(\"*\");\n        if (fb.error) console.error(\"Error fetching products (fallback):\", fb.error);\n        products = (fb.data as any[] | null) ?? null;\n      } else {\n        if (error) console.error(\"Error fetching products:\", error);\n        products = (data as any[] | null) ?? null;\n      }\n\n      // Categories are predefined; no need to query them from DB\n    } catch (e) {\n      console.error(\"Failed to initialize Supabase client:\", e);\n    }\n  } else {\n    console.warn(\"Supabase env vars missing; showing empty state.\");\n    products = [];\n  }\n\n  return (\n    <main>\n      <Hero />\n      <ValueProps />\n      <div className=\"container py-8\">\n        {/* Best Sellers / Featured */}\n        <section className=\"mb-10\">\n          <h2 className=\"mb-4 text-2xl font-bold\">Best Sellers</h2>\n          {(!products || products.length === 0) ? (\n            <div className=\"text-slate-600\">No products available.</div>\n          ) : (\n            <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n              {products.slice(0, 10).map((p) => (\n                <ProductCard key={p.id} product={p as Product} />\n              ))}\n            </div>\n          )}\n        </section>\n      </div>\n      <Newsletter />\n    </main>\n  );\n}\n","path":null,"size_bytes":3035,"size_tokens":null},"src/components/trust-badges.tsx":{"content":"export default function TrustBadges() {\n  const items = [\n    { icon: \"🔒\", label: \"Secure Payment\" },\n    { icon: \"↩️\", label: \"30-Day Returns\" },\n    { icon: \"⚡\", label: \"Fast Shipping\" },\n    { icon: \"⭐\", label: \"Excellent Reviews\" },\n  ];\n  return (\n    <div className=\"container\">\n      <div className=\"grid grid-cols-2 gap-4 py-6 text-sm text-foreground sm:grid-cols-4\">\n        {items.map((i) => (\n          <div key={i.label} className=\"flex items-center gap-2 rounded-xl border bg-card px-4 py-3 shadow-sm\">\n            <span className=\"text-lg\" aria-hidden>{i.icon}</span>\n            <span>{i.label}</span>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":688,"size_tokens":null},"branding/suppliers/shipping-matrix-request-ar.md":{"content":"# طلب جدول شحن إلى السعودية (KSA) — Shopixo\n\nمرحبًا، نرجو تزويدنا ببطاقات أسعار الشحن إلى السعودية لطلبات الدروبشيب مع الشحن الأعمى (Blind Shipping) باسم المرسل: \"Shopixo\".\n\nيرجى تزويدنا لكل خدمة (اقتصادي / سريع):\n- هل الأسعار تشمل DDP (الرسوم والضرائب مدفوعة)؟ نعم/لا. إن كانت لا، اذكر من يدفع وآلية/أمثلة التكلفة.\n- زمن التوصيل المعتاد (باب لباب) إلى السعودية.\n- شرائح الوزن (فعلي أو حجمي) والأسعار بالدولار:\n  - 0–0.25 كغ\n  - 0.25–0.5 كغ\n  - 0.5–1.0 كغ\n  - 1.0–1.5 كغ\n  - 1.5–2.0 كغ\n  - 2.0–3.0 كغ\n  - 3.0–5.0 كغ\n- معادلة الوزن الحجمي (مثل: الطول × العرض × الارتفاع ÷ 5000).\n- أي رسوم مناطق نائية أو رسوم وقود.\n- دعم ملصقات الدفع عند الاستلام (COD) مستقبلًا؟ الرسوم؟\n\nمتطلبات المعالجة لكل شحنة:\n- اسم المرسل على الملصق: Shopixo\n- تضمين قسيمة التغليف وبطاقة الشكر الخاصة بنا داخل الطرد (PDF/HTML مرفقة)\n- عدم وضع أي مواد تسويقية تخص المورد داخل الطرد\n\nفضلًا أرسلوا أحدث بطاقة أسعار لديكم ووصف الخدمات. شكرًا لكم.\n","path":null,"size_bytes":1510,"size_tokens":null},"src/components/ui/toast-provider.tsx":{"content":"\"use client\";\n\nimport React, { createContext, useCallback, useContext, useEffect, useMemo, useState } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\nexport type ToastVariant = \"success\" | \"error\" | \"info\" | \"warning\";\nexport type ToastOptions = {\n  title?: string;\n  description?: string;\n  variant?: ToastVariant;\n  duration?: number;\n};\n\ntype ToastInternal = Required<Omit<ToastOptions, \"duration\">> & {\n  id: number;\n  duration: number;\n};\n\nconst ToastContext = createContext<{\n  toast: (opts: ToastOptions) => number;\n  dismiss: (id: number) => void;\n} | null>(null);\n\nexport function ToastProvider({ children }: { children: React.ReactNode }) {\n  const [toasts, setToasts] = useState<ToastInternal[]>([]);\n\n  const dismiss = useCallback((id: number) => {\n    setToasts((prev) => prev.filter((t) => t.id !== id));\n  }, []);\n\n  const toast = useCallback((opts: ToastOptions) => {\n    const id = Date.now() + Math.floor(Math.random() * 1000);\n    const t: ToastInternal = {\n      id,\n      title: opts.title ?? \"\",\n      description: opts.description ?? \"\",\n      variant: opts.variant ?? \"info\",\n      duration: opts.duration ?? 3500,\n    };\n    setToasts((prev) => [...prev, t]);\n    return id;\n  }, []);\n\n  useEffect(() => {\n    if (toasts.length === 0) return;\n    const timers = toasts.map((t) =>\n      setTimeout(() => {\n        dismiss(t.id);\n      }, t.duration)\n    );\n    return () => timers.forEach(clearTimeout);\n  }, [toasts, dismiss]);\n\n  const value = useMemo(() => ({ toast, dismiss }), [toast, dismiss]);\n\n  return (\n    <ToastContext.Provider value={value}>\n      {children}\n      <Toaster toasts={toasts} onDismiss={dismiss} />\n    </ToastContext.Provider>\n  );\n}\n\nexport function useToast() {\n  const ctx = useContext(ToastContext);\n  if (!ctx) throw new Error(\"useToast must be used within ToastProvider\");\n  return ctx;\n}\n\nfunction Toaster({ toasts, onDismiss }: { toasts: ToastInternal[]; onDismiss: (id: number) => void }) {\n  return (\n    <div className=\"fixed top-4 right-4 z-50 flex w-full max-w-sm flex-col gap-2\">\n      {toasts.map((t) => (\n        <ToastItem key={t.id} toast={t} onDismiss={() => onDismiss(t.id)} />\n      ))}\n    </div>\n  );\n}\n\nfunction ToastItem({ toast, onDismiss }: { toast: ToastInternal; onDismiss: () => void }) {\n  const variantClasses: Record<ToastVariant, string> = {\n    success: \"border-green-300 text-green-900\",\n    error: \"border-red-300 text-red-900\",\n    info: \"border-blue-300 text-blue-900\",\n    warning: \"border-yellow-300 text-yellow-900\",\n  };\n\n  const title = toast.title || (toast.variant === \"success\" ? \"Success\" : toast.variant === \"error\" ? \"Error\" : \"Notice\");\n\n  return (\n    <div className={cn(\"pointer-events-auto overflow-hidden rounded-md border bg-white shadow-md\", variantClasses[toast.variant])}>\n      <div className=\"p-3\">\n        <div className=\"flex items-start gap-3\">\n          <div className=\"flex-1\">\n            <p className=\"text-sm font-semibold\">{title}</p>\n            {toast.description ? (\n              <p className=\"mt-1 text-xs text-gray-700\">{toast.description}</p>\n            ) : null}\n          </div>\n          <button onClick={onDismiss} className=\"text-xs text-gray-500 hover:text-gray-800\" aria-label=\"Close\">\n            ✕\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3306,"size_tokens":null},"src/__tests__/site.test.ts":{"content":"import { getSiteUrl } from '@/lib/site'\n\ndescribe('getSiteUrl', () => {\n  const envBackup = { ...process.env };\n  afterEach(() => {\n    process.env = { ...envBackup } as any;\n  });\n\n  test('uses NEXT_PUBLIC_SITE_URL when set and normalizes without trailing slash', () => {\n    process.env.NEXT_PUBLIC_SITE_URL = 'https://example.com/';\n    expect(getSiteUrl()).toBe('https://example.com');\n  });\n\n  test('falls back to VERCEL_URL and normalizes scheme', () => {\n    delete process.env.NEXT_PUBLIC_SITE_URL;\n    process.env.VERCEL_URL = 'my-app.vercel.app';\n    expect(getSiteUrl()).toBe('https://my-app.vercel.app');\n  });\n\n  test('falls back to localhost when unset/invalid', () => {\n    delete process.env.NEXT_PUBLIC_SITE_URL;\n    delete process.env.VERCEL_URL;\n    expect(getSiteUrl()).toBe('http://localhost:3000');\n  });\n});\n","path":null,"size_bytes":831,"size_tokens":null},"src/app/admin/products/archive-button.tsx":{"content":"\"use client\";\n\nimport { useFormState } from \"react-dom\";\nimport { setProductActive } from \"@/app/admin/products/actions\";\n\ntype ToggleState = { error: string | null; success: boolean };\n\nconst initialState: ToggleState = { error: null, success: false };\n\nexport default function ArchiveProductButton({ productId, isActive, formId }: { productId: number; isActive: boolean; formId?: string }) {\n  const [state, formAction] = useFormState<ToggleState, FormData>(setProductActive as any, initialState);\n  const label = isActive ? \"Archive\" : \"Restore\";\n\n  return (\n    <form id={formId} action={formAction} className=\"inline-block\">\n      <input type=\"hidden\" name=\"id\" value={productId} />\n      <input type=\"hidden\" name=\"is_active\" value={(!isActive).toString()} />\n      <button\n        type=\"submit\"\n        className={\n          isActive\n            ? \"text-sm font-medium text-amber-600 hover:underline\"\n            : \"text-sm font-medium text-emerald-600 hover:underline\"\n        }\n      >\n        {label}\n      </button>\n      {state?.error && <p className=\"mt-1 text-xs text-red-600\">{state.error}</p>}\n    </form>\n  );\n}\n","path":null,"size_bytes":1129,"size_tokens":null},"src/app/new-arrivals/page.tsx":{"content":"import ProductCard from \"@/components/product-card\"\nimport Breadcrumbs from \"@/components/breadcrumbs\"\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\"\nimport type { Product } from \"@/lib/types\"\n\nexport const metadata = { title: \"New Arrivals\", description: \"Latest products added to the store\" }\nexport const revalidate = 60\nexport const dynamic = \"force-dynamic\"\n\nexport default async function NewArrivalsPage() {\n  const supabase = getSupabaseAnonServer()\n  let products: any[] | null = null\n  if (!supabase) {\n    products = []\n  } else {\n    try {\n      let { data, error } = await supabase.from(\"products\").select(\"*\").order(\"created_at\", { ascending: false })\n      if (error && (error as any).code === \"42703\") {\n        const fb = await supabase.from(\"products\").select(\"*\").order(\"id\", { ascending: false })\n        data = fb.data as any\n      }\n      products = (data as any[] | null) ?? []\n    } catch {\n      products = []\n    }\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <Breadcrumbs items={[{ name: \"Home\", href: \"/\" }, { name: \"New Arrivals\" }]} />\n      <h1 className=\"text-3xl font-bold\">New Arrivals</h1>\n      <p className=\"mt-2 text-slate-600\">Check out the latest additions to our collection.</p>\n      {products && products.length > 0 ? (\n        <div className=\"mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n          {products.map((p) => (\n            <ProductCard key={p.id} product={p as Product} />\n          ))}\n        </div>\n      ) : (\n        <div className=\"mt-6 rounded-md border p-6 text-center text-slate-500\">No products available.</div>\n      )}\n    </div>\n  )\n}\n","path":null,"size_bytes":1676,"size_tokens":null},"src/app/api/cj/seed/diag/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { loggerForRequest } from '@/lib/log'\nimport { getAccessToken } from '@/lib/cj/v2'\nimport { fetchWithMeta } from '@/lib/http'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getBase(): string {\n  const b = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1'\n  return b.replace(/\\/$/, '')\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const { searchParams } = new URL(req.url)\n    const kw = searchParams.get('kw') || 'dress'\n\n    const out: any = { ok: false, kw }\n\n    // Step 1: obtain token (do not expose token)\n    try {\n      const token = await getAccessToken()\n      out.tokenObtained = !!token\n      out.tokenPreview = token ? token.slice(0, 4) + '…' + token.slice(-4) : null\n    } catch (e: any) {\n      out.tokenObtained = false\n      out.tokenError = e?.message || String(e)\n    }\n\n    // If token not obtained, return early\n    if (!out.tokenObtained) {\n      const r = NextResponse.json({ ok: false, step: 'token', ...out }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Step 2: probe endpoints with sanitized output\n    const tokenHeader = { 'CJ-Access-Token': 'hidden' }\n    const base = getBase()\n    const probes = [\n      `/product/list?keyWords=${encodeURIComponent(kw)}&pageSize=1&pageNum=1`,\n      `/product/query?keyword=${encodeURIComponent(kw)}&pageSize=1&pageNumber=1`,\n      `/product/myProduct/query?keyword=${encodeURIComponent(kw)}&pageSize=1&pageNumber=1`,\n    ]\n\n    out.tests = []\n    for (const p of probes) {\n      const url = `${base}${p}`\n      try {\n        const r = await fetchWithMeta<any>(url, {\n          method: 'GET',\n          headers: { 'CJ-Access-Token': (await getAccessToken()) },\n          cache: 'no-store',\n          timeoutMs: 12000,\n          retries: 1,\n        })\n        out.tests.push({ path: p, status: r.status, ok: r.ok, sample: r.body?.data ? Object.keys(r.body.data).slice(0, 3) : undefined })\n      } catch (e: any) {\n        out.tests.push({ path: p, error: e?.message || String(e) })\n      }\n    }\n\n    out.ok = true\n    const r = NextResponse.json(out)\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || String(e) }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2505,"size_tokens":null},"src/lib/pricing-policy.ts":{"content":"import { createClient } from '@supabase/supabase-js'\nimport { hasTable } from '@/lib/db-features'\nimport { getEnv } from '@/lib/env'\n\nexport type PricingPolicy = {\n  margin: number // 0..1 (e.g., 0.35)\n  floorSar: number // minimum retail SAR\n  roundTo: number // rounding step (e.g., 0.05)\n  endings: number[] // preferred decimal endings (e.g., [0.95, 0.99])\n}\n\nfunction getSupabaseAdmin() {\n  const url = getEnv('NEXT_PUBLIC_SUPABASE_URL') as string | undefined\n  const key = getEnv('SUPABASE_SERVICE_ROLE_KEY') as string | undefined\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nfunction defaultsFromEnv(): PricingPolicy {\n  const margin = Number(process.env.PRICE_MARGIN_DEFAULT || '0.35')\n  const floorSar = Number(process.env.PRICE_FLOOR_SAR || '9')\n  const roundTo = Number(process.env.PRICE_ROUND_STEP || '0.05')\n  const endingsCsv = (process.env.PRICE_ENDINGS || '0.95,0.99').split(',').map(s => Number(s.trim())).filter(n => Number.isFinite(n))\n  const endings = endingsCsv.length > 0 ? endingsCsv : [0.95, 0.99]\n  return { margin: Math.max(0, Math.min(0.95, margin || 0.35)), floorSar: Math.max(0, floorSar || 0), roundTo: roundTo || 0.05, endings }\n}\n\nexport async function loadPricingPolicy(collection?: string): Promise<PricingPolicy> {\n  const admin = getSupabaseAdmin()\n  const d = defaultsFromEnv()\n  if (!admin) return d\n  try {\n    if (!(await hasTable('pricing_policies'))) return d\n    const q = admin.from('pricing_policies').select('*').limit(1)\n    if (collection) q.eq('collection', collection)\n    const { data } = await q\n    if (!data || data.length === 0) return d\n    const row = data[0] as any\n    const endings: number[] = Array.isArray(row.endings) ? row.endings : (typeof row.endings === 'string' ? row.endings.split(',').map((s: string) => Number(s.trim())).filter((n: number) => Number.isFinite(n)) : d.endings)\n    return {\n      margin: Number(row.margin ?? d.margin) || d.margin,\n      floorSar: Number(row.floor_sar ?? d.floorSar) || d.floorSar,\n      roundTo: Number(row.round_to ?? d.roundTo) || d.roundTo,\n      endings: endings.length > 0 ? endings : d.endings,\n    }\n  } catch {\n    return d\n  }\n}\n","path":null,"size_bytes":2165,"size_tokens":null},"src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"rounded-lg border bg-card text-card-foreground shadow-sm\", className)}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex flex-col space-y-1.5 p-6\", className)} {...props} />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLHeadingElement>>(({ className, ...props }, ref) => (\n  <h3 ref={ref} className={cn(\"text-2xl font-semibold leading-none tracking-tight\", className)} {...props} />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<HTMLParagraphElement, React.HTMLAttributes<HTMLParagraphElement>>(({ className, ...props }, ref) => (\n  <p ref={ref} className={cn(\"text-sm text-muted-foreground\", className)} {...props} />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<HTMLDivElement, React.HTMLAttributes<HTMLDivElement>>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center p-6 pt-0\", className)} {...props} />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1749,"size_tokens":null},"src/app/api/cj/import/by-codes/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { persistRawCj, upsertProductFromCj } from '@/lib/ops/cj-sync'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction tokenOk(req: Request): boolean {\n  try {\n    const url = new URL(req.url)\n    const qp = url.searchParams.get('token') || ''\n    const hdr = req.headers.get('x-seed-token') || ''\n    const auth = req.headers.get('authorization') || ''\n    const bearer = auth.toLowerCase().startsWith('bearer ') ? auth.slice(7) : ''\n    const provided = qp || hdr || bearer\n    const expected = process.env.SEED_IMPORT_TOKEN || ''\n    if (!expected) return false\n    return !!provided && provided === expected\n  } catch { return false }\n}\n\nasync function allow(req: Request) {\n  const admin = await ensureAdmin()\n  if (admin.ok) return true\n  if (tokenOk(req)) return true\n  return false\n}\n\nasync function handleImport(codes: string[]) {\n  const results: any[] = []\n  for (const rawCode of codes) {\n    const code = String(rawCode || '').trim()\n    if (!code) { results.push({ code, ok: false, error: 'empty code' }); continue }\n    try {\n      const raw = await queryProductByPidOrKeyword({ pid: code })\n      const itemRaw = Array.isArray((raw as any)?.data?.list)\n        ? (raw as any).data.list[0]\n        : Array.isArray((raw as any)?.data?.content)\n          ? (raw as any).data.content[0]\n          : Array.isArray((raw as any)?.content)\n            ? (raw as any).content[0]\n            : Array.isArray((raw as any)?.data)\n              ? (raw as any).data[0]\n              : ((raw as any)?.data || raw)\n\n      const mapped = mapCjItemToProductLike(itemRaw)\n      if (!mapped) { results.push({ code, ok: false, error: 'CJ item mapping failed' }); continue }\n\n      const up = await upsertProductFromCj(mapped, { updateImages: true, updateVideo: true, updatePrice: true })\n      if (up.ok) {\n        try { await persistRawCj(up.productId, itemRaw) } catch {}\n        const variantCount = Array.isArray(mapped.variants) ? mapped.variants.length : 0\n        const totalStock = (Array.isArray(mapped.variants) ? mapped.variants : []).reduce((a, v: any) => a + (typeof v.stock === 'number' ? v.stock : 0), 0)\n        results.push({ code, ok: true, productId: up.productId, updated: up.updated, variantCount, totalStock })\n      } else {\n        results.push({ code, ok: false, error: up.error || 'upsert failed' })\n      }\n    } catch (e: any) {\n      results.push({ code, ok: false, error: e?.message || 'import failed' })\n    }\n  }\n  return results\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    if (!(await allow(req))) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const url = new URL(req.url)\n    const codesParam = url.searchParams.get('codes') || ''\n    const codes = codesParam.split(',').map(s => s.trim()).filter(Boolean)\n    if (codes.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'Missing codes' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const results = await handleImport(codes)\n    const r = NextResponse.json({ ok: true, count: results.length, results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'import failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    if (!(await allow(req))) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const body = await req.json().catch(() => ({}))\n    const Schema = z.object({ codes: z.array(z.string()).min(1) })\n    const parsed = Schema.safeParse(body)\n    if (!parsed.success) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid body; expected { codes: string[] }' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const results = await handleImport(parsed.data.codes)\n    const r = NextResponse.json({ ok: true, count: results.length, results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'import failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4829,"size_tokens":null},"src/app/admin/cj/shipping/page.tsx":{"content":"\"use client\"\n\nimport { useState } from 'react'\n\nexport default function CjShippingPage() {\n  const [loading, setLoading] = useState(false)\n  const [resp, setResp] = useState<any>(null)\n\n  async function onSubmit(formData: FormData) {\n    setLoading(true)\n    setResp(null)\n    const body: any = {\n      countryCode: String(formData.get('countryCode') || 'SA').toUpperCase(),\n      zipCode: String(formData.get('zipCode') || ''),\n      pid: String(formData.get('pid') || ''),\n      sku: String(formData.get('sku') || ''),\n      quantity: Number(formData.get('quantity') || 1),\n      weightGram: Number(formData.get('weightGram') || 0) || undefined,\n      lengthCm: Number(formData.get('lengthCm') || 0) || undefined,\n      widthCm: Number(formData.get('widthCm') || 0) || undefined,\n      heightCm: Number(formData.get('heightCm') || 0) || undefined,\n    }\n    try {\n      const res = await fetch('/api/cj/shipping/calc', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(body),\n      })\n      const j = await res.json()\n      setResp({ status: res.status, body: j })\n    } catch (e: any) {\n      setResp({ error: e?.message || String(e) })\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <main className=\"mx-auto max-w-3xl p-6 space-y-6\">\n      <h1 className=\"text-2xl font-semibold\">Shipping Calculator</h1>\n      <form action={onSubmit} className=\"grid grid-cols-2 gap-3 border rounded p-4\">\n        <label className=\"flex flex-col text-sm\">Country Code<input name=\"countryCode\" defaultValue=\"SA\" className=\"border rounded px-2 py-1\"/></label>\n        <label className=\"flex flex-col text-sm\">ZIP (optional)<input name=\"zipCode\" className=\"border rounded px-2 py-1\"/></label>\n        <label className=\"flex flex-col text-sm\">Product ID<input name=\"pid\" placeholder=\"GUID pid\" className=\"border rounded px-2 py-1\"/></label>\n        <label className=\"flex flex-col text-sm\">Variant SKU<input name=\"sku\" placeholder=\"cjSku\" className=\"border rounded px-2 py-1\"/></label>\n        <label className=\"flex flex-col text-sm\">Quantity<input name=\"quantity\" type=\"number\" defaultValue={1} min={1} className=\"border rounded px-2 py-1\"/></label>\n        <div className=\"col-span-2 grid grid-cols-3 gap-3\">\n          <label className=\"flex flex-col text-sm\">Weight (g)<input name=\"weightGram\" type=\"number\" className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">L (cm)<input name=\"lengthCm\" type=\"number\" className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">W (cm)<input name=\"widthCm\" type=\"number\" className=\"border rounded px-2 py-1\"/></label>\n          <label className=\"flex flex-col text-sm\">H (cm)<input name=\"heightCm\" type=\"number\" className=\"border rounded px-2 py-1\"/></label>\n        </div>\n        <div className=\"col-span-2\">\n          <button type=\"submit\" disabled={loading} className=\"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-50\">{loading ? 'Calculating...' : 'Calculate'}</button>\n        </div>\n      </form>\n      {resp && (\n        <pre className=\"text-xs bg-gray-50 border rounded p-3 overflow-auto max-h-96\">{JSON.stringify(resp, null, 2)}</pre>\n      )}\n    </main>\n  )\n}\n","path":null,"size_bytes":3270,"size_tokens":null},"src/__tests__/utils.test.ts":{"content":"import { formatCurrency } from '@/lib/utils'\n\ndescribe('formatCurrency', () => {\n  it('formats USD with en-US locale deterministically', () => {\n    expect(formatCurrency(1, 'USD', 'en-US')).toBe('$1.00')\n    expect(formatCurrency(1234.5, 'USD', 'en-US')).toBe('$1,234.50')\n  })\n\n  it('respects provided currency code', () => {\n    const out = formatCurrency(10, 'EUR', 'en-US')\n    expect(out).toBe('€10.00')\n  })\n})\n","path":null,"size_bytes":420,"size_tokens":null},"src/app/search/page.tsx":{"content":"import { getSupabaseAnonServer } from \"@/lib/supabase-server\";\nimport { labelFromSlug } from \"@/lib/categories\";\nimport ProductCard from \"@/components/product-card\";\nimport type { Product } from \"@/lib/types\";\nimport { headers } from \"next/headers\";\n\n\nexport const metadata = { title: \"Search\" };\n\nconst siteUrl = process.env.NEXT_PUBLIC_SITE_URL || \"http://localhost:3000\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function SearchPage({\n  searchParams,\n}: {\n  searchParams?: Record<string, string | string[] | undefined>;\n}) {\n  const nonce = headers().get('x-csp-nonce') || undefined;\n  const getFirst = (v: string | string[] | undefined) =>\n    (Array.isArray(v) ? v[0] : v) ?? \"\";\n\n  const q = getFirst(searchParams?.q).toLowerCase();\n  const rawCategory = getFirst(searchParams?.category);\n  const category = labelFromSlug(rawCategory) || rawCategory;\n  const minPriceRaw = getFirst(searchParams?.minPrice);\n  const maxPriceRaw = getFirst(searchParams?.maxPrice);\n  const minRatingRaw = getFirst(searchParams?.minRating);\n  const sort = getFirst(searchParams?.sort);\n\n  const minPrice = Number.isFinite(parseFloat(minPriceRaw))\n    ? parseFloat(minPriceRaw)\n    : undefined;\n  const maxPrice = Number.isFinite(parseFloat(maxPriceRaw))\n    ? parseFloat(maxPriceRaw)\n    : undefined;\n  const minRating = Number.isFinite(parseFloat(minRatingRaw))\n    ? parseFloat(minRatingRaw)\n    : undefined;\n\n  const supabase = getSupabaseAnonServer();\n\n  let categories: string[] = [];\n  if (supabase) {\n    const { data: categoriesData } = await supabase\n      .from(\"products\")\n      .select(\"category\")\n      .or(\"is_active.is.null,is_active.eq.true\");\n    categories = Array.from(new Set((categoriesData ?? []).map((p: { category: string }) => p.category))).sort();\n  } else {\n    categories = [];\n  }\n\n  let filtered: Product[] | null = [];\n  if (!supabase) {\n    filtered = [];\n  } else {\n    let query = supabase.from(\"products\").select<\"*\", Product>(\"*\").or(\"is_active.is.null,is_active.eq.true\");\n\n    if (q) {\n      query = query.or(`title.ilike.%${q}%,description.ilike.%${q}%`);\n    }\n    if (category) {\n      query = query.eq(\"category\", category);\n    }\n    if (minPrice) {\n      query = query.gte(\"price\", minPrice);\n    }\n    if (maxPrice) {\n      query = query.lte(\"price\", maxPrice);\n    }\n    if (minRating) {\n      query = query.gte(\"rating\", minRating);\n    }\n\n    if (sort) {\n      const [field, order] = sort.split(\"-\");\n      query = query.order(field, { ascending: order === \"asc\" });\n    }\n\n    const { data, error } = await query;\n    if (error) {\n      console.error(\"Error fetching products:\", error);\n    }\n    filtered = (data as Product[] | null) ?? [];\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <script\n        nonce={nonce}\n        type=\"application/ld+json\"\n        dangerouslySetInnerHTML={{\n          __html: JSON.stringify({\n            \"@context\": \"https://schema.org\",\n            \"@type\": \"BreadcrumbList\",\n            itemListElement: [\n              { \"@type\": \"ListItem\", position: 1, name: \"Home\", item: siteUrl },\n              { \"@type\": \"ListItem\", position: 2, name: \"Search\", item: `${siteUrl}/search` },\n            ],\n          }),\n        }}\n      />\n      <nav aria-label=\"Breadcrumb\" className=\"text-sm text-slate-600\">\n        <a href=\"/\" className=\"hover:underline\">Home</a>\n        <span className=\"mx-2\">/</span>\n        <span>Search</span>\n      </nav>\n      <h1 className=\"text-3xl font-bold\">Search</h1>\n\n      <form className=\"mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-6\" method=\"get\">\n        <div className=\"lg:col-span-2\">\n          <input\n            name=\"q\"\n            placeholder=\"Search products...\"\n            defaultValue={getFirst(searchParams?.q)}\n            className=\"w-full rounded-md border px-4 py-2\"\n          />\n        </div>\n        <div>\n          <select name=\"category\" defaultValue={category} className=\"w-full rounded-md border px-3 py-2\">\n            <option value=\"\">All Categories</option>\n            {categories.map((c) => (\n              <option key={c} value={c}>\n                {c}\n              </option>\n            ))}\n          </select>\n        </div>\n        <div className=\"flex gap-2\">\n          <input\n            type=\"number\"\n            name=\"minPrice\"\n            placeholder=\"Min Price\"\n            step=\"0.01\"\n            defaultValue={minPriceRaw}\n            className=\"w-full rounded-md border px-3 py-2\"\n          />\n          <input\n            type=\"number\"\n            name=\"maxPrice\"\n            placeholder=\"Max Price\"\n            step=\"0.01\"\n            defaultValue={maxPriceRaw}\n            className=\"w-full rounded-md border px-3 py-2\"\n          />\n        </div>\n        <div>\n          <select name=\"minRating\" defaultValue={minRatingRaw} className=\"w-full rounded-md border px-3 py-2\">\n            <option value=\"\">Any Rating</option>\n            <option value=\"3\">3+ Stars</option>\n            <option value=\"4\">4+ Stars</option>\n            <option value=\"4.5\">4.5+ Stars</option>\n            <option value=\"5\">5 Stars</option>\n          </select>\n        </div>\n        <div>\n          <select name=\"sort\" defaultValue={sort} className=\"w-full rounded-md border px-3 py-2\">\n            <option value=\"\">Sort By</option>\n            <option value=\"price-asc\">Price: Low to High</option>\n            <option value=\"price-desc\">Price: High to Low</option>\n            <option value=\"rating-desc\">Rating: High to Low</option>\n            <option value=\"rating-asc\">Rating: Low to High</option>\n          </select>\n        </div>\n        <div className=\"flex gap-3\">\n          <button type=\"submit\" className=\"rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700\">\n            Apply\n          </button>\n          <a href=\"/search\" className=\"rounded-md border px-4 py-2 hover:bg-slate-50\">\n            Clear\n          </a>\n        </div>\n      </form>\n\n      <div className=\"mt-6 text-sm text-slate-600\">Results: {filtered?.length || 0}</div>\n\n      <div className=\"mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n        {filtered?.map((p) => (\n          <ProductCard key={p.slug} product={p} />\n        ))}\n        {(!filtered || filtered.length === 0) && (\n          <div className=\"text-slate-600\">No products found{q ? ` for \"${q}\"` : \"\"}</div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6440,"size_tokens":null},"src/app/admin/products/[id]/edit/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport ProductForm from \"@/app/admin/products/product-form\";\n\nexport const metadata = {\n  title: \"Edit Product\",\n};\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function EditProductPage({ params }: { params: { id: string } }) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { session } } = await supabase.auth.getSession();\n\n  if (!session) {\n    redirect(\"/login\");\n  }\n\n  const { data: product } = await supabase\n    .from(\"products\")\n    .select(\"*\")\n    .eq(\"id\", params.id)\n    .single();\n\n  if (!product) {\n    redirect(\"/admin\");\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Edit Product</h1>\n      <div className=\"mt-6 max-w-2xl\">\n        <ProductForm product={product} />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1001,"size_tokens":null},"src/components/admin-product-actions.tsx":{"content":"\"use client\";\n\nimport Link from \"next/link\";\nimport ArchiveProductButton from \"@/app/admin/products/archive-button\";\nimport DeleteProductButton from \"@/app/admin/products/delete-button\";\n\nexport default function AdminProductActions({\n  productId,\n  productSlug,\n  isActive = true,\n}: {\n  productId: number;\n  productSlug: string;\n  isActive?: boolean;\n}) {\n  return (\n    <div className=\"mt-4 flex items-center gap-3 rounded-md border bg-card/60 p-2 text-sm\">\n      <Link\n        href={`/admin/products/${productId}/edit`}\n        className=\"rounded-md bg-gradient-to-r from-primary/90 to-primary px-3 py-1.5 font-medium text-primary-foreground shadow hover:opacity-90\"\n      >\n        Edit\n      </Link>\n      <ArchiveProductButton productId={productId} isActive={isActive} />\n      <DeleteProductButton productId={productId} doubleConfirm />\n      <span className=\"ms-auto text-xs text-muted-foreground\">Admin Panel</span>\n    </div>\n  );\n}\n","path":null,"size_bytes":943,"size_tokens":null},"tailwind.config.js":{"content":"/** @type {import('tailwindcss').Config} */\nmodule.exports = {\n  darkMode: [\"class\"],\n  content: [\n    './pages/**/*.{ts,tsx}',\n    './components/**/*.{ts,tsx}',\n    './app/**/*.{ts,tsx}',\n    './src/**/*.{ts,tsx}',\n\t],\n  theme: {\n    container: {\n      center: true,\n      padding: \"2rem\",\n      screens: {\n        \"2xl\": \"1400px\",\n      },\n    },\n    extend: {\n      colors: {\n        border: \"hsl(var(--border))\",\n        input: \"hsl(var(--input))\",\n        ring: \"hsl(var(--ring))\",\n        background: \"hsl(var(--background))\",\n        foreground: \"hsl(var(--foreground))\",\n        primary: {\n          DEFAULT: \"hsl(var(--primary))\",\n          foreground: \"hsl(var(--primary-foreground))\",\n        },\n        secondary: {\n          DEFAULT: \"hsl(var(--secondary))\",\n          foreground: \"hsl(var(--secondary-foreground))\",\n        },\n        destructive: {\n          DEFAULT: \"hsl(var(--destructive))\",\n          foreground: \"hsl(var(--destructive-foreground))\",\n        },\n        muted: {\n          DEFAULT: \"hsl(var(--muted))\",\n          foreground: \"hsl(var(--muted-foreground))\",\n        },\n        accent: {\n          DEFAULT: \"hsl(var(--accent))\",\n          foreground: \"hsl(var(--accent-foreground))\",\n        },\n        popover: {\n          DEFAULT: \"hsl(var(--popover))\",\n          foreground: \"hsl(var(--popover-foreground))\",\n        },\n        card: {\n          DEFAULT: \"hsl(var(--card))\",\n          foreground: \"hsl(var(--card-foreground))\",\n        },\n      },\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: { height: 0 },\n          to: { height: \"var(--radix-accordion-content-height)\" },\n        },\n        \"accordion-up\": {\n          from: { height: \"var(--radix-accordion-content-height)\" },\n          to: { height: 0 },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\")],\n}\n","path":null,"size_bytes":2125,"size_tokens":null},"src/app/admin/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport Link from \"next/link\";\nimport { RefreshCw, Clock, Package, ShoppingCart, AlertTriangle, CheckCircle, XCircle, ArrowRight } from \"lucide-react\";\n\nexport const metadata = {\n  title: \"Admin Dashboard - Shopixo\",\n};\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function getCJStatus() {\n  const apiKey = process.env.CJ_API_KEY;\n  if (!apiKey) return { connected: false, error: \"API key not configured\", latency: 0 };\n  \n  try {\n    const admin = getSupabaseAdmin();\n    if (admin) {\n      const { data: tokenData } = await admin\n        .from(\"integration_tokens\")\n        .select(\"access_token, access_expiry, updated_at\")\n        .eq(\"provider\", \"cj\")\n        .maybeSingle();\n      \n      if (tokenData?.access_token) {\n        const isValid = !tokenData.access_expiry || new Date(tokenData.access_expiry) > new Date();\n        const lastUpdate = tokenData.updated_at ? new Date(tokenData.updated_at) : null;\n        const ageMs = lastUpdate ? Date.now() - lastUpdate.getTime() : 0;\n        \n        return { \n          connected: isValid, \n          error: isValid ? null : \"Token expired\", \n          latency: Math.min(ageMs / 1000, 999)\n        };\n      }\n    }\n    \n    return { connected: false, error: \"Not authenticated yet\", latency: 0 };\n  } catch (e: any) {\n    return { connected: false, error: e?.message || \"Status check failed\", latency: 0 };\n  }\n}\n\nexport default async function AdminDashboard() {\n  const supabase = createServerComponentClient({ cookies });\n\n  const [\n    { data: products },\n    { data: orders },\n    { data: queueItems },\n    { data: syncChanges },\n    { data: jobs },\n    cjStatus\n  ] = await Promise.all([\n    supabase.from(\"products\").select(\"id, active, stock\").not(\"metadata->cj_product_id\", \"is\", null),\n    supabase.from(\"orders\").select(\"id, status, total\").order(\"created_at\", { ascending: false }).limit(5),\n    supabase.from(\"product_queue\").select(\"id, status\"),\n    supabase.from(\"daily_sync_changes\").select(\"id, change_type, status\").eq(\"status\", \"pending\").limit(10),\n    supabase.from(\"import_logs\").select(\"id, action, status, created_at\").order(\"created_at\", { ascending: false }).limit(5),\n    getCJStatus(),\n  ]);\n\n  const totalProducts = products?.length || 0;\n  const activeProducts = products?.filter(p => p.active)?.length || 0;\n  const pendingOrders = orders?.filter(o => o.status === \"pending\")?.length || 0;\n  const pendingReview = queueItems?.filter(i => i.status === \"pending\" || i.status === \"pending_review\")?.length || 0;\n  const queueCount = queueItems?.filter(i => i.status === \"approved\")?.length || 0;\n  const importedCount = queueItems?.filter(i => i.status === \"imported\")?.length || 0;\n  const pendingChanges = syncChanges?.length || 0;\n  const priceChanges = syncChanges?.filter(c => c.change_type?.includes(\"price\"))?.length || 0;\n  const stockChanges = syncChanges?.filter(c => c.change_type?.includes(\"stock\"))?.length || 0;\n  const lowStockProducts = products?.filter(p => (p.stock || 0) > 0 && (p.stock || 0) < 10)?.length || 0;\n  const outOfStockProducts = products?.filter(p => (p.stock || 0) === 0)?.length || 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Dashboard</h1>\n          <p className=\"text-sm text-gray-500\">Overview of your store performance and alerts</p>\n        </div>\n        <Link \n          href=\"/admin/import/discover\"\n          className=\"inline-flex items-center gap-2 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors font-medium text-sm\"\n        >\n          <Package className=\"h-4 w-4\" />\n          Import Products\n        </Link>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4\">\n        <div className=\"bg-white rounded-xl border border-gray-200 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-blue-50 rounded-lg\">\n              <RefreshCw className=\"h-5 w-5 text-blue-600\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-gray-500\">Sync Alerts</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{pendingChanges}</p>\n              <p className=\"text-xs text-gray-400\">price {priceChanges}, stock {stockChanges}</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-amber-50 rounded-lg\">\n              <Clock className=\"h-5 w-5 text-amber-600\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-gray-500\">Import Queue</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{queueCount}</p>\n              <p className=\"text-xs text-gray-400\">ready to import</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-green-50 rounded-lg\">\n              <ShoppingCart className=\"h-5 w-5 text-green-600\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-gray-500\">Pending Orders</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{pendingOrders}</p>\n              <p className=\"text-xs text-gray-400\">SAR {orders?.reduce((sum, o) => sum + (o.total || 0), 0) || 0} total</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 bg-purple-50 rounded-lg\">\n              <Package className=\"h-5 w-5 text-purple-600\" />\n            </div>\n            <div>\n              <p className=\"text-xs text-gray-500\">Total Products</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{totalProducts}</p>\n              <p className=\"text-xs text-gray-400\">{activeProducts} active</p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-3 gap-4\">\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <h3 className=\"font-semibold text-gray-900 mb-4\">Daily Sync Changes</h3>\n          <div className=\"flex items-center gap-2 mb-4\">\n            {pendingChanges === 0 ? (\n              <>\n                <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                <span className=\"text-sm text-gray-600\">No Pending Changes</span>\n              </>\n            ) : (\n              <>\n                <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                <span className=\"text-sm text-gray-600\">{pendingChanges} pending changes</span>\n              </>\n            )}\n          </div>\n          <p className=\"text-xs text-gray-400 mb-4\">All synced and up to date</p>\n          <Link href=\"/admin/sync\" className=\"inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900\">\n            <ArrowRight className=\"h-4 w-4\" />\n            Manage Sync\n          </Link>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <h3 className=\"font-semibold text-gray-900 mb-4\">Stock Alerts</h3>\n          <div className=\"flex items-center gap-2 mb-4\">\n            {lowStockProducts === 0 && outOfStockProducts === 0 ? (\n              <>\n                <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                <span className=\"text-sm text-green-600\">All Good</span>\n              </>\n            ) : (\n              <>\n                <AlertTriangle className=\"h-5 w-5 text-amber-500\" />\n                <span className=\"text-sm text-amber-600\">{lowStockProducts + outOfStockProducts} alerts</span>\n              </>\n            )}\n          </div>\n          <p className=\"text-xs text-gray-400 mb-4\">\n            {lowStockProducts === 0 && outOfStockProducts === 0 \n              ? \"No stock alerts at this time\" \n              : `${lowStockProducts} low stock, ${outOfStockProducts} out of stock`}\n          </p>\n          <Link href=\"/admin/inventory\" className=\"inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900\">\n            <ArrowRight className=\"h-4 w-4\" />\n            Manage Inventory\n          </Link>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <h3 className=\"font-semibold text-gray-900 mb-4\">CJ Dropshipping Status</h3>\n          <div className=\"flex items-center gap-3 mb-4\">\n            <span className=\"text-xs text-gray-400\">{cjStatus.latency || 0}ms</span>\n            <div className=\"flex items-center gap-2\">\n              <span className={`text-sm font-medium ${cjStatus.connected ? \"text-green-600\" : \"text-red-600\"}`}>\n                {cjStatus.connected ? \"Connected\" : \"Disconnected\"}\n              </span>\n              {cjStatus.connected ? (\n                <CheckCircle className=\"h-4 w-4 text-green-500\" />\n              ) : (\n                <XCircle className=\"h-4 w-4 text-red-500\" />\n              )}\n            </div>\n          </div>\n          {cjStatus.error && (\n            <p className=\"text-xs text-red-500 mb-2\">{cjStatus.error}</p>\n          )}\n          <div className=\"space-y-1 text-sm\">\n            <div className=\"flex justify-between\">\n              <span className=\"text-red-500\">{pendingReview}</span>\n              <span className=\"text-gray-500\">Pending Review</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-amber-500\">{queueCount}</span>\n              <span className=\"text-gray-500\">Ready to Import</span>\n            </div>\n            <div className=\"flex justify-between\">\n              <span className=\"text-green-500\">{importedCount || totalProducts}</span>\n              <span className=\"text-gray-500\">Imported</span>\n            </div>\n          </div>\n          <div className=\"mt-4\">\n            <Link href=\"/admin/import/queue\" className=\"inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-900\">\n              <ArrowRight className=\"h-4 w-4\" />\n              View Queue\n            </Link>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-2 gap-4\">\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"font-semibold text-gray-900\">Recent Jobs</h3>\n            <Link href=\"/admin/jobs\" className=\"text-sm text-amber-600 hover:text-amber-700\">View All</Link>\n          </div>\n          {jobs && jobs.length > 0 ? (\n            <div className=\"space-y-3\">\n              {jobs.map((job: any) => (\n                <div key={job.id} className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-gray-600\">{job.action}</span>\n                  <span className={`px-2 py-0.5 rounded text-xs ${\n                    job.status === \"success\" ? \"bg-green-100 text-green-700\" :\n                    job.status === \"partial\" ? \"bg-amber-100 text-amber-700\" :\n                    \"bg-red-100 text-red-700\"\n                  }`}>\n                    {job.status}\n                  </span>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-400 text-center py-4\">No jobs run yet</p>\n          )}\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h3 className=\"font-semibold text-gray-900\">Recent Orders</h3>\n            <Link href=\"/admin/orders\" className=\"text-sm text-amber-600 hover:text-amber-700\">View All</Link>\n          </div>\n          {orders && orders.length > 0 ? (\n            <div className=\"space-y-3\">\n              {orders.map((order: any) => (\n                <div key={order.id} className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-gray-600\">Order #{order.id.slice(0, 8)}</span>\n                  <span className=\"text-gray-900 font-medium\">SAR {order.total}</span>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-400 text-center py-4\">No orders yet</p>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12827,"size_tokens":null},"tests/example.spec.ts":{"content":"import { test, expect } from '@playwright/test';\n\ntest('has title', async ({ page }) => {\n  await page.goto('https://playwright.dev/');\n\n  // Expect a title \"to contain\" a substring.\n  await expect(page).toHaveTitle(/Playwright/);\n});\n\ntest('get started link', async ({ page }) => {\n  await page.goto('https://playwright.dev/');\n\n  // Click the get started link.\n  await page.getByRole('link', { name: 'Get started' }).click();\n\n  // Expects page to have a heading with the name of Installation.\n  await expect(page.getByRole('heading', { name: 'Installation' })).toBeVisible();\n});\n","path":null,"size_bytes":583,"size_tokens":null},"src/lib/jobs.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport { hasTable } from '@/lib/db-features';\n\nexport type JobKind = 'finder' | 'import' | 'sync' | 'scanner';\nexport type JobStatus = 'pending' | 'running' | 'success' | 'error' | 'canceled';\nexport type JobItemStatus = 'pending' | 'running' | 'success' | 'error' | 'skipped' | 'canceled';\n\nfunction getAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function ensureJobsTables(): Promise<boolean> {\n  const hasJobs = await hasTable('admin_jobs');\n  if (!hasJobs) return false;\n  const hasItems = await hasTable('admin_job_items');\n  return hasItems;\n}\n\nexport async function patchJob(id: number, patch: Partial<{ params: any; totals: any; status: JobStatus; started_at: string; finished_at: string; error_text: string }>): Promise<boolean> {\n  const db = getAdmin();\n  if (!db) return false;\n  const { error } = await db\n    .from('admin_jobs')\n    .update(patch as any)\n    .eq('id', id);\n  return !error;\n}\n\nexport async function createJob(kind: JobKind, params?: any): Promise<{ id: number } | null> {\n  const db = getAdmin();\n  if (!db) return null;\n  const { data, error } = await db\n    .from('admin_jobs')\n    .insert({ kind, status: 'pending', params: params || null })\n    .select('id')\n    .single();\n  if (error || !data) return null;\n  return { id: data.id as number };\n}\n\nexport async function startJob(id: number): Promise<boolean> {\n  const db = getAdmin();\n  if (!db) return false;\n  const { error } = await db\n    .from('admin_jobs')\n    .update({ status: 'running', started_at: new Date().toISOString() })\n    .eq('id', id);\n  return !error;\n}\n\nexport async function finishJob(id: number, status: Exclude<JobStatus, 'pending' | 'running'>, totals?: any, errorText?: string): Promise<boolean> {\n  const db = getAdmin();\n  if (!db) return false;\n  const { error } = await db\n    .from('admin_jobs')\n    .update({ status, finished_at: new Date().toISOString(), totals: totals || null, error_text: errorText || null })\n    .eq('id', id);\n  return !error;\n}\n\nexport async function addJobItem(jobId: number, input: {\n  status?: JobItemStatus;\n  step?: string | null;\n  cj_product_id?: string | null;\n  cj_sku?: string | null;\n  result?: any;\n  error_text?: string | null;\n}): Promise<{ id: number } | null> {\n  const db = getAdmin();\n  if (!db) return null;\n  const row = {\n    job_id: jobId,\n    status: input.status || 'pending',\n    step: input.step || null,\n    cj_product_id: input.cj_product_id || null,\n    cj_sku: input.cj_sku || null,\n    result: input.result || null,\n    error_text: input.error_text || null,\n  };\n  const { data, error } = await db\n    .from('admin_job_items')\n    .insert(row)\n    .select('id')\n    .single();\n  if (error || !data) return null;\n  return { id: data.id as number };\n}\n\nexport async function updateJobItem(id: number, patch: Partial<{ status: JobItemStatus; step: string | null; result: any; error_text: string | null; started_at: string; finished_at: string }>): Promise<boolean> {\n  const db = getAdmin();\n  if (!db) return false;\n  const { error } = await db\n    .from('admin_job_items')\n    .update(patch as any)\n    .eq('id', id);\n  return !error;\n}\n\nexport async function cancelJob(id: number): Promise<boolean> {\n  const db = getAdmin();\n  if (!db) return false;\n  const { error } = await db\n    .from('admin_jobs')\n    .update({ status: 'canceled', finished_at: new Date().toISOString() })\n    .eq('id', id)\n    .neq('status', 'success');\n  return !error;\n}\n\nexport async function getJob(id: number): Promise<any | null> {\n  const db = getAdmin();\n  if (!db) return null;\n  const { data: job } = await db.from('admin_jobs').select('*').eq('id', id).maybeSingle();\n  if (!job) return null;\n  const { data: items } = await db.from('admin_job_items').select('*').eq('job_id', id).order('id', { ascending: true });\n  return { job, items: items || [] };\n}\n\nexport async function listJobs(limit = 50): Promise<{ jobs: any[]; tablesMissing?: boolean }> {\n  const db = getAdmin();\n  if (!db) return { jobs: [], tablesMissing: true };\n  const tablesExist = await ensureJobsTables();\n  if (!tablesExist) return { jobs: [], tablesMissing: true };\n  const { data } = await db\n    .from('admin_jobs')\n    .select('id, created_at, kind, status, started_at, finished_at, totals, error_text')\n    .order('created_at', { ascending: false })\n    .limit(limit);\n  return { jobs: data || [] };\n}\n\nexport async function upsertJobItemByPid(jobId: number, cj_product_id: string, input: Partial<{ status: JobItemStatus; step: string | null; result: any; error_text: string | null }>): Promise<{ id: number } | null> {\n  const db = getAdmin();\n  if (!db) return null;\n  const { data: exist } = await db\n    .from('admin_job_items')\n    .select('id')\n    .eq('job_id', jobId)\n    .eq('cj_product_id', cj_product_id)\n    .maybeSingle();\n  if (exist?.id) {\n    const { error } = await db\n      .from('admin_job_items')\n      .update({\n        status: input.status || 'pending',\n        step: typeof input.step === 'undefined' ? null : input.step,\n        result: typeof input.result === 'undefined' ? null : input.result,\n        error_text: typeof input.error_text === 'undefined' ? null : input.error_text,\n      } as any)\n      .eq('id', exist.id);\n    if (error) return null;\n    return { id: exist.id as number };\n  }\n  return await addJobItem(jobId, { status: input.status || 'pending', step: input.step || null, cj_product_id, cj_sku: undefined, result: input.result || null, error_text: input.error_text || null });\n}\n","path":null,"size_bytes":5697,"size_tokens":null},"src/components/breadcrumbs.tsx":{"content":"import Link from \"next/link\";\nimport { type Route } from \"next\";\n\nexport type Crumb = { name: string; href?: Route };\n\nexport default function Breadcrumbs({ items }: { items: Crumb[] }) {\n  return (\n    <nav aria-label=\"Breadcrumb\" className=\"mb-4 text-sm text-muted-foreground\">\n      <ol className=\"flex flex-wrap items-center gap-2\">\n        {items.map((item, idx) => (\n          <li key={idx} className=\"flex items-center gap-2\">\n            {idx > 0 && <span className=\"opacity-50\">/</span>}\n            {item.href ? (\n              <Link className=\"hover:text-foreground\" href={item.href}>{item.name}</Link>\n            ) : (\n              <span className=\"text-foreground\">{item.name}</span>\n            )}\n          </li>\n        ))}\n      </ol>\n    </nav>\n  );\n}\n","path":null,"size_bytes":772,"size_tokens":null},"src/app/account/orders/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Finding your orders...\" />;\n}\n","path":null,"size_bytes":157,"size_tokens":null},"src/lib/payment-actions.ts":{"content":"\"use server\";\n\n// Deprecated: use '@/lib/checkout-actions' instead. This module re-exports the canonical action\n// to avoid duplicate implementations that can drift over time.\nexport { createCheckoutSession } from \"./checkout-actions\";\n","path":null,"size_bytes":236,"size_tokens":null},"src/lib/security-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\n\nexport async function updatePassword(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/security\");\n\n  const newPassword = String(formData.get(\"new_password\") || \"\");\n  const confirmPassword = String(formData.get(\"confirm_password\") || \"\");\n\n  if (newPassword.length < 8) {\n    throw new Error(\"Password must be at least 8 characters.\");\n  }\n  if (newPassword !== confirmPassword) {\n    throw new Error(\"Passwords do not match.\");\n  }\n\n  const { error } = await supabase.auth.updateUser({ password: newPassword });\n  if (error) {\n    console.error(\"updatePassword error\", error);\n    throw new Error(error.message || \"Failed to update password.\");\n  }\n  revalidatePath(\"/account/security\");\n}\n","path":null,"size_bytes":1055,"size_tokens":null},"src/lib/ops/cj-fulfill.ts":{"content":"import { createClient } from '@supabase/supabase-js';\nimport { CjApi } from '@/lib/cj/api';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nfunction isCjConfigured(): boolean {\n  return !!(process.env.CJ_APP_KEY && process.env.CJ_APP_SECRET && (process.env.CJ_API_BASE || process.env.CJ_API_BASE_SANDBOX));\n}\n\nexport async function maybeCreateCjOrderForOrderId(orderId: number): Promise<{ ok: boolean; info?: any; reason?: string }>{\n  if (!isCjConfigured()) {\n    return { ok: false, reason: 'CJ API not configured' };\n  }\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return { ok: false, reason: 'Supabase not configured' };\n\n  // 1) Load order\n  const { data: order, error: orderErr } = await supabase\n    .from('orders')\n    .select('id, user_id, total_amount, status')\n    .eq('id', orderId)\n    .single();\n  if (orderErr || !order) return { ok: false, reason: 'Order not found' };\n\n  // 2) Load order items (include variant_id)\n  const { data: items, error: itemsErr } = await supabase\n    .from('order_items')\n    .select('product_id, variant_id, quantity, price')\n    .eq('order_id', orderId);\n  if (itemsErr || !items || items.length === 0) return { ok: false, reason: 'No order items' };\n\n  // 3) Load minimal product info (title, slug) used as fallback SKU mapping\n  const productIds = items.map((i) => i.product_id);\n  const { data: products, error: prodErr } = await supabase\n    .from('products')\n    .select('id, title, slug')\n    .in('id', productIds);\n  if (prodErr) {\n    // Non-fatal; continue with minimal mapping\n  }\n  const productMap = new Map<number, { title: string; slug: string }>();\n  for (const p of products || []) productMap.set(p.id, { title: p.title, slug: p.slug });\n\n  // 3b) Load variant info for those items that have variant_id (to extract cj_sku)\n  const variantIds = items.map((i) => i.variant_id).filter((v: any) => v !== null && v !== undefined) as number[];\n  let variantMap = new Map<number, { cj_sku: string | null; option_name: string | null; option_value: string | null }>();\n  if (variantIds.length > 0) {\n    const { data: variants } = await supabase\n      .from('product_variants')\n      .select('id, cj_sku, option_name, option_value')\n      .in('id', variantIds);\n    for (const v of variants || []) {\n      variantMap.set(v.id, { cj_sku: v.cj_sku, option_name: v.option_name, option_value: v.option_value });\n    }\n  }\n\n  // 4) Load recipient (default address of user)\n  const { data: addr } = await supabase\n    .from('addresses')\n    .select('full_name, phone, line1, line2, city, state, postal_code, country, is_default')\n    .eq('user_id', order.user_id)\n    .order('is_default', { ascending: false })\n    .limit(1)\n    .maybeSingle();\n\n  if (!addr) return { ok: false, reason: 'Missing recipient address; cannot create CJ order yet' };\n\n  // 5) Build CJ payload (placeholder structure; adjust to CJ docs when provided)\n  const payload = {\n    orderNo: `SHOPIXO-${order.id}-${Date.now()}`,\n    recipient: {\n      name: addr.full_name,\n      phone: addr.phone,\n      country: addr.country,\n      state: addr.state,\n      city: addr.city,\n      address1: addr.line1,\n      address2: addr.line2,\n      postalCode: addr.postal_code,\n    },\n    // Choose service code once provided by CJ (e.g., 'KSA_DDP_ECONOMY')\n    serviceCode: 'KSA_DDP_ECONOMY',\n    // Packaging instructions\n    packaging: {\n      neutral: true,\n      includePackingSlip: true,\n      includeThankYouCard: true,\n    },\n    items: items.map((it) => {\n      const meta = productMap.get(it.product_id as number);\n      const vmeta = (it as any).variant_id ? variantMap.get((it as any).variant_id) : null;\n      const sku = vmeta?.cj_sku || meta?.slug || String(it.product_id);\n      const optionLabel = vmeta?.option_value ? ` (${vmeta.option_value})` : '';\n      return {\n        sku,\n        name: (meta?.title || `Product ${it.product_id}`) + optionLabel,\n        quantity: it.quantity,\n      };\n    }),\n  };\n\n  const cj = new CjApi();\n  try {\n    const res = await cj.createOrder(payload);\n    try {\n      const cjOrderNo = res?.orderNo || res?.order_no || res?.id || res?.data?.orderNo || null;\n      if (cjOrderNo) {\n        await supabase\n          .from('orders')\n          .update({ cj_order_no: String(cjOrderNo), shipping_status: 'created' })\n          .eq('id', orderId);\n      }\n    } catch (e) {\n      // Best-effort: do not fail the main call\n      console.warn('Failed to persist CJ order number:', e);\n    }\n    return { ok: true, info: res };\n  } catch (e: any) {\n    return { ok: false, reason: e?.message || 'CJ create order failed' };\n  }\n}\n","path":null,"size_bytes":4749,"size_tokens":null},"src/app/account/security/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading security settings...\" />;\n}\n","path":null,"size_bytes":163,"size_tokens":null},"src/app/privacy-policy/page.tsx":{"content":"export const metadata = {\n  title: \"Privacy Policy | Shopixo\",\n  description: \"Learn how we collect, use, and protect your personal data at Shopixo.\",\n};\n\nexport default function PrivacyPolicyPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Privacy Policy</h1>\n      <p className=\"mt-4 text-slate-700\">\n        <strong>Shopixo</strong> respects your privacy and is committed to protecting your personal data. This policy explains\n        the types of information we collect, how we use and share it, and your choices regarding it.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Information We Collect</h2>\n      <ul className=\"list-disc pl-6 mt-3 text-slate-700 space-y-2\">\n        <li>Account information: Name, email, phone number (if provided), profile picture.</li>\n        <li>Order and payment information: Order details and shipping addresses. We do not store payment card data on our servers.</li>\n        <li>Usage data: Login records, pages you visit, and cookies for analytics and performance improvement.</li>\n      </ul>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">How We Use Your Information</h2>\n      <ul className=\"list-disc pl-6 mt-3 text-slate-700 space-y-2\">\n        <li>Providing services, creating accounts, and processing orders.</li>\n        <li>Improvement, fraud prevention, and technical support.</li>\n        <li>Sending account or order-related notifications (you can unsubscribe from marketing emails).</li>\n      </ul>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Cookies</h2>\n      <p className=\"mt-3 text-slate-700\">\n        We use cookies and similar technologies to enable login functionality, save your shopping cart,\n        and for analytics. You can control cookies through your browser settings, but disabling them may affect some features.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Sharing Information</h2>\n      <p className=\"mt-3 text-slate-700\">\n        We may share your data with trusted service providers only to the extent necessary to provide our services (such as payment providers,\n        shipping companies, and analytics), with adherence to protection and confidentiality measures. We will not sell your personal information to third parties.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Payment Services</h2>\n      <p className=\"mt-3 text-slate-700\">\n        Payments are processed by secure external providers; we do not store payment card numbers on our servers.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Your Rights</h2>\n      <ul className=\"list-disc pl-6 mt-3 text-slate-700 space-y-2\">\n        <li>Access, update, and correct your data.</li>\n        <li>Request data deletion according to our deletion policy: <a className=\"text-primary underline\" href=\"/data-deletion\">/data-deletion</a>.</li>\n        <li>Object to certain processing where legally possible.</li>\n      </ul>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Data Retention</h2>\n      <p className=\"mt-3 text-slate-700\">\n        We retain data as long as necessary to provide our services, comply with legal obligations, prevent fraud, and resolve disputes.\n      </p>\n\n      <h2 className=\"mt-8 text-xl font-semibold\">Contact Us</h2>\n      <p className=\"mt-3 text-slate-700\">\n        For any privacy-related inquiries, you can contact us at: {\" \"}\n        <a className=\"text-primary underline\" href=\"mailto:support@shopixo.com\">support@shopixo.com</a>\n      </p>\n\n      <p className=\"mt-10 text-xs text-slate-500\">Last updated: September 14, 2025</p>\n    </div>\n  );\n}\n","path":null,"size_bytes":3638,"size_tokens":null},"src/lib/cj/v2.ts":{"content":"import { createClient } from '@supabase/supabase-js';\nimport { loadToken, saveToken } from '@/lib/integration/token-store';\nimport { fetchJson } from '@/lib/http';\nimport { getSetting } from '@/lib/settings';\n\n// CJ v2 client with token auth per official docs:\n// - POST /authentication/getAccessToken { apiKey }\n// The apiKey format is: CJUserNum@api@xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx\n// Token lives 15 days; refresh token 180 days; getAccessToken limited to once/5 minutes.\n\n// ============================================================================\n// GLOBAL RATE LIMITER FOR CJ API (1 request/second limit)\n// Uses Redis for cross-process coordination + in-memory fallback\n// ============================================================================\nimport { Ratelimit } from '@upstash/ratelimit';\nimport { Redis } from '@upstash/redis';\n\n// In-memory fallback for single-process rate limiting\nlet lastCjRequestTime = 0;\nconst CJ_REQUEST_INTERVAL_MS = 1100; // 1.1 seconds to be safe\nconst CJ_MAX_WAIT_MS = 55000; // 55 second timeout (CJ API timeout)\n\n// Initialize Redis-backed rate limiter (if Redis is available)\nlet redisRateLimiter: Ratelimit | null = null;\ntry {\n  if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {\n    const redis = new Redis({\n      url: process.env.UPSTASH_REDIS_REST_URL,\n      token: process.env.UPSTASH_REDIS_REST_TOKEN,\n    });\n    redisRateLimiter = new Ratelimit({\n      redis,\n      limiter: Ratelimit.fixedWindow(1, '1 s'), // 1 request per second\n      prefix: 'cj-api-ratelimit',\n    });\n  }\n} catch (e) {\n  console.warn('[CJ RateLimiter] Failed to initialize Redis rate limiter, using in-memory fallback');\n}\n\n/**\n * Wait if needed to respect CJ's 1 request/second rate limit.\n * Uses Redis for cross-process coordination, with in-memory fallback.\n * @returns true if rate limit was acquired, false if timed out\n */\nexport async function waitForCjRateLimit(): Promise<boolean> {\n  const startTime = Date.now();\n  \n  // Try Redis-backed rate limiting first (for cross-process coordination)\n  if (redisRateLimiter) {\n    while (Date.now() - startTime < CJ_MAX_WAIT_MS) {\n      try {\n        const { success, remaining, reset } = await redisRateLimiter.limit('cj-inventory');\n        if (success) {\n          // Also update local timestamp for extra safety\n          lastCjRequestTime = Date.now();\n          return true;\n        }\n        // Calculate wait time until reset\n        const waitMs = Math.min(reset - Date.now(), CJ_REQUEST_INTERVAL_MS);\n        if (waitMs > 0) {\n          await new Promise(r => setTimeout(r, waitMs));\n        }\n      } catch (e) {\n        console.warn('[CJ RateLimiter] Redis error, falling back to in-memory:', e);\n        break; // Fall through to in-memory limiter\n      }\n    }\n  }\n  \n  // In-memory fallback (single-process coordination)\n  const now = Date.now();\n  const elapsed = now - lastCjRequestTime;\n  if (elapsed < CJ_REQUEST_INTERVAL_MS) {\n    const waitTime = CJ_REQUEST_INTERVAL_MS - elapsed;\n    if (Date.now() - startTime + waitTime >= CJ_MAX_WAIT_MS) {\n      console.warn('[CJ RateLimiter] Timeout waiting for rate limit slot');\n      return false;\n    }\n    await new Promise(r => setTimeout(r, waitTime));\n  }\n  lastCjRequestTime = Date.now();\n  return true;\n}\n\n// ============================================================================\n\ntype CjConfig = { email?: string | null; apiKey?: string | null; base?: string | null };\n\nasync function getCjApiKey(): Promise<string | null> {\n  // Prefer env; if missing, attempt kv_settings (key: 'cj_config')\n  const envKey = process.env.CJ_API_KEY || null;\n  if (envKey) return envKey;\n  try {\n    const cfg = await getSetting<CjConfig>('cj_config', undefined);\n    const apiKey = (cfg?.apiKey || null) as string | null;\n    if (apiKey) return apiKey;\n  } catch {}\n  return envKey;\n}\n\n// Keep legacy function for backward compatibility\nasync function getCjCreds(): Promise<{ email: string | null; apiKey: string | null }> {\n  const apiKey = await getCjApiKey();\n  const envEmail = process.env.CJ_EMAIL || null;\n  return { email: envEmail, apiKey };\n}\n\nexport async function listCjProductsPage(params: { pageNum: number; pageSize?: number; keyword?: string }): Promise<any> {\n  const pageNum = Math.max(1, Math.floor(params.pageNum || 1));\n  const pageSize = Math.min(50, Math.max(1, Math.floor(params.pageSize ?? 20)));\n  const kw = params.keyword ? String(params.keyword) : '';\n  const qsList = `keyWords=${encodeURIComponent(kw)}&pageSize=${pageSize}&pageNum=${pageNum}`;\n  const qsQuery = `keyword=${encodeURIComponent(kw)}&pageSize=${pageSize}&pageNumber=${pageNum}`;\n\n  const endpoints = [\n    `/product/list?${qsList}`,\n    `/product/query?${qsQuery}`,\n    `/product/myProduct/query?${qsQuery}`,\n  ];\n\n  const out: any[] = [];\n  const seen = new Set<string>();\n  let lastErr: any = null;\n  for (const ep of endpoints) {\n    try {\n      const r = await cjFetch<any>(ep);\n      const arr = Array.isArray(r?.data?.list)\n        ? r.data.list\n        : Array.isArray(r?.data?.content)\n          ? r.data.content\n          : Array.isArray(r?.list)\n            ? r.list\n            : Array.isArray(r?.data)\n              ? r.data\n              : Array.isArray(r)\n                ? r\n                : [];\n      for (const it of arr) {\n        const pid = String(it?.pid || it?.productId || it?.id || '');\n        const key = pid || JSON.stringify(it).slice(0, 120);\n        if (!seen.has(key)) { seen.add(key); out.push(it); }\n        if (out.length >= pageSize) break;\n      }\n      if (out.length >= pageSize) break;\n    } catch (e) {\n      lastErr = e;\n    }\n  }\n  if (out.length === 0 && lastErr) throw lastErr;\n  return { code: 200, data: { list: out } };\n}\n\n// --- Freight / Shipping ---\n// Uses CJ's \"According to Shipping Method\" feature - exact pre-calculated shipping options\n// Calls POST /logistic/freightCalculate with variant ID (vid) to get exact CJ pricing\nexport type CjFreightCalcParams = {\n  countryCode: string; // e.g., 'US' - destination country\n  startCountryCode?: string; // e.g., 'CN' - origin country (defaults to China)\n  quantity?: number;\n  vid: string; // variant ID (UUID format required for freightCalculate)\n};\n\nexport type CjShippingOption = {\n  code: string;\n  name: string;\n  price: number;\n  currency?: string;\n  logisticAgingDays?: { min?: number; max?: number };\n};\n\nexport type FreightResult = {\n  ok: true;\n  options: CjShippingOption[];\n} | {\n  ok: false;\n  reason: 'invalid_vid' | 'no_options' | 'api_error';\n  message: string;\n};\n\nexport async function freightCalculate(params: CjFreightCalcParams): Promise<FreightResult> {\n  const startCountry = params.startCountryCode || 'CN';\n  const endCountry = params.countryCode || 'US';\n  const vid = params.vid;\n  const qty = params.quantity ?? 1;\n  \n  if (!vid) {\n    return {\n      ok: false,\n      reason: 'invalid_vid',\n      message: 'Variant ID (vid) is required for shipping calculation',\n    };\n  }\n  \n  console.log(`[CJ Freight] Getting \"According to Shipping Method\" for vid=${vid}, qty=${qty}, ${startCountry} → ${endCountry}`);\n  \n  try {\n    // Use CJ's freightCalculate API - this returns the exact \"According to Shipping Method\" data\n    const body = {\n      startCountryCode: startCountry,\n      endCountryCode: endCountry,\n      products: [{ vid, quantity: qty }],\n    };\n    \n    const r = await cjFetch<any>('/logistic/freightCalculate', {\n      method: 'POST',\n      body: JSON.stringify(body),\n    });\n    \n    console.log(`[CJ Freight] Response: ${JSON.stringify(r).slice(0, 2000)}`);\n    \n    const result = parseFreightResponse(r);\n    if (result.ok && result.options.length > 0) {\n      console.log(`[CJ Freight] Got ${result.options.length} shipping options from CJ \"According to Shipping Method\"`);\n      return result;\n    }\n    \n    // No options returned\n    return {\n      ok: false,\n      reason: 'no_options',\n      message: 'CJ returned no shipping options for this variant/destination',\n    };\n  } catch (e: any) {\n    console.error(`[CJ Freight] API error: ${e?.message}`);\n    return {\n      ok: false,\n      reason: 'api_error',\n      message: `CJ shipping API error: ${e?.message || 'Unknown error'}`,\n    };\n  }\n}\n\n// Helper to parse freightCalculate response\nfunction parseFreightResponse(r: any): FreightResult {\n  // Check for CJ API error response first (code !== 200 means error)\n  if (r?.code && r.code !== 200 && r.code !== '200') {\n    const errorMsg = r.message || r.msg || 'Unknown CJ error';\n    console.log(`[CJ Freight] API error response: code=${r.code}, message=${errorMsg}`);\n    return {\n      ok: false,\n      reason: 'api_error',\n      message: `CJ error (${r.code}): ${errorMsg}`,\n    };\n  }\n  \n  const src: any = (r?.data ?? r?.content ?? r ?? []);\n  const out: CjShippingOption[] = [];\n  const arr: any[] = Array.isArray(src) ? src : Array.isArray(src?.list) ? src.list : [];\n  \n  console.log(`[CJ Freight] Raw shipping options from CJ API (${arr.length} items):`);\n  \n  for (const it of arr) {\n    // CJ API returns logisticPrice in USD - this is the exact shipping cost\n    const price = Number(it.logisticPrice || it.price || it.amount || it.totalFee || it.totalPrice || 0);\n    \n    const currency = it.currency || it.ccy || 'USD';\n    const name = String(it.logisticName || it.logisticsName || it.name || it.channelName || it.express || 'Shipping');\n    const code = String(it.logisticCode || it.logisticsType || it.code || it.channel || name);\n    const age = it.logisticAging || it.aging || it.days || null;\n    const aging = typeof age === 'string'\n      ? (() => { const m = age.match(/(\\d+)[^\\d]+(\\d+)/); if (m) return { min: Number(m[1]), max: Number(m[2]) }; const n = age.match(/(\\d+)/); return n ? { min: Number(n[1]) } : undefined; })()\n      : (typeof age === 'number' ? { min: age, max: age } : undefined);\n    \n    // Log each shipping option with exact price from CJ\n    console.log(`[CJ Freight]   - ${name}: $${price.toFixed(2)} USD, delivery: ${age || 'N/A'}`);\n    \n    // Include all options even with price 0 for debugging, but mark them\n    if (price <= 0) {\n      console.log(`[CJ Freight]     ^ Skipping (price <= 0)`);\n      continue;\n    }\n    \n    out.push({ code, name, price, currency, logisticAgingDays: aging });\n  }\n  \n  console.log(`[CJ Freight] Parsed ${out.length} valid shipping options`);\n  \n  if (out.length > 0) {\n    return { ok: true, options: out };\n  }\n  \n  return {\n    ok: false,\n    reason: 'no_options',\n    message: 'No shipping options returned',\n  };\n}\n\n// Helper to find CJPacket Ordinary from shipping options\nexport function findCJPacketOrdinary(options: CjShippingOption[]): CjShippingOption | undefined {\n  // Normalize function: lowercase, remove all non-letter characters\n  const normalize = (s: string) => s.toLowerCase().replace(/[^a-z]/g, '');\n  \n  // We're looking for anything that contains \"cjpacketordinary\" when normalized\n  // This handles: \"CJPacket Ordinary\", \"CJ Packet Ordinary\", \"CJ Packet Ordinary USPS\", \n  // \"CJPacket Ordinary+\", \"CJ-Packet-Ordinary\", etc.\n  const TARGET = 'cjpacketordinary';\n  \n  for (const option of options) {\n    const normalizedName = normalize(option.name);\n    const normalizedCode = normalize(option.code);\n    \n    if (normalizedName.includes(TARGET) || normalizedCode.includes(TARGET)) {\n      console.log(`[CJ Freight] Selected CJPacket Ordinary: $${option.price.toFixed(2)} USD (${option.name})`);\n      return option;\n    }\n  }\n  \n  // Log available options if CJPacket Ordinary not found\n  console.log(`[CJ Freight] CJPacket Ordinary NOT FOUND. Available options:`);\n  for (const o of options) {\n    console.log(`[CJ Freight]   - ${o.name} (code: ${o.code}): $${o.price.toFixed(2)}`);\n  }\n  \n  return undefined;\n}\n\n// --- Product Inventory by PID ---\n// Uses CJ's dedicated inventory API: GET /product/stock/getInventoryByPid\n// Returns warehouse-level stock breakdown (CJ warehouse vs Factory)\nexport type CjWarehouseInventory = {\n  areaId: number;\n  areaName: string;\n  countryCode: string;\n  totalInventory: number;\n  cjInventory: number;\n  factoryInventory: number;\n};\n\nexport type CjProductInventory = {\n  pid: string;\n  totalCJ: number;\n  totalFactory: number;\n  totalAvailable: number;\n  warehouses: CjWarehouseInventory[];\n};\n\nexport async function getInventoryByPid(pid: string): Promise<CjProductInventory | null> {\n  const token = await getAccessToken();\n  const base = await resolveBase();\n  \n  console.log(`[CJ Inventory] Fetching inventory for pid=${pid}`);\n  \n  try {\n    const url = `${base}/product/stock/getInventoryByPid?pid=${encodeURIComponent(pid)}`;\n    const res = await fetchJson<any>(url, {\n      method: 'GET',\n      headers: {\n        'CJ-Access-Token': token,\n      },\n      cache: 'no-store',\n      timeoutMs: 10000,\n    });\n    \n    console.log(`[CJ Inventory] Response for ${pid}:`, JSON.stringify(res).slice(0, 1000));\n    \n    // CJ API returns code as either number 200 or string \"200\" - handle both\n    const isSuccess = res && (res.code === 200 || res.code === '200' || String(res.code) === '200');\n    if (!isSuccess || !res.data) {\n      console.log(`[CJ Inventory] No inventory data returned for ${pid} (code: ${res?.code})`);\n      return null;\n    }\n    \n    const data = res.data;\n    const inventories = data.inventories || [];\n    \n    let totalCJ = 0;\n    let totalFactory = 0;\n    const warehouses: CjWarehouseInventory[] = [];\n    \n    for (const inv of inventories) {\n      const cjInv = Number(inv.cjInventoryNum || inv.cjInventory || 0);\n      const factoryInv = Number(inv.factoryInventoryNum || inv.factoryInventory || 0);\n      const totalInv = Number(inv.totalInventoryNum || inv.totalInventory || cjInv + factoryInv);\n      \n      totalCJ += cjInv;\n      totalFactory += factoryInv;\n      \n      warehouses.push({\n        areaId: Number(inv.areaId || 0),\n        areaName: inv.areaEn || inv.countryNameEn || inv.area || 'Unknown',\n        countryCode: inv.countryCode || '',\n        totalInventory: totalInv,\n        cjInventory: cjInv,\n        factoryInventory: factoryInv,\n      });\n    }\n    \n    const result: CjProductInventory = {\n      pid,\n      totalCJ,\n      totalFactory,\n      totalAvailable: totalCJ + totalFactory,\n      warehouses,\n    };\n    \n    console.log(`[CJ Inventory] Parsed for ${pid}: total=${result.totalAvailable} (CJ=${totalCJ}, Factory=${totalFactory}), warehouses=${warehouses.length}`);\n    \n    return result;\n  } catch (e: any) {\n    console.error(`[CJ Inventory] Error fetching inventory for ${pid}:`, e?.message);\n    return null;\n  }\n}\n\n// - POST /authentication/refreshAccessToken { refreshToken }\n// Token lives 15 days; refresh token 180 days; getAccessToken limited to once/5 minutes.\n// Env vars supported:\n// - CJ_API_BASE (optional; default: https://developers.cjdropshipping.com/api2.0/v1)\n// - CJ_ACCESS_TOKEN (optional manual override)\n// - CJ_EMAIL (required if no CJ_ACCESS_TOKEN)\n// - CJ_API_KEY (required if no CJ_ACCESS_TOKEN)\n\n// --- Variant Inventory Query ---\nexport type CjVariantInventory = {\n  variantSku: string;\n  variantName?: string;\n  vid?: string;           // CJ's variant ID (vid)\n  variantId?: string;     // Alternative variant ID field\n  variantKey?: string;    // Variant key (e.g., \"White-L\")\n  price: number;\n  cjStock: number; // CJ warehouse stock\n  factoryStock: number; // Factory/supplier stock\n  totalStock: number;\n};\n\nexport async function queryVariantInventory(pid: string, warehouse?: string): Promise<CjVariantInventory[]> {\n  const token = await getAccessToken();\n  const base = await resolveBase();\n  \n  const toSafeNumber = (val: any, fallback = 0): number => {\n    if (val === undefined || val === null || val === '') return fallback;\n    const num = typeof val === 'number' ? val : Number(val);\n    return isNaN(num) ? fallback : num;\n  };\n  \n  let allVariants: CjVariantInventory[] = [];\n  const stockBySku: Map<string, { cjStock: number; factoryStock: number }> = new Map();\n  // Store original stockList items for fallback variant building\n  let stockListItems: any[] = [];\n  \n  try {\n    // Try the newer /product/stock/queryByPid endpoint first (better per-variant data)\n    // This is a GET request with pid as query parameter\n    let stockRes: any = null;\n    \n    try {\n      stockRes = await fetchJson<any>(`${base}/product/stock/queryByPid?pid=${encodeURIComponent(pid)}`, {\n        method: 'GET',\n        headers: {\n          'CJ-Access-Token': token,\n        },\n        cache: 'no-store',\n        timeoutMs: 15000,\n      });\n      console.log(`[CJ Inventory] Used /product/stock/queryByPid for ${pid}`);\n    } catch (e: any) {\n      console.log(`[CJ Inventory] /product/stock/queryByPid failed, trying /inventory/queryVariantStock: ${e?.message}`);\n      \n      // Fallback to old endpoint\n      const inventoryBody: any = { pid };\n      if (warehouse) inventoryBody.warehouseId = warehouse;\n      \n      stockRes = await fetchJson<any>(`${base}/inventory/queryVariantStock`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'CJ-Access-Token': token,\n        },\n        body: JSON.stringify(inventoryBody),\n        cache: 'no-store',\n        timeoutMs: 15000,\n      });\n    }\n    \n    console.log(`[CJ Inventory] Response for ${pid}:`, JSON.stringify(stockRes).slice(0, 3000));\n    console.log(`[CJ Inventory] Full data structure for ${pid}:`, JSON.stringify(stockRes?.data, null, 2)?.slice(0, 5000));\n    \n    // Log first 3 raw variants to see exact field names CJ provides\n    const rawVariants = stockRes?.data?.variantInventories || stockRes?.data?.variantStocks || [];\n    if (Array.isArray(rawVariants) && rawVariants.length > 0) {\n      console.log(`[CJ Inventory DEBUG] Raw variant fields for ${pid}:`);\n      for (let i = 0; i < Math.min(3, rawVariants.length); i++) {\n        const v = rawVariants[i];\n        console.log(`  Variant ${i + 1}: ${JSON.stringify(v)}`);\n        console.log(`  Fields: variantKey=\"${v.variantKey}\", variantName=\"${v.variantName}\", variantNameEn=\"${v.variantNameEn}\", variantSku=\"${v.variantSku}\", vid=\"${v.vid}\"`);\n        console.log(`  Stock fields: cjInventory=${v.cjInventory}, factoryInventory=${v.factoryInventory}, inventory=${JSON.stringify(v.inventory)}`);\n      }\n    } else {\n      console.log(`[CJ Inventory DEBUG] No variantInventories or variantStocks in response for ${pid}`);\n    }\n    \n    const stockData = stockRes?.data;\n    \n    // CJ API getInventoryByPid returns:\n    // {\n    //   data: {\n    //     inventories: [...],  // Product-level by warehouse\n    //     variantInventories: [  // Per-variant inventory\n    //       { vid: \"variant-id\", inventory: [{ cjInventory, factoryInventory, totalInventory }] }\n    //     ]\n    //   }\n    // }\n    let stockList: any[] = [];\n    \n    // Normalize key helper\n    const normalizeKey = (s: any): string => {\n      if (s === undefined || s === null) return '';\n      const str = String(s).trim();\n      if (!str) return '';\n      return str.toLowerCase().replace(/[\\s\\-_\\.]/g, '');\n    };\n    \n    // Check for CJ's standard variantInventories format first\n    if (stockData?.variantInventories && Array.isArray(stockData.variantInventories)) {\n      console.log(`[CJ Inventory] Found variantInventories array with ${stockData.variantInventories.length} variants`);\n      \n      for (const vi of stockData.variantInventories) {\n        const vid = vi.vid || vi.variantId || '';\n        const variantSku = vi.variantSku || vi.sku || '';\n        const variantName = vi.variantName || vi.variantNameEn || vi.variantKey || '';\n        const price = toSafeNumber(vi.variantSellPrice || vi.sellPrice || vi.price, 0);\n        \n        // Sum up inventory across all warehouses for this variant\n        let cjTotal = 0;\n        let factoryTotal = 0;\n        let rawTotal = 0; // Total from totalInventory field (when CJ/Factory breakdown not available)\n        \n        const inventoryArr = vi.inventory || [];\n        if (Array.isArray(inventoryArr)) {\n          for (const inv of inventoryArr) {\n            // Try to get CJ and Factory breakdown\n            const cjInv = toSafeNumber(inv.cjInventory || inv.cjStock || 0);\n            const factoryInv = toSafeNumber(inv.factoryInventory || inv.factoryStock || 0);\n            cjTotal += cjInv;\n            factoryTotal += factoryInv;\n            \n            // Also track totalInventory as fallback\n            const total = toSafeNumber(inv.totalInventory || inv.total || 0);\n            if (cjInv === 0 && factoryInv === 0 && total > 0) {\n              // Check warehouse type to classify\n              const countryCode = String(inv.countryCode || '').toUpperCase();\n              const warehouseType = String(inv.warehouseType || inv.type || '').toLowerCase();\n              const verifiedWarehouse = toSafeNumber(inv.verifiedWarehouse, 0);\n              \n              // CJ warehouses are typically verifiedWarehouse=1, outside China\n              if (verifiedWarehouse === 1 || warehouseType.includes('cj') || warehouseType.includes('overseas')) {\n                cjTotal += total;\n              } else if (countryCode === 'CN' || warehouseType.includes('factory') || verifiedWarehouse === 2) {\n                // China warehouse or factory = supplier stock\n                factoryTotal += total;\n              } else {\n                // Unknown - treat as factory stock (safer assumption)\n                factoryTotal += total;\n              }\n            }\n          }\n        }\n        \n        // Also check direct fields as fallback\n        if (cjTotal === 0 && factoryTotal === 0) {\n          cjTotal = toSafeNumber(vi.cjInventory || vi.cjStock || 0);\n          factoryTotal = toSafeNumber(vi.factoryInventory || vi.factoryStock || 0);\n        }\n        \n        // Final fallback: if still no stock but totalStock exists, treat as factory\n        if (cjTotal === 0 && factoryTotal === 0) {\n          const totalFromVariant = toSafeNumber(vi.totalStock || vi.stock || vi.totalInventory || 0);\n          if (totalFromVariant > 0) {\n            factoryTotal = totalFromVariant;\n          }\n        }\n        \n        const totalStock = cjTotal + factoryTotal;\n        \n        // Create a normalized stock list item for later use\n        stockList.push({\n          vid,\n          variantSku,\n          variantName,\n          variantKey: vi.variantKey || variantName,\n          price,\n          cjStock: cjTotal,\n          factoryStock: factoryTotal,\n          totalStock,\n        });\n        \n        // Store in stockBySku map\n        const possibleKeys = [vid, variantSku, variantName].filter(k => k && String(k).trim());\n        for (const rawKey of possibleKeys) {\n          const rawKeyStr = String(rawKey).trim();\n          if (!stockBySku.has(rawKeyStr)) {\n            stockBySku.set(rawKeyStr, { cjStock: cjTotal, factoryStock: factoryTotal });\n          }\n          const normalized = normalizeKey(rawKeyStr);\n          if (normalized && normalized !== rawKeyStr && !stockBySku.has(normalized)) {\n            stockBySku.set(normalized, { cjStock: cjTotal, factoryStock: factoryTotal });\n          }\n        }\n        \n        if (stockList.length <= 3) {\n          console.log(`[CJ Inventory] Variant ${vid}: CJ=${cjTotal}, Factory=${factoryTotal}, Name=${variantName}`);\n        }\n      }\n    }\n    // Fallback: check for variantStocks array\n    else if (stockData?.variantStocks && Array.isArray(stockData.variantStocks)) {\n      console.log(`[CJ Inventory] Found variantStocks array with ${stockData.variantStocks.length} variants`);\n      \n      for (const vs of stockData.variantStocks) {\n        const vid = vs.vid || vs.variantId || '';\n        const variantSku = vs.variantSku || vs.sku || '';\n        const variantName = vs.variantName || vs.variantNameEn || vs.variantKey || '';\n        const price = toSafeNumber(vs.variantSellPrice || vs.sellPrice || vs.price, 0);\n        \n        // Parse warehouse stocks\n        let cjTotal = 0;\n        let factoryTotal = 0;\n        \n        const warehouseStocks = vs.warehouseStocks || [];\n        if (Array.isArray(warehouseStocks)) {\n          for (const ws of warehouseStocks) {\n            const warehouseType = String(ws.warehouseType || ws.type || '').toLowerCase();\n            const availNum = toSafeNumber(ws.availableNum || ws.availableStock || ws.quantity || 0);\n            if (warehouseType.includes('cj') || warehouseType.includes('overseas')) {\n              cjTotal += availNum;\n            } else {\n              factoryTotal += availNum;\n            }\n          }\n        }\n        \n        // Direct fields fallback\n        if (cjTotal === 0 && factoryTotal === 0) {\n          cjTotal = toSafeNumber(vs.cjInventory || vs.cjStock || 0);\n          factoryTotal = toSafeNumber(vs.factoryInventory || vs.factoryStock || 0);\n        }\n        \n        const totalStock = cjTotal + factoryTotal;\n        \n        stockList.push({\n          vid,\n          variantSku,\n          variantName,\n          variantKey: vs.variantKey || variantName,\n          price,\n          cjStock: cjTotal,\n          factoryStock: factoryTotal,\n          totalStock,\n        });\n        \n        const possibleKeys = [vid, variantSku, variantName].filter(k => k && String(k).trim());\n        for (const rawKey of possibleKeys) {\n          const rawKeyStr = String(rawKey).trim();\n          if (!stockBySku.has(rawKeyStr)) {\n            stockBySku.set(rawKeyStr, { cjStock: cjTotal, factoryStock: factoryTotal });\n          }\n        }\n      }\n    }\n    // Fallback: direct array or other structures\n    else if (Array.isArray(stockData)) {\n      console.log(`[CJ Inventory] Found direct array with ${stockData.length} items`);\n      stockList = stockData;\n    } else if (stockData?.list || stockData?.variants) {\n      stockList = stockData?.list || stockData?.variants || [];\n      console.log(`[CJ Inventory] Found nested list/variants with ${stockList.length} items`);\n    }\n    \n    stockListItems = stockList; // Save for fallback variant building\n    console.log(`[CJ Inventory] Parsed ${stockBySku.size} stock entries from inventory API (from ${stockList.length} items)`);\n  } catch (e: any) {\n    console.error(`[CJ Inventory] Error fetching stock for ${pid}:`, e?.message);\n  }\n  \n  try {\n    const variantRes = await fetchJson<any>(`${base}/product/variant/query?pid=${encodeURIComponent(pid)}`, {\n      headers: {\n        'Content-Type': 'application/json',\n        'CJ-Access-Token': token,\n      },\n      cache: 'no-store',\n      timeoutMs: 15000,\n    });\n    \n    console.log(`[CJ Variants] Response for ${pid}:`, JSON.stringify(variantRes).slice(0, 1500));\n    \n    const variantData = variantRes?.data;\n    const variantList = Array.isArray(variantData) ? variantData : (variantData?.list || variantData?.variants || []);\n    \n    if (Array.isArray(variantList) && variantList.length > 0) {\n      console.log(`[CJ Variants] First variant sample:`, JSON.stringify(variantList[0]));\n    }\n    \n    // Normalize key helper (same as storage)\n    const normalizeKeyForLookup = (s: any): string => {\n      if (s === undefined || s === null) return '';\n      const str = String(s).trim();\n      if (!str) return '';\n      return str.toLowerCase().replace(/[\\s\\-_\\.]/g, '');\n    };\n    \n    // Log first few variants to debug field values\n    if (Array.isArray(variantList) && variantList.length > 0) {\n      console.log(`[CJ Variants DEBUG] First 3 variants for ${pid}:`);\n      for (let i = 0; i < Math.min(3, variantList.length); i++) {\n        const v = variantList[i];\n        console.log(`  #${i + 1}: variantKey=\"${v.variantKey || '(empty)'}\", variantSku=\"${v.variantSku || '(empty)'}\", variantName=\"${v.variantName || '(empty)'}\", variantNameEn=\"${v.variantNameEn || '(empty)'}\", variantSellPrice=${v.variantSellPrice}`);\n      }\n    }\n    \n    for (const v of variantList) {\n      // Capture ALL identifier fields from the response\n      const variantSku = v.variantSku || v.sku || v.skuId || '';\n      const vid = v.vid || '';\n      const variantId = v.variantId || '';\n      // variantKey is the SHORT name like \"Black And Silver-2XL\" - prioritize this!\n      const variantKey = v.variantKey || '';\n      // variantNameEn is typically the full product name with variant - use as fallback\n      const variantNameLong = v.variantName || v.skuName || v.variantNameEn || '';\n      const price = toSafeNumber(v.variantSellPrice || v.sellPrice || v.variantPrice || v.price, 0);\n      \n      // Try matching stock by ANY of the possible keys (both raw and normalized)\n      const rawKeys = [variantSku, vid, variantId, variantKey, variantNameLong].filter(Boolean);\n      const allKeysToTry = [...rawKeys];\n      // Add normalized versions of each key\n      for (const raw of rawKeys) {\n        const normalized = normalizeKeyForLookup(raw);\n        if (normalized && !allKeysToTry.includes(normalized)) {\n          allKeysToTry.push(normalized);\n        }\n      }\n      \n      let stockInfo: { cjStock: number; factoryStock: number } | undefined;\n      \n      for (const key of allKeysToTry) {\n        stockInfo = stockBySku.get(key);\n        if (stockInfo) {\n          console.log(`[CJ Variants] Matched stock for ${variantKey || variantSku} via key: ${key}`);\n          break;\n        }\n      }\n      \n      let cjStock = 0;\n      let factoryStock = 0;\n      \n      if (stockInfo) {\n        cjStock = stockInfo.cjStock;\n        factoryStock = stockInfo.factoryStock;\n      } else {\n        console.log(`[CJ Variants] No stock match for variant, trying direct fields. Keys tried: ${allKeysToTry.join(', ')}`);\n        cjStock = Math.floor(toSafeNumber(v.cjAvailableNum || v.cjStock || v.warehouseStock || v.cjQuantity || 0));\n        factoryStock = Math.floor(toSafeNumber(\n          v.supplierAvailableNum || v.factoryStock || v.factoryAvailableNum || \n          v.inventory || v.supplierStock || v.availableStock || 0\n        ));\n        \n        const totalFromVariant = Math.floor(toSafeNumber(v.stock || v.totalStock || v.quantity || v.availableNum || 0));\n        if (cjStock === 0 && factoryStock === 0 && totalFromVariant > 0) {\n          factoryStock = totalFromVariant;\n        }\n      }\n      \n      // Use the first non-empty identifier as the primary SKU\n      const primarySku = variantSku || vid || variantId || variantKey || '';\n      \n      if (primarySku) {\n        allVariants.push({\n          variantSku: primarySku,\n          // IMPORTANT: Prioritize variantKey (short name like \"Black And Silver-2XL\")\n          // over variantNameLong (full descriptive name)\n          variantName: variantKey || variantNameLong || undefined,\n          vid: vid || undefined,\n          variantId: variantId || undefined,\n          variantKey: variantKey || undefined,\n          price,\n          cjStock,\n          factoryStock,\n          totalStock: cjStock + factoryStock,\n        });\n      }\n    }\n  } catch (e: any) {\n    console.error(`[CJ Variants] Error fetching variants for ${pid}:`, e?.message);\n  }\n  \n  // If variants have no per-variant stock data, query each variant individually\n  // using /product/stock/queryByVid endpoint\n  const variantsNeedStock = allVariants.filter(v => v.cjStock === 0 && v.factoryStock === 0 && v.vid);\n  if (variantsNeedStock.length > 0 && variantsNeedStock.length <= 20) {\n    console.log(`[CJ Variants] Querying per-variant stock for ${variantsNeedStock.length} variants with vid...`);\n    \n    // Query each variant's stock individually (respecting rate limits)\n    for (const variant of variantsNeedStock) {\n      if (!variant.vid) continue;\n      \n      try {\n        // Rate limit: wait between requests\n        await new Promise(r => setTimeout(r, 150)); // 150ms between variant stock queries\n        \n        const vidStockRes = await fetchJson<any>(\n          `${base}/product/stock/queryByVid?vid=${encodeURIComponent(variant.vid)}`,\n          {\n            method: 'GET',\n            headers: { 'CJ-Access-Token': token },\n            cache: 'no-store',\n            timeoutMs: 10000,\n          }\n        );\n        \n        const vidData = vidStockRes?.data;\n        if (vidData) {\n          // Parse the inventory array for this variant\n          const inventoryArr = vidData.variantInventories?.[0]?.inventory || vidData.inventory || [];\n          let cjTotal = 0;\n          let factoryTotal = 0;\n          \n          if (Array.isArray(inventoryArr)) {\n            for (const inv of inventoryArr) {\n              const cjInv = toSafeNumber(inv.cjInventory || inv.cjStock || 0);\n              const factoryInv = toSafeNumber(inv.factoryInventory || inv.factoryStock || 0);\n              cjTotal += cjInv;\n              factoryTotal += factoryInv;\n              \n              // Handle totalInventory when breakdown not available\n              const total = toSafeNumber(inv.totalInventory || inv.total || 0);\n              if (cjInv === 0 && factoryInv === 0 && total > 0) {\n                const countryCode = String(inv.countryCode || '').toUpperCase();\n                const verifiedWarehouse = toSafeNumber(inv.verifiedWarehouse, 0);\n                if (verifiedWarehouse === 1 || countryCode !== 'CN') {\n                  cjTotal += total;\n                } else {\n                  factoryTotal += total;\n                }\n              }\n            }\n          }\n          \n          // Also check direct fields on vidData\n          if (cjTotal === 0 && factoryTotal === 0) {\n            cjTotal = toSafeNumber(vidData.cjInventory || vidData.cjStock || 0);\n            factoryTotal = toSafeNumber(vidData.factoryInventory || vidData.factoryStock || 0);\n          }\n          \n          if (cjTotal > 0 || factoryTotal > 0) {\n            variant.cjStock = cjTotal;\n            variant.factoryStock = factoryTotal;\n            variant.totalStock = cjTotal + factoryTotal;\n            console.log(`[CJ Variants] Got stock for vid ${variant.vid}: CJ=${cjTotal}, Factory=${factoryTotal}`);\n          }\n        }\n      } catch (e: any) {\n        console.log(`[CJ Variants] Failed to get stock for vid ${variant.vid}: ${e?.message}`);\n      }\n    }\n  }\n  \n  // If variant query returned nothing but we have stock data from inventory API,\n  // build variants directly from stockListItems (already pre-parsed with cjStock/factoryStock)\n  if (allVariants.length === 0 && stockListItems.length > 0) {\n    console.log(`[CJ Variants] No variants from query but ${stockListItems.length} stock items available - building from stock data`);\n    \n    for (const v of stockListItems) {\n      // stockListItems is pre-parsed with cjStock/factoryStock from inventory API\n      const cjStock = v.cjStock ?? 0;\n      const factoryStock = v.factoryStock ?? 0;\n      const totalStock = v.totalStock ?? (cjStock + factoryStock);\n      \n      // Skip variants with no stock\n      if (totalStock <= 0) continue;\n      \n      const sku = v.variantSku || v.sku || v.skuId || '';\n      const vid = v.vid || '';\n      const variantId = v.variantId || '';\n      const variantKey = v.variantKey || '';\n      const variantName = v.variantName || v.variantNameEn || '';\n      const price = v.price ?? 0;\n      \n      const primarySku = sku || vid || variantId || variantKey || '';\n      \n      if (primarySku) {\n        allVariants.push({\n          variantSku: primarySku,\n          variantName: variantName || variantKey || undefined,\n          vid: vid || undefined,\n          variantId: variantId || undefined,\n          variantKey: variantKey || undefined,\n          price,\n          cjStock,\n          factoryStock,\n          totalStock,\n        });\n      }\n    }\n    console.log(`[CJ Variants] Built ${allVariants.length} variants from stock data fallback`);\n  }\n  \n  console.log(`[CJ Variants] Final result: ${allVariants.length} variants for ${pid}`);\n  return allVariants;\n}\n\nexport type CjVariantLike = {\n  cjSku?: string;\n  variantKey?: string; // Short variant name from CJ (e.g., \"Black And Silver-2XL\")\n  vid?: string; // CJ variant ID\n  size?: string;\n  color?: string;\n  price?: number;\n  stock?: number;\n  cjStock?: number; // CJ warehouse stock\n  factoryStock?: number; // Factory/supplier stock\n  // Optional shipping metadata when provided by CJ\n  weightGrams?: number; // unit grams if available; undefined if unknown\n  lengthCm?: number;\n  widthCm?: number;\n  heightCm?: number;\n  imageUrl?: string; // optional variant image if provided by CJ\n};\n\nexport type CjProductLike = {\n  productId: string;\n  name: string;\n  images: string[];\n  videoUrl?: string | null;\n  variants: CjVariantLike[];\n  deliveryTimeHours?: number | null; // estimated delivery time in hours (if provided by CJ)\n  processingTimeHours?: number | null; // estimated processing time in hours (if provided by CJ)\n  originArea?: string | null;\n  originCountryCode?: string | null;\n};\n\nlet baseOverride: string | null = null;\nasync function resolveBase(): Promise<string> {\n  if (baseOverride) return baseOverride;\n  const envBase = process.env.CJ_API_BASE || '';\n  if (envBase) return envBase.replace(/\\/$/, '');\n  try {\n    const cfg = await getSetting<CjConfig>('cj_config', undefined);\n    const b = (cfg?.base || '').trim();\n    if (b) {\n      baseOverride = b.replace(/\\/$/, '');\n      return baseOverride;\n    }\n  } catch {}\n  return 'https://developers.cjdropshipping.com/api2.0/v1';\n}\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\ntype TokenState = {\n  accessToken: string;\n  accessTokenExpiry?: string | null;\n  refreshToken?: string | null;\n  refreshTokenExpiry?: string | null;\n  lastAuthCallMs: number; // throttle get/refresh to avoid 5-min rule\n};\n\nlet tokenState: TokenState | null = null;\n\nfunction ms() { return Date.now(); }\n\nfunction isNotExpired(iso?: string | null): boolean {\n  if (!iso) return true; // if server doesn't give, assume valid\n  const t = Date.parse(iso);\n  if (isNaN(t)) return true;\n  // treat token as expiring 60s earlier for safety\n  return t - 60_000 > Date.now();\n}\n\nfunction throttleOk(last: number): boolean {\n  // 5 minutes = 300000ms\n  return (Date.now() - last) >= 300_000;\n}\n\nasync function authPost<T>(path: string, body: any): Promise<T> {\n  const base = await resolveBase();\n  const url = `${base}${path.startsWith('/') ? '' : '/'}${path}`;\n  return await fetchJson<T>(url, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(body || {}),\n    cache: 'no-store',\n    timeoutMs: 12000,\n    retries: 2,\n  });\n}\n\nasync function fetchNewAccessToken(): Promise<TokenState> {\n  // Per official CJ API docs: only apiKey is required (format: CJUserNum@api@xxx)\n  const apiKey = await getCjApiKey();\n  if (!apiKey) throw new Error('Missing CJ_API_KEY (env or admin settings)');\n\n  // Official endpoint per CJ docs\n  const r = await authPost<any>('/authentication/getAccessToken', { apiKey });\n  \n  // Check for success response\n  if (r?.code !== 200 || !r?.result) {\n    throw new Error(`CJ getAccessToken failed: ${r?.message || 'Unknown error'} (code: ${r?.code})`);\n  }\n  \n  const d = r?.data || {};\n  const accessToken = String(d?.accessToken || '');\n  \n  if (!accessToken) {\n    throw new Error('CJ getAccessToken returned empty token');\n  }\n  \n  const out: TokenState = {\n    accessToken,\n    accessTokenExpiry: d?.accessTokenExpiryDate || null,\n    refreshToken: d?.refreshToken || null,\n    refreshTokenExpiry: d?.refreshTokenExpiryDate || null,\n    lastAuthCallMs: ms(),\n  };\n  \n  // Persist token to database for reuse across requests\n  try {\n    await saveToken('cj', {\n      access_token: out.accessToken,\n      access_expiry: out.accessTokenExpiry || null,\n      refresh_token: out.refreshToken || null,\n      refresh_expiry: out.refreshTokenExpiry || null,\n      last_auth_call_at: new Date(out.lastAuthCallMs).toISOString(),\n    });\n  } catch {}\n  \n  return out;\n}\n\nasync function refreshAccessTokenState(state: TokenState): Promise<TokenState> {\n  if (!state.refreshToken) return state;\n  const r = await authPost<any>('/authentication/refreshAccessToken', { refreshToken: state.refreshToken });\n  if (r?.code !== 200 || !r?.result) {\n    throw new Error(`refreshAccessToken failed: ${r?.message || 'Unknown error'}`);\n  }\n  const d = r.data || {};\n  const out: TokenState = {\n    accessToken: String(d.accessToken || state.accessToken),\n    accessTokenExpiry: d.accessTokenExpiryDate || state.accessTokenExpiry || null,\n    refreshToken: d.refreshToken || state.refreshToken || null,\n    refreshTokenExpiry: d.refreshTokenExpiryDate || state.refreshTokenExpiry || null,\n    lastAuthCallMs: ms(),\n  };\n  try {\n    await saveToken('cj', {\n      access_token: out.accessToken,\n      access_expiry: out.accessTokenExpiry || null,\n      refresh_token: out.refreshToken || null,\n      refresh_expiry: out.refreshTokenExpiry || null,\n      last_auth_call_at: new Date(out.lastAuthCallMs).toISOString(),\n    });\n  } catch {}\n  return out;\n}\n\nexport async function getAccessToken(): Promise<string> {\n  // Manual override for emergencies\n  const manual = process.env.CJ_ACCESS_TOKEN;\n  if (manual) return manual;\n\n  // Use cached if valid\n  if (tokenState && isNotExpired(tokenState.accessTokenExpiry)) {\n    return tokenState.accessToken;\n  }\n\n  // Try to load from DB token store\n  try {\n    const row = await loadToken('cj');\n    if (row?.access_token) {\n      const dbState: TokenState = {\n        accessToken: row.access_token,\n        accessTokenExpiry: row.access_expiry,\n        refreshToken: row.refresh_token,\n        refreshTokenExpiry: row.refresh_expiry,\n        lastAuthCallMs: row.last_auth_call_at ? Date.parse(row.last_auth_call_at) : 0,\n      };\n      tokenState = dbState;\n      if (isNotExpired(dbState.accessTokenExpiry)) {\n        return dbState.accessToken;\n      }\n    }\n  } catch {}\n\n  // Try to refresh if we have a refreshToken and respect 5-min throttle\n  if (tokenState && tokenState.refreshToken) {\n    if (!throttleOk(tokenState.lastAuthCallMs)) {\n      // If throttled but token expired, we still have to try using the old token (may fail downstream)\n      return tokenState.accessToken;\n    }\n    try {\n      tokenState = await refreshAccessTokenState(tokenState);\n      if (tokenState && isNotExpired(tokenState.accessTokenExpiry)) return tokenState.accessToken;\n    } catch {/* will fallback to new token */}\n  }\n\n  // Fetch a new token with email/apiKey\n  if (!tokenState || throttleOk(tokenState.lastAuthCallMs)) {\n    tokenState = await fetchNewAccessToken();\n    return tokenState.accessToken;\n  }\n\n  throw new Error('Unable to obtain CJ access token (throttled). Please try again shortly.');\n}\n\nasync function cjFetch<T>(path: string, init?: RequestInit): Promise<T> {\n  const base = await resolveBase();\n  const url = `${base}${path.startsWith('/') ? '' : '/'}${path}`;\n  const attempt = async (tok: string) => {\n    const headers = {\n      'Content-Type': 'application/json',\n      'CJ-Access-Token': tok,\n      ...(init?.headers || {}),\n    } as Record<string, string>;\n    return await fetchJson<T>(url, {\n      ...init,\n      headers,\n      cache: 'no-store',\n      timeoutMs: 12000,\n      retries: 2,\n    });\n  };\n\n  let token = await getAccessToken();\n  try {\n    return await attempt(token);\n  } catch (e: any) {\n    const msg = String(e?.message || e || '');\n    const looksAuth = /HTTP\\s*(401|403)/i.test(msg) || /token|auth/i.test(msg);\n    const freshCreds = await getCjCreds();\n    const canFetchFresh = !!(process.env.CJ_EMAIL || freshCreds.email) && !!(process.env.CJ_API_KEY || freshCreds.apiKey);\n    if (looksAuth && canFetchFresh) {\n      try {\n        // Force-fetch a fresh token bypassing any bad manual override\n        const fresh = await fetchNewAccessToken();\n        tokenState = fresh;\n        return await attempt(fresh.accessToken);\n      } catch {\n        // fall through to rethrow original error\n      }\n    }\n    throw e;\n  }\n}\n\n// --- Product Rating from Comments ---\nexport async function getProductRating(pid: string): Promise<{ rating: number | null; reviewCount: number }> {\n  try {\n    console.log(`[CJ Rating] Fetching comments for pid: ${pid}`);\n    const res = await cjFetch<any>(`/product/productComments?pid=${encodeURIComponent(pid)}`);\n    console.log(`[CJ Rating] Response for pid ${pid}:`, JSON.stringify(res).slice(0, 800));\n    \n    // Handle various response structures from CJ API\n    // Can be: { data: { list: [], total: X } } or { data: [] } or { list: [] }\n    const data = res?.data;\n    let list: any[] = [];\n    let total = 0;\n    \n    if (Array.isArray(data)) {\n      list = data;\n      total = data.length;\n    } else if (data?.list && Array.isArray(data.list)) {\n      list = data.list;\n      total = parseInt(data?.total || String(data.list.length), 10);\n    } else if (Array.isArray(res)) {\n      list = res;\n      total = res.length;\n    }\n    \n    console.log(`[CJ Rating] pid ${pid}: total=${total}, listLength=${list.length}`);\n    \n    if (list.length === 0) {\n      return { rating: null, reviewCount: 0 };\n    }\n    \n    let sumScore = 0;\n    let countScores = 0;\n    for (const comment of list) {\n      // Try multiple possible field names for score\n      const scoreVal = comment?.score || comment?.rating || comment?.starScore || comment?.commentScore;\n      const score = parseFloat(String(scoreVal || '0'));\n      if (score > 0 && score <= 5) {\n        sumScore += score;\n        countScores++;\n      }\n    }\n    \n    if (countScores === 0) {\n      return { rating: null, reviewCount: total };\n    }\n    \n    const avgRating = sumScore / countScores;\n    console.log(`[CJ Rating] pid ${pid}: avgRating=${avgRating}, reviewCount=${total}`);\n    return { rating: Math.round(avgRating * 10) / 10, reviewCount: total };\n  } catch (e: any) {\n    console.error('[CJ Rating] Failed to fetch product rating:', e?.message || e);\n    return { rating: null, reviewCount: 0 };\n  }\n}\n\n// Batch fetch ratings for multiple products (with concurrency limit)\nexport async function getProductRatings(pids: string[]): Promise<Map<string, { rating: number | null; reviewCount: number }>> {\n  const results = new Map<string, { rating: number | null; reviewCount: number }>();\n  const BATCH_SIZE = 5; // Limit concurrent requests\n  \n  for (let i = 0; i < pids.length; i += BATCH_SIZE) {\n    const batch = pids.slice(i, i + BATCH_SIZE);\n    const promises = batch.map(async (pid) => {\n      const result = await getProductRating(pid);\n      return { pid, result };\n    });\n    \n    const batchResults = await Promise.allSettled(promises);\n    for (const res of batchResults) {\n      if (res.status === 'fulfilled') {\n        results.set(res.value.pid, res.value.result);\n      }\n    }\n  }\n  \n  return results;\n}\n\n// Helper: Parse JSON array fields from CJ API (e.g., materialNameEn: '[\"\",\"metal\"]')\nfunction parseCjJsonArray(val: any): string[] {\n  if (!val) return [];\n  if (Array.isArray(val)) return val.filter(Boolean).map(String);\n  if (typeof val === 'string') {\n    const trimmed = val.trim();\n    if (trimmed.startsWith('[')) {\n      try {\n        const arr = JSON.parse(trimmed);\n        if (Array.isArray(arr)) return arr.filter(Boolean).map(String);\n      } catch {}\n    }\n    return trimmed ? [trimmed] : [];\n  }\n  return [];\n}\n\n// Helper: Extract product list from listV2 response (handles various response structures)\nfunction extractListV2Products(res: any): any[] {\n  const content = res?.data?.content;\n  if (Array.isArray(content) && content[0]?.productList) {\n    return content[0].productList;\n  }\n  if (content && !Array.isArray(content) && content.productList) {\n    return content.productList;\n  }\n  if (res?.data?.list) {\n    return res.data.list;\n  }\n  if (Array.isArray(res?.data)) {\n    return res.data;\n  }\n  return [];\n}\n\n// Helper: Copy useful fields from listV2 match to product data\nfunction mergeListV2Fields(productData: any, match: any, source: string): void {\n  if (match.description && !productData.description) {\n    productData.description = match.description;\n    console.log(`[CJ Details] Got description from listV2 (${source}): ${match.description.slice(0, 80)}...`);\n  }\n  if (match.threeCategoryName) productData.threeCategoryName = match.threeCategoryName;\n  if (match.twoCategoryName) productData.twoCategoryName = match.twoCategoryName;\n  if (match.oneCategoryName) productData.oneCategoryName = match.oneCategoryName;\n  if (match.deliveryCycle) productData.deliveryCycle = match.deliveryCycle;\n  if (match.categoryId && !productData.categoryId) productData.categoryId = match.categoryId;\n  if (match.listedNum && !productData.listedNum) productData.listedNum = match.listedNum;\n  if (match.addMarkStatus !== undefined) productData.addMarkStatus = match.addMarkStatus;\n  \n  // IMPORTANT: Copy inventory fields from listV2 (these are the REAL stock values)\n  // warehouseInventoryNum = total inventory number\n  // totalVerifiedInventory = CJ warehouse stock (verified)\n  // totalUnVerifiedInventory = Factory/supplier stock (unverified)\n  if (match.warehouseInventoryNum !== undefined && match.warehouseInventoryNum !== null) {\n    productData.warehouseInventoryNum = Number(match.warehouseInventoryNum);\n    console.log(`[CJ Details] Got warehouseInventoryNum from listV2 (${source}): ${productData.warehouseInventoryNum}`);\n  }\n  if (match.totalVerifiedInventory !== undefined && match.totalVerifiedInventory !== null) {\n    productData.totalVerifiedInventory = Number(match.totalVerifiedInventory);\n  }\n  if (match.totalUnVerifiedInventory !== undefined && match.totalUnVerifiedInventory !== null) {\n    productData.totalUnVerifiedInventory = Number(match.totalUnVerifiedInventory);\n  }\n  // Also copy listedNum for popularity (override if we have a better value)\n  if (match.listedNum !== undefined && match.listedNum !== null && Number(match.listedNum) > 0) {\n    productData.listedNum = Number(match.listedNum);\n    console.log(`[CJ Details] Got listedNum from listV2 (${source}): ${productData.listedNum}`);\n  }\n}\n\n// Fetch full product details by PID - returns complete product with all images and variants\nexport async function fetchProductDetailsByPid(pid: string): Promise<any | null> {\n  if (!pid) return null;\n  \n  try {\n    // Fetch product details from /product/query\n    const pr = await cjFetch<any>(`/product/query?pid=${encodeURIComponent(pid)}`);\n    let productData = pr?.data || pr?.content || pr || null;\n    \n    if (!productData) return null;\n    \n    // Get the SKU for more targeted search\n    const sku = productData.productSku || productData.sku || '';\n    \n    // Parse JSON array fields from /product/query (CJ returns some as JSON strings)\n    // These contain material, packing info etc that we need for product specs\n    const materialArr = parseCjJsonArray(productData.materialNameEn || productData.materialName);\n    const packingArr = parseCjJsonArray(productData.packingNameEn || productData.packingName);\n    const productKeyArr = parseCjJsonArray(productData.productKeyEn || productData.productKey);\n    \n    // Store parsed arrays as readable strings for display\n    if (materialArr.length > 0 && !productData.materialParsed) {\n      productData.materialParsed = materialArr.filter(m => m && m.length > 0).join(', ');\n    }\n    if (packingArr.length > 0 && !productData.packingParsed) {\n      productData.packingParsed = packingArr.filter(p => p && p.length > 0).join(', ');\n    }\n    if (productKeyArr.length > 0 && !productData.productKeyParsed) {\n      productData.productKeyParsed = productKeyArr.filter(k => k && k.length > 0).join(', ');\n    }\n    \n    // Also try to fetch description from listV2 with features parameter\n    // The /product/query endpoint does NOT return description, but listV2 with features=enable_description does\n    // Use features=enable_description,enable_category for maximum data\n    const listV2Features = 'enable_description,enable_category';\n    \n    if (!productData.description) {\n      // Strategy 1: Direct search by PID (most reliable if CJ indexes by PID)\n      try {\n        const listV2Res = await cjFetch<any>(`/product/listV2?keyWord=${encodeURIComponent(pid)}&page=1&size=5&features=${listV2Features}`);\n        const productList = extractListV2Products(listV2Res);\n        const match = productList.find((p: any) => p.id === pid || p.pid === pid);\n        if (match) {\n          mergeListV2Fields(productData, match, `PID search ${pid}`);\n        }\n      } catch (e: any) {\n        console.log(`[CJ Details] listV2 PID search failed for ${pid}:`, e?.message);\n      }\n    }\n    \n    // Strategy 2: Search by exact SKU (reliable for products with unique SKUs)\n    if (!productData.description && sku) {\n      try {\n        const listV2Res = await cjFetch<any>(`/product/listV2?keyWord=${encodeURIComponent(sku)}&page=1&size=10&features=${listV2Features}`);\n        const productList = extractListV2Products(listV2Res);\n        // Find exact match by PID or SKU\n        const match = productList.find((p: any) => \n          p.id === pid || p.pid === pid || p.sku === sku || p.productSku === sku\n        );\n        if (match) {\n          mergeListV2Fields(productData, match, `SKU search ${sku}`);\n        }\n      } catch (e: any) {\n        console.log(`[CJ Details] listV2 SKU search failed for ${pid}:`, e?.message);\n      }\n    }\n    \n    // Strategy 3: Search by product name if we still don't have description\n    if (!productData.description) {\n      try {\n        const productName = productData.productNameEn || productData.productName || productData.nameEn || '';\n        if (productName && productName.length > 5) {\n          // Use first 40 chars of product name for search (increased from 30)\n          const searchTerm = productName.slice(0, 40).trim();\n          const listV2Res = await cjFetch<any>(`/product/listV2?keyWord=${encodeURIComponent(searchTerm)}&page=1&size=20&features=${listV2Features}`);\n          const productList = extractListV2Products(listV2Res);\n          \n          // Find exact match by PID first\n          let match = productList.find((p: any) => p.id === pid || p.pid === pid);\n          \n          // If no PID match, try SKU match\n          if (!match && sku) {\n            match = productList.find((p: any) => p.sku === sku || p.productSku === sku);\n          }\n          \n          if (match) {\n            mergeListV2Fields(productData, match, `name search \"${searchTerm.slice(0, 20)}...\"`);\n          }\n        }\n      } catch (e: any) {\n        console.log(`[CJ Details] listV2 name search failed for ${pid}:`, e?.message);\n      }\n    }\n    \n    // Log all weight-related fields from CJ API for debugging shipping costs\n    // For shipping, packWeight (total weight with packaging) is more accurate than productWeight (net)\n    const weightFields = ['packWeight', 'packingWeight', 'productWeight', 'weight', 'grossWeight', 'netWeight'];\n    const foundWeights: Record<string, any> = {};\n    for (const f of weightFields) {\n      if (productData[f] !== undefined && productData[f] !== null && productData[f] !== '') {\n        foundWeights[f] = productData[f];\n      }\n    }\n    if (Object.keys(foundWeights).length > 0) {\n      console.log(`[CJ Details] Product ${pid} weight fields:`, JSON.stringify(foundWeights));\n    } else {\n      console.log(`[CJ Details] Product ${pid}: No weight data in CJ response`);\n    }\n    \n    // Build synthesized productInfo from all available fields (used if no description HTML)\n    // This ensures we always have SOMETHING to show on Page 3\n    if (!productData.synthesizedInfo) {\n      const infoLines: string[] = [];\n      \n      // Material info\n      if (productData.materialParsed) {\n        infoLines.push(`Material: ${productData.materialParsed}`);\n      }\n      \n      // Packing/package info\n      if (productData.packingParsed) {\n        infoLines.push(`Package: ${productData.packingParsed}`);\n      }\n      \n      // Product weight\n      const weight = productData.productWeight || productData.packingWeight || productData.packWeight || productData.weight;\n      if (weight && Number(weight) > 0) {\n        infoLines.push(`Weight: ${weight}g`);\n      }\n      \n      // Dimensions from packing\n      const pL = productData.packLength;\n      const pW = productData.packWidth;\n      const pH = productData.packHeight;\n      if (pL && pW && pH && Number(pL) > 0 && Number(pW) > 0 && Number(pH) > 0) {\n        infoLines.push(`Package Size: ${pL} × ${pW} × ${pH} cm`);\n      }\n      \n      // Product attributes (color, size options from productKeyEn)\n      if (productData.productKeyParsed) {\n        infoLines.push(`Attributes: ${productData.productKeyParsed}`);\n      }\n      \n      // Category path\n      const category = productData.threeCategoryName || productData.twoCategoryName || productData.categoryName || '';\n      if (category && !category.includes('_')) {\n        infoLines.push(`Category: ${category}`);\n      }\n      \n      // Delivery cycle\n      if (productData.deliveryCycle) {\n        infoLines.push(`Delivery: ${productData.deliveryCycle} days`);\n      }\n      \n      // HS code for customs (useful for international shipping)\n      if (productData.entryCode && productData.entryNameEn) {\n        infoLines.push(`HS Code: ${productData.entryCode} (${productData.entryNameEn})`);\n      }\n      \n      if (infoLines.length > 0) {\n        productData.synthesizedInfo = infoLines.join('<br/>');\n        console.log(`[CJ Details] Built synthesizedInfo for ${pid}: ${infoLines.length} fields`);\n      }\n    }\n    \n    // Log available data fields for debugging\n    const specFields = ['description', 'synthesizedInfo', 'materialParsed', 'packingParsed', 'productPropertyList', 'productWeight'];\n    const availableSpecs: Record<string, string> = {};\n    for (const field of specFields) {\n      if (productData[field]) {\n        const val = productData[field];\n        if (typeof val === 'string') {\n          availableSpecs[field] = `\"${val.slice(0, 40)}...\"`;\n        } else if (Array.isArray(val)) {\n          availableSpecs[field] = `[${val.length} items]`;\n        } else {\n          availableSpecs[field] = typeof val;\n        }\n      }\n    }\n    console.log(`[CJ Details] Product ${pid} spec fields:`, JSON.stringify(availableSpecs));\n    \n    // Fetch variants separately to get complete variant data with images\n    try {\n      const vr = await cjFetch<any>(`/product/variant/query?pid=${encodeURIComponent(pid)}`);\n      const variantList = Array.isArray(vr?.data) ? vr.data : (vr?.data?.list || []);\n      if (variantList.length > 0) {\n        console.log(`[CJ Details] Product ${pid} has ${variantList.length} variants`);\n        productData = { ...productData, variantList };\n      }\n    } catch {\n      // Continue without variants if that endpoint fails\n    }\n    \n    return productData;\n  } catch (e: any) {\n    console.log(`[CJ Details] Failed to fetch details for ${pid}:`, e?.message);\n    return null;\n  }\n}\n\n// Batch fetch product details with concurrency control\nexport async function fetchProductDetailsBatch(pids: string[], concurrency: number = 5): Promise<Map<string, any>> {\n  const results = new Map<string, any>();\n  \n  // Process in batches to avoid overwhelming the API\n  for (let i = 0; i < pids.length; i += concurrency) {\n    const batch = pids.slice(i, i + concurrency);\n    const promises = batch.map(async (pid) => {\n      const details = await fetchProductDetailsByPid(pid);\n      if (details) {\n        results.set(pid, details);\n      }\n    });\n    await Promise.all(promises);\n    \n    // Small delay between batches to respect rate limits\n    if (i + concurrency < pids.length) {\n      await new Promise(resolve => setTimeout(resolve, 100));\n    }\n  }\n  \n  console.log(`[CJ Batch] Fetched details for ${results.size}/${pids.length} products`);\n  return results;\n}\n\n// Query by keyword or PID (CJ sometimes exposes myProduct query); we attempt flexible endpoints.\nexport async function queryProductByPidOrKeyword(input: { pid?: string; keyword?: string }): Promise<any> {\n  const { pid, keyword } = input;\n  if (!pid && !keyword) throw new Error('Missing pid or keyword');\n\n  // If PID provided, hit the exact PID endpoint first\n  if (pid) {\n    try {\n      let guidPid = pid;\n      // Resolve PID generically: the input may be a numeric web id or a SKU like CJTZ...; search to find the product pid\n      try {\n        const lr = await cjFetch<any>(`/product/list?keyWords=${encodeURIComponent(pid)}&pageSize=5&pageNum=1`);\n        const cand = (Array.isArray(lr?.data?.list) ? lr.data.list : []) as any[];\n        if (cand.length > 0 && cand[0]?.pid) {\n          guidPid = String(cand[0].pid);\n        }\n      } catch {}\n\n      // Fetch product details and variants using GUID pid\n      const pr = await cjFetch<any>(`/product/query?pid=${encodeURIComponent(guidPid)}`);\n      let base = pr?.data || pr?.content || pr || null;\n      try {\n        const vr = await cjFetch<any>(`/product/variant/query?pid=${encodeURIComponent(guidPid)}`);\n        const vlist = Array.isArray(vr?.data) ? vr.data : [];\n        if (base) base = { ...base, variantList: vlist };\n      } catch { /* ignore variant errors */ }\n\n      const content = base ? [base] : [];\n      return { code: 200, data: { content } };\n    } catch (e) {\n      // Fall through to keyword mode as a last resort\n    }\n  }\n\n  // Keyword search: try multiple endpoints (CJ requires min pageSize of 10)\n  const term = String(keyword || pid);\n  const qsKeyword = `keyword=${encodeURIComponent(term)}&pageSize=20&pageNumber=1`;\n  const qsList = `keyWords=${encodeURIComponent(term)}&pageSize=20&pageNum=1`;\n  const endpoints = [\n    `/product/myProduct/query?${qsKeyword}`,\n    `/product/query?${qsKeyword}`,\n    `/product/list?${qsList}`,\n  ];\n\n  const collected: any[] = [];\n  let lastErr: any = null;\n  for (const ep of endpoints) {\n    try {\n      const r = await cjFetch<any>(ep);\n      const arr = Array.isArray(r?.data?.list)\n        ? r.data.list\n        : Array.isArray(r?.data?.content)\n          ? r.data.content\n          : Array.isArray(r?.content)\n            ? r.content\n            : Array.isArray(r?.data)\n              ? r.data\n              : Array.isArray(r)\n                ? r\n                : [];\n      for (const it of arr) collected.push(it);\n      if (collected.length > 0) break;\n    } catch (e: any) {\n      lastErr = e;\n    }\n  }\n\n  if (collected.length === 0 && lastErr) throw lastErr;\n  return { code: 200, data: { content: collected } };\n}\n\n// Attempt to map a CJ response item to our internal structure.\nexport function mapCjItemToProductLike(item: any): CjProductLike | null {\n  if (!item) return null;\n  const productId = String(item.productId || item.pid || item.id || item.vid || item.sku || '');\n  if (!productId) return null;\n  // --- Title normalization ---\n  function cleanTitle(s: string): string {\n    try {\n      const normalized = s.replace(/[“”„‟‛]/g, '\"').replace(/[’‘`]/g, \"'\");\n      const parts = normalized.split(/[\",，、|]+/).map((p) => p.trim()).filter(Boolean);\n      const uniq: string[] = [];\n      for (const p of parts) if (!uniq.includes(p)) uniq.push(p);\n      let out = (uniq.join(', ') || normalized).replace(/^\"+|\"+$/g, '').replace(/\\s{2,}/g, ' ').trim();\n      if (out.length > 120) { out = out.slice(0, 120).replace(/\\s+\\S*$/, '').trim(); }\n      return out || 'Untitled';\n    } catch { return s || 'Untitled'; }\n  }\n  // Prefer English/Latin/Arabic title if available; fall back to cleaned string with CJK stripped if dominant\n  const rawTitle = String(item.nameEn || item.productNameEn || item.englishName || item.productName || item.name || item.title || 'Untitled');\n  let name = cleanTitle(rawTitle);\n  try {\n    const cjk = (name.match(/[\\u3040-\\u30ff\\u3400-\\u4dbf\\u4e00-\\u9fff\\uf900-\\ufaff]/g) || []).length;\n    if (cjk > 0 && cjk / Math.max(1, name.length) > 0.4) {\n      const asciiish = name.replace(/[\\u3040-\\u30ff\\u3400-\\u4dbf\\u4e00-\\u9fff\\uf900-\\ufaff]/g, '').replace(/\\s{2,}/g, ' ').trim();\n      if (asciiish.length >= 10) name = cleanTitle(asciiish);\n    }\n  } catch {}\n  // Optional: basic Arabic terminology replacement if enabled (non-AI, deterministic)\n  function arabizeTitle(s: string): string {\n    const map: Array<[RegExp, string]> = [\n      [/\\bwomen'?s\\b/ig, 'للنساء'],\n      [/\\bwomen\\b/ig, 'نساء'],\n      [/\\bmen'?s\\b/ig, 'للرجال'],\n      [/\\bmen\\b/ig, 'رجال'],\n      [/\\bdress(es)?\\b/ig, 'فستان'],\n      [/\\bblouse(s)?\\b/ig, 'بلوزة'],\n      [/\\bskirt(s)?\\b/ig, 'تنورة'],\n      [/\\bshirt(s)?\\b/ig, 'قميص'],\n      [/\\bt[- ]?shirt(s)?\\b/ig, 'تيشيرت'],\n      [/\\bhoodie(s)?\\b/ig, 'هودي'],\n      [/\\bsweater(s)?\\b/ig, 'كنزة'],\n      [/\\bjeans?\\b/ig, 'جينز'],\n      [/\\bpants?\\b/ig, 'بنطال'],\n      [/\\bshorts?\\b/ig, 'شورت'],\n      [/\\bshoes?\\b/ig, 'أحذية'],\n      [/\\bsneakers?\\b/ig, 'سنيكرز'],\n      [/\\blong sleeve(s)?\\b/ig, 'أكمام طويلة'],\n      [/\\bshort sleeve(s)?\\b/ig, 'أكمام قصيرة'],\n    ];\n    let out = s;\n    for (const [re, ar] of map) out = out.replace(re, ar);\n    return out;\n  }\n  try {\n    if ((process.env.AUTO_ARABIC_TITLES || '').toLowerCase() === 'true') {\n      name = arabizeTitle(name);\n    }\n  } catch {}\n\n  // --- Image collection (robust across CJ shapes) ---\n  const imageList: string[] = [];\n  const bigImage = (item.productImage || item.bigImage || item.image || item.mainImage || item.mainImageUrl || null) as string | null;\n  const pushUrl = (val: any) => { if (typeof val === 'string' && val.trim()) imageList.push(val.trim()); };\n  if (bigImage) pushUrl(bigImage);\n  // Arrays: strings or objects with common keys\n  const arrFields = ['imageList', 'productImageList', 'detailImageList', 'pictureList', 'productImages'] as const;\n  for (const key of arrFields) {\n    const arr: any = (item as any)[key];\n    if (Array.isArray(arr)) {\n      for (const it of arr) {\n        if (typeof it === 'string') pushUrl(it);\n        else if (it && typeof it === 'object') pushUrl(it.imageUrl || it.url || it.imgUrl || it.big || it.origin || it.src);\n      }\n    }\n  }\n  // String fields that may contain JSON array or comma-separated URLs\n  const strFields = ['images', 'imageUrls', 'images2'];\n  for (const key of strFields) {\n    const v: any = (item as any)[key];\n    if (typeof v === 'string' && v.trim()) {\n      const s = v.trim();\n      if (s.startsWith('[') && s.endsWith(']')) {\n        try { const parsed = JSON.parse(s); if (Array.isArray(parsed)) parsed.forEach(pushUrl); } catch {}\n      } else if (/[;,|\\n\\r\\t,]+/.test(s)) {\n        s.split(/[;,|\\n\\r\\t,]+/).map((x) => x.trim()).filter(Boolean).forEach(pushUrl);\n      } else { pushUrl(s); }\n    }\n  }\n\n  // Filter out non-product images (badges, icons, flags, logos, placeholders) and small thumbs\n  const deny = /(sprite|icon|favicon|logo|placeholder|blank|loading|alipay|wechat|whatsapp|kefu|service|avatar|thumb|thumbnail|small|tiny|mini|sizechart|size\\s*chart|chart|table|guide|tips|hot|badge|flag|promo|banner|sale|discount|qr)/i;\n  function normalizeUrl(u: string): string {\n    try {\n      const url = new URL(u);\n      url.hash = '';\n      return url.toString();\n    } catch { return u; }\n  }\n  function isSmall(u: string): boolean {\n    // match -100x100 etc in filename; treat as small only if BOTH dims are small\n    const m = u.match(/-(\\d{2,4})x(\\d{2,4})(?=\\.)/i);\n    if (m) {\n      const w = Number(m[1]);\n      const h = Number(m[2]);\n      if (Math.max(w, h) < 300) return true;\n    }\n    // query hints like ?w=300 or &h=300: be lenient; only treat as small under 300\n    const qm = u.match(/[?&](?:w|width|h|height)=(\\d{2,4})/i);\n    if (qm && Number(qm[1]) < 300) return true;\n    return false;\n  }\n  function normKey(u: string): string {\n    try {\n      const url = new URL(u);\n      const name = url.pathname.split('/').pop() || u;\n      return name.toLowerCase().replace(/-\\d{2,4}x\\d{2,4}(?=\\.)/, '');\n    } catch { return u; }\n  }\n\n  const seen = new Set<string>();\n  const filteredImages: string[] = [];\n  for (const raw of imageList) {\n    if (!raw) continue;\n    const u = normalizeUrl(String(raw));\n    if (deny.test(u)) continue;\n    if (isSmall(u)) continue;\n    const key = normKey(u);\n    if (seen.has(key)) continue;\n    seen.add(key);\n    filteredImages.push(u);\n    if (filteredImages.length >= 30) break;\n  }\n\n  // Video detection: some responses may contain videoUrl or list\n  let videoUrl: string | null = (item.video || item.videoUrl || null) as string | null;\n  try {\n    const vlist: any = (item as any).videoList || (item as any).videos;\n    if (!videoUrl && Array.isArray(vlist) && vlist.length > 0) {\n      const first = vlist.find((x: any) => typeof x === 'string') || vlist.find((x: any) => x && typeof x.url === 'string')?.url;\n      if (first && typeof first === 'string') videoUrl = first;\n    }\n  } catch {}\n\n  // Helpers to coerce numbers from various shapes\n  const toNum = (x: any): number | undefined => {\n    if (typeof x === 'number' && isFinite(x)) return x;\n    if (typeof x === 'string') {\n      // Remove common separators and non-numeric chars except dot\n      const m = x.replace(/[,\\s]/g, '').match(/-?\\d*\\.?\\d+/);\n      if (m) {\n        const n = parseFloat(m[0]);\n        return isFinite(n) ? n : undefined;\n      }\n    }\n    return undefined;\n  };\n  const pickNum = (...cands: any[]): number | undefined => {\n    for (const c of cands) {\n      const n = toNum(c);\n      if (typeof n === 'number' && !isNaN(n)) return n;\n    }\n    return undefined;\n  };\n\n  // Variants: try multiple shapes (skuList, variantList, productSku, etc.)\n  const variants: CjVariantLike[] = [];\n  const rawVariants = item.variantList || item.skuList || item.productSkuList || item.variants || [];\n  if (Array.isArray(rawVariants)) {\n    for (const v of rawVariants) {\n      const cjSku = v.cjSku || v.sku || v.skuId || v.barcode || null;\n      // Extract size/color from multiple shapes\n      const baseSize = v.size || v.attributeValue || (v.attributes && (v.attributes.size || v.attributes.Size || v.attributes.SIZE)) || v.optionValue || null;\n      const baseColor = (v.color || v.colour || v.Color || (v.attributes && (v.attributes.color || v.attributes.Color || v.attributes.COLOUR))) || null;\n      const kvs: Array<{ key: string; value: string }> = [];\n      const pushKv = (k: any, val: any) => { if (typeof k === 'string' && typeof val === 'string' && k && val) kvs.push({ key: k, value: val }); };\n      try {\n        if (Array.isArray(v.attributes)) {\n          for (const a of v.attributes) pushKv(a?.name || a?.key || a?.k, a?.value || a?.v);\n        }\n        if (Array.isArray(v.attributeList)) {\n          for (const a of v.attributeList) pushKv(a?.name || a?.key, a?.value);\n        }\n        if (Array.isArray(v.properties)) {\n          for (const a of v.properties) pushKv(a?.name || a?.key, a?.value);\n        }\n        if (typeof v.variantKey === 'string' && (v as any).variantValue) pushKv(v.variantKey, String((v as any).variantValue));\n        if (typeof v.specKey === 'string' && (v as any).specValue) pushKv(v.specKey, String((v as any).specValue));\n      } catch {}\n      function deriveFromText(t?: string): { size?: string; color?: string } {\n        const out: { size?: string; color?: string } = {};\n        if (!t || typeof t !== 'string') return out;\n        const s = t.trim();\n        // Forms like \"Color: Black; Size: L\"\n        const mColor = s.match(/(?:color|colour)\\s*[:=]\\s*([^;|,\\/]*)/i);\n        if (mColor && mColor[1]) out.color = mColor[1].trim();\n        const mSize = s.match(/size\\s*[:=]\\s*([^;|,\\/]*)/i);\n        if (mSize && mSize[1]) out.size = mSize[1].trim();\n        // Hyphen or slash separated like \"Black-L\"\n        if (!out.color || !out.size) {\n          const parts = s.split(/[\\-\\/|]+/).map(x => x.trim()).filter(Boolean);\n          const sizeTokens = new Set(['XS','S','M','L','XL','XXL','XXXL','2XL','3XL','4XL','5XL','One Size','Free Size']);\n          const maybeSize = parts.find(p => sizeTokens.has(p.toUpperCase()) || /^\\d{2}$/.test(p));\n          const maybeColor = parts.find(p => p && p !== maybeSize);\n          if (!out.size && maybeSize) out.size = maybeSize;\n          if (!out.color && maybeColor) out.color = maybeColor;\n        }\n        return out;\n      }\n      let derivedSize: string | null = null;\n      let derivedColor: string | null = null;\n      try {\n        // Prefer kv pairs\n        for (const kv of kvs) {\n          const k = String(kv.key).toLowerCase();\n          if (!derivedColor && /(color|colour)/i.test(k) && kv.value) derivedColor = kv.value;\n          if (!derivedSize && /size/i.test(k) && kv.value) derivedSize = kv.value;\n        }\n        if (!derivedColor || !derivedSize) {\n          const t = String((v as any).skuName || (v as any).variantName || (v as any).variant || '');\n          const got = deriveFromText(t);\n          if (!derivedColor && got.color) derivedColor = got.color;\n          if (!derivedSize && got.size) derivedSize = got.size;\n        }\n      } catch {}\n      const size = baseSize || derivedSize || null;\n      const color = baseColor || derivedColor || null;\n      const price = pickNum(\n        v.sellPrice, v.price, v.discountPrice, v.sellPriceUSD, v.usdPrice, v.listedPrice, v.originalPrice,\n        (v.priceInfo && (v.priceInfo.sellPrice || v.priceInfo.price)),\n        item.sellPrice, item.price\n      );\n      const stock = pickNum(\n        v.stock, v.quantity, v.sellStock, v.availableStock, v.inventory, v.inventoryQuantity, v.stockNum\n      );\n      // Try to coerce weight (grams) and dimensions (cm) from common CJ fields\n      const weightCandidates = [\n        v.weightGram, v.weight_g, v.weightGrams, v.weight,\n        (v.packageWeight || v.packingWeight),\n      ];\n      let weightGrams: number | undefined = undefined;\n      for (const c of weightCandidates) {\n        const n = pickNum(c);\n        if (typeof n === 'number') {\n          // Heuristic: if looks like kilograms (very small number), convert to grams\n          weightGrams = n < 30 ? Math.round(n * 1000) : Math.round(n);\n          break;\n        }\n      }\n      const lengthCm = pickNum(v.length, v.lengthCm, v.l) as number | undefined;\n      const widthCm = pickNum(v.width, v.widthCm, v.w) as number | undefined;\n      const heightCm = pickNum(v.height, v.heightCm, v.h) as number | undefined;\n\n      // Extract variantKey (short name like \"Black And Silver-2XL\")\n      const variantKey = v.variantKey || undefined;\n      const vid = v.vid || v.variantId || undefined;\n      \n      // Extract CJ and Factory stock separately\n      const cjStock = pickNum(v.cjStock, v.cjInventory, v.cjAvailableNum);\n      const factoryStock = pickNum(v.factoryStock, v.factoryInventory, v.supplierStock, v.factoryAvailableNum);\n      \n      variants.push({\n        cjSku: cjSku || undefined,\n        variantKey,\n        vid,\n        size: size || undefined,\n        color: color || undefined,\n        price,\n        stock,\n        cjStock,\n        factoryStock,\n        weightGrams,\n        lengthCm: typeof lengthCm === 'number' ? lengthCm : undefined,\n        widthCm: typeof widthCm === 'number' ? widthCm : undefined,\n        heightCm: typeof heightCm === 'number' ? heightCm : undefined,\n        imageUrl: (v.whiteImage || v.image || v.imageUrl || v.imgUrl || undefined) as string | undefined,\n      });\n\n      // Opportunistically collect variant images if main set is empty or small\n      if (filteredImages.length < 30) {\n        const vcands = [v.image, v.imageUrl, v.imgUrl, v.whiteImage, v.bigImage];\n        for (const c of vcands) {\n          if (!c || typeof c !== 'string') continue;\n          const u = normalizeUrl(String(c));\n          if (deny.test(u)) continue;\n          if (isSmall(u)) continue;\n          const key = normKey(u);\n          if (seen.has(key)) continue;\n          seen.add(key);\n          filteredImages.push(u);\n          if (filteredImages.length >= 30) break;\n        }\n      }\n    }\n  }\n\n  // If no variants found, create one from product-level data\n  // IMPORTANT: Never fabricate stock - use actual CJ data or undefined\n  if (variants.length === 0) {\n    const productPrice = pickNum(item.sellPrice, item.price, item.salePrice, item.costPrice);\n    // Do NOT default to 100 - only use actual CJ stock data\n    const productStock = pickNum(item.stock, item.inventory, item.warehouseInventoryNum, item.storageNum);\n    const productSku = item.productSku || item.sku || null;\n    variants.push({\n      cjSku: productSku || undefined,\n      price: productPrice,\n      stock: typeof productStock === 'number' ? productStock : undefined, // undefined if not provided by CJ\n    });\n  }\n\n  // Delivery/processing time (hours) if provided\n  const deliveryTimeHours = typeof item.deliveryTime === 'number' ? item.deliveryTime : (typeof item.logisticAging === 'number' ? item.logisticAging : null);\n  const processingTimeHours = (() => {\n    const d = pickNum(item.processingTime, item.handleTime, item.handlingTime, item.processingDays, item.deliveryAging);\n    if (typeof d === 'number') {\n      // If looks like days (<= 60), convert to hours\n      return d <= 60 ? Math.round(d * 24) : Math.round(d);\n    }\n    return null;\n  })();\n\n  const originArea = (item.defaultArea || item.warehouse || item.areaName || null) as string | null;\n  const originCountryCode = (item.areaCountryCode || item.countryCode || null) as string | null;\n\n  return {\n    productId,\n    name,\n    images: filteredImages,\n    videoUrl: videoUrl || null,\n    variants,\n    deliveryTimeHours,\n    processingTimeHours,\n    originArea,\n    originCountryCode,\n    // Attach processing time in a way that callers can read from item if needed\n    // (keeping CjProductLike strict; we will pass via casting if used)\n  };\n}\n","path":null,"size_bytes":77752,"size_tokens":null},"postcss.config.js":{"content":"module.exports = {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":82,"size_tokens":null},"src/app/admin/blog/actions.ts":{"content":"\"use server\";\n\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\nimport { z } from \"zod\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { createClient } from \"@supabase/supabase-js\";\n\ntype BlogFormState = {\n  message: string;\n  fieldErrors: Record<string, string[] | undefined> | null;\n};\n\ntype DeleteState = { error?: string | null; success?: boolean };\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null as any;\n  return createClient(url, key);\n}\n\nasync function requireAdmin() {\n  const supabaseAuth = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabaseAuth.auth.getUser();\n  if (!user) return { allowed: false as const };\n  const adminEmails = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((e) => e.trim().toLowerCase())\n    .filter(Boolean);\n  if (adminEmails.length === 0) {\n    // Default deny in production; allow in dev when unset\n    return { allowed: process.env.NODE_ENV !== \"production\" } as const;\n  }\n  const email = (user.email || \"\").toLowerCase();\n  return { allowed: !!email && adminEmails.includes(email) } as const;\n}\n\nconst blogSchema = z.object({\n  title: z.string().min(1, \"Title is required\"),\n  slug: z.string().min(1, \"Slug is required\"),\n  excerpt: z.string().optional().nullable(),\n  content: z.string().optional().nullable(),\n  published: z\n    .union([z.literal(\"on\"), z.literal(\"true\"), z.literal(\"false\"), z.boolean()])\n    .optional()\n    .transform((v) => {\n      if (v === undefined) return true;\n      if (v === \"on\" || v === \"true\" || v === true) return true;\n      return false;\n    }),\n});\n\nconst blogUpdateSchema = blogSchema.extend({ id: z.coerce.number() });\n\nexport async function addBlogPost(prevState: BlogFormState, formData: FormData): Promise<BlogFormState> {\n  const adminCheck = await requireAdmin();\n  if (!adminCheck.allowed) return { message: \"Not authorized\", fieldErrors: null };\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) return { message: \"Server misconfiguration\", fieldErrors: null };\n\n  const validated = blogSchema.safeParse(Object.fromEntries(formData.entries()));\n  if (!validated.success) {\n    return { message: \"Invalid data\", fieldErrors: validated.error.flatten().fieldErrors };\n  }\n\n  const data = {\n    title: validated.data.title,\n    slug: validated.data.slug,\n    excerpt: validated.data.excerpt ?? null,\n    content: validated.data.content ?? null,\n    published: validated.data.published ?? true,\n  };\n\n  const { error } = await supabaseAdmin.from(\"blog_posts\").insert(data);\n  if (error) {\n    console.error(\"Add blog post failed:\", error);\n    const friendly = error.code === \"23505\" ? \"Slug already exists.\" : (error.message || \"Database error\");\n    return { message: friendly, fieldErrors: null };\n  }\n\n  revalidatePath(\"/admin/blog\");\n  revalidatePath(\"/blog\");\n  redirect(\"/admin/blog\");\n}\n\nexport async function updateBlogPost(prevState: BlogFormState, formData: FormData): Promise<BlogFormState> {\n  const adminCheck = await requireAdmin();\n  if (!adminCheck.allowed) return { message: \"Not authorized\", fieldErrors: null };\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) return { message: \"Server misconfiguration\", fieldErrors: null };\n\n  const validated = blogUpdateSchema.safeParse(Object.fromEntries(formData.entries()));\n  if (!validated.success) {\n    return { message: \"Invalid data\", fieldErrors: validated.error.flatten().fieldErrors };\n  }\n\n  const { id, ...rest } = validated.data;\n  const data = {\n    title: rest.title,\n    slug: rest.slug,\n    excerpt: rest.excerpt ?? null,\n    content: rest.content ?? null,\n    published: rest.published ?? true,\n  };\n\n  const { error } = await supabaseAdmin.from(\"blog_posts\").update(data).eq(\"id\", id);\n  if (error) {\n    console.error(\"Update blog post failed:\", error);\n    const friendly = error.code === \"23505\" ? \"Slug already exists.\" : (error.message || \"Database error\");\n    return { message: friendly, fieldErrors: null };\n  }\n\n  revalidatePath(\"/admin/blog\");\n  revalidatePath(\"/blog\");\n  redirect(\"/admin/blog\");\n}\n\nexport async function deleteBlogPost(prevState: DeleteState, formData: FormData): Promise<DeleteState> {\n  const adminCheck = await requireAdmin();\n  if (!adminCheck.allowed) return { error: \"Not authorized\" };\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) return { error: \"Server misconfiguration\" };\n\n  const id = Number(formData.get(\"id\"));\n  if (!id || !Number.isFinite(id)) return { error: \"Invalid post id\" };\n\n  const { error } = await supabaseAdmin.from(\"blog_posts\").delete().eq(\"id\", id);\n  if (error) return { error: \"Database error: Could not delete post.\" };\n\n  revalidatePath(\"/admin/blog\");\n  revalidatePath(\"/blog\");\n  return { success: true };\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"src/app/api/contact/route.ts":{"content":"import { NextResponse, type NextRequest } from 'next/server'\nimport { contactLimiter, getClientIp } from '@/lib/ratelimit'\nimport { createClient } from '@supabase/supabase-js'\nimport { loggerForRequest } from '@/lib/log'\n\nexport const dynamic = 'force-dynamic'\nexport const runtime = 'nodejs'\n\nfunction isEmail(s: unknown): s is string {\n  if (typeof s !== 'string') return false\n  const v = s.trim()\n  if (!v) return false\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v)\n}\n\nfunction escapeHtml(s: string): string {\n  return s.replace(/[&<>\"']/g, (ch: string) => ({\n    '&': '&amp;',\n    '<': '&lt;',\n    '>': '&gt;',\n    '\"': '&quot;',\n    \"'\": '&#39;',\n  } as Record<string, string>)[ch]!)\n}\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req)\n  try {\n    const ip = getClientIp(req as unknown as Request)\n    const rl = await contactLimiter.limit(`contact:${ip}`)\n    if (!rl.success) {\n      const r = NextResponse.json({ ok: false, error: 'rate_limited' }, { status: 429 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n  } catch {}\n\n  const body = await req.json().catch(() => null) as any\n  const name = (body?.name || '').toString().trim()\n  const email = (body?.email || '').toString().trim()\n  const message = (body?.message || '').toString().trim()\n\n  if (!name || !isEmail(email) || !message || message.length < 10) {\n    const r = NextResponse.json({ ok: false, error: 'invalid_payload' }, { status: 400 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n\n  // Persist to Supabase if service role is configured\n  try {\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const service = process.env.SUPABASE_SERVICE_ROLE_KEY\n    if (url && service) {\n      const admin = createClient(url, service, { auth: { autoRefreshToken: false, persistSession: false } })\n      await admin.from('contact_messages').insert({ name, email, message }).single()\n    }\n  } catch (e) {\n    // swallow\n  }\n\n  // Notify admins via Resend if configured\n  try {\n    const admins = (process.env.ADMIN_EMAILS || '').split(',').map(s => s.trim()).filter(Boolean)\n    const apiKey = process.env.RESEND_API_KEY\n    if (admins.length && apiKey) {\n      const domain = (process.env.NEXT_PUBLIC_SITE_URL || 'shopixo.vercel.app').replace(/^https?:\\/\\//,'')\n      const html = `\n        <div style=\"font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;line-height:1.6\">\n          <h2 style=\"margin:0 0 12px\">New Contact Message</h2>\n          <p style=\"margin:0 0 6px\"><strong>Name:</strong> ${name}</p>\n          <p style=\"margin:0 0 6px\"><strong>Email:</strong> ${email}</p>\n          <p style=\"margin:12px 0 6px\"><strong>Message:</strong></p>\n          <div style=\"white-space:pre-wrap\">${escapeHtml(message || '')}</div>\n        </div>`\n      await fetch('https://api.resend.com/emails', {\n        method: 'POST',\n        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          from: `${process.env.NEXT_PUBLIC_STORE_NAME || 'Shopixo'} <no-reply@${domain}>`,\n          to: admins,\n          subject: `Message from ${name}`,\n          html,\n        })\n      })\n    }\n  } catch {}\n\n  const r = NextResponse.json({ ok: true })\n  r.headers.set('x-request-id', log.requestId)\n  return r\n}\n","path":null,"size_bytes":3334,"size_tokens":null},"src/app/api/cj/sync/product/[pid]/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { persistRawCj, upsertProductFromCj } from '@/lib/ops/cj-sync'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request, ctx: { params: { pid: string } }) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const pid = decodeURIComponent(ctx.params.pid)\n    if (!pid) {\n      const r = NextResponse.json({ ok: false, error: 'Missing pid' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const { searchParams } = new URL(req.url)\n    const Q = z.object({\n      updateImages: z.string().optional(),\n      updateVideo: z.string().optional(),\n      updatePrice: z.string().optional(),\n    })\n    const q = Q.parse({\n      updateImages: searchParams.get('updateImages') || undefined,\n      updateVideo: searchParams.get('updateVideo') || undefined,\n      updatePrice: searchParams.get('updatePrice') || undefined,\n    })\n    const toBool = (v: string | undefined, def: boolean) => v ? v.toLowerCase() === 'true' : def\n    const updateImages = toBool(q.updateImages, true)\n    const updateVideo = toBool(q.updateVideo, true)\n    const updatePrice = toBool(q.updatePrice, true)\n\n    const raw = await queryProductByPidOrKeyword({ pid })\n    const itemRaw = Array.isArray(raw?.data?.list)\n      ? raw.data.list[0]\n      : Array.isArray(raw?.data?.content)\n        ? raw.data.content[0]\n        : Array.isArray(raw?.content)\n          ? raw.content[0]\n          : Array.isArray(raw?.data)\n            ? raw.data[0]\n            : (raw?.data || raw)\n\n    const mapped = mapCjItemToProductLike(itemRaw)\n    if (!mapped) {\n      const r = NextResponse.json({ ok: false, error: 'CJ item mapping failed' }, { status: 502 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const up = await upsertProductFromCj(mapped, { updateImages, updateVideo, updatePrice })\n    if (up.ok) {\n      try { await persistRawCj(up.productId, itemRaw) } catch {}\n      const r = NextResponse.json({ ok: true, productId: up.productId, updated: up.updated })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const r = NextResponse.json({ ok: false, error: up.error }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'sync failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2959,"size_tokens":null},"src/app/not-found.tsx":{"content":"\"use client\";\nimport Link from \"next/link\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"container py-20 text-center\">\n      <h1 className=\"text-3xl sm:text-4xl font-bold text-slate-900\">Page Not Found</h1>\n      <p className=\"mt-4 text-slate-600\">\n        Sorry, we couldn't find the page you're looking for.\n      </p>\n      <div className=\"mt-8 flex items-center justify-center gap-4\">\n        <Link href=\"/\" className=\"inline-flex items-center rounded bg-black text-white px-4 py-2 text-sm hover:bg-gray-800\">Back to Home</Link>\n        <Link\n          href=\"/shop\"\n          className=\"inline-flex items-center font-medium text-slate-900 underline decoration-2 underline-offset-4\"\n        >\n          Browse Products\n        </Link>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":793,"size_tokens":null},"src/app/contact/page.tsx":{"content":"import ContactForm from \"@/components/contact-form\";\nexport const metadata = { title: \"Contact Us\" };\n\nexport default function ContactPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Contact Us</h1>\n      <p className=\"mt-2 text-slate-600\">\n        Have questions? Email us at\n        {\" \"}\n        <a className=\"underline\" href=\"mailto:support@shopixo.com\">support@shopixo.com</a>\n        {\" \"}\n        or use the form below to get in touch.\n      </p>\n      <ContactForm />\n    </div>\n  );\n}\n","path":null,"size_bytes":554,"size_tokens":null},"src/app/admin/jobs/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\nimport type { Route } from \"next\";\nimport { ArrowLeft, RefreshCw, Clock, CheckCircle, XCircle, Pause, Play } from \"lucide-react\";\n\ntype JobRow = {\n  id: number;\n  created_at: string;\n  kind: string;\n  status: string;\n  started_at?: string | null;\n  finished_at?: string | null;\n  totals?: any;\n  error_text?: string | null;\n};\n\ntype JobsResp = { ok: boolean; jobs?: JobRow[]; error?: string; tablesMissing?: boolean };\n\nexport default function JobsPage() {\n  const [rows, setRows] = useState<JobRow[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [tablesMissing, setTablesMissing] = useState(false);\n  const [loading, setLoading] = useState(true);\n  const [acting, setActing] = useState<number | null>(null);\n\n  async function load() {\n    setLoading(true);\n    setError(null);\n    setTablesMissing(false);\n    try {\n      const r = await fetch(`/api/admin/jobs?limit=100`, { cache: \"no-store\" });\n      const j: JobsResp = await r.json();\n      if (j.tablesMissing) {\n        setTablesMissing(true);\n        setError(j.error || 'Database tables missing');\n        setRows([]);\n        return;\n      }\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setRows(j.jobs || []);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load jobs\");\n      setRows([]);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function cancel(id: number) {\n    setActing(id);\n    setError(null);\n    try {\n      const r = await fetch(`/api/admin/jobs/${id}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ action: \"cancel\" }),\n      });\n      const j = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await load();\n    } catch (e: any) {\n      setError(e?.message || \"Cancel failed\");\n    } finally {\n      setActing(null);\n    }\n  }\n\n  useEffect(() => {\n    load();\n    const t = setInterval(load, 10000);\n    return () => clearInterval(t);\n  }, []);\n\n  if (tablesMissing) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/admin\" className=\"text-gray-500 hover:text-gray-700\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Link>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Background Jobs</h1>\n        </div>\n        <div className=\"rounded-lg border-2 border-amber-300 bg-amber-50 p-6\">\n          <h2 className=\"text-lg font-semibold text-amber-800 mb-3\">Database Setup Required</h2>\n          <p className=\"text-amber-700 mb-4\">\n            The required database tables <code className=\"bg-amber-100 px-1 rounded\">admin_jobs</code> and <code className=\"bg-amber-100 px-1 rounded\">admin_job_items</code> do not exist.\n          </p>\n          <div className=\"bg-white rounded border p-4 text-sm\">\n            <p className=\"font-medium mb-2\">To fix this, run the following SQL in your Supabase SQL Editor:</p>\n            <pre className=\"bg-slate-100 p-3 rounded text-xs overflow-auto whitespace-pre-wrap\">\n{`CREATE TABLE IF NOT EXISTS public.admin_jobs (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  kind TEXT NOT NULL CHECK (kind IN ('finder','import','sync','scanner')),\n  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','running','success','error','canceled')),\n  params JSONB,\n  totals JSONB,\n  started_at TIMESTAMPTZ,\n  finished_at TIMESTAMPTZ,\n  error_text TEXT\n);\n\nCREATE TABLE IF NOT EXISTS public.admin_job_items (\n  id BIGSERIAL PRIMARY KEY,\n  job_id BIGINT NOT NULL REFERENCES public.admin_jobs(id) ON DELETE CASCADE,\n  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','running','success','error','skipped','canceled')),\n  step TEXT,\n  cj_product_id TEXT,\n  cj_sku TEXT,\n  result JSONB,\n  error_text TEXT,\n  started_at TIMESTAMPTZ,\n  finished_at TIMESTAMPTZ\n);\n\nCREATE INDEX IF NOT EXISTS idx_admin_jobs_status_created ON public.admin_jobs(status, created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_admin_job_items_job ON public.admin_job_items(job_id);`}\n            </pre>\n          </div>\n          <button onClick={load} className=\"mt-4 rounded bg-amber-600 px-4 py-2 text-white hover:bg-amber-700\">\n            Retry\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \"success\":\n        return \"bg-green-100 text-green-700\";\n      case \"running\":\n        return \"bg-blue-100 text-blue-700\";\n      case \"pending\":\n        return \"bg-amber-100 text-amber-700\";\n      case \"failed\":\n      case \"error\":\n        return \"bg-red-100 text-red-700\";\n      case \"canceled\":\n        return \"bg-gray-100 text-gray-700\";\n      default:\n        return \"bg-gray-100 text-gray-600\";\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \"success\":\n        return <CheckCircle className=\"h-4 w-4\" />;\n      case \"running\":\n        return <RefreshCw className=\"h-4 w-4 animate-spin\" />;\n      case \"pending\":\n        return <Clock className=\"h-4 w-4\" />;\n      case \"failed\":\n      case \"error\":\n        return <XCircle className=\"h-4 w-4\" />;\n      case \"canceled\":\n        return <Pause className=\"h-4 w-4\" />;\n      default:\n        return <Clock className=\"h-4 w-4\" />;\n    }\n  };\n\n  const formatDuration = (start?: string | null, end?: string | null) => {\n    if (!start) return \"-\";\n    const startTime = new Date(start).getTime();\n    const endTime = end ? new Date(end).getTime() : Date.now();\n    const duration = Math.round((endTime - startTime) / 1000);\n    if (duration < 60) return `${duration}s`;\n    return `${Math.floor(duration / 60)}m ${duration % 60}s`;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/admin\" className=\"text-gray-500 hover:text-gray-700\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold text-gray-900\">Background Jobs</h1>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              Monitor and manage automated tasks\n            </p>\n          </div>\n        </div>\n        <button\n          onClick={load}\n          disabled={loading}\n          className=\"inline-flex items-center gap-2 rounded-lg border px-4 py-2 text-sm font-medium hover:bg-gray-50\"\n        >\n          <RefreshCw className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`} />\n          Refresh\n        </button>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-700\">\n          {error}\n        </div>\n      )}\n\n      <div className=\"rounded-xl border bg-white shadow-sm overflow-hidden\">\n        {loading && rows.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500\">Loading jobs...</div>\n        ) : rows.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500\">\n            <Clock className=\"h-12 w-12 mx-auto text-gray-300 mb-3\" />\n            <p className=\"font-medium\">No jobs yet</p>\n            <p className=\"text-sm mt-1\">\n              Background jobs will appear here when tasks are running\n            </p>\n          </div>\n        ) : (\n          <table className=\"min-w-full text-sm\">\n            <thead>\n              <tr className=\"bg-gray-50 border-b\">\n                <th className=\"px-4 py-3 text-left font-medium text-gray-600\">ID</th>\n                <th className=\"px-4 py-3 text-left font-medium text-gray-600\">Type</th>\n                <th className=\"px-4 py-3 text-left font-medium text-gray-600\">Status</th>\n                <th className=\"px-4 py-3 text-left font-medium text-gray-600\">Duration</th>\n                <th className=\"px-4 py-3 text-left font-medium text-gray-600\">Created</th>\n                <th className=\"px-4 py-3 text-right font-medium text-gray-600\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y\">\n              {rows.map((j) => (\n                <tr key={j.id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-4 py-3 font-mono text-xs\">{j.id}</td>\n                  <td className=\"px-4 py-3\">{j.kind}</td>\n                  <td className=\"px-4 py-3\">\n                    <span\n                      className={`inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-xs font-medium ${getStatusColor(\n                        j.status\n                      )}`}\n                    >\n                      {getStatusIcon(j.status)}\n                      {j.status}\n                    </span>\n                  </td>\n                  <td className=\"px-4 py-3 text-gray-500\">\n                    {formatDuration(j.started_at, j.finished_at)}\n                  </td>\n                  <td className=\"px-4 py-3 text-gray-500\">\n                    {new Date(j.created_at).toLocaleString()}\n                  </td>\n                  <td className=\"px-4 py-3 text-right\">\n                    <div className=\"inline-flex gap-2\">\n                      <Link\n                        href={`/admin/jobs/${j.id}` as Route}\n                        className=\"rounded-lg border px-3 py-1.5 text-xs font-medium hover:bg-gray-50\"\n                      >\n                        Details\n                      </Link>\n                      {j.status !== \"success\" && j.status !== \"canceled\" && j.status !== \"failed\" && (\n                        <button\n                          onClick={() => cancel(j.id)}\n                          disabled={acting === j.id}\n                          className=\"rounded-lg border border-red-200 px-3 py-1.5 text-xs font-medium text-red-600 hover:bg-red-50 disabled:opacity-50\"\n                        >\n                          Cancel\n                        </button>\n                      )}\n                    </div>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10193,"size_tokens":null},"src/lib/db-features.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\n// Centralized DB feature detection with simple in-memory caching.\n// - hasTable(table)\n// - hasColumn(table, column)\n// - hasColumns(table, [columns])\n// The checks are optimistic on failures (assume feature exists) to avoid breaking runtime paths.\n\nfunction getSupabaseAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\ntype ColumnCache = Map<string, boolean>;\n\nconst tableCache = new Map<string, boolean>();\nconst columnCache = new Map<string, ColumnCache>();\n\nexport function clearDbFeatureCache() {\n  tableCache.clear();\n  columnCache.clear();\n}\n\nexport async function hasTable(table: string): Promise<boolean> {\n  const cached = tableCache.get(table);\n  if (typeof cached === 'boolean') return cached;\n  const supabase = getSupabaseAdmin();\n  if (!supabase) {\n    // If service role is not configured, assume table exists (non-breaking default)\n    tableCache.set(table, true);\n    return true;\n  }\n  try {\n    const { error } = await supabase.from(table).select('*').limit(0);\n    if (error) {\n      const msg = String((error as any)?.message || error);\n      if (/does not exist|relation .* does not exist/i.test(msg)) {\n        tableCache.set(table, false);\n        return false;\n      }\n      // Other errors (e.g., network): assume exists to avoid hard failures\n    }\n    tableCache.set(table, true);\n    return true;\n  } catch {\n    tableCache.set(table, true);\n    return true;\n  }\n}\n\nexport async function hasColumn(table: string, column: string): Promise<boolean> {\n  let tCache = columnCache.get(table);\n  if (!tCache) {\n    tCache = new Map<string, boolean>();\n    columnCache.set(table, tCache);\n  }\n  const cached = tCache.get(column);\n  if (typeof cached === 'boolean') return cached;\n\n  const supabase = getSupabaseAdmin();\n  if (!supabase) {\n    tCache.set(column, true);\n    return true;\n  }\n  try {\n    const { error } = await supabase.from(table).select(column).limit(0);\n    if (error) {\n      const msg = String((error as any)?.message || error);\n      if (/column .* does not exist|does not exist/i.test(msg)) {\n        tCache.set(column, false);\n        return false;\n      }\n      // Other errors -> optimistic true\n    }\n    tCache.set(column, true);\n    return true;\n  } catch {\n    tCache.set(column, true);\n    return true;\n  }\n}\n\nexport async function hasColumns(table: string, columns: string[]): Promise<Record<string, boolean>> {\n  const result: Record<string, boolean> = {};\n  const pairs = await Promise.all(columns.map(async (c) => [c, await hasColumn(table, c)] as const));\n  for (const [c, ok] of pairs) result[c] = ok;\n  return result;\n}\n","path":null,"size_bytes":2809,"size_tokens":null},"src/components/theme-toggle.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Moon, Sun } from \"lucide-react\"\nimport { useTheme } from \"next-themes\"\n\nimport { Button } from \"@/components/ui/button\"\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\"\n\nexport function ThemeToggle() {\n  const { setTheme } = useTheme()\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"ghost\" size=\"icon\" className=\"h-9 w-9 relative rounded-full\">\n          <Sun className=\"h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0\" />\n          <Moon className=\"absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100\" />\n          <span className=\"sr-only\">Toggle theme</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem onClick={() => setTheme(\"light\")}>\n          Light Mode\n        </DropdownMenuItem>\n        <DropdownMenuItem onClick={() => setTheme(\"dark\")}>\n          Dark Mode\n        </DropdownMenuItem>\n        <DropdownMenuItem onClick={() => setTheme(\"system\")}>\n          System\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  )\n}\n","path":null,"size_bytes":1259,"size_tokens":null},"src/app/api/stripe/webhook/route.ts":{"content":"import { handleStripeWebhook } from \"@/lib/webhooks/stripe-handler\";\n\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\nexport async function POST(req: Request) {\n  return handleStripeWebhook(req);\n}\n","path":null,"size_bytes":253,"size_tokens":null},"src/app/forgot-password/page.tsx":{"content":"import ForgotPasswordForm from \"./forgot-password-form\"\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\"\nimport { cookies } from \"next/headers\"\nimport { redirect } from \"next/navigation\"\n\nexport const metadata = { title: \"Reset Password\" }\nexport const dynamic = \"force-dynamic\"\nexport const revalidate = 0\n\nexport default async function ForgotPasswordPage() {\n  const supabase = createServerComponentClient({ cookies })\n  const { data } = await supabase.auth.getSession()\n  if (data?.session) {\n    redirect(\"/\")\n  }\n  return (\n    <div className=\"container flex min-h-[70vh] w-full flex-col items-center justify-center py-12\">\n      <div className=\"w-full max-w-md rounded-xl border bg-white p-8 shadow-sm\">\n        <ForgotPasswordForm />\n      </div>\n    </div>\n  )\n}\n","path":null,"size_bytes":798,"size_tokens":null},"docs/cj-admin-guide.md":{"content":"# CJ Admin Guide\n\nThis guide explains how to operate the CJ integration in your store.\n\n## Prerequisites\n- Set the following environment variables in Vercel with exact names:\n  - CJ_API_KEY (or CJ_ACCESS_TOKEN)\n  - CJ_API_BASE\n  - CJ_EMAIL\n  - CJ_WEBHOOK_SECRET\n  - NEXT_PUBLIC_SUPABASE_URL\n  - SUPABASE_SERVICE_ROLE_KEY\n  - OPENAI_API_KEY (optional)\n  - AI_MODEL_TEXT (optional)\n- Redeploy the app after saving the variables.\n\n## Admin pages\n- Hub: /admin/cj\n- Catalog refresh: /admin/cj/refresh\n- Shipping calculator: /admin/cj/shipping\n- Product detail (raw + mapped + actions): /admin/cj/product/[pid]\n\n## Catalog refresh (batch)\n1) Open /admin/cj/refresh.\n2) Set `pageNum` and `pageSize` (20–50 recommended), optionally a keyword.\n3) Keep toggles ON for Update Images/Video/Price.\n4) Click \"Run Batch\". Repeat with next pageNum until done.\n\n## Re-sync a single product\n1) On /admin/cj/refresh, use the second form.\n2) Paste the CJ PID (GUID). Keep all toggles ON.\n3) Submit. The product is upserted, images filtered, video saved, variants refreshed.\n\n## Product inspector\n- Go to /admin/cj/product/[pid].\n  - Left: mapped data, images, variants summary.\n  - Right: raw CJ JSON for auditing.\n  - Actions: Force re-sync (images + video + price), Shipping preview.\n\n## Shipping calculator\n- Use /admin/cj/shipping to test `freightCalculate` by country, PID/SKU, and quantity.\n- Use results to verify delivery time windows and carrier pricing.\n\n## Webhook\n- Endpoint: /api/cj/webhook\n- Secure with CJ_WEBHOOK_SECRET (HMAC-SHA256). Use header `x-cj-signature`.\n- Purpose: keep tracking / shipping updates in sync.\n\n## Notes\n- Prices are computed as: cost + cheapest shipping + margin, then rounded, with a price floor.\n- Image filtering removes badges, logos, flags, size charts, and small thumbnails.\n- All API calls include timeouts, retries, and request correlation via `x-request-id`.\n","path":null,"size_bytes":1891,"size_tokens":null},"src/lib/notify.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\nfunction getAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nexport async function saveNotification(input: { type: string; title: string; body?: string | null; meta?: any; status?: 'unread' | 'read' | 'archived' }) {\n  const db = getAdmin();\n  if (!db) return false;\n  const row = {\n    type: input.type,\n    title: input.title,\n    body: input.body ?? null,\n    meta: input.meta ?? null,\n    status: input.status ?? 'unread',\n  };\n  const { error } = await db.from('notifications').insert(row);\n  return !error;\n}\n\nexport async function listNotifications(limit = 50): Promise<any[]> {\n  const db = getAdmin();\n  if (!db) return [];\n  const { data } = await db.from('notifications').select('*').order('created_at', { ascending: false }).limit(limit);\n  return data || [];\n}\n","path":null,"size_bytes":1003,"size_tokens":null},"src/lib/review-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\n\nfunction parseIntOrNull(v: FormDataEntryValue | null): number | null {\n  if (v == null) return null;\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n}\n\nexport async function updateReview(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/reviews\");\n\n  const id = parseIntOrNull(formData.get(\"id\"));\n  const rating = parseIntOrNull(formData.get(\"rating\"));\n  const titleRaw = String(formData.get(\"title\") || \"\").trim();\n  const bodyRaw = String(formData.get(\"body\") || \"\").trim();\n\n  if (!id) throw new Error(\"Invalid review id\");\n  if (!rating || rating < 1 || rating > 5) throw new Error(\"Rating must be between 1 and 5\");\n\n  const title = titleRaw.length ? titleRaw : null;\n  const body = bodyRaw.length ? bodyRaw : null;\n\n  const { error } = await supabase\n    .from(\"reviews\")\n    .update({ rating, title, body })\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id);\n\n  if (error) {\n    console.error(\"updateReview error\", error);\n    throw new Error(\"Failed to update review.\");\n  }\n  revalidatePath(\"/account/reviews\");\n}\n\nexport async function deleteReview(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/reviews\");\n\n  const id = parseIntOrNull(formData.get(\"id\"));\n  if (!id) throw new Error(\"Invalid review id\");\n\n  const { error } = await supabase\n    .from(\"reviews\")\n    .delete()\n    .eq(\"id\", id)\n    .eq(\"user_id\", user.id);\n\n  if (error) {\n    console.error(\"deleteReview error\", error);\n    throw new Error(\"Failed to delete review.\");\n  }\n  revalidatePath(\"/account/reviews\");\n}\n","path":null,"size_bytes":2011,"size_tokens":null},"src/lib/supabase-server.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\nexport function getSupabaseAnonServer(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  if (!url || !anon) {\n    return null;\n  }\n  return createClient(url, anon);\n}\n","path":null,"size_bytes":326,"size_tokens":null},"src/app/api/admin/cj/settings/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { getSetting, setSetting, hasSettingsTable } from '@/lib/settings'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nconst KEY = 'cj_config'\n\ntype CjConfig = {\n  email?: string | null\n  apiKey?: string | null\n  base?: string | null\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const tableExists = await hasSettingsTable()\n    if (!tableExists) {\n      const r = NextResponse.json({ \n        ok: false, \n        error: 'Database table missing. Please run migrations: kv_settings table required.',\n        tablesMissing: true \n      }, { status: 503 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const cfg = await getSetting<CjConfig>(KEY, { email: null, apiKey: null, base: null })\n    const email = cfg?.email || null\n    const base = cfg?.base || null\n    const configured = !!(cfg?.email && cfg?.apiKey)\n    const r = NextResponse.json({ ok: true, configured, emailPreview: email ? (email.replace(/(.{2}).+(@.*)/, '$1***$2')) : null, base })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'cj settings load failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const tableExists = await hasSettingsTable()\n    if (!tableExists) {\n      const r = NextResponse.json({ \n        ok: false, \n        error: 'Database table missing. Please run migrations: kv_settings table required.',\n        tablesMissing: true \n      }, { status: 503 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const next: CjConfig = {\n      email: typeof body.email === 'string' ? body.email.trim() : null,\n      apiKey: typeof body.apiKey === 'string' ? body.apiKey.trim() : null,\n      base: typeof body.base === 'string' ? (body.base.trim() || null) : null,\n    }\n    const result = await setSetting(KEY, next)\n    if (!result.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Failed to save settings' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const r = NextResponse.json({ ok: true })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'cj settings save failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":3262,"size_tokens":null},"tests-examples/demo-todo-app.spec.ts":{"content":"import { test, expect, type Page } from '@playwright/test';\n\ntest.beforeEach(async ({ page }) => {\n  await page.goto('https://demo.playwright.dev/todomvc');\n});\n\nconst TODO_ITEMS = [\n  'buy some cheese',\n  'feed the cat',\n  'book a doctors appointment'\n] as const;\n\ntest.describe('New Todo', () => {\n  test('should allow me to add todo items', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n\n    // Create 1st todo.\n    await newTodo.fill(TODO_ITEMS[0]);\n    await newTodo.press('Enter');\n\n    // Make sure the list only has one todo item.\n    await expect(page.getByTestId('todo-title')).toHaveText([\n      TODO_ITEMS[0]\n    ]);\n\n    // Create 2nd todo.\n    await newTodo.fill(TODO_ITEMS[1]);\n    await newTodo.press('Enter');\n\n    // Make sure the list now has two todo items.\n    await expect(page.getByTestId('todo-title')).toHaveText([\n      TODO_ITEMS[0],\n      TODO_ITEMS[1]\n    ]);\n\n    await checkNumberOfTodosInLocalStorage(page, 2);\n  });\n\n  test('should clear text input field when an item is added', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n\n    // Create one todo item.\n    await newTodo.fill(TODO_ITEMS[0]);\n    await newTodo.press('Enter');\n\n    // Check that input is empty.\n    await expect(newTodo).toBeEmpty();\n    await checkNumberOfTodosInLocalStorage(page, 1);\n  });\n\n  test('should append new items to the bottom of the list', async ({ page }) => {\n    // Create 3 items.\n    await createDefaultTodos(page);\n\n    // create a todo count locator\n    const todoCount = page.getByTestId('todo-count')\n  \n    // Check test using different methods.\n    await expect(page.getByText('3 items left')).toBeVisible();\n    await expect(todoCount).toHaveText('3 items left');\n    await expect(todoCount).toContainText('3');\n    await expect(todoCount).toHaveText(/3/);\n\n    // Check all items in one call.\n    await expect(page.getByTestId('todo-title')).toHaveText(TODO_ITEMS);\n    await checkNumberOfTodosInLocalStorage(page, 3);\n  });\n});\n\ntest.describe('Mark all as completed', () => {\n  test.beforeEach(async ({ page }) => {\n    await createDefaultTodos(page);\n    await checkNumberOfTodosInLocalStorage(page, 3);\n  });\n\n  test.afterEach(async ({ page }) => {\n    await checkNumberOfTodosInLocalStorage(page, 3);\n  });\n\n  test('should allow me to mark all items as completed', async ({ page }) => {\n    // Complete all todos.\n    await page.getByLabel('Mark all as complete').check();\n\n    // Ensure all todos have 'completed' class.\n    await expect(page.getByTestId('todo-item')).toHaveClass(['completed', 'completed', 'completed']);\n    await checkNumberOfCompletedTodosInLocalStorage(page, 3);\n  });\n\n  test('should allow me to clear the complete state of all items', async ({ page }) => {\n    const toggleAll = page.getByLabel('Mark all as complete');\n    // Check and then immediately uncheck.\n    await toggleAll.check();\n    await toggleAll.uncheck();\n\n    // Should be no completed classes.\n    await expect(page.getByTestId('todo-item')).toHaveClass(['', '', '']);\n  });\n\n  test('complete all checkbox should update state when items are completed / cleared', async ({ page }) => {\n    const toggleAll = page.getByLabel('Mark all as complete');\n    await toggleAll.check();\n    await expect(toggleAll).toBeChecked();\n    await checkNumberOfCompletedTodosInLocalStorage(page, 3);\n\n    // Uncheck first todo.\n    const firstTodo = page.getByTestId('todo-item').nth(0);\n    await firstTodo.getByRole('checkbox').uncheck();\n\n    // Reuse toggleAll locator and make sure its not checked.\n    await expect(toggleAll).not.toBeChecked();\n\n    await firstTodo.getByRole('checkbox').check();\n    await checkNumberOfCompletedTodosInLocalStorage(page, 3);\n\n    // Assert the toggle all is checked again.\n    await expect(toggleAll).toBeChecked();\n  });\n});\n\ntest.describe('Item', () => {\n\n  test('should allow me to mark items as complete', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n\n    // Create two items.\n    for (const item of TODO_ITEMS.slice(0, 2)) {\n      await newTodo.fill(item);\n      await newTodo.press('Enter');\n    }\n\n    // Check first item.\n    const firstTodo = page.getByTestId('todo-item').nth(0);\n    await firstTodo.getByRole('checkbox').check();\n    await expect(firstTodo).toHaveClass('completed');\n\n    // Check second item.\n    const secondTodo = page.getByTestId('todo-item').nth(1);\n    await expect(secondTodo).not.toHaveClass('completed');\n    await secondTodo.getByRole('checkbox').check();\n\n    // Assert completed class.\n    await expect(firstTodo).toHaveClass('completed');\n    await expect(secondTodo).toHaveClass('completed');\n  });\n\n  test('should allow me to un-mark items as complete', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n\n    // Create two items.\n    for (const item of TODO_ITEMS.slice(0, 2)) {\n      await newTodo.fill(item);\n      await newTodo.press('Enter');\n    }\n\n    const firstTodo = page.getByTestId('todo-item').nth(0);\n    const secondTodo = page.getByTestId('todo-item').nth(1);\n    const firstTodoCheckbox = firstTodo.getByRole('checkbox');\n\n    await firstTodoCheckbox.check();\n    await expect(firstTodo).toHaveClass('completed');\n    await expect(secondTodo).not.toHaveClass('completed');\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n\n    await firstTodoCheckbox.uncheck();\n    await expect(firstTodo).not.toHaveClass('completed');\n    await expect(secondTodo).not.toHaveClass('completed');\n    await checkNumberOfCompletedTodosInLocalStorage(page, 0);\n  });\n\n  test('should allow me to edit an item', async ({ page }) => {\n    await createDefaultTodos(page);\n\n    const todoItems = page.getByTestId('todo-item');\n    const secondTodo = todoItems.nth(1);\n    await secondTodo.dblclick();\n    await expect(secondTodo.getByRole('textbox', { name: 'Edit' })).toHaveValue(TODO_ITEMS[1]);\n    await secondTodo.getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');\n    await secondTodo.getByRole('textbox', { name: 'Edit' }).press('Enter');\n\n    // Explicitly assert the new text value.\n    await expect(todoItems).toHaveText([\n      TODO_ITEMS[0],\n      'buy some sausages',\n      TODO_ITEMS[2]\n    ]);\n    await checkTodosInLocalStorage(page, 'buy some sausages');\n  });\n});\n\ntest.describe('Editing', () => {\n  test.beforeEach(async ({ page }) => {\n    await createDefaultTodos(page);\n    await checkNumberOfTodosInLocalStorage(page, 3);\n  });\n\n  test('should hide other controls when editing', async ({ page }) => {\n    const todoItem = page.getByTestId('todo-item').nth(1);\n    await todoItem.dblclick();\n    await expect(todoItem.getByRole('checkbox')).not.toBeVisible();\n    await expect(todoItem.locator('label', {\n      hasText: TODO_ITEMS[1],\n    })).not.toBeVisible();\n    await checkNumberOfTodosInLocalStorage(page, 3);\n  });\n\n  test('should save edits on blur', async ({ page }) => {\n    const todoItems = page.getByTestId('todo-item');\n    await todoItems.nth(1).dblclick();\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).dispatchEvent('blur');\n\n    await expect(todoItems).toHaveText([\n      TODO_ITEMS[0],\n      'buy some sausages',\n      TODO_ITEMS[2],\n    ]);\n    await checkTodosInLocalStorage(page, 'buy some sausages');\n  });\n\n  test('should trim entered text', async ({ page }) => {\n    const todoItems = page.getByTestId('todo-item');\n    await todoItems.nth(1).dblclick();\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('    buy some sausages    ');\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Enter');\n\n    await expect(todoItems).toHaveText([\n      TODO_ITEMS[0],\n      'buy some sausages',\n      TODO_ITEMS[2],\n    ]);\n    await checkTodosInLocalStorage(page, 'buy some sausages');\n  });\n\n  test('should remove the item if an empty text string was entered', async ({ page }) => {\n    const todoItems = page.getByTestId('todo-item');\n    await todoItems.nth(1).dblclick();\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('');\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Enter');\n\n    await expect(todoItems).toHaveText([\n      TODO_ITEMS[0],\n      TODO_ITEMS[2],\n    ]);\n  });\n\n  test('should cancel edits on escape', async ({ page }) => {\n    const todoItems = page.getByTestId('todo-item');\n    await todoItems.nth(1).dblclick();\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).fill('buy some sausages');\n    await todoItems.nth(1).getByRole('textbox', { name: 'Edit' }).press('Escape');\n    await expect(todoItems).toHaveText(TODO_ITEMS);\n  });\n});\n\ntest.describe('Counter', () => {\n  test('should display the current number of todo items', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n    \n    // create a todo count locator\n    const todoCount = page.getByTestId('todo-count')\n\n    await newTodo.fill(TODO_ITEMS[0]);\n    await newTodo.press('Enter');\n\n    await expect(todoCount).toContainText('1');\n\n    await newTodo.fill(TODO_ITEMS[1]);\n    await newTodo.press('Enter');\n    await expect(todoCount).toContainText('2');\n\n    await checkNumberOfTodosInLocalStorage(page, 2);\n  });\n});\n\ntest.describe('Clear completed button', () => {\n  test.beforeEach(async ({ page }) => {\n    await createDefaultTodos(page);\n  });\n\n  test('should display the correct text', async ({ page }) => {\n    await page.locator('.todo-list li .toggle').first().check();\n    await expect(page.getByRole('button', { name: 'Clear completed' })).toBeVisible();\n  });\n\n  test('should remove completed items when clicked', async ({ page }) => {\n    const todoItems = page.getByTestId('todo-item');\n    await todoItems.nth(1).getByRole('checkbox').check();\n    await page.getByRole('button', { name: 'Clear completed' }).click();\n    await expect(todoItems).toHaveCount(2);\n    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[2]]);\n  });\n\n  test('should be hidden when there are no items that are completed', async ({ page }) => {\n    await page.locator('.todo-list li .toggle').first().check();\n    await page.getByRole('button', { name: 'Clear completed' }).click();\n    await expect(page.getByRole('button', { name: 'Clear completed' })).toBeHidden();\n  });\n});\n\ntest.describe('Persistence', () => {\n  test('should persist its data', async ({ page }) => {\n    // create a new todo locator\n    const newTodo = page.getByPlaceholder('What needs to be done?');\n\n    for (const item of TODO_ITEMS.slice(0, 2)) {\n      await newTodo.fill(item);\n      await newTodo.press('Enter');\n    }\n\n    const todoItems = page.getByTestId('todo-item');\n    const firstTodoCheck = todoItems.nth(0).getByRole('checkbox');\n    await firstTodoCheck.check();\n    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[1]]);\n    await expect(firstTodoCheck).toBeChecked();\n    await expect(todoItems).toHaveClass(['completed', '']);\n\n    // Ensure there is 1 completed item.\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n\n    // Now reload.\n    await page.reload();\n    await expect(todoItems).toHaveText([TODO_ITEMS[0], TODO_ITEMS[1]]);\n    await expect(firstTodoCheck).toBeChecked();\n    await expect(todoItems).toHaveClass(['completed', '']);\n  });\n});\n\ntest.describe('Routing', () => {\n  test.beforeEach(async ({ page }) => {\n    await createDefaultTodos(page);\n    // make sure the app had a chance to save updated todos in storage\n    // before navigating to a new view, otherwise the items can get lost :(\n    // in some frameworks like Durandal\n    await checkTodosInLocalStorage(page, TODO_ITEMS[0]);\n  });\n\n  test('should allow me to display active items', async ({ page }) => {\n    const todoItem = page.getByTestId('todo-item');\n    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();\n\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n    await page.getByRole('link', { name: 'Active' }).click();\n    await expect(todoItem).toHaveCount(2);\n    await expect(todoItem).toHaveText([TODO_ITEMS[0], TODO_ITEMS[2]]);\n  });\n\n  test('should respect the back button', async ({ page }) => {\n    const todoItem = page.getByTestId('todo-item'); \n    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();\n\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n\n    await test.step('Showing all items', async () => {\n      await page.getByRole('link', { name: 'All' }).click();\n      await expect(todoItem).toHaveCount(3);\n    });\n\n    await test.step('Showing active items', async () => {\n      await page.getByRole('link', { name: 'Active' }).click();\n    });\n\n    await test.step('Showing completed items', async () => {\n      await page.getByRole('link', { name: 'Completed' }).click();\n    });\n\n    await expect(todoItem).toHaveCount(1);\n    await page.goBack();\n    await expect(todoItem).toHaveCount(2);\n    await page.goBack();\n    await expect(todoItem).toHaveCount(3);\n  });\n\n  test('should allow me to display completed items', async ({ page }) => {\n    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n    await page.getByRole('link', { name: 'Completed' }).click();\n    await expect(page.getByTestId('todo-item')).toHaveCount(1);\n  });\n\n  test('should allow me to display all items', async ({ page }) => {\n    await page.getByTestId('todo-item').nth(1).getByRole('checkbox').check();\n    await checkNumberOfCompletedTodosInLocalStorage(page, 1);\n    await page.getByRole('link', { name: 'Active' }).click();\n    await page.getByRole('link', { name: 'Completed' }).click();\n    await page.getByRole('link', { name: 'All' }).click();\n    await expect(page.getByTestId('todo-item')).toHaveCount(3);\n  });\n\n  test('should highlight the currently applied filter', async ({ page }) => {\n    await expect(page.getByRole('link', { name: 'All' })).toHaveClass('selected');\n    \n    //create locators for active and completed links\n    const activeLink = page.getByRole('link', { name: 'Active' });\n    const completedLink = page.getByRole('link', { name: 'Completed' });\n    await activeLink.click();\n\n    // Page change - active items.\n    await expect(activeLink).toHaveClass('selected');\n    await completedLink.click();\n\n    // Page change - completed items.\n    await expect(completedLink).toHaveClass('selected');\n  });\n});\n\nasync function createDefaultTodos(page: Page) {\n  // create a new todo locator\n  const newTodo = page.getByPlaceholder('What needs to be done?');\n\n  for (const item of TODO_ITEMS) {\n    await newTodo.fill(item);\n    await newTodo.press('Enter');\n  }\n}\n\nasync function checkNumberOfTodosInLocalStorage(page: Page, expected: number) {\n  return await page.waitForFunction(e => {\n    return JSON.parse(localStorage['react-todos']).length === e;\n  }, expected);\n}\n\nasync function checkNumberOfCompletedTodosInLocalStorage(page: Page, expected: number) {\n  return await page.waitForFunction(e => {\n    return JSON.parse(localStorage['react-todos']).filter((todo: any) => todo.completed).length === e;\n  }, expected);\n}\n\nasync function checkTodosInLocalStorage(page: Page, title: string) {\n  return await page.waitForFunction(t => {\n    return JSON.parse(localStorage['react-todos']).map((todo: any) => todo.title).includes(t);\n  }, title);\n}\n","path":null,"size_bytes":15674,"size_tokens":null},"src/app/forgot-password/forgot-password-form.tsx":{"content":"\"use client\"\n\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\"\nimport { useSearchParams } from \"next/navigation\"\nimport { useState, useTransition, useEffect } from \"react\"\n\nexport default function ForgotPasswordForm() {\n  const supabase = createClientComponentClient()\n  const params = useSearchParams()\n  const [email, setEmail] = useState(\"\")\n  const [message, setMessage] = useState(\"\")\n  const [error, setError] = useState(\"\")\n  const [pending, startTransition] = useTransition()\n\n  useEffect(() => {\n    const e = params?.get(\"email\") || \"\"\n    if (e) setEmail(e)\n  }, [params])\n\n  const base = (process.env.NEXT_PUBLIC_SITE_URL && process.env.NEXT_PUBLIC_SITE_URL.trim().length > 0)\n    ? process.env.NEXT_PUBLIC_SITE_URL\n    : (typeof window !== \"undefined\" ? window.location.origin : \"\")\n  const nextParam = (params?.get(\"redirect\") || params?.get(\"next\") || \"/\").toString()\n  const safeNext = nextParam.startsWith(\"/\") && !nextParam.startsWith(\"//\") ? nextParam : \"/\"\n  const targetAfterCallback = safeNext && safeNext !== \"/\" ? `/reset-password?next=${encodeURIComponent(safeNext)}` : \"/reset-password\"\n  const redirectTo = base ? `${base.replace(/\\/$/, \"\")}/auth/callback?next=${encodeURIComponent(targetAfterCallback)}` : `/auth/callback?next=${encodeURIComponent(targetAfterCallback)}`\n\n  function onSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    setError(\"\")\n    setMessage(\"\")\n    if (!email) { setError(\"Please enter your email address\"); return }\n    startTransition(async () => {\n      const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo })\n      if (error) setError(error.message)\n      else setMessage(`Reset link sent to ${email}. Please check your inbox.`)\n    })\n  }\n\n  return (\n    <form onSubmit={onSubmit} className=\"space-y-4\">\n      <h2 className=\"text-center text-2xl font-bold\">Reset Password</h2>\n      <div className=\"grid gap-2\">\n        <label className=\"text-sm\">Email</label>\n        <input type=\"email\" required value={email} onChange={(e) => setEmail(e.target.value)} className=\"rounded-full border px-4 py-3\" placeholder=\"example@email.com\" />\n      </div>\n      <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">Send Reset Link</button>\n      {message && <div className=\"rounded-md border border-emerald-500 bg-emerald-50 p-2 text-sm text-emerald-700\">{message}</div>}\n      {error && <div className=\"rounded-md border border-destructive bg-destructive/10 p-2 text-sm text-destructive\">{error}</div>}\n    </form>\n  )\n}\n","path":null,"size_bytes":2596,"size_tokens":null},"src/lib/stripe-webhook-handler.ts":{"content":"import { getStripe } from \"@/lib/stripe\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport type Stripe from \"stripe\";\nimport { maybeCreateCjOrderForOrderId } from '@/lib/ops/cj-fulfill';\nimport { loggerForRequest } from '@/lib/log';\nimport { ensureEnv, getEnv } from '@/lib/env';\n\nexport async function handleStripeWebhook(req: Request): Promise<Response> {\n  const log = loggerForRequest(req);\n  const textBody = await req.text();\n  const signature =\n    (req.headers.get(\"stripe-signature\") as string | null) ||\n    (req.headers.get(\"Stripe-Signature\") as string | null);\n\n  const need = ensureEnv(['STRIPE_WEBHOOK_SECRET','NEXT_PUBLIC_SUPABASE_URL','SUPABASE_SERVICE_ROLE_KEY']);\n  if (!need.ok) {\n    log.error(\"stripe_webhook_env_missing\", { keys: need.missing });\n    const r = new Response(\"Server misconfiguration\", { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const webhookSecret = getEnv('STRIPE_WEBHOOK_SECRET') as string;\n  const supabaseUrl = getEnv('NEXT_PUBLIC_SUPABASE_URL') as string;\n  const serviceRoleKey = getEnv('SUPABASE_SERVICE_ROLE_KEY') as string;\n\n  if (!signature) {\n    const r = new Response(\"Missing stripe-signature header\", { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  let event: Stripe.Event;\n  try {\n    const stripe = getStripe();\n    event = stripe.webhooks.constructEvent(textBody, signature, webhookSecret);\n  } catch (err: any) {\n    log.error('stripe_webhook_verify_failed', { error: err?.message || String(err) });\n    const r = new Response(`Webhook Error: ${err.message}`, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  log.info(\"stripe_webhook_event\", { id: event.id, type: event.type });\n  const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey);\n\n  try {\n    switch (event.type) {\n      case \"checkout.session.completed\": {\n        const session = event.data.object as Stripe.Checkout.Session;\n        const metadata = session.metadata || {};\n        // We support two formats for backward compatibility:\n        // 1) metadata.cart (JSON string of items)\n        // 2) metadata.cartSessionId (legacy, not used anymore)\n        if (metadata.cart) {\n          const userId = metadata.userId as string | undefined;\n          if (!userId) {\n            log.error(\"stripe_missing_user_id\");\n            break;\n          }\n\n          const parsedCart: Array<{ productId: number | string; variantId?: number | string | null; quantity: number; price: number }>\n            = JSON.parse(metadata.cart as string);\n\n          // Compute total using Stripe-authoritative data (fallback to line items if amount_total is unavailable)\n          let totalAmount = 0;\n          try {\n            if (typeof (session as any).amount_total === 'number') {\n              totalAmount = ((session as any).amount_total as number) / 100;\n            } else {\n              const stripe = getStripe();\n              const li = await stripe.checkout.sessions.listLineItems(session.id, { limit: 100 });\n              const cents = li.data.reduce((acc, item: any) => {\n                const itemTotal = typeof item.amount_total === 'number'\n                  ? item.amount_total\n                  : ((item.price?.unit_amount || 0) * (item.quantity || 1));\n                return acc + itemTotal;\n              }, 0);\n              totalAmount = cents / 100;\n            }\n          } catch (e) {\n            log.warn('stripe_compute_total_fallback');\n            totalAmount = parsedCart.reduce((acc, i) => acc + i.price * i.quantity, 0);\n          }\n\n          // 1) Create or update order (idempotent on stripe_session_id)\n          const { data: order, error: orderError } = await supabaseAdmin\n            .from(\"orders\")\n            .upsert(\n              { user_id: userId, total_amount: totalAmount, status: \"paid\", stripe_session_id: session.id },\n              { onConflict: \"stripe_session_id\" }\n            )\n            .select()\n            .single();\n          if (orderError || !order) {\n            log.error(\"stripe_order_upsert_error\", { error: orderError?.message || String(orderError) });\n            const r = new Response(\"Error creating order\", { status: 500 });\n            r.headers.set('x-request-id', log.requestId);\n            return r;\n          }\n\n          // If order already has items, we've processed this event; exit early (idempotency)\n          const { count: existingItemsCount, error: countError } = await supabaseAdmin\n            .from(\"order_items\")\n            .select(\"id\", { count: \"exact\", head: true })\n            .eq(\"order_id\", order.id);\n          if (countError) {\n            log.warn(\"stripe_order_items_count_error\", { error: countError?.message || String(countError) });\n          }\n          if ((existingItemsCount ?? 0) > 0) {\n            break;\n          }\n\n          // 2) Create order items\n          const orderItems = parsedCart.map((item) => ({\n            order_id: order.id,\n            product_id: typeof item.productId === 'string' ? Number(item.productId) : item.productId,\n            variant_id: item.variantId ? (typeof item.variantId === 'string' ? Number(item.variantId) : item.variantId) : null,\n            quantity: item.quantity,\n            price: item.price,\n          }));\n          const { error: itemsError } = await supabaseAdmin\n            .from(\"order_items\")\n            .insert(orderItems);\n          if (itemsError) {\n            log.error(\"stripe_order_items_error\", { error: itemsError?.message || String(itemsError) });\n            const r = new Response(\"Error creating order items\", { status: 500 });\n            r.headers.set('x-request-id', log.requestId);\n            return r;\n          }\n\n          // 3) Decrement stock (best-effort)\n          await Promise.all(\n            parsedCart.map((item) => {\n              const pid = typeof item.productId === 'string' ? Number(item.productId) : item.productId;\n              const vid = item.variantId ? (typeof item.variantId === 'string' ? Number(item.variantId) : item.variantId) : null;\n              if (vid) {\n                // Decrement variant stock; trigger will recompute product stock\n                return supabaseAdmin.rpc(\"decrement_variant_stock\", {\n                  variant_id_in: vid,\n                  quantity_in: item.quantity,\n                });\n              }\n              // Fallback to product-level stock decrement\n              return supabaseAdmin.rpc(\"decrement_stock\", {\n                product_id_in: pid,\n                quantity_in: item.quantity,\n              });\n            })\n          );\n\n          // 4) Trigger CJ fulfillment (best-effort, non-blocking errors). This is idempotent upstream via CJ orderNo.\n          try {\n            const ful = await maybeCreateCjOrderForOrderId(order.id as number);\n            if (!ful.ok) {\n              log.warn('stripe_cj_fulfillment_warn', { reason: ful.reason });\n            }\n          } catch (e: any) {\n            log.warn('stripe_cj_fulfillment_error', { error: e?.message || String(e) });\n          }\n\n          // 5) Best-effort: clear cart items by session ID (if provided)\n          const cartSessionId = (metadata.cartSessionId as string | undefined) || undefined;\n          if (cartSessionId) {\n            const { error: clearErr } = await supabaseAdmin\n              .from(\"cart_items\")\n              .delete()\n              .eq(\"session_id\", cartSessionId);\n            if (clearErr) {\n              console.warn(\"Failed to clear cart items for session after payment:\", clearErr);\n            }\n          }\n        } else if (metadata.cartSessionId) {\n          // Legacy path: metadata had cartSessionId/userId; keep 200 so Stripe doesn't retry.\n          log.warn(\"stripe_legacy_webhook_format\");\n        }\n        break;\n      }\n      default: {\n        // No-op\n        break;\n      }\n    }\n  } catch (e: any) {\n    log.error(\"stripe_webhook_unhandled_error\", { error: e?.message || String(e) });\n    const r = new Response(\"Internal Server Error\", { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const r = new Response(null, { status: 200 });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":8270,"size_tokens":null},"e2e/verify-deploy.spec.ts":{"content":"import { test, expect } from '@playwright/test';\n\ntest('Verify Theme Toggle on Production', async ({ page }) => {\n  // Navigate to the production URL\n  await page.goto('https://shopixo.vercel.app/');\n\n  // Locate the theme toggle button by its accessible name (Arabic or English)\n  const themeToggleButton = page.getByRole('button', { name: /(?:تبديل السمة|toggle theme)/i });\n\n  // Assert that the button is visible on the page\n  await expect(themeToggleButton).toBeVisible({ timeout: 10000 }); // Wait up to 10 seconds\n});\n","path":null,"size_bytes":535,"size_tokens":null},"src/app/robots.ts":{"content":"import { MetadataRoute } from \"next\";\nimport { getSiteUrl } from \"@/lib/site\";\n\nexport default function robots(): MetadataRoute.Robots {\n  const baseUrl = getSiteUrl();\n  const env = process.env.VERCEL_ENV || process.env.NODE_ENV || \"development\";\n  const isProd = env === \"production\";\n  if (!isProd) {\n    return {\n      rules: [\n        { userAgent: \"*\", disallow: [\"/\"] },\n      ],\n      sitemap: `${baseUrl}/sitemap.xml`,\n      host: baseUrl,\n    };\n  }\n  return {\n    rules: [\n      {\n        userAgent: \"*\",\n        allow: \"/\",\n        disallow: [\"/cart\", \"/checkout\", \"/order-tracking\", \"/account\"],\n      },\n    ],\n    sitemap: `${baseUrl}/sitemap.xml`,\n    host: baseUrl,\n  };\n}\n","path":null,"size_bytes":689,"size_tokens":null},"src/components/mobile-nav.tsx":{"content":"\"use client\";\n\nimport Link from \"next/link\";\nimport { useState } from \"react\";\n\nexport default function MobileNav() {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <div className=\"md:hidden\">\n      <button\n        className=\"rounded-md px-3 py-2 text-sm font-medium\"\n        onClick={() => setOpen(!open)}\n      >\n        Menu\n      </button>\n      {open && (\n        <div className=\"absolute left-0 top-full w-full border-t bg-white\">\n          <nav className=\"container flex flex-col py-2 text-sm\">\n            <Link href=\"/\" className=\"px-3 py-2\" onClick={() => setOpen(false)}>\n              Home\n            </Link>\n            <Link href=\"/shop\" className=\"px-3 py-2\" onClick={() => setOpen(false)}>\n              Shop\n            </Link>\n            <Link href=\"/about\" className=\"px-3 py-2\" onClick={() => setOpen(false)}>\n              About\n            </Link>\n            <Link href=\"/contact\" className=\"px-3 py-2\" onClick={() => setOpen(false)}>\n              Contact\n            </Link>\n            <Link href=\"/faq\" className=\"px-3 py-2\" onClick={() => setOpen(false)}>\n              FAQ\n            </Link>\n          </nav>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1195,"size_tokens":null},"src/app/admin/console/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function AdminConsolePage() {\n  redirect(\"/admin\");\n}\n\n","path":null,"size_bytes":191,"size_tokens":null},"src/lib/sample-products.ts":{"content":"import type { Product } from \"@/lib/types\";\n\n// Samples removed permanently. Keep empty export to avoid import errors if referenced.\nexport const SAMPLE_PRODUCTS: Product[] = [];\n/*\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.4,\n    stock: 70,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\",\"2XL\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"أزرق سماوي\",\"رمادي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1005,\n    title: \"بنطال رياضي رجالي\",\n    slug: \"men-jogger-pants\",\n    description: \"بنطال جوجر بقصة مريحة ومطاط عند الخصر، للاستخدام اليومي والرياضة.\",\n    price: 69,\n    images: [\n      \"https://images.unsplash.com/photo-1520975916090-3105956dac38?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.5,\n    stock: 90,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أسود\",\"رمادي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1006,\n    title: \"فستان صيفي مزهر\",\n    slug: \"women-summer-floral-dress\",\n    description: \"فستان خفيف بنقشة زهور، مثالي للصيف والمشاوير.\",\n    price: 119,\n    images: [\n      \"https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس نسائية\",\n    rating: 4.6,\n    stock: 50,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\"] },\n      { name: \"اللون\", options: [\"زهري\",\"أزرق فاتح\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1007,\n    title: \"طقم أطفال قطني (قطعتان)\",\n    slug: \"kids-cotton-set-2pcs\",\n    description: \"طقم للأطفال من قطعتين بخامة قطنية مريحة.\",\n    price: 59,\n    images: [\n      \"https://images.unsplash.com/photo-1549366021-9f761d450615?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أزياء الأطفال\",\n    rating: 4.8,\n    stock: 100,\n    variants: [\n      { name: \"العمر\", options: [\"2-3\",\"3-4\",\"4-5\",\"5-6\"] },\n      { name: \"اللون\", options: [\"بيج\",\"أزرق\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1008,\n    title: \"شبشب منزلي مبطن\",\n    slug: \"women-cozy-home-slippers\",\n    description: \"شبشب منزلي مبطن ومريح للنساء.\",\n    price: 35,\n    images: [\n      \"https://images.unsplash.com/photo-1703622846437-d99b08a906b0?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أحذية نسائية\",\n    rating: 4.3,\n    stock: 140,\n    variants: [\n      { name: \"المقاس\", options: [\"36\",\"37\",\"38\",\"39\",\"40\"] },\n      { name: \"اللون\", options: [\"زهري\",\"رمادي\",\"بيج\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1009,\n    title: \"حقيبة كتف عملية\",\n    slug: \"women-shoulder-bag-classic\",\n    description: \"حقيبة كتف كلاسيكية بمساحة جيدة للاستخدام اليومي.\",\n    price: 89,\n    images: [\n      \"https://images.unsplash.com/photo-1689914667397-a77effb740da?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"حقائب وأحذية\",\n    rating: 4.5,\n    stock: 85,\n    variants: [\n      { name: \"اللون\", options: [\"أسود\",\"بني\",\"بيج\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1010,\n    title: \"منظم أدراج للمنزل\",\n    slug: \"home-drawer-organizer\",\n    description: \"منظم أدراج قابل للتخصيص لتخزين الملابس الصغيرة والإكسسوارات.\",\n    price: 29,\n    images: [\n      \"https://images.unsplash.com/photo-1616065758546-a50b6d3190b1?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"المنزل والحديقة\",\n    rating: 4.4,\n    stock: 200,\n    variants: [\n      { name: \"اللون\", options: [\"رمادي\",\"بيج\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1011,\n    title: \"ساعة يد أنيقة للنساء\",\n    slug: \"women-elegant-watch\",\n    description: \"ساعة يد بسيطة وأنيقة بتصميم عصري.\",\n    price: 149,\n    images: [\n      \"https://images.unsplash.com/photo-1670574914335-0bcd4a768d76?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"المجوهرات والساعات\",\n    rating: 4.6,\n    stock: 40,\n    variants: [\n      { name: \"اللون\", options: [\"ذهبي\",\"فضي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 1012,\n    title: \"مزهرية ديكور سيراميك\",\n    slug: \"home-ceramic-vase\",\n    description: \"مزهرية سيراميك بسيطة لإضافة لمسة جمالية في المنزل.\",\n    price: 45,\n    images: [\n      \"https://images.unsplash.com/photo-1728947850665-32f996262c5a?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"المنزل والحديقة\",\n    rating: 4.2,\n    stock: 110,\n    variants: [\n      { name: \"اللون\", options: [\"أبيض\",\"أسود\"] }\n    ],\n    is_active: true,\n  },\n  // --- Additional curated CN products ---\n  {\n    id: 2001,\n    title: \"تيشيرت قطن أساسي رجالي\",\n    slug: \"men-basic-cotton-tee\",\n    description: \"تيشيرت قطن 180 GSM بقصة مريحة ومناسبة للاستخدام اليومي.\",\n    price: 39,\n    images: [\n      \"https://images.unsplash.com/photo-1544716278-e513176f20b5?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.5,\n    stock: 120,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\",\"2XL\"] },\n      { name: \"اللون\", options: [\"أسود\",\"أبيض\",\"كحلي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2002,\n    title: \"هودي رجالي سادة\",\n    slug: \"men-plain-hoodie\",\n    description: \"هودي قطني متوسط السماكة ببطانة ناعمة.\",\n    price: 99,\n    images: [\n      \"https://images.unsplash.com/photo-1618333272197-2ee791c42963?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.4,\n    stock: 80,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أسود\",\"رمادي\",\"زيتي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2003,\n    title: \"جينز ممزق للنساء\",\n    slug: \"women-ripped-jeans\",\n    description: \"جينز نسائي بقصة ضيقة وتمزقات خفيفة لمظهر عصري.\",\n    price: 99,\n    images: [\n      \"https://images.unsplash.com/photo-1632852301634-96b856283a5e?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس نسائية\",\n    rating: 4.6,\n    stock: 90,\n    variants: [\n      { name: \"المقاس\", options: [\"26\",\"28\",\"30\",\"32\",\"34\"] },\n      { name: \"اللون\", options: [\"أزرق\",\"أسود\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2004,\n    title: \"بلوزة شيفون نسائية\",\n    slug: \"women-chiffon-blouse\",\n    description: \"بلوزة خفيفة من الشيفون مناسبة للعمل والخروج.\",\n    price: 79,\n    images: [\n      \"https://images.unsplash.com/photo-1613419489076-15da367b38df?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس نسائية\",\n    rating: 4.5,\n    stock: 110,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"بيج\",\"أسود\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2005,\n    title: \"سنيكرز رجالي خفيف\",\n    slug: \"men-light-sneaker\",\n    description: \"حذاء رياضي رجالي خفيف ومريح للمشي اليومي.\",\n    price: 139,\n    images: [\n      \"https://images.unsplash.com/photo-1707125249530-f1e3ee0a1b9c?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أحذية رجالية\",\n    rating: 4.6,\n    stock: 70,\n    variants: [\n      { name: \"المقاس\", options: [\"40\",\"41\",\"42\",\"43\",\"44\",\"45\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"أسود\",\"رمادي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2006,\n    title: \"سنيكرز نسائي عصري\",\n    slug: \"women-trendy-sneaker\",\n    description: \"سنيكرز بتصميم عصري ونعل خفيف للراحة اليومية.\",\n    price: 149,\n    images: [\n      \"https://images.unsplash.com/photo-1695225897718-b657a89ca78f?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أحذية نسائية\",\n    rating: 4.7,\n    stock: 85,\n    variants: [\n      { name: \"المقاس\", options: [\"36\",\"37\",\"38\",\"39\",\"40\",\"41\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"أسود\",\"بيج\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2007,\n    title: \"فستان يومي بسيط\",\n    slug: \"women-daily-simple-dress\",\n    description: \"فستان كاجوال بقصة مستقيمة ومظهر أنيق.\",\n    price: 109,\n    images: [\n      \"https://images.unsplash.com/photo-1515378791036-0648a3ef77b2?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس نسائية\",\n    rating: 4.4,\n    stock: 95,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أسود\",\"أزرق\",\"أخضر\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2008,\n    title: \"بنطال كارجو رجالي\",\n    slug: \"men-cargo-pants-basic\",\n    description: \"بنطال كارجو متعدد الجيوب بقصة مريحة.\",\n    price: 99,\n    images: [\n      \"https://images.unsplash.com/photo-1690908719438-330c0045d408?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.5,\n    stock: 100,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"كاكي\",\"أسود\",\"رمادي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2009,\n    title: \"طقم أطفال صيفي\",\n    slug: \"kids-summer-set\",\n    description: \"طقم أطفال قطعتين بخامة قطنية ناعمة.\",\n    price: 55,\n    images: [\n      \"https://images.unsplash.com/photo-1549366021-9f761d450615?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أزياء الأطفال\",\n    rating: 4.8,\n    stock: 140,\n    variants: [\n      { name: \"العمر\", options: [\"2-3\",\"3-4\",\"4-5\",\"5-6\"] },\n      { name: \"اللون\", options: [\"بيج\",\"أزرق\",\"زهري\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2010,\n    title: \"شنطة ظهر نسائية بسيطة\",\n    slug: \"women-simple-backpack\",\n    description: \"شنطة ظهر يومية بتقسيمات عملية وخامة متينة.\",\n    price: 89,\n    images: [\n      \"https://images.unsplash.com/photo-1689914667397-a77effb740da?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"الحقائب والأمتعة\",\n    rating: 4.4,\n    stock: 120,\n    variants: [\n      { name: \"اللون\", options: [\"أسود\",\"بيج\",\"بني\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2011,\n    title: \"سوار نسائي بسيط\",\n    slug: \"women-minimal-bracelet\",\n    description: \"سوار معدن مطلي بتصميم بسيط وأنيق.\",\n    price: 39,\n    images: [\n      \"https://images.unsplash.com/photo-1670574914335-0bcd4a768d76?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"مجوهرات واكسسوارات\",\n    rating: 4.3,\n    stock: 160,\n    variants: [\n      { name: \"اللون\", options: [\"ذهبي\",\"فضي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2012,\n    title: \"حقيبة يد نسائية\",\n    slug: \"women-handbag-classic\",\n    description: \"حقيبة يد كلاسيكية بمساحة جيدة للاستخدام اليومي.\",\n    price: 119,\n    images: [\n      \"https://images.unsplash.com/photo-1689914667397-a77effb740da?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"الحقائب والأمتعة\",\n    rating: 4.5,\n    stock: 90,\n    variants: [\n      { name: \"اللون\", options: [\"أسود\",\"بيج\",\"بني\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2013,\n    title: \"منظم مطبخ جداري\",\n    slug: \"kitchen-wall-organizer\",\n    description: \"منظم مطبخ لتعليق الأدوات وتوفير المساحة.\",\n    price: 49,\n    images: [\n      \"https://images.unsplash.com/photo-1616065758546-a50b6d3190b1?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"المنزل والحديقة\",\n    rating: 4.4,\n    stock: 200,\n    variants: [\n      { name: \"اللون\", options: [\"أسود\",\"رمادي\",\"أبيض\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2014,\n    title: \"كفر جوال شفاف\",\n    slug: \"clear-phone-case\",\n    description: \"كفر شفاف مضاد للصدمات لهواتف متعددة.\",\n    price: 29,\n    images: [\n      \"https://images.unsplash.com/photo-1588864669083-2f5960a6f62f?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"هواتف خليوية & إكسسوارات\",\n    rating: 4.2,\n    stock: 300,\n    variants: [\n      { name: \"اللون\", options: [\"شفاف\",\"أسود\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2015,\n    title: \"كيبل شحن سريع USB-C\",\n    slug: \"usb-c-fast-cable\",\n    description: \"كيبل USB-C يدعم الشحن السريع بطول 1 متر.\",\n    price: 25,\n    images: [\n      \"https://images.unsplash.com/photo-1535303311164-664fc9ec6532?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"هواتف خليوية & إكسسوارات\",\n    rating: 4.4,\n    stock: 500,\n    variants: [\n      { name: \"اللون\", options: [\"أسود\",\"أبيض\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2016,\n    title: \"شبشب نسائي صيفي\",\n    slug: \"women-summer-slides\",\n    description: \"شبشب خفيف للمنزل والشاطئ.\",\n    price: 29,\n    images: [\n      \"https://images.unsplash.com/photo-1703622846437-d99b08a906b0?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أحذية نسائية\",\n    rating: 4.1,\n    stock: 220,\n    variants: [\n      { name: \"المقاس\", options: [\"36\",\"37\",\"38\",\"39\",\"40\"] },\n      { name: \"اللون\", options: [\"زهري\",\"بيج\",\"أزرق\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2017,\n    title: \"صندل رجالي مسطح\",\n    slug: \"men-flat-sandals\",\n    description: \"صندل رجالي مريح بنعل مطاطي.\",\n    price: 49,\n    images: [\n      \"https://images.unsplash.com/photo-1662308074084-8e2d73c353e6?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"أحذية رجالية\",\n    rating: 4.2,\n    stock: 150,\n    variants: [\n      { name: \"المقاس\", options: [\"40\",\"41\",\"42\",\"43\",\"44\"] },\n      { name: \"اللون\", options: [\"أسود\",\"بني\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2018,\n    title: \"قميص رجالي قصير\",\n    slug: \"men-short-sleeve-shirt\",\n    description: \"قميص قصير الأكمام بخامة قطنية خفيفة.\",\n    price: 79,\n    images: [\n      \"https://images.unsplash.com/photo-1592878904946-b3cd69fbcf94?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس رجالية\",\n    rating: 4.3,\n    stock: 100,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"أزرق\",\"رمادي\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2019,\n    title: \"توب نسائي بسيط\",\n    slug: \"women-basic-top\",\n    description: \"توب نسائي بسيط مناسب للتنسيق اليومي.\",\n    price: 49,\n    images: [\n      \"https://images.unsplash.com/photo-1710954962775-c46bd6a5f67f?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"ملابس نسائية\",\n    rating: 4.2,\n    stock: 180,\n    variants: [\n      { name: \"المقاس\", options: [\"S\",\"M\",\"L\",\"XL\"] },\n      { name: \"اللون\", options: [\"أبيض\",\"أسود\",\"زهري\"] }\n    ],\n    is_active: true,\n  },\n  {\n    id: 2020,\n    title: \"منظم أدراج قماشي\",\n    slug: \"fabric-drawer-organizer\",\n    description: \"منظم قماشي قابل للطي لترتيب الأدراج.\",\n    price: 35,\n    images: [\n      \"https://images.unsplash.com/photo-1616065758546-a50b6d3190b1?auto=format&fit=crop&w=1200&q=80\"\n    ],\n    category: \"المنزل والحديقة\",\n    rating: 4.4,\n    stock: 260,\n    variants: [\n      { name: \"اللون\", options: [\"رمادي\",\"بيج\",\"أسود\"] }\n    ],\n    is_active: true,\n  },\n];\n*/\n","path":null,"size_bytes":16377,"size_tokens":null},"src/lib/http.ts":{"content":"/*\n  Simple HTTP helpers with timeouts and retries.\n  - fetchJson<T>(url, { timeoutMs, retries, retryStatuses })\n    Throws on final non-ok. Retries on network errors and configured statuses.\n*/\n\nexport type FetchJsonOptions = (RequestInit & {\n  timeoutMs?: number;\n  retries?: number; // total attempts = retries + 1\n  retryStatuses?: number[]; // defaults: [429, 500, 502, 503, 504]\n}) | undefined;\n\nfunction sleep(ms: number) {\n  return new Promise((r) => setTimeout(r, ms));\n}\n\nexport async function fetchJson<T = any>(url: string, options?: FetchJsonOptions): Promise<T> {\n  const timeoutMs = options?.timeoutMs ?? 12000;\n  const retries = Math.max(0, options?.retries ?? 2);\n  const retryStatuses = options?.retryStatuses ?? [429, 500, 502, 503, 504];\n\n  let lastErr: any = null;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    const ac = new AbortController();\n    const timer = setTimeout(() => ac.abort(), timeoutMs);\n    try {\n      const res = await fetch(url, { ...options, signal: ac.signal });\n      clearTimeout(timer);\n      if (!res.ok) {\n        const text = await res.text().catch(() => \"\");\n        if (retryStatuses.includes(res.status) && attempt < retries) {\n          const backoff = 250 * Math.pow(2, attempt) + Math.floor(Math.random() * 100);\n          await sleep(backoff);\n          continue;\n        }\n        throw new Error(`HTTP ${res.status}: ${text}`);\n      }\n      const text = await res.text();\n      try { return JSON.parse(text) as T; } catch { return text as unknown as T; }\n    } catch (e: any) {\n      clearTimeout(timer);\n      lastErr = e;\n      const isAbort = e?.name === 'AbortError';\n      const isNet = isAbort || e?.code === 'ECONNRESET' || e?.code === 'ENOTFOUND' || e?.message?.includes('network');\n      if (attempt < retries && isNet) {\n        const backoff = 250 * Math.pow(2, attempt) + Math.floor(Math.random() * 100);\n        await sleep(backoff);\n        continue;\n      }\n      throw e;\n    }\n  }\n  throw lastErr || new Error('fetchJson failed');\n}\n\nexport type FetchMetaResult<T = any> = { status: number; ok: boolean; body: T };\n\n// fetchWithMeta: like fetchJson but returns { status, ok, body } and does not throw on non-ok responses.\nexport async function fetchWithMeta<T = any>(url: string, options?: FetchJsonOptions): Promise<FetchMetaResult<T>> {\n  const timeoutMs = options?.timeoutMs ?? 12000;\n  const retries = Math.max(0, options?.retries ?? 2);\n  const retryStatuses = options?.retryStatuses ?? [429, 500, 502, 503, 504];\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    const ac = new AbortController();\n    const timer = setTimeout(() => ac.abort(), timeoutMs);\n    try {\n      const res = await fetch(url, { ...options, signal: ac.signal });\n      clearTimeout(timer);\n      const text = await res.text().catch(() => \"\");\n      let body: any = text;\n      try { body = JSON.parse(text); } catch { /* keep text */ }\n      if (!res.ok && retryStatuses.includes(res.status) && attempt < retries) {\n        const backoff = 250 * Math.pow(2, attempt) + Math.floor(Math.random() * 100);\n        await sleep(backoff);\n        continue;\n      }\n      return { status: res.status, ok: res.ok, body };\n    } catch (e: any) {\n      clearTimeout(timer);\n      const isAbort = e?.name === 'AbortError';\n      const isNet = isAbort || e?.code === 'ECONNRESET' || e?.code === 'ENOTFOUND' || e?.message?.includes('network');\n      if (attempt < retries && isNet) {\n        const backoff = 250 * Math.pow(2, attempt) + Math.floor(Math.random() * 100);\n        await sleep(backoff);\n        continue;\n      }\n      throw e;\n    }\n  }\n  // If we get here, treat as network error; keep consistent with fetchJson and throw\n  throw new Error('fetchWithMeta failed');\n}\n","path":null,"size_bytes":3752,"size_tokens":null},"src/components/user-nav.tsx":{"content":"\"use client\";\nimport Link from \"next/link\";\nimport { useEffect, useState } from \"react\";\nimport { User } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport SignOutButton from \"./sign-out-button\";\nimport { getSupabaseBrowser } from \"@/lib/supabase\";\n\nexport default function UserNav() {\n  const hasSupabaseEnv = !!process.env.NEXT_PUBLIC_SUPABASE_URL && !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  const [email, setEmail] = useState<string | null>(null);\n  const [loading, setLoading] = useState<boolean>(hasSupabaseEnv);\n  const [isAdmin, setIsAdmin] = useState<boolean>(false);\n\n  useEffect(() => {\n    if (!hasSupabaseEnv) return;\n    let mounted = true;\n    const supabase = getSupabaseBrowser();\n    (async () => {\n      try {\n        const { data: { session } } = await supabase.auth.getSession();\n        if (!mounted) return;\n        setEmail(session?.user?.email ?? null);\n      } catch (e) {\n        console.error(\"UserNav(client): failed to fetch session\", e);\n      } finally {\n        if (mounted) setLoading(false);\n      }\n    })();\n    const { data: sub } = supabase.auth.onAuthStateChange((_event, session) => {\n      setEmail(session?.user?.email ?? null);\n    });\n    return () => {\n      mounted = false;\n      sub.subscription.unsubscribe();\n    };\n  }, [hasSupabaseEnv]);\n\n  useEffect(() => {\n    let aborted = false;\n    async function checkAdmin() {\n      try {\n        if (!email) {\n          setIsAdmin(false);\n          return;\n        }\n        const r = await fetch('/api/admin/settings', { cache: 'no-store' });\n        if (!aborted) setIsAdmin(r.ok);\n      } catch {\n        if (!aborted) setIsAdmin(false);\n      }\n    }\n    checkAdmin();\n    return () => { aborted = true };\n  }, [email]);\n\n  if (!hasSupabaseEnv) {\n    return (\n      <div className=\"flex items-center gap-2\">\n        <div className=\"md:hidden\">\n          <Button asChild variant=\"ghost\" size=\"icon\" aria-label=\"Sign In\">\n            <Link href=\"/login\">\n              <User className=\"h-5 w-5\" />\n            </Link>\n          </Button>\n        </div>\n        <div className=\"hidden md:flex items-center gap-2\">\n          <Button asChild variant=\"ghost\" size=\"sm\">\n            <Link href=\"/login\">Sign In</Link>\n          </Button>\n          <Button asChild variant=\"cta\" size=\"sm\">\n            <Link href=\"/sign-up\">Create Account</Link>\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  if (loading) {\n    return <div className=\"h-9 w-9 animate-pulse rounded-full bg-muted\" aria-hidden />;\n  }\n\n  if (email) {\n    return (\n      <DropdownMenu>\n        <DropdownMenuTrigger asChild>\n          <Button variant=\"ghost\" size=\"icon\" className=\"relative h-9 w-9 rounded-full\">\n            <User className=\"h-5 w-5\" />\n          </Button>\n        </DropdownMenuTrigger>\n        <DropdownMenuContent className=\"w-56\" align=\"end\" forceMount>\n          <DropdownMenuLabel className=\"font-normal\">\n            <div className=\"flex flex-col space-y-1\">\n              <p className=\"text-sm font-medium leading-none\">My Account</p>\n              <p className=\"text-xs leading-none text-muted-foreground\">{email}</p>\n            </div>\n          </DropdownMenuLabel>\n          <DropdownMenuSeparator />\n          <DropdownMenuItem asChild>\n            <Link href=\"/account\">Overview</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/orders\">Orders</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/addresses\">Addresses</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/coupons\">Coupons</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/reviews\">Reviews</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/security\">Security</Link>\n          </DropdownMenuItem>\n          <DropdownMenuItem asChild>\n            <Link href=\"/account/notifications\">Notifications</Link>\n          </DropdownMenuItem>\n          <DropdownMenuSeparator />\n          {isAdmin && (\n            <DropdownMenuItem asChild>\n              <Link href=\"/admin/console\">Admin Console</Link>\n            </DropdownMenuItem>\n          )}\n          {isAdmin && <DropdownMenuSeparator />}\n          <SignOutButton />\n        </DropdownMenuContent>\n      </DropdownMenu>\n    );\n  }\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <div className=\"md:hidden\">\n        <Button asChild variant=\"ghost\" size=\"icon\" aria-label=\"Sign In\">\n          <Link href=\"/login\">\n            <User className=\"h-5 w-5\" />\n          </Link>\n        </Button>\n      </div>\n      <div className=\"hidden md:flex items-center gap-2\">\n        <Button asChild variant=\"ghost\" size=\"sm\">\n          <Link href=\"/login\">Sign In</Link>\n        </Button>\n        <Button asChild variant=\"cta\" size=\"sm\">\n          <Link href=\"/sign-up\">Create Account</Link>\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5244,"size_tokens":null},"src/lib/pricing.ts":{"content":"import { DEFAULT_KSA_DDP_MATRIX, type DdpTier } from '@/lib/shipping/ksa-ddp-matrix';\n\nexport type BilledWeightInput = {\n  actualKg: number;\n  lengthCm: number;\n  widthCm: number;\n  heightCm: number;\n  divisor?: number; // defaults to env KSA_DDP_DIVISOR or 6000\n};\n\nexport type RetailCalcOptions = {\n  handlingSar?: number; // default 0\n  margin?: number;      // fraction, e.g. 0.35\n  roundTo?: number;     // nearest price rounding granularity, e.g. 0.05; default 0.05\n  prettyEnding?: number[]; // prefer endings like .95 or .99\n};\n\nexport type RetailCalcResult = {\n  billedWeightKg: number;\n  ddpShippingSar: number;\n  landedCostSar: number;\n  retailSar: number;\n};\n\nexport function getDivisor(): number {\n  const fromEnv = Number(process.env.KSA_DDP_DIVISOR || '6000');\n  return Number.isFinite(fromEnv) && fromEnv > 0 ? fromEnv : 6000;\n}\n\nexport function getKsaDdpMatrix(): DdpTier[] {\n  try {\n    const raw = process.env.KSA_DDP_MATRIX_JSON;\n    if (raw) {\n      const parsed = JSON.parse(raw) as DdpTier[];\n      if (Array.isArray(parsed) && parsed.length > 0) return parsed;\n    }\n  } catch {}\n  return DEFAULT_KSA_DDP_MATRIX;\n}\n\nexport function computeVolumetricWeightKg(input: BilledWeightInput): number {\n  const divisor = input.divisor ?? getDivisor();\n  const vol = (input.lengthCm * input.widthCm * input.heightCm) / divisor;\n  return Number(vol.toFixed(3));\n}\n\nexport function computeBilledWeightKg(input: BilledWeightInput): number {\n  const vol = computeVolumetricWeightKg(input);\n  const billed = Math.max(input.actualKg, vol);\n  return Number(billed.toFixed(3));\n}\n\nexport function resolveDdpShippingSar(billedWeightKg: number, matrix: DdpTier[] = getKsaDdpMatrix()): number {\n  // Find first tier that covers billed weight\n  for (const t of matrix) {\n    if (billedWeightKg <= t.maxKg + 1e-9) return t.priceSAR;\n  }\n  // If above highest tier, extrapolate linearly using the last step's per-kg increment (rough fallback)\n  const last = matrix[matrix.length - 1];\n  const prev = matrix[matrix.length - 2] || { maxKg: 0, priceSAR: 0 };\n  const perKg = (last.priceSAR - prev.priceSAR) / Math.max(last.maxKg - prev.maxKg, 1);\n  const extraKg = Math.max(0, billedWeightKg - last.maxKg);\n  return Math.round((last.priceSAR + perKg * extraKg) * 100) / 100;\n}\n\nfunction roundToGranularity(value: number, step = 0.05): number {\n  const rounded = Math.round(value / step) * step;\n  return Math.round(rounded * 100) / 100;\n}\n\nfunction prettyPrice(value: number, endings: number[] = [0.95, 0.99]): number {\n  const floor = Math.floor(value);\n  const decimals = value - floor;\n  let best = value;\n  let bestDiff = Infinity;\n  for (const e of endings) {\n    const candidate = floor + e;\n    const diff = Math.abs(candidate - value);\n    if (diff < bestDiff) {\n      best = candidate;\n      bestDiff = diff;\n    }\n  }\n  return Math.round(best * 100) / 100;\n}\n\nexport function computeRetailFromLanded(\n  landedCostSar: number,\n  opts: RetailCalcOptions = {}\n): number {\n  const margin = opts.margin ?? 0.35;\n  const step = opts.roundTo ?? 0.05;\n  const prelim = landedCostSar / Math.max(1e-6, (1 - margin));\n  const rounded = roundToGranularity(prelim, step);\n  return prettyPrice(rounded, opts.prettyEnding ?? [0.95, 0.99]);\n}\n\nexport function calculateRetailSar(\n  supplierCostSar: number,\n  weight: BilledWeightInput,\n  opts: RetailCalcOptions = {}\n): RetailCalcResult {\n  const handling = opts.handlingSar ?? 0;\n  const billed = computeBilledWeightKg(weight);\n  const ddp = resolveDdpShippingSar(billed);\n  const landed = supplierCostSar + ddp + handling;\n  const retail = computeRetailFromLanded(landed, opts);\n  return {\n    billedWeightKg: billed,\n    ddpShippingSar: ddp,\n    landedCostSar: Math.round(landed * 100) / 100,\n    retailSar: retail,\n  };\n}\n\nexport function usdToSar(usd: number): number {\n  const rate = Number(process.env.EXCHANGE_USD_TO_SAR || '3.75');\n  return Math.round(usd * rate * 100) / 100;\n}\n\nexport function convertToSar(amount: number, currency?: string | null): number {\n  const cur = (currency || 'SAR').toUpperCase();\n  if (cur === 'USD') return usdToSar(amount);\n  // For now, assume already SAR for unknown currencies\n  return amount;\n}\n\nexport function maybeUsdToSar(amount: number): number {\n  const flag = String(process.env.CJ_PRICES_ARE_USD || '').toLowerCase();\n  if (flag === '1' || flag === 'true' || flag === 'yes') return usdToSar(amount);\n  return amount;\n}\n\n// --- Packaging recommendation ---\nexport type PackagingOption = {\n  code: 'POLY_MAILER' | 'PADDED_BAG' | 'SMALL_BOX';\n  innerDimsCm: { L: number; W: number; H: number };\n  description: string;\n};\n\nconst PACKAGING_OPTIONS: PackagingOption[] = [\n  { code: 'POLY_MAILER', innerDimsCm: { L: 25, W: 20, H: 3 }, description: 'Tight fold apparel; neutral poly mailer' },\n  { code: 'PADDED_BAG', innerDimsCm: { L: 30, W: 25, H: 6 }, description: 'Padded bag (no shoe box) for light footwear' },\n  { code: 'SMALL_BOX', innerDimsCm: { L: 33, W: 22, H: 12 }, description: 'Small carton box for accessories/shoes' },\n];\n\nexport function recommendPackaging(actualKg: number, productDimsCm: { L: number; W: number; H: number }, divisor?: number) {\n  const d = divisor ?? getDivisor();\n  let best = PACKAGING_OPTIONS[0];\n  let bestBilled = Infinity;\n  for (const opt of PACKAGING_OPTIONS) {\n    const L = Math.max(opt.innerDimsCm.L, productDimsCm.L);\n    const W = Math.max(opt.innerDimsCm.W, productDimsCm.W);\n    const H = Math.max(opt.innerDimsCm.H, productDimsCm.H);\n    const vol = (L * W * H) / d;\n    const billed = Math.max(actualKg, vol);\n    if (billed < bestBilled) {\n      bestBilled = billed;\n      best = opt;\n    }\n  }\n  return { option: best, billedWeightKg: Number(bestBilled.toFixed(3)) };\n}\n\n// --- Anomaly detection ---\nexport type PricingAnomaly = { code: string; severity: 'info' | 'warn' | 'error'; message: string };\n\nexport function detectPricingAnomalies(input: {\n  actualKg: number;\n  volumetricKg: number;\n  billedKg: number;\n  ddpShippingSar: number;\n  landedCostSar: number;\n  retailSar: number;\n}): PricingAnomaly[] {\n  const out: PricingAnomaly[] = [];\n  const { actualKg, volumetricKg, billedKg, ddpShippingSar, landedCostSar, retailSar } = input;\n  const volRatio = volumetricKg > 0 && actualKg > 0 ? volumetricKg / actualKg : 0;\n  if (volRatio >= 3) {\n    out.push({ code: 'VOL>>ACTUAL', severity: 'warn', message: `Volumetric weight (${volumetricKg.toFixed(2)}kg) is ${volRatio.toFixed(1)}x actual (${actualKg.toFixed(2)}kg)` });\n  }\n  // Heuristic thresholds; adjust when real KSA DDP matrix is finalized\n  const ddpPerKg = billedKg > 0 ? ddpShippingSar / billedKg : 0;\n  if (ddpPerKg > 90) {\n    out.push({ code: 'HIGH_DDP_PER_KG', severity: 'warn', message: `DDP shipping SAR/kg seems high: ${ddpPerKg.toFixed(2)} SAR/kg` });\n  }\n  if (retailSar < landedCostSar * 1.05) {\n    out.push({ code: 'LOW_MARGIN', severity: 'warn', message: `Retail (${retailSar}) is too close to landed (${landedCostSar}); margin may be too low.` });\n  }\n  if (ddpShippingSar > retailSar * 0.6) {\n    out.push({ code: 'SHIP>RETAIL*0.6', severity: 'info', message: `Shipping (${ddpShippingSar}) is a large fraction of retail (${retailSar}).` });\n  }\n  if (billedKg > 5) {\n    out.push({ code: 'HEAVY_PARCEL', severity: 'info', message: `Billed weight is heavy (${billedKg.toFixed(2)}kg); verify service level & matrix tiers.` });\n  }\n  return out;\n}\n","path":null,"size_bytes":7366,"size_tokens":null},"src/app/admin/products/product-form.tsx":{"content":"\"use client\";\n\nimport { useFormState, useFormStatus } from \"react-dom\";\nimport { useEffect, useRef, useState } from \"react\";\nimport { addProduct, updateProduct } from \"@/app/admin/products/actions\";\nimport type { Product } from \"@/lib/types\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { UploadCloud, Loader2 } from \"lucide-react\";\nimport { getSupabaseBrowser } from \"@/lib/supabase\";\nimport { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from \"@/components/ui/select\";\nimport { CATEGORIES, labelFromSlug, slugFromLabel } from \"@/lib/categories\";\n\nfunction isVideoSrc(s: string): boolean {\n  if (!s) return false;\n  const str = s.trim().toLowerCase();\n  if (str.startsWith('data:video/')) return true;\n  if (/\\.(mp4|webm|ogg|m3u8)(\\?|#|$)/.test(str)) return true;\n  if (str.includes('res.cloudinary.com') && str.includes('/video/')) return true;\n  // blob: URLs for local previews\n  if (str.startsWith('blob:')) return true;\n  return false;\n}\n\nfunction sanitizeFileName(name: string) {\n  return name.replace(/[^a-zA-Z0-9._-]/g, \"_\");\n}\n\nfunction SubmitButton({ isEditing }: { isEditing: boolean }) {\n  const { pending } = useFormStatus();\n  return (\n    <Button type=\"submit\" disabled={pending} className=\"w-full\">\n      {pending ? (isEditing ? \"Updating...\" : \"Adding...\") : (isEditing ? \"Update Product\" : \"Add Product\")}\n    </Button>\n  );\n}\n\nfunction UploadImagesControl({\n  onAppendUrls,\n  onLocalPreview,\n}: {\n  onAppendUrls: (urls: string[]) => void;\n  onLocalPreview?: (urls: string[]) => void;\n}) {\n  const [uploading, setUploading] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const onClick = () => fileInputRef.current?.click();\n\n  async function handleFiles(files: FileList) {\n    if (!files || files.length === 0) return;\n    setUploading(true);\n    try {\n      const supabase = getSupabaseBrowser();\n      // Prefer signed uploads via our server API for better security\n      let signData: any = null;\n      try {\n        const signRes = await fetch(\"/api/cloudinary/sign\");\n        if (signRes.ok) signData = await signRes.json();\n      } catch {}\n\n      const canSigned = !!(signData && signData.ok && signData.cloudName && signData.apiKey && signData.signature && signData.timestamp && signData.uploadPreset);\n      const cloudNamePublic = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;\n      const uploadPresetPublic = process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET;\n      const hasUnsigned = !!cloudNamePublic && !!uploadPresetPublic;\n      const supabaseReady = !!process.env.NEXT_PUBLIC_SUPABASE_URL && !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n      const uploadedUrls: string[] = [];\n      for (const file of Array.from(files)) {\n        let uploaded: string | null = null;\n        let lastErr: any = null;\n        // First preference: direct upload to Supabase Storage from the browser (no server size limits)\n        if (supabaseReady && !uploaded) {\n          try {\n            const now = new Date();\n            const y = now.getUTCFullYear();\n            const m = String(now.getUTCMonth() + 1).padStart(2, \"0\");\n            const base = `uploads/${y}/${m}/products`;\n            const safe = sanitizeFileName(file.name || 'file');\n            const ext = safe.includes('.') ? safe.split('.').pop() : 'bin';\n            const rnd = Math.random().toString(36).slice(2);\n            const path = `${base}/${now.getTime()}-${rnd}.${ext}`;\n            const up = await supabase.storage.from('products').upload(path, file, { upsert: true, contentType: file.type || undefined });\n            if (!up.error) {\n              const pub = supabase.storage.from('products').getPublicUrl(path);\n              uploaded = (pub as any)?.data?.publicUrl || (pub as any)?.publicUrl || null;\n            } else {\n              lastErr = up.error;\n            }\n          } catch (e) {\n            lastErr = e;\n          }\n        }\n        // Fallback A: upload via our API route (will also work for smaller files)\n        if (!uploaded) {\n          try {\n            const fd = new FormData();\n            fd.append(\"file\", file);\n            fd.append(\"dir\", \"products\");\n            const res = await fetch(\"/api/upload\", { method: \"POST\", body: fd });\n            if (res.ok) {\n              const j = await res.json();\n              if (j?.ok && j?.url) uploaded = j.url as string;\n            } else {\n              const errTxt = await res.text().catch(() => \"\");\n              lastErr = new Error(`Upload API failed: ${res.status} ${res.statusText} ${errTxt}`);\n            }\n          } catch (e) {\n            lastErr = e;\n          }\n        }\n        // Try signed first if available\n        if (canSigned) {\n          try {\n            const fd = new FormData();\n            fd.append(\"file\", file);\n            fd.append(\"api_key\", String(signData.apiKey));\n            fd.append(\"timestamp\", String(signData.timestamp));\n            fd.append(\"upload_preset\", String(signData.uploadPreset));\n            fd.append(\"signature\", String(signData.signature));\n            const kind = file.type.startsWith(\"video/\") ? \"video\" : \"image\";\n            const res = await fetch(`https://api.cloudinary.com/v1_1/${signData.cloudName}/${kind}/upload`, { method: \"POST\", body: fd });\n            if (!res.ok) {\n              const errTxt = await res.text().catch(() => \"\");\n              throw new Error(`Signed upload failed: ${res.status} ${res.statusText} ${errTxt}`);\n            }\n            const json = await res.json();\n            uploaded = (json.secure_url as string) || null;\n          } catch (e) {\n            lastErr = e;\n          }\n        }\n        // Fallback 1: unsigned using signing response values (covers case where preset is actually unsigned)\n        if (!uploaded && signData?.cloudName && signData?.uploadPreset) {\n          try {\n            const fd = new FormData();\n            fd.append(\"file\", file);\n            fd.append(\"upload_preset\", String(signData.uploadPreset));\n            const kind = file.type.startsWith(\"video/\") ? \"video\" : \"image\";\n            const res = await fetch(`https://api.cloudinary.com/v1_1/${signData.cloudName}/${kind}/upload`, { method: \"POST\", body: fd });\n            if (!res.ok) {\n              const errTxt = await res.text().catch(() => \"\");\n              throw new Error(`Unsigned(upload_preset from sign) failed: ${res.status} ${res.statusText} ${errTxt}`);\n            }\n            const json = await res.json();\n            uploaded = (json.secure_url as string) || null;\n          } catch (e) {\n            lastErr = e;\n          }\n        }\n        // Fallback 2: unsigned using NEXT_PUBLIC vars\n        if (!uploaded && hasUnsigned) {\n          try {\n            const fd = new FormData();\n            fd.append(\"file\", file);\n            fd.append(\"upload_preset\", uploadPresetPublic as string);\n            const kind = file.type.startsWith(\"video/\") ? \"video\" : \"image\";\n            const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudNamePublic}/${kind}/upload`, { method: \"POST\", body: fd });\n            if (!res.ok) {\n              const errTxt = await res.text().catch(() => \"\");\n              throw new Error(`Unsigned(NEXT_PUBLIC) failed: ${res.status} ${res.statusText} ${errTxt}`);\n            }\n            const json = await res.json();\n            uploaded = (json.secure_url as string) || null;\n          } catch (e) {\n            lastErr = e;\n          }\n        }\n        if (uploaded) {\n          uploadedUrls.push(uploaded);\n        } else {\n          // Last resort: local preview only\n          const objectUrl = URL.createObjectURL(file);\n          onLocalPreview?.([objectUrl]);\n          console.error(\"Image upload failed:\", lastErr);\n        }\n      }\n\n      if (uploadedUrls.length > 0) onAppendUrls(uploadedUrls);\n    } catch (e) {\n      console.error(\"Image upload failed\", e);\n      alert(\"Image upload failed. You can paste direct image URLs or configure Cloudinary env vars.\");\n    } finally {\n      setUploading(false);\n    }\n  }\n\n  return (\n    <div className=\"flex items-center gap-2\">\n      <Button type=\"button\" variant=\"secondary\" onClick={onClick} disabled={uploading} aria-live=\"polite\">\n        {uploading ? (\n          <>\n            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> Uploading...\n          </>\n        ) : (\n          <>\n            <UploadCloud className=\"mr-2 h-4 w-4\" /> Upload Media\n          </>\n        )}\n      </Button>\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"image/*,video/*\"\n        multiple\n        className=\"hidden\"\n        onChange={(e) => e.target.files && handleFiles(e.target.files)}\n      />\n    </div>\n  );\n}\n\ntype FormState = {\n  message: string | null;\n  fieldErrors: Record<string, string[] | undefined> | null;\n};\n\nconst initialState: FormState = { message: null, fieldErrors: null };\n\nexport default function ProductForm({ product }: { product?: Product }) {\n  const action = product ? updateProduct : addProduct;\n  const [state, formAction] = useFormState(action, initialState);\n  const imagesInputRef = useRef<HTMLInputElement>(null);\n  const [previews, setPreviews] = useState<string[]>(product?.images || []);\n  const [extUrl, setExtUrl] = useState<string>(\"\");\n  const [uploadConfigured, setUploadConfigured] = useState<boolean | null>(null);\n  const [clientError, setClientError] = useState<string>(\"\");\n  // Category selection\n  const initialCategoryLabel = product?.category || \"General\";\n  const [categorySlug, setCategorySlug] = useState<string>(slugFromLabel(initialCategoryLabel));\n\n  useEffect(() => {\n    let mounted = true;\n    (async () => {\n      try {\n        const res = await fetch(\"/api/cloudinary/sign\", { cache: \"no-store\" });\n        if (!mounted) return;\n        if (res.ok) {\n          const j = await res.json();\n          setUploadConfigured(!!j?.ok);\n        } else {\n          setUploadConfigured(false);\n        }\n      } catch {\n        if (mounted) setUploadConfigured(false);\n      }\n    })();\n    return () => { mounted = false; };\n  }, []);\n\n  const appendUrls = (urls: string[]) => {\n    const current = imagesInputRef.current?.value?.trim();\n    const arr = current ? current.split(\",\").map((s) => s.trim()).filter(Boolean) : [];\n    const newArr = Array.from(new Set([...arr, ...urls]));\n    if (imagesInputRef.current) {\n      imagesInputRef.current.value = newArr.join(\", \");\n    }\n    setPreviews((prev) => Array.from(new Set([...(prev || []), ...urls])));\n  };\n\n  const onLocalPreview = (urls: string[]) => {\n    setPreviews((prev) => Array.from(new Set([...(prev || []), ...urls])));\n  };\n\n  const onSubmitForm = (e: React.FormEvent<HTMLFormElement>) => {\n    setClientError(\"\");\n    const val = imagesInputRef.current?.value?.trim() || \"\";\n    // Prevent submitting products with no real media URLs saved\n    if (!val) {\n      e.preventDefault();\n      setClientError(\"يجب إضافة صورة أو فيديو واحد على الأقل قبل الحفظ. إذا كانت المعاينة من نوع blob: فلن يتم حفظها، الرجاء رفع الملف أو إدخال رابط مباشر.\");\n      // Focus the external URL input to guide the user\n      try { (document.getElementById(\"images-ext-url\") as HTMLInputElement | null)?.focus(); } catch {}\n      return false;\n    }\n    return true;\n  };\n\n  return (\n    <form action={formAction} onSubmit={onSubmitForm}>\n      {product && <input type=\"hidden\" name=\"id\" value={product.id} />}\n      <div className=\"grid gap-4 py-4\">\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"title\">Title</Label>\n          <Input id=\"title\" name=\"title\" defaultValue={product?.title} required />\n          {state.fieldErrors?.title && <p className=\"text-xs text-destructive\">{state.fieldErrors.title.join(', ')}</p>}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"slug\">Slug</Label>\n          <Input id=\"slug\" name=\"slug\" defaultValue={product?.slug} required />\n          {state.fieldErrors?.slug && <p className=\"text-xs text-destructive\">{state.fieldErrors.slug.join(', ')}</p>}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"description\">Description</Label>\n          <Textarea id=\"description\" name=\"description\" defaultValue={product?.description || \"\"} />\n          {state.fieldErrors?.description && <p className=\"text-xs text-destructive\">{state.fieldErrors.description.join(', ')}</p>}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"price\">Price</Label>\n          <Input id=\"price\" name=\"price\" type=\"number\" step=\"0.01\" defaultValue={product?.price} required />\n          {state.fieldErrors?.price && <p className=\"text-xs text-destructive\">{state.fieldErrors.price.join(', ')}</p>}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"stock\">Stock</Label>\n          <Input id=\"stock\" name=\"stock\" type=\"number\" step=\"1\" min=\"0\" defaultValue={product?.stock ?? 0} required />\n          {state.fieldErrors?.stock && <p className=\"text-xs text-destructive\">{state.fieldErrors.stock.join(', ')}</p>}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label htmlFor=\"category\">Category</Label>\n          {/* Hidden field stores the label for consistent DB values */}\n          <input type=\"hidden\" name=\"category\" value={labelFromSlug(categorySlug) || initialCategoryLabel} />\n          <Select value={categorySlug} onValueChange={(v) => setCategorySlug(v)}>\n            <SelectTrigger className=\"w-full\">\n              <SelectValue placeholder=\"Select a category\" />\n            </SelectTrigger>\n            <SelectContent>\n              {CATEGORIES.map((c) => (\n                <SelectItem key={c.slug} value={c.slug}>{c.label}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n          {state.fieldErrors?.category && (\n            <p className=\"text-xs text-destructive\">{state.fieldErrors.category.join(', ')}</p>\n          )}\n        </div>\n        <div className=\"grid gap-2\">\n          <Label>صور/فيديو المنتج</Label>\n          {/* نُخفي الحقل النصي ونملؤه تلقائيًا عند الرفع */}\n          <Input ref={imagesInputRef} id=\"images\" name=\"images\" defaultValue={product?.images?.join(', ') || \"\"} className=\"hidden\" />\n          <div className=\"flex items-center gap-3\">\n            <UploadImagesControl onAppendUrls={appendUrls} onLocalPreview={onLocalPreview} />\n            <span className=\"text-xs text-muted-foreground\">\n              ارفع صورًا أو فيديوهات؛ لا حاجة لإدخال روابط يدويًا.\n            </span>\n          </div>\n          {uploadConfigured === false && (\n            <div className=\"text-xs text-amber-600\">\n              ملاحظة: الرفع غير مُفعّل (لم يتم ضبط Cloudinary). ستظهر معاينات blob: محليًا فقط ولن تُحفظ. أدخل رابطًا مباشرًا أو فعّل متغيرات Cloudinary.\n            </div>\n          )}\n          <div className=\"mt-2 flex items-center gap-2\">\n            <Input\n              placeholder=\"أو أدخل رابط صورة/فيديو (https://...)\"\n              value={extUrl}\n              onChange={(e) => setExtUrl(e.target.value)}\n              id=\"images-ext-url\"\n            />\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => {\n                const url = (extUrl || \"\").trim();\n                if (!url) return;\n                appendUrls([url]);\n                setExtUrl(\"\");\n              }}\n            >\n              إضافة الرابط\n            </Button>\n          </div>\n          {!!clientError && <p className=\"text-xs text-destructive\">{clientError}</p>}\n          {previews && previews.length > 0 && (\n            <div className=\"mt-2 flex flex-wrap gap-2\">\n              {previews.map((src, i) => (\n                isVideoSrc(src) ? (\n                  <video key={`${src}-${i}`} src={src} className=\"h-16 w-16 rounded border object-cover\" muted playsInline />\n                ) : (\n                  <img key={`${src}-${i}`} src={src} alt=\"preview\" className=\"h-16 w-16 rounded border object-cover\" />\n                )\n              ))}\n            </div>\n          )}\n          {state.fieldErrors?.images && <p className=\"text-xs text-destructive\">{state.fieldErrors.images.join(', ')}</p>}\n        </div>\n      </div>\n      <div className=\"mt-6\">\n        <SubmitButton isEditing={!!product} />\n        {state.message && !state.fieldErrors && <p className=\"mt-2 text-sm text-destructive\">{state.message}</p>}\n      </div>\n    </form>\n  );\n}\n","path":null,"size_bytes":16862,"size_tokens":null},"src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n}\n","path":null,"size_bytes":4369,"size_tokens":null},"src/app/api/admin/cj/sync/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from '@/lib/cj/v2';\nimport { hasTable, hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { calculateRetailSar, usdToSar } from '@/lib/pricing';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function productVariantsTableExists(_admin: any): Promise<boolean> {\n  return await hasTable('product_variants');\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'cj-sync-v1', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Global kill-switch enforcement: block write operations\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, version: 'cj-sync-v1', error: 'Kill switch is ON. Sync is temporarily disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const { searchParams } = new URL(req.url);\n    const limit = Math.max(1, Math.min(50, Number(searchParams.get('limit') || '20')));\n    const offset = Math.max(0, Number(searchParams.get('offset') || '0'));\n    const idsCsv = searchParams.get('ids');\n    const updatePrice = (searchParams.get('updatePrice') || 'false').toLowerCase() === 'true';\n    const updateImages = (searchParams.get('updateImages') || 'false').toLowerCase() === 'true';\n    const updateVideo = (searchParams.get('updateVideo') || 'false').toLowerCase() === 'true';\n    const updateRetail = (searchParams.get('updateRetail') || 'false').toLowerCase() === 'true';\n    const margin = Number(searchParams.get('margin') || '0.35');\n    const handlingSar = Number(searchParams.get('handlingSar') || '0');\n    const cjCurrency = (searchParams.get('cjCurrency') || 'USD').toUpperCase(); // USD | SAR\n\n    const hasVariants = await productVariantsTableExists(supabase);\n    const hasVideoCol = await hasColumn('products', 'video_url').catch(() => false);\n\n    let products: any[] = [];\n    if (idsCsv) {\n      const ids = idsCsv.split(',').map((s) => Number(s.trim())).filter((n) => Number.isFinite(n) && n > 0);\n      if (ids.length === 0) return NextResponse.json({ ok: false, version: 'cj-sync-v1', error: 'No valid ids provided' }, { status: 400 });\n      const { data } = await supabase\n        .from('products')\n        .select('id, cj_product_id, slug, title, price, images')\n        .in('id', ids)\n        .not('cj_product_id', 'is', null);\n      products = data || [];\n    } else {\n      const { data } = await supabase\n        .from('products')\n        .select('id, cj_product_id, slug, title, price, images')\n        .not('cj_product_id', 'is', null)\n        .order('id', { ascending: true })\n        .range(offset, offset + limit - 1);\n      products = data || [];\n    }\n\n    if (products.length === 0) {\n      const r = NextResponse.json({ ok: true, version: 'cj-sync-v1', synced: 0, results: [] }, { headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const results: any[] = [];\n\n    for (const p of products) {\n      try {\n        const pid = String(p.cj_product_id);\n        const raw = await queryProductByPidOrKeyword({ pid });\n        const itemRaw = Array.isArray(raw?.data?.content)\n          ? raw.data.content[0]\n          : Array.isArray(raw?.content)\n            ? raw.content[0]\n            : (raw?.data || raw);\n        const cj = mapCjItemToProductLike(itemRaw);\n        if (!cj) throw new Error('CJ item map failed');\n\n        // Update variants if table exists\n        if (hasVariants) {\n          const rows = (cj.variants || [])\n            .filter((v: any) => v && (v.size || v.cjSku))\n            .map((v: any) => {\n              // Supplier cost (assume CJ in USD unless specified)\n              const supplierCostRaw = typeof v.price === 'number' ? v.price : undefined;\n              const supplierCostSar = typeof supplierCostRaw === 'number'\n                ? (cjCurrency === 'USD' ? usdToSar(supplierCostRaw) : supplierCostRaw)\n                : undefined;\n\n              // Weight and dims\n              const weightG = typeof v.weightGrams === 'number' ? Math.max(0, v.weightGrams) : undefined;\n              const actualKg = typeof weightG === 'number' ? Math.max(0.05, weightG / 1000) : 0.3; // fallback 0.3kg\n              const L = typeof v.lengthCm === 'number' ? v.lengthCm : 25; // sensible apparel defaults\n              const W = typeof v.widthCm === 'number' ? v.widthCm : 20;\n              const H = typeof v.heightCm === 'number' ? v.heightCm : 3;\n\n              // Compute retail inclusive of DDP + margin if requested\n              let retailSar: number | null = null;\n              let retailSansShip: number | null = null;\n              if (updateRetail && typeof supplierCostSar === 'number' && supplierCostSar > 0) {\n                const calc = calculateRetailSar(supplierCostSar, { actualKg, lengthCm: L, widthCm: W, heightCm: H }, { handlingSar, margin });\n                retailSar = calc.retailSar;\n                retailSansShip = Math.max(0, calc.retailSar - calc.ddpShippingSar);\n              }\n\n              return {\n                product_id: p.id,\n                option_name: 'Size',\n                option_value: v.size || '-',\n                cj_sku: v.cjSku || null,\n                price: (retailSansShip ?? (typeof v.price === 'number' ? (cjCurrency === 'USD' ? usdToSar(v.price) : v.price) : null)),\n                stock: typeof v.stock === 'number' ? v.stock : 0,\n                weight_grams: typeof v.weightGrams === 'number' ? Math.round(v.weightGrams) : null,\n                length_cm: typeof v.lengthCm === 'number' ? v.lengthCm : null,\n                width_cm: typeof v.widthCm === 'number' ? v.widthCm : null,\n                height_cm: typeof v.heightCm === 'number' ? v.heightCm : null,\n              } as any;\n            });\n          await supabase.from('product_variants').delete().eq('product_id', p.id);\n          if (rows.length > 0) {\n            const { error: vErr } = await supabase.from('product_variants').insert(rows);\n            if (vErr) throw vErr;\n          }\n        }\n\n        // Update product stock, media, and optionally price\n        let update: Record<string, any> = {};\n        if (hasVariants) {\n          const stockSum = (cj.variants || []).reduce((acc: number, v: any) => acc + (typeof v.stock === 'number' ? v.stock : 0), 0);\n          update.stock = stockSum;\n        }\n        if (updateRetail) {\n          // Compute product-level price as min of variant retail\n          const variantRetail: { full: number; sansShip: number }[] = [];\n          for (const v of (cj.variants || [])) {\n            const costRaw = typeof v.price === 'number' ? v.price : undefined;\n            const costSar = typeof costRaw === 'number' ? (cjCurrency === 'USD' ? usdToSar(costRaw) : costRaw) : undefined;\n            const weightG = typeof v.weightGrams === 'number' ? Math.max(0, v.weightGrams) : undefined;\n            const actualKg = typeof weightG === 'number' ? Math.max(0.05, weightG / 1000) : 0.3;\n            const L = typeof v.lengthCm === 'number' ? v.lengthCm : 25;\n            const W = typeof v.widthCm === 'number' ? v.widthCm : 20;\n            const H = typeof v.heightCm === 'number' ? v.heightCm : 3;\n            if (typeof costSar === 'number' && costSar > 0) {\n              const calc = calculateRetailSar(costSar, { actualKg, lengthCm: L, widthCm: W, heightCm: H }, { handlingSar, margin });\n              if (typeof calc.retailSar === 'number' && isFinite(calc.retailSar)) variantRetail.push({ full: calc.retailSar, sansShip: Math.max(0, calc.retailSar - calc.ddpShippingSar) });\n            }\n          }\n          if (variantRetail.length > 0) update.price = Math.min(...variantRetail.map(v => v.sansShip));\n        } else if (updatePrice) {\n          const priceCandidates = (cj.variants || [])\n            .map((v: any) => (typeof v.price === 'number' ? (cjCurrency === 'USD' ? usdToSar(v.price) : v.price) : NaN))\n            .filter((n: number) => !isNaN(n));\n          const base = priceCandidates.length > 0 ? Math.min(...priceCandidates) : undefined;\n          if (typeof base === 'number') update.price = base;\n        }\n        if (updateImages && Array.isArray(cj.images) && cj.images.length > 0) {\n          update.images = cj.images;\n        }\n        if (updateVideo && hasVideoCol) {\n          update.video_url = cj.videoUrl || null;\n        }\n        // Product-level shipping metadata (best-effort)\n        if (typeof (cj as any).deliveryTimeHours === 'number') {\n          update.delivery_time_hours = Math.round((cj as any).deliveryTimeHours);\n        }\n        if (typeof (cj as any).processingTimeHours === 'number') {\n          update.processing_time_hours = Math.round((cj as any).processingTimeHours);\n        }\n        if ((cj as any).originArea) update.origin_area = (cj as any).originArea;\n        if ((cj as any).originCountryCode) update.origin_country_code = (cj as any).originCountryCode;\n        if (Object.keys(update).length > 0) {\n          await supabase.from('products').update(update).eq('id', p.id);\n        }\n\n        // Recompute stock via RPC if present\n        try { await supabase.rpc('recompute_product_stock', { product_id_in: p.id }); } catch {}\n\n        results.push({ ok: true, productId: p.id, cjPid: pid, updated: Object.keys(update) });\n      } catch (e: any) {\n        results.push({ ok: false, productId: p?.id, error: e?.message || String(e) });\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, version: 'cj-sync-v1', synced: results.filter(r => r.ok).length, results }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, version: 'cj-sync-v1', error: e?.message || 'Sync failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":10947,"size_tokens":null},"src/app/shop/page.tsx":{"content":"import ProductCard from \"@/components/product-card\";\nimport AdminProductActions from \"@/components/admin-product-actions\";\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\";\nimport type { Product } from \"@/lib/types\";\nimport Breadcrumbs from \"@/components/breadcrumbs\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport FiltersPanel from \"@/components/pro/FiltersPanel\";\n\nexport const metadata = { title: \"Shop\", description: \"Shop the latest products and deals\" };\nexport const revalidate = 0;\nexport const dynamic = \"force-dynamic\";\n\nexport default async function ShopPage({ searchParams }: { searchParams?: { sort?: string; min?: string; max?: string } }) {\n  const supabase = getSupabaseAnonServer();\n  const supabaseAuth = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabaseAuth.auth.getUser();\n  const adminEmails = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((e) => e.trim().toLowerCase())\n    .filter(Boolean);\n  const isPrivileged = !!user && (adminEmails.length === 0\n    ? (process.env.NODE_ENV !== \"production\")\n    : adminEmails.includes((user.email || \"\").toLowerCase()));\n  const applySortAndFilter = (list: Product[]): Product[] => {\n    let arr = [...list];\n    const sort = (searchParams?.sort || '').toLowerCase();\n    const min = Number(searchParams?.min);\n    const max = Number(searchParams?.max);\n    if (!Number.isNaN(min)) arr = arr.filter((p) => p.price >= min);\n    if (!Number.isNaN(max)) arr = arr.filter((p) => p.price <= max);\n    if (sort === 'price-asc') arr = arr.sort((a,b) => a.price - b.price);\n    else if (sort === 'price-desc') arr = arr.sort((a,b) => b.price - a.price);\n    return arr;\n  };\n  \n  if (!supabase) {\n    return (\n      <div className=\"container py-10\">\n        <Breadcrumbs items={[{ name: \"Home\", href: \"/\" }, { name: \"Shop\" }]} />\n        <h1 className=\"text-3xl font-bold\">Shop</h1>\n        <p className=\"mt-2 text-slate-600\">Discover our curated selection of trending products.</p>\n        <FiltersPanel basePath=\"/shop\" sort={searchParams?.sort} min={searchParams?.min} max={searchParams?.max} />\n        <div className=\"mt-8 text-slate-600\">No products available.</div>\n      </div>\n    );\n  }\n  let products: any[] | null = null;\n  let error: any = null;\n  {\n    let query = supabase.from(\"products\").select(\"*\").or(\"is_active.is.null,is_active.eq.true\") as any;\n    const sort = (searchParams?.sort || '').toLowerCase();\n    if (sort === 'price-asc') query = query.order('price', { ascending: true });\n    else if (sort === 'price-desc') query = query.order('price', { ascending: false });\n    const min = Number(searchParams?.min);\n    const max = Number(searchParams?.max);\n    if (!Number.isNaN(min)) query = query.gte('price', min);\n    if (!Number.isNaN(max)) query = query.lte('price', max);\n    const { data, error: err } = await query;\n    if (err && (String(err.message || \"\").includes(\"is_active\") || err.code === \"42703\")) {\n      const fallback = await supabase.from(\"products\").select(\"*\");\n      products = fallback.data as any[] | null;\n      error = fallback.error;\n    } else {\n      products = data as any[] | null;\n      error = err;\n    }\n  }\n\n  if (error) {\n    console.error(\"Error fetching products:\", error.message);\n    return (\n      <div className=\"container py-10 text-center\">\n        <h2 className=\"text-xl font-semibold text-red-600\">Failed to load products</h2>\n        <p className=\"mt-2 text-slate-500\">There was a problem connecting to the database. Please try again later.</p>\n        <p className=\"mt-4 text-xs text-slate-400\">Error: {error.message}</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <Breadcrumbs items={[{ name: \"Home\", href: \"/\" }, { name: \"Shop\" }]} />\n      <h1 className=\"text-3xl font-bold\">Shop</h1>\n      <p className=\"mt-2 text-slate-600\">Discover our curated selection of trending products.</p>\n      <FiltersPanel basePath=\"/shop\" sort={searchParams?.sort} min={searchParams?.min} max={searchParams?.max} />\n      <div className=\"mt-8\">\n        {products && products.length > 0 ? (\n          <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n            {products.map((p) => (\n              <div key={p.id} className=\"space-y-2\">\n                <ProductCard product={p as Product} />\n                {isPrivileged && (\n                  <AdminProductActions productId={p.id} productSlug={(p as any).slug} isActive={(p as any).is_active ?? true} />\n                )}\n              </div>\n            ))}\n          </div>\n        ) : (\n          <div className=\"text-slate-600\">No products available.</div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4795,"size_tokens":null},"src/components/form-status-toast.tsx":{"content":"\"use client\";\n\nimport { useEffect, useRef } from \"react\";\nimport { useFormStatus } from \"react-dom\";\nimport { useToast } from \"@/components/ui/toast-provider\";\n\nexport default function FormStatusToast({\n  successMessage = \"Saved successfully\",\n  successTitle,\n}: {\n  successMessage?: string;\n  successTitle?: string;\n}) {\n  const { pending } = useFormStatus();\n  const { toast } = useToast();\n  const prev = useRef(pending);\n\n  useEffect(() => {\n    // Show success when we transition from pending -> not pending\n    if (prev.current && !pending) {\n      toast({ variant: \"success\", title: successTitle, description: successMessage });\n    }\n    prev.current = pending;\n  }, [pending, toast, successMessage, successTitle]);\n\n  return null;\n}\n","path":null,"size_bytes":742,"size_tokens":null},"src/app/api/admin/cj/products/query/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, getAccessToken, fetchProductDetailsBatch } from '@/lib/cj/v2';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { fetchWithMeta, fetchJson } from '@/lib/http';\nimport { loggerForRequest } from '@/lib/log';\nimport { classifyQuery, matchProductName } from '@/lib/search/keyword-lexicon';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction normalizeText(text: string): string {\n  return text.toLowerCase().replace(/[^a-z0-9\\s]/g, ' ').replace(/\\s+/g, ' ').trim();\n}\n\nfunction tokenize(text: string): string[] {\n  return normalizeText(text).split(' ').filter(w => w.length > 1);\n}\n\nfunction smartMatch(productName: string, rawQuery: string, relaxed: boolean = false): { matches: boolean; score: number; matchRatio: number; hasProductMatch: boolean; debug?: any } {\n  const { requiredConcepts, genderExclusions } = classifyQuery(rawQuery);\n  const result = matchProductName(productName, requiredConcepts, genderExclusions);\n  \n  const hasProductMatch = result.matchedConcepts.size > 0 && \n    Array.from(result.matchedConcepts).some(c => requiredConcepts.has(c));\n  \n  const matchRatio = requiredConcepts.size > 0 ? result.matchedConcepts.size / requiredConcepts.size : 1;\n  \n  let matches = result.matches;\n  if (relaxed && !matches && requiredConcepts.size > 0) {\n    if (hasProductMatch && matchRatio >= 0.5) {\n      matches = true;\n    }\n  }\n  \n  return { \n    matches, \n    score: result.score,\n    matchRatio,\n    hasProductMatch,\n    debug: {\n      productName,\n      requiredConcepts: Array.from(requiredConcepts),\n      matchedConcepts: Array.from(result.matchedConcepts),\n      genderExclusions,\n      relaxed,\n      matchRatio,\n      hasProductMatch,\n    }\n  };\n}\n\nfunction extractPidFromUrl(u?: string | null): string | undefined {\n  if (!u) return undefined;\n  try {\n    const url = new URL(u);\n    const cand = url.searchParams.get('pid') || url.searchParams.get('productId') || url.searchParams.get('id');\n    if (cand) return cand;\n    const m = url.href.match(/[0-9A-Fa-f-]{16,}/);\n    return m?.[0];\n  } catch {\n    return undefined;\n  }\n}\n\nasync function extractGuidPidFromCjHtml(u?: string | null): Promise<string | undefined> {\n  if (!u) return undefined;\n  try {\n    const meta = await fetchWithMeta<string>(u, { method: 'GET', cache: 'no-store', timeoutMs: 10000, retries: 1 });\n    const html = typeof meta.body === 'string' ? meta.body : '';\n    const patterns = [\n      /[\"']pid[\"']\\s*[:=]\\s*[\"']([0-9A-Fa-f\\-]{32,36})[\"']/i,\n      /pid=([0-9A-Fa-f\\-]{32,36})/i,\n      /[\"']productId[\"']\\s*[:=]\\s*[\"']([0-9A-Fa-f\\-]{32,36})[\"']/i,\n      /data-pid=[\"']([0-9A-Fa-f\\-]{32,36})[\"']/i,\n    ];\n    for (const re of patterns) {\n      const m = html.match(re);\n      if (m && m[1]) return m[1];\n    }\n  } catch {}\n  return undefined;\n}\n\nasync function fetchCjProductPage(token: string, base: string, keyword: string, categoryId: string | undefined, pageNum: number, pageSize: number): Promise<{ list: any[]; total: number }> {\n  const params = new URLSearchParams();\n  params.set('keyWords', keyword);\n  params.set('pageSize', String(pageSize));\n  params.set('pageNum', String(pageNum));\n  if (categoryId && categoryId !== 'all') {\n    params.set('categoryId', categoryId);\n  }\n  \n  try {\n    const res = await fetchJson<any>(`${base}/product/list?${params}`, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 20000,\n    });\n    return {\n      list: res?.data?.list || [],\n      total: res?.data?.total || 0,\n    };\n  } catch {\n    return { list: [], total: 0 };\n  }\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'query-v4', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const { searchParams } = new URL(req.url);\n    let pid = searchParams.get('pid') || undefined;\n    const keyword = searchParams.get('keyword') || undefined;\n    const urlParam = searchParams.get('url') || undefined;\n    const categoryId = searchParams.get('category') || undefined;\n    const quantity = Math.max(1, Number(searchParams.get('quantity') || 25));\n    const strictMode = searchParams.get('strict') !== 'false';\n    const minRating = Number(searchParams.get('minRating') || 0);\n    const includeUnratedParam = searchParams.get('includeUnrated');\n    const includeUnrated = includeUnratedParam === 'true' ? true : (includeUnratedParam === 'false' ? false : (minRating <= 0));\n    \n    if (!pid && urlParam) pid = extractPidFromUrl(urlParam);\n    if (!pid && urlParam) {\n      pid = await extractGuidPidFromCjHtml(urlParam);\n    }\n\n    if (!pid && !keyword) {\n      const r = NextResponse.json({ ok: false, error: 'Provide pid or keyword' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    let items: any[] = [];\n    let totalFound = 0;\n    let pagesFetched = 0;\n    let totalRawFetched = 0;\n    let skippedNoRating = 0;\n    let skippedLowRating = 0;\n    let skippedNoMatch = 0;\n    \n    if (pid) {\n      const raw = await queryProductByPidOrKeyword({ pid, keyword });\n      const itemsRaw = Array.isArray(raw?.data?.list) ? raw.data.list\n        : Array.isArray(raw?.data) ? raw.data\n        : raw?.data ? [raw.data] : [];\n      items = itemsRaw.map((it: any) => mapCjItemToProductLike(it)).filter(Boolean);\n    } else if (keyword) {\n      const token = await getAccessToken();\n      const base = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n      const searchTokens = tokenize(keyword);\n      \n      const { requiredConcepts, genderExclusions } = classifyQuery(keyword);\n      console.log(`[Search v4] Keyword: \"${keyword}\", Required Concepts: [${Array.from(requiredConcepts).join(', ')}], Gender Exclusions: [${genderExclusions.join(', ')}], Target: ${quantity}, Strict: ${strictMode}, MinRating: ${minRating}, IncludeUnrated: ${includeUnrated}`);\n      \n      const pageSize = 50;\n      const maxPagesForQuantity = Math.ceil(quantity * 20 / pageSize);\n      const maxPages = Math.min(2000, Math.max(100, maxPagesForQuantity));\n      \n      let allRawItems: any[] = [];\n      let strictMatchedItems: any[] = [];\n      let relaxedMatchedItems: any[] = [];\n      const seenPids = new Set<string>();\n      const startTime = Date.now();\n      const maxDurationMs = quantity > 1000 ? 180000 : (quantity > 500 ? 120000 : 90000);\n      \n      console.log(`[Search v4] Config: maxPages=${maxPages}, maxDuration=${maxDurationMs}ms, pageSize=${pageSize}`);\n      \n      for (let page = 1; page <= maxPages; page++) {\n        if (Date.now() - startTime > maxDurationMs) {\n          console.log(`[Search v4] Timeout reached after ${page - 1} pages, ${strictMatchedItems.length} strict, ${relaxedMatchedItems.length} relaxed`);\n          break;\n        }\n        \n        const pageResult = await fetchCjProductPage(token, base, keyword, categoryId, page, pageSize);\n        pagesFetched++;\n        totalRawFetched += pageResult.list.length;\n        \n        if (pageResult.list.length === 0) {\n          console.log(`[Search v4] Empty page at ${page}, stopping`);\n          break;\n        }\n        \n        if (page === 1) {\n          totalFound = pageResult.total;\n          console.log(`[Search v4] CJ reports ${totalFound} total products available`);\n        }\n        \n        for (const rawItem of pageResult.list) {\n          const itemPid = String(rawItem.pid || rawItem.productId || rawItem.id || '');\n          if (seenPids.has(itemPid)) continue;\n          seenPids.add(itemPid);\n          \n          allRawItems.push(rawItem);\n          \n          const supplierRating = Number(rawItem.supplierRating || rawItem.score || rawItem.rating || rawItem.productScore || 0);\n          const hasRating = supplierRating > 0;\n          \n          if (minRating > 0) {\n            if (!hasRating) {\n              if (!includeUnrated) {\n                skippedNoRating++;\n                continue;\n              }\n            } else if (supplierRating < minRating) {\n              skippedLowRating++;\n              continue;\n            }\n          }\n          \n          const mappedItem = mapCjItemToProductLike(rawItem);\n          if (!mappedItem) continue;\n          \n          (mappedItem as any).supplierRating = hasRating ? supplierRating : null;\n          (mappedItem as any).hasRating = hasRating;\n          \n          if (strictMode && searchTokens.length > 0 && requiredConcepts.size > 0) {\n            const strictResult = smartMatch(mappedItem.name || '', keyword, false);\n            const relaxedResult = smartMatch(mappedItem.name || '', keyword, true);\n            (mappedItem as any)._matchScore = strictResult.score;\n            (mappedItem as any)._matchRatio = strictResult.matchRatio;\n            \n            if (strictResult.matches) {\n              strictMatchedItems.push(mappedItem);\n            } else if (relaxedResult.matches) {\n              relaxedMatchedItems.push(mappedItem);\n            } else {\n              skippedNoMatch++;\n            }\n          } else {\n            strictMatchedItems.push(mappedItem);\n          }\n        }\n        \n        if (page % 20 === 0 || page === 1) {\n          console.log(`[Search v4] Page ${page}/${maxPages}: ${strictMatchedItems.length} strict, ${relaxedMatchedItems.length} relaxed, target: ${quantity}, raw: ${totalRawFetched}`);\n        }\n        \n        const totalMatched = strictMatchedItems.length + relaxedMatchedItems.length;\n        if (totalMatched >= quantity) {\n          console.log(`[Search v4] Target reached with ${totalMatched} matches after ${page} pages`);\n          break;\n        }\n        \n        if (pageResult.list.length < pageSize) {\n          console.log(`[Search v4] Partial page at ${page} (${pageResult.list.length}/${pageSize}), stopping`);\n          break;\n        }\n      }\n      \n      strictMatchedItems.sort((a, b) => {\n        const ratingA = (a as any).hasRating ? ((a as any).supplierRating || 0) : -1;\n        const ratingB = (b as any).hasRating ? ((b as any).supplierRating || 0) : -1;\n        if (ratingB !== ratingA) return ratingB - ratingA;\n        return ((b as any)._matchScore || 0) - ((a as any)._matchScore || 0);\n      });\n      \n      relaxedMatchedItems.sort((a, b) => {\n        const ratioA = (a as any)._matchRatio || 0;\n        const ratioB = (b as any)._matchRatio || 0;\n        if (ratioB !== ratioA) return ratioB - ratioA;\n        const ratingA = (a as any).hasRating ? ((a as any).supplierRating || 0) : -1;\n        const ratingB = (b as any).hasRating ? ((b as any).supplierRating || 0) : -1;\n        if (ratingB !== ratingA) return ratingB - ratingA;\n        return ((b as any)._matchScore || 0) - ((a as any)._matchScore || 0);\n      });\n      \n      const combined = [...strictMatchedItems, ...relaxedMatchedItems];\n      const selectedItems = combined.slice(0, quantity);\n      \n      // CRITICAL: Hydrate selected products with full details (images + variants)\n      // The /product/list endpoint only returns 1-2 thumbnail images\n      // We need to call /product/query and /product/variant/query for full data\n      const pidsToHydrate = selectedItems.map(item => item.productId).filter(Boolean);\n      console.log(`[Search v4] Hydrating ${pidsToHydrate.length} products with full details...`);\n      \n      const detailsMap = await fetchProductDetailsBatch(pidsToHydrate, 5);\n      \n      // Re-map products using full detail data\n      const hydratedItems: any[] = [];\n      for (const item of selectedItems) {\n        const pid = item.productId;\n        const fullDetails = detailsMap.get(pid);\n        \n        if (fullDetails) {\n          // Map the full details which include all images and variants\n          const hydratedItem = mapCjItemToProductLike(fullDetails);\n          if (hydratedItem) {\n            // Preserve metadata from original match\n            (hydratedItem as any).supplierRating = (item as any).supplierRating;\n            (hydratedItem as any).hasRating = (item as any).hasRating;\n            (hydratedItem as any)._matchScore = (item as any)._matchScore;\n            (hydratedItem as any)._matchRatio = (item as any)._matchRatio;\n            hydratedItems.push(hydratedItem);\n            console.log(`[Search v4] Hydrated ${pid}: ${hydratedItem.images.length} images, ${hydratedItem.variants.length} variants`);\n          } else {\n            // Fallback to original if mapping fails\n            hydratedItems.push(item);\n          }\n        } else {\n          // Fallback to original if details fetch failed\n          hydratedItems.push(item);\n          console.log(`[Search v4] Using original for ${pid} (details fetch failed)`);\n        }\n      }\n      \n      items = hydratedItems;\n      \n      const duration = Date.now() - startTime;\n      console.log(`[Search v4] Final: ${items.length}/${quantity} items from ${pagesFetched} pages in ${duration}ms`);\n      console.log(`[Search v4] Stats: raw=${totalRawFetched}, unique=${seenPids.size}, strict=${strictMatchedItems.length}, relaxed=${relaxedMatchedItems.length}`);\n      console.log(`[Search v4] Skipped: noRating=${skippedNoRating}, lowRating=${skippedLowRating}, noMatch=${skippedNoMatch}`);\n      console.log(`[Search v4] Hydration: ${detailsMap.size}/${pidsToHydrate.length} products successfully hydrated with full details`);\n    }\n\n    const r = NextResponse.json({ \n      ok: true, \n      version: 'query-v4', \n      count: items.length,\n      requested: quantity,\n      totalFound,\n      pagesFetched,\n      stats: {\n        rawFetched: totalRawFetched,\n        skippedNoRating,\n        skippedLowRating,\n        skippedNoMatch,\n      },\n      items \n    }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    console.error('[Search v4] Error:', e?.message);\n    const r = NextResponse.json({ ok: false, version: 'query-v4', error: e?.message || 'CJ query failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":14460,"size_tokens":null},"src/app/cart/cart-item.tsx":{"content":"\"use client\";\n\nimport { useFormState, useFormStatus } from \"react-dom\";\nimport { removeItem, updateItemQuantity } from \"@/lib/cart-actions\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport type { CartItem as CartItemType } from \"@/lib/types\";\nimport Image from \"next/image\";\nimport Link from \"next/link\";\n\nfunction SubmitButton({ children, className }: { children: React.ReactNode, className?: string }) {\n  const { pending } = useFormStatus();\n  return (\n    <button type=\"submit\" disabled={pending} className={className}>\n      {children}\n    </button>\n  );\n}\n\nexport default function CartItem({ item }: { item: CartItemType }) {\n  const [removeMessage, removeAction] = useFormState(removeItem, null);\n  const [updateMessage, updateAction] = useFormState(updateItemQuantity, null);\n  const { product, variant } = item;\n\n  if (!product) {\n    return null;\n  }\n\n  return (\n    <div className=\"flex items-center gap-4 rounded-xl border bg-white p-4 shadow-sm\">\n      <div className=\"relative h-20 w-20 overflow-hidden rounded-md bg-slate-100\">\n        <Image src={product.images?.[0] || \"/placeholder.svg\"} alt={product.title} fill sizes=\"80px\" className=\"object-cover\" />\n      </div>\n      <div className=\"flex-1\">\n        <Link href={`/product/${product.slug}`} className=\"font-medium hover:underline\">\n          {product.title}\n        </Link>\n        {product.product_code && (\n          <p className=\"text-xs text-slate-500\">Code: {product.product_code}</p>\n        )}\n        <div className=\"text-sm text-slate-600\">\n          {variant ? (\n            <>\n              <span className=\"mr-2 inline-block rounded bg-slate-100 px-2 py-0.5 text-xs text-slate-700\">Size: {variant.option_value}</span>\n              {formatCurrency((variant.price ?? product.price))} each\n            </>\n          ) : (\n            <>{formatCurrency(product.price)} each</>\n          )}\n        </div>\n        <div className=\"mt-2 flex items-center\">\n          <form action={updateAction}>\n            <input type=\"hidden\" name=\"itemId\" value={item.id} />\n            <input type=\"hidden\" name=\"quantity\" value={item.quantity - 1} />\n            <SubmitButton className=\"rounded-l-md border px-3 py-1\">-</SubmitButton>\n          </form>\n          <span className=\"border-y px-4 py-1\">{item.quantity}</span>\n          <form action={updateAction}>\n            <input type=\"hidden\" name=\"itemId\" value={item.id} />\n            <input type=\"hidden\" name=\"quantity\" value={item.quantity + 1} />\n            <SubmitButton className=\"rounded-r-md border px-3 py-1\">+</SubmitButton>\n          </form>\n        </div>\n      </div>\n      <form action={removeAction}>\n        <input type=\"hidden\" name=\"itemId\" value={item.id} />\n        <SubmitButton className=\"text-sm text-red-600 underline\">Remove</SubmitButton>\n      </form>\n    </div>\n  );\n}\n","path":null,"size_bytes":2827,"size_tokens":null},"src/app/error.tsx":{"content":"\"use client\";\n\nimport Link from \"next/link\";\n\nexport default function Error({\n  error,\n  reset,\n}: {\n  error: Error & { digest?: string };\n  reset: () => void;\n}) {\n  return (\n    <div className=\"container py-20 text-center\">\n      <h1 className=\"text-3xl sm:text-4xl font-bold text-slate-900\">An Unexpected Error Occurred</h1>\n      <p className=\"mt-4 text-slate-600\">\n        Sorry, something went wrong. Please try again or return to the home page.\n      </p>\n      {error?.digest && (\n        <p className=\"mt-2 text-xs text-slate-400\">Error ID: {error.digest}</p>\n      )}\n      <div className=\"mt-8 flex items-center justify-center gap-4\">\n        <button\n          onClick={reset}\n          className=\"inline-flex items-center rounded bg-black text-white px-4 py-2 text-sm hover:bg-gray-800\"\n          aria-label=\"Try again\"\n        >\n          Try Again\n        </button>\n        <Link\n          href=\"/\"\n          className=\"inline-flex items-center font-medium text-slate-900 underline decoration-2 underline-offset-4\"\n        >\n          Back to Home\n        </Link>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1109,"size_tokens":null},"src/app/api/admin/purge/catalog/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { hasColumn, hasTable } from '@/lib/db-features'\nimport { createClient } from '@supabase/supabase-js'\nimport { isKillSwitchOn } from '@/lib/settings'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nfunction tokenOk(req: Request, envKey: string): boolean {\n  try {\n    const url = new URL(req.url)\n    const qp = url.searchParams.get('token') || ''\n    const hdr = req.headers.get('x-purge-token') || ''\n    const auth = req.headers.get('authorization') || ''\n    const bearer = auth.toLowerCase().startsWith('bearer ') ? auth.slice(7) : ''\n    const provided = qp || hdr || bearer\n    const expected = process.env[envKey] || process.env.SEED_IMPORT_TOKEN || ''\n    if (!expected) return false\n    return !!provided && provided === expected\n  } catch { return false }\n}\n\nasync function allow(req: Request) {\n  const admin = await ensureAdmin()\n  if (admin.ok) return true\n  if (tokenOk(req, 'PRUNE_TOKEN')) return true\n  return false\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  const admin = getAdmin()\n  if (!admin) {\n    const r = NextResponse.json({ ok: false, error: 'Supabase not configured' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n  try {\n    if (!(await allow(req))) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Global kill-switch enforcement\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, error: 'Kill switch is ON. Purge is disabled.' }, { status: 423 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const u = new URL(req.url)\n    const params = {\n      scope: (u.searchParams.get('scope') || 'non_cj').toLowerCase(),\n      ids: (u.searchParams.get('ids') || '').split(',').map(s => s.trim()).filter(Boolean),\n      cjPids: (u.searchParams.get('cjPids') || '').split(',').map(s => s.trim()).filter(Boolean),\n      hard: ((u.searchParams.get('hard') || 'false').toLowerCase() === 'true'),\n      dry: ((u.searchParams.get('dryRun') || 'false').toLowerCase() === 'true'),\n      confirm: u.searchParams.get('confirm') || ''\n    }\n\n    if (params.confirm !== 'PURGE') {\n      const r = NextResponse.json({ ok: false, error: 'Confirmation required: add confirm=PURGE' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Determine target product IDs\n    let targetIds: number[] = []\n\n    if (params.ids.length > 0) {\n      const parsed = params.ids.map((s) => Number(s)).filter((n) => Number.isFinite(n))\n      targetIds = parsed\n    } else if (params.cjPids.length > 0) {\n      const { data, error } = await admin\n        .from('products')\n        .select('id, cj_product_id')\n        .in('cj_product_id', params.cjPids)\n      if (error) throw error\n      targetIds = (data || []).map((r: any) => r.id)\n    } else if (params.scope === 'all') {\n      const { data, error } = await admin\n        .from('products')\n        .select('id')\n        .limit(10000)\n      if (error) throw error\n      targetIds = (data || []).map((r: any) => r.id)\n    } else {\n      // non_cj: cj_product_id is null\n      const colExists = await hasColumn('products', 'cj_product_id')\n      if (colExists) {\n        const { data, error } = await admin\n          .from('products')\n          .select('id')\n          .is('cj_product_id', null)\n          .limit(10000)\n        if (error) throw error\n        targetIds = (data || []).map((r: any) => r.id)\n      } else {\n        // If no cj_product_id column, nothing to purge under non_cj scope unless ids/cjPids provided\n        targetIds = []\n      }\n    }\n\n    // Unique list\n    targetIds = Array.from(new Set(targetIds)).filter((n) => Number.isFinite(n))\n\n    if (params.dry) {\n      const r = NextResponse.json({ ok: true, dryRun: true, count: targetIds.length, ids: targetIds.slice(0, 200) })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    let updated = 0\n    let deletedVariants = 0\n    let deletedProducts = 0\n\n    // Delete variants for the target products if table exists\n    if (await hasTable('product_variants')) {\n      if (targetIds.length > 0) {\n        const { count, error } = await admin\n          .from('product_variants')\n          .delete({ count: 'exact' })\n          .in('product_id', targetIds)\n        if (error) throw error\n        deletedVariants = count || 0\n      }\n    }\n\n    // Soft archive by is_active if available and not hard delete\n    const hasIsActive = await hasColumn('products', 'is_active')\n    if (!params.hard && hasIsActive && targetIds.length > 0) {\n      const { data: updRows, error } = await admin\n        .from('products')\n        .update({ is_active: false })\n        .in('id', targetIds)\n        .select('id')\n      if (error) throw error\n      updated = (updRows?.length || 0)\n    }\n\n    // Hard delete if requested\n    if (params.hard && targetIds.length > 0) {\n      const { count, error } = await admin\n        .from('products')\n        .delete({ count: 'exact' })\n        .in('id', targetIds)\n      if (error) throw error\n      deletedProducts = count || 0\n    }\n\n    const r = NextResponse.json({ ok: true, scope: params.scope, hard: params.hard, affected: { productsSoftUpdated: updated, variantsDeleted: deletedVariants, productsDeleted: deletedProducts }, targetCount: targetIds.length })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'purge failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":6098,"size_tokens":null},"src/app/api/cj/seed/one/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { loggerForRequest } from '@/lib/log'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from '@/lib/cj/v2'\nimport { upsertProductFromCj, persistRawCj } from '@/lib/ops/cj-sync'\nimport { createClient } from '@supabase/supabase-js'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const { searchParams } = new URL(req.url)\n    const Q = z.object({\n      token: z.string().optional(),\n      pid: z.string().optional(),\n      keyword: z.string().optional(),\n    })\n\n    const q = Q.parse({\n      token: searchParams.get('token') || undefined,\n      pid: searchParams.get('pid') || undefined,\n      keyword: searchParams.get('keyword') || undefined,\n    })\n\n    const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n    if (!url || !key) {\n      const r = NextResponse.json({ ok: false, error: 'Supabase not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const db = createClient(url, key)\n\n    // Bootstrap policy: if there are zero products, allow without token once.\n    // Otherwise require token === SEED_IMPORT_TOKEN.\n    const { count: productsCountRaw } = await db.from('products').select('id', { count: 'exact', head: true })\n    const productsCount = typeof productsCountRaw === 'number' ? productsCountRaw : 0\n\n    const tokenEnv = String(process.env.SEED_IMPORT_TOKEN || '')\n    const disabled = String(process.env.SEED_IMPORT_DISABLED || '').toLowerCase() === 'true'\n\n    const allowWithoutToken = productsCount === 0\n    const tokenOk = !!tokenEnv && q.token === tokenEnv\n\n    if (disabled || (!allowWithoutToken && !tokenOk)) {\n      const r = NextResponse.json({ ok: false, error: 'Seed not allowed' }, { status: 403 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const keyword = q.keyword || (q.pid ? undefined : 'women dress')\n    const raw = await queryProductByPidOrKeyword({ pid: q.pid || undefined, keyword })\n\n    const list: any[] = Array.isArray(raw?.data?.content)\n      ? raw.data.content\n      : Array.isArray(raw?.data?.list)\n        ? raw.data.list\n        : Array.isArray(raw?.content)\n          ? raw.content\n          : Array.isArray(raw?.data)\n            ? raw.data\n            : []\n\n    if (!list || list.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'No CJ items found' }, { status: 404 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const itemRaw = list[0]\n    // Enrich: if keyword search returned a shallow item, fetch product detail by PID before mapping\n    let mapped = mapCjItemToProductLike(itemRaw)\n    try {\n      const pid = (mapped?.productId || String((itemRaw as any)?.pid || (itemRaw as any)?.productId || '')) as string\n      if (pid) {\n        const detail = await queryProductByPidOrKeyword({ pid })\n        const dlist: any[] = Array.isArray(detail?.data?.content)\n          ? detail.data.content\n          : Array.isArray(detail?.data?.list)\n            ? detail.data.list\n            : Array.isArray(detail?.content)\n              ? detail.content\n              : Array.isArray(detail?.data)\n                ? detail.data\n                : []\n        if (dlist && dlist[0]) {\n          const remapped = mapCjItemToProductLike(dlist[0])\n          if (remapped) mapped = remapped\n        }\n      }\n    } catch {}\n    if (!mapped) {\n      const r = NextResponse.json({ ok: false, error: 'Mapping failed' }, { status: 422 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const up = await upsertProductFromCj(mapped, { updateImages: true, updateVideo: true, updatePrice: true })\n    if (!('ok' in up) || !up.ok) {\n      const r = NextResponse.json({ ok: false, error: (up as any).error || 'Upsert failed' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    try { await persistRawCj(up.productId, itemRaw) } catch {}\n\n    let slug: string | undefined\n    try {\n      const { data } = await db.from('products').select('slug').eq('id', up.productId).maybeSingle()\n      slug = data?.slug || undefined\n    } catch {}\n\n    const r = NextResponse.json({ ok: true, productId: up.productId, slug, updated: up.updated })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'seed failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4714,"size_tokens":null},"branding/suppliers/supplier-agreement-template-en.md":{"content":"# Supplier Master Service Agreement (Template) — Shopixo\n\nThis Agreement is made between:\n- Buyer: Shopixo (the “Buyer”)\n- Supplier: [Company Legal Name] (the “Supplier”)\n\nEffective Date: [YYYY-MM-DD]\nTerm: 12 months (auto-renew unless terminated per Section 14)\n\n1. Scope\n- Supplier provides products and fulfillment services to KSA on a dropship basis.\n- Blind Shipping is mandatory. Shipper Name on labels must be “Shopixo”.\n\n2. Orders & Fulfillment\n- Orders placed via [Portal/API/Email]. Processing SLA: [X] hours.\n- Include Buyer’s packing slip and thank-you insert in every parcel.\n- No supplier marketing material inside parcels.\n\n3. Branding & Packaging\n- If applicable, use Buyer-provided polybag/hangtag/sticker. MOQ/cost per Annex C.\n- Packaging must protect items; apparel folded in clean polybags.\n\n4. Quality Control\n- AQL: [Level]. Pre-dispatch photos/videos for first 3 lots and upon request.\n- Defects/short-shipments handled per Section 8.\n\n5. Pricing & Payment\n- Prices per Annex B (Rate Card). Currency: [USD]. Payment: [Card/Wire].\n- Buyer may apply FX buffer [X%]. Changes require 7 days’ notice.\n\n6. Shipping & Delivery\n- Services per Annex B (Economy/Express), DDP preferred. Provide KSA transit times.\n- Tracking to be shared within 24 hours of handover.\n\n7. Compliance & Warranty\n- Supplier warrants products are genuine, safe, and compliant with KSA laws (including kids textiles labeling where applicable).\n- Supplier bears responsibility for customs issues caused by misdeclaration.\n\n8. Returns & Defects\n- DOA/defect rate threshold: [X%]. Remedies: replacement/reship/refund within [X] days.\n- RMA workflow agreed in Annex D.\n\n9. Data & Privacy\n- Use order data solely for fulfillment. No marketing contact to Buyer’s customers.\n\n10. Confidentiality & IP\n- Mutual NDA applies to product info, pricing, customer data, and brand assets.\n\n11. Liability\n- Caps and exclusions per Annex E. No indirect damages.\n\n12. Termination\n- Either party may terminate with 14 days’ notice, or immediately for material breach.\n\n13. Governing Law\n- [Choose jurisdiction]. Disputes to be resolved via [arbitration/courts].\n\n14. Annexes\n- A: RFI Response\n- B: Rate Cards & Shipping Matrix\n- C: Branding Materials & Packaging Specs\n- D: SLAs (Processing, RMA)\n- E: Compliance & Liability Details\n\nSignatures:\n- Supplier: __________________  Date:_____\n- Buyer (Shopixo): ___________ Date:_____\n","path":null,"size_bytes":2426,"size_tokens":null},"branding/suppliers/rfi-supplier-en.md":{"content":"# Request for Information (RFI) — Shopixo Supplier\n\nGoal: Identify reliable suppliers with low prices, high quality, fast delivery to Saudi Arabia, and full blind-shipping capability under Shopixo brand.\n\n## Company Information\n- Legal company name:\n- Website:\n- Registered address:\n- Country of operation:\n- Registration certificate (link/file):\n- Years in business:\n- Key clients or marketplaces served:\n\n## Capabilities & Compliance\n- Blind Shipping supported? (Yes/No)\n- Shipper Name override on label: Shopixo (Yes/No)\n- Branded packing slip inclusion (PDF/HTML we provide) (Yes/No)\n- Thank-you insert inclusion (Yes/No)\n- Optional branded materials (polybag/hangtag/sticker) MOQ & cost:\n- Quality Control process (AQL level, photos before dispatch):\n- Returns/defects policy and compensation terms:\n- No third-party marketing materials in parcel (confirm):\n\n## Product Scope & Pricing\n- Categories offered (tick all relevant): Apparel (Men/Women/Kids), Shoes, Accessories, Bags, Home & Kitchen, Toys, etc.\n- Provide sample price list (CSV/XLS) with: SKU, name, description, material, variants, cost, pack weight/dimensions.\n- MOQ per SKU for dropship orders:\n- Volume pricing tiers (100/500/1000+ units):\n- Certifications for sensitive categories (kids textiles, electronics accessories):\n- Sample policy (lead time, cost):\n\n## Shipping to KSA\n- Carriers/options to KSA (DHL, Aramex, SF, Postal, Express):\n- Typical door-to-door transit time (KSA):\n  - Apparel/Kids: __–__ days\n  - Shoes: __–__ days\n  - Accessories/others: __–__ days\n- Address labeling in Arabic supported? (Yes/No)\n- Tracking updates + format (link/API):\n- Handling of COD labels (if required later):\n\n## Systems & Integration\n- Product feeds: CSV / XML / API (specs & update frequency)\n- Inventory/price update frequency:\n- Order submission: Portal / Email / API\n- Webhooks/callbacks for shipped/delivered:\n- SLA for order processing time:\n\n## Payments & Terms\n- Accepted payment methods (Card, PayPal, Wire):\n- Currency & FX handling:\n- Dispute/chargeback handling procedures:\n- Credit terms (if any):\n\n## Test Order (Required)\n- Agree to send pre-dispatch photos/video showing:\n  - Shipping label with Shipper: Shopixo\n  - Insert + packing slip inside parcel\n- Sample test order ETA to KSA:\n\n---\nPlease reply with this form filled, your catalog file(s), and standard agreement. Email: support@shopixo.com\n","path":null,"size_bytes":2391,"size_tokens":null},"src/app/api/admin/jobs/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { listJobs } from '@/lib/jobs';\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const { searchParams } = new URL(req.url);\n    const limit = Math.max(1, Math.min(200, Number(searchParams.get('limit') || '50')));\n    const result = await listJobs(limit);\n    if (result.tablesMissing) {\n      const r = NextResponse.json({ \n        ok: false, \n        error: 'Database tables missing. Please run migrations: admin_jobs, admin_job_items tables required.',\n        tablesMissing: true \n      }, { status: 503 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const r = NextResponse.json({ ok: true, jobs: result.jobs });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'jobs list failed' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":1433,"size_tokens":null},"src/app/api/cj/pricing/quote/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { z } from 'zod'\nimport { loggerForRequest } from '@/lib/log'\nimport { shippingLimiter, getClientIp } from '@/lib/ratelimit'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, freightCalculate } from '@/lib/cj/v2'\nimport { loadPricingPolicy } from '@/lib/pricing-policy'\nimport { computeRetailFromLanded, convertToSar } from '@/lib/pricing'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nconst Body = z.object({\n  pid: z.string().min(1),\n  sku: z.string().optional(),\n  countryCode: z.string().min(2).max(3).default('SA'),\n  quantity: z.number().int().positive().default(1),\n})\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const ip = getClientIp(req)\n    const { success } = await shippingLimiter.limit(`price:${ip}`)\n    if (!success) {\n      const r = NextResponse.json({ ok: false, error: 'Too many requests' }, { status: 429 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    let parsed: z.infer<typeof Body>\n    try {\n      const json = await req.json()\n      parsed = Body.parse(json)\n    } catch (e: any) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid body' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Fetch and map product\n    const raw = await queryProductByPidOrKeyword({ pid: parsed.pid })\n    const itemRaw = Array.isArray(raw?.data?.list)\n      ? raw.data.list[0]\n      : Array.isArray(raw?.data?.content)\n        ? raw.data.content[0]\n        : Array.isArray(raw?.content)\n          ? raw.content[0]\n          : Array.isArray(raw?.data)\n            ? raw.data[0]\n            : (raw?.data || raw)\n    const mapped = mapCjItemToProductLike(itemRaw)\n    if (!mapped) {\n      const r = NextResponse.json({ ok: false, error: 'CJ map failed' }, { status: 502 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Choose variant cost\n    let cost = 0\n    let chosenSku: string | undefined = undefined\n    if (parsed.sku) {\n      const v = (mapped.variants || []).find((x) => x.cjSku === parsed.sku)\n      if (v && typeof v.price === 'number') { cost = v.price; chosenSku = v.cjSku || undefined }\n    }\n    if (!cost) {\n      const min = (mapped.variants || []).reduce<{ price: number; sku?: string } | null>((best, v) => {\n        const p = typeof v.price === 'number' ? v.price : NaN\n        if (isNaN(p)) return best\n        if (!best || p < best.price) return { price: p, sku: v.cjSku }\n        return best\n      }, null)\n      cost = min?.price || 0\n      chosenSku = min?.sku\n    }\n\n    // Freight calculation - use variant vid for exact CJ \"According to Shipping Method\" data\n    let shippingSar = 0\n    let options: any[] = []\n    try {\n      // Find the variant's vid (UUID) from the raw CJ data\n      const chosenVariant = (itemRaw?.variants || []).find((v: any) => v.variantSku === chosenSku || v.vid === chosenSku);\n      const variantVid = chosenVariant?.vid || chosenSku || mapped.productId;\n      \n      const fc = await freightCalculate({ \n        countryCode: parsed.countryCode.toUpperCase(), \n        vid: variantVid,\n        quantity: parsed.quantity\n      })\n      if (fc.ok) {\n        options = fc.options || []\n        const cheapest = options.reduce<{ price: number; currency?: string } | null>((best, opt: any) => {\n          const p = Number(opt.price || 0)\n          if (!best || p < best.price) return { price: p, currency: opt.currency }\n          return best\n        }, null)\n        if (cheapest) shippingSar = convertToSar(cheapest.price, cheapest.currency)\n      }\n    } catch {}\n\n    const policy = await loadPricingPolicy()\n    const landed = Math.max(0, cost) + Math.max(0, shippingSar)\n    let retail = computeRetailFromLanded(landed, { margin: policy.margin, roundTo: policy.roundTo, prettyEnding: policy.endings })\n    if (retail < policy.floorSar) retail = policy.floorSar\n\n    const r = NextResponse.json({ ok: true, pid: mapped.productId, sku: chosenSku, costSar: cost, shippingSar, retailSar: retail, options })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'pricing failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4408,"size_tokens":null},"src/app/api/admin/orders/[id]/fulfill-cj/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { maybeCreateCjOrderForOrderId } from '@/lib/ops/cj-fulfill';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const runtime = 'nodejs';\n\nexport async function POST(req: NextRequest, { params }: { params: { id: string } }) {\n  const log = loggerForRequest(req);\n  const guard = await ensureAdmin();\n  if (!guard.ok) {\n    const r = NextResponse.json({ error: 'Not authorized' }, { status: 401 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  // Global kill-switch enforcement\n  if (await isKillSwitchOn()) {\n    const r = NextResponse.json({ ok: false, error: 'Kill switch is ON. Fulfillment is disabled.' }, { status: 423 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const idNum = Number(params.id);\n  if (!Number.isFinite(idNum) || idNum <= 0) {\n    const r = NextResponse.json({ error: 'Invalid order id' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const res = await maybeCreateCjOrderForOrderId(idNum);\n  if (!res.ok) {\n    const r = NextResponse.json({ ok: false, reason: res.reason }, { status: 502 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  const r = NextResponse.json({ ok: true, info: res.info });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":1476,"size_tokens":null},"src/lib/ai/category-map.ts":{"content":"export type StoreCategory = \"Women\" | \"Men\" | \"Kids\" | \"Shoes\" | \"Accessories\" | \"Home\" | \"General\";\n\nconst KEYWORDS: Record<StoreCategory, string[]> = {\n  Women: [\"women\", \"woman\", \"ladies\", \"girl\", \"female\", \"abaya\", \"hijab\", \"dress\", \"skirt\", \"blouse\", \"heels\"],\n  Men: [\"men\", \"man\", \"male\", \"shirt\", \"pants\", \"hoodie\", \"jacket\", \"sweatshirt\", \"trousers\"],\n  Kids: [\"kid\", \"child\", \"children\", \"boys\", \"girls\", \"toddler\", \"baby\", \"infant\"],\n  Shoes: [\"shoe\", \"sneaker\", \"boot\", \"heel\", \"sandals\", \"loafers\", \"slippers\", \"flip flops\"],\n  Accessories: [\"bag\", \"belt\", \"hat\", \"cap\", \"scarf\", \"gloves\", \"sunglasses\", \"watch\", \"jewelry\"],\n  Home: [\"home\", \"kitchen\", \"bath\", \"bedding\", \"towel\", \"decor\", \"pillow\", \"blanket\"],\n  General: [],\n};\n\nfunction score(text: string, keywords: string[]): number {\n  const t = text.toLowerCase();\n  let s = 0;\n  for (const k of keywords) {\n    if (!k) continue;\n    const re = new RegExp(`\\\\b${k.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, \"\\\\$&\")}\\\\b`, \"i\");\n    if (re.test(t)) s += 1;\n  }\n  return s;\n}\n\nexport function mapCategory(input: { cjCategory?: string; title?: string; description?: string }): { category: StoreCategory; confidence: number } {\n  const base = `${input.cjCategory || ''} ${input.title || ''} ${input.description || ''}`.trim();\n  if (!base) return { category: \"General\", confidence: 0 };\n  let best: StoreCategory = \"General\";\n  let bestScore = 0;\n  (Object.keys(KEYWORDS) as StoreCategory[]).forEach((cat) => {\n    if (cat === 'General') return;\n    const s = score(base, KEYWORDS[cat]);\n    if (s > bestScore) {\n      best = cat;\n      bestScore = s;\n    }\n  });\n  const confidence = Math.min(1, bestScore / 3);\n  return { category: bestScore > 0 ? best : \"General\", confidence };\n}\n","path":null,"size_bytes":1739,"size_tokens":null},"src/components/chat-widget.tsx":{"content":"\"use client\";\n\nimport React, { useEffect, useRef, useState } from 'react';\n\ntype Msg = { role: 'user' | 'assistant' | 'system'; content: string };\n\nexport default function ChatWidget() {\n  const [open, setOpen] = useState(false);\n  const [input, setInput] = useState('');\n  const [sending, setSending] = useState(false);\n  const [messages, setMessages] = useState<Msg[]>([\n    { role: 'assistant', content: 'Hello! How can I help you today?' },\n  ]);\n  const listRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    if (listRef.current) listRef.current.scrollTop = listRef.current.scrollHeight;\n  }, [messages, open]);\n\n  async function send() {\n    const text = input.trim();\n    if (!text || sending) return;\n    const nextMessages: Msg[] = [...messages, { role: 'user' as const, content: text }];\n    setMessages((m) => [...m, { role: 'user' as const, content: text }]);\n    setInput('');\n    setSending(true);\n    try {\n      const res = await fetch('/api/chat', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ messages: nextMessages }),\n      });\n      const data = await res.json();\n      if (!res.ok || !data) throw new Error(data?.error || res.statusText);\n      const reply = (data.reply as string) || 'An error occurred. Please try again.';\n      setMessages((m) => [...m, { role: 'assistant' as const, content: reply }]);\n    } catch (e: any) {\n      setMessages((m) => [...m, { role: 'assistant' as const, content: 'Unable to get a response right now.' }]);\n    } finally {\n      setSending(false);\n    }\n  }\n\n  return (\n    <div>\n      <button\n        onClick={() => setOpen((v) => !v)}\n        className=\"fixed bottom-4 right-4 z-50 rounded-full bg-indigo-600 text-white w-14 h-14 shadow-lg hover:bg-indigo-700\"\n        aria-label=\"Open chat\"\n      >\n        {open ? '×' : '💬'}\n      </button>\n\n      {open && (\n        <div className=\"fixed bottom-20 right-4 z-50 w-80 sm:w-96 rounded-lg border bg-white shadow-xl flex flex-col overflow-hidden\">\n          <div className=\"px-3 py-2 bg-indigo-600 text-white text-sm font-medium\">Store Assistant</div>\n          <div ref={listRef} className=\"flex-1 p-3 space-y-2 overflow-auto max-h-96\">\n            {messages.map((m, idx) => (\n              <div key={idx} className={m.role === 'assistant' ? '' : 'text-right'}>\n                <div className={`inline-block px-3 py-2 rounded-lg text-sm ${m.role === 'assistant' ? 'bg-indigo-50 text-slate-900' : 'bg-slate-100'}`}>\n                  {m.content}\n                </div>\n              </div>\n            ))}\n            {sending && <div className=\"text-xs opacity-70\">Typing...</div>}\n          </div>\n          <div className=\"p-2 border-t flex gap-2\">\n            <input\n              value={input}\n              onChange={(e) => setInput(e.target.value)}\n              onKeyDown={(e) => { if (e.key === 'Enter') send(); }}\n              placeholder=\"Type your message...\"\n              className=\"flex-1 rounded border px-3 py-2 text-sm\"\n            />\n            <button onClick={send} disabled={sending} className=\"rounded bg-indigo-600 text-white px-3 py-2 text-sm disabled:opacity-50\">Send</button>\n          </div>\n          <div className=\"px-3 pb-2 text-[10px] text-slate-500\">\n            Tip: Check your orders on the <a href=\"/order-tracking\" className=\"underline\">order tracking</a> page.\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3459,"size_tokens":null},"src/app/api/cj/resync/media/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { loggerForRequest } from '@/lib/log'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from '@/lib/cj/v2'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nasync function resyncOne(db: any, id: number) {\n  // 1) Load product row (need cj_product_id, title as fallback)\n  const { data: p } = await db.from('products')\n    .select('id, slug, title, images, cj_product_id')\n    .eq('id', id)\n    .maybeSingle()\n  if (!p) return { id, ok: false, error: 'product not found' }\n\n  // 2) Determine CJ lookup input (pid preferred, else keyword)\n  const pid: string | undefined = (p as any).cj_product_id || undefined\n  const keyword: string | undefined = pid ? undefined : String((p as any).title || '').split(' ').slice(0, 6).join(' ') || undefined\n\n  const raw = await queryProductByPidOrKeyword({ pid, keyword })\n  const list: any[] = Array.isArray(raw?.data?.content)\n    ? raw.data.content\n    : Array.isArray(raw?.data?.list)\n      ? raw.data.list\n      : Array.isArray(raw?.content)\n        ? raw.content\n        : Array.isArray(raw?.data)\n          ? raw.data\n          : []\n  if (!list || list.length === 0) return { id, ok: false, error: 'cj not found' }\n\n  const mapped = mapCjItemToProductLike(list[0])\n  if (!mapped) return { id, ok: false, error: 'map failed' }\n\n  // 3) Update only media + title; keep existing slug/price\n  const patch: any = {\n    title: mapped.name,\n    images: mapped.images || [],\n    video_url: mapped.videoUrl || null,\n    is_active: true,\n  }\n  // Only set cj_product_id if present and column exists\n  try {\n    const { error: err } = await db.from('products').update(patch).eq('id', id)\n    if (err) return { id, ok: false, error: err.message }\n  } catch (e: any) {\n    return { id, ok: false, error: e?.message || 'update failed' }\n  }\n  return { id, ok: true, slug: p.slug }\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const db = getAdmin()\n    if (!db) {\n      const r = NextResponse.json({ ok: false, error: 'Supabase not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const { searchParams } = new URL(req.url)\n    const idsParam = searchParams.get('ids') || ''\n    let ids: number[] = []\n    if (idsParam) {\n      ids = idsParam.split(',').map((s) => Number(s.trim())).filter((n) => Number.isFinite(n) && n > 0)\n    }\n\n    // If no ids specified, pick up to 10 products missing images\n    if (ids.length === 0) {\n      const { data } = await db\n        .from('products')\n        .select('id, images')\n        .order('id', { ascending: false })\n        .limit(20)\n      const candidates = (data || []) as any[]\n      ids = candidates\n        .filter((p) => !p.images || (Array.isArray(p.images) && p.images.length === 0) || (typeof p.images === 'string' && (!p.images.trim() || p.images.trim() === '[]')))\n        .slice(0, 10)\n        .map((p) => p.id)\n    }\n\n    const results: any[] = []\n    for (const id of ids) {\n      try { results.push(await resyncOne(db, id)) } catch (e: any) { results.push({ id, ok: false, error: e?.message || 'resync failed' }) }\n    }\n\n    const r = NextResponse.json({ ok: true, results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'resync error' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":3779,"size_tokens":null},"src/app/api/admin/pricing/calc/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { calculateLandedCost } from '@/app/admin/pricing/actions';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\n\nexport const runtime = 'nodejs';\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req);\n  const guard = await ensureAdmin();\n  if (!guard.ok) {\n    const r = NextResponse.json({ error: 'Not authorized' }, { status: 401 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  let body: any;\n  try { body = await req.json(); } catch {\n    const r = NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n  try {\n    const {\n      supplierCostSar,\n      actualKg,\n      lengthCm,\n      widthCm,\n      heightCm,\n      margin,\n      handlingSar,\n    } = body || {};\n    const result = await calculateLandedCost({ supplierCostSar, actualKg, lengthCm, widthCm, heightCm, margin, handlingSar });\n    const r = NextResponse.json(result);\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ error: e?.message || 'Calculation failed' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":1331,"size_tokens":null},"src/app/reset-password/reset-password-form.tsx":{"content":"\"use client\"\n\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\"\nimport { useSearchParams } from \"next/navigation\"\nimport { useState, useTransition } from \"react\"\n\nexport default function ResetPasswordForm() {\n  const supabase = createClientComponentClient()\n  const params = useSearchParams()\n  const nextParam = (params?.get(\"next\") || params?.get(\"redirect\") || \"/\").toString()\n  const safeNext = nextParam.startsWith(\"/\") && !nextParam.startsWith(\"//\") ? nextParam : \"/\"\n\n  const [password, setPassword] = useState(\"\")\n  const [confirm, setConfirm] = useState(\"\")\n  const [error, setError] = useState(\"\")\n  const [message, setMessage] = useState(\"\")\n  const [pending, startTransition] = useTransition()\n\n  function onSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    setError(\"\")\n    setMessage(\"\")\n    if (password.length < 8) { setError(\"Password must be at least 8 characters\"); return }\n    if (password !== confirm) { setError(\"Passwords do not match\"); return }\n\n    startTransition(async () => {\n      const { error } = await supabase.auth.updateUser({ password })\n      if (error) setError(error.message)\n      else {\n        setMessage(\"Password updated successfully\")\n        if (typeof window !== \"undefined\") {\n          window.location.replace(safeNext === \"/\" ? \"/account\" : safeNext)\n        }\n      }\n    })\n  }\n\n  return (\n    <form onSubmit={onSubmit} className=\"space-y-4\">\n      <h2 className=\"text-center text-2xl font-bold\">Set New Password</h2>\n      <div className=\"grid gap-2\">\n        <label className=\"text-sm\">New Password</label>\n        <input type=\"password\" required value={password} onChange={(e) => setPassword(e.target.value)} className=\"rounded-full border px-4 py-3\" placeholder=\"••••••••\" />\n      </div>\n      <div className=\"grid gap-2\">\n        <label className=\"text-sm\">Confirm Password</label>\n        <input type=\"password\" required value={confirm} onChange={(e) => setConfirm(e.target.value)} className=\"rounded-full border px-4 py-3\" placeholder=\"••••••••\" />\n      </div>\n      <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">Update Password</button>\n      {message && <div className=\"rounded-md border border-emerald-500 bg-emerald-50 p-2 text-sm text-emerald-700\">{message}</div>}\n      {error && <div className=\"rounded-md border border-destructive bg-destructive/10 p-2 text-sm text-destructive\">{error}</div>}\n    </form>\n  )\n}\n","path":null,"size_bytes":2523,"size_tokens":null},"src/components/pro/ValueProps.tsx":{"content":"import { ShieldCheck, Truck, RotateCcw, Headphones } from \"lucide-react\"\n\nexport default function ValueProps() {\n  const items = [\n    { Icon: Truck, title: \"Fast Shipping\", desc: \"Reliable delivery to most areas\" },\n    { Icon: RotateCcw, title: \"30-Day Returns\", desc: \"Easy and hassle-free returns\" },\n    { Icon: ShieldCheck, title: \"Secure Payment\", desc: \"SSL protection and PCI standards\" },\n    { Icon: Headphones, title: \"Premium Support\", desc: \"Customer service team ready to help\" }\n  ]\n  return (\n    <section className=\"bg-[hsl(var(--bg-secondary))] py-8\" aria-label=\"Store Benefits\">\n      <div className=\"container grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4\">\n        {items.map(({ Icon, title, desc }) => (\n          <div key={title} className=\"rounded-[var(--radius-lg)] border bg-card p-5 shadow-soft\">\n            <div className=\"mb-2 flex items-center gap-2 text-[hsl(var(--secondary))]\">\n              <Icon className=\"h-6 w-6\" />\n              <h3 className=\"text-lg font-semibold text-foreground\">{title}</h3>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">{desc}</p>\n          </div>\n        ))}\n      </div>\n    </section>\n  )\n}\n","path":null,"size_bytes":1194,"size_tokens":null},"src/app/category/[slug]/page.tsx":{"content":"import { getSupabaseAnonServer } from \"@/lib/supabase-server\";\nimport type { Metadata } from \"next\";\nimport { getSiteUrl } from \"@/lib/site\";\nimport { notFound } from \"next/navigation\";\nimport ProductCard from \"@/components/product-card\";\nimport Breadcrumbs from \"@/components/breadcrumbs\";\nimport type { Product } from \"@/lib/types\";\nimport { labelFromSlug } from \"@/lib/categories\";\nimport FiltersPanel from \"@/components/pro/FiltersPanel\";\nimport { headers } from \"next/headers\";\n\nfunction slugToTitle(slug: string) {\n  return slug.replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n}\n\nexport const revalidate = 60;\n\nexport async function generateMetadata({ params }: { params: { slug: string } }): Promise<Metadata> {\n  const categoryTitle = labelFromSlug(params.slug) || params.slug.replace(/-/g, ' ').replace(/\\b\\w/g, (l) => l.toUpperCase());\n  const storeName = process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\";\n  const title = `${categoryTitle} | ${storeName}`;\n  const description = `Shop ${categoryTitle} at great prices on ${storeName}. Discover our offers and curated products.`;\n  return {\n    title,\n    description,\n    alternates: { canonical: `${getSiteUrl()}/category/${params.slug}` },\n    openGraph: {\n      title,\n      description,\n      url: `${getSiteUrl()}/category/${params.slug}`,\n      type: \"website\",\n      images: [\"/logo-wordmark.svg\"],\n    },\n    twitter: { card: \"summary_large_image\", title, description, images: [\"/logo-wordmark.svg\"] },\n  };\n}\n\nexport default async function CategoryPage({ params, searchParams }: { params: { slug: string }, searchParams?: { sort?: string; min?: string; max?: string } }) {\n  const nonce = headers().get('x-csp-nonce') || undefined;\n  const supabase = getSupabaseAnonServer();\n  const categoryTitle = labelFromSlug(params.slug) || slugToTitle(params.slug);\n  const englishFallback = slugToTitle(params.slug);\n\n  let products: Product[] | null = null;\n  if (!supabase) {\n    products = [] as any;\n  } else {\n    const s = supabase!;\n    let query = s\n      .from(\"products\")\n      .select(\"*\")\n      .in(\"category\", Array.from(new Set([categoryTitle, englishFallback])))\n      .or(\"is_active.is.null,is_active.eq.true\") as any;\n\n    const min = Number(searchParams?.min);\n    const max = Number(searchParams?.max);\n    if (!Number.isNaN(min)) query = query.gte(\"price\", min);\n    if (!Number.isNaN(max)) query = query.lte(\"price\", max);\n\n    const sort = (searchParams?.sort || '').toLowerCase();\n    if (sort === 'price-asc') query = query.order('price', { ascending: true });\n    else if (sort === 'price-desc') query = query.order('price', { ascending: false });\n\n    const { data, error } = await query;\n    if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n      const fb = await s\n        .from(\"products\")\n        .select(\"*\")\n        .eq(\"category\", categoryTitle);\n      products = (fb.data as any[] | null) as any;\n      if (fb.error) console.error(\"Category fallback error:\", fb.error);\n    } else {\n      if (error) console.error(\"Error fetching category products:\", error);\n      products = (data as any[] | null) as any;\n    }\n  }\n\n  return (\n    <main className=\"container py-6\">\n      <script\n        nonce={nonce}\n        type=\"application/ld+json\"\n        dangerouslySetInnerHTML={{\n          __html: JSON.stringify({\n            \"@context\": \"https://schema.org\",\n            \"@type\": \"BreadcrumbList\",\n            itemListElement: [\n              { \"@type\": \"ListItem\", position: 1, name: \"Home\", item: getSiteUrl() },\n              { \"@type\": \"ListItem\", position: 2, name: categoryTitle, item: `${getSiteUrl()}/category/${params.slug}` },\n            ],\n          }),\n        }}\n      />\n      <Breadcrumbs items={[{ name: \"Home\", href: \"/\" }, { name: categoryTitle }]} />\n      <FiltersPanel basePath={`/category/${params.slug}`} sort={searchParams?.sort} min={searchParams?.min} max={searchParams?.max} />\n      <h1 className=\"mb-6 text-2xl font-bold text-foreground\">{categoryTitle}</h1>\n      {products && products.length > 0 ? (\n        <div className=\"grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n          {products.map((p) => (\n            <ProductCard key={p.id} product={p as Product} />\n          ))}\n        </div>\n      ) : (\n        <p className=\"text-muted-foreground\">No products in this category.</p>\n      )}\n    </main>\n  );\n}\n","path":null,"size_bytes":4446,"size_tokens":null},"src/lib/schemas/product.ts":{"content":"import { z } from 'zod';\nimport { slugify } from '@/lib/utils/slug';\n\nexport const productSchema = z.object({\n  title: z.string().min(1, 'Title is required'),\n  slug: z\n    .string()\n    .min(1, 'Slug is required')\n    .transform((s) => slugify(s)),\n  description: z.string().optional(),\n  price: z.coerce.number().min(0, 'Price must be a positive number'),\n  stock: z.coerce.number().int().min(0, 'Stock must be a non-negative integer'),\n  // Category is required in DB; default to 'General' if not provided\n  category: z\n    .string()\n    .optional()\n    .transform((val) => (val && val.trim().length > 0 ? val.trim() : 'General')),\n  // Accept a comma-separated string from the form and transform it into a string[]\n  images: z\n    .string()\n    .optional()\n    .transform((val) => {\n      if (!val) return [] as string[];\n      return val\n        .split(',')\n        .map((s) => s.trim())\n        .filter((s) => s.length > 0);\n    })\n    .refine((arr) => Array.isArray(arr) && arr.length > 0, {\n      message: 'الرجاء إضافة صورة أو فيديو واحد على الأقل',\n      path: ['images'],\n    }),\n  // Optional publishing flag (defaults to true when omitted)\n  is_active: z\n    .union([z.boolean(), z.literal('true'), z.literal('false'), z.null()])\n    .optional()\n    .transform((v) => (v === 'false' || v === false ? false : true)),\n});\n","path":null,"size_bytes":1367,"size_tokens":null},"src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nexport interface InputProps\n  extends React.InputHTMLAttributes<HTMLInputElement> {}\n\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-[var(--radius-sm)] border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":840,"size_tokens":null},"src/app/sign-up/sign-up-form.tsx":{"content":"\"use client\";\n\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { useRouter } from \"next/navigation\";\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\n\nexport default function SignUpForm() {\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState(false);\n  const router = useRouter();\n  const supabase = createClientComponentClient();\n\n  const handleSignUp = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(null);\n\n    if (password !== confirmPassword) {\n      setError(\"Passwords do not match.\");\n      return;\n    }\n\n    const { error } = await supabase.auth.signUp({\n      email,\n      password,\n      options: {\n        emailRedirectTo: `${location.origin}/auth/callback`,\n      },\n    });\n\n    if (error) {\n      setError(error.message);\n    } else {\n      setSuccess(true);\n    }\n  };\n\n  if (success) {\n    return (\n      <div className=\"rounded-md bg-primary/10 p-6 text-center\">\n        <h2 className=\"text-lg font-semibold\">Check Your Email</h2>\n        <p className=\"mt-2 text-sm text-muted-foreground\">\n          We sent a confirmation link to your email. Please click the link to complete registration.\n        </p>\n      </div>\n    );\n  }\n\n  return (\n    <form onSubmit={handleSignUp} className=\"space-y-4\">\n      {error && <p className=\"rounded-md bg-destructive/10 p-3 text-center text-sm text-destructive\">{error}</p>}\n      <div className=\"space-y-1\">\n        <Label htmlFor=\"email\">Email</Label>\n        <Input\n          id=\"email\"\n          type=\"email\"\n          value={email}\n          onChange={(e) => setEmail(e.target.value)}\n          dir=\"ltr\"\n          required\n        />\n      </div>\n      <div className=\"space-y-1\">\n        <Label htmlFor=\"password\">Password</Label>\n        <Input\n          id=\"password\"\n          type=\"password\"\n          value={password}\n          onChange={(e) => setPassword(e.target.value)}\n          dir=\"ltr\"\n          required\n        />\n      </div>\n      <div className=\"space-y-1\">\n        <Label htmlFor=\"confirmPassword\">Confirm Password</Label>\n        <Input\n          id=\"confirmPassword\"\n          type=\"password\"\n          value={confirmPassword}\n          onChange={(e) => setConfirmPassword(e.target.value)}\n          dir=\"ltr\"\n          required\n        />\n      </div>\n      <Button type=\"submit\" className=\"w-full\">Create Account</Button>\n    </form>\n  );\n}\n","path":null,"size_bytes":2711,"size_tokens":null},"src/app/return-policy/page.tsx":{"content":"export const metadata = { title: \"Return Policy\" };\n\nexport default function ReturnPolicyPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Return Policy</h1>\n      <p className=\"mt-4 text-slate-700 text-sm\">You can return eligible items within 30 days of delivery. This is a placeholder policy.</p>\n    </div>\n  );\n}\n","path":null,"size_bytes":376,"size_tokens":null},"src/components/admin-fulfill-cj-button.tsx":{"content":"\"use client\";\n\nimport React, { useState } from 'react';\n\nexport function AdminFulfillCjButton({ orderId }: { orderId: number }) {\n  const [loading, setLoading] = useState(false);\n  const [msg, setMsg] = useState<string | null>(null);\n\n  async function handleClick() {\n    setLoading(true);\n    setMsg(null);\n    try {\n      const res = await fetch(`/api/admin/orders/${orderId}/fulfill-cj`, { method: 'POST' });\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        setMsg(`Failed: ${data?.reason || res.statusText}`);\n      } else {\n        setMsg('CJ order created');\n      }\n    } catch (e: any) {\n      setMsg(e?.message || 'Request failed');\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"inline-flex items-center gap-2\">\n      <button\n        onClick={handleClick}\n        disabled={loading}\n        className=\"px-3 py-1.5 rounded bg-indigo-600 text-white disabled:opacity-50\"\n      >\n        {loading ? 'Submitting…' : 'Fulfill at CJ'}\n      </button>\n      {msg && <span className=\"text-xs opacity-80\">{msg}</span>}\n    </div>\n  );\n}\n","path":null,"size_bytes":1104,"size_tokens":null},"src/lib/order-actions.ts":{"content":"\"use server\";\n\nimport { createClient } from \"@supabase/supabase-js\";\nimport { getCartItemsBySessionId } from \"./cart-actions\";\nimport type { CartItem } from \"./types\";\n\n// IMPORTANT: Use a lazily initialized Supabase admin client to avoid\n// build-time env access. This is called in server actions/webhooks only.\nlet supabaseAdmin: ReturnType<typeof createClient> | null = null;\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  if (!supabaseAdmin) {\n    supabaseAdmin = createClient(url, key);\n  }\n  return supabaseAdmin;\n}\n\n/**\n * Creates an order in the database from a cart session.\n * @param cartSessionId The ID of the cart session.\n * @param userId The ID of the user placing the order.\n * @param stripeSessionId The ID of the Stripe Checkout session.\n */\nexport async function createOrder(cartSessionId: string, userId: string, stripeSessionId: string) {\n  const admin = getSupabaseAdmin();\n  if (!admin) {\n    throw new Error(\"Server misconfiguration: Supabase env vars missing\");\n  }\n  const client = admin as any;\n  const { items, error: cartError } = await getCartItemsBySessionId(cartSessionId);\n\n  if (cartError || !items || items.length === 0) {\n    throw new Error(`Could not retrieve cart items or cart is empty. Error: ${cartError?.message}`);\n  }\n\n  const totalAmount = items.reduce((sum: number, item: CartItem) => {\n    if (!item.product) return sum;\n    return sum + item.product.price * item.quantity;\n  }, 0);\n\n  // 1. Create the order\n  const { data: order, error: orderError } = await client\n    .from(\"orders\")\n    .insert({\n      user_id: userId,\n      total_amount: totalAmount,\n      stripe_session_id: stripeSessionId,\n    })\n    .select()\n    .single();\n\n  if (orderError) {\n    console.error(\"Error creating order:\", orderError);\n    throw new Error(\"Failed to create order.\");\n  }\n\n  // 2. Create the order items\n  const orderItems = items\n    .filter((item: CartItem) => item.product)\n    .map((item: CartItem) => ({\n      order_id: order.id,\n      product_id: item.product!.id,\n      quantity: item.quantity,\n      price: item.product!.price, // Price at the time of purchase\n    }));\n\n  if (orderItems.length === 0) {\n    throw new Error(\"No valid items to add to the order.\");\n  }\n\n  const { error: itemsError } = await client.from(\"order_items\").insert(orderItems);\n\n  if (itemsError) {\n    console.error(\"Error creating order items:\", itemsError);\n    // If creating order items fails, we should ideally roll back the order creation.\n    // For simplicity, we'll log the error. In production, you'd want a transaction.\n    throw new Error(\"Failed to create order items.\");\n  }\n\n  // 3. Clear the cart\n  const { error: deleteError } = await client\n    .from(\"cart_items\")\n    .delete()\n    .eq(\"session_id\", cartSessionId);\n  if (deleteError) {\n    console.error(\"Failed to clear cart items after order creation:\", deleteError);\n    // This is not a critical failure, so we just log it.\n  }\n\n  return { orderId: order.id };\n}\n","path":null,"size_bytes":3085,"size_tokens":null},"src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center whitespace-nowrap rounded-[var(--radius-sm)] text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n        gradient: \"btn-gradient shadow-soft hover:shadow-soft hover:brightness-95 hover:scale-[1.02] transition-transform rounded-[var(--radius-btn)]\",\n        // Brand variants\n        cta: \"bg-[hsl(var(--primary))] text-white rounded-[var(--radius-btn)] hover:brightness-95 shadow-soft\",\n        secondaryOutline: \"border-2 border-[hsl(var(--secondary))] text-[hsl(var(--secondary))] rounded-[var(--radius-btn)] hover:bg-[hsl(var(--secondary))]/10\",\n      },\n      size: {\n        default: \"h-12 px-5 py-2.5\", // 48px height per brief\n        sm: \"h-9 px-3\",\n        lg: \"h-11 px-8\",\n        pill: \"h-11 px-6 py-3 rounded-[var(--radius-btn)]\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2378,"size_tokens":null},"src/lib/stripe.ts":{"content":"import Stripe from \"stripe\";\nlet stripeInstance: Stripe | null = null;\n\nexport function getStripe(): Stripe {\n  const key = process.env.STRIPE_SECRET_KEY;\n  if (!key) {\n    throw new Error(\"STRIPE_SECRET_KEY is not set in the environment variables\");\n  }\n  if (!stripeInstance) {\n    stripeInstance = new Stripe(key, {\n      apiVersion: \"2024-06-20\" as any,\n      typescript: true,\n    });\n  }\n  return stripeInstance;\n}\n","path":null,"size_bytes":421,"size_tokens":null},"src/components/announcement-bar.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\n\nexport default function AnnouncementBar() {\n  const [hidden, setHidden] = useState(false);\n\n  useEffect(() => {\n    const dismissed = localStorage.getItem(\"ann_bar_dismissed\") === \"1\";\n    setHidden(dismissed);\n  }, []);\n\n  if (hidden) return null;\n\n  return (\n    <div className=\"w-full bg-secondary/10 text-foreground\">\n      <div className=\"container flex items-center justify-between gap-4 py-2 text-sm\">\n        <p className=\"truncate\">Free shipping on orders over $50 • 30-day returns • Secure payment</p>\n        <button\n          aria-label=\"Dismiss announcement\"\n          className=\"rounded-md px-2 py-1 text-xs text-muted-foreground hover:text-foreground\"\n          onClick={() => {\n            localStorage.setItem(\"ann_bar_dismissed\", \"1\");\n            setHidden(true);\n          }}\n        >\n          Close\n        </button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":936,"size_tokens":null},"src/pages/api/healthz.ts":{"content":"import type { NextApiRequest, NextApiResponse } from 'next'\n\nexport default function handler(req: NextApiRequest, res: NextApiResponse) {\n  const env = {\n    NEXT_PUBLIC_SUPABASE_URL: !!process.env.NEXT_PUBLIC_SUPABASE_URL,\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    SUPABASE_SERVICE_ROLE_KEY: !!process.env.SUPABASE_SERVICE_ROLE_KEY,\n    STRIPE_SECRET_KEY: !!process.env.STRIPE_SECRET_KEY,\n    STRIPE_WEBHOOK_SECRET: !!process.env.STRIPE_WEBHOOK_SECRET,\n    NEXT_PUBLIC_SITE_URL: !!process.env.NEXT_PUBLIC_SITE_URL,\n    VERCEL_URL: !!process.env.VERCEL_URL,\n  } as const\n\n  const deployment = {\n    vercel: !!process.env.VERCEL,\n    vercelEnv: process.env.VERCEL_ENV || null,\n  } as const\n\n  res.status(200).json({\n    ok: true,\n    node: process.version,\n    runtime: 'nodejs',\n    env,\n    deployment,\n    timestamp: new Date().toISOString(),\n  })\n}\n","path":null,"size_bytes":894,"size_tokens":null},"src/app/account/orders/page.tsx":{"content":"import Link from \"next/link\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport type { Order } from \"@/lib/types\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nasync function getUserOrders(userId: string, status?: string): Promise<Order[]> {\n  const supabase = createServerComponentClient({ cookies });\n  let query = supabase\n    .from(\"orders\")\n    .select(`\n      id,\n      created_at,\n      total_amount,\n      status\n    `)\n    .eq(\"user_id\", userId)\n    .order(\"created_at\", { ascending: false });\n\n  if (status && status !== \"all\") {\n    query = query.eq(\"status\", status);\n  }\n\n  const { data, error } = await query;\n\n  if (error) {\n    console.error(\"Error fetching user orders:\", error);\n    return [];\n  }\n  return data as Order[];\n}\n\nexport default async function UserOrdersPage({ searchParams }: { searchParams: { status?: string } }) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    redirect(\"/login?redirect=/account/orders\");\n  }\n\n  const currentStatus = (searchParams?.status || \"all\").toLowerCase();\n  const orders = await getUserOrders(user.id, currentStatus);\n\n  const statuses: { key: string; label: string }[] = [\n    { key: \"all\", label: \"All\" },\n    { key: \"paid\", label: \"Paid\" },\n    { key: \"processing\", label: \"Processing\" },\n    { key: \"shipped\", label: \"Shipped\" },\n    { key: \"delivered\", label: \"Delivered\" },\n    { key: \"returned\", label: \"Returned\" },\n  ];\n\n  const statusLabelMap: Record<string, string> = {\n    paid: \"Paid\",\n    processing: \"Processing\",\n    shipped: \"Shipped\",\n    delivered: \"Delivered\",\n    returned: \"Returned\",\n  };\n\n  return (\n    <div className=\"max-w-4xl mx-auto py-12 px-4\">\n      <h1 className=\"text-3xl font-bold mb-4\">My Orders</h1>\n      <div className=\"flex flex-wrap gap-2 mb-6\">\n        {statuses.map((s) => {\n          const linkHref = s.key === \"all\"\n            ? { pathname: \"/account/orders\" }\n            : { pathname: \"/account/orders\", query: { status: s.key } };\n          const isActive = currentStatus === s.key || (s.key === \"all\" && currentStatus === \"all\");\n          return (\n            <Link\n              key={s.key}\n              href={linkHref}\n              className={`px-3 py-1.5 text-sm rounded-full border ${\n                isActive ? \"bg-black text-white border-black\" : \"bg-white text-gray-700 hover:bg-gray-50\"\n              }`}\n            >\n              {s.label}\n            </Link>\n          );\n        })}\n      </div>\n      {orders.length === 0 ? (\n        <p>You haven't placed any orders yet.</p>\n      ) : (\n        <div className=\"space-y-4\">\n          {orders.map((order) => (\n            <div key={order.id} className=\"bg-white shadow-md rounded-lg p-6\">\n              <div className=\"flex justify-between items-start mb-2\">\n                <div>\n                  <h2 className=\"text-lg font-semibold\">Order #{order.id}</h2>\n                  <p className=\"text-sm text-gray-500\">\n                    {format(new Date(order.created_at), \"MMMM d, yyyy\")}\n                  </p>\n                </div>\n                <span className=\"px-3 py-1 text-sm font-semibold text-green-800 bg-green-100 rounded-full\">\n                  {statusLabelMap[order.status] || order.status}\n                </span>\n              </div>\n              <div>\n                <p className=\"text-lg font-medium\">\n                  Total: {formatCurrency(order.total_amount)}\n                </p>\n              </div>\n            </div>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":3799,"size_tokens":null},"src/app/opengraph-image.tsx":{"content":"import { ImageResponse } from \"next/og\";\n\nexport const runtime = \"edge\";\nexport const size = { width: 1200, height: 630 };\nexport const contentType = \"image/png\";\n\nexport default function Image() {\n  return new ImageResponse(\n    (\n      <div\n        style={{\n          height: \"100%\",\n          width: \"100%\",\n          display: \"flex\",\n          flexDirection: \"column\",\n          justifyContent: \"center\",\n          alignItems: \"flex-start\",\n          background: \"linear-gradient(135deg, #EEF2FF 0%, #ECFEFF 100%)\",\n          padding: 80,\n        }}\n      >\n        <div\n          style={{\n            fontSize: 56,\n            color: \"#1f2937\",\n            fontWeight: 800,\n          }}\n        >\n          Shopixo\n        </div>\n        <div\n          style={{\n            marginTop: 12,\n            fontSize: 36,\n            color: \"#111827\",\n            fontWeight: 700,\n          }}\n        >\n          Modern Online Store\n        </div>\n        <div\n          style={{\n            marginTop: 16,\n            fontSize: 24,\n            color: \"#374151\",\n          }}\n        >\n          Secure checkout • Fast delivery • Curated collections\n        </div>\n      </div>\n    ),\n    { ...size }\n  );\n}\n","path":null,"size_bytes":1211,"size_tokens":null},"src/app/admin/blog/[id]/edit/page.tsx":{"content":"import BlogForm from \"@/app/admin/blog/_components/blog-form\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nasync function getPost(id: number) {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null as any;\n  const supabase = createClient(url, key);\n  const { data } = await supabase\n    .from(\"blog_posts\")\n    .select(\"id, title, slug, excerpt, content, published\")\n    .eq(\"id\", id)\n    .maybeSingle();\n  return data || null;\n}\n\nexport default async function EditBlogPostPage({ params }: { params: { id: string } }) {\n  const id = Number(params.id);\n  const post = Number.isFinite(id) ? await getPost(id) : null;\n\n  return (\n    <div>\n      <h1 className=\"mb-6 text-2xl font-bold\">Edit Blog Post</h1>\n      {post ? (\n        <BlogForm\n          mode=\"edit\"\n          initial={{ id: post.id, title: post.title, slug: post.slug, excerpt: post.excerpt, content: post.content, published: post.published }}\n        />\n      ) : (\n        <p className=\"text-slate-600\">Post not found.</p>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":1176,"size_tokens":null},"src/lib/utils.ts":{"content":"import { type ClassValue, clsx } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n \nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n\nexport function formatCurrency(value: number, currency?: string, locale?: string) {\n  const curr = (currency || process.env.NEXT_PUBLIC_CURRENCY || \"USD\");\n  const loc = locale || (typeof window !== 'undefined' && typeof navigator !== 'undefined' ? navigator.language : 'en-US');\n  return new Intl.NumberFormat(loc, { style: \"currency\", currency: curr }).format(value);\n}\n","path":null,"size_bytes":540,"size_tokens":null},"src/lib/runner.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js'\nimport { listCjProductsPage, mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\nimport { calculateRetailSar, usdToSar } from '@/lib/pricing'\nimport { getJob, patchJob, startJob, finishJob, upsertJobItemByPid } from '@/lib/jobs'\nimport { runScannerJob } from '@/lib/scanner'\n\nfunction getAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function runJob(id: number): Promise<{ ok: boolean; processed?: number; kind?: string; error?: string }> {\n  const db = getAdmin()\n  if (!db) return { ok: false, error: 'Server not configured' }\n  const state = await getJob(id)\n  if (!state) return { ok: false, error: 'Job not found' }\n  const job = state.job\n  if (job.status === 'success' || job.status === 'canceled') return { ok: true, processed: 0, kind: job.kind }\n\n  await startJob(id)\n\n  try {\n    if (job.kind === 'finder') {\n      // Run until done by stepping many times\n      let processed = 0\n      for (let i = 0; i < 2000; i++) {\n        const r = await stepFinderJob(id)\n        processed += r.added\n        if (r.done) break\n      }\n      await finishJob(id, 'success', { candidates: (job?.totals?.candidates || 0) + processed })\n      return { ok: true, processed, kind: job.kind }\n    }\n    if (job.kind === 'scanner') {\n      const res = await runScannerJob(id)\n      await finishJob(id, 'success', res)\n      return { ok: true, processed: res.updated || 0, kind: job.kind }\n    }\n    // Other kinds not implemented yet\n    await finishJob(id, 'error', null, 'Runner does not support this job kind yet')\n    return { ok: false, error: 'unsupported kind' }\n  } catch (e: any) {\n    await finishJob(id, 'error', null, e?.message || String(e))\n    return { ok: false, error: e?.message || String(e) }\n  }\n}\n\nexport async function stepFinderJob(id: number): Promise<{ added: number; done: boolean }> {\n  const db = getAdmin()\n  if (!db) return { added: 0, done: true }\n  const state = await getJob(id)\n  if (!state) return { added: 0, done: true }\n  const job = state.job\n  const params = (job.params || {}) as any\n\n  const keywords: string[] = Array.isArray(params.keywords) ? params.keywords : []\n  const pageSize: number = Math.max(1, Math.min(50, Number(params.pageSize || 20)))\n  const maxPagesPerKeyword: number = Math.max(1, Math.min(40, Number(params.maxPagesPerKeyword || 5)))\n  const pricing = params.pricing || {}\n  const margin = typeof pricing.margin === 'number' ? pricing.margin : 0.35\n  const handlingSar = typeof pricing.handlingSar === 'number' ? pricing.handlingSar : 0\n  const cjCurrency: 'USD' | 'SAR' = (pricing.cjCurrency || 'USD').toUpperCase() === 'SAR' ? 'SAR' : 'USD'\n\n  // Initialize or read cursor\n  const cur = params.cursor && typeof params.cursor === 'object'\n    ? params.cursor\n    : { kwIndex: 0, pageNum: 1, collected: 0 }\n\n  if (!keywords || keywords.length === 0 || cur.kwIndex >= keywords.length) {\n    await finishJob(id, 'success', job.totals || { candidates: job.totals?.candidates || 0 })\n    return { added: 0, done: true }\n  }\n\n  const kw = keywords[cur.kwIndex]\n\n  // Stop if exceeded max pages for current keyword\n  if (cur.pageNum > maxPagesPerKeyword) {\n    const next = { kwIndex: cur.kwIndex + 1, pageNum: 1, collected: cur.collected }\n    await patchJob(id, { params: { ...params, cursor: next } })\n    const done = next.kwIndex >= keywords.length\n    if (done) await finishJob(id, 'success', job.totals || { candidates: job.totals?.candidates || 0 })\n    return { added: 0, done }\n  }\n\n  // Fetch a single page\n  let list: any[] = []\n  try {\n    const lr = await listCjProductsPage({ pageNum: cur.pageNum, pageSize, keyword: kw })\n    list = Array.isArray(lr?.data?.list) ? lr.data.list : []\n  } catch {}\n\n  // If empty page, advance to next keyword\n  if (!list || list.length === 0) {\n    const next = { kwIndex: cur.kwIndex + 1, pageNum: 1, collected: cur.collected }\n    await patchJob(id, { params: { ...params, cursor: next } })\n    const done = next.kwIndex >= keywords.length\n    if (done) await finishJob(id, 'success', job.totals || { candidates: job.totals?.candidates || 0 })\n    return { added: 0, done }\n  }\n\n  let added = 0\n  for (const it of list) {\n    const pid = String(it?.pid || it?.productId || it?.id || '')\n    if (!pid) continue\n\n    let mapped: any = null\n    try {\n      const det = await queryProductByPidOrKeyword({ pid })\n      const base = Array.isArray((det as any)?.data?.content) ? (det as any).data.content[0] : ((det as any).data || det)\n      mapped = mapCjItemToProductLike(base)\n    } catch {}\n    if (!mapped) continue\n\n    const variants = Array.isArray(mapped.variants) ? mapped.variants : []\n    let stockSum = 0\n    let minRetailSansShip: number | null = null\n    const outVariants: any[] = []\n    for (const v of variants) {\n      const costUSD = typeof v.price === 'number' ? v.price : undefined\n      const supplierCostSar = typeof costUSD === 'number' ? (cjCurrency === 'USD' ? usdToSar(costUSD) : costUSD) : undefined\n      const weightG = typeof v.weightGrams === 'number' ? Math.max(0, v.weightGrams) : undefined\n      const L = typeof v.lengthCm === 'number' ? v.lengthCm : 25\n      const W = typeof v.widthCm === 'number' ? v.widthCm : 20\n      const H = typeof v.heightCm === 'number' ? v.heightCm : 3\n      const actualKg = typeof weightG === 'number' ? Math.max(0.05, weightG / 1000) : 0.3\n\n      let retailSar: number | null = null\n      let ddpShippingSar: number | null = null\n      if (typeof supplierCostSar === 'number' && supplierCostSar > 0) {\n        const calc = calculateRetailSar(supplierCostSar, { actualKg, lengthCm: L, widthCm: W, heightCm: H }, { margin, handlingSar })\n        retailSar = calc.retailSar\n        ddpShippingSar = calc.ddpShippingSar\n        const sans = Math.max(0, retailSar - ddpShippingSar)\n        if (minRetailSansShip === null || sans < minRetailSansShip) minRetailSansShip = sans\n      }\n      const stock = typeof v.stock === 'number' ? v.stock : 0\n      stockSum += stock\n\n      outVariants.push({\n        size: v.size || null,\n        color: v.color || null,\n        cj_sku: v.cjSku || null,\n        supplier_cost_sar: typeof supplierCostSar === 'number' ? supplierCostSar : null,\n        retail_sar: typeof retailSar === 'number' ? retailSar : null,\n        ddp_shipping_sar: typeof ddpShippingSar === 'number' ? ddpShippingSar : null,\n        stock,\n        weight_grams: typeof weightG === 'number' ? Math.round(weightG) : null,\n        length_cm: typeof v.lengthCm === 'number' ? v.lengthCm : null,\n        width_cm: typeof v.widthCm === 'number' ? v.widthCm : null,\n        height_cm: typeof v.heightCm === 'number' ? v.heightCm : null,\n        imageUrl: v.imageUrl || null,\n      })\n    }\n\n    await upsertJobItemByPid(id, mapped.productId, {\n      status: 'success',\n      step: 'candidate',\n      result: {\n        product: {\n          cj_product_id: mapped.productId,\n          name: mapped.name,\n          images: mapped.images,\n          video_url: mapped.videoUrl || null,\n          origin_area: (mapped as any).originArea ?? null,\n          origin_country_code: (mapped as any).originCountryCode ?? null,\n          processing_time_hours: (mapped as any).processingTimeHours ?? null,\n          delivery_time_hours: (mapped as any).deliveryTimeHours ?? null,\n        },\n        metrics: {\n          stock_sum: stockSum,\n          min_retail_sans_ship: minRetailSansShip,\n        },\n        variants: outVariants,\n      },\n    })\n    added++\n  }\n\n  // Advance cursor to next page\n  const next = { kwIndex: cur.kwIndex, pageNum: cur.pageNum + 1, collected: cur.collected + added }\n  await patchJob(id, { params: { ...params, cursor: next }, totals: { candidates: (job?.totals?.candidates || 0) + added } })\n\n  return { added, done: false }\n}\n","path":null,"size_bytes":7962,"size_tokens":null},"src/app/admin/cj/settings/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\n\ntype GetResp = { ok: boolean; configured?: boolean; emailPreview?: string | null; base?: string | null; error?: string; tablesMissing?: boolean };\ntype SaveResp = { ok: boolean; error?: string; tablesMissing?: boolean };\n\nexport default function CjSettingsPage() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [tablesMissing, setTablesMissing] = useState(false);\n  const [configured, setConfigured] = useState(false);\n  const [email, setEmail] = useState(\"\");\n  const [apiKey, setApiKey] = useState(\"\");\n  const [base, setBase] = useState(\"\");\n\n  async function load() {\n    setLoading(true); setError(null); setTablesMissing(false);\n    try {\n      const r = await fetch('/api/admin/cj/settings', { cache: 'no-store' });\n      const j: GetResp = await r.json();\n      if (j.tablesMissing) {\n        setTablesMissing(true);\n        setError(j.error || 'Database tables missing');\n        return;\n      }\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setConfigured(!!j.configured);\n      if (typeof j.base === 'string') setBase(j.base);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to load settings');\n    } finally { setLoading(false); }\n  }\n\n  async function save() {\n    setSaving(true); setError(null);\n    try {\n      const r = await fetch('/api/admin/cj/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, apiKey, base: base || null }) });\n      const j: SaveResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setConfigured(true);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to save');\n    } finally { setSaving(false); }\n  }\n\n  useEffect(() => { load(); }, []);\n\n  if (tablesMissing) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex items-baseline justify-between\">\n          <h1 className=\"text-2xl font-semibold\">Supplier Settings</h1>\n        </div>\n        <div className=\"rounded-lg border-2 border-amber-300 bg-amber-50 p-6\">\n          <h2 className=\"text-lg font-semibold text-amber-800 mb-3\">Database Setup Required</h2>\n          <p className=\"text-amber-700 mb-4\">\n            The required database table <code className=\"bg-amber-100 px-1 rounded\">kv_settings</code> does not exist.\n          </p>\n          <div className=\"bg-white rounded border p-4 text-sm\">\n            <p className=\"font-medium mb-2\">To fix this, run the following SQL in your Supabase SQL Editor:</p>\n            <pre className=\"bg-slate-100 p-3 rounded text-xs overflow-auto whitespace-pre-wrap\">\n{`CREATE TABLE IF NOT EXISTS public.kv_settings (\n  key TEXT PRIMARY KEY,\n  value JSONB NOT NULL DEFAULT '{}'::jsonb,\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nALTER TABLE public.kv_settings ENABLE ROW LEVEL SECURITY;\n\nCREATE POLICY \"Service role can manage kv_settings\" ON public.kv_settings\n  FOR ALL USING (auth.role() = 'service_role') \n  WITH CHECK (auth.role() = 'service_role');`}\n            </pre>\n          </div>\n          <button onClick={load} className=\"mt-4 rounded bg-amber-600 px-4 py-2 text-white hover:bg-amber-700\">\n            Retry\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Supplier Settings</h1>\n        <div className=\"flex items-center gap-3 text-sm\">\n          <Link href=\"/admin/console\" className=\"text-blue-600 hover:underline\">Admin Console</Link>\n          <Link href=\"/api/admin/cj/diag?kw=dress\" className=\"text-blue-600 hover:underline\">Run Diagnostics</Link>\n        </div>\n      </div>\n\n      {error && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <section className=\"rounded border bg-white p-4 space-y-4\">\n        <div className=\"text-sm text-muted-foreground\">Provide supplier API credentials. These are stored in kv_settings (server-side).</div>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Supplier Account Email</div>\n            <input value={email} onChange={e => setEmail(e.target.value)} className=\"w-full rounded border px-2 py-1\" placeholder=\"you@example.com\" />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Supplier API Key</div>\n            <input value={apiKey} onChange={e => setApiKey(e.target.value)} className=\"w-full rounded border px-2 py-1\" placeholder=\"••••••\" />\n          </label>\n        </div>\n        <label className=\"text-sm block\">\n          <div className=\"text-gray-600 mb-1\">Supplier API Base (optional)</div>\n          <input value={base} onChange={e => setBase(e.target.value)} className=\"w-full rounded border px-2 py-1\" placeholder=\"https://developers.cjdropshipping.com/api2.0/v1\" />\n        </label>\n        <div className=\"flex items-center gap-3\">\n          <button onClick={save} disabled={saving || !email || !apiKey} className=\"rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700\">Save</button>\n          {configured ? <span className=\"text-sm text-green-700\">Configured</span> : <span className=\"text-sm text-amber-700\">Not configured</span>}\n        </div>\n      </section>\n\n      {loading && <div className=\"text-sm text-gray-500\">Loading…</div>}\n\n      <section className=\"rounded border bg-white p-4\">\n        <div className=\"font-medium mb-2\">After saving</div>\n        <ul className=\"list-disc pl-5 text-sm text-gray-700 space-y-1\">\n          <li>Run <Link href=\"/api/admin/cj/diag?kw=dress\" className=\"underline text-blue-600\">Diagnostics</Link> to confirm token.</li>\n          <li>Use <Link href=\"/admin/cj/finder\" className=\"underline text-blue-600\">Catalog Finder</Link> or <code className=\"bg-slate-100 px-1\">auto-import</code> endpoints with your target categories.</li>\n        </ul>\n      </section>\n    </div>\n  );\n}\n","path":null,"size_bytes":6238,"size_tokens":null},"branding/suppliers/po-trial-order-en.md":{"content":"# Trial Purchase Order (PO) — Shopixo\n\nPO No: [PO-2025-001]\nDate: [YYYY-MM-DD]\nSupplier: [Company]\nContact: [Name, Email, WhatsApp]\n\nFulfillment Terms:\n- Blind Shipping. Shipper Name on label: Shopixo\n- Include Shopixo packing slip + thank-you insert in parcel\n- Service: [Economy/Express], DDP: [Yes/No]\n- Target KSA transit: [X–Y] days. Tracking within 24h of handover\n\nShip-To: End customer (KSA). Address will be provided per order (Arabic supported)\n\nItems:\n| SKU | Name | Variant(s) | Qty | Unit Cost (USD) | Est. Weight (kg) | Notes |\n|---|---|---|---:|---:|---:|---|\n\nPackaging Instructions: Apparel folded in clean polybags. No supplier materials inside\n\nPre-dispatch proof required: label (Shopixo) + insert + packing slip inside parcel\n\nPayment: [Card/Wire]. Currency: USD. Incoterms: DDP preferred\n\nAuthorized by Shopixo: __________________ Date: _____\n","path":null,"size_bytes":869,"size_tokens":null},"src/app/globals.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n \n@layer base {\n  :root {\n    /* Shopixo Brand Tokens (Light) */\n    /* Colors (HSL) */\n    --bg: 0 0% 100%;                 /* #FFFFFF */\n    --surface: 0 0% 100%;            /* #FFFFFF */\n    --text-primary: 0 0% 7%;         /* #111111 */\n    --text-secondary: 0 0% 32%;      /* ~#525252 */\n    --muted-foreground: 0 0% 45%;    /* ~#737373 */\n\n    /* Brand palette */\n    --brand-gold: 46 67% 47%;        /* #C9A227 */\n    --brand-navy: 219 65% 29%;       /* #1A3D7C */\n    --brand-error: 0 65% 50%;        /* #D32F2F */\n    --brand-success: 123 43% 39%;    /* #388E3C */\n    --bg-secondary: 0 0% 97%;        /* #F8F8F8 */\n\n    /* Accent gradient stops (hex) for btn-gradient */\n    --accent-start-hex: #c9a227;     /* brand gold start */\n    --accent-end-hex: #e0b84b;       /* brand gold end (lighter) */\n\n    /* Radii */\n    --radius-lg: 16px;   /* cards */\n    --radius-btn: 12px;  /* buttons */\n    --radius-sm: 8px;    /* inputs */\n    --radius-image: 12px;\n    --radius: var(--radius-lg);\n\n    /* Shadows */\n    --shadow-soft: 0 8px 24px rgba(0,0,0,0.06);\n    --shadow-hover: 0 12px 28px rgba(0,0,0,0.08);\n\n    /* Tailwind color mappings */\n    --background: var(--bg);\n    --foreground: var(--text-primary);\n    --card: var(--surface);\n    --card-foreground: var(--text-primary);\n    --popover: var(--surface);\n    --popover-foreground: var(--text-primary);\n    --primary: var(--brand-gold);\n    --primary-foreground: 0 0% 100%;\n    --secondary: var(--brand-navy);\n    --secondary-foreground: 0 0% 100%;\n    --muted: var(--bg-secondary);\n    --accent: var(--brand-gold);\n    --accent-foreground: 0 0% 100%;\n    --destructive: var(--brand-error);\n    --destructive-foreground: 0 0% 100%;\n    --border: 0 0% 87%;              /* #DDDDDD */\n    --input: 0 0% 87%;\n    --ring: var(--brand-gold);\n  }\n\n  .dark {\n    /* Dark mode approximations */\n    --bg: 0 0% 7%;                  /* near black */\n    --surface: 0 0% 10%;\n    --text-primary: 0 0% 98%;\n    --text-secondary: 0 0% 75%;\n    --muted-foreground: 0 0% 60%;\n\n    --brand-gold: 46 67% 45%;\n    --brand-navy: 219 65% 40%;\n    --brand-error: 0 70% 58%;\n    --brand-success: 123 45% 48%;\n    --bg-secondary: 0 0% 12%;\n\n    /* Accent gradient stops (hex) for dark */\n    --accent-start-hex: #d4ae2e;\n    --accent-end-hex: #f1cc58;\n\n    --shadow-soft: 0 8px 20px rgba(255,255,255,0.06);\n    --shadow-hover: 0 12px 28px rgba(255,255,255,0.08);\n\n    --background: var(--bg);\n    --foreground: var(--text-primary);\n    --card: var(--surface);\n    --card-foreground: var(--text-primary);\n    --popover: var(--surface);\n    --popover-foreground: var(--text-primary);\n    --primary: var(--brand-gold);\n    --primary-foreground: 0 0% 100%;\n    --secondary: var(--brand-navy);\n    --secondary-foreground: 0 0% 100%;\n    --muted: var(--bg-secondary);\n    --accent: var(--brand-gold);\n    --accent-foreground: 0 0% 100%;\n    --destructive: var(--brand-error);\n    --destructive-foreground: 0 0% 100%;\n    --border: 0 0% 18%;\n    --input: 0 0% 18%;\n    --ring: var(--brand-gold);\n  }\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply bg-background text-foreground antialiased;\n    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, \"Apple Color Emoji\", \"Segoe UI Emoji\";\n    font-size: 18px;   /* Body desktop */\n    line-height: 1.5;  /* 27px on 18px */\n  }\n  h1, h2, h3 {\n    font-family: var(--font-playfair), Playfair Display, serif;\n    font-weight: 700;\n    line-height: 1.2;\n  }\n  h1 { font-size: 40px; }\n  h2 { font-size: 32px; }\n  h3 { font-size: 24px; }\n  @media (max-width: 768px) {\n    body { font-size: 16px; }\n    h1 { font-size: 28px; }\n    h2 { font-size: 24px; }\n    h3 { font-size: 20px; }\n  }\n}\n\nhtml, body { height: 100%; overflow-x: hidden; }\n\n.container { @apply mx-auto max-w-7xl px-4 sm:px-6 lg:px-8; }\n\n/* Accessible skip link */\n.skip-link {\n  position: absolute;\n  left: 1rem;\n  top: -3rem;\n  background: hsl(var(--background));\n  color: hsl(var(--foreground));\n  border: 1px solid hsl(var(--border));\n  padding: 0.5rem 0.75rem;\n  border-radius: var(--radius-sm);\n  box-shadow: var(--shadow-soft);\n  transition: top 0.15s ease;\n  z-index: 50;\n}\n.skip-link:focus {\n  top: 0.5rem;\n}\n\n/* Utilities for soft-rounded variant */\n.shadow-soft { box-shadow: var(--shadow-soft); }\n.hover\\:shadow-soft:hover { box-shadow: var(--shadow-hover); }\n.rounded-image { border-radius: var(--radius-image); }\n.btn-gradient {\n  background: linear-gradient(90deg, var(--accent-start-hex), var(--accent-end-hex));\n  color: #fff;\n  border-radius: var(--radius-btn);\n}\n\n/* Primary button utility for legacy usages (anchors and buttons) */\n.btn-primary {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  height: 2.75rem; /* ~44px */\n  padding: 0.5rem 1rem;\n  border-radius: var(--radius-btn);\n  background: hsl(var(--primary));\n  color: hsl(var(--primary-foreground));\n  font-weight: 600;\n  line-height: 1;\n  transition: filter 0.15s ease, transform 0.15s ease;\n}\n.btn-primary:hover { filter: brightness(0.95); }\n.btn-primary:active { transform: translateY(0.5px); }\n.btn-primary:disabled,\n.btn-primary[aria-disabled=\"true\"] {\n  opacity: 0.6;\n  pointer-events: none;\n}\n\n","path":null,"size_bytes":5278,"size_tokens":null},"src/app/bestsellers/page.tsx":{"content":"import ProductCard from \"@/components/product-card\"\nimport Breadcrumbs from \"@/components/breadcrumbs\"\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\"\nimport type { Product } from \"@/lib/types\"\n\nexport const metadata = { title: \"Best Sellers\", description: \"Best selling products in the store\" }\nexport const revalidate = 60\nexport const dynamic = \"force-dynamic\"\n\nexport default async function BestsellersPage() {\n  const supabase = getSupabaseAnonServer()\n  let products: any[] | null = null\n  if (!supabase) {\n    products = []\n  } else {\n    try {\n      let { data, error } = await supabase.from(\"products\").select(\"*\").order(\"sales_count\", { ascending: false })\n      if (error && (error as any).code === \"42703\") {\n        const byRating = await supabase.from(\"products\").select(\"*\").order(\"rating\", { ascending: false })\n        data = byRating.data as any\n        error = byRating.error as any\n        if (error && (error as any).code === \"42703\") {\n          const byPrice = await supabase.from(\"products\").select(\"*\").order(\"price\", { ascending: false })\n          data = byPrice.data as any\n        }\n      }\n      products = (data as any[] | null) ?? []\n    } catch {\n      products = []\n    }\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <Breadcrumbs items={[{ name: \"Home\", href: \"/\" }, { name: \"Best Sellers\" }]} />\n      <h1 className=\"text-3xl font-bold\">Best Sellers</h1>\n      <p className=\"mt-2 text-slate-600\">Products customers buy frequently.</p>\n      {products && products.length > 0 ? (\n        <div className=\"mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5\">\n          {products.map((p) => (\n            <ProductCard key={p.id} product={p as Product} />\n          ))}\n        </div>\n      ) : (\n        <div className=\"mt-6 rounded-md border p-6 text-center text-slate-500\">No products available.</div>\n      )}\n    </div>\n  )\n}\n","path":null,"size_bytes":1926,"size_tokens":null},"src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\",\n      className\n    )}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":587,"size_tokens":null},"src/app/account/reviews/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading your reviews...\" />;\n}\n","path":null,"size_bytes":158,"size_tokens":null},"src/app/api/cj/webhook/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport crypto from 'crypto';\nimport { persistCjTracking } from '@/lib/ops/tracking';\nimport { cjWebhookLimiter, getClientIp } from '@/lib/ratelimit';\nimport { loggerForRequest } from '@/lib/log';\n\nexport const runtime = 'nodejs';\n\nfunction verifySignature(raw: string, signature: string | null, secret: string | undefined): boolean {\n  if (!signature || !secret) return false;\n  try {\n    // Expect hex signature; normalize and compare in constant time\n    const expectedHex = crypto.createHmac('sha256', secret).update(raw).digest('hex');\n    const sigHex = signature.trim();\n    const a = Buffer.from(sigHex, 'hex');\n    const b = Buffer.from(expectedHex, 'hex');\n    if (a.length !== b.length) return false;\n    return crypto.timingSafeEqual(a, b);\n  } catch {\n    return false;\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req);\n  // Rate limit by client IP to prevent abuse\n  const ip = getClientIp(req as unknown as Request);\n  const rl = await cjWebhookLimiter.limit(`cj:${ip}`);\n  if (!rl.success) {\n    const r = NextResponse.json({ error: 'Too many requests' }, { status: 429 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const secret = process.env.CJ_WEBHOOK_SECRET;\n  const raw = await req.text();\n  const sig = req.headers.get('x-signature') || req.headers.get('x-cj-signature');\n  const ok = verifySignature(raw, sig, secret);\n\n  // Parse after verification to avoid tampering risks\n  let payload: any = {};\n  try { payload = JSON.parse(raw); } catch {}\n\n  if (!ok) {\n    log.warn('cj_webhook_signature_invalid');\n    if (process.env.NODE_ENV === 'production') {\n      const r = NextResponse.json({ error: 'Invalid signature' }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    // In development, proceed to aid integration testing\n  }\n\n  // Handle events: shipped, tracking assigned, delivered, exception, etc.\n  const event = payload?.event || payload?.type || 'unknown';\n  log.info('cj_webhook_received', { event, orderId: payload?.data?.orderId || payload?.orderId });\n\n  try {\n    const saved = await persistCjTracking(payload);\n    if (!saved.ok) {\n      log.warn('cj_webhook_persist_warn', { reason: saved.reason });\n    }\n  } catch (e: any) {\n    log.warn('cj_webhook_persist_error', { error: e?.message || String(e) });\n  }\n\n  const r = NextResponse.json({ received: true, verified: ok });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":2548,"size_tokens":null},"branding/suppliers/README.md":{"content":"# Supplier Execution Pack — Shopixo\n\nThis folder contains everything to contact, qualify, and onboard suppliers for KSA.\n\nContents:\n- RFI (AR/EN): `rfi-supplier-ar.md`, `rfi-supplier-en.md`\n- Shipping Matrix Request (AR/EN): `shipping-matrix-request-ar.md`, `../ops/shipping/shipping-matrix-request-en.md`\n- Outreach templates (AR/EN): `outreach-ar.txt`, `outreach-en.txt`\n- Supplier Agreement (AR/EN): `supplier-agreement-template-ar.md`, `supplier-agreement-template-en.md`\n- Trial PO templates (AR/EN): `po-trial-order-ar.md`, `po-trial-order-en.md`\n- Supplier Tracker: `supplier-tracker.csv`\n- Blind shipping instructions (AR/EN): `../shipping-instructions-ar.txt`, `../shipping-instructions-en.txt`\n\n7‑Day Plan:\n1) Day 0–1 — Outreach\n- Send RFI + Shipping Matrix Request + Blind Shipping Instructions to: CJdropshipping, HyperSKU, Wiio (China), and 2–3 Turkey agents (via ShipEntegra/OPLOG).\n- Channel: email + WhatsApp/WeChat if available. Use outreach templates.\n\n2) Day 1–2 — Collect & Score\n- Populate `supplier-tracker.csv` with replies.\n- Score on: landed cost (with DDP), transit, QC, blind shipping compliance, integration.\n\n3) Day 2–3 — Trial POs\n- Issue small POs (`po-trial-order-*`) for 5–10 items per line.\n- Require pre-dispatch photos (label shows Shipper: Shopixo + insert).\n\n4) Day 4–5 — Evaluate\n- Check transit time, packaging quality, defects.\n- Confirm returns/RMA and compensation.\n\n5) Day 6–7 — Approve & Integrate\n- Sign Supplier Agreement. Lock rates. Set feeds (CSV/API). Start bulk listing.\n\nNotes:\n- Keep COD as future option; prioritize online payments initially.\n- Avoid regulated SKUs initially (electronics with radio, cosmetics, etc.).\n","path":null,"size_bytes":1702,"size_tokens":null},"src/components/submit-button.tsx":{"content":"\"use client\";\n\nimport React from \"react\";\nimport { useFormStatus } from \"react-dom\";\nimport { cn } from \"@/lib/utils\";\n\ninterface SubmitButtonProps\n  extends Omit<React.ButtonHTMLAttributes<HTMLButtonElement>, \"formAction\"> {\n  label: string;\n  pendingLabel?: string;\n  variant?: \"primary\" | \"secondary\" | \"danger\";\n  // Allow Next.js server actions to be passed through without TS friction\n  formAction?: any;\n}\n\nexport default function SubmitButton({\n  label,\n  pendingLabel = \"Processing...\",\n  variant = \"primary\",\n  className,\n  disabled,\n  type,\n  ...rest\n}: SubmitButtonProps) {\n  const { pending } = useFormStatus();\n\n  const base =\n    \"inline-flex items-center gap-2 justify-center rounded px-4 py-2 text-sm transition focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-60 disabled:cursor-not-allowed\";\n  const variants: Record<string, string> = {\n    primary: \"bg-black text-white hover:bg-gray-800 focus:ring-black\",\n    secondary: \"bg-white text-gray-800 border hover:bg-gray-50 focus:ring-gray-400\",\n    danger: \"bg-white text-red-600 border border-red-200 hover:bg-red-50 focus:ring-red-500\",\n  };\n\n  return (\n    <button\n      type={type || \"submit\"}\n      aria-disabled={pending || disabled}\n      disabled={pending || disabled}\n      className={cn(base, variants[variant] || variants.primary, className)}\n      {...rest}\n    >\n      {pending && (\n        <span\n          className=\"inline-block w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\"\n          aria-hidden=\"true\"\n        />\n      )}\n      {pending ? pendingLabel : label}\n    </button>\n  );\n}\n","path":null,"size_bytes":1620,"size_tokens":null},"src/app/admin/orders/actions.ts":{"content":"\"use server\";\n\nimport { z } from \"zod\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { revalidatePath } from \"next/cache\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function requireAdmin() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) return { allowed: false as const };\n  const adminEmails = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((e) => e.trim().toLowerCase())\n    .filter(Boolean);\n  if (adminEmails.length === 0) {\n    // Default deny in production when unset; allow in development for DX\n    return { allowed: process.env.NODE_ENV !== \"production\" } as const;\n  }\n  const email = (user.email || \"\").toLowerCase();\n  return { allowed: !!email && adminEmails.includes(email) } as const;\n}\n\nconst statusEnum = z.enum([\"pending\", \"processing\", \"shipped\", \"delivered\", \"cancelled\", \"paid\"]);\n\nconst updateSchema = z.object({\n  id: z.coerce.number(),\n  status: statusEnum,\n});\n\nexport type UpdateOrderState = { error?: string | null; success?: boolean };\n\nexport async function updateOrderStatus(prev: UpdateOrderState, formData: FormData): Promise<UpdateOrderState> {\n  const admin = await requireAdmin();\n  if (!admin.allowed) return { error: \"Not authorized\" };\n  const client = getSupabaseAdmin();\n  if (!client) return { error: \"Server misconfiguration\" };\n\n  const parse = updateSchema.safeParse({ id: formData.get(\"id\"), status: formData.get(\"status\") });\n  if (!parse.success) return { error: \"Invalid input\" };\n  const { id, status } = parse.data;\n\n  const { error } = await client.from(\"orders\").update({ status }).eq(\"id\", id);\n  if (error) {\n    console.error(\"updateOrderStatus error\", error);\n    return { error: \"Database error\" };\n  }\n  revalidatePath(\"/admin/orders\");\n  return { success: true };\n}\n","path":null,"size_bytes":2126,"size_tokens":null},"src/app/admin/cj/finder/page.tsx":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\n\ntype StartResp = { ok: boolean; jobId?: number; error?: string; tablesMissing?: boolean };\n\ntype RunResp = { ok: boolean; done?: boolean; stepsRun?: number; candidatesAddedTotal?: number; error?: string };\n\ntype JobItem = {\n  id: number;\n  status: string;\n  step: string | null;\n  result: any;\n};\n\ntype JobResp = { ok: boolean; job?: any; items?: JobItem[]; error?: string };\n\ntype CommitResp = { ok: boolean; results?: any[]; error?: string };\n\nexport default function CjFinderPage() {\n  const [keywords, setKeywords] = useState(\"men shirts\");\n  const [targetQuantity, setTargetQuantity] = useState(50);\n  const [pageSize, setPageSize] = useState(20);\n  const [maxPages, setMaxPages] = useState(5);\n  const [margin, setMargin] = useState(0.35);\n  const [handling, setHandling] = useState(0);\n  const [currency, setCurrency] = useState<'USD'|'SAR'>('USD');\n\n  const [jobId, setJobId] = useState<number | null>(null);\n  const [items, setItems] = useState<JobItem[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [tablesMissing, setTablesMissing] = useState(false);\n  const [loading, setLoading] = useState(false);\n  const [category, setCategory] = useState(\"General\");\n\n  const [selected, setSelected] = useState<Record<string, { includeSkus?: Record<string, boolean> }>>({});\n  const [committing, setCommitting] = useState(false);\n  const [commitResult, setCommitResult] = useState<any[] | null>(null);\n\n  async function start() {\n    setLoading(true); setError(null); setCommitResult(null); setTablesMissing(false);\n    try {\n      const r = await fetch('/api/admin/cj/finder/start', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          keywords,\n          targetQuantity,\n          pageSize,\n          maxPagesPerKeyword: maxPages,\n          margin,\n          handlingSar: handling,\n          cjCurrency: currency,\n        }),\n      });\n      const j: StartResp = await r.json();\n      if (j.tablesMissing) {\n        setTablesMissing(true);\n        setError(j.error || 'Database tables missing');\n        return;\n      }\n      if (!r.ok || !j.ok || !j.jobId) throw new Error(j.error || `HTTP ${r.status}`);\n      setJobId(j.jobId);\n      // run to completion\n      const rr = await fetch(`/api/admin/jobs/${j.jobId}/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode: 'all' }) });\n      const jj: RunResp = await rr.json();\n      if (!rr.ok || !jj.ok) throw new Error(jj.error || `HTTP ${rr.status}`);\n      await refresh(j.jobId);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to start');\n    } finally { setLoading(false); }\n  }\n\n  async function refresh(id?: number | null) {\n    const jid = id ?? jobId;\n    if (!jid) return;\n    const r = await fetch(`/api/admin/jobs/${jid}`, { cache: 'no-store' });\n    const j: JobResp = await r.json();\n    if (!r.ok || !j.ok) { setError(j.error || `HTTP ${r.status}`); return; }\n    setItems(j.items || []);\n  }\n\n  function toggleSelect(pid: string) {\n    setSelected((s) => ({ ...s, [pid]: s[pid] ? undefined as any : {} }));\n  }\n\n  function toggleSku(pid: string, sku: string) {\n    setSelected((s) => {\n      const cur = s[pid] || { includeSkus: {} };\n      const next = { includeSkus: { ...(cur.includeSkus || {}) } } as { includeSkus?: Record<string, boolean> };\n      next.includeSkus![sku] = !next.includeSkus?.[sku];\n      return { ...s, [pid]: next };\n    });\n  }\n\n  async function commitImport() {\n    if (!jobId) return;\n    setCommitting(true); setError(null); setCommitResult(null);\n    try {\n      // Build selected list from job items\n      const chosen: Array<{ cj_product_id: string; includeSkus?: string[]; category: string; margin: number; handlingSar: number; cjCurrency: 'USD'|'SAR' }> = [];\n      for (const it of items) {\n        if (it.step !== 'candidate') continue;\n        const pid = String(it?.result?.product?.cj_product_id || '')\n        if (!pid) continue;\n        if (!selected[pid]) continue;\n        const allSkus = Array.isArray(it?.result?.variants) ? it.result.variants.map((v: any) => v?.cj_sku).filter((x: any) => !!x) : [];\n        const includesMap = selected[pid]?.includeSkus || {};\n        const includeSkus = Object.keys(includesMap).filter(k => includesMap[k]);\n        chosen.push({ cj_product_id: pid, includeSkus: includeSkus.length > 0 ? includeSkus : allSkus, category, margin, handlingSar: handling, cjCurrency: currency });\n      }\n      if (chosen.length === 0) throw new Error('Select at least one product');\n      const r = await fetch('/api/admin/cj/import/commit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ selected: chosen }) });\n      const j: CommitResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setCommitResult(j.results || []);\n    } catch (e: any) {\n      setError(e?.message || 'Commit failed');\n    } finally { setCommitting(false); }\n  }\n\n  const candidateItems = items.filter(it => it.step === 'candidate');\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Catalog Finder</h1>\n        <Link href=\"/admin/console\" className=\"text-sm text-blue-600 hover:underline\">Back to Console</Link>\n      </div>\n\n      {tablesMissing && (\n        <div className=\"rounded-lg border-2 border-amber-300 bg-amber-50 p-6\">\n          <h2 className=\"text-lg font-semibold text-amber-800 mb-3\">Database Setup Required</h2>\n          <p className=\"text-amber-700 mb-4\">\n            The required database tables do not exist. Please run the migrations in your Supabase SQL Editor.\n          </p>\n          <div className=\"bg-white rounded border p-4 text-sm\">\n            <p className=\"font-medium mb-2\">Required tables:</p>\n            <ul className=\"list-disc pl-5 text-gray-700 space-y-1\">\n              <li><code className=\"bg-slate-100 px-1\">admin_jobs</code> - For background job tracking</li>\n              <li><code className=\"bg-slate-100 px-1\">admin_job_items</code> - For job item details</li>\n              <li><code className=\"bg-slate-100 px-1\">kv_settings</code> - For supplier settings</li>\n            </ul>\n            <p className=\"mt-3 text-gray-600\">Go to Background Jobs page for the full SQL migration script.</p>\n          </div>\n        </div>\n      )}\n\n      {error && !tablesMissing && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <section className=\"rounded border bg-white p-4 space-y-3\">\n        <div className=\"grid grid-cols-1 md:grid-cols-3 gap-3\">\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Keywords (comma or space separated)</div>\n            <input className=\"w-full rounded border px-2 py-1\" value={keywords} onChange={e => setKeywords(e.target.value)} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Target Quantity</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={targetQuantity} onChange={e => setTargetQuantity(Math.max(1, Number(e.target.value||1)))} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Category for import</div>\n            <input className=\"w-full rounded border px-2 py-1\" value={category} onChange={e => setCategory(e.target.value)} />\n          </label>\n        </div>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-3\">\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Page size</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={pageSize} onChange={e => setPageSize(Math.max(1, Math.min(50, Number(e.target.value||20))))} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Max pages/keyword</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={maxPages} onChange={e => setMaxPages(Math.max(1, Math.min(40, Number(e.target.value||5))))} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Margin</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" step=\"0.01\" value={margin} onChange={e => setMargin(Math.max(0, Number(e.target.value||0)))} />\n          </label>\n          <label className=\"text-sm\">\n            <div className=\"text-gray-600 mb-1\">Handling SAR</div>\n            <input type=\"number\" className=\"w-full rounded border px-2 py-1\" value={handling} onChange={e => setHandling(Math.max(0, Number(e.target.value||0)))} />\n          </label>\n        </div>\n        <div className=\"flex items-center gap-4\">\n          <label className=\"text-sm inline-flex items-center gap-2\">\n            <input type=\"radio\" name=\"cur\" checked={currency==='USD'} onChange={() => setCurrency('USD')} /> USD\n          </label>\n          <label className=\"text-sm inline-flex items-center gap-2\">\n            <input type=\"radio\" name=\"cur\" checked={currency==='SAR'} onChange={() => setCurrency('SAR')} /> SAR\n          </label>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <button onClick={start} disabled={loading} className=\"rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700\">Start Search</button>\n          {jobId && <button onClick={() => refresh(jobId)} disabled={loading} className=\"rounded bg-gray-600 px-3 py-1.5 text-white hover:bg-gray-700\">Refresh</button>}\n          {jobId && <Link href={`/admin/jobs/${jobId}`} className=\"text-sm text-blue-600 hover:underline\">Open Job</Link>}\n        </div>\n      </section>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-3\">Candidates</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n          {candidateItems.map((it) => {\n            const p = it.result?.product || {};\n            const pid = String(p.cj_product_id || '');\n            const vs: any[] = Array.isArray(it.result?.variants) ? it.result.variants : [];\n            const images: string[] = Array.isArray(p.images) ? p.images : [];\n            const sel = !!selected[pid];\n            return (\n              <div key={it.id} className={`rounded border ${sel? 'border-blue-400' : 'border-gray-200'} p-3 space-y-2`}>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"font-medium\">{p.name || pid}</div>\n                  <label className=\"inline-flex items-center gap-2 text-sm\">\n                    <input type=\"checkbox\" checked={sel} onChange={() => toggleSelect(pid)} /> Select\n                  </label>\n                </div>\n                {images[0] && (\n                  <img src={images[0]} alt={p.name||pid} className=\"w-full h-40 object-cover rounded\" />\n                )}\n                <div className=\"text-xs text-gray-600\">\n                  <div>PID: <span className=\"font-mono\">{pid}</span></div>\n                  <div>Stock sum: {it.result?.metrics?.stock_sum ?? '-'}</div>\n                  <div>Min retail sans ship: {typeof it.result?.metrics?.min_retail_sans_ship === 'number' ? it.result.metrics.min_retail_sans_ship.toFixed(2) : '-'}</div>\n                </div>\n                {sel && (\n                  <div className=\"rounded border bg-muted/20 overflow-auto\">\n                    <table className=\"min-w-full text-xs\">\n                      <thead>\n                        <tr className=\"bg-muted\">\n                          <th className=\"p-1 text-left\">Size</th>\n                          <th className=\"p-1 text-left\">Color</th>\n                          <th className=\"p-1 text-left\">CJ SKU</th>\n                          <th className=\"p-1 text-left\">Retail</th>\n                          <th className=\"p-1 text-left\">Stock</th>\n                          <th className=\"p-1 text-left\">Pick</th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        {vs.map((v, idx) => (\n                          <tr key={idx} className=\"border-t\">\n                            <td className=\"p-1\">{v.size || '-'}</td>\n                            <td className=\"p-1\">{v.color || '-'}</td>\n                            <td className=\"p-1 font-mono text-[11px]\">{v.cj_sku || '-'}</td>\n                            <td className=\"p-1\">{typeof v.retail_sar === 'number' ? v.retail_sar.toFixed(2) : '-'}</td>\n                            <td className=\"p-1\">{v.stock ?? 0}</td>\n                            <td className=\"p-1\">\n                              {v.cj_sku ? (\n                                <input type=\"checkbox\" onChange={() => toggleSku(pid, v.cj_sku)} checked={!!selected[pid]?.includeSkus?.[v.cj_sku]} />\n                              ) : null}\n                            </td>\n                          </tr>\n                        ))}\n                      </tbody>\n                    </table>\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n        <div className=\"mt-4\">\n          <button onClick={commitImport} disabled={committing || candidateItems.length===0} className=\"rounded bg-green-600 px-3 py-1.5 text-white hover:bg-green-700\">Commit Import</button>\n        </div>\n        {commitResult && (\n          <div className=\"mt-3 rounded border bg-emerald-50 border-emerald-200 p-3 text-sm\">\n            <div className=\"font-medium mb-1\">Import Results</div>\n            <pre className=\"whitespace-pre-wrap break-words text-xs\">{JSON.stringify(commitResult, null, 2)}</pre>\n          </div>\n        )}\n      </section>\n\n      {loading && <div className=\"text-sm text-gray-500\">Working…</div>}\n    </div>\n  );\n}\n","path":null,"size_bytes":13983,"size_tokens":null},"src/lib/shipping/ksa-ddp-matrix.ts":{"content":"export type DdpTier = {\n  maxKg: number;      // inclusive upper bound of the weight tier (kg)\n  priceSAR: number;   // all-in DDP price in SAR for a parcel within this tier\n};\n\n// NOTE: These are placeholder defaults and MUST be overridden with your real KSA DDP matrix\n// from the carrier/CJ. You can override at runtime via KSA_DDP_MATRIX_JSON or replace this file.\nexport const DEFAULT_KSA_DDP_MATRIX: DdpTier[] = [\n  { maxKg: 0.5, priceSAR: 25 },\n  { maxKg: 1.0, priceSAR: 35 },\n  { maxKg: 1.5, priceSAR: 45 },\n  { maxKg: 2.0, priceSAR: 55 },\n  { maxKg: 3.0, priceSAR: 75 },\n  { maxKg: 5.0, priceSAR: 110 },\n];\n","path":null,"size_bytes":616,"size_tokens":null},"src/components/pro/Newsletter.tsx":{"content":"\"use client\"\n\nimport { useState, useTransition } from \"react\"\n\nexport default function Newsletter() {\n  const [email, setEmail] = useState(\"\")\n  const [msg, setMsg] = useState<string>(\"\")\n  const [err, setErr] = useState<string>(\"\")\n  const [pending, startTransition] = useTransition()\n\n  function onSubmit(e: React.FormEvent) {\n    e.preventDefault(); setMsg(\"\"); setErr(\"\")\n    if (!email) { setErr(\"Please enter your email address\"); return }\n    startTransition(async () => {\n      try {\n        const res = await fetch(\"/api/newsletter/subscribe\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ email }),\n        })\n        if (!res.ok) throw new Error(\"Subscription failed\")\n        setMsg(\"Successfully subscribed. Thank you!\")\n        setEmail(\"\")\n      } catch (e: any) {\n        setErr(e?.message || \"Unable to subscribe at this time\")\n      }\n    })\n  }\n\n  return (\n    <section className=\"py-10\" aria-label=\"Newsletter\">\n      <div className=\"container rounded-[var(--radius-lg)] border bg-card p-6 shadow-soft\">\n        <h2 className=\"mb-2 text-2xl font-bold\">Subscribe to our Newsletter</h2>\n        <p className=\"mb-4 text-sm text-muted-foreground\">Be the first to know about new products and exclusive deals. Just enter your email.</p>\n        <form onSubmit={onSubmit} className=\"flex flex-col items-stretch gap-3 sm:flex-row\">\n          <input\n            type=\"email\"\n            required\n            placeholder=\"example@email.com\"\n            value={email}\n            onChange={(e) => setEmail(e.target.value)}\n            className=\"h-12 flex-1 rounded-[var(--radius-sm)] border px-4\"\n          />\n          <button disabled={pending} className=\"h-12 rounded-[var(--radius-btn)] bg-[hsl(var(--primary))] px-6 text-white hover:brightness-95\">\n            Subscribe\n          </button>\n        </form>\n        {(msg || err) && (\n          <div className=\"mt-3 text-sm\">\n            {msg && <div className=\"text-green-700\">{msg}</div>}\n            {err && <div className=\"text-red-600\">{err}</div>}\n          </div>\n        )}\n      </div>\n    </section>\n  )\n}\n","path":null,"size_bytes":2154,"size_tokens":null},"src/app/sign-in/page.tsx":{"content":"import { redirect } from \"next/navigation\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default function SignInPage({\n  searchParams,\n}: {\n  searchParams?: Record<string, string | string[] | undefined>;\n}) {\n  const params = new URLSearchParams();\n  for (const [k, v] of Object.entries(searchParams || {})) {\n    if (Array.isArray(v)) v.forEach((val) => params.append(k, val));\n    else if (v != null) params.set(k, v);\n  }\n  redirect(`/login${params.toString() ? `?${params.toString()}` : \"\"}`);\n}\n","path":null,"size_bytes":533,"size_tokens":null},"scripts/cj/import-one.ts":{"content":"/*\n  One-off importer to add a single product from CJ into Supabase.\n  Usage examples:\n    node -r ts-node/register/transpile-only -r tsconfig-paths/register scripts/cj/import-one.ts --keyword \"women dress\"\n    node -r ts-node/register/transpile-only -r tsconfig-paths/register scripts/cj/import-one.ts --pid <CJ_PID>\n\n  Required env:\n    NEXT_PUBLIC_SUPABASE_URL\n    SUPABASE_SERVICE_ROLE_KEY\n    CJ_API_BASE (optional)\n    CJ_ACCESS_TOKEN or (CJ_EMAIL + CJ_API_KEY)\n*/\n\nimport { createClient } from '@supabase/supabase-js'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from '../../src/lib/cj/v2'\nimport { upsertProductFromCj, persistRawCj } from '../../src/lib/ops/cj-sync'\n\nfunction getArg(name: string): string | undefined {\n  const idx = process.argv.findIndex(a => a === `--${name}`)\n  if (idx >= 0) return process.argv[idx + 1]\n  const pref = `--${name}=`\n  const found = process.argv.find(a => a.startsWith(pref))\n  if (found) return found.slice(pref.length)\n  return undefined\n}\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY')\n  return createClient(url, key)\n}\n\nasync function main() {\n  const pid = getArg('pid')\n  const keyword = getArg('keyword') || (pid ? undefined : 'women dress')\n  const admin = getSupabaseAdmin()\n\n  console.log('Importing one product from CJ...', { pid, keyword })\n\n  const raw = await queryProductByPidOrKeyword({ pid: pid || undefined, keyword })\n  const list: any[] = Array.isArray(raw?.data?.content)\n    ? raw.data.content\n    : Array.isArray(raw?.data?.list)\n      ? raw.data.list\n      : Array.isArray(raw?.content)\n        ? raw.content\n        : Array.isArray(raw?.data)\n          ? raw.data\n          : []\n\n  if (!list || list.length === 0) {\n    throw new Error('No CJ items found for provided pid/keyword')\n  }\n\n  const itemRaw = list[0]\n  const mapped = mapCjItemToProductLike(itemRaw)\n  if (!mapped) throw new Error('Mapping failed for selected CJ item')\n\n  const up = await upsertProductFromCj(mapped, { updateImages: true, updateVideo: true, updatePrice: true })\n  if (!('ok' in up) || !up.ok) throw new Error((up as any).error || 'Upsert failed')\n\n  try { await persistRawCj(up.productId, itemRaw) } catch {}\n\n  let slug: string | undefined\n  try {\n    const { data } = await admin.from('products').select('slug').eq('id', up.productId).maybeSingle()\n    slug = data?.slug || undefined\n  } catch {}\n\n  console.log('Import complete', { productId: up.productId, slug, updated: up.updated })\n  if (slug) {\n    console.log(`PDP URL: /product/${slug}`)\n  }\n}\n\nmain().catch((e) => {\n  console.error('Import failed:', e?.message || e)\n  process.exitCode = 1\n})\n","path":null,"size_bytes":2809,"size_tokens":null},"src/components/categories-menu.tsx":{"content":"\"use client\";\n\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport Link from \"next/link\";\nimport Image from \"next/image\";\nimport { Menu, X } from \"lucide-react\";\nimport { FULL_CATEGORIES, type FullCategory, type FullCategoryChild } from \"@/lib/categories\";\n\nexport default function CategoriesMenu() {\n  const [open, setOpen] = useState(false);\n  const panelRef = useRef<HTMLDivElement>(null);\n  const [active, setActive] = useState(0);\n  const [query, setQuery] = useState(\"\");\n\n  useEffect(() => {\n    function onKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") setOpen(false);\n    }\n    if (open) document.addEventListener(\"keydown\", onKey);\n    return () => document.removeEventListener(\"keydown\", onKey);\n  }, [open]);\n\n  useEffect(() => {\n    if (!open) return;\n    const onClick = (e: MouseEvent) => {\n      if (panelRef.current && !panelRef.current.contains(e.target as Node)) {\n        setOpen(false);\n      }\n    };\n    document.addEventListener(\"mousedown\", onClick);\n    return () => document.removeEventListener(\"mousedown\", onClick);\n  }, [open]);\n\n  const normalized = (s: string) => (s || \"\").toLowerCase().trim();\n  const filteredCats: FullCategory[] = useMemo(() => {\n    if (!query) return FULL_CATEGORIES;\n    const q = normalized(query);\n    return FULL_CATEGORIES.map((c) => {\n      const children = (c.children || []).filter((ch) => normalized(ch.label).includes(q));\n      const matchSelf = normalized(c.label).includes(q);\n      if (matchSelf || children.length) return { ...c, children };\n      return null as any;\n    }).filter((x): x is FullCategory => Boolean(x));\n  }, [query]);\n\n  const safeActiveIndex = Math.min(active, Math.max(0, filteredCats.length - 1));\n  const activeCat = filteredCats[safeActiveIndex];\n\n  return (\n    <div className=\"relative\" dir=\"ltr\">\n      <button\n        type=\"button\"\n        aria-label=\"Open menu\"\n        className=\"inline-flex items-center rounded-md border p-2 text-sm hover:bg-muted\"\n        onClick={() => setOpen(true)}\n      >\n        <Menu className=\"h-5 w-5\" />\n      </button>\n\n      {open && (\n        <div className=\"fixed inset-0 z-50\">\n          <div className=\"absolute inset-0 bg-black/40\" />\n          <div\n            ref={panelRef}\n            className=\"absolute inset-x-0 top-0 mx-auto h-[88vh] w-full max-w-6xl overflow-hidden rounded-b-2xl border bg-background shadow-xl md:top-8 md:h-[80vh] md:rounded-2xl overscroll-contain flex flex-col touch-pan-y\"\n          >\n            <div className=\"flex items-center justify-between gap-3 border-b p-3 md:p-4\">\n              <div className=\"flex-1\">\n                <div className=\"text-base font-semibold mb-2\">All Categories</div>\n                <label className=\"sr-only\" htmlFor=\"cat-search\">Search</label>\n                <input\n                  id=\"cat-search\"\n                  value={query}\n                  onChange={(e) => { setQuery(e.target.value); setActive(0); }}\n                  placeholder=\"Search categories...\"\n                  className=\"w-full rounded-md border px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-primary\"\n                  dir=\"ltr\"\n                />\n              </div>\n              <button aria-label=\"Close\" className=\"self-start rounded-md p-2 hover:bg-muted\" onClick={() => setOpen(false)}>\n                <X className=\"h-5 w-5\" />\n              </button>\n            </div>\n\n            {/* Desktop layout: left rail + right content */}\n            <div className=\"hidden md:grid flex-1 min-h-0 grid-cols-[240px_1fr] overflow-hidden\">\n              <aside className=\"border-l overflow-auto p-3 min-h-0\">\n                <ul className=\"space-y-1 text-sm\">\n                  {filteredCats.map((c: FullCategory, idx) => (\n                    <li key={c.slug}>\n                      <button\n                        className={`flex w-full items-center justify-between rounded-md px-3 py-2 text-right hover:bg-muted ${idx===safeActiveIndex ? 'bg-muted font-medium' : ''}`}\n                        onClick={() => setActive(idx)}\n                        aria-current={idx===safeActiveIndex}\n                      >\n                        <span className=\"truncate\">{c.label}</span>\n                      </button>\n                    </li>\n                  ))}\n                </ul>\n              </aside>\n              <section className=\"overflow-auto p-4 min-h-0\">\n                <div className=\"mb-3 flex items-center justify-between gap-3\">\n                  <h3 className=\"text-lg font-semibold\">{activeCat?.label}</h3>\n                  {activeCat && (\n                    <Link href={`/category/${activeCat.slug}`} className=\"text-sm text-primary hover:underline\" onClick={() => setOpen(false)}>View All</Link>\n                  )}\n                </div>\n                {/* Children grid: circular thumbnails like Shein */}\n                <div className=\"grid grid-cols-2 gap-4 lg:grid-cols-3 xl:grid-cols-4\">\n                  {activeCat?.children?.length ? (\n                    activeCat.children.map((child: FullCategoryChild) => (\n                      <Link\n                        key={child.slug}\n                        href={`/search?category=${encodeURIComponent(activeCat.slug)}&q=${encodeURIComponent(child.label)}`}\n                        className=\"group flex flex-col items-center gap-2 rounded-xl border bg-card p-3 text-center shadow-soft transition hover:-translate-y-[2px] hover:shadow\"\n                        onClick={() => setOpen(false)}\n                      >\n                        <div className=\"relative aspect-square w-24 overflow-hidden rounded-full bg-muted ring-1 ring-muted-foreground/10 sm:w-28\">\n                          <CategoryThumb parentSlug={activeCat.slug} child={child} />\n                        </div>\n                        <div className=\"text-xs sm:text-sm font-medium leading-tight\">{child.label}</div>\n                      </Link>\n                    ))\n                  ) : (\n                    <div className=\"text-sm text-muted-foreground\">No subcategories available.</div>\n                  )}\n                </div>\n              </section>\n            </div>\n\n            {/* Mobile layout: stacked cards + children chips */}\n            <div className=\"block max-h-[calc(88vh-56px)] overflow-auto p-4 md:hidden\">\n              <div className=\"grid grid-cols-2 gap-3\">\n                {filteredCats.map((c: FullCategory) => (\n                  <div key={c.slug} className=\"overflow-hidden rounded-xl border bg-card shadow-soft\">\n                    <Link\n                      href={`/category/${c.slug}`}\n                      className=\"group block\"\n                      onClick={() => setOpen(false)}\n                    >\n                      <div className=\"relative aspect-[4/3] w-full overflow-hidden bg-muted\">\n                        <Image\n                          src={c.image || \"/placeholder.svg\"}\n                          alt={c.label}\n                          fill\n                          sizes=\"(max-width: 768px) 50vw, (max-width: 1200px) 33vw, 25vw\"\n                          className=\"object-cover transition-transform duration-300 group-hover:scale-[1.03]\"\n                          priority={false}\n                        />\n                      </div>\n                      <div className=\"p-3 text-center text-sm font-medium\">{c.label}</div>\n                    </Link>\n                    {c.children && c.children.length > 0 && (\n                      <div className=\"-mt-2 flex overflow-x-auto gap-3 px-3 pb-3\">\n                        {c.children.slice(0, 10).map((child: FullCategoryChild) => (\n                          <Link\n                            key={child.slug}\n                            href={`/search?category=${encodeURIComponent(c.slug)}&q=${encodeURIComponent(child.label)}`}\n                            className=\"shrink-0 flex flex-col items-center gap-1\"\n                            onClick={() => setOpen(false)}\n                          >\n                            <div className=\"relative h-16 w-16 overflow-hidden rounded-full bg-muted ring-1 ring-muted-foreground/10\">\n                              <CategoryThumb parentSlug={c.slug} child={child} />\n                            </div>\n                            <span className=\"text-[11px] leading-tight\">{child.label}</span>\n                          </Link>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\n// --- Helpers ---\nfunction getCloudinaryUrl(parentSlug: string, childSlug: string, ext: 'jpg' | 'png' = 'jpg') {\n  const cloud = process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME || 'dkwh8kbgr';\n  if (!cloud) return null;\n  // Ex: categories/women/women-jeans.jpg\n  const path = `categories/${parentSlug}/${childSlug}.${ext}`;\n  return `https://res.cloudinary.com/${cloud}/image/upload/f_auto,q_auto,c_fill,g_auto,w_560,h_560/${path}`;\n}\n\nfunction dataUriFromLabel(label: string) {\n  const text = encodeURIComponent(label || \"\");\n  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='560' height='560'>\n    <defs>\n      <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>\n        <stop offset='0%' stop-color='#e2e8f0'/>\n        <stop offset='100%' stop-color='#cbd5e1'/>\n      </linearGradient>\n    </defs>\n    <rect width='100%' height='100%' fill='url(#g)'/>\n    <circle cx='280' cy='280' r='260' fill='white' />\n    <text x='50%' y='52%' dominant-baseline='middle' text-anchor='middle'\n      font-family='sans-serif' font-size='44' fill='#0f172a'>${text}</text>\n  </svg>`;\n  return `data:image/svg+xml;utf8,${svg}`;\n}\n\nfunction buildSrcQueue(parentSlug: string, child: FullCategoryChild): string[] {\n  const set = new Set<string>();\n  // 1) Always use client's provided image first if present\n  if (child.image) set.add(child.image);\n  // 2) Then Cloudinary convention (client can upload any time)\n  const cj = getCloudinaryUrl(parentSlug, child.slug, 'jpg');\n  const cp = getCloudinaryUrl(parentSlug, child.slug, 'png');\n  if (cj) set.add(cj);\n  if (cp) set.add(cp);\n  // 3) Local convention under public/categories\n  set.add(`/categories/${parentSlug}/${child.slug}.jpg`);\n  set.add(`/categories/${parentSlug}/${child.slug}.png`);\n  // 4) Generic child slug at root\n  set.add(`/categories/${child.slug}.jpg`);\n  set.add(`/categories/${child.slug}.png`);\n  // 5) Fallback placeholder (will be replaced by data URI on final error)\n  set.add(`/placeholder.svg`);\n  return Array.from(set);\n}\n\nfunction CategoryThumb({ parentSlug, child }: { parentSlug: string; child: FullCategoryChild }) {\n  const [index, setIndex] = useState(0);\n  const srcs = useMemo(() => buildSrcQueue(parentSlug, child), [parentSlug, child.slug, child.image]);\n  const src = index < srcs.length ? srcs[index] : dataUriFromLabel(child.label);\n  const isData = src.startsWith('data:');\n  return (\n    <Image\n      src={src}\n      alt={child.label}\n      fill\n      sizes=\"(max-width: 768px) 6rem, (max-width: 1200px) 7rem, 7rem\"\n      className=\"object-cover\"\n      priority={false}\n      unoptimized={isData}\n      onError={() => setIndex((i) => i + 1)}\n    />\n  );\n}\n","path":null,"size_bytes":11233,"size_tokens":null},"src/lib/integration/token-store.ts":{"content":"import { createClient } from '@supabase/supabase-js';\nimport { hasTable } from '@/lib/db-features';\n\nexport type ProviderKey = 'cj';\n\nexport type TokenStateRow = {\n  provider: string;\n  access_token: string | null;\n  access_expiry: string | null;\n  refresh_token: string | null;\n  refresh_expiry: string | null;\n  last_auth_call_at: string | null;\n  updated_at?: string | null;\n};\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nexport async function loadToken(provider: ProviderKey): Promise<TokenStateRow | null> {\n  const admin = getSupabaseAdmin();\n  if (!admin) return null;\n  if (!(await hasTable('integration_tokens'))) return null;\n  try {\n    const { data } = await admin\n      .from('integration_tokens')\n      .select('provider, access_token, access_expiry, refresh_token, refresh_expiry, last_auth_call_at, updated_at')\n      .eq('provider', provider)\n      .maybeSingle();\n    return (data as TokenStateRow) || null;\n  } catch {\n    return null;\n  }\n}\n\nexport async function saveToken(provider: ProviderKey, row: Partial<TokenStateRow>): Promise<void> {\n  const admin = getSupabaseAdmin();\n  if (!admin) return;\n  if (!(await hasTable('integration_tokens'))) return;\n  try {\n    const payload: TokenStateRow = {\n      provider,\n      access_token: row.access_token ?? null,\n      access_expiry: row.access_expiry ?? null,\n      refresh_token: row.refresh_token ?? null,\n      refresh_expiry: row.refresh_expiry ?? null,\n      last_auth_call_at: row.last_auth_call_at ?? new Date().toISOString(),\n      updated_at: new Date().toISOString(),\n    };\n    await admin.from('integration_tokens').upsert(payload, { onConflict: 'provider' });\n  } catch {\n    // ignore\n  }\n}\n","path":null,"size_bytes":1837,"size_tokens":null},"src/app/account/security/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { updatePassword } from \"@/lib/security-actions\";\nimport PasswordForm from \"@/components/account/password-form\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function SecurityPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/security\");\n\n  return (\n    <div className=\"max-w-3xl mx-auto py-12 px-4\">\n      <h1 className=\"text-2xl font-bold mb-6\">Account Security</h1>\n\n      <div className=\"rounded-lg border bg-white p-6\">\n        <h2 className=\"text-lg font-semibold mb-3\">Change Password</h2>\n        <PasswordForm action={updatePassword} />\n        <p className=\"mt-3 text-xs text-gray-500\">After changing your password, you may be asked to sign in again on other devices.</p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1055,"size_tokens":null},"src/app/sign-up/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport AuthForm from \"@/app/login/auth-form\";\n\nexport const metadata = { title: \"Sign In or Create Account\" };\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function SignUpPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data } = await supabase.auth.getSession();\n\n  if (data?.session) {\n    redirect(\"/\");\n  }\n\n  return (\n    <div className=\"container flex min-h-[70vh] w-full flex-col items-center justify-center py-12\">\n      <div className=\"w-full max-w-md rounded-xl border bg-white p-8 shadow-sm\">\n        <AuthForm />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":794,"size_tokens":null},"src/app/admin/products/import/page.tsx":{"content":"\"use client\";\n\nimport React, { useState } from 'react';\n\nfunction parseCsv(text: string) {\n  const rows = text.trim().split(/\\r?\\n/);\n  const header = rows.shift()?.split(',') || [];\n  const out: any[] = [];\n  for (const line of rows) {\n    if (!line.trim()) continue;\n    const cols = line.split(',');\n    const obj: any = {};\n    header.forEach((h, i) => { obj[h.trim()] = (cols[i] || '').trim(); });\n    out.push(obj);\n  }\n  return out;\n}\n\nexport default function ImportProductsPage() {\n  const [csv, setCsv] = useState(\"\");\n  const [items, setItems] = useState<any[]>([]);\n  const [serverPreview, setServerPreview] = useState<any | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [log, setLog] = useState<string>(\"\");\n  const [draftOnAnomalies, setDraftOnAnomalies] = useState(true);\n  // CJ tab state\n  const [cjKeyword, setCjKeyword] = useState(\"\");\n  const [cjPid, setCjPid] = useState(\"\");\n  const [cjUrl, setCjUrl] = useState(\"\");\n  const [cjLoading, setCjLoading] = useState(false);\n  const [cjResults, setCjResults] = useState<any[] | null>(null);\n  const [cjMessage, setCjMessage] = useState<string>(\"\");\n\n  function mapRowsToPayload(rows: any[]) {\n    return rows.map((r) => ({\n      name: r.Name || r.title || r.TITLE || 'Untitled',\n      supplierCost: Number(r.UnitCost || r.supplierCost || 0),\n      currency: (r.UnitCostCurrency || 'SAR').toUpperCase(),\n      lengthCm: Number(r.PackLengthCM || r.length || 25),\n      widthCm: Number(r.PackWidthCM || r.width || 20),\n      heightCm: Number(r.PackHeightCM || r.height || 3),\n      weightKg: Number(r.GrossWeightKG || r.weight || 0.4),\n      imagesCsv: r.Images || r.images || '',\n      videoUrl: r.VideoUrl || r.videoUrl || r.VIDEO || r.video || '',\n      category: r.Category || r.category || 'General',\n      stock: Number(r.Stock || r.stock || 100),\n    }));\n  }\n\n  async function handlePreview() {\n    const rows = parseCsv(csv);\n    const payload = mapRowsToPayload(rows);\n    setItems(payload);\n    setServerPreview(null);\n  }\n\n  async function handleServerPreview() {\n    try {\n      setLoading(true);\n      setLog('');\n      const res = await fetch('/api/admin/import-products', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ items, preview: true, draftOnAnomalies }),\n      });\n      const data = await res.json();\n      if (!res.ok) throw new Error(data?.error || res.statusText);\n      setServerPreview(data);\n    } catch (e: any) {\n      setLog(String(e?.message || e));\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function handleImport() {\n    try {\n      setLoading(true);\n      setLog('');\n      const res = await fetch('/api/admin/import-products', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ items, draftOnAnomalies }),\n      });\n      const data = await res.json();\n      setLog(JSON.stringify(data, null, 2));\n      if (res.ok) setServerPreview(null);\n    } catch (e: any) {\n      setLog(String(e?.message || e));\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  // --- CJ Tab handlers ---\n  async function handleCjSearch() {\n    try {\n      setCjLoading(true);\n      setCjMessage('');\n      setCjResults(null);\n      const url = new URL('/api/admin/cj/products/query', window.location.origin);\n      if (cjPid.trim()) url.searchParams.set('pid', cjPid.trim());\n      if (cjKeyword.trim()) url.searchParams.set('keyword', cjKeyword.trim());\n      if (cjUrl.trim()) url.searchParams.set('url', cjUrl.trim());\n      const res = await fetch(url.toString(), { cache: 'no-store' });\n      const data = await res.json();\n      if (!res.ok || !data?.ok) throw new Error(data?.error || res.statusText);\n      setCjResults(data.items || []);\n      if ((data.items || []).length === 0) setCjMessage('لم يتم العثور على منتجات.');\n    } catch (e: any) {\n      setCjMessage(e?.message || 'فشل البحث في CJ. تأكد من إعداد CJ_ACCESS_TOKEN.');\n    } finally {\n      setCjLoading(false);\n    }\n  }\n\n  async function handleCjImportOne(idx: number) {\n    if (!cjResults || !cjResults[idx]) return;\n    try {\n      setCjLoading(true);\n      setCjMessage('');\n      const body = { items: [cjResults[idx]] };\n      const res = await fetch('/api/admin/cj/products/import', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(body),\n      });\n      const data = await res.json();\n      if (!res.ok || !data?.ok) throw new Error(data?.error || res.statusText);\n      setCjMessage('تم الاستيراد بنجاح.');\n    } catch (e: any) {\n      setCjMessage(e?.message || 'فشل الاستيراد.');\n    } finally {\n      setCjLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"max-w-4xl mx-auto p-6 space-y-6\">\n      <h1 className=\"text-2xl font-semibold\">CSV Import — Products</h1>\n      <p className=\"text-sm opacity-80\">Paste CSV matching branding/suppliers/sku-specs-template.csv. Columns like: Name, UnitCostCurrency, UnitCost, PackLengthCM, PackWidthCM, PackHeightCM, GrossWeightKG, Images, Category, Stock.</p>\n\n      <textarea\n        className=\"w-full h-48 border rounded p-2 font-mono\"\n        placeholder=\"Paste CSV here\"\n        value={csv}\n        onChange={(e) => setCsv(e.target.value)}\n      />\n\n      <div className=\"flex items-center gap-3\">\n        <button onClick={handlePreview} className=\"px-4 py-2 bg-gray-800 text-white rounded\">Preview</button>\n        <button onClick={handleServerPreview} disabled={loading || items.length === 0} className=\"px-4 py-2 bg-amber-600 text-white rounded disabled:opacity-50\">{loading ? 'Processing…' : 'Server Preview (AI + Pricing)'}</button>\n        <button onClick={handleImport} disabled={loading || items.length === 0} className=\"px-4 py-2 bg-blue-600 text-white rounded disabled:opacity-50\">{loading ? 'Importing…' : `Import ${items.length} Products`}</button>\n        <label className=\"flex items-center gap-2 text-sm\">\n          <input type=\"checkbox\" checked={draftOnAnomalies} onChange={(e) => setDraftOnAnomalies(e.target.checked)} />\n          <span>Mark anomalies as draft</span>\n        </label>\n      </div>\n\n      {items.length > 0 && (\n        <div className=\"overflow-auto border rounded\">\n          <table className=\"min-w-full text-sm\">\n            <thead>\n              <tr className=\"bg-gray-100\">\n                <th className=\"p-2 text-left\">Name</th>\n                <th className=\"p-2 text-left\">Currency</th>\n                <th className=\"p-2 text-right\">Cost</th>\n                <th className=\"p-2 text-right\">L×W×H (cm)</th>\n                <th className=\"p-2 text-right\">Weight (kg)</th>\n                <th className=\"p-2 text-left\">Images</th>\n                <th className=\"p-2 text-left\">Video</th>\n                <th className=\"p-2 text-left\">Category</th>\n                <th className=\"p-2 text-right\">Stock</th>\n              </tr>\n            </thead>\n            <tbody>\n              {items.map((it, idx) => (\n                <tr key={idx} className=\"border-t\">\n                  <td className=\"p-2\">{it.name}</td>\n                  <td className=\"p-2\">{it.currency}</td>\n                  <td className=\"p-2 text-right\">{it.supplierCost}</td>\n                  <td className=\"p-2 text-right\">{it.lengthCm}×{it.widthCm}×{it.heightCm}</td>\n                  <td className=\"p-2 text-right\">{it.weightKg}</td>\n                  <td className=\"p-2 truncate max-w-[240px]\" title={it.imagesCsv}>{it.imagesCsv || <span className=\"opacity-60\">(missing)</span>}</td>\n                  <td className=\"p-2 truncate max-w-[200px]\" title={it.videoUrl}>{it.videoUrl ? 'yes' : <span className=\"opacity-60\">(none)</span>}</td>\n                  <td className=\"p-2\">{it.category}</td>\n                  <td className=\"p-2 text-right\">{it.stock}</td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      )}\n\n      {serverPreview && (\n        <div className=\"mt-6\">\n          <h2 className=\"text-xl font-semibold mb-2\">Server Preview Results</h2>\n          <div className=\"overflow-auto border rounded\">\n            <table className=\"min-w-full text-sm\">\n              <thead>\n                <tr className=\"bg-gray-100\">\n                  <th className=\"p-2 text-left\">Title</th>\n                  <th className=\"p-2 text-left\">Slug</th>\n                  <th className=\"p-2 text-left\">Category</th>\n                  <th className=\"p-2 text-right\">Retail (SAR)</th>\n                  <th className=\"p-2 text-right\">Landed (SAR)</th>\n                  <th className=\"p-2 text-right\">DDP Ship (SAR)</th>\n                  <th className=\"p-2 text-right\">Billed Wt (kg)</th>\n                  <th className=\"p-2 text-right\">Vol (kg)</th>\n                  <th className=\"p-2 text-left\">Anomalies</th>\n                </tr>\n              </thead>\n              <tbody>\n                {serverPreview.results?.map((r: any, idx: number) => (\n                  <tr key={idx} className=\"border-t\">\n                    <td className=\"p-2\">{r.title}</td>\n                    <td className=\"p-2\">{r.slug}</td>\n                    <td className=\"p-2\">{r.category}</td>\n                    <td className=\"p-2 text-right\">{r.pricing?.retailSar}</td>\n                    <td className=\"p-2 text-right\">{r.pricing?.landedCostSar}</td>\n                    <td className=\"p-2 text-right\">{r.pricing?.ddpShippingSar}</td>\n                    <td className=\"p-2 text-right\">{r.pricing?.billedWeightKg}</td>\n                    <td className=\"p-2 text-right\">{r.volumetricKg}</td>\n                    <td className=\"p-2\">\n                      {Array.isArray(r.anomalies) && r.anomalies.length > 0 ? (\n                        <ul className=\"list-disc list-inside text-xs space-y-0.5\">\n                          {r.anomalies.map((a: any, i: number) => (\n                            <li key={i} className={a.severity === 'warn' ? 'text-amber-700' : a.severity === 'error' ? 'text-red-700' : 'text-slate-600'}>\n                              {a.code}: {a.message}\n                            </li>\n                          ))}\n                        </ul>\n                      ) : (\n                        <span className=\"text-xs opacity-60\">—</span>\n                      )}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n          <details className=\"mt-3\">\n            <summary className=\"cursor-pointer\">Raw preview JSON</summary>\n            <pre className=\"bg-black text-green-300 text-xs p-3 rounded overflow-auto max-h-80\">{JSON.stringify(serverPreview, null, 2)}</pre>\n          </details>\n        </div>\n      )}\n\n      {/* CJ Import Section */}\n      <div className=\"mt-10 border-t pt-6 space-y-4\">\n        <h2 className=\"text-xl font-semibold\">CJ Import</h2>\n        <p className=\"text-sm opacity-80\">ابحث بالـ PID أو كلمة مفتاحية أو الصق رابط منتج CJ، ثم استورد المنتج (يشمل الصور/الفيديو/المقاسات/المخزون). يحتاج تفعيل CJ_EMAIL و CJ_API_KEY في Vercel.</p>\n        <div className=\"flex flex-col gap-3 sm:flex-row\">\n          <input className=\"border rounded p-2 flex-1\" placeholder=\"PID\" value={cjPid} onChange={(e) => setCjPid(e.target.value)} />\n          <input className=\"border rounded p-2 flex-1\" placeholder=\"Keyword\" value={cjKeyword} onChange={(e) => setCjKeyword(e.target.value)} />\n          <input className=\"border rounded p-2 flex-1\" placeholder=\"CJ Product URL\" value={cjUrl} onChange={(e) => setCjUrl(e.target.value)} />\n          <button onClick={handleCjSearch} disabled={cjLoading} className=\"px-4 py-2 bg-emerald-600 text-white rounded disabled:opacity-50\">{cjLoading ? 'جارٍ البحث…' : 'Search CJ'}</button>\n        </div>\n        {cjMessage && <div className=\"text-sm text-slate-600\">{cjMessage}</div>}\n        {Array.isArray(cjResults) && cjResults.length > 0 && (\n          <div className=\"space-y-4\">\n            {cjResults.map((p, idx) => (\n              <div key={idx} className=\"rounded border p-3\">\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"grid grid-cols-4 gap-2 w-1/2 pr-2\">\n                    {(p.images || []).slice(0, 8).map((u: string, i: number) => (\n                      // eslint-disable-next-line @next/next/no-img-element\n                      <img key={i} src={u} alt=\"\" className=\"aspect-square w-full object-cover rounded bg-slate-100\" />\n                    ))}\n                    {p.videoUrl ? (\n                      <div className=\"col-span-4 text-xs text-emerald-700\">Video: نعم</div>\n                    ) : null}\n                  </div>\n                  <div className=\"flex-1\">\n                    <div className=\"font-medium\">{p.name}</div>\n                    <div className=\"text-xs text-slate-500\">PID: {p.productId} · From: {p.originArea || '—'} ({p.originCountryCode || '—'})</div>\n                    <div className=\"overflow-auto mt-2\">\n                      <table className=\"min-w-[360px] text-xs\">\n                        <thead>\n                          <tr className=\"bg-muted\">\n                            <th className=\"p-1 text-left\">Size</th>\n                            <th className=\"p-1 text-right\">Price</th>\n                            <th className=\"p-1 text-right\">Stock</th>\n                            <th className=\"p-1 text-left\">SKU</th>\n                          </tr>\n                        </thead>\n                        <tbody>\n                          {(p.variants || []).map((v: any, vi: number) => (\n                            <tr key={vi} className=\"border-t\">\n                              <td className=\"p-1\">{v.size || '-'}</td>\n                              <td className=\"p-1 text-right\">{v.price ?? '—'}</td>\n                              <td className=\"p-1 text-right\">{v.stock ?? '—'}</td>\n                              <td className=\"p-1\">{v.cjSku || '-'}</td>\n                            </tr>\n                          ))}\n                        </tbody>\n                      </table>\n                    </div>\n                    <div className=\"mt-2\">\n                      <button onClick={() => handleCjImportOne(idx)} disabled={cjLoading} className=\"px-3 py-1 bg-blue-600 text-white rounded disabled:opacity-50\">{cjLoading ? 'جارٍ الاستيراد…' : 'Import'}</button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n\n      {log && (\n        <pre className=\"bg-black text-green-300 text-xs p-3 rounded overflow-auto max-h-80\">{log}</pre>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":14837,"size_tokens":null},"src/app/api/admin/cj/products/import/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, type CjProductLike } from '@/lib/cj/v2';\nimport { slugify } from '@/lib/utils/slug';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { hasTable, hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function ensureUniqueSlug(admin: any, base: string): Promise<string> {\n  const s = slugify(base);\n  let candidate = s;\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin\n      .from('products')\n      .select('id')\n      .eq('slug', candidate)\n      .maybeSingle();\n    if (!data) return candidate;\n    candidate = `${s}-${i}`;\n  }\n  return `${s}-${Date.now()}`;\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'import-v2', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Global kill-switch enforcement: block write operations\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, version: 'import-v2', error: 'Kill switch is ON. Import is temporarily disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const body = await req.json();\n    const pid: string | undefined = body?.pid || undefined;\n    const itemsIn: CjProductLike[] | undefined = body?.items || undefined;\n    const categoryParam: string = (body?.category || 'General').trim();\n\n    let items: CjProductLike[] = [];\n    if (Array.isArray(itemsIn) && itemsIn.length > 0) {\n      items = itemsIn;\n    } else if (pid) {\n      const raw = await queryProductByPidOrKeyword({ pid });\n      const listRaw = Array.isArray(raw?.data?.content)\n        ? raw.data.content\n        : Array.isArray(raw?.content)\n          ? raw.content\n          : Array.isArray(raw?.data)\n            ? raw.data\n            : Array.isArray(raw)\n              ? raw\n              : [];\n      items = (listRaw as any[]).map((it) => mapCjItemToProductLike(it)).filter(Boolean) as CjProductLike[];\n      if (items.length === 0) {\n        const r = NextResponse.json({ ok: false, error: 'No CJ products found for pid' }, { status: 404 });\n        r.headers.set('x-request-id', log.requestId);\n        return r;\n      }\n    } else {\n      const r = NextResponse.json({ ok: false, error: 'Provide pid or items' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const results: any[] = [];\n    const hasVariantsTable = await hasTable('product_variants');\n\n    for (const cj of items) {\n      try {\n        // If product with same cj_product_id exists, we will update it; otherwise insert.\n        const { data: existing } = await supabase\n          .from('products')\n          .select('id, slug')\n          .eq('cj_product_id', cj.productId)\n          .maybeSingle();\n\n        const baseSlug = await ensureUniqueSlug(supabase, cj.name);\n        const priceCandidates = (cj.variants || []).map((v) => (typeof v.price === 'number' ? v.price : NaN)).filter((n) => !isNaN(n));\n        const defaultPrice = priceCandidates.length > 0 ? Math.min(...priceCandidates) : 0;\n        \n        // 100% ACCURACY MANDATE: Import ALL variants exactly as CJ provides them\n        // Calculate totalStock from known values only, but keep ALL variants (even with unknown stock)\n        // If ALL variants have unknown stock, product stock should be null (not 0)\n        const variants = cj.variants || [];\n        const variantsWithKnownStock = variants.filter((v) => {\n          if (typeof v.stock === 'number' && v.stock >= 0) return true;\n          if (typeof v.cjStock === 'number' && v.cjStock >= 0) return true;\n          if (typeof v.factoryStock === 'number' && v.factoryStock >= 0) return true;\n          return false;\n        });\n        \n        // If no variants have known stock, totalStock is null (unknown, not fabricated 0)\n        const totalStock: number | null = variantsWithKnownStock.length === 0 \n          ? null \n          : variantsWithKnownStock.reduce((acc, v) => {\n              if (typeof v.stock === 'number' && v.stock >= 0) return acc + v.stock;\n              const cjVal = (typeof v.cjStock === 'number' && v.cjStock >= 0) ? v.cjStock : 0;\n              const factoryVal = (typeof v.factoryStock === 'number' && v.factoryStock >= 0) ? v.factoryStock : 0;\n              return acc + cjVal + factoryVal;\n            }, 0);\n\n        let productPayload: any = {\n          title: cj.name,\n          slug: existing?.slug || baseSlug,\n          description: '',\n          price: defaultPrice,\n          images: cj.images || [],\n          category: categoryParam,\n          stock: totalStock,\n          video_url: cj.videoUrl || null,\n          processing_time_hours: null,\n          delivery_time_hours: cj.deliveryTimeHours ?? null,\n          origin_area: cj.originArea ?? null,\n          origin_country_code: cj.originCountryCode ?? null,\n          free_shipping: true,\n          inventory_shipping_fee: 0,\n          last_mile_fee: 0,\n          cj_product_id: cj.productId,\n          shipping_from: cj.originArea ?? null,\n          is_active: true,\n        };\n\n        // Omit is_active if column missing in this environment\n        if (!(await hasColumn('products', 'is_active'))) {\n          const { is_active, ...rest } = productPayload;\n          productPayload = rest;\n        }\n\n        let productId: number;\n        if (existing?.id) {\n          const { data: upd, error: upErr } = await supabase\n            .from('products')\n            .update(productPayload)\n            .eq('id', existing.id)\n            .select('id')\n            .single();\n          if (upErr || !upd) throw upErr || new Error('Failed to update product');\n          productId = upd.id as number;\n\n          // Clear old variants\n          await supabase.from('product_variants').delete().eq('product_id', productId);\n        } else {\n          // Insert with basic idempotency on slug conflicts\n          let insResult: any = null;\n          try {\n            const { data: ins, error: insErr } = await supabase\n              .from('products')\n              .insert(productPayload)\n              .select('id')\n              .single();\n            if (insErr || !ins) throw insErr || new Error('Failed to insert product');\n            insResult = ins;\n          } catch (e: any) {\n            const msg = String(e?.message || e || '');\n            if (/duplicate key|unique constraint|unique violation|already exists/i.test(msg)) {\n              const base = productPayload.slug || slugify(cj.name);\n              productPayload.slug = await ensureUniqueSlug(supabase, base);\n              const { data: ins2, error: err2 } = await supabase\n                .from('products')\n                .insert(productPayload)\n                .select('id')\n                .single();\n              if (err2 || !ins2) throw err2 || new Error('Failed to insert product (retry)');\n              insResult = ins2;\n            } else {\n              throw e;\n            }\n          }\n          productId = insResult.id as number;\n        }\n\n        // Insert variants if table exists\n        // CRITICAL: Only import variants with accurate stock data (100% accuracy mandate)\n        if (hasVariantsTable) {\n          const variantsRows = (cj.variants || [])\n            .filter((v) => v && (v.size || v.cjSku || v.variantKey))\n            .map((v) => {\n              // Handle stock values with 100% accuracy:\n              // - null/undefined means unknown - skip this variant\n              // - -1 is a sentinel for \"per-variant unknown\" - skip this variant  \n              // - 0+ is actual known stock - use this value\n              const cjStockRaw = v.cjStock;\n              const factoryStockRaw = v.factoryStock;\n              \n              // Convert to DB values: null for unknown, actual value for known\n              const cjStockVal = (typeof cjStockRaw === 'number' && cjStockRaw >= 0) ? cjStockRaw : null;\n              const factoryStockVal = (typeof factoryStockRaw === 'number' && factoryStockRaw >= 0) ? factoryStockRaw : null;\n              \n              // Calculate total stock - ONLY from known CJ data, never fabricated\n              // 1. If explicit v.stock provided and >= 0, use it\n              // 2. If cj + factory are known, sum them\n              // 3. If only one is known, use that\n              // 4. If neither is known, mark as null (will be filtered out)\n              let totalStock: number | null;\n              if (typeof v.stock === 'number' && v.stock >= 0) {\n                // CJ provided explicit total for this variant\n                totalStock = v.stock;\n              } else if (cjStockVal !== null && factoryStockVal !== null) {\n                // Both warehouse values known - sum them\n                totalStock = cjStockVal + factoryStockVal;\n              } else if (cjStockVal !== null) {\n                // Only CJ stock known - use it\n                totalStock = cjStockVal;\n              } else if (factoryStockVal !== null) {\n                // Only Factory stock known - use it\n                totalStock = factoryStockVal;\n              } else {\n                // Neither is known - cannot import without fabricating data\n                totalStock = null;\n              }\n              \n              return {\n                product_id: productId,\n                option_name: 'Size',\n                option_value: v.size || v.variantKey || '-',\n                cj_sku: v.cjSku || null,\n                cj_variant_id: v.vid || null,\n                variant_key: v.variantKey || null, // Short name like \"Black And Silver-2XL\"\n                price: typeof v.price === 'number' ? v.price : null,\n                stock: totalStock, // null if unknown (will be filtered out)\n                cj_stock: cjStockVal, // null if unknown, actual value if known\n                factory_stock: factoryStockVal, // null if unknown, actual value if known\n                weight_grams: typeof v.weightGrams === 'number' ? v.weightGrams : null,\n                length_cm: typeof v.lengthCm === 'number' ? v.lengthCm : null,\n                width_cm: typeof v.widthCm === 'number' ? v.widthCm : null,\n                height_cm: typeof v.heightCm === 'number' ? v.heightCm : null,\n              };\n            });\n          // 100% ACCURACY: Keep ALL variants from CJ, store null for unknown stock\n          // Do NOT filter out variants - that would misrepresent CJ's catalog\n            \n          if (variantsRows.length > 0) {\n            const { error: vErr } = await supabase\n              .from('product_variants')\n              .insert(variantsRows);\n            if (vErr) throw vErr;\n          }\n        }\n\n        // Best-effort: recompute product stock using trigger or RPC (optional)\n        try {\n          await supabase.rpc('recompute_product_stock', { product_id_in: productId });\n        } catch {}\n\n        results.push({ ok: true, productId, title: cj.name });\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e), title: cj?.name });\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, version: 'import-v2', results }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, version: 'import-v2', error: e?.message || 'CJ import failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":12476,"size_tokens":null},"src/app/account/notifications/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading your preferences...\" />;\n}\n","path":null,"size_bytes":162,"size_tokens":null},"src/app/brand/review/page.tsx":{"content":"\"use client\";\n\nimport React from \"react\";\n\nexport default function BrandReviewPage() {\n  const setAccent = (hex: string) => {\n    if (typeof document !== \"undefined\") {\n      document.documentElement.style.setProperty(\"--accent\", hex);\n      const el = document.getElementById(\"swAccent\");\n      if (el) {\n        (el as HTMLElement).style.backgroundColor = hex;\n        const span = el.querySelector(\"span\");\n        if (span) span.textContent = hex;\n      }\n    }\n  };\n\n  return (\n    <div>\n      <style>{`\n        :root{ --brand:#111111; --bg:#ffffff; --accent:#2563EB; --muted:#6b7280; }\n        *{ box-sizing:border-box; }\n        body{ margin:0; font-family: Inter, Cairo, Arial, Helvetica, sans-serif; color:#111; background:#fff; }\n        /* Hide global store chrome on this preview page only */\n        header.sticky.top-0{ display:none !important; }\n        nav{ display:none !important; }\n        footer{ display:none !important; }\n        header{ position:sticky; top:0; background:#fff; border-bottom:1px solid #eee; padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px; }\n        header .l{ display:flex; align-items:center; gap:12px; }\n        header img{ height:28px; }\n        .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 40px; }\n        h1{ font-size:20px; margin:6px 0 12px; }\n        h2{ font-size:18px; margin:22px 0 10px; }\n        p{ margin:8px 0; color:#333; }\n        .row{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }\n        .card{ border:1px solid #eee; border-radius:10px; padding:14px; background:#fff; }\n        .swatches{ display:flex; flex-wrap:wrap; gap:10px; }\n        .swatch{ width:110px; height:64px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; box-shadow:0 0 0 1px rgba(0,0,0,.05) inset; }\n        .swatch span{ background:rgba(0,0,0,.35); padding:2px 6px; border-radius:6px; font-size:12px; }\n        .grid-logos{ display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:center; }\n        .logo-box{ border:1px dashed #ddd; border-radius:10px; background:#fafafa; display:flex; align-items:center; justify-content:center; padding:16px; }\n        .logo-box.dark{ background:#111; }\n        .logo-box img{ max-width:100%; height:64px; }\n        .toolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }\n        button{ background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:700; }\n        .muted{ color:var(--muted); font-size:12px; }\n        iframe{ width:100%; height:330px; border:1px solid #eee; border-radius:10px; background:#fff; }\n        .checklist li{ margin:6px 0; }\n        .pill{ display:inline-block; padding:2px 8px; border:1px solid #eee; border-radius:999px; font-size:12px; color:#333; background:#fafafa; }\n      `}</style>\n\n      <header>\n        <div className=\"l\">\n          <img src=\"/brand/logo-shopixo-wordmark.svg\" alt=\"Shopixo\" />\n          <strong>لوحة مراجعة العلامة | Brand Review</strong>\n        </div>\n        <div className=\"toolbar\">\n          <button onClick={() => setAccent(\"#2563EB\")}>Accent أزرق</button>\n          <button onClick={() => setAccent(\"#0EA5E9\")}>Accent تركوازي</button>\n          <span className=\"pill\">Shipper Name: Shopixo</span>\n          <span className=\"pill\">WhatsApp: 00962781637033</span>\n        </div>\n      </header>\n\n      <main className=\"wrap\">\n        <section className=\"card\">\n          <h1>الشعار</h1>\n          <div className=\"grid-logos\">\n            <div>\n              <div className=\"muted\">Wordmark على خلفية فاتحة</div>\n              <div className=\"logo-box\">\n                <img src=\"/brand/logo-shopixo-wordmark.svg\" alt=\"Shopixo wordmark\" />\n              </div>\n            </div>\n            <div>\n              <div className=\"muted\">Wordmark على خلفية داكنة</div>\n              <div className=\"logo-box dark\">\n                <img src=\"/brand/logo-shopixo-wordmark-white.svg\" alt=\"Shopixo wordmark (white)\" />\n              </div>\n            </div>\n          </div>\n          <div style={{ height: 12 }} />\n          <div className=\"grid-logos\">\n            <div>\n              <div className=\"muted\">نسخة الحقيبة — فاتح</div>\n              <div className=\"logo-box\">\n                <img src=\"/brand/logo-shopixo-bag.svg\" alt=\"Shopixo with bag\" />\n              </div>\n            </div>\n            <div>\n              <div className=\"muted\">نسخة الحقيبة — داكن</div>\n              <div className=\"logo-box dark\">\n                <img src=\"/brand/logo-shopixo-bag-white.svg\" alt=\"Shopixo with bag (white)\" />\n              </div>\n            </div>\n          </div>\n        </section>\n\n        <section className=\"card\">\n          <h2>الألوان</h2>\n          <div className=\"swatches\">\n            <div className=\"swatch\" style={{ background: \"#111111\" }}><span>#111111</span></div>\n            <div className=\"swatch\" style={{ background: \"#FFFFFF\", color: \"#111\" }}><span>#FFFFFF</span></div>\n            <div id=\"swAccent\" className=\"swatch\" style={{ background: \"#2563EB\" }}><span>#2563EB</span></div>\n            <div className=\"swatch\" style={{ background: \"#374151\" }}><span>#374151</span></div>\n            <div className=\"swatch\" style={{ background: \"#9CA3AF\" }}><span>#9CA3AF</span></div>\n            <div className=\"swatch\" style={{ background: \"#F59E0B\" }}><span>#F59E0B</span></div>\n          </div>\n          <p className=\"muted\">يمكن تغيير لون الـ Accent مؤقتاً بالأزرار أعلى الصفحة لمعاينة الإحساس البصري.</p>\n        </section>\n\n        <section className=\"row\">\n          <div className=\"card\">\n            <h2>قسيمة التغليف (Packing Slip)</h2>\n            <iframe src=\"/brand/packing-slip\" title=\"Packing Slip\" />\n            <p className=\"muted\">تُعرَض القسيمة بحجم A5. تحقّق من ترتيب النصوص بالعربية ووضوح المعلومات.</p>\n          </div>\n          <div className=\"card\">\n            <h2>بطاقة الشكر (Thank-You)</h2>\n            <iframe src=\"/brand/thank-you-insert\" title=\"Thank You Insert\" />\n            <p className=\"muted\">الـ QR يفتح واتساب 00962781637033. تأكد من ملاءمة الخط والهوامش.</p>\n          </div>\n        </section>\n\n        <section className=\"card\">\n          <h2>قائمة قرارات سريعة</h2>\n          <ul className=\"checklist\">\n            <li>اختر الشعار للاستخدام في الهيدر: <strong>Wordmark</strong> أم <strong>نسخة الحقيبة</strong>؟</li>\n            <li>اعتماد لون الـ Accent: الأزرق (#2563EB) أم تفضّل تركوازي (#0EA5E9)؟</li>\n            <li>هل الخط مناسب؟ (Inter + Cairo/Tajawal)</li>\n            <li>هل نصوص الـ Packing Slip وبطاقة الشكر مناسبة؟ هل نعدّل البريد/النص؟</li>\n            <li>اعتماد اسم المرسل: <strong>Shopixo</strong> — تأكيد نهائي؟</li>\n          </ul>\n          <p>بعد الاعتماد، سأطبّق الهوية على واجهة المتجر ونبدأ مباشرة باعتماد الموردين وطلبات الاختبار.</p>\n        </section>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":7438,"size_tokens":null},"src/app/account/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading your account...\" />;\n}\n","path":null,"size_bytes":158,"size_tokens":null},"src/components/ratings.tsx":{"content":"type Props = { value: number; count?: number };\n\nexport default function Ratings({ value, count }: Props) {\n  const full = Math.floor(value);\n  const half = value - full >= 0.5;\n  const stars = Array.from({ length: 5 }, (_, i) => {\n    if (i < full) return \"★\";\n    if (i === full && half) return \"☆\"; // simple half representation\n    return \"☆\";\n  });\n  return (\n    <div className=\"inline-flex items-center gap-2 text-yellow-500\" aria-label={`${value} stars`}>\n      <span className=\"text-base leading-none\">{stars.join(\" \")}</span>\n      {count != null && <span className=\"text-sm text-slate-600\">({count})</span>}\n    </div>\n  );\n}\n","path":null,"size_bytes":643,"size_tokens":null},"src/app/api/upload/route.ts":{"content":"import { NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { getClientIp, uploadLimiter } from \"@/lib/ratelimit\";\nimport { ensureAdmin } from \"@/lib/auth/admin-guard\";\nimport { loggerForRequest } from \"@/lib/log\";\nimport { ensureEnv, getEnv } from \"@/lib/env\";\n\nexport const dynamic = \"force-dynamic\";\nexport const runtime = \"nodejs\";\nexport const revalidate = 0;\n\nfunction sanitizeFileName(name: string) {\n  return name.replace(/[^a-zA-Z0-9._-]/g, \"_\");\n}\n\n// Upstash Redis rate limiting is used instead of in-memory\n\nexport async function POST(req: Request) {\n  try {\n    const log = loggerForRequest(req);\n    // Auth: require admin via centralized guard\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, message: \"Unauthorized\" }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Rate limit (Upstash Redis)\n    try {\n      const ip = getClientIp(req);\n      const { success } = await uploadLimiter.limit(ip);\n      if (!success) {\n        const r = NextResponse.json({ ok: false, message: \"Too Many Requests\" }, { status: 429 });\n        r.headers.set('x-request-id', log.requestId);\n        return r;\n      }\n    } catch {}\n\n    const form = await req.formData();\n    const file = form.get(\"file\") as File | null;\n    const dir = (form.get(\"dir\") as string | null) || \"\";\n    if (!file) {\n      const r = NextResponse.json({ ok: false, message: \"No file provided\" }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Validate content type & size\n    const allowed = [\n      // images\n      \"image/jpeg\", \"image/png\", \"image/webp\", \"image/avif\", \"image/gif\", \"image/svg+xml\",\n      // videos\n      \"video/mp4\", \"video/webm\", \"video/ogg\", \"application/vnd.apple.mpegURL\"\n    ];\n    const maxBytes = 15 * 1024 * 1024; // 15MB\n    const contentType = (file.type || \"\").toLowerCase();\n    if (!allowed.includes(contentType)) {\n      return NextResponse.json({ ok: false, message: \"Unsupported file type\" }, { status: 415 });\n    }\n    if ((file as any).size && (file as any).size > maxBytes) {\n      return NextResponse.json({ ok: false, message: \"File too large\" }, { status: 413 });\n    }\n\n    const need = ensureEnv(['NEXT_PUBLIC_SUPABASE_URL','SUPABASE_SERVICE_ROLE_KEY']);\n    if (!need.ok) {\n      const r = NextResponse.json(\n        { ok: false, message: \"Server misconfiguration: missing Supabase envs\" },\n        { status: 500 }\n      );\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const url = getEnv('NEXT_PUBLIC_SUPABASE_URL') as string;\n    const key = getEnv('SUPABASE_SERVICE_ROLE_KEY') as string;\n\n    const supabase = createClient(url, key);\n\n    // Ensure bucket exists (public)\n    const bucketName = \"products\";\n    try {\n      const { data: bucketInfo, error: bucketInfoErr } = await supabase.storage.getBucket(bucketName);\n      if (!bucketInfo || bucketInfoErr) {\n        await supabase.storage.createBucket(bucketName, { public: true });\n      }\n    } catch {}\n\n    const now = new Date();\n    const y = now.getUTCFullYear();\n    const m = String(now.getUTCMonth() + 1).padStart(2, \"0\");\n    const safeDir = sanitizeFileName(dir).slice(0, 64);\n    const base = `uploads/${y}/${m}/${guard.user.id}` + (safeDir ? `/${safeDir}` : \"\");\n    const safeName = sanitizeFileName(file.name || \"file\");\n    const ext = safeName.includes(\".\") ? safeName.split(\".\").pop() : \"bin\";\n    const rnd = Math.random().toString(36).slice(2);\n    const path = `${base}/${now.getTime()}-${rnd}.${ext}`;\n\n    const { error: upErr } = await supabase.storage\n      .from(bucketName)\n      .upload(path, file, { contentType: contentType || undefined, upsert: true });\n    if (upErr) {\n      const r = NextResponse.json({ ok: false, message: upErr.message }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const pub = supabase.storage.from(bucketName).getPublicUrl(path);\n    const publicUrl = (pub as any)?.data?.publicUrl || (pub as any)?.publicURL || (pub as any)?.publicUrl;\n\n    if (!publicUrl) {\n      const r = NextResponse.json({ ok: false, message: \"Could not resolve public URL\" }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const r = NextResponse.json({ ok: true, url: publicUrl, path }, { status: 200 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, message: e?.message || \"Upload failed\" }, { status: 500 });\n    try { r.headers.set('x-request-id', loggerForRequest(req).requestId); } catch {}\n    return r;\n  }\n}\n","path":null,"size_bytes":4751,"size_tokens":null},"src/app/api/admin/cj/products/import/scrape/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { hasTable, hasColumn } from '@/lib/db-features';\nimport { loggerForRequest } from '@/lib/log';\nimport { fetchWithMeta } from '@/lib/http';\nimport { createClient } from '@supabase/supabase-js';\nimport { slugify } from '@/lib/utils/slug';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { isKillSwitchOn } from '@/lib/settings';\n\n// Ensure this route is always dynamic and not cached at the edge\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nfunction uniq<T>(arr: T[]): T[] { return Array.from(new Set(arr)); }\n\nasync function omitMissingProductColumns(_admin: any, payload: Record<string, any>, cols: string[]) {\n  for (const c of cols) {\n    if (!(c in payload)) continue;\n    try {\n      const exists = await hasColumn('products', c);\n      if (!exists) delete payload[c];\n    } catch {\n      delete payload[c];\n    }\n  }\n}\n\nasync function productVariantsTableExists(_admin: any): Promise<boolean> {\n  return await hasTable('product_variants');\n}\n\nfunction normalizeUrl(u: string): string {\n  try {\n    const url = new URL(u);\n    url.hash = '';\n    url.search = '';\n    url.protocol = 'https:';\n    return url.toString();\n  } catch { return u; }\n}\n\nfunction sanitizeTitle(t: string): string {\n  let s = t.trim();\n  // remove any occurrence of 'CJDropshipping' or 'CJ Dropshipping' (any case, with/without dash)\n  s = s.replace(/\\b(cj\\s*-?\\s*dropshipping)\\b/ig, '');\n  // remove trailing/leading separators left over\n  s = s.replace(/\\s*-\\s*$/g, '');\n  s = s.replace(/^\\s*-\\s*/g, '');\n  // collapse multiple spaces\n  s = s.replace(/\\s{2,}/g, ' ').trim();\n  return s;\n}\n\nfunction extractFromHtml(html: string, pageUrl: string) {\n  // Title: og:title > <title>\n  let title = '';\n  const og = html.match(/<meta\\s+property=[\"']og:title[\"']\\s+content=[\"']([^\"']+)[\"']/i);\n  if (og && og[1]) title = og[1].trim();\n  if (!title) {\n    const t = html.match(/<title>([^<]+)<\\/title>/i);\n    if (t && t[1]) title = t[1].trim();\n  }\n  if (!title) title = 'Untitled';\n  title = sanitizeTitle(title);\n\n  // Images: parse <img src|data-src> and filter to product media\n  const imgs: string[] = [];\n  const attrImgs = html.matchAll(/<img[^>]+(?:data-src|src)=[\"']([^\"']+\\.(?:jpg|jpeg|png|webp))(?:\\?[^\"']*)?[\"'][^>]*>/ig);\n  for (const m of attrImgs) {\n    if (typeof m[1] === 'string') imgs.push(normalizeUrl(m[1]));\n  }\n  // Also catch direct URLs\n  const directImgs = html.matchAll(/https?:\\/\\/[^\\s\"'<>]+\\.(?:jpg|jpeg|png|webp)(?:\\?[^\\s\"'<>]*)?/ig);\n  for (const m of directImgs) { if (typeof m[0] === 'string') imgs.push(normalizeUrl(m[0])); }\n\n  // Filter out icons/logos/ui/badges/flags/size-charts/etc.\n  const deny = /(sprite|icon|favicon|logo|placeholder|blank|loading|alipay|wechat|whatsapp|kefu|service|avatar|thumb|thumbnail|small|tiny|mini|sizechart|size\\s*chart|chart|table|guide|tips|hot|badge|flag|promo|banner|sale|discount|qr|cm|inch)/i;\n  const allowHost = /(cjdropshipping|aliyuncs|alicdn|oss-)/i;\n  function isSmall(u: string) {\n    // match -100x100 etc\n    const m = u.match(/-(\\d{2,4})x(\\d{2,4})(?=\\.)/i);\n    if (m) {\n      const w = Number(m[1]);\n      const h = Number(m[2]);\n      if (w < 512 || h < 512) return true;\n    }\n    // query hints\n    const qm = u.match(/[?&](?:w|width|h|height)=(\\d{2,4})/i);\n    if (qm && Number(qm[1]) < 512) return true;\n    return false;\n  }\n  function normKey(u: string) {\n    try {\n      const url = new URL(u);\n      const name = url.pathname.split('/').pop() || u;\n      return name.toLowerCase().replace(/-\\d{2,4}x\\d{2,4}(?=\\.)/, '');\n    } catch { return u; }\n  }\n  const seen = new Set<string>();\n  const filtered: string[] = [];\n  for (const u of imgs) {\n    if (deny.test(u)) continue;\n    if (!allowHost.test(u)) continue;\n    if (isSmall(u)) continue;\n    const key = normKey(u);\n    if (seen.has(key)) continue;\n    seen.add(key);\n    filtered.push(u);\n    if (filtered.length >= 8) break;\n  }\n  const images = filtered;\n\n  // Video: try og:video, <video src>, <source src>\n  let videoUrl: string | null = null;\n  const ogv = html.match(/<meta\\s+property=[\"']og:video[\"']\\s+content=[\"']([^\"']+)[\"']/i);\n  if (ogv && ogv[1]) videoUrl = normalizeUrl(ogv[1]);\n  if (!videoUrl) {\n    const v1 = html.match(/<video[^>]+src=[\"']([^\"']+\\.(?:mp4|m3u8))(?:\\?[^\"']*)?[\"']/i);\n    if (v1 && v1[1]) videoUrl = normalizeUrl(v1[1]);\n  }\n  if (!videoUrl) {\n    const v2 = html.match(/<source[^>]+src=[\"']([^\"']+\\.(?:mp4|m3u8))(?:\\?[^\"']*)?[\"']/i);\n    if (v2 && v2[1]) videoUrl = normalizeUrl(v2[1]);\n  }\n  if (!videoUrl) {\n    const jv = html.match(/[\"']videoUrl[\"']\\s*[:=]\\s*[\"'](https?:[^\"']+\\.(?:mp4|m3u8))[\"']/i);\n    if (jv && jv[1]) videoUrl = normalizeUrl(jv[1]);\n  }\n\n  // Attempt to extract numeric id from URL pattern p-123456...html\n  const np = pageUrl.match(/p-([0-9]{6,})/i);\n  const numericId = np ? np[1] : undefined;\n\n  return { title, images, numericId, videoUrl };\n}\n\nasync function ensureUniqueSlug(admin: any, base: string): Promise<string> {\n  const s = slugify(base);\n  let candidate = s;\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin\n      .from('products')\n      .select('id')\n      .eq('slug', candidate)\n      .maybeSingle();\n    if (!data) return candidate;\n    candidate = `${s}-${i}`;\n  }\n  return `${s}-${Date.now()}`;\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'scrape-v3', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Global kill-switch enforcement\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, version: 'scrape-v3', error: 'Kill switch is ON. Import is disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const { searchParams } = new URL(req.url);\n    const urls = new Set<string>();\n    for (const u of searchParams.getAll('url')) if (u && u.trim()) urls.add(u.trim());\n    const urlsCsv = searchParams.get('urls');\n    if (urlsCsv) for (const u of urlsCsv.split(',').map((s) => s.trim()).filter(Boolean)) urls.add(u);\n    if (urls.size === 0) {\n      const r = NextResponse.json({ ok: false, error: 'Provide url=... (supports multiple)' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const priceParam = Number(searchParams.get('price') || NaN);\n    const defaultPrice = Math.max(1, Number(process.env.DEFAULT_SCRAPE_PRICE_SAR || '69'));\n\n    const results: any[] = [];\n\n    for (const u of Array.from(urls)) {\n      try {\n        const meta = await fetchWithMeta<string>(u, { method: 'GET', cache: 'no-store', timeoutMs: 12000, retries: 1 });\n        log.info('scrape_fetch', { url: u, status: meta.status, ok: meta.ok });\n        const html = typeof meta.body === 'string' ? meta.body : '';\n        if (!meta.ok || !html) throw new Error('Failed to fetch source page');\n        const ext = extractFromHtml(html, u);\n\n        const baseSlug = await ensureUniqueSlug(supabase, ext.title);\n        const productPayload: any = {\n          // Start with the most common columns only\n          title: ext.title,\n          slug: baseSlug,\n          price: Number.isFinite(priceParam) && priceParam > 0 ? Math.round(priceParam) : defaultPrice,\n          category: 'Women',\n          stock: 100,\n        };\n\n        // Add optional fields that we will prune if absent\n        productPayload.description = '';\n        productPayload.images = ext.images;\n        productPayload.video_url = ext.videoUrl || null;\n        productPayload.processing_time_hours = null;\n        productPayload.delivery_time_hours = null;\n        productPayload.origin_area = null;\n        productPayload.origin_country_code = null;\n        productPayload.free_shipping = true;\n        productPayload.inventory_shipping_fee = 0;\n        productPayload.last_mile_fee = 0;\n        productPayload.cj_product_id = ext.numericId || null;\n        productPayload.shipping_from = null;\n        productPayload.is_active = (productPayload.price > 0);\n\n        // Omit optional columns that may not exist in this schema\n        await omitMissingProductColumns(supabase, productPayload, [\n          'video_url',\n          'processing_time_hours',\n          'delivery_time_hours',\n          'origin_area',\n          'origin_country_code',\n          'free_shipping',\n          'inventory_shipping_fee',\n          'last_mile_fee',\n          'shipping_from',\n          'description',\n          'images',\n        ]);\n\n        // Omit cj_product_id if column missing\n        if (!(await hasColumn('products', 'cj_product_id'))) {\n          delete productPayload.cj_product_id;\n        }\n\n        // Omit is_active if column missing\n        if (!(await hasColumn('products', 'is_active'))) {\n          delete productPayload.is_active;\n        }\n\n        // Insert with base columns only to avoid schema issues\n        const baseInsert = {\n          title: productPayload.title,\n          slug: productPayload.slug,\n          price: productPayload.price,\n          category: productPayload.category,\n          stock: productPayload.stock,\n        } as any;\n\n        let productId: number;\n        // Insert with basic idempotency on slug conflicts\n        try {\n          const { data: ins, error: insErr } = await supabase\n            .from('products')\n            .insert(baseInsert)\n            .select('id')\n            .single();\n          if (insErr || !ins) throw insErr || new Error('Failed to insert product');\n          productId = ins.id as number;\n        } catch (e: any) {\n          const msg = String(e?.message || e || '');\n          if (/duplicate key|unique constraint|unique violation|already exists/i.test(msg)) {\n            const base = baseInsert.slug || slugify(ext.title);\n            const newSlug = await ensureUniqueSlug(supabase, base);\n            const retry = { ...baseInsert, slug: newSlug };\n            const { data: ins2, error: err2 } = await supabase\n              .from('products')\n              .insert(retry)\n              .select('id')\n              .single();\n            if (err2 || !ins2) throw err2 || new Error('Failed to insert product (retry)');\n            productId = ins2.id as number;\n          } else {\n            throw e;\n          }\n        }\n\n        // Optional update with pruned fields if any remain\n        const optionalUpdate: Record<string, any> = { ...productPayload };\n        delete optionalUpdate.title;\n        delete optionalUpdate.slug;\n        delete optionalUpdate.price;\n        delete optionalUpdate.category;\n        delete optionalUpdate.stock;\n\n        await omitMissingProductColumns(supabase, optionalUpdate, [\n          'images', 'description', 'video_url', 'processing_time_hours', 'delivery_time_hours', 'origin_area',\n          'origin_country_code', 'free_shipping', 'inventory_shipping_fee', 'last_mile_fee', 'shipping_from',\n          'cj_product_id', 'is_active'\n        ]);\n        const keysLeft = Object.keys(optionalUpdate);\n        if (keysLeft.length > 0) {\n          await supabase.from('products').update(optionalUpdate).eq('id', productId);\n        }\n\n        let variantsInserted = false;\n        if (await productVariantsTableExists(supabase)) {\n          // One default variant placeholder; will be enriched later by API\n          const { error: vErr } = await supabase\n            .from('product_variants')\n            .insert([{ product_id: productId, option_name: 'Size', option_value: '-', cj_sku: null, price: null, stock: 0 }]);\n          if (vErr) throw vErr;\n          variantsInserted = true;\n        }\n\n        results.push({ ok: true, productId, url: u, title: ext.title, images: ext.images.length, variantsInserted });\n      } catch (e: any) {\n        results.push({ ok: false, url: u, error: e?.message || String(e) });\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, version: 'scrape-v3', imported: results.filter(r => r.ok).length, results }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, version: 'scrape-v3', error: e?.message || 'Scrape import failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":13047,"size_tokens":null},"src/app/api/cj/resync/full/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { loggerForRequest } from '@/lib/log'\nimport { createClient } from '@supabase/supabase-js'\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from '@/lib/cj/v2'\nimport { upsertProductFromCj } from '@/lib/ops/cj-sync'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nasync function resyncFullOne(db: any, id: number) {\n  const { data: p } = await db.from('products')\n    .select('id, slug, title, cj_product_id')\n    .eq('id', id)\n    .maybeSingle()\n  if (!p) return { id, ok: false, error: 'product not found' }\n\n  const pid: string | undefined = (p as any).cj_product_id || undefined\n  const keyword: string | undefined = pid ? undefined : String((p as any).title || '').split(' ').slice(0, 6).join(' ') || undefined\n\n  const raw = await queryProductByPidOrKeyword({ pid, keyword })\n  const list: any[] = Array.isArray(raw?.data?.content)\n    ? raw.data.content\n    : Array.isArray(raw?.data?.list)\n      ? raw.data.list\n      : Array.isArray(raw?.content)\n        ? raw.content\n        : Array.isArray(raw?.data)\n          ? raw.data\n          : []\n  if (!list || list.length === 0) return { id, ok: false, error: 'cj not found' }\n\n  const mapped = mapCjItemToProductLike(list[0])\n  if (!mapped) return { id, ok: false, error: 'map failed' }\n\n  const up = await upsertProductFromCj(mapped, { updateImages: true, updateVideo: true, updatePrice: true })\n  if (!('ok' in up) || !up.ok) return { id, ok: false, error: (up as any).error || 'upsert failed' }\n  return { id, ok: true, productId: up.productId, slug: p.slug }\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const db = getAdmin()\n    if (!db) {\n      const r = NextResponse.json({ ok: false, error: 'Supabase not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const { searchParams } = new URL(req.url)\n    const idsParam = searchParams.get('ids') || ''\n    const allFlag = (searchParams.get('all') || '').trim() === '1'\n    const limit = Math.max(1, Math.min(200, Number(searchParams.get('limit') || '30')))\n    let ids: number[] = []\n    if (idsParam) ids = idsParam.split(',').map((s) => Number(s.trim())).filter((n) => Number.isFinite(n) && n > 0)\n\n    // If no ids specified, pick products missing media or with price 0\n    if (ids.length === 0) {\n      const { data } = await db\n        .from('products')\n        .select('id, images, price')\n        .order('id', { ascending: false })\n        .limit(limit)\n      const candidates = (data || []) as any[]\n      ids = candidates\n        .filter((p) => p.price === 0 || !p.images || (Array.isArray(p.images) && p.images.length === 0) || (typeof p.images === 'string' && (!p.images.trim() || p.images.trim() === '[]')))\n        .slice(0, allFlag ? limit : Math.min(limit, 10))\n        .map((p) => p.id)\n    }\n\n    const results: any[] = []\n    for (const id of ids) {\n      try { results.push(await resyncFullOne(db, id)) } catch (e: any) { results.push({ id, ok: false, error: e?.message || 'resync failed' }) }\n    }\n\n    const r = NextResponse.json({ ok: true, results })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'resync full error' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":3655,"size_tokens":null},"src/app/api/admin/proposals/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { createClient } from '@supabase/supabase-js'\nimport { hasTable } from '@/lib/db-features'\nimport { recordAudit } from '@/lib/audit'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const admin = getSupabaseAdmin()\n    if (!admin) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    if (!(await hasTable('proposals'))) {\n      const r = NextResponse.json({ ok: false, error: 'proposals table missing' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const { searchParams } = new URL(req.url)\n    const status = searchParams.get('status') || undefined\n    const limit = Math.max(1, Math.min(100, Number(searchParams.get('limit') || '50')))\n    const offset = Math.max(0, Number(searchParams.get('offset') || '0'))\n\n    let q = admin.from('proposals').select('*').order('created_at', { ascending: false }).range(offset, offset + limit - 1)\n    if (status) q = q.eq('status', status)\n    const { data, error } = await q\n    if (error) {\n      const r = NextResponse.json({ ok: false, error: error.message }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const r = NextResponse.json({ ok: true, proposals: data || [] })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'list failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const admin = getSupabaseAdmin()\n    if (!admin) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    if (!(await hasTable('proposals'))) {\n      const r = NextResponse.json({ ok: false, error: 'proposals table missing' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const id = body?.id as string | undefined\n    const status = body?.status as string | undefined\n\n    if (!id || !status || !['pending','approved','rejected','executed'].includes(status)) {\n      const r = NextResponse.json({ ok: false, error: 'Provide id and valid status' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const { data, error } = await admin.from('proposals').update({ status }).eq('id', id).select('*').single()\n    if (error) {\n      const r = NextResponse.json({ ok: false, error: error.message }, { status: 500 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    try {\n      await recordAudit({ action: `proposal_${status}`, entity: 'proposal', entityId: id, userEmail: (guard as any)?.user?.email || null, userId: (guard as any)?.user?.id || null, payload: data })\n    } catch {}\n\n    const r = NextResponse.json({ ok: true, proposal: data })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'update failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4308,"size_tokens":null},"src/components/smart-image.tsx":{"content":"import Image, { ImageProps } from \"next/image\";\nimport React from \"react\";\n\nexport type SmartImageProps = Omit<\n  React.ImgHTMLAttributes<HTMLImageElement>,\n  \"src\"\n> &\n  Omit<ImageProps, \"src\" | \"alt\"> & {\n    src: string;\n    alt: string;\n    fill?: boolean;\n  };\n\nfunction isAllowedNextImage(src: string): boolean {\n  if (!src) return false;\n  const s = src.trim();\n  if (s.startsWith(\"/\")) return true; // local public assets\n  if (s.startsWith(\"data:\")) return false; // let <img> handle data URLs\n  try {\n    const u = new URL(s);\n    const host = u.hostname.toLowerCase();\n    if (host === \"res.cloudinary.com\") return true;\n    if (host.endsWith(\".supabase.co\")) return true;\n    if (host.endsWith(\".supabase.in\")) return true;\n    // Allow CJ and common Alibaba CDNs so next/image can optimize them\n    if (host === 'cjdropshipping.com' || host.endsWith('.cjdropshipping.com')) return true;\n    if (host.includes('alicdn.com') || host.includes('aliyuncs.com')) return true;\n  } catch {\n    // Non-URL strings (e.g., bucket/object); treat as not allowed for next/image\n  }\n  return false;\n}\n\nexport default function SmartImage({ src, alt, fill, className, loading, ...rest }: SmartImageProps) {\n  const canUseNext = isAllowedNextImage(src);\n  if (canUseNext) {\n    if (fill) {\n      return (\n        <Image\n          src={src}\n          alt={alt}\n          fill\n          className={className}\n          loading={loading as any}\n          sizes={(rest as any).sizes || \"(max-width: 768px) 100vw, 33vw\"}\n          priority={(rest as any).priority}\n          quality={(rest as any).quality}\n        />\n      );\n    }\n    const width = (rest as any).width ?? 800;\n    const height = (rest as any).height ?? 600;\n    return (\n      <Image\n        src={src}\n        alt={alt}\n        width={width}\n        height={height}\n        className={className}\n        loading={loading as any}\n        priority={(rest as any).priority}\n        quality={(rest as any).quality}\n      />\n    );\n  }\n  return <img src={src} alt={alt} className={className} loading={loading as any} {...(rest as any)} />;\n}\n","path":null,"size_bytes":2096,"size_tokens":null},"src/lib/products.ts":{"content":"// Product utility functions\n// Note: Product fetching is primarily done via Supabase queries in components/pages.\n// This file provides shared product utilities if needed.\n\nimport type { Product } from './types';\n\n/**\n * Format product price for display\n */\nexport function formatProductPrice(price: number, currency: string = 'SAR'): string {\n  return new Intl.NumberFormat('ar-SA', {\n    style: 'currency',\n    currency,\n    minimumFractionDigits: 2,\n  }).format(price);\n}\n\n/**\n * Check if a product is in stock\n */\nexport function isInStock(product: Product): boolean {\n  return (product.stock ?? 0) > 0;\n}\n\n/**\n * Get the primary image URL for a product\n */\nexport function getPrimaryImage(product: Product): string | null {\n  return product.images?.length > 0 ? product.images[0] : null;\n}\n\n","path":null,"size_bytes":797,"size_tokens":null},"src/app/login/auth-form.tsx":{"content":"\"use client\"\n\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\"\nimport { useMemo, useState, useTransition } from \"react\"\nimport { useSearchParams } from \"next/navigation\"\nimport { Facebook, Smartphone, Eye, EyeOff } from \"lucide-react\"\n\ntype Step = \"email\" | \"password\" | \"verify_code\" | \"onboarding\" | \"phone\"\n\nexport default function AuthForm() {\n  const supabase = createClientComponentClient()\n  const searchParams = useSearchParams()\n  const nextParam = (searchParams?.get(\"redirect\") || searchParams?.get(\"next\") || \"/\").toString()\n  const safeNext = nextParam.startsWith(\"/\") && !nextParam.startsWith(\"//\") ? nextParam : \"/\"\n  const base = (process.env.NEXT_PUBLIC_SITE_URL && process.env.NEXT_PUBLIC_SITE_URL.trim().length > 0)\n    ? process.env.NEXT_PUBLIC_SITE_URL\n    : (typeof window !== \"undefined\" ? window.location.origin : \"\")\n  const redirectTo = base ? `${base.replace(/\\/$/, \"\")}/auth/callback` : \"/auth/callback\"\n  const redirectWithNext = safeNext && safeNext !== \"/\" ? `${redirectTo}?next=${encodeURIComponent(safeNext)}` : redirectTo\n\n  const [step, setStep] = useState<Step>(\"email\")\n  const [email, setEmail] = useState(\"\")\n  const [password, setPassword] = useState(\"\")\n  const [showPw, setShowPw] = useState(false)\n  const [code, setCode] = useState(\"\")\n  const [fullName, setFullName] = useState(\"\")\n  const [birthday, setBirthday] = useState(\"\")\n  const [info, setInfo] = useState<string>(\"\")\n  const [error, setError] = useState<string>(\"\")\n  const [pending, startTransition] = useTransition()\n  const [emailExists, setEmailExists] = useState<boolean | null>(null)\n\n  const titleByStep = useMemo(() => {\n    switch (step) {\n      case \"email\":\n        return \"Sign In or Create Account\"\n      case \"password\":\n        return emailExists === false ? \"Create Password\" : \"Enter Password\"\n      case \"verify_code\":\n        return \"Check Your Email\"\n      case \"onboarding\":\n        return \"Tell Us About You\"\n      case \"phone\":\n        return \"Sign In with Phone\"\n      default:\n        return \"\"\n    }\n  }, [step, emailExists])\n\n  function resetMessages() {\n    setError(\"\")\n    setInfo(\"\")\n  }\n\n  function handleContinueFromEmail(e: React.FormEvent) {\n    e.preventDefault()\n    resetMessages()\n    if (!email) {\n      setError(\"Please enter your email address\")\n      return\n    }\n    startTransition(async () => {\n      try {\n        const res = await fetch(\"/api/auth/check-email\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({ email }),\n        })\n        if (res.ok) {\n          const j = await res.json()\n          if (typeof j.exists === \"boolean\") {\n            setEmailExists(j.exists)\n          } else {\n            setEmailExists(null)\n          }\n        } else {\n          setEmailExists(null)\n        }\n      } catch {\n        setEmailExists(null)\n      }\n      setStep(\"password\")\n    })\n  }\n\n  function heading(h: string) {\n    return (\n      <h2 className=\"mb-4 text-center text-2xl font-bold\">{h}</h2>\n    )\n  }\n\n  async function handlePasswordSubmit(e: React.FormEvent) {\n    e.preventDefault()\n    resetMessages()\n    if (!email || !password) {\n      setError(\"Please enter email and password\")\n      return\n    }\n\n    startTransition(async () => {\n      if (emailExists === true) {\n        const { data, error: signInErr } = await supabase.auth.signInWithPassword({ email, password })\n        if (!signInErr && data?.user) {\n          if (typeof window !== \"undefined\") window.location.replace(safeNext)\n          return\n        }\n        setError(\"Incorrect password. Please try again or use the password recovery option.\")\n        return\n      }\n\n      if (emailExists === false) {\n        if (password.length < 8) {\n          setError(\"Password must be at least 8 characters\")\n          return\n        }\n        const { error: otpErr } = await supabase.auth.signInWithOtp({\n          email,\n          options: { emailRedirectTo: redirectTo, shouldCreateUser: true },\n        })\n        if (!otpErr) {\n          setInfo(`Verification code sent to ${email}.`)\n          setStep(\"verify_code\")\n          return\n        }\n        const { error: suErr } = await supabase.auth.signUp({\n          email,\n          password,\n          options: { emailRedirectTo: redirectTo },\n        })\n        if (!suErr) {\n          setInfo(`Confirmation email sent to ${email}. Please check your inbox and click \"Confirm Email\" to complete registration.`)\n          return\n        }\n        setError(suErr?.message || otpErr?.message || \"Failed to send verification code\")\n        return\n      }\n\n      const { data, error: signInErr } = await supabase.auth.signInWithPassword({ email, password })\n      if (!signInErr && data?.user) {\n        if (typeof window !== \"undefined\") window.location.replace(safeNext)\n        return\n      }\n      const { error: otpErr2 } = await supabase.auth.signInWithOtp({\n        email,\n        options: { emailRedirectTo: redirectTo, shouldCreateUser: true },\n      })\n      if (!otpErr2) {\n        setInfo(`Verification code sent to ${email}.`)\n        setStep(\"verify_code\")\n        return\n      }\n      const { error: suErr2 } = await supabase.auth.signUp({ email, password, options: { emailRedirectTo: redirectTo } })\n      if (!suErr2) {\n        setInfo(`Confirmation email sent to ${email}. Please check your inbox and click \"Confirm Email\".`)\n        return\n      }\n      setError(suErr2?.message || otpErr2?.message || \"An unexpected error occurred\")\n    })\n  }\n\n  async function handleVerifyCode(e: React.FormEvent) {\n    e.preventDefault()\n    resetMessages()\n    if (!code || code.length < 6) {\n      setError(\"Please enter the 6-digit code\")\n      return\n    }\n\n    startTransition(async () => {\n      const { error: verifyErr } = await supabase.auth.verifyOtp({\n        email,\n        token: code,\n        type: \"email\",\n      })\n      if (verifyErr) {\n        setError(verifyErr.message)\n        return\n      }\n\n      if (emailExists === false && password && password.length >= 8) {\n        const { error: pwdErr } = await supabase.auth.updateUser({ password })\n        if (pwdErr) { setError(pwdErr.message); return }\n      }\n\n      setStep(\"onboarding\")\n    })\n  }\n\n  async function handleResend() {\n    resetMessages()\n    startTransition(async () => {\n      const { error: otpErr } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectTo, shouldCreateUser: true } })\n      if (otpErr) setError(otpErr.message)\n      else setInfo(\"Verification code resent to your email.\")\n    })\n  }\n\n  function parseBirthday(input: string): string | null {\n    const m = input.match(/^\\s*(\\d{2})\\/(\\d{2})\\/(\\d{4})\\s*$/)\n    if (!m) return null\n    const mm = Number(m[1])\n    const dd = Number(m[2])\n    const yyyy = Number(m[3])\n    const d = new Date(yyyy, mm - 1, dd)\n    if (d.getFullYear() !== yyyy || d.getMonth() !== mm - 1 || d.getDate() !== dd) return null\n    return `${yyyy.toString().padStart(4, \"0\")}-${mm.toString().padStart(2, \"0\")}-${dd.toString().padStart(2, \"0\")}`\n  }\n\n  async function handleOnboarding(e: React.FormEvent) {\n    e.preventDefault()\n    resetMessages()\n    if (!fullName.trim()) {\n      setError(\"Please enter your full name\")\n      return\n    }\n    const iso = parseBirthday(birthday)\n    if (!iso) {\n      setError(\"Please enter a valid date in MM/DD/YYYY format\")\n      return\n    }\n\n    startTransition(async () => {\n      const { error: updErr } = await supabase.auth.updateUser({\n        data: { full_name: fullName.trim(), birthday: iso },\n      })\n      if (updErr) {\n        setError(updErr.message)\n        return\n      }\n      if (typeof window !== \"undefined\") window.location.replace(safeNext === \"/\" ? \"/account\" : safeNext)\n    })\n  }\n\n  async function handleOAuth(provider: \"google\" | \"facebook\") {\n    setError(''); setInfo('')\n    const options: { redirectTo: string; scopes?: string; queryParams?: Record<string, string> } = { redirectTo: redirectWithNext }\n    if (provider === 'facebook') {\n      options.scopes = 'email public_profile'\n      options.queryParams = { auth_type: 'rerequest' }\n    }\n    if (provider === 'google') {\n      options.queryParams = { prompt: 'select_account' }\n    }\n    const { error } = await supabase.auth.signInWithOAuth({ provider, options })\n    if (error) {\n      const msg = (error.message || '').toLowerCase()\n      if (msg.includes('unsupported provider') || msg.includes('not enabled')) {\n        setError(`${provider === 'google' ? 'Google' : 'Facebook'} provider is not enabled in Supabase settings. Please enable it and add OAuth credentials.`)\n      } else {\n        setError(error.message)\n      }\n    }\n  }\n\n  const [phone, setPhone] = useState(\"\")\n  const [phoneCode, setPhoneCode] = useState(\"\")\n  const [phoneSent, setPhoneSent] = useState(false)\n\n  async function handlePhoneSend(e: React.FormEvent) {\n    e.preventDefault(); resetMessages()\n    startTransition(async () => {\n      const { error } = await supabase.auth.signInWithOtp({ phone })\n      if (error) setError(error.message); else setPhoneSent(true)\n    })\n  }\n  async function handlePhoneVerify(e: React.FormEvent) {\n    e.preventDefault(); resetMessages()\n    startTransition(async () => {\n      const { error } = await supabase.auth.verifyOtp({ phone, token: phoneCode, type: \"sms\" })\n      if (error) setError(error.message); else if (typeof window !== \"undefined\") window.location.replace(safeNext)\n    })\n  }\n\n  function PillButton({ children, variant = \"outline\", onClick, disabled }: { children: React.ReactNode; variant?: \"outline\" | \"solid\"; onClick?: () => void; disabled?: boolean }) {\n    const common = \"w-full h-12 rounded-full px-4 text-sm font-semibold transition focus:outline-none focus:ring-2 focus:ring-offset-2\"\n    const cls = variant === \"solid\"\n      ? `${common} bg-[#1a73e8] text-white hover:opacity-95 focus:ring-[#1a73e8]`\n      : `${common} border hover:bg-accent`\n    return (\n      <button type=\"button\" onClick={onClick} disabled={disabled} className={cls}>\n        <div className=\"flex items-center justify-between\">\n          {children}\n        </div>\n      </button>\n    )\n  }\n\n  return (\n    <div className=\"space-y-5\">\n      {heading(titleByStep)}\n\n      {step === \"email\" && (\n        <form onSubmit={handleContinueFromEmail} className=\"space-y-3\">\n          <div className=\"grid gap-2\">\n            <label className=\"text-sm\">Email</label>\n            <input\n              type=\"email\"\n              required\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              className=\"rounded-full border px-4 py-3\"\n              placeholder=\"example@email.com\"\n            />\n          </div>\n          <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">\n            Continue\n          </button>\n        </form>\n      )}\n\n      {step === \"password\" && (\n        <form onSubmit={handlePasswordSubmit} className=\"space-y-3\">\n          <div className=\"rounded-full bg-gray-100 px-4 py-2 text-sm text-gray-700 flex items-center justify-between\">\n            <span className=\"truncate\">{email}</span>\n            <button type=\"button\" className=\"underline\" onClick={() => setStep(\"email\")}>Edit</button>\n          </div>\n          <div className=\"grid gap-2\">\n            <label className=\"text-sm\">{emailExists === false ? \"Create Password\" : \"Password\"}</label>\n            <div className=\"relative\">\n              <input\n                type={showPw ? \"text\" : \"password\"}\n                required\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                className=\"w-full rounded-full border px-4 py-3 pr-12\"\n                placeholder=\"••••••••\"\n              />\n              <button type=\"button\" onClick={() => setShowPw((v) => !v)} className=\"absolute inset-y-0 right-3 flex items-center text-gray-500\">\n                {showPw ? <EyeOff className=\"h-5 w-5\" /> : <Eye className=\"h-5 w-5\" />}\n              </button>\n            </div>\n          </div>\n          <div className=\"flex items-center justify-between text-sm\">\n            <div />\n            {emailExists !== false && (\n              <a\n                href={`/forgot-password${safeNext && safeNext !== \"/\" ? `?next=${encodeURIComponent(safeNext)}` : \"\"}${email ? `${safeNext && safeNext !== \"/\" ? \"&\" : \"?\"}email=${encodeURIComponent(email)}` : \"\"}`}\n                className=\"text-blue-600 hover:underline\"\n              >\n                Forgot password?\n              </a>\n            )}\n          </div>\n          <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">\n            Continue\n          </button>\n          {emailExists === false && (\n            <p className=\"text-xs text-gray-500 text-center\">A new account will be created for this email.</p>\n          )}\n        </form>\n      )}\n\n      {step === \"verify_code\" && (\n        <form onSubmit={handleVerifyCode} className=\"space-y-3\">\n          <p className=\"text-center text-sm text-gray-600\">Enter the verification code we sent to {email}</p>\n          <input\n            inputMode=\"numeric\"\n            pattern=\"[0-9]*\"\n            maxLength={6}\n            required\n            value={code}\n            onChange={(e) => setCode(e.target.value)}\n            className=\"w-full rounded-full border px-4 py-3 text-center tracking-widest\"\n            placeholder=\"Code\"\n          />\n          <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">\n            Continue\n          </button>\n          <div className=\"text-center\">\n            <button type=\"button\" onClick={handleResend} className=\"text-sm text-blue-600 hover:underline\">Resend Email</button>\n          </div>\n        </form>\n      )}\n\n      {step === \"onboarding\" && (\n        <form onSubmit={handleOnboarding} className=\"space-y-4\">\n          <div className=\"grid gap-2\">\n            <label className=\"text-sm\">Full Name</label>\n            <input\n              type=\"text\"\n              required\n              value={fullName}\n              onChange={(e) => setFullName(e.target.value)}\n              className=\"rounded-full border px-4 py-3\"\n              placeholder=\"Full Name\"\n            />\n          </div>\n          <div className=\"grid gap-2\">\n            <label className=\"text-sm\">Date of Birth</label>\n            <input\n              type=\"text\"\n              required\n              value={birthday}\n              onChange={(e) => setBirthday(e.target.value)}\n              className=\"rounded-full border px-4 py-3\"\n              placeholder=\"MM/DD/YYYY\"\n            />\n          </div>\n          <p className=\"text-xs text-gray-600 text-center\">\n            By clicking \"Continue\", you agree to our Terms of Service and have read our Privacy Policy.\n          </p>\n          <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">\n            Continue\n          </button>\n        </form>\n      )}\n\n      {step === \"email\" && (\n        <div className=\"flex items-center gap-4 text-sm text-gray-500\">\n          <div className=\"h-px flex-1 bg-gray-200\" />\n          <span>or</span>\n          <div className=\"h-px flex-1 bg-gray-200\" />\n        </div>\n      )}\n\n      {step === \"email\" && (\n        <div className=\"space-y-3\">\n          <PillButton variant=\"solid\" onClick={() => handleOAuth(\"google\")} disabled={pending}>\n            <GoogleIcon />\n            <span className=\"flex-1 text-center\">Continue with Google</span>\n          </PillButton>\n          <PillButton onClick={() => handleOAuth(\"facebook\")} disabled={pending}>\n            <Facebook className=\"h-5 w-5 text-[#1877f2]\" />\n            <span className=\"flex-1 text-center\">Continue with Facebook</span>\n          </PillButton>\n          <PillButton onClick={() => setStep(\"phone\")} disabled={pending}>\n            <Smartphone className=\"h-5 w-5\" />\n            <span className=\"flex-1 text-center\">Continue with Phone</span>\n          </PillButton>\n        </div>\n      )}\n\n      {step === \"phone\" && (\n        <div className=\"space-y-3\">\n          <form onSubmit={handlePhoneSend} className=\"grid gap-2\">\n            <label className=\"text-sm\">Phone Number (e.g., +1555xxxxxxx)</label>\n            <input type=\"tel\" required value={phone} onChange={(e) => setPhone(e.target.value)} className=\"rounded-full border px-4 py-3\" />\n            <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">Send Code</button>\n          </form>\n          {phoneSent && (\n            <form onSubmit={handlePhoneVerify} className=\"grid gap-2\">\n              <label className=\"text-sm\">Enter Verification Code</label>\n              <input inputMode=\"numeric\" pattern=\"[0-9]*\" maxLength={6} required value={phoneCode} onChange={(e) => setPhoneCode(e.target.value)} className=\"rounded-full border px-4 py-3\" />\n              <button disabled={pending} className=\"w-full h-12 rounded-full bg-black text-white text-sm font-semibold hover:opacity-95\">Confirm</button>\n            </form>\n          )}\n          <div className=\"text-center\">\n            <button type=\"button\" className=\"text-sm text-blue-600 hover:underline\" onClick={() => setStep(\"email\")}>Back</button>\n          </div>\n        </div>\n      )}\n\n      {(error || info) && (\n        <div className=\"space-y-2\">\n          {error && <div className=\"rounded-md border border-destructive bg-destructive/10 p-2 text-sm text-destructive\">{error}</div>}\n          {info && <div className=\"rounded-md border border-emerald-500 bg-emerald-50 p-2 text-sm text-emerald-700\">{info}</div>}\n        </div>\n      )}\n    </div>\n  )\n}\n\nfunction GoogleIcon() {\n  return (\n    <svg width=\"20\" height=\"20\" viewBox=\"0 0 48 48\" aria-hidden className=\"mr-1\">\n      <path fill=\"#FFC107\" d=\"M43.6 20.5H42V20H24v8h11.3C33.9 33.7 29.4 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.3 0 6.3 1.2 8.6 3.2l5.7-5.7C34.6 5.1 29.6 3 24 3 12.4 3 3 12.4 3 24s9.4 21 21 21 21-9.4 21-21c0-1.2-.1-2.3-.4-3.5z\"/>\n      <path fill=\"#FF3D00\" d=\"M6.3 14.7l6.6 4.8C14.7 16.2 18.9 13 24 13c3.3 0 6.3 1.2 8.6 3.2l5.7-5.7C34.6 5.1 29.6 3 24 3 15.3 3 7.8 8.1 6.3 14.7z\"/>\n      <path fill=\"#4CAF50\" d=\"M24 45c5.3 0 10.2-2 13.8-5.2l-6.4-5.3C29.2 35.7 26.8 36.5 24 36.5 18.7 36.5 14.1 33.1 12.4 28l-6.4 5C8.4 39.9 15.6 45 24 45c9.9 0 18.4-6.9 21-16.1.3-1.2.4-2.3.4-3.5 0-1-.1-1.9-.3-2.9z\"/>\n      <path fill=\"#1976D2\" d=\"M43.6 20.5H42V20H24v8h11.3c-1.6 4.7-6 8-11.3 8-5.3 0-9.9-3.4-11.6-8.5l-6.4 5C8.4 39.9 15.6 45 24 45c9.9 0 18.4-6.9 21-16.1.3-1.2.4-2.3.4-3.5 0-1-.1-1.9-.3-2.9z\"/>\n    </svg>\n  )\n}\n","path":null,"size_bytes":18828,"size_tokens":null},"src/components/__tests__/logo.test.tsx":{"content":"import { render, screen } from '@testing-library/react'\nimport Logo from '../logo'\n \ndescribe('Logo Component', () => {\n  it('should render the logo text', () => {\n    render(<Logo />)\n \n    const logoElement = screen.getByText(/Shopixo/i)\n    expect(logoElement).toBeInTheDocument()\n  })\n \n  it('should link to the homepage', () => {\n    render(<Logo />)\n \n    const linkElement = screen.getByRole('link', { name: /Shopixo/i })\n    expect(linkElement).toHaveAttribute('href', '/')\n  })\n})\n","path":null,"size_bytes":490,"size_tokens":null},"src/app/about/page.tsx":{"content":"export const metadata = { title: \"About Us\" };\n\nexport default function AboutPage() {\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">About Us</h1>\n      <div className=\"mt-4 space-y-4 text-slate-700\">\n        <p>\n          Shopixo is a modern e-commerce store focused on product quality, secure payments, and an enjoyable shopping experience.\n        </p>\n        <p>\n          Our goal is to provide a professional, fast, and convenient shopping journey with clear policies and excellent customer support.\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":604,"size_tokens":null},"playwright.config.ts":{"content":"import { defineConfig, devices } from '@playwright/test';\n\n/**\n * Read environment variables from file.\n * https://github.com/motdotla/dotenv\n */\n// import dotenv from 'dotenv';\n// import path from 'path';\n// dotenv.config({ path: path.resolve(__dirname, '.env') });\n\n/**\n * See https://playwright.dev/docs/test-configuration.\n */\nexport default defineConfig({\n  testDir: './e2e',\n  /* Run tests in files in parallel */\n  fullyParallel: true,\n  /* Fail the build on CI if you accidentally left test.only in the source code. */\n  forbidOnly: !!process.env.CI,\n  /* Retry on CI only */\n  retries: process.env.CI ? 2 : 0,\n  /* Opt out of parallel tests on CI. */\n  workers: process.env.CI ? 1 : undefined,\n  /* Reporter to use. See https://playwright.dev/docs/test-reporters */\n  reporter: 'html',\n  /* Shared settings for all the projects below. See https://playwright.dev/docs/api/class-testoptions. */\n  use: {\n    /* Base URL to use in actions like `await page.goto('/')`. */\n    // baseURL: 'http://localhost:3000',\n\n    /* Collect trace when retrying the failed test. See https://playwright.dev/docs/trace-viewer */\n    trace: 'on-first-retry',\n  },\n\n  /* Configure projects for major browsers */\n  projects: [\n    {\n      name: 'chromium',\n      use: { ...devices['Desktop Chrome'] },\n    },\n\n    {\n      name: 'firefox',\n      use: { ...devices['Desktop Firefox'] },\n    },\n\n    {\n      name: 'webkit',\n      use: { ...devices['Desktop Safari'] },\n    },\n\n    /* Test against mobile viewports. */\n    // {\n    //   name: 'Mobile Chrome',\n    //   use: { ...devices['Pixel 5'] },\n    // },\n    // {\n    //   name: 'Mobile Safari',\n    //   use: { ...devices['iPhone 12'] },\n    // },\n\n    /* Test against branded browsers. */\n    // {\n    //   name: 'Microsoft Edge',\n    //   use: { ...devices['Desktop Edge'], channel: 'msedge' },\n    // },\n    // {\n    //   name: 'Google Chrome',\n    //   use: { ...devices['Desktop Chrome'], channel: 'chrome' },\n    // },\n  ],\n\n  /* Run your local dev server before starting the tests */\n  webServer: {\n    command: 'npm run dev',\n    url: 'http://localhost:3000',\n    reuseExistingServer: !process.env.CI,\n  },\n});\n","path":null,"size_bytes":2159,"size_tokens":null},"src/lib/env.ts":{"content":"import { z } from 'zod'\n\nconst EnvSchema = z.object({\n  NEXT_PUBLIC_SUPABASE_URL: z.string().url().optional(),\n  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1).optional(),\n  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1).optional(),\n  STRIPE_SECRET_KEY: z.string().min(1).optional(),\n  STRIPE_WEBHOOK_SECRET: z.string().min(1).optional(),\n  CJ_WEBHOOK_SECRET: z.string().min(1).optional(),\n  RESEND_API_KEY: z.string().min(1).optional(),\n  NEXT_PUBLIC_SITE_URL: z.string().url().optional(),\n  ADMIN_EMAILS: z.string().optional(),\n  ADMIN_EMAIL_DOMAINS: z.string().optional(),\n  OPENAI_API_KEY: z.string().min(1).optional(),\n  AI_MODEL_TEXT: z.string().optional(),\n})\n\nexport type Env = z.infer<typeof EnvSchema>\n\nexport const env: Env = EnvSchema.parse(process.env as any)\n\nexport function ensureEnv<K extends keyof Env>(keys: K[]): { ok: boolean; missing: K[] } {\n  const missing = keys.filter((k) => !env[k])\n  return { ok: missing.length === 0, missing }\n}\n\nexport function getEnv<K extends keyof Env>(key: K): Env[K] {\n  return env[key]\n}\n\nexport function parseCommaList(v?: string | null): string[] {\n  if (!v) return []\n  return v.split(',').map((s) => s.trim()).filter(Boolean)\n}\n\nexport const adminEmailList = () => parseCommaList(env.ADMIN_EMAILS)\nexport const adminDomainList = () => parseCommaList(env.ADMIN_EMAIL_DOMAINS).map(d => d.replace(/^@/, ''))\n","path":null,"size_bytes":1364,"size_tokens":null},"src/app/account/addresses/loading.tsx":{"content":"import LoadingSpinner from \"@/components/loading-spinner\";\n\nexport default function Loading() {\n  return <LoadingSpinner text=\"Loading your addresses...\" />;\n}\n","path":null,"size_bytes":160,"size_tokens":null},"src/app/api/newsletter/subscribe/route.ts":{"content":"import { NextResponse, type NextRequest } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { marketingLimiter, getClientIp } from '@/lib/ratelimit'\nimport { loggerForRequest } from '@/lib/log'\n\nexport const dynamic = 'force-dynamic'\nexport const runtime = 'nodejs'\n\nfunction isEmail(s: unknown): s is string {\n  if (typeof s !== 'string') return false\n  const v = s.trim()\n  if (!v) return false\n  // Simple RFC-compliant-ish pattern\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v)\n}\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req)\n  // Rate limit\n  try {\n    const ip = getClientIp(req as unknown as Request)\n    const lim = await marketingLimiter.limit(`newsletter:${ip}`)\n    if (!lim.success) {\n      const r = NextResponse.json({ ok: false, error: 'rate_limited' }, { status: 429 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n  } catch {}\n\n  const json = await req.json().catch(() => null) as any\n  const email = json?.email\n  if (!isEmail(email)) {\n    const r = NextResponse.json({ ok: false, error: 'invalid_email' }, { status: 400 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n\n  // Try to persist to Supabase (server-side) if service key configured\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (url && service) {\n    try {\n      const admin = createClient(url, service, { auth: { autoRefreshToken: false, persistSession: false } })\n      // Use a generic table name; if not present, swallow error safely\n      const { error } = await admin.from('newsletter_subscribers').insert({ email }).single()\n      if (error && !String(error.message || '').toLowerCase().includes('relation')) {\n        // Unknown failure other than table missing\n        console.warn('[newsletter] insert failed', error.message)\n      }\n    } catch (e) {\n      console.warn('[newsletter] supabase insert error', e)\n    }\n  }\n\n  const r = NextResponse.json({ ok: true })\n  r.headers.set('x-request-id', log.requestId)\n  return r\n}\n","path":null,"size_bytes":2096,"size_tokens":null},"src/app/api/admin/scanner/watch/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { createClient } from '@supabase/supabase-js'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nfunction getAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !key) return null\n  return createClient(url, key)\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const db = getAdmin()\n    if (!db) return NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n    const { data, error } = await db.from('cj_inventory_watch').select('*').order('created_at', { ascending: false })\n    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 500 })\n    return NextResponse.json({ ok: true, watch: data || [] })\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'watch list failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const db = getAdmin()\n    if (!db) return NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const row = {\n      cj_product_id: String(body.cj_product_id || '').trim(),\n      cj_sku: (body.cj_sku ? String(body.cj_sku).trim() : null) as string | null,\n      threshold_low: typeof body.threshold_low === 'number' ? Math.max(0, Math.floor(body.threshold_low)) : 0,\n      price_change_threshold: typeof body.price_change_threshold === 'number' ? Math.max(0, Math.floor(body.price_change_threshold)) : 5,\n      watch_price: body.watch_price !== false,\n      watch_stock: body.watch_stock !== false,\n    }\n    if (!row.cj_product_id) return NextResponse.json({ ok: false, error: 'cj_product_id required' }, { status: 400 })\n    const { error } = await db.from('cj_inventory_watch').upsert(row, { onConflict: 'cj_product_id, cj_sku' })\n    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 500 })\n    return NextResponse.json({ ok: true })\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'watch upsert failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n\nexport async function DELETE(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const db = getAdmin()\n    if (!db) return NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 })\n    const { searchParams } = new URL(req.url)\n    const pid = searchParams.get('cj_product_id') || ''\n    const sku = searchParams.get('cj_sku') || ''\n    if (!pid) return NextResponse.json({ ok: false, error: 'cj_product_id required' }, { status: 400 })\n    const q = db.from('cj_inventory_watch').delete().eq('cj_product_id', pid)\n    const exec = sku ? q.eq('cj_sku', sku) : q.is('cj_sku', null)\n    const { error } = await exec\n    if (error) return NextResponse.json({ ok: false, error: error.message }, { status: 500 })\n    return NextResponse.json({ ok: true })\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'watch delete failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":4190,"size_tokens":null},"src/app/api/auth/check-email/route.ts":{"content":"import { NextResponse, type NextRequest } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { z } from 'zod'\nimport { authLimiter, getClientIp } from '@/lib/ratelimit'\nimport { loggerForRequest } from '@/lib/log'\n\nexport const dynamic = 'force-dynamic'\nexport const runtime = 'nodejs'\n\nconst BodySchema = z.object({ email: z.string().email() })\n\nexport async function POST(req: NextRequest) {\n  const log = loggerForRequest(req)\n  // Rate limit per IP\n  try {\n    const ip = getClientIp(req as unknown as Request)\n    const lim = await authLimiter.limit(`auth:chk:${ip}`)\n    if (!lim.success) {\n      const r = NextResponse.json({ error: 'rate_limited' }, { status: 429 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n  } catch {\n    // noop (no limiter in local/dev)\n  }\n\n  let email: string\n  try {\n    const json = await req.json()\n    ;({ email } = BodySchema.parse(json))\n  } catch {\n    const r = NextResponse.json({ error: 'invalid_payload' }, { status: 400 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL\n  const service = process.env.SUPABASE_SERVICE_ROLE_KEY\n  if (!url || !service) {\n    // Without service key we cannot check; return 200 with unknown\n    const r = NextResponse.json({ exists: null }, { status: 200 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n\n  const admin = createClient(url, service, { auth: { autoRefreshToken: false, persistSession: false } })\n\n  try {\n    // Use generateLink with type 'recovery' which does not send an email here\n    const { error } = await admin.auth.admin.generateLink({ type: 'recovery', email })\n    if (!error) {\n      const r = NextResponse.json({ exists: true })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const msg = (error.message || '').toLowerCase()\n    if (msg.includes('not found')) {\n      const r = NextResponse.json({ exists: false })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const r = NextResponse.json({ error: 'unknown_error' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch {\n    const r = NextResponse.json({ error: 'server_error' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2358,"size_tokens":null},"jest.config.js":{"content":"// DEPRECATED: This CommonJS config is retained only for compatibility with certain IDEs.\n// The authoritative Jest config is jest.config.mjs (ESM) and is used by package.json scripts.\nconst nextJest = require('next/jest');\n\nconst createJestConfig = nextJest({\n  dir: './',\n});\n\n/** @type {import('jest').Config} */\nconst customJestConfig = {\n  testEnvironment: 'jest-environment-jsdom',\n  setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],\n  moduleNameMapper: {\n    '^@/(.*)$': '<rootDir>/src/$1',\n  },\n  testPathIgnorePatterns: ['/node_modules/', '/.next/', '/e2e/'],\n};\n\nmodule.exports = createJestConfig(customJestConfig);\n","path":null,"size_bytes":625,"size_tokens":null},"e2e/prod-smoke.spec.ts":{"content":"import { test, expect, request } from '@playwright/test';\n\n// Production smoke tests hitting the live site\nconst base = process.env.E2E_BASE_URL || 'https://shopixo.vercel.app';\n\ntest.describe('Production Smoke', () => {\n  test('home loads', async ({ page }) => {\n    const resp = await page.goto(base + '/');\n    expect(resp?.ok()).toBeTruthy();\n    // Expect to see Sign In link (public header) in Arabic or English\n    await expect(page.getByRole('link', { name: /(?:تسجيل الدخول|sign in)/i })).toBeVisible();\n  });\n\n  test('login page loads', async ({ page }) => {\n    const resp = await page.goto(base + '/login');\n    expect(resp?.ok()).toBeTruthy();\n    await expect(page.getByRole('heading', { name: /(?:تسجيل الدخول|log in)/i })).toBeVisible();\n  });\n\n  test('health endpoint is ok', async () => {\n    const api = await request.newContext();\n    const res = await api.get(base + '/api/health');\n    expect(res.status()).toBe(200);\n    const json = await res.json();\n    expect(json.ok).toBeTruthy();\n  });\n\n  test('not-found returns 404', async ({ page }) => {\n    const resp = await page.goto(base + '/definitely-not-a-real-page-xyz');\n    expect(resp?.status()).toBe(404);\n  });\n\n  test('account security requires auth (redirects to login or returns 404)', async ({ page }) => {\n    const resp = await page.goto(base + '/account/security');\n    const status = resp?.status();\n    if (status === 404) {\n      // Some deployments may hide protected routes by returning 404 when unauthenticated\n      expect(status).toBe(404);\n      return;\n    }\n    // Otherwise we expect a redirect (final URL contains /login)\n    await expect(page).toHaveURL(/\\/login/);\n    await expect(page.getByRole('heading', { name: /(?:تسجيل الدخول|log in)/i })).toBeVisible();\n  });\n});\n","path":null,"size_bytes":1806,"size_tokens":null},"next-env.d.ts":{"content":"/// <reference types=\"next\" />\n/// <reference types=\"next/image-types/global\" />\n/// <reference types=\"next/navigation-types/compat/navigation\" />\n\n// NOTE: This file should not be edited\n// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.\n","path":null,"size_bytes":294,"size_tokens":null},"src/app/admin/console/proposals/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype Proposal = {\n  id: string;\n  created_at: string;\n  status: \"pending\"|\"approved\"|\"rejected\"|\"executed\";\n  action_type?: string | null;\n  entity_type?: string | null;\n  entity_id?: string | null;\n  score?: number | null;\n  reasons?: any;\n  impact?: any;\n  payload?: any;\n  mode?: string | null;\n  tags?: string[] | null;\n};\n\ntype ListResp = { ok: boolean; proposals?: Proposal[]; error?: string };\n\ntype UpdateResp = { ok: boolean; proposal?: Proposal; error?: string };\n\nexport default function ProposalsPage() {\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [status, setStatus] = useState<string>('pending');\n  const [rows, setRows] = useState<Proposal[]>([]);\n  const [actingId, setActingId] = useState<string | null>(null);\n\n  async function load() {\n    setLoading(true); setError(null);\n    try {\n      const r = await fetch(`/api/admin/proposals?status=${encodeURIComponent(status)}`, { cache: 'no-store' });\n      const j: ListResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setRows(j.proposals || []);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to load proposals');\n      setRows([]);\n    } finally { setLoading(false); }\n  }\n\n  async function update(id: string, nextStatus: Proposal['status']) {\n    setActingId(id); setError(null);\n    try {\n      const r = await fetch('/api/admin/proposals', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id, status: nextStatus }) });\n      const j: UpdateResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await load();\n    } catch (e: any) {\n      setError(e?.message || 'Failed to update proposal');\n    } finally { setActingId(null); }\n  }\n\n  useEffect(() => { load(); }, [status]);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Proposals</h1>\n        <Link href=\"/admin/console\" className=\"text-sm text-blue-600 hover:underline\">Back to Console</Link>\n      </div>\n\n      <div className=\"flex items-center gap-3\">\n        {['pending','approved','rejected','executed'].map(s => (\n          <button key={s} onClick={() => setStatus(s)} disabled={loading} className={`rounded px-3 py-1.5 text-sm border ${status===s?\"bg-blue-600 text-white border-blue-600\":\"bg-white text-blue-700 border-blue-300 hover:bg-blue-50\"}`}>{s}</button>\n        ))}\n      </div>\n\n      {error && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <div className=\"rounded border bg-white overflow-auto\">\n        <table className=\"min-w-full text-sm\">\n          <thead>\n            <tr className=\"bg-muted\">\n              <th className=\"p-2 text-left\">ID</th>\n              <th className=\"p-2 text-left\">Created</th>\n              <th className=\"p-2 text-left\">Action</th>\n              <th className=\"p-2 text-left\">Entity</th>\n              <th className=\"p-2 text-left\">Score</th>\n              <th className=\"p-2 text-left\">Reasons</th>\n              <th className=\"p-2 text-left\">Impact</th>\n              <th className=\"p-2 text-left\">Mode</th>\n              <th className=\"p-2 text-left\">Status</th>\n              <th className=\"p-2 text-right\">Actions</th>\n            </tr>\n          </thead>\n          <tbody>\n            {(rows || []).map((p) => (\n              <tr key={p.id} className=\"border-t align-top\">\n                <td className=\"p-2 font-mono text-xs\">{p.id.slice(0,8)}…</td>\n                <td className=\"p-2\">{new Date(p.created_at).toLocaleString()}</td>\n                <td className=\"p-2\">{p.action_type || '-'}</td>\n                <td className=\"p-2\">{p.entity_type || '-'} {p.entity_id ? `#${p.entity_id}` : ''}</td>\n                <td className=\"p-2\">{typeof p.score === 'number' ? p.score.toFixed(2) : '-'}</td>\n                <td className=\"p-2\"><pre className=\"max-w-[300px] whitespace-pre-wrap break-words text-xs\">{p.reasons ? JSON.stringify(p.reasons) : '-'}</pre></td>\n                <td className=\"p-2\"><pre className=\"max-w-[300px] whitespace-pre-wrap break-words text-xs\">{p.impact ? JSON.stringify(p.impact) : '-'}</pre></td>\n                <td className=\"p-2\">{p.mode || '-'}</td>\n                <td className=\"p-2\">{p.status}</td>\n                <td className=\"p-2 text-right\">\n                  <div className=\"flex gap-2 justify-end\">\n                    <button onClick={() => update(p.id, 'approved')} disabled={actingId===p.id || loading} className=\"rounded bg-green-600 px-2 py-1 text-white text-xs hover:bg-green-700\">Approve</button>\n                    <button onClick={() => update(p.id, 'rejected')} disabled={actingId===p.id || loading} className=\"rounded bg-amber-600 px-2 py-1 text-white text-xs hover:bg-amber-700\">Reject</button>\n                    <button onClick={() => update(p.id, 'executed')} disabled={actingId===p.id || loading} className=\"rounded bg-blue-600 px-2 py-1 text-white text-xs hover:bg-blue-700\">Mark Executed</button>\n                  </div>\n                </td>\n              </tr>\n            ))}\n            {(!rows || rows.length === 0) && !loading && (\n              <tr><td colSpan={10} className=\"p-4 text-center text-sm text-muted-foreground\">No proposals</td></tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n\n      {loading && <div className=\"text-sm text-gray-500\">Loading…</div>}\n    </div>\n  );\n}\n","path":null,"size_bytes":5706,"size_tokens":null},"src/components/sign-out-button.tsx":{"content":"\"use client\";\n\nimport { createClientComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { useRouter } from \"next/navigation\";\nimport { DropdownMenuItem } from \"@/components/ui/dropdown-menu\";\n\nexport default function SignOutButton() {\n  const router = useRouter();\n  const supabase = createClientComponentClient();\n\n  const handleSignOut = async () => {\n    await supabase.auth.signOut();\n    router.push(\"/\");\n    router.refresh();\n  };\n\n  return <DropdownMenuItem onClick={handleSignOut}>Sign Out</DropdownMenuItem>;\n}\n","path":null,"size_bytes":532,"size_tokens":null},"src/app/api/admin/scanner/settings/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { getSetting, setSetting } from '@/lib/settings'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nconst KEY = 'scanner_settings'\n\nexport type ScannerSettings = {\n  enabled: boolean\n  daily_report_time?: string | null // e.g., '09:00' (24h, project timezone)\n  low_stock_threshold?: number | null // e.g., 5\n  price_change_threshold?: number | null // e.g., 5 (percent)\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const s = await getSetting<ScannerSettings>(KEY, { enabled: false, daily_report_time: '09:00', low_stock_threshold: 5, price_change_threshold: 5 })\n    const r = NextResponse.json({ ok: true, settings: s })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'scanner settings failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    let body: any = {}\n    try { body = await req.json() } catch {}\n\n    const next: ScannerSettings = {\n      enabled: !!body.enabled,\n      daily_report_time: body.daily_report_time ?? null,\n      low_stock_threshold: typeof body.low_stock_threshold === 'number' ? Math.max(0, Math.floor(body.low_stock_threshold)) : null,\n      price_change_threshold: typeof body.price_change_threshold === 'number' ? Math.max(0, body.price_change_threshold) : null,\n    }\n    await setSetting(KEY, next)\n    const r = NextResponse.json({ ok: true, settings: next })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'save failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2483,"size_tokens":null},"src/app/account/layout.tsx":{"content":"import Link from \"next/link\";\nimport { ReactNode } from \"react\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function AccountLayout({ children }: { children: ReactNode }) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n\n  if (!user) {\n    redirect(\"/login?next=/account\");\n  }\n\n  const navItems = [\n    { href: { pathname: \"/account\" }, label: \"Overview\" },\n    { href: { pathname: \"/account/orders\" }, label: \"Orders\" },\n    { href: { pathname: \"/account/addresses\" }, label: \"Addresses\" },\n    { href: { pathname: \"/account/coupons\" }, label: \"Coupons\" },\n    { href: { pathname: \"/account/reviews\" }, label: \"Reviews\" },\n    { href: { pathname: \"/account/security\" }, label: \"Security\" },\n    { href: { pathname: \"/account/notifications\" }, label: \"Notifications\" },\n  ];\n\n  return (\n    <div className=\"container mx-auto py-8\">\n      {/* Mobile: compact header + horizontal chips nav */}\n      <div className=\"md:hidden space-y-3 mb-4\">\n        <div className=\"rounded-lg border bg-white p-4\">\n          <p className=\"text-sm text-gray-500\">Signed in as</p>\n          <p className=\"font-semibold truncate\">{user.email}</p>\n        </div>\n        <nav className=\"overflow-x-auto whitespace-nowrap\">\n          <ul className=\"flex items-center gap-2\">\n            {navItems.map((item) => (\n              <li key={item.label}>\n                <Link\n                  className=\"inline-block rounded-full border px-3 py-1.5 text-sm text-foreground/80 hover:text-foreground bg-white\"\n                  href={item.href}\n                >\n                  {item.label}\n                </Link>\n              </li>\n            ))}\n          </ul>\n        </nav>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-12 gap-6\">\n        {/* Desktop/Tablet: sticky sidebar */}\n        <aside className=\"hidden md:block md:col-span-3 bg-white rounded-lg border p-4 h-fit sticky top-6\">\n          <div className=\"mb-6\">\n            <p className=\"text-sm text-gray-500\">Signed in as</p>\n            <p className=\"font-semibold truncate\">{user.email}</p>\n          </div>\n          <nav>\n            <ul className=\"space-y-2\">\n              {navItems.map((item) => (\n                <li key={item.label}>\n                  <Link className=\"block w-full px-3 py-2 rounded hover:bg-gray-100\" href={item.href}>\n                    {item.label}\n                  </Link>\n                </li>\n              ))}\n            </ul>\n          </nav>\n        </aside>\n        <main className=\"md:col-span-9\">{children}</main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2832,"size_tokens":null},"src/components/footer.tsx":{"content":"import Link from \"next/link\";\nimport {\n  Facebook,\n  Instagram,\n  Twitter,\n  Youtube,\n  ShieldCheck,\n  Apple,\n  Play,\n  Mail,\n  Phone,\n  MapPin,\n} from \"lucide-react\";\n\nconst storeName = process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\";\n\nconst socials = [\n  { name: \"Facebook\", href: process.env.NEXT_PUBLIC_SOCIAL_FACEBOOK, Icon: Facebook },\n  { name: \"Instagram\", href: process.env.NEXT_PUBLIC_SOCIAL_INSTAGRAM, Icon: Instagram },\n  { name: \"Twitter\", href: process.env.NEXT_PUBLIC_SOCIAL_TWITTER, Icon: Twitter },\n  { name: \"YouTube\", href: process.env.NEXT_PUBLIC_SOCIAL_YOUTUBE, Icon: Youtube },\n].filter((s) => !!s.href);\n\nfunction Badge({ children }: { children: React.ReactNode }) {\n  return (\n    <span className=\"inline-flex items-center rounded-md border border-white/10 bg-white/5 px-2.5 py-1 text-xs text-slate-200\">\n      {children}\n    </span>\n  );\n}\n\nexport default function Footer() {\n  return (\n    <footer className=\"mt-12 border-t bg-[hsl(var(--secondary))] text-white\">\n      <div className=\"container py-10\">\n        {/* Top grid */}\n        <div className=\"grid gap-8 md:grid-cols-2 lg:grid-cols-4\">\n          {/* About / Brand */}\n          <div>\n            <h3 className=\"mb-3 text-lg font-semibold\">\n              <span className=\"text-[hsl(var(--primary))]\">{storeName}</span>\n            </h3>\n            <p className=\"mb-4 text-sm leading-6 text-white/80\">\n              A modern store offering carefully curated products with an easy and secure shopping experience.\n            </p>\n            <ul className=\"space-y-2 text-sm\">\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/about\">About Us</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/contact\">Contact Us</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/blog\">Blog</Link></li>\n            </ul>\n          </div>\n\n          {/* Help */}\n          <div>\n            <h3 className=\"mb-3 text-lg font-semibold text-white\">Help</h3>\n            <ul className=\"space-y-2 text-sm\">\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/faq\">FAQ</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/order-tracking\">Track Order</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/contact\">Support Center</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/privacy-policy\">Privacy Policy</Link></li>\n              <li><Link className=\"hover:text-[hsl(var(--primary))]\" href=\"/terms\">Terms of Service</Link></li>\n            </ul>\n          </div>\n\n          {/* Customer Service */}\n          <div>\n            <h3 className=\"mb-3 text-lg font-semibold text-white\">Customer Service</h3>\n            <ul className=\"space-y-2 text-sm\">\n              <li className=\"flex items-center gap-2\"><Phone size={16} className=\"text-[hsl(var(--primary))]\" /><span>Fast email support</span></li>\n              <li className=\"flex items-center gap-2\"><Mail size={16} className=\"text-[hsl(var(--primary))]\" /><a className=\"hover:text-[hsl(var(--primary))]\" href=\"mailto:support@shopixo.com\">support@shopixo.com</a></li>\n              <li className=\"flex items-center gap-2\"><MapPin size={16} className=\"text-[hsl(var(--primary))]\" /><span>Shipping to most areas</span></li>\n            </ul>\n          </div>\n\n          {/* App Download (Coming soon) */}\n          <div>\n            <h3 className=\"mb-3 text-lg font-semibold text-white\">Download the App</h3>\n            <ul className=\"mb-4 space-y-1 text-sm text-slate-400\">\n              <li>• Track orders anytime</li>\n              <li>• Deal and price alerts</li>\n              <li>• Faster checkout</li>\n            </ul>\n            <div className=\"flex items-center gap-3\">\n              <a href=\"#\" aria-label=\"App Store (Coming soon)\" className=\"inline-flex items-center gap-2 rounded-md bg-white px-3 py-2 text-xs font-medium text-slate-900\">\n                <Apple size={16} />\n                <span>App Store</span>\n              </a>\n              <a href=\"#\" aria-label=\"Google Play (Coming soon)\" className=\"inline-flex items-center gap-2 rounded-md bg-black px-3 py-2 text-xs font-medium text-white\">\n                <Play size={16} />\n                <span>Google Play</span>\n              </a>\n            </div>\n            <p className=\"mt-2 text-[11px] text-white/70\">Coming soon to app stores</p>\n          </div>\n        </div>\n\n        {/* Divider */}\n        <div className=\"my-8 h-px w-full bg-white/15\" />\n\n        {/* Socials */}\n        {socials.length > 0 && (\n          <div className=\"mb-6 flex flex-wrap items-center justify-center gap-4\">\n            {socials.map(({ name, href, Icon }) => (\n              <a key={name} href={href as string} aria-label={name} target=\"_blank\" rel=\"noopener noreferrer\" className=\"text-white/80 transition hover:text-white\">\n                <Icon size={20} />\n              </a>\n            ))}\n          </div>\n        )}\n\n        {/* Payments & Security */}\n        <div className=\"mb-6 flex flex-wrap items-center justify-center gap-2\">\n          <Badge>Apple&nbsp;Pay</Badge>\n          <Badge>Google&nbsp;Pay</Badge>\n          <Badge>Visa</Badge>\n          <Badge>Mastercard</Badge>\n          <Badge>American&nbsp;Express</Badge>\n          <Badge>JCB</Badge>\n          <Badge>Discover</Badge>\n        </div>\n        <div className=\"mb-2 flex flex-wrap items-center justify-center gap-2 text-[12px] text-white/80\">\n          <span className=\"inline-flex items-center gap-1\"><ShieldCheck size={14} className=\"text-[hsl(var(--primary))]\" /> SSL Secure</span>\n          <span className=\"inline-flex items-center gap-1\"><ShieldCheck size={14} className=\"text-[hsl(var(--primary))]\" /> PCI DSS</span>\n          <span className=\"inline-flex items-center gap-1\"><ShieldCheck size={14} className=\"text-[hsl(var(--primary))]\" /> 3D Secure</span>\n        </div>\n\n        {/* Lower links */}\n        <div className=\"mt-6 flex flex-wrap items-center justify-center gap-6 text-sm\">\n          <Link href=\"/privacy-policy\" className=\"text-white/80 hover:text-white\">Privacy Policy</Link>\n          <Link href=\"/terms\" className=\"text-white/80 hover:text-white\">Terms of Use</Link>\n          <Link href=\"/contact\" className=\"text-white/80 hover:text-white\">Support</Link>\n        </div>\n\n        <p className=\"mt-4 text-center text-xs text-white/70\">© {new Date().getFullYear()} {storeName}. All rights reserved.</p>\n      </div>\n    </footer>\n  );\n}\n","path":null,"size_bytes":6561,"size_tokens":null},"src/app/api/cloudinary/sign/route.ts":{"content":"import crypto from \"crypto\";\nimport { NextResponse } from \"next/server\";\nimport { getClientIp, signLimiter } from \"@/lib/ratelimit\";\nimport { ensureAdmin } from \"@/lib/auth/admin-guard\";\nimport { loggerForRequest } from \"@/lib/log\";\n\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\n// Upstash Redis rate limiting is used instead of in-memory\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  log.info('cloudinary_sign_start');\n  // Require authenticated admin\n  const guard = await ensureAdmin();\n  if (!guard.ok) {\n    log.warn('cloudinary_sign_unauthorized', { reason: guard.reason });\n    const r = NextResponse.json({ ok: false, message: 'Unauthorized' }, { status: 401 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  // Rate limit (Upstash Redis)\n  try {\n    const addr = getClientIp(req);\n    const { success } = await signLimiter.limit(addr);\n    if (!success) {\n      log.warn('cloudinary_sign_rate_limited', { ip: addr });\n      const r = NextResponse.json({ ok: false, message: 'rate_limited' }, { status: 429 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n  } catch {}\n  const cloudName = process.env.CLOUDINARY_CLOUD_NAME || process.env.NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME;\n  const apiKey = process.env.CLOUDINARY_API_KEY;\n  const apiSecret = process.env.CLOUDINARY_API_SECRET;\n  const uploadPreset = process.env.CLOUDINARY_UPLOAD_PRESET || process.env.NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET;\n\n  if (!cloudName || !apiKey || !apiSecret || !uploadPreset) {\n    log.warn('cloudinary_env_missing');\n    const r = NextResponse.json({ ok: false, message: \"Cloudinary environment variables are not fully configured.\" }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n\n  const timestamp = Math.floor(Date.now() / 1000);\n  // Build the signature string in alphabetical order of params\n  // We sign at least timestamp and upload_preset; you can add folder, tags, etc. if needed.\n  const signatureBase = `timestamp=${timestamp}&upload_preset=${uploadPreset}${apiSecret}`;\n  const signature = crypto.createHash('sha1').update(signatureBase).digest('hex');\n\n  const r = NextResponse.json({ ok: true, timestamp, signature, apiKey, cloudName, uploadPreset });\n  r.headers.set('x-request-id', log.requestId);\n  return r;\n}\n","path":null,"size_bytes":2400,"size_tokens":null},"src/app/api/admin/jobs/[id]/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { getJob, cancelJob } from '@/lib/jobs';\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\n\nexport async function GET(_req: Request, ctx: { params: { id: string } }) {\n  const log = loggerForRequest(_req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const id = Number(ctx.params.id);\n    if (!Number.isFinite(id) || id <= 0) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid id' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const data = await getJob(id);\n    if (!data) {\n      const r = NextResponse.json({ ok: false, error: 'Not found' }, { status: 404 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const r = NextResponse.json({ ok: true, ...data });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'job get failed' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n\nexport async function POST(req: Request, ctx: { params: { id: string } }) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const id = Number(ctx.params.id);\n    if (!Number.isFinite(id) || id <= 0) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid id' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    let body: any = {}; try { body = await req.json(); } catch {}\n    const action = String(body?.action || '').toLowerCase();\n    if (action === 'cancel') {\n      const ok = await cancelJob(id);\n      const r = NextResponse.json({ ok });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const r = NextResponse.json({ ok: false, error: 'Unsupported action' }, { status: 400 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'job action failed' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":2671,"size_tokens":null},"src/app/reset-password/page.tsx":{"content":"import ResetPasswordForm from \"./reset-password-form\"\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\"\nimport { cookies } from \"next/headers\"\nimport { redirect } from \"next/navigation\"\n\nexport const metadata = { title: \"Set New Password\" }\nexport const dynamic = \"force-dynamic\"\nexport const revalidate = 0\n\nexport default async function ResetPasswordPage() {\n  const supabase = createServerComponentClient({ cookies })\n  const { data } = await supabase.auth.getSession()\n  if (!data?.session) {\n    // If user isn't authenticated after recovery, send back to login\n    redirect(\"/login\")\n  }\n  return (\n    <div className=\"container flex min-h-[70vh] w-full flex-col items-center justify-center py-12\">\n      <div className=\"w-full max-w-md rounded-xl border bg-white p-8 shadow-sm\">\n        <ResetPasswordForm />\n      </div>\n    </div>\n  )\n}\n","path":null,"size_bytes":872,"size_tokens":null},"src/lib/notification-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { revalidatePath } from \"next/cache\";\n\nfunction boolFromForm(value: FormDataEntryValue | null): boolean {\n  if (!value) return false;\n  const v = String(value).toLowerCase();\n  return v === \"true\" || v === \"on\" || v === \"1\";\n}\n\nexport async function updateNotifications(formData: FormData) {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/notifications\");\n\n  const order_updates = boolFromForm(formData.get(\"order_updates\"));\n  const promotions = boolFromForm(formData.get(\"promotions\"));\n  const product_updates = boolFromForm(formData.get(\"product_updates\"));\n\n  const { error } = await supabase.auth.updateUser({\n    data: {\n      notifications: {\n        order_updates,\n        promotions,\n        product_updates,\n      },\n    },\n  });\n\n  if (error) {\n    console.error(\"updateNotifications error\", error);\n    throw new Error(error.message || \"Failed to update notifications\");\n  }\n\n  revalidatePath(\"/account/notifications\");\n}\n","path":null,"size_bytes":1240,"size_tokens":null},"src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nexport interface TextareaProps\n  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}\n\nconst Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(\n  ({ className, ...props }, ref) => {\n    return (\n      <textarea\n        className={cn(\n          \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":772,"size_tokens":null},"src/components/navigation-bar.tsx":{"content":"import Link from \"next/link\";\nimport type { Route } from \"next\";\n\nconst MENU: { href: string; label: string }[] = [\n  { href: \"/shop\", label: \"Shop\" },\n  { href: \"/collections\", label: \"Collections\" },\n  { href: \"/bestsellers\", label: \"Bestsellers\" },\n  { href: \"/new-arrivals\", label: \"New Arrivals\" },\n  { href: \"/about\", label: \"About Us\" },\n  { href: \"/contact\", label: \"Contact\" },\n];\n\nexport default async function NavigationBar() {\n  return (\n    <nav className=\"hidden md:block border-b bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80\">\n      <div className=\"container flex items-center justify-start gap-6 py-2 text-sm font-medium text-muted-foreground overflow-x-auto whitespace-nowrap\">\n        {MENU.map((m) => (\n          <Link key={m.href} href={m.href as Route} className=\"transition-colors hover:text-foreground\">\n            {m.label}\n          </Link>\n        ))}\n      </div>\n    </nav>\n  );\n}\n","path":null,"size_bytes":940,"size_tokens":null},"src/app/order-tracking/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { formatCurrency } from \"@/lib/utils\";\nexport const metadata = { title: \"Order Tracking\" };\nexport const dynamic = \"force-dynamic\";\n\nexport default async function OrderTrackingPage({\n  searchParams,\n}: {\n  searchParams?: { [key: string]: string | string[] | undefined };\n}) {\n  const getFirst = (v: string | string[] | undefined) =>\n    (Array.isArray(v) ? v[0] : v) ?? \"\";\n\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/order-tracking\");\n\n  const idParam = getFirst(searchParams?.id);\n  const orderId = idParam ? Number(idParam) : undefined;\n\n  let order: any | null = null;\n  if (orderId && Number.isFinite(orderId)) {\n    const { data } = await supabase\n      .from(\"orders\")\n      .select(\"id, status, total_amount, created_at\")\n      .eq(\"id\", orderId)\n      .eq(\"user_id\", user.id)\n      .maybeSingle();\n    order = data || null;\n  }\n\n  return (\n    <div className=\"container py-10\">\n      <h1 className=\"text-3xl font-bold\">Order Tracking</h1>\n      <p className=\"mt-2 text-slate-600\">Enter your order number to see the latest status.</p>\n      <div className=\"mt-6 max-w-md rounded-xl border bg-white p-6 shadow-sm\">\n        <form method=\"get\" className=\"flex gap-2\">\n          <input name=\"id\" defaultValue={idParam} placeholder=\"Order Number\" className=\"w-full rounded-md border px-3 py-2\" />\n          <button className=\"btn-primary\" type=\"submit\">Track</button>\n        </form>\n\n        {idParam && !order && (\n          <div className=\"mt-4 text-sm text-red-600\">No order found with this number for your account.</div>\n        )}\n\n        {order && (\n          <div className=\"mt-4 text-sm text-slate-700\">\n            <div>Order Number: <span className=\"font-medium\">#{order.id}</span></div>\n            <div>Status: <span className=\"font-medium\">{order.status}</span></div>\n            <div>Total: <span className=\"font-medium\">{formatCurrency(Number(order.total_amount || 0))}</span></div>\n            <div>Date: <span className=\"font-medium\">{new Date(order.created_at).toLocaleString()}</span></div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2360,"size_tokens":null},"branding/suppliers/shortlist-ksa.md":{"content":"# Shopixo — KSA Supplier Shortlist (Low Cost, High Quality, Fast Delivery)\n\nThis shortlist focuses on launching with online payments first, COD later. All suppliers must support blind shipping and show Shipper Name: Shopixo.\n\n## Tier 1 (China) — Broad catalog, competitive cost\n\n- CJdropshipping (China)\n  - Strengths: Large catalog (apparel/shoes/accessories/home), blind shipping, branded packing slip, kitting, API feeds.\n  - Typical KSA transit: ~6–12 days (service-dependent, weight/size sensitive).\n  - Use cases: Women/Men apparel basics, women/men shoes, bags, jewelry, home & kitchen accessories, toys (non-regulated), mobile accessories.\n  - Notes: Confirm inclusion of our packing slip and thank-you insert for every order.\n\n- HyperSKU (China)\n  - Strengths: Strong private-label options, custom packaging, good QC, fast handling.\n  - Typical KSA transit: ~6–10 days via express lanes.\n  - Use cases: Fashion (including plus-size), shoes, accessories with better branding needs.\n  - Notes: Good for future brand packaging (polybag/hangtag) on best-sellers.\n\n- Wiio (China)\n  - Strengths: Competitive buying, media proofs before dispatch, custom packaging.\n  - Typical KSA transit: ~7–12 days depending on lanes.\n  - Use cases: Accessories, bags, select apparel; flexible sourcing.\n\n## Tier 1 (Turkey) — Higher quality apparel/kids + faster to KSA\n\n- Sourcing via Agent + 3PL (ShipEntegra or OPLOG)\n  - Strengths: Access to verified Istanbul textile wholesalers, better fabric/fit, Arabic labels possible, fast KSA shipping.\n  - Typical KSA transit: ~3–7 days express after 1–2 days handling.\n  - Use cases: Women/Men apparel, Kids Fashion (priority), selected kids shoes.\n  - Process: Agent purchases from wholesalers → 3PL receives, checks, inserts Shopixo materials, ships blind to KSA.\n  - Notes: Start with trial lots; require pre-dispatch photos showing label (Shopixo) + insert.\n\n## 3PL / Logistics to KSA\n\n- ShipEntegra (Turkey → KSA)\n  - Express consolidation, Arabic address support, COD labels supported (for later), competitive rates for apparel.\n- OPLOG (Turkey / EU)\n  - Fulfillment + value-added services, scalable for brand packaging.\n- Courier options (as routed by suppliers/3PL): DHL/Aramex/SF/UPS — choose by lane and weight.\n\n## Category-to-Supplier Mapping (Phase 1)\n\n- Women Apparel, Men Apparel, Kids Fashion → Turkey (Agent + ShipEntegra). Backup: CJ/HyperSKU for basics.\n- Women Shoes, Men Shoes → China (CJ/HyperSKU). Select leather lines via Turkey later.\n- Kids Shoes → China initially (CJ), Turkey later for premium.\n- Women Plus, Men Plus → China (HyperSKU/CJ) with size charts; Turkey later for premium fits.\n- Underwear (Men) & Women Sleepwear → China (QC emphasis, soft fabrics). Trial with Turkey if needed.\n- Jewelry & Accessories, Bags & Luggage → China (CJ/HyperSKU/Wiio).\n- Home & Kitchen (non-electrical), Office/School, Toys (non-regulated), Tools (hand tools), Auto accessories, Pet supplies, Garden → China.\n- Electronics/Appliances/Smart Home/Mobile → Accessories only (no regulated items initially).\n\n## Next Actions\n\n1) Send RFI (AR/EN) to: CJdropshipping, HyperSKU, Wiio; and to 2–3 Turkey agents recommended by ShipEntegra.\n2) Request sample price lists + KSA shipping matrix + confirmation of blind shipping & label override.\n3) Place test orders (5–10 items per line). Require pre-dispatch photo/video with Shopixo label + inserts.\n4) Select lanes based on landed cost + KSA transit + QC results.\n\nAll suppliers must agree to: blind shipping, no supplier materials, Shopixo shipper name on label, include our packing slip + insert, and share tracking within 24h.\n","path":null,"size_bytes":3665,"size_tokens":null},"src/app/account/reviews/page.tsx":{"content":"import Link from \"next/link\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { format } from \"date-fns\";\nimport { updateReview, deleteReview } from \"@/lib/review-actions\";\nimport SubmitButton from \"@/components/submit-button\";\nimport ConfirmSubmitButton from \"@/components/confirm-submit-button\";\nimport FormStatusToast from \"@/components/form-status-toast\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype JoinedReview = {\n  id: number;\n  user_id: string;\n  product_id: number;\n  rating: number;\n  title: string | null;\n  body: string | null;\n  created_at: string;\n  product?: { id: number; slug: string; title: string } | null;\n};\n\nasync function getUserReviews(userId: string): Promise<JoinedReview[]> {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: reviewsData, error: revErr } = await supabase\n    .from(\"reviews\")\n    .select(\"id,user_id,product_id,rating,title,body,created_at\")\n    .eq(\"user_id\", userId)\n    .order(\"created_at\", { ascending: false });\n  if (revErr) {\n    console.error(\"getUserReviews error\", revErr);\n    return [];\n  }\n  const reviews = (reviewsData || []) as Array<{\n    id: number; user_id: string; product_id: number; rating: number; title: string | null; body: string | null; created_at: string;\n  }>;\n\n  const productIds = Array.from(new Set(reviews.map(r => r.product_id)));\n  let productMap = new Map<number, { id: number; slug: string; title: string }>();\n  if (productIds.length > 0) {\n    const { data: productsData, error: prodErr } = await supabase\n      .from(\"products\")\n      .select(\"id,slug,title\")\n      .in(\"id\", productIds);\n    if (prodErr) {\n      console.warn(\"Failed to fetch products for reviews\", prodErr);\n    } else {\n      for (const p of productsData as any[]) {\n        productMap.set(p.id as number, { id: p.id as number, slug: String(p.slug), title: String(p.title) });\n      }\n    }\n  }\n\n  return reviews.map(r => ({ ...r, product: productMap.get(r.product_id) || null }));\n}\n\nexport default async function ReviewsPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/reviews\");\n\n  const reviews = await getUserReviews(user.id);\n\n  return (\n    <div className=\"max-w-3xl mx-auto py-12 px-4\">\n      <h1 className=\"text-2xl font-bold mb-6\">My Reviews</h1>\n\n      {reviews.length === 0 ? (\n        <div className=\"rounded-lg border bg-white p-6\">\n          <p className=\"text-gray-600\">No reviews yet. You can write a review from the product page after purchase.</p>\n        </div>\n      ) : (\n        <ul className=\"space-y-4\">\n          {reviews.map((r) => {\n            const product = r.product || null;\n            const dateStr = format(new Date(r.created_at), \"MMMM d, yyyy\");\n            return (\n              <li key={r.id} className=\"rounded-lg border bg-white p-6\">\n                <div className=\"flex items-start justify-between gap-3\">\n                  <div>\n                    <h2 className=\"text-lg font-semibold\">\n                      {product ? (\n                        <Link href={{ pathname: `/product/${product.slug}` }} className=\"hover:underline\">\n                          {product.title}\n                        </Link>\n                      ) : (\n                        <span>Unknown Product</span>\n                      )}\n                    </h2>\n                    <p className=\"text-sm text-gray-600\">{dateStr}</p>\n                  </div>\n                  <div className=\"text-yellow-500 font-semibold\" aria-label={`Rating ${r.rating} out of 5`}>\n                    {\"★\".repeat(r.rating)}<span className=\"text-gray-300\">{\"★\".repeat(5 - r.rating)}</span>\n                  </div>\n                </div>\n\n                {r.title && <p className=\"mt-3 font-medium\">{r.title}</p>}\n                {r.body && <p className=\"mt-1 text-gray-700 whitespace-pre-wrap\">{r.body}</p>}\n\n                <details className=\"mt-4\">\n                  <summary className=\"cursor-pointer text-sm text-gray-700 hover:text-black\">Edit Review</summary>\n                  <form action={updateReview} className=\"mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                    <input type=\"hidden\" name=\"id\" value={String(r.id)} />\n                    <div>\n                      <label className=\"block text-sm font-medium mb-1\">Rating</label>\n                      <select name=\"rating\" required defaultValue={String(r.rating)} className=\"w-full rounded border px-3 py-2\">\n                        <option value=\"5\">5</option>\n                        <option value=\"4\">4</option>\n                        <option value=\"3\">3</option>\n                        <option value=\"2\">2</option>\n                        <option value=\"1\">1</option>\n                      </select>\n                    </div>\n                    <div>\n                      <label className=\"block text-sm font-medium mb-1\">Title (optional)</label>\n                      <input name=\"title\" defaultValue={r.title ?? \"\"} className=\"w-full rounded border px-3 py-2\" />\n                    </div>\n                    <div className=\"sm:col-span-2\">\n                      <label className=\"block text-sm font-medium mb-1\">Review (optional)</label>\n                      <textarea name=\"body\" defaultValue={r.body ?? \"\"} rows={4} className=\"w-full rounded border px-3 py-2\" />\n                    </div>\n                    <div className=\"sm:col-span-2\">\n                      <div className=\"flex items-center gap-2\">\n                        <SubmitButton label=\"Save Changes\" pendingLabel=\"Saving...\" />\n                      </div>\n                      <FormStatusToast successMessage=\"Changes saved\" />\n                    </div>\n                  </form>\n                  <form action={deleteReview} className=\"mt-2 flex items-center justify-end\">\n                    <input type=\"hidden\" name=\"id\" value={String(r.id)} />\n                    <ConfirmSubmitButton label=\"Delete\" pendingLabel=\"Deleting...\" confirmMessage=\"Are you sure you want to delete this review?\" className=\"px-3 py-2 text-sm\" />\n                    <FormStatusToast successMessage=\"Review deleted\" />\n                  </form>\n                </details>\n              </li>\n            );\n          })}\n        </ul>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":6477,"size_tokens":null},"src/app/api/admin/jobs/[id]/run/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { getJob, startJob, finishJob } from '@/lib/jobs'\nimport { stepFinderJob } from '@/lib/runner'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function POST(req: Request, ctx: { params: { id: string } }) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const id = Number(ctx.params.id)\n    if (!Number.isFinite(id) || id <= 0) {\n      const r = NextResponse.json({ ok: false, error: 'Invalid id' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const st = await getJob(id)\n    if (!st) return NextResponse.json({ ok: false, error: 'Not found' }, { status: 404 })\n\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const mode = (body?.mode || 'step') as 'step' | 'all'\n    const maxSteps = Math.max(1, Math.min(200, Number(body?.steps || 1)))\n\n    if (st.job.status === 'pending') await startJob(id)\n\n    let stepsRun = 0\n    let candidatesAddedTotal = 0\n    let done = false\n\n    const safety = mode === 'all' ? 2000 : maxSteps\n    for (let i = 0; i < safety; i++) {\n      const res = await stepFinderJob(id)\n      stepsRun++\n      candidatesAddedTotal += res.added\n      if (res.done) { done = true; break }\n      if (mode === 'step' && stepsRun >= maxSteps) break\n    }\n\n    if (done) {\n      // ensure job is success (stepFinderJob finalizes, but be safe)\n      try { await finishJob(id, 'success', { stepsRun, candidatesAddedTotal }) } catch {}\n    }\n\n    const r = NextResponse.json({ ok: true, done, stepsRun, candidatesAddedTotal })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'run failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2194,"size_tokens":null},"src/app/account/notifications/page.tsx":{"content":"import { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport { updateNotifications } from \"@/lib/notification-actions\";\nimport SubmitButton from \"@/components/submit-button\";\nimport FormStatusToast from \"@/components/form-status-toast\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nexport default async function NotificationsPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabase.auth.getUser();\n  if (!user) redirect(\"/login?redirect=/account/notifications\");\n\n  const meta = (user.user_metadata || {}) as any;\n  const prefs = (meta.notifications || {}) as { order_updates?: boolean; promotions?: boolean; product_updates?: boolean };\n\n  return (\n    <div className=\"max-w-3xl mx-auto py-12 px-4\">\n      <h1 className=\"text-2xl font-bold mb-6\">Notifications</h1>\n      <div className=\"rounded-lg border bg-white p-6\">\n        <form action={updateNotifications} className=\"space-y-4\">\n          <div>\n            <h2 className=\"text-lg font-semibold mb-2\">Email Notifications</h2>\n            <label className=\"flex items-center gap-3 py-2\">\n              <input type=\"checkbox\" name=\"order_updates\" defaultChecked={!!prefs.order_updates} className=\"h-4 w-4\" />\n              <span>Order updates (status changes, shipping info)</span>\n            </label>\n            <label className=\"flex items-center gap-3 py-2\">\n              <input type=\"checkbox\" name=\"promotions\" defaultChecked={!!prefs.promotions} className=\"h-4 w-4\" />\n              <span>Promotions and special offers</span>\n            </label>\n            <label className=\"flex items-center gap-3 py-2\">\n              <input type=\"checkbox\" name=\"product_updates\" defaultChecked={!!prefs.product_updates} className=\"h-4 w-4\" />\n              <span>Product updates and back-in-stock alerts</span>\n            </label>\n          </div>\n          <SubmitButton label=\"Save Preferences\" pendingLabel=\"Saving...\" />\n          <FormStatusToast successMessage=\"Preferences saved\" />\n        </form>\n        <p className=\"text-xs text-gray-500 mt-3\">You can unsubscribe from marketing emails at any time. Transactional emails cannot be disabled.</p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2331,"size_tokens":null},"src/app/admin/products/page.tsx":{"content":"import Image from \"next/image\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport Link from \"next/link\";\nimport {\n  Table,\n  TableBody,\n  TableCaption,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport ArchiveProductButton from \"@/app/admin/products/archive-button\";\nimport DeleteProductButton from \"@/app/admin/products/delete-button\";\nimport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n} from \"@/components/ui/dropdown-menu\";\n\nexport const dynamic = \"force-dynamic\";\n\nexport default async function AdminProductsPage() {\n  const supabase = createServerComponentClient({ cookies });\n  const { data: products, error } = await supabase\n    .from(\"products\")\n    .select(\"*\")\n    .order(\"created_at\", { ascending: false });\n\n  if (error) {\n    console.error(\"Error fetching products:\", error);\n    return <p className=\"text-red-500\">Failed to load products.</p>;\n  }\n\n  function pickPrimaryImage(images: any): string | null {\n    try {\n      if (!images) return null;\n      if (Array.isArray(images)) {\n        const v = images.find((s: any) => typeof s === 'string' && s.trim().length > 0) as string | undefined;\n        return v || null;\n      }\n      if (typeof images === 'string') {\n        const s = images.trim();\n        if (!s) return null;\n        if (s.startsWith('[') && s.endsWith(']')) {\n          const parsed = JSON.parse(s);\n          if (Array.isArray(parsed)) {\n            const v = parsed.find((x: any) => typeof x === 'string' && x.trim().length > 0);\n            return (v as string) || null;\n          }\n        }\n        if (s.includes(',')) {\n          const v = s.split(',').map((x) => x.trim()).find((x) => x.length > 0);\n          return v || null;\n        }\n        return s; // single URL string\n      }\n    } catch {}\n    return null;\n  }\n\n  return (\n    <div className=\"w-full\">\n      <div className=\"flex items-center justify-between mb-6\">\n        <h1 className=\"text-2xl font-bold\">Products</h1>\n        <Button asChild>\n          <Link href=\"/admin/products/new\">Add Product</Link>\n        </Button>\n      </div>\n      <div className=\"rounded-md border\">\n        <Table>\n          <TableCaption>A list of your products.</TableCaption>\n          <TableHeader>\n            <TableRow>\n              <TableHead className=\"w-[80px]\">\n                Image\n              </TableHead>\n              <TableHead>Title</TableHead>\n              <TableHead>Price</TableHead>\n              <TableHead>Stock</TableHead>\n              <TableHead className=\"hidden md:table-cell\">Created at</TableHead>\n              <TableHead>\n                <span className=\"sr-only\">Actions</span>\n              </TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {products.map((product: any) => (\n              <TableRow key={product.id}>\n                <TableCell>\n                  <Image\n                    alt={product.title}\n                    className=\"aspect-square rounded-md object-cover\"\n                    height=\"64\"\n                    src={pickPrimaryImage(product.images) || \"/placeholder.svg\"}\n                    width=\"64\"\n                    unoptimized\n                  />\n                </TableCell>\n                <TableCell className=\"font-medium\">\n                  {product.title}\n                  {product.is_active === false && (\n                    <span className=\"ml-2 rounded bg-amber-100 px-2 py-0.5 text-xs font-medium text-amber-700\">Archived</span>\n                  )}\n                </TableCell>\n                <TableCell>{formatCurrency(product.price)}</TableCell>\n                <TableCell>\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"font-medium\">{typeof product.stock === 'number' ? product.stock : 0}</span>\n                    <span className={\n                      (product.stock ?? 0) > 0\n                        ? \"rounded-full bg-emerald-100 px-2 py-0.5 text-xs font-medium text-emerald-700\"\n                        : \"rounded-full bg-rose-100 px-2 py-0.5 text-xs font-medium text-rose-700\"\n                    }>\n                      {(product.stock ?? 0) > 0 ? 'Available' : 'Out of Stock'}\n                    </span>\n                  </div>\n                </TableCell>\n                <TableCell className=\"hidden md:table-cell\">\n                  {new Date(product.created_at).toLocaleDateString()}\n                </TableCell>\n                <TableCell className=\"text-right\">\n                  {/* Hidden forms to be triggered from the dropdown */}\n                  <div className=\"sr-only\">\n                    <ArchiveProductButton formId={`archive-form-${product.id}`} productId={product.id} isActive={product.is_active ?? true} />\n                    <DeleteProductButton formId={`delete-form-${product.id}`} productId={product.id} doubleConfirm />\n                  </div>\n                  <DropdownMenu>\n                    <DropdownMenuTrigger asChild>\n                      <Button variant=\"outline\" size=\"sm\">إجراءات</Button>\n                    </DropdownMenuTrigger>\n                    <DropdownMenuContent align=\"end\">\n                      <DropdownMenuItem asChild>\n                        <Link href={`/admin/products/${product.id}/edit`} className=\"cursor-pointer\">\n                          تعديل\n                        </Link>\n                      </DropdownMenuItem>\n                      <DropdownMenuItem asChild>\n                        <button type=\"submit\" form={`archive-form-${product.id}`} className=\"w-full text-right\">\n                          {product.is_active === false ? 'استعادة' : 'أرشفة'}\n                        </button>\n                      </DropdownMenuItem>\n                      <DropdownMenuSeparator />\n                      <DropdownMenuItem asChild>\n                        <button type=\"submit\" form={`delete-form-${product.id}`} className=\"w-full text-right text-red-600\">\n                          حذف\n                        </button>\n                      </DropdownMenuItem>\n                    </DropdownMenuContent>\n                  </DropdownMenu>\n                </TableCell>\n              </TableRow>\n            ))}\n          </TableBody>\n        </Table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6533,"size_tokens":null},"src/app/api/admin/settings/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { getOperatingMode, isKillSwitchOn, setOperatingMode, setKillSwitch } from '@/lib/settings'\nimport { hasTable } from '@/lib/db-features'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const [mode, kill, hasKv] = await Promise.all([\n      getOperatingMode(),\n      isKillSwitchOn(),\n      hasTable('kv_settings'),\n    ])\n    const r = NextResponse.json({ ok: true, mode, killSwitch: kill, hasKv })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'settings failed' }, { status: 500 })\n    r.headers.set('x-request-id', loggerForRequest(req).requestId)\n    return r\n  }\n}\n\nexport async function POST(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    const hasKv = await hasTable('kv_settings')\n    if (!hasKv) {\n      const r = NextResponse.json({ ok: false, error: 'kv_settings table missing' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n    let body: any = {}\n    try { body = await req.json() } catch {}\n    const updates: Record<string, any> = {}\n    if (typeof body.mode === 'string' && ['monitor','copilot','autopilot'].includes(body.mode)) {\n      await setOperatingMode(body.mode)\n      updates.mode = body.mode\n    }\n    if (typeof body.killSwitch === 'boolean') {\n      await setKillSwitch(body.killSwitch)\n      updates.killSwitch = body.killSwitch\n    }\n    const r = NextResponse.json({ ok: true, updated: updates })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'update failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":2474,"size_tokens":null},"src/app/product/[slug]/page.tsx":{"content":"function isLikelyImageUrl(s: string): boolean {\n  if (!s) return false;\n  if (s.startsWith('http://') || s.startsWith('https://')) return true;\n  if (s.startsWith('/')) return true;\n  if (s.startsWith('data:image/')) return true;\n  return false;\n}\nfunction normalizeSlugCandidate(s: string) {\n  return (s || \"\").trim().toLowerCase().replace(/\\s+/g, \"-\");\n}\n\nfunction pickPrimaryImage(images: any): string | null {\n  try {\n    if (!images) return null;\n    if (Array.isArray(images)) {\n      const v = images.find((s) => typeof s === 'string' && isLikelyImageUrl(s.trim())) as string | undefined;\n      return v || null;\n    }\n    if (typeof images === 'string') {\n      const s = images.trim();\n      if (!s) return null;\n      if (s.startsWith('[') && s.endsWith(']')) {\n        const parsed = JSON.parse(s);\n        if (Array.isArray(parsed)) {\n          const v = parsed.find((x) => typeof x === 'string' && isLikelyImageUrl(x.trim()));\n          return (v as string) || null;\n        }\n      }\n      if (/[;,|\\n\\r\\t]/.test(s) || s.includes(',')) {\n        const v = s.split(/[;,|\\n\\r\\t,]+/).map((x) => x.trim()).find((x) => isLikelyImageUrl(x));\n        return v || null;\n      }\n      return isLikelyImageUrl(s) ? s : null;\n    }\n  } catch {}\n  return null;\n}\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\";\nimport { notFound, redirect } from \"next/navigation\";\nimport ProductDetailsClient from \"@/components/product-details-client\";\nimport type { Product, ProductVariant } from \"@/lib/types\";\nimport AdminProductActions from \"@/components/admin-product-actions\";\nimport PriceComparison from \"@/components/price-comparison\";\nimport type { Metadata } from 'next'\nimport { getSiteUrl } from \"@/lib/site\";\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { cookies } from \"next/headers\";\nimport { headers } from \"next/headers\";\n \n\nexport const revalidate = 60; // fresher PDP data every minute\nexport const dynamic = \"force-dynamic\"; // render per-request to include session-based admin controls\n\n// --- Generate Metadata for SEO ---\nexport async function generateMetadata({ params }: { params: { slug: string } }): Promise<Metadata> {\n  const supabase = getSupabaseAnonServer();\n  const storeName = process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\";\n  if (!supabase) {\n    return { title: `${params.slug} | ${storeName}`, description: 'Product details' };\n  }\n  const isNumeric = /^\\d+$/.test(params.slug);\n  let product: { title: string; description: string; images: string[]; slug?: string } | null = null;\n  // Try slug first (even if numeric), without is_active filter\n  {\n    const { data } = await supabase\n      .from(\"products\")\n      .select(\"title, description, images, slug\")\n      .eq(\"slug\", params.slug)\n      .single();\n    product = data as any;\n  }\n  // Fallbacks: case-insensitive and normalized\n  if (!product) {\n    const norm = normalizeSlugCandidate(params.slug);\n    const { data } = await supabase\n      .from(\"products\")\n      .select(\"title, description, images, slug\")\n      .ilike(\"slug\", norm)\n      .maybeSingle();\n    product = (data as any) || null;\n  }\n  if (!product) {\n    const norm = normalizeSlugCandidate(params.slug);\n    const { data } = await supabase\n      .from(\"products\")\n      .select(\"title, description, images, slug\")\n      .ilike(\"slug\", `%${norm}%`)\n      .limit(1)\n      .single();\n    product = (data as any) || null;\n  }\n  if (!product && isNumeric) {\n    const { data } = await supabase\n      .from(\"products\")\n      .select(\"title, description, images, slug\")\n      .eq(\"id\", Number(params.slug))\n      .single();\n    product = data as any;\n  }\n \n  if (!product) {\n    return {\n      title: 'Product Not Found',\n      description: 'The requested product is not available.',\n    }\n  }\n \n  return {\n    title: `${product.title} | ${storeName}`,\n    description: product.description,\n    alternates: {\n      canonical: `/product/${(product as any).slug ?? params.slug}`,\n    },\n    openGraph: {\n      title: `${product.title} | ${storeName}`,\n      description: product.description,\n      images: [\n        (() => {\n          const img = pickPrimaryImage((product as any).images ?? (product as any).image) || '/placeholder.svg';\n          return img.startsWith('http') ? img : `${getSiteUrl()}${img}`;\n        })(),\n      ],\n    },\n  }\n}\n\n// --- Main Product Page Component (Server Component) ---\nexport default async function ProductPage({ params, searchParams }: { params: { slug: string }, searchParams?: { debugMedia?: string } }) {\n  const nonce = headers().get('x-csp-nonce') || undefined;\n  const supabase = getSupabaseAnonServer();\n  if (!supabase) {\n    notFound();\n  }\n\n  const isNumeric = /^\\d+$/.test(params.slug);\n  let product: Product | null = null;\n  // Try slug first (even if numeric), without is_active filter\n  {\n    const { data } = await supabase\n      .from(\"products\")\n      .select<\"*\", Product>(\"*\")\n      .eq(\"slug\", params.slug)\n      .single();\n    product = data as any;\n  }\n  // Fallbacks: case-insensitive and normalized\n  if (!product) {\n    const norm = normalizeSlugCandidate(params.slug);\n    const { data } = await supabase\n      .from(\"products\")\n      .select<\"*\", Product>(\"*\")\n      .ilike(\"slug\", norm)\n      .maybeSingle();\n    product = (data as any) || null;\n  }\n  if (!product) {\n    const norm = normalizeSlugCandidate(params.slug);\n    const { data } = await supabase\n      .from(\"products\")\n      .select<\"*\", Product>(\"*\")\n      .ilike(\"slug\", `%${norm}%`)\n      .limit(1)\n      .single();\n    product = (data as any) || null;\n  }\n  // If not found and numeric, try by id then redirect to canonical slug\n  if (!product && isNumeric) {\n    const { data } = await supabase\n      .from(\"products\")\n      .select<\"*\", Product>(\"*\")\n      .eq(\"id\", Number(params.slug))\n      .single();\n    product = data as any;\n    if (product && product.slug && product.slug !== params.slug) {\n      redirect(`/product/${product.slug}`);\n    }\n  }\n  // If found but slug differs only by case/format, redirect to canonical\n  if (product && product.slug && product.slug !== params.slug) {\n    redirect(`/product/${product.slug}`);\n  }\n\n  if (!product) {\n    notFound();\n  }\n\n  // Normalize images field to array of strings (handles JSON string or comma-separated strings) with fallback to legacy 'image'\n  try {\n    const raw = (product as any).images ?? (product as any).image;\n    let normalized: string[] = [];\n    if (Array.isArray(raw)) normalized = raw.filter((s) => typeof s === 'string');\n    else if (typeof raw === 'string') {\n      const s = raw.trim();\n      if (s.startsWith('[') && s.endsWith(']')) {\n        const parsed = JSON.parse(s);\n        if (Array.isArray(parsed)) normalized = parsed.filter((x: any) => typeof x === 'string');\n      } else if (s.includes(',')) {\n        normalized = s.split(',').map((x) => x.trim()).filter(Boolean);\n      } else if (s) {\n        normalized = [s];\n      }\n    }\n    (product as any).images = normalized;\n  } catch {}\n\n  // Fetch variant rows for this product and synthesize UI variants if missing\n  let variantRows: ProductVariant[] = [];\n  try {\n    const { data: v } = await supabase\n      .from(\"product_variants\")\n      .select(\"id, product_id, option_name, option_value, cj_sku, cj_variant_id, price, stock\")\n      .eq(\"product_id\", (product as any).id)\n      .order(\"option_value\", { ascending: true });\n    variantRows = (v as any) || [];\n  } catch {}\n  if ((!product.variants || product.variants.length === 0) && variantRows.length > 0) {\n    const name = variantRows[0].option_name || \"Size\";\n    const opts = Array.from(new Set(variantRows.map((r) => r.option_value))).filter(Boolean);\n    (product as any).variants = [{ name, options: opts }];\n  }\n\n  // Detect admin (show inline admin actions on PDP)\n  let isAdmin = false;\n  try {\n    const supabaseAuth = createServerComponentClient({ cookies });\n    const { data: { user } } = await supabaseAuth.auth.getUser();\n    if (user) {\n      const list = (process.env.ADMIN_EMAILS || \"\")\n        .split(\",\")\n        .map((e) => e.trim().toLowerCase())\n        .filter(Boolean);\n      if (list.length === 0) {\n        // Default deny in production when unset; allow in development for DX\n        isAdmin = process.env.NODE_ENV !== 'production';\n      } else {\n        isAdmin = list.includes((user.email || \"\").toLowerCase());\n      }\n    }\n  } catch {}\n\n  const debug = (searchParams?.debugMedia || \"\").toString() === '1' || (searchParams?.debugMedia || \"\").toString().toLowerCase() === 'true';\n\n  return (\n    <div className=\"container py-10\">\n      {debug && (\n        <pre className=\"mb-4 overflow-auto rounded bg-muted p-3 text-xs\" dir=\"ltr\">\n{JSON.stringify({\n  slug: params.slug,\n  hasProduct: !!product,\n  title: product?.title,\n  category: product?.category,\n  rawImages: (product as any)?.image ? { image: (product as any).image, images: (product as any).images } : (product as any)?.images,\n  normalizedImages: (product as any)?.images,\n}, null, 2)}\n        </pre>\n      )}\n      {/* Structured Data: Product + BreadcrumbList */}\n      <script\n        nonce={nonce}\n        type=\"application/ld+json\"\n        dangerouslySetInnerHTML={{\n          __html: JSON.stringify({\n            \"@context\": \"https://schema.org\",\n            \"@type\": \"Product\",\n            name: product.title,\n            description: product.description,\n            image: (() => {\n              const imgs = Array.isArray(product.images)\n                ? product.images.filter((s: any) => typeof s === 'string' && isLikelyImageUrl(s))\n                : [];\n              const base = imgs.length ? imgs : ['/placeholder.svg'];\n              return base.map((u: string) => (u.startsWith('http') ? u : `${getSiteUrl()}${u}`));\n            })(),\n            sku: String(product.id),\n            brand: { \"@type\": \"Brand\", name: process.env.NEXT_PUBLIC_STORE_NAME || \"Shopixo\" },\n            offers: {\n              \"@type\": \"Offer\",\n              url: `${getSiteUrl()}/product/${product.slug}`,\n              priceCurrency: process.env.NEXT_PUBLIC_CURRENCY || \"SAR\",\n              price: product.price,\n              availability: (product.stock ?? 0) > 0 ? \"https://schema.org/InStock\" : \"https://schema.org/OutOfStock\",\n            },\n          }),\n        }}\n      />\n      <script\n        nonce={nonce}\n        type=\"application/ld+json\"\n        dangerouslySetInnerHTML={{\n          __html: JSON.stringify({\n            \"@context\": \"https://schema.org\",\n            \"@type\": \"BreadcrumbList\",\n            itemListElement: [\n              { \"@type\": \"ListItem\", position: 1, name: \"الرئيسية\", item: getSiteUrl() },\n              { \"@type\": \"ListItem\", position: 2, name: product.category || \"المتجر\", item: `${getSiteUrl()}/category/${(product.category || \"\").toLowerCase().replace(/\\s+/g, '-')}` },\n              { \"@type\": \"ListItem\", position: 3, name: product.title, item: `${getSiteUrl()}/product/${product.slug}` },\n            ],\n          }),\n        }}\n      />\n      <ProductDetailsClient product={product} variantRows={variantRows}>\n        <PriceComparison productId={product.id} />\n        {isAdmin && (\n          <AdminProductActions\n            productId={product.id}\n            productSlug={product.slug as any}\n            isActive={(product as any).is_active ?? true}\n          />\n        )}\n      </ProductDetailsClient>\n    </div>\n  );\n}\n","path":null,"size_bytes":11410,"size_tokens":null},"ops/payments/ksa-tap-vs-moyasar.md":{"content":"# KSA Online Payments — Tap vs Moyasar (Shopixo)\n\nLaunch choice: Online payments first (cards + Apple Pay). COD later.\n\n## Summary\n- Tap: Fast onboarding for KSA, Apple Pay, robust links/Hosted checkout, good docs.\n- Moyasar: Strong KSA focus, Apple Pay, simple UI, competitive pricing.\n\nEither is fine. If undecided, default to Tap for launch.\n\n## Required Documents (both)\n- Commercial Registration (CR)\n- National address in KSA\n- IBAN letter (bank)\n- Domain + live store URL\n- Contact details (owner)\n- Return/Refund/Privacy/Shipping policies live on website\n\n## Fees (indicative — verify on approval)\n- Tap: ~2.7–3.2% + fixed per txn, Apple Pay supported\n- Moyasar: ~2.8–3.0% + fixed per txn, Apple Pay supported\n\n## Features checklist\n- Apple Pay: Both\n- Payment links: Both\n- Hosted checkout: Both\n- Refunds/partial: Both\n- Settlement: Next business days (varies)\n- BNPL later: via providers (e.g., Tabby/Tamara) — separate agreements\n\n## Steps to Launch\n1) Pick provider (Tap default) and submit application with docs.\n2) Enable Hosted checkout / Links for fast integration.\n3) Set support email and WhatsApp on checkout pages.\n4) Go live in test orders, then production.\n\n## Store Policies (must be live)\n- Return/Refund policy\n- Privacy policy\n- Shipping policy (with transit times)\n\nAdd these pages to footer before submitting the application.\n","path":null,"size_bytes":1365,"size_tokens":null},"src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\"bg-primary font-medium text-primary-foreground\", className)}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2738,"size_tokens":null},"src/app/api/admin/cron/tick/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { loggerForRequest } from '@/lib/log'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { getSetting } from '@/lib/settings'\nimport { createJob } from '@/lib/jobs'\nimport { runJob } from '@/lib/runner'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req)\n  try {\n    const url = new URL(req.url)\n    const secret = process.env.CRON_SECRET || ''\n    const headerSecret = req.headers.get('x-cron-secret') || url.searchParams.get('secret') || ''\n\n    let authorized = false\n    if (secret && headerSecret && headerSecret === secret) authorized = true\n    if (!authorized) {\n      const guard = await ensureAdmin()\n      if (guard.ok) authorized = true\n    }\n    if (!authorized) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const settings = await getSetting<any>('scanner_settings', { enabled: false })\n    if (!settings?.enabled) {\n      const r = NextResponse.json({ ok: true, scannerEnabled: false })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    // Create a scanner job; the actual scan will be handled by a follow-up worker route or next tick\n    const job = await createJob('scanner', { source: 'cron', settings })\n    let result: any = null\n    if (job?.id) {\n      try { result = await runJob(job.id) } catch {}\n    }\n    const r = NextResponse.json({ ok: true, scannerEnabled: true, jobId: job?.id || null, result })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'cron tick failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":1919,"size_tokens":null},"src/app/cart/checkout-button.tsx":{"content":"\"use client\";\n\nimport { createCheckoutSession } from \"@/lib/checkout-actions\";\nimport { Button } from \"@/components/ui/button\";\nimport { useFormStatus } from \"react-dom\";\n\nfunction SubmitButton() {\n  const { pending } = useFormStatus();\n\n  return (\n    <Button\n      type=\"submit\"\n      className=\"w-full\"\n      disabled={pending}\n      variant=\"cta\"\n      size=\"default\"\n      aria-label={pending ? \"Processing\" : \"Proceed to Checkout\"}\n    >\n      {pending ? \"Processing...\" : \"Proceed to Checkout\"}\n    </Button>\n  );\n}\n\nexport default function CheckoutButton() {\n  return (\n    <form action={createCheckoutSession}>\n      <SubmitButton />\n    </form>\n  );\n}\n","path":null,"size_bytes":662,"size_tokens":null},"src/components/cookie-consent.tsx":{"content":"\"use client\";\nimport { useEffect, useState } from \"react\";\n\nconst KEY = \"shopixo_cookie_consent\";\n\nexport default function CookieConsent() {\n  const [open, setOpen] = useState(false);\n  useEffect(() => {\n    if (typeof window !== \"undefined\") {\n      const ok = localStorage.getItem(KEY);\n      setOpen(!ok);\n    }\n  }, []);\n  if (!open) return null;\n  return (\n    <div className=\"fixed inset-x-0 bottom-0 z-50\">\n      <div className=\"container pb-6\">\n        <div className=\"flex items-start justify-between gap-4 rounded-xl border bg-white p-4 shadow-lg\">\n          <p className=\"text-sm text-slate-700\">\n            We use cookies to enhance your experience, analyze traffic, and for marketing purposes. By continuing to browse, you agree to our privacy policy.\n          </p>\n          <div className=\"flex shrink-0 gap-2\">\n            <button className=\"rounded-md border px-3 py-2 text-sm\" onClick={() => { localStorage.setItem(KEY, \"dismiss\"); setOpen(false); }}>Decline</button>\n            <button className=\"btn-primary\" onClick={() => { localStorage.setItem(KEY, \"accept\"); setOpen(false); }}>Accept</button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1184,"size_tokens":null},"src/app/admin/console/settings/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype SettingsResp = { ok: boolean; mode?: \"monitor\"|\"copilot\"|\"autopilot\"; killSwitch?: boolean; hasKv?: boolean; error?: string };\n\nexport default function AdminSettingsPage() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [mode, setMode] = useState<\"monitor\"|\"copilot\"|\"autopilot\">(\"monitor\");\n  const [kill, setKill] = useState(false);\n  const [hasKv, setHasKv] = useState<boolean>(true);\n\n  async function load() {\n    setLoading(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/settings\", { cache: \"no-store\" });\n      const j: SettingsResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setMode((j.mode as any) || \"monitor\");\n      setKill(!!j.killSwitch);\n      setHasKv(!!j.hasKv);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load settings\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function save(next: Partial<{ mode: \"monitor\"|\"copilot\"|\"autopilot\"; killSwitch: boolean }>) {\n    setSaving(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/settings\", { method: \"POST\", headers: { \"Content-Type\": \"application/json\" }, body: JSON.stringify(next) });\n      const j = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await load();\n    } catch (e: any) {\n      setError(e?.message || \"Failed to save settings\");\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  useEffect(() => { load(); }, []);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-baseline justify-between\">\n        <h1 className=\"text-2xl font-semibold\">Admin Settings</h1>\n        <Link href=\"/admin/console\" className=\"text-sm text-blue-600 hover:underline\">Back to Console</Link>\n      </div>\n\n      {error && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <div className=\"rounded border bg-white p-4\">\n        <div className=\"mb-4\">\n          <div className=\"text-sm text-muted-foreground\">Operating Mode</div>\n          <div className=\"mt-2 flex gap-3\">\n            {[\"monitor\",\"copilot\",\"autopilot\"].map((m) => (\n              <button\n                key={m}\n                onClick={() => save({ mode: m as any })}\n                disabled={saving || loading}\n                className={`rounded px-3 py-1.5 text-sm border ${mode===m?\"bg-blue-600 text-white border-blue-600\":\"bg-white text-blue-700 border-blue-300 hover:bg-blue-50\"}`}\n              >{m}</button>\n            ))}\n          </div>\n          <p className=\"mt-2 text-xs text-gray-500\">Monitor: proposals only · Copilot: approval required · Autopilot: low-risk auto actions</p>\n        </div>\n        <div className=\"mt-4\">\n          <div className=\"text-sm text-muted-foreground\">Kill‑Switch</div>\n          <div className=\"mt-2\">\n            <button\n              onClick={() => save({ killSwitch: !kill })}\n              disabled={saving || loading}\n              className={`rounded px-3 py-1.5 text-sm border ${kill?\"bg-red-600 text-white border-red-600\":\"bg-white text-red-700 border-red-300 hover:bg-red-50\"}`}\n            >{kill ? \"Turn OFF\" : \"Turn ON\"}</button>\n            <span className=\"ml-3 text-sm\">{kill ? \"All write operations are blocked\" : \"Writes are enabled\"}</span>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"rounded border bg-white p-4\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <div className=\"font-medium\">Key-Value Settings Table</div>\n            <div className=\"text-sm text-muted-foreground\">kv_settings {hasKv ? \"is present\" : \"is missing\"}</div>\n          </div>\n          <Link href=\"/admin/console/setup\" className=\"text-sm text-blue-600 hover:underline\">Open DB Setup</Link>\n        </div>\n      </div>\n\n      {(loading || saving) && <div className=\"text-sm text-gray-500\">Working…</div>}\n    </div>\n  );\n}\n","path":null,"size_bytes":4219,"size_tokens":null},"src/lib/ratelimit.ts":{"content":"import { Ratelimit } from \"@upstash/ratelimit\";\nimport { Redis } from \"@upstash/redis\";\n\n// Create a single Redis client from environment when available.\n// In local/dev build environments without env, fall back to a permissive no-op limiter\n// so builds do not crash. On Vercel, envs are present and Redis is used.\nlet redis: ReturnType<typeof Redis.fromEnv> | null = null;\ntry {\n  // Only construct if both vars present\n  if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {\n    redis = Redis.fromEnv();\n  }\n} catch {\n  redis = null;\n}\n\n// One-time production warning when rate limiting is disabled due to missing env\nlet warned = false;\nif (!redis && process.env.NODE_ENV === 'production' && !warned) {\n  warned = true;\n  console.warn(\"[ratelimit] Upstash env vars are missing in production; API routes will not be rate limited.\");\n}\n\nexport function getClientIp(req: Request): string {\n  const xf = req.headers.get(\"x-forwarded-for\");\n  if (xf) return xf.split(\",\")[0].trim();\n  const realIp = (req.headers.get(\"x-real-ip\") || \"\").trim();\n  return realIp || \"unknown\";\n}\n\nfunction makeLimiter(prefix: string, max: number, window: string) {\n  if (redis) {\n    return new Ratelimit({\n      redis,\n      limiter: Ratelimit.slidingWindow(max, window as any),\n      analytics: true,\n      prefix,\n    });\n  }\n  // No-op limiter for local build/dev without env\n  return {\n    async limit(_key: string) {\n      return { success: true } as const;\n    },\n  } as unknown as Ratelimit;\n}\n\n// Sliding window: 30 req / 30s for search\nexport const searchLimiter = makeLimiter(\"rl:search\", 30, \"30 s\");\n\n// Uploads: 20 req / min per IP\nexport const uploadLimiter = makeLimiter(\"rl:upload\", 20, \"60 s\");\n\n// Cloudinary sign: 60 req / min per IP\nexport const signLimiter = makeLimiter(\"rl:sign\", 60, \"60 s\");\n\n// Auth endpoints (e.g., check-email): 30 req / min per IP\nexport const authLimiter = makeLimiter(\"rl:auth\", 30, \"60 s\");\n\n// Marketing (newsletter): 20 req / min per IP\nexport const marketingLimiter = makeLimiter(\"rl:marketing\", 20, \"60 s\");\n\n// Contact form submissions: 10 req / 5 min per IP\nexport const contactLimiter = makeLimiter(\"rl:contact\", 10, \"300 s\");\n\n// CJ webhook: 120 req / min per IP (adjust if needed based on CJ event volume)\nexport const cjWebhookLimiter = makeLimiter(\"rl:cj_webhook\", 120, \"60 s\");\n\n// Chat: 15 req / min per IP\nexport const chatLimiter = makeLimiter(\"rl:chat\", 15, \"60 s\");\n\n// Shipping calc: 60 req / min per IP\nexport const shippingLimiter = makeLimiter(\"rl:shipping\", 60, \"60 s\");\n","path":null,"size_bytes":2550,"size_tokens":null},"src/app/admin/blog/_components/blog-form.tsx":{"content":"\"use client\";\n\nimport { useFormState, useFormStatus } from \"react-dom\";\nimport { addBlogPost, updateBlogPost } from \"@/app/admin/blog/actions\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\n\ntype FormState = {\n  message: string; // keep string to satisfy inferred union from server action\n  fieldErrors: Record<string, string[] | undefined> | null;\n};\n\nconst initialState: FormState = { message: \"\", fieldErrors: null };\n\nfunction SubmitButton({ isEditing }: { isEditing: boolean }) {\n  const { pending } = useFormStatus();\n  return (\n    <Button type=\"submit\" disabled={pending} className=\"w-full\">\n      {pending ? (isEditing ? \"Updating...\" : \"Adding...\") : (isEditing ? \"Update Post\" : \"Add Post\")}\n    </Button>\n  );\n}\n\nexport default function BlogForm({\n  initial,\n  mode,\n}: {\n  initial?: { id?: number; title?: string; slug?: string; excerpt?: string | null; content?: string | null; published?: boolean };\n  mode: \"create\" | \"edit\";\n}) {\n  const action = mode === \"edit\" ? updateBlogPost : addBlogPost;\n  const [state, formAction] = useFormState<FormState, FormData>(action, initialState);\n\n  return (\n    <form action={formAction} className=\"max-w-xl space-y-4\">\n      {mode === \"edit\" && initial?.id != null && (\n        <input type=\"hidden\" name=\"id\" value={initial.id} />\n      )}\n\n      <div className=\"grid gap-2\">\n        <Label htmlFor=\"title\">Title</Label>\n        <Input id=\"title\" name=\"title\" defaultValue={initial?.title || \"\"} required />\n        {state.fieldErrors?.title && <p className=\"text-xs text-destructive\">{state.fieldErrors.title.join(\", \")}</p>}\n      </div>\n\n      <div className=\"grid gap-2\">\n        <Label htmlFor=\"slug\">Slug</Label>\n        <Input id=\"slug\" name=\"slug\" defaultValue={initial?.slug || \"\"} required />\n        {state.fieldErrors?.slug && <p className=\"text-xs text-destructive\">{state.fieldErrors.slug.join(\", \")}</p>}\n      </div>\n\n      <div className=\"grid gap-2\">\n        <Label htmlFor=\"excerpt\">Excerpt</Label>\n        <Textarea id=\"excerpt\" name=\"excerpt\" defaultValue={initial?.excerpt || \"\"} />\n      </div>\n\n      <div className=\"grid gap-2\">\n        <Label htmlFor=\"content\">Content</Label>\n        <Textarea id=\"content\" name=\"content\" defaultValue={initial?.content || \"\"} rows={8} />\n      </div>\n\n      <div className=\"flex items-center gap-2\">\n        <input id=\"published\" name=\"published\" type=\"checkbox\" defaultChecked={initial?.published ?? true} />\n        <Label htmlFor=\"published\">Published</Label>\n      </div>\n\n      <div className=\"pt-2\">\n        <SubmitButton isEditing={mode === \"edit\"} />\n        {Boolean(state.message) && !state.fieldErrors && (\n          <p className=\"mt-2 text-sm text-destructive\">{state.message}</p>\n        )}\n      </div>\n    </form>\n  );\n}\n","path":null,"size_bytes":2901,"size_tokens":null},"src/lib/ai/enrich.ts":{"content":"type GenOpts = { locale?: 'en' | 'ar'; };\n\nconst OPENAI_ENDPOINT = 'https://api.openai.com/v1/chat/completions';\n\nasync function callLLM(system: string, user: string): Promise<string> {\n  const key = process.env.OPENAI_API_KEY;\n  if (!key) {\n    // Fallback: return a safe deterministic stub to avoid blocking flows\n    return user.slice(0, 512);\n  }\n  const model = process.env.AI_MODEL_TEXT || 'gpt-4o-mini';\n  const res = await fetch(OPENAI_ENDPOINT, {\n    method: 'POST',\n    headers: {\n      'Authorization': `Bearer ${key}`,\n      'Content-Type': 'application/json',\n    },\n    body: JSON.stringify({\n      model,\n      messages: [\n        { role: 'system', content: system },\n        { role: 'user', content: user },\n      ],\n      temperature: 0.3,\n    }),\n  });\n  if (!res.ok) {\n    return user.slice(0, 512);\n  }\n  const data = await res.json();\n  return data.choices?.[0]?.message?.content || user.slice(0, 512);\n}\n\nexport async function generateTitle(base: string, opts: GenOpts = {}): Promise<string> {\n  const system = 'You are a concise e-commerce product title writer.';\n  const user = `Title: ${base}\\nRules: <= 60 chars, no emojis, capitalize properly.`;\n  const out = await callLLM(system, user);\n  return out.trim();\n}\n\nexport async function generateDescription(base: string, opts: GenOpts = {}): Promise<string> {\n  const system = 'You write product descriptions with bullets and a short paragraph.';\n  const user = `Product: ${base}\\nWrite 1 short paragraph and 3–5 bullets.`;\n  const out = await callLLM(system, user);\n  return out.trim();\n}\n\nexport async function translateAr(text: string): Promise<string> {\n  const system = 'Translate to Arabic with natural phrasing and RTL awareness. Keep meaning and tone.';\n  const user = text;\n  const out = await callLLM(system, user);\n  return out.trim();\n}\n","path":null,"size_bytes":1826,"size_tokens":null},"src/app/api/admin/cj/diag/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getAccessToken } from '@/lib/cj/v2';\nimport { fetchWithMeta } from '@/lib/http';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { hasTable } from '@/lib/db-features';\n\nexport const runtime = 'nodejs';\n\nfunction getBase(): string {\n  const b = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n  return b.replace(/\\/$/, '');\n}\n\nexport async function GET(req: Request) {\n  const out: any = { ok: false };\n  const log = loggerForRequest(req);\n  try {\n    const { searchParams } = new URL(req.url);\n    const testPid = searchParams.get('pid') || undefined;\n    const kw = searchParams.get('kw') || 'dress';\n\n    // Admin guard\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      log.warn('cj_diag_unauthorized', { reason: guard.reason });\n      return NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 });\n    }\n\n    log.info('cj_diag_start', { kw, pid: testPid });\n\n    // 1) Token\n    let token: string | null = null;\n    try {\n      token = await getAccessToken();\n      out.tokenObtained = true;\n      out.tokenPreview = token ? token.slice(0, 6) + '...' + token.slice(-6) : null;\n    } catch (e: any) {\n      out.tokenObtained = false;\n      // Provide configuration hints to speed up setup\n      out.config = {\n        hasCJEmail: !!process.env.CJ_EMAIL,\n        hasCJApiKey: !!process.env.CJ_API_KEY,\n        hasManualAccessToken: !!process.env.CJ_ACCESS_TOKEN,\n        hasIntegrationTokensTable: await hasTable('integration_tokens').catch(() => false),\n        base: getBase(),\n      };\n      out.error = e?.message || String(e);\n    }\n\n    // If no token, stop early\n    if (!out.tokenObtained) {\n      return NextResponse.json({ ok: false, step: 'token', ...out }, { status: 500 });\n    }\n\n    // Fetch helper preserving status/ok/body with timeouts & retries\n    async function probe(path: string) {\n      const url = `${getBase()}${path.startsWith('/') ? '' : '/'}${path}`;\n      const r = await fetchWithMeta<any>(url, {\n        method: 'GET',\n        headers: { 'CJ-Access-Token': token as string },\n        cache: 'no-store',\n        timeoutMs: 12000,\n        retries: 2,\n      });\n      log.info('cj_diag_probe', { path, status: r.status, ok: r.ok });\n      return r;\n    }\n\n    out.tests = {};\n    out.tests.productList = await probe(`/product/list?keyWords=${encodeURIComponent(kw)}&pageSize=1&pageNum=1`);\n    out.tests.queryKeyword = await probe(`/product/query?keyword=${encodeURIComponent(kw)}&pageSize=1&pageNumber=1`);\n    out.tests.myProductKeyword = await probe(`/product/myProduct/query?keyword=${encodeURIComponent(kw)}&pageSize=1&pageNumber=1`);\n    if (testPid) out.tests.queryPid = await probe(`/product/query?pid=${encodeURIComponent(testPid)}`);\n\n    out.ok = true;\n    const resp = NextResponse.json(out);\n    resp.headers.set('x-request-id', log.requestId);\n    return resp;\n  } catch (e: any) {\n    out.ok = false;\n    out.error = e?.message || String(e);\n    log.error('cj_diag_error', { error: out.error });\n    const resp = NextResponse.json(out, { status: 500 });\n    resp.headers.set('x-request-id', log.requestId);\n    return resp;\n  }\n}\n","path":null,"size_bytes":3251,"size_tokens":null},"src/app/api/admin/cj/products/auto-import/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike, type CjProductLike } from '@/lib/cj/v2';\nimport { slugify } from '@/lib/utils/slug';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { hasTable } from '@/lib/db-features';\nimport { isKillSwitchOn } from '@/lib/settings';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function ensureUniqueSlug(admin: any, base: string): Promise<string> {\n  const s = slugify(base);\n  let candidate = s;\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin\n      .from('products')\n      .select('id')\n      .eq('slug', candidate)\n      .maybeSingle();\n    if (!data) return candidate;\n    candidate = `${s}-${i}`;\n  }\n  return `${s}-${Date.now()}`;\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, version: 'auto-import-v2', error: guard.reason }, { status: 401, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      const r = NextResponse.json({ ok: false, error: 'Server not configured' }, { status: 500 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // Global kill-switch enforcement: block write operations\n    if (await isKillSwitchOn()) {\n      const r = NextResponse.json({ ok: false, version: 'auto-import-v2', error: 'Kill switch is ON. Auto-import is temporarily disabled.' }, { status: 423, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const { searchParams } = new URL(req.url);\n    const keywordsParam = searchParams.get('keywords') || '';\n    const limit = Math.max(1, Math.min(10, Number(searchParams.get('limit') || '2')));\n    const categoryParam = (searchParams.get('category') || 'General').trim();\n\n    const keywords = keywordsParam\n      .split(',')\n      .map((s) => s.trim())\n      .filter(Boolean);\n    if (keywords.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'Provide ?keywords=women%20dress,women%20blouse&limit=2' }, { status: 400 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // 1) Aggregate results from CJ for all keywords\n    const pool: any[] = [];\n    for (const kw of keywords) {\n      try {\n        const raw = await queryProductByPidOrKeyword({ keyword: kw });\n        const itemsRaw = Array.isArray(raw?.data?.list)\n          ? raw.data.list\n          : Array.isArray(raw?.data?.content)\n            ? raw.data.content\n            : Array.isArray(raw?.content)\n              ? raw.content\n              : Array.isArray(raw?.data)\n                ? raw.data\n                : Array.isArray(raw)\n                  ? raw\n                  : (raw?.data ? [raw.data] : []);\n        for (const it of itemsRaw) {\n          const mapped = mapCjItemToProductLike(it);\n          if (mapped) pool.push(mapped);\n        }\n      } catch (e) {\n        // continue\n      }\n    }\n\n    // 2) Deduplicate by productId and take first N\n    const seen = new Set<string>();\n    const selected: CjProductLike[] = [];\n    for (const it of pool) {\n      if (!it.productId) continue;\n      if (seen.has(it.productId)) continue;\n      seen.add(it.productId);\n      selected.push(it);\n      if (selected.length >= limit) break;\n    }\n\n    if (selected.length === 0) {\n      const r = NextResponse.json({ ok: false, error: 'No CJ products found from given keywords' }, { status: 404 });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    // 3) Import selected items (same logic as POST import route)\n    const results: any[] = [];\n\n    const hasVariantsTable = await hasTable('product_variants');\n\n    for (const cj of selected) {\n      try {\n        const { data: existing } = await supabase\n          .from('products')\n          .select('id, slug')\n          .eq('cj_product_id', cj.productId)\n          .maybeSingle();\n\n        const baseSlug = await ensureUniqueSlug(supabase, cj.name);\n        // Compute a conservative product price using min retail without shipping if we can compute; fallback to min supplier cost\n        const priceCandidates = (cj.variants || []).map((v) => (typeof v.price === 'number' ? v.price : NaN)).filter((n) => !isNaN(n));\n        const defaultPrice = priceCandidates.length > 0 ? Math.min(...priceCandidates) : 0;\n        const totalStock = (cj.variants || []).reduce((acc, v) => acc + (typeof v.stock === 'number' ? v.stock : 0), 0);\n\n        let productPayload: any = {\n          title: cj.name,\n          slug: existing?.slug || baseSlug,\n          description: '',\n          price: defaultPrice,\n          images: cj.images || [],\n          category: categoryParam,\n          stock: totalStock,\n          video_url: cj.videoUrl || null,\n          processing_time_hours: null,\n          delivery_time_hours: cj.deliveryTimeHours ?? null,\n          origin_area: cj.originArea ?? null,\n          origin_country_code: cj.originCountryCode ?? null,\n          free_shipping: true,\n          inventory_shipping_fee: 0,\n          last_mile_fee: 0,\n          cj_product_id: cj.productId,\n          shipping_from: cj.originArea ?? null,\n          is_active: true,\n        };\n\n        // Omit is_active if column missing\n        try {\n          const probeActive = await supabase.from('products').select('is_active').limit(1);\n          if (probeActive.error) {\n            const { is_active, ...rest } = productPayload;\n            productPayload = rest;\n          }\n        } catch {\n          const { is_active, ...rest } = productPayload;\n          productPayload = rest;\n        }\n\n        let productId: number;\n        if (existing?.id) {\n          const { data: upd, error: upErr } = await supabase\n            .from('products')\n            .update(productPayload)\n            .eq('id', existing.id)\n            .select('id')\n            .single();\n          if (upErr || !upd) throw upErr || new Error('Failed to update product');\n          productId = upd.id as number;\n\n          await supabase.from('product_variants').delete().eq('product_id', productId);\n        } else {\n          const { data: ins, error: insErr } = await supabase\n            .from('products')\n            .insert(productPayload)\n            .select('id')\n            .single();\n          if (insErr || !ins) throw insErr || new Error('Failed to insert product');\n          productId = ins.id as number;\n        }\n\n        if (hasVariantsTable) {\n          const variantsRows = (cj.variants || [])\n            .filter((v) => v && ((v.size || v.color) || v.cjSku))\n            .map((v) => {\n              const color = (v as any).color || null;\n              const size = (v as any).size || null;\n              const optionValue = color ? (size ? `${color} / ${size}` : color) : (size || '-');\n              return {\n                product_id: productId,\n                option_name: 'Variant',\n                option_value: optionValue,\n                cj_sku: v.cjSku || null,\n                price: typeof v.price === 'number' ? v.price : null,\n                stock: typeof v.stock === 'number' ? v.stock : 0,\n                weight_grams: typeof (v as any).weightGrams === 'number' ? Math.round((v as any).weightGrams) : null,\n                length_cm: typeof (v as any).lengthCm === 'number' ? (v as any).lengthCm : null,\n                width_cm: typeof (v as any).widthCm === 'number' ? (v as any).widthCm : null,\n                height_cm: typeof (v as any).heightCm === 'number' ? (v as any).heightCm : null,\n              } as any;\n            });\n          if (variantsRows.length > 0) {\n            const { error: vErr } = await supabase.from('product_variants').insert(variantsRows as any[]);\n            if (vErr) throw vErr;\n          }\n        }\n\n        try {\n          await supabase.rpc('recompute_product_stock', { product_id_in: productId });\n        } catch {}\n\n        results.push({ ok: true, productId, title: cj.name });\n      } catch (e: any) {\n        results.push({ ok: false, error: e?.message || String(e), title: cj?.name });\n      }\n    }\n\n    const r = NextResponse.json({ ok: true, version: 'auto-import-v2', selected: selected.map((s) => ({ productId: s.productId, name: s.name })), results }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, version: 'auto-import-v2', error: e?.message || 'Auto import failed' }, { status: 500, headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":9220,"size_tokens":null},"src/app/faq/page.tsx":{"content":"export const metadata = { title: \"FAQ\" };\n\nexport default function FaqPage() {\n  const faqs = [\n    { q: \"What payment methods are available?\", a: \"We support payment via Stripe and credit cards. More options will be enabled soon.\" },\n    { q: \"Do you offer returns?\", a: \"Yes, 30-day returns for eligible products according to our return policy.\" },\n    { q: \"How long does shipping take?\", a: \"Most orders ship within 2 business days. Delivery time varies by location.\" },\n  ];\n  return (\n    <div className=\"container max-w-3xl py-10\">\n      <h1 className=\"text-3xl font-bold\">Frequently Asked Questions</h1>\n      <div className=\"mt-6 space-y-6\">\n        {faqs.map((f) => (\n          <div key={f.q} className=\"rounded-xl border bg-white p-5 shadow-sm\">\n            <div className=\"font-semibold\">{f.q}</div>\n            <div className=\"mt-2 text-slate-700 text-sm\">{f.a}</div>\n          </div>\n        ))}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":941,"size_tokens":null},"src/app/api/cj/inspect/[pid]/route.ts":{"content":"import { NextResponse } from 'next/server'\nimport { ensureAdmin } from '@/lib/auth/admin-guard'\nimport { loggerForRequest } from '@/lib/log'\nimport { mapCjItemToProductLike, queryProductByPidOrKeyword } from '@/lib/cj/v2'\n\nexport const runtime = 'nodejs'\nexport const dynamic = 'force-dynamic'\nexport const revalidate = 0\n\nexport async function GET(req: Request, ctx: { params: { pid: string } }) {\n  const log = loggerForRequest(req)\n  try {\n    const guard = await ensureAdmin()\n    if (!guard.ok) {\n      const r = NextResponse.json({ ok: false, error: 'Unauthorized' }, { status: 401 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const pid = decodeURIComponent(ctx.params.pid)\n    if (!pid) {\n      const r = NextResponse.json({ ok: false, error: 'Missing pid' }, { status: 400 })\n      r.headers.set('x-request-id', log.requestId)\n      return r\n    }\n\n    const raw = await queryProductByPidOrKeyword({ pid })\n    const itemRaw = Array.isArray(raw?.data?.list)\n      ? raw.data.list[0]\n      : Array.isArray(raw?.data?.content)\n        ? raw.data.content[0]\n        : Array.isArray(raw?.content)\n          ? raw.content[0]\n          : Array.isArray(raw?.data)\n            ? raw.data[0]\n            : (raw?.data || raw)\n\n    const mapped = mapCjItemToProductLike(itemRaw)\n\n    const r = NextResponse.json({ ok: true, mapped, raw: itemRaw })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  } catch (e: any) {\n    const r = NextResponse.json({ ok: false, error: e?.message || 'inspect failed' }, { status: 500 })\n    r.headers.set('x-request-id', log.requestId)\n    return r\n  }\n}\n","path":null,"size_bytes":1634,"size_tokens":null},"src/lib/categories.ts":{"content":"export type CategoryDef = { slug: string; label: string };\n\nexport const CATEGORIES: CategoryDef[] = [\n  { slug: \"general\", label: \"General\" },\n  { slug: \"new-in\", label: \"New Arrivals\" },\n  { slug: \"sale\", label: \"Sale\" },\n  { slug: \"women\", label: \"Women's Clothing\" },\n  { slug: \"plus-size\", label: \"Women's Plus Size\" },\n  { slug: \"womens-shoes\", label: \"Women's Shoes\" },\n  { slug: \"women-beachwear\", label: \"Beachwear\" },\n  { slug: \"men\", label: \"Men's Clothing\" },\n  { slug: \"men-plus-size\", label: \"Men's Plus Size\" },\n  { slug: \"men-underwear\", label: \"Men's Underwear\" },\n  { slug: \"underwear-sleepwear\", label: \"Women's Underwear & Sleepwear\" },\n  { slug: \"home-kitchen\", label: \"Home & Kitchen\" },\n  { slug: \"furniture\", label: \"Furniture\" },\n  { slug: \"health-beauty\", label: \"Health & Beauty\" },\n  { slug: \"health-household\", label: \"Health & Household\" },\n  { slug: \"baby-maternity\", label: \"Baby & Maternity\" },\n  { slug: \"jewelry-accessories\", label: \"Jewelry & Accessories\" },\n  { slug: \"bags-luggage\", label: \"Bags & Luggage\" },\n  { slug: \"toys\", label: \"Toys\" },\n  { slug: \"tools-home-improvement\", label: \"Tools & Home Improvement\" },\n  { slug: \"office-school\", label: \"Office & School Supplies\" },\n  { slug: \"mobile-accessories\", label: \"Phones & Accessories\" },\n  { slug: \"electronics\", label: \"Electronics\" },\n  { slug: \"musical-instruments\", label: \"Musical Instruments\" },\n  { slug: \"smart-home\", label: \"Smart Home\" },\n  { slug: \"appliances\", label: \"Appliances\" },\n  { slug: \"automotive\", label: \"Automotive\" },\n  { slug: \"pet-supplies\", label: \"Pet Supplies\" },\n  { slug: \"yard-garden\", label: \"Yard & Garden\" },\n  { slug: \"kids-fashion\", label: \"Kids' Fashion\" },\n  { slug: \"kids-shoes\", label: \"Kids' Shoes\" },\n  { slug: \"mens-shoes\", label: \"Men's Shoes\" },\n  { slug: \"business-industry-science\", label: \"Business & Industrial\" },\n  { slug: \"arts-crafts-sewing\", label: \"Arts, Crafts & Sewing\" },\n];\n\nexport function labelFromSlug(slug: string): string |\n  undefined {\n  const s = (slug || \"\").trim().toLowerCase();\n  const found = CATEGORIES.find((c) => c.slug === s);\n  return found?.label;\n}\n\nexport function slugFromLabel(label: string): string {\n  const l = (label || \"\").trim();\n  const exact = CATEGORIES.find((c) => c.label.toLowerCase() === l.toLowerCase());\n  if (exact) return exact.slug;\n  return l.toLowerCase().replace(/\\s+/g, \"-\");\n}\n\n// Rich dataset for menus with images and optional children\nexport type FullCategoryChild = { slug: string; label: string; image?: string };\n\nexport type FullCategory = {\n  slug: string;\n  label: string;\n  image?: string; // Square or 4:3 works best\n  children?: FullCategoryChild[];\n};\n\nexport const FULL_CATEGORIES: FullCategory[] = [\n  {\n    slug: \"women\",\n    label: \"Women's Clothing\",\n    image: \"https://images.unsplash.com/photo-1572804013427-4d7ca7268211?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"women-coats\", label: \"Women's Coats & Jackets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758126604/17defd5f299efa43102b8c7602fe8a00_zpcjw6_tc8uja.jpg\" },\n      { slug: \"women-tshirts\", label: \"Women's T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758126646/photo-1710954962775-c46bd6a5f67f_k8r0jx.avif\" },\n      { slug: \"women-dresses\", label: \"Women's Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758126954/photo-1739544252344-85d230322e9d_ncjqbc.avif\" },\n      { slug: \"women-sweaters\", label: \"Women's Sweaters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758130336/photo-1687275168955-aacd8bba29cf_sg1zgn.avif\" },\n      { slug: \"women-two-piece-sets\", label: \"Women's Two-Piece Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758131359/photo-1613419489076-15da367b38df_jrregr.avif\" },\n      { slug: \"women-blouses-shirts\", label: \"Women's Blouses & Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758131516/premium_photo-1669559419417-f2ef4227afbe_sfuubu.avif\" },\n      { slug: \"women-trousers\", label: \"Women's Trousers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758131654/photo-1561104726-210cbc28c2eb_juck5q.avif\" },\n      { slug: \"women-jeans\", label: \"Women's Jeans\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758131792/photo-1632852301634-96b856283a5e_hvajjy.avif\" },\n      { slug: \"women-hoodies-sweatshirts\", label: \"Women's Hoodies & Sweatshirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758131978/photo-1618333272197-2ee791c42963_ffcbrt.avif\" },\n      { slug: \"women-sportswear\", label: \"Women's Sportswear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758132045/photo-1737231808017-43e87b998685_rcrccz.avif\" },\n      { slug: \"women-skirts\", label: \"Women's Skirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758132148/photo-1615898290907-0ad011905389_l1fcqp.avif\" },\n      { slug: \"women-blazers\", label: \"Women's Blazers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758132342/photo-1748620755011-139976988d08_uskcfg.avif\" },\n      { slug: \"women-tanks-camis\", label: \"Women's Tank Tops & Camis\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758132512/photo-1597582927786-bae43be837a0_veuec0.avif\" },\n      { slug: \"women-skinny-pants\", label: \"Women's Skinny Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758132728/premium_photo-1689371952452-c88c72464115_hc6jhh.avif\" },\n      { slug: \"women-wedding-party-dresses\", label: \"Women's Wedding & Party Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758133066/photo-1637794895556-faf0a6012c38_lazgk4.avif\" },\n      { slug: \"women-jumpsuits\", label: \"Women's Jumpsuits\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758133411/premium_photo-1673758894830-b24d44000f70_ckxlwf.avif\" },\n      { slug: \"women-sport-jackets\", label: \"Women's Sport Jackets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758133582/photo-1722620197153-eb2549909098_gze8ug.avif\" },\n      { slug: \"women-maternity\", label: \"Maternity Clothing\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758133737/photo-1693426967931-b3c758c29f0e_nthoom.avif\" },\n      { slug: \"women-work-safety\", label: \"Women's Work & Safety Wear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758133934/photo-1753161024053-4ef8b6237973_vek323.avif\" },\n      { slug: \"women-lingerie\", label: \"Women's Lingerie\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134112/premium_photo-1671641797213-920dc610f1dd_ghicj1.avif\" },\n      { slug: \"women-traditional-cultural\", label: \"Traditional & Cultural Wear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134230/photo-1649109669076-a432665c5dcb_imvccf.avif\" },\n      { slug: \"women-shorts\", label: \"Women's Shorts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134327/photo-1595537021571-e2c8ffa1d587_inloag.avif\" },\n      { slug: \"women-jeans-styles\", label: \"Women's Jeans Styles\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134655/premium_photo-1664476740901-e78f939dd485_e7ujik.avif\" },\n      { slug: \"women-denim-jackets\", label: \"Women's Denim Jackets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134753/premium_photo-1664476326681-7cbb5bb87c2a_xukwzz.avif\" },\n      { slug: \"women-denim-skirts\", label: \"Women's Denim Skirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134843/photo-1619627826693-8b40c611ca59_dc2xwy.avif\" },\n      { slug: \"women-costumes\", label: \"Women's Costumes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758134968/photo-1616065758546-a50b6d3190b1_izuuiz.avif\" },\n    ],\n  },\n  {\n    slug: \"men\",\n    label: \"Men's Clothing\",\n    image: \"https://images.unsplash.com/photo-1610384104075-e04c883de4e2?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"men-outerwear\", label: \"Men's Jackets & Coats\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758148715/photo-1636721316790-d2552899e77d_e4s1xq.avif\" },\n      { slug: \"men-tshirts\", label: \"Men's T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758148781/premium_photo-1689629728966-0d248b5aeda2_pw0ujp.avif\" },\n      { slug: \"men-coords\", label: \"Men's Coord Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758148896/download_du25dx.jpg\" },\n      { slug: \"men-casual-long-pants\", label: \"Men's Casual Long Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149276/photo-1742310134130-3709910c4728_znjm30.avif\" },\n      { slug: \"men-jeans\", label: \"Men's Jeans\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149283/premium_photo-1727942419701-0428352a21e1_gi8bse.avif\" },\n      { slug: \"men-hoodies-knit\", label: \"Men's Hoodies & Sweatshirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149338/premium_photo-1673827311290-d435f481152e_c03k6h.avif\" },\n      { slug: \"men-casual-wear\", label: \"Men's Casual Wear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149394/photo-1669791777450-d1ab3816c26d_usjyuf.avif\" },\n      { slug: \"men-polo\", label: \"Men's Polo Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149442/photo-1654432008908-f7bf0b14f4fc_jyt4ld.avif\" },\n      { slug: \"men-tops\", label: \"Men's Tops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149481/photo-1621060348025-e70d6540dce6_hvsvtp.avif\" },\n      { slug: \"men-suits-separates\", label: \"Men's Suits & Separates\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149492/premium_photo-1673734626655-0c1dc4be0e9c_f74bay.avif\" },\n      { slug: \"men-shorts\", label: \"Men's Shorts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149513/photo-1617953644310-e690da9be982_xhg6cg.avif\" },\n      { slug: \"men-cargo-pants\", label: \"Men's Cargo Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758149545/photo-1690908719438-330c0045d408_awikew.avif\" },\n    ],\n  },\n  {\n    slug: \"womens-shoes\",\n    label: \"Women's Shoes\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143831/premium_photo-1728947850665-32f996262c5a_bx9yhi.avif\",\n    children: [\n      { slug: \"women-denim-shoes\", label: \"Women's Denim Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758135098/photo-1554238113-6d3dbed5cf55_rdn0jo.avif\" },\n      { slug: \"women-sneakers-trendy\", label: \"Women's Trendy Sneakers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143656/photo-1695225897718-b657a89ca78f_zhbefr.avif\" },\n      { slug: \"women-ankle-boots\", label: \"Women's Ankle Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143667/premium_photo-1671718110912-2bf5ce67d504_lz71jf.avif\" },\n      { slug: \"women-slides\", label: \"Women's Slides\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143703/premium_photo-1703622846437-d99b08a906b0_jtkouk.avif\" },\n      { slug: \"women-high-heels\", label: \"Women's High Heels\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143831/premium_photo-1728947850665-32f996262c5a_bx9yhi.avif\" },\n      { slug: \"women-heeled-sandals\", label: \"Women's Heeled Sandals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143770/photo-1689914667397-a77effb740da_ifnmmk.avif\" },\n      { slug: \"women-loafers-slipon\", label: \"Women's Loafers & Slip-Ons\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143979/premium_photo-1670574914335-0bcd4a768d76_ruj2ft.avif\" },\n      { slug: \"women-block-heel-sandals\", label: \"Women's Block Heel Sandals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144105/photo-1614634717465-eb3d6bc8d930_bqm51l.avif\" },\n      { slug: \"women-mid-calf-boots\", label: \"Women's Mid-Calf Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144131/premium_photo-1728722637392-c0bd073341ad_il6l9e.avif\" },\n      { slug: \"women-light-sandals\", label: \"Women's Light Sandals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144170/istockphoto-1415050878-612x612_dmqmey.webp\" },\n      { slug: \"women-shoe-accessories\", label: \"Shoe Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144195/premium_photo-1673818515879-65ca32ff3ef1_svlmjh.avif\" },\n      { slug: \"women-flat-sandals\", label: \"Women's Flat Sandals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144856/photo-1662132090920-060bba5cdf18_ppp6ti.avif\" },\n      { slug: \"women-knee-high-boots\", label: \"Women's Knee-High Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144265/photo-1732708862072-d2f9e578e531_upcynl.avif\" },\n      { slug: \"women-flats\", label: \"Women's Flats\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144272/photo-1559334417-01b38aec66bd_kfajrh.avif\" },\n      { slug: \"women-heels-clogs\", label: \"Women's Heels & Clogs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144382/photo-1693026233053-f199c5c5d8f4_ygbs6c.avif\" },\n      { slug: \"women-over-knee-boots\", label: \"Women's Over-the-Knee Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144401/photo-1575425939273-46ecee6d6931_t3pocj.avif\" },\n      { slug: \"women-flip-flops\", label: \"Women's Flip Flops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144445/premium_photo-1727427850030-380bb3e0ec61_sdcsud.avif\" },\n      { slug: \"women-oxford-shoes\", label: \"Women's Oxford Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144527/premium_photo-1664438655922-3b10d3cbc3a4_jrtppu.avif\" },\n      { slug: \"women-canvas-shoes\", label: \"Women's Canvas Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144640/photo-1650320079970-b4ee8f0dae33_pei8id.avif\" },\n      { slug: \"women-work-safety-shoes\", label: \"Women's Work & Safety Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758144628/istockphoto-1452821935-612x612_ybrftt.webp\" },\n    ],\n  },\n  {\n    slug: \"mens-shoes\",\n    label: \"Men's Shoes\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150233/photo-1616663308968-58162d332720_ilcvwb.avif\",\n    children: [\n      { slug: \"men-casual-shoes\", label: \"Men's Casual Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150233/photo-1616663308968-58162d332720_ilcvwb.avif\" },\n      { slug: \"men-semi-formal-shoes\", label: \"Men's Semi-Formal Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150253/premium_photo-1668376939292-bd6953dd1bac_isv7zy.avif\" },\n      { slug: \"men-loafers-slipon\", label: \"Men's Loafers & Slip-Ons\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150366/photo-1426649397221-b62c5a7824ee_gk99w6.avif\" },\n      { slug: \"men-sandals\", label: \"Men's Sandals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150400/istockphoto-72736585-612x612_wfyy9w.webp\" },\n      { slug: \"men-flip-flops\", label: \"Men's Flip Flops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150423/photo-1662308074084-8e2d73c353e6_xhzzgy.avif\" },\n      { slug: \"men-ice-high-boots\", label: \"Men's Snow Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150455/premium_photo-1728158949815-2c32a7fd3229_n8vxzr.avif\" },\n      { slug: \"men-boots\", label: \"Men's Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150498/photo-1608629601270-a0007becead3_lwiciq.avif\" },\n      { slug: \"men-skate-shoes\", label: \"Men's Skate Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150518/photo-1707125249530-f1e3ee0a1b9c_nfrbdl.avif\" },\n      { slug: \"men-work-safety-shoes\", label: \"Men's Work & Safety Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150523/photo-1520518225010-711b4f0b1d32_nteinq.avif\" },\n      { slug: \"men-mules-clogs\", label: \"Men's Mules & Clogs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150569/OIP_pb5tom.webp\" },\n      { slug: \"men-canvas-shoes\", label: \"Men's Canvas Shoes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150633/istockphoto-1201660255-612x612_dpuwjv.webp\" },\n      { slug: \"men-rain-boots\", label: \"Men's Rain Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758150699/photo-1626808763451-ffd08dcf0c36_xdkcgr.avif\" },\n    ],\n  },\n  {\n    slug: \"men-plus-size\",\n    label: \"Men's Plus Size\",\n    image: \"https://images.unsplash.com/photo-1610384104075-e04c883de4e2?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"men-plus-tshirts\", label: \"Men's Plus Size T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151452/photo-1666358777322-a25eda95848f_kvnltq.avif\" },\n      { slug: \"men-plus-tops\", label: \"Men's Plus Size Tops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151457/photo-1742518424556-839a9846adee_ebnogf.avif\" },\n      { slug: \"men-plus-outerwear\", label: \"Men's Plus Size Jackets & Coats\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151491/photo-1660776864454-628551d83a2c_twh7xn.avif\" },\n      { slug: \"men-plus-sportswear\", label: \"Men's Plus Size Sportswear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151573/photo-1752778598489-ae34ac74ab34_ujjxnw.avif\" },\n      { slug: \"men-plus-pants\", label: \"Men's Plus Size Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151575/photo-1612653829925-ca7c5095129f_ny8aeu.avif\" },\n      { slug: \"men-plus-hoodies-sweatshirts\", label: \"Men's Plus Size Hoodies & Sweatshirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151664/photo-1617386124435-9eb3935b1e11_ltt3du.avif\" },\n      { slug: \"men-plus-jeans\", label: \"Men's Plus Size Jeans\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151745/photo-1746591847545-33d872de8411_cf89kl.avif\" },\n      { slug: \"men-plus-suits-sets\", label: \"Men's Plus Size Suits & Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151799/photo-1662833595899-07c57d617f56_tlvs7z.avif\" },\n      { slug: \"men-plus-shorts\", label: \"Men's Plus Size Shorts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151796/photo-1740512922260-543b1b83c986_upnccq.avif\" },\n      { slug: \"men-plus-sweaters\", label: \"Men's Plus Size Sweaters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151802/photo-1579592610812-49855d94db0d_wgup5n.avif\" },\n      { slug: \"men-plus-cargo-pants\", label: \"Men's Plus Size Cargo Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758151880/photo-1661110546807-4c1ce22ceced_chot5f.avif\" },\n      { slug: \"men-plus-swimwear\", label: \"Men's Plus Size Swimwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758152195/photo-1636016223841-e10d7a401ee4_nikk75.avif\" },\n    ],\n  },\n  {\n    slug: \"men-underwear\",\n    label: \"Men's Underwear\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188100/cn50714147_p2u7y5.avif\",\n    children: [\n      { slug: \"men-underwear\", label: \"Men's Underwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188100/cn50714147_p2u7y5.avif\" },\n      { slug: \"men-socks\", label: \"Men's Socks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188150/photo-1613151848917-80e67f421fff_jdoxwn.avif\" },\n      { slug: \"men-loungewear\", label: \"Men's Loungewear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188445/premium_photo-1708275668360-cd29b1f5b67d_smxvrz.avif\" },\n      { slug: \"men-shapewear\", label: \"Men's Shapewear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188490/photo-1582388734399-b929a2f0e114_p8mtmp.avif\" },\n      { slug: \"men-thermal-underwear\", label: \"Men's Thermal Underwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188675/OIP_rozsz6.webp\" },\n      { slug: \"men-novelty-wear\", label: \"Men's Novelty Wear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758188736/photo-1729719762110-6ad6e60f4dbd_jkop2h.avif\" },\n    ],\n  },\n  {\n    slug: \"plus-size\",\n    label: \"Women's Plus Size Clothing\",\n    image: \"https://images.unsplash.com/photo-1545291730-faff8ca1d4b0?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"plus-dresses\", label: \"Plus Size Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141211/istockphoto-1080827138-612x612_xw9ks6.webp\" },\n      { slug: \"plus-underwear\", label: \"Plus Size Underwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141290/photo-1652735822404-a981dfff31ca_m2sxaa.avif\" },\n      { slug: \"plus-coats-jackets\", label: \"Plus Size Coats & Jackets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141359/premium_photo-1700824489749-d6899ee77b60_xkgda6.avif\" },\n      { slug: \"plus-tshirts\", label: \"Plus Size T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141452/photo-1661110546797-d86cc72a2765_cn2ypw.avif\" },\n      { slug: \"plus-two-piece-sets\", label: \"Plus Size Two-Piece Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141619/premium_photo-1664885647785-784fc4615bdc_ovvbki.avif\" },\n      { slug: \"plus-denim\", label: \"Plus Size Denim\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141722/photo-1753719734459-91c8cfcc1c3d_gvdq4e.avif\" },\n      { slug: \"plus-loungewear-sleepwear\", label: \"Plus Size Loungewear & Sleepwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758141839/premium_photo-1661717385595-ac79e5dd64db_bchium.avif\" },\n      { slug: \"plus-blouses\", label: \"Plus Size Blouses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758143294/photo-1657862901690-815b2c028151_pwso5c.avif\" },\n      { slug: \"plus-shorts\", label: \"Plus Size Shorts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142015/photo-1588748570590-a8a5646c5c06_apdsrw.avif\" },\n      { slug: \"plus-knitwear\", label: \"Plus Size Knitwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142102/photo-1687275166296-7766371fd254_gbpphd.avif\" },\n      { slug: \"plus-cardigans\", label: \"Plus Size Cardigans\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142148/photo-1606765729255-ae25ca132476_otuxbu.avif\" },\n      { slug: \"plus-sweatshirts\", label: \"Plus Size Sweatshirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142234/premium_photo-1693161218384-ec9203e2a9c7_d2aknz.avif\" },\n      { slug: \"plus-leggings\", label: \"Plus Size Leggings\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142382/premium_photo-1664537979948-a87ffe6aa45f_iiodif.avif\" },\n      { slug: \"plus-wedding-party-dresses\", label: \"Plus Size Wedding & Party Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142391/photo-1756267236010-45c19888555d_d8m6uf.avif\" },\n      { slug: \"plus-sport-trousers\", label: \"Plus Size Sport Trousers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142457/premium_photo-1726731186132-8eeaf636e419_rpjthm.avif\" },\n      { slug: \"plus-skirts\", label: \"Plus Size Skirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142573/photo-1561289765-55534c357c18_arghek.avif\" },\n      { slug: \"plus-suits\", label: \"Plus Size Suits\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142603/photo-1610271468724-03d406367a66_dd9znz.avif\" },\n      { slug: \"plus-sport-shirts\", label: \"Plus Size Sport Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142670/photo-1715441330070-3c74704ab287_jboghg.avif\" },\n      { slug: \"plus-tanks-camis\", label: \"Plus Size Tank Tops & Camis\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142618/photo-1614569410453-7b963b557798_ulvgya.avif\" },\n      { slug: \"plus-jumpsuits-bodysuits\", label: \"Plus Size Jumpsuits & Bodysuits\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142793/images_whbwbf.jpg\" },\n      { slug: \"plus-sport-jackets\", label: \"Plus Size Sport Jackets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142901/photo-1674478969244-a8bbf5e06624_hp5c1u.avif\" },\n      { slug: \"plus-lingerie-sexy\", label: \"Plus Size Lingerie & Sexy Wear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758142919/photo-1589579116155-d251612794c0_eucavz.avif\" },\n    ],\n  },\n  \n  {\n    slug: \"women-beachwear\",\n    label: \"Women's Beachwear\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197437/photo-1753192108400-7e73fb581d69_lecj00.avif\",\n    children: [\n      { slug: \"women-bikini-sets\", label: \"Women's Bikini Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197419/photo-1605207375962-2190296c105b_k9lcis.avif\" },\n      { slug: \"women-one-piece-swimsuits\", label: \"Women's One-Piece Swimsuits\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197428/photo-1587660987491-ffd22589feec_k11t7h.avif\" },\n      { slug: \"women-sun-protective-beach-dresses\", label: \"Women's Sun-Protective Beach Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197437/photo-1753192108400-7e73fb581d69_lecj00.avif\" },\n      { slug: \"women-tankini\", label: \"Women's Tankini\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197456/photo-1600704983834-593c722008e2_zs4x9i.avif\" },\n      { slug: \"women-sun-protective-swimwear\", label: \"Women's Sun-Protective Swimwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197510/photo-1586929918504-61db224bbd0e_uwjsyf.avif\" },\n      { slug: \"women-plus-tankini\", label: \"Plus Size Tankini\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197573/premium_photo-1663040464433-be6c15ecacb8_ytalxt.avif\" },\n      { slug: \"women-plus-coverups\", label: \"Plus Size Cover-Ups\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197586/photo-1753192104240-209f3fb568ef_yppuho.avif\" },\n      { slug: \"women-plus-one-piece-swimsuits\", label: \"Plus Size One-Piece Swimsuits\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197620/photo-1620798821093-c32bef1c63ac_bdouqk.avif\" },\n      { slug: \"women-beachwear-sets\", label: \"Women's Beachwear Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197649/premium_photo-1753792637704-ac68a3bed771_nzb33x.avif\" },\n      { slug: \"women-plus-bikini-sets\", label: \"Plus Size Bikini Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197669/premium_photo-1723291257136-3430d2d444c7_pfd8fq.avif\" },\n      { slug: \"women-beach-pants\", label: \"Women's Beach Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197679/photo-1691315894355-83188bd4e8e5_xbuffw.avif\" },\n      { slug: \"women-bikini-bottoms\", label: \"Women's Bikini Bottoms\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197814/photo-1749220781965-b745d9efd3ce_opgfk2.avif\" },\n      { slug: \"women-bikini-tops\", label: \"Women's Bikini Tops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197857/photo-1586024683109-bd4744fe61a3_m6ql93.avif\" },\n      { slug: \"women-plus-swim-bottoms\", label: \"Plus Size Swim Bottoms\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197878/premium_photo-1661477956574-face6de508a8_p64fmo.avif\" },\n      { slug: \"women-plus-bikini-tops\", label: \"Plus Size Bikini Tops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197971/premium_photo-1723575741045-649f317a4103_lvq8lm.avif\" },\n    ],\n  },\n  {\n    slug: \"kids-shoes\",\n    label: \"Kids' Shoes\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239981/photo-1497319892902-e0a47680bb6b_bv5zcf.avif\",\n    children: [\n      { slug: \"girls-boots\", label: \"Girls' Boots\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239981/photo-1497319892902-e0a47680bb6b_bv5zcf.avif\" },\n      { slug: \"boys-sneakers\", label: \"Boys' Sneakers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239953/photo-1624991368922-3286d19c7fa5_yfcnlk.avif\" },\n      { slug: \"girls-sneakers\", label: \"Girls' Sneakers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239996/photo-1622920609618-6d06f2b27aea_hr4au4.avif\" },\n      { slug: \"boys-sports-products\", label: \"Boys' Sports Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758240004/photo-1679875806089-1d1d9c7c2c18_ow4ful.avif\" },\n      { slug: \"girls-sports-products\", label: \"Girls' Sports Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758240011/photo-1652500790208-9e01eaa76184_hcoykb.avif\" },\n    ],\n  },\n  {\n    slug: \"kids-fashion\",\n    label: \"Kids' Fashion\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299622/photo-1622290291468-a28f7a7dc6a8_sre7s1.avif\",\n    children: [\n      { slug: \"girls-sets\", label: \"Girls' Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758298943/photo-1745636624886-56ee9f3e2d9b_xpdzwr.avif\" },\n      { slug: \"boys-sets\", label: \"Boys' Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758298991/photo-1692385818674-7836a40c5731_fpnqda.avif\" },\n      { slug: \"kids-underwear-socks\", label: \"Kids' Underwear & Socks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299039/istockphoto-1355032606-612x612_okyidh.webp\" },\n      { slug: \"girls-outerwear\", label: \"Girls' Outerwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299194/istockphoto-1179789063-612x612_ygiwoe.webp\" },\n      { slug: \"baby-sets\", label: \"Baby Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299202/photo-1622290319146-7b63df48a635_xjcbdc.avif\" },\n      { slug: \"boys-outerwear\", label: \"Boys' Outerwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299250/istockphoto-1066694406-612x612_ewxwbq.webp\" },\n      { slug: \"girls-pants\", label: \"Girls' Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299284/istockphoto-1633653860-612x612_qvqcn7.webp\" },\n      { slug: \"girls-dresses\", label: \"Girls' Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299298/photo-1748499475920-6bb8ad2db838_cvrzve.avif\" },\n      { slug: \"baby-clothes\", label: \"Baby Clothes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299381/photo-1664918688104-4eb8956f97a2_u9mm9s.avif\" },\n      { slug: \"boys-pants\", label: \"Boys' Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299412/photo-1683115764911-425c8043f177_wodydq.avif\" },\n      { slug: \"girls-tshirts\", label: \"Girls' T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299446/istockphoto-621589954-612x612_qlbswh.webp\" },\n      { slug: \"boys-tshirts\", label: \"Boys' T-Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299473/istockphoto-1766774026-612x612_q5gmma.webp\" },\n      { slug: \"kids-watches\", label: \"Kids' Watches\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299513/photo-1566879873726-77fda17417c9_swxb2y.avif\" },\n      { slug: \"baby-tops\", label: \"Baby Tops\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299524/photo-1619490743936-35df0e7f1464_alwagr.avif\" },\n      { slug: \"kids-underwear-pajamas\", label: \"Kids' Underwear & Pajamas\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299531/photo-1594299590683-6d6ab3e14c53_slbloh.avif\" },\n      { slug: \"kids-jewelry\", label: \"Kids' Jewelry\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299574/photo-1679019937997-2272d4a840ee_jhe7sk.avif\" },\n      { slug: \"kids-clothing-accessories\", label: \"Kids' Clothing & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299622/photo-1622290291468-a28f7a7dc6a8_sre7s1.avif\" },\n      { slug: \"baby-dresses\", label: \"Baby Dresses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299651/premium_photo-1695635228843-35ddbc5026a6_fitb5s.avif\" },\n      { slug: \"kids-bags\", label: \"Kids' Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299800/photo-1744692173574-17b8247489b4_xfxwtt.avif\" },\n      { slug: \"kids-hair-accessories\", label: \"Kids' Hair Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299807/photo-1727193066825-8e681a89f8ae_bg7tz3.avif\" },\n      { slug: \"baby-pants\", label: \"Baby Pants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299817/photo-1649730241574-062f40aa83e8_lzhrfo.avif\" },\n      { slug: \"kids-hats-headwear\", label: \"Kids' Hats & Headwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299857/photo-1652980964679-7bd8542c2617_ndjx3m.avif\" },\n      { slug: \"baby-supplies\", label: \"Baby Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299872/photo-1586867764343-c1e7ca23b3da_mg3yg4.avif\" },\n      { slug: \"kids-gloves-scarves\", label: \"Kids' Gloves & Scarves\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299916/premium_photo-1683147827981-ca6dae1d6cb6_wki3qt.avif\" },\n      { slug: \"boys-shirts\", label: \"Boys' Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299949/istockphoto-884387672-612x612_usdxuc.webp\" },\n      { slug: \"girls-shirts\", label: \"Girls' Shirts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299958/photo-1645095542177-125b3e224eef_jrdjiq.avif\" },\n      { slug: \"kids-ties-belts-accessories\", label: \"Kids' Ties, Belts & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299969/photo-1739047596014-d921ce553f1c_z1psud.avif\" },\n      { slug: \"kids-sunglasses\", label: \"Kids' Sunglasses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758299997/premium_photo-1692809752341-ae91be430246_kpyhnu.avif\" },\n      { slug: \"kids-buttons-pins\", label: \"Kids' Buttons & Pins\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758300020/photo-1689509973594-8f966f5df6b6_aahhsv.avif\" },\n      { slug: \"girls-swimwear\", label: \"Girls' Swimwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758300042/premium_photo-1708991819129-fbb7cd65048b_em0g90.avif\" },\n      { slug: \"kids-keychains\", label: \"Kids' Keychains\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758300060/photo-1583242042981-084b336918d8_vvlkq2.avif\" },\n      { slug: \"boys-swimwear\", label: \"Boys' Swimwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758300080/photo-1674649206176-60f16cf87627_yztclh.avif\" },\n    ],\n  },\n  {\n    slug: \"underwear-sleepwear\",\n    label: \"Women's Underwear & Sleepwear\",\n    image: \"https://images.unsplash.com/photo-1585144723202-13838a1a4884?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"women-underwear\", label: \"Women's Underwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758145769/photo-1584061634739-88035e420618_xzmgbk.avif\" },\n      { slug: \"women-sleepwear\", label: \"Women's Sleepwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758145801/photo-1693988505497-9d4f6955e6a0_b71gmo.avif\" },\n      { slug: \"women-bras\", label: \"Women's Bras\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758145850/photo-1599839770015-53df36f312a8_tezlza.avif\" },\n      { slug: \"women-stockings-tights\", label: \"Women's Stockings & Tights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758145924/photo-1631180543602-727e1197619d_k0wtia.avif\" },\n      { slug: \"women-shapewear\", label: \"Women's Shapewear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146173/download_zvcp15.jpg\" },\n      { slug: \"women-loungewear\", label: \"Women's Loungewear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146182/premium_photo-1678344777040-d86ca0e7c658_il5pje.avif\" },\n      { slug: \"women-sexy-lingerie\", label: \"Women's Sexy Lingerie\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146274/photo-1643067352852-ba76170c0684_aia1zu.avif\" },\n      { slug: \"women-lingerie-sets\", label: \"Women's Lingerie Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146282/premium_photo-1675186049535-fd762eea0325_heniqu.avif\" },\n      { slug: \"women-underwear-accessories\", label: \"Women's Underwear Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146322/photo-1594631763695-46808aaa5a6a_pit6v1.avif\" },\n      { slug: \"women-slimming-shorts\", label: \"Women's Slimming Shorts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758146311/photo-1747237602396-20cb5331ee7b_flcs8k.avif\" },\n    ],\n  },\n  {\n    slug: \"jewelry-accessories\",\n    label: \"Jewelry & Accessories\",\n    image: \"https://images.unsplash.com/photo-1611652022419-a941954b6868?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      // Women\n      { slug: \"women-jewelry\", label: \"Women's Jewelry\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191115/photo-1740416649851-e16cff7d4f9a_isidnp.avif\" },\n      { slug: \"women-watches\", label: \"Women's Watches\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191191/photo-1658973070926-4b1511f7ec83_bbxiv2.avif\" },\n      { slug: \"women-hair-accessories\", label: \"Women's Hair Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191230/premium_photo-1661645449694-5bf9766205e1_dqlwib.avif\" },\n      { slug: \"women-hats-headwear\", label: \"Women's Hats & Headwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191277/photo-1620686847763-2e234d23e825_bb4znh.avif\" },\n      { slug: \"women-sunglasses\", label: \"Women's Sunglasses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191323/photo-1647825281647-2078e3fb72d1_rjn3ej.avif\" },\n      { slug: \"women-scarves-wraps\", label: \"Women's Scarves & Wraps\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191387/premium_photo-1695604461350-70d97106483a_qo7jax.avif\" },\n      { slug: \"women-belts\", label: \"Women's Belts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191423/photo-1601281866896-1576541e77a1_demxhy.avif\" },\n      { slug: \"women-keychains-charms\", label: \"Women's Keychains & Charms\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191464/photo-1687428140117-0d196849b2ec_tbj2fc.avif\" },\n      { slug: \"women-fashion-accessories\", label: \"Women's Fashion Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191509/photo-1674555201959-58ae7b2d7731_g5pi6d.avif\" },\n      { slug: \"women-eyewear-accessories\", label: \"Women's Eyewear Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191972/photo-1567448389790-84e763ed66c9_dpwmax.avif\" },\n      { slug: \"women-decorative-collars\", label: \"Women's Decorative Collars\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192070/premium_photo-1740020242524-318435e4be6f_o9syx5.avif\" },\n      { slug: \"women-buttons-clasps\", label: \"Women's Buttons & Clasps\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192143/photo-1633655442017-3b2a701ec705_gbauw8.avif\" },\n      { slug: \"women-wedding-accessories\", label: \"Women's Wedding Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192171/premium_photo-1747221079778-1d1240f33f1a_cnthte.avif\" },\n      { slug: \"wigs-fashion\", label: \"Fashion Wigs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192207/premium_photo-1682125610568-5b5b30ecc937_xtk016.avif\" },\n      { slug: \"women-earmuffs\", label: \"Women's Earmuffs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192468/photo-1702918652765-e2d45fa55edf_bm3jqu.avif\" },\n\n      // Men\n      { slug: \"men-watches\", label: \"Men's Watches\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191147/photo-1509941943102-10c232535736_kgkoig.avif\" },\n      { slug: \"men-jewelry\", label: \"Men's Jewelry\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191176/photo-1560186453-f83aa3c1cde4_hgr5ej.avif\" },\n      { slug: \"men-hats-headwear\", label: \"Men's Hats & Headwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758202998/photo-1611583041077-ea1668688c47_qg4ogh.avif\" },\n      { slug: \"men-sunglasses\", label: \"Men's Sunglasses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191350/photo-1611578623900-1372f19a6186_f5yqx1.avif\" },\n      { slug: \"men-belts\", label: \"Men's Belts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191409/photo-1667284152823-0b07a791fb79_jdpwyl.avif\" },\n      { slug: \"men-keychains-charms\", label: \"Men's Keychains & Charms\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191537/photo-1579565426003-f83d6036c8f9_mnaalb.avif\" },\n      { slug: \"watch-accessories\", label: \"Watch Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191572/photo-1689372828191-dc2a3ae42c76_esmxmc.avif\" },\n      { slug: \"men-ties-neckwear\", label: \"Men's Ties & Neckwear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191611/premium_photo-1668376937462-c44716f10de3_pukrna.avif\" },\n      { slug: \"men-gloves-mittens\", label: \"Men's Gloves & Mittens\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192114/photo-1580133588950-de89bb18f35d_kbaiyb.avif\" },\n      { slug: \"men-scarves\", label: \"Men's Scarves\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192028/photo-1634666498696-c68a92adc199_e8d7jz.avif\" },\n      { slug: \"men-suspenders\", label: \"Men's Suspenders\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192240/premium_photo-1661310087748-d3f629596737_ldgpul.avif\" },\n      { slug: \"men-accessories\", label: \"Men's Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192265/premium_photo-1661385963299-c08f8590a652_eaelyk.avif\" },\n      { slug: \"men-earmuffs\", label: \"Men's Earmuffs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192534/premium_photo-1679785591233-d00d211b129c_eyvg3i.avif\" },\n\n      // Neutral / General accessories\n      { slug: \"decorative-patches\", label: \"Decorative Patches\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191689/photo-1685059352125-077b37ca6743_qlnseh.avif\" },\n      { slug: \"jewelry-making-supplies\", label: \"Jewelry Making Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191945/premium_photo-1663045663569-f4d1460eb9d2_o37ogs.avif\" },\n      { slug: \"jewelry-boxes-organizers\", label: \"Jewelry Boxes & Organizers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191952/photo-1680200256120-8ac04eb6f01d_tfmpeb.avif\" },\n      { slug: \"cigarette-cases\", label: \"Cigarette Cases\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191983/photo-1675010787842-17ff5beb6c9b_wfwnbk.avif\" },\n      { slug: \"loose-gemstones\", label: \"Loose Gemstones\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758191995/photo-1602751584549-44d0f48236a5_lgptc7.avif\" },\n      { slug: \"handbag-holders\", label: \"Handbag Holders\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192309/photo-1697267322976-5c3d05d07d96_baabge.avif\" },\n      { slug: \"face-cover\", label: \"Face Covers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192460/premium_photo-1699534956883-a8e5c4746884_lq60wv.avif\" },\n      { slug: \"jewelry-cleaning-care\", label: \"Jewelry Cleaning & Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758192526/premium_photo-1734370874249-b9187b73af90_bu9355.avif\" },\n    ],\n  },\n  {\n    slug: \"bags-luggage\",\n    label: \"Bags & Luggage\",\n    image: \"https://images.unsplash.com/photo-1553062407-98eeb6e0e946?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"women-shoulder-bags\", label: \"Women's Shoulder Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758210996/photo-1711113456524-d51ede789617_lbdrnf.avif\" },\n      { slug: \"women-crossbody-bags\", label: \"Women's Crossbody Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211061/photo-1608060434411-0c3fa9049e7b_pm0la2.avif\" },\n      { slug: \"women-tote-bags\", label: \"Women's Tote Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211038/photo-1706008003391-fdf79dcdf5a0_jrwxsq.avif\" },\n      { slug: \"travel-luggage-gear\", label: \"Travel Luggage & Gear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211089/photo-1732605548318-b6d80dfa72a3_qvhx4f.avif\" },\n      { slug: \"unisex-casual-backpacks\", label: \"Unisex Casual Backpacks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211129/photo-1675524385151-7750363fe4bc_z9tcwj.avif\" },\n      { slug: \"women-backpacks\", label: \"Women's Backpacks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211155/photo-1685338336450-ccf9c8f21303_x6gb8l.avif\" },\n      { slug: \"women-handbags\", label: \"Women's Handbags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211178/photo-1751522937993-46b83342398b_lpxat0.avif\" },\n      { slug: \"women-wallets-card-holders\", label: \"Women's Wallets & Card Holders\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211209/photo-1743244948210-8d70a7f2b556_c4b1kf.avif\" },\n      { slug: \"men-wallets-card-holders\", label: \"Men's Wallets & Card Holders\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211234/photo-1585401586477-2a671e1cae4e_rovlkm.avif\" },\n      { slug: \"umbrellas\", label: \"Umbrellas\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211268/photo-1534185146-2908affa9b0c_tswr6j.avif\" },\n      { slug: \"men-shoulder-bags\", label: \"Men's Shoulder Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211319/photo-1730637207122-c634d22d1f9c_iiexkt.avif\" },\n      { slug: \"laptop-bags\", label: \"Laptop Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211338/photo-1689757875266-66446af145dc_awrj6b.avif\" },\n      { slug: \"women-mini-bags\", label: \"Women's Mini Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211384/photo-1710008653296-658e4455eafb_utzwmf.avif\" },\n      { slug: \"travel-luggage\", label: \"Travel Luggage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211396/photo-1522199710521-72d69614c702_ltavk7.avif\" },\n      { slug: \"storage-bags\", label: \"Storage Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211468/photo-1672625912400-35f1f7bca79b_jpdxnl.avif\" },\n      { slug: \"waist-chest-bags\", label: \"Waist & Chest Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211503/photo-1730637207122-c634d22d1f9c_gett4u.avif\" },\n      { slug: \"student-backpacks\", label: \"Student Backpacks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211517/premium_photo-1667511201650-7381b8e5e70b_ax64nl.avif\" },\n      { slug: \"women-bag-sets\", label: \"Women's Bag Sets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211538/premium_photo-1664391905941-48b68048c889_eyef7a.avif\" },\n      { slug: \"hiking-backpacks\", label: \"Hiking Backpacks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758212166/premium_photo-1723802515507-4e76037fa414_tr0ffk.avif\" },\n      { slug: \"gym-bags\", label: \"Gym Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211603/photo-1708622833152-924c6e364138_ef63te.avif\" },\n      { slug: \"luggage-travel-accessories\", label: \"Luggage & Travel Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211657/photo-1732605548227-5679cb62193b_ga1oft.avif\" },\n      { slug: \"makeup-bag\", label: \"Makeup Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211710/photo-1524860155154-c904628c418c_jtncc4.avif\" },\n      { slug: \"passport-holders-wallets\", label: \"Passport Holders & Wallets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211747/photo-1639597785756-41e2038db0b5_vbleig.avif\" },\n      { slug: \"women-waist-chest-bags\", label: \"Women's Waist & Chest Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758212364/photo-1711113456820-639918258722_z1b10n.avif\" },\n      { slug: \"handbags\", label: \"Handbags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211849/photo-1598099947145-e85739e7ca28_fdpacz.avif\" },\n      { slug: \"messenger-bags\", label: \"Messenger Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211881/photo-1668934803324-62e7126b9b93_db97uu.avif\" },\n      { slug: \"hobo-bags\", label: \"Hobo Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758211949/photo-1587599305803-01f1f176fbb4_ar6lrd.avif\" },\n    ],\n  },\n  \n  {\n    slug: \"health-beauty\",\n    label: \"Health & Beauty\",\n    image: \"https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"makeup\", label: \"Makeup\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196288/photo-1676918325698-f7311098aa98_vyfjuv.avif\" },\n      { slug: \"wigs-extensions\", label: \"Wigs & Hair Extensions\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196319/photo-1752860365302-1dffcb178fd9_zqgy0y.avif\" },\n      { slug: \"face-care\", label: \"Face Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196340/premium_photo-1715604350464-5d8c2cd4d61a_pbkve2.avif\" },\n      { slug: \"hair-styling-tools\", label: \"Hair Styling Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196367/photo-1713180758533-e219fe2e98e4_ksx3de.avif\" },\n      { slug: \"shaving-hair-removal\", label: \"Shaving & Hair Removal\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196392/photo-1754459153037-9f5aee2194e8_nfif1b.avif\" },\n      { slug: \"beauty-tools\", label: \"Beauty Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196478/photo-1631214500020-e56e3d7eabb4_matov2.avif\" },\n      { slug: \"hair-care\", label: \"Hair Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196487/photo-1749137315696-3590c111e495_hpuysd.avif\" },\n      { slug: \"foot-hand-nail-care\", label: \"Foot, Hand & Nail Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196495/premium_photo-1661499077211-e8e6dd1777bd_xyjq0l.avif\" },\n      { slug: \"nail-polish\", label: \"Nail Polish\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196502/photo-1636019411401-82485711b6ba_hzpu6m.avif\" },\n      { slug: \"false-eyelashes\", label: \"False Eyelashes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196525/premium_photo-1755505991586-21f802986bc8_dze2sz.avif\" },\n      { slug: \"fragrance\", label: \"Fragrance\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196545/photo-1622618991746-fe6004db3a47_umcxyh.avif\" },\n      { slug: \"personal-care\", label: \"Personal Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196548/photo-1649073005971-37babef31983_axmmrz.avif\" },\n      { slug: \"oral-care\", label: \"Oral Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758198346/premium_photo-1664544673787-97b042cb07ab_pfedtz.avif\" },\n      { slug: \"hair-cutting-tools\", label: \"Hair Cutting Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196599/premium_photo-1755597392675-a60a3da25522_ov20ny.avif\" },\n      { slug: \"nail-devices\", label: \"Nail Devices\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196629/premium_photo-1661497590552-93536b2b84b9_foojtn.avif\" },\n      { slug: \"skincare\", label: \"Skincare\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196636/photo-1741896136069-f3588d8993b5_phrubu.avif\" },\n      { slug: \"press-on-nails\", label: \"Press-On Nails\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196643/premium_photo-1661337159345-bc2e2e014c49_knq5j4.avif\" },\n      { slug: \"nail-tools\", label: \"Nail Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196739/premium_photo-1670963024642-59d3a500f880_ki0t49.avif\" },\n      { slug: \"makeup-bags-storage\", label: \"Makeup Bags & Storage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196755/photo-1734599420537-94f0cd0c0193_ly940v.avif\" },\n      { slug: \"refillable-containers\", label: \"Refillable Containers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196792/photo-1624377166852-776794be17f5_za6ypf.avif\" },\n      { slug: \"nail-art\", label: \"Nail Art\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196891/photo-1753285310651-6974a839c992_alqnlj.avif\" },\n      { slug: \"massage-relaxation-devices\", label: \"Massage & Relaxation Devices\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196900/premium_photo-1661437988429-d24854fd3b6f_nqpstq.avif\" },\n      { slug: \"bath-accessories\", label: \"Bath Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196947/premium_photo-1750860246230-cba8749dd61e_ojlznn.avif\" },\n      { slug: \"makeup-mirrors\", label: \"Makeup Mirrors\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758196988/photo-1725792826466-a7aa717da6e6_evtpyv.avif\" },\n      { slug: \"hair-accessories\", label: \"Hair Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197047/premium_photo-1661645513085-75134d7eb8a7_m6wagv.avif\" },\n      { slug: \"temporary-tattoo\", label: \"Temporary Tattoos\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197055/photo-1623187424438-baaff1810b66_naautc.avif\" },\n      { slug: \"body-paint-makeup\", label: \"Body Paint & Makeup\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197136/photo-1662592364948-43f26931cdae_bijazd.avif\" },\n      { slug: \"nail-powder\", label: \"Nail Powder\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758197142/photo-1714387648824-2493ef18b7bc_zcbmhs.avif\" },\n    ],\n  },\n  {\n    slug: \"health-household\",\n    label: \"Health & Household\",\n    image: \"https://images.unsplash.com/photo-1581579188871-45ea61f2a0f3?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"household-cleaning-supplies\", label: \"Household & Cleaning Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219373/premium_photo-1678742388597-d9d76a759d14_zbmrdo.avif\" },\n      { slug: \"sexual-health-products\", label: \"Sexual Health Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219397/photo-1609606466211-78b4a59f2bc2_utup3i.avif\" },\n      { slug: \"healthcare-products\", label: \"Healthcare Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219504/photo-1730472528700-4965c3aff6d1_dr7sjv.avif\" },\n      { slug: \"oral-care-products\", label: \"Oral Care Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219529/photo-1693692273603-3b9e13789298_vcg7sg.avif\" },\n      { slug: \"home-medical-equipment\", label: \"Home Medical Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219560/photo-1576091160550-2173dba999ef_drqaxj.avif\" },\n      { slug: \"skincare-products\", label: \"Skincare Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219580/photo-1600428853876-fb5a850b444f_dv3kc0.avif\" },\n      { slug: \"office-gift-wrapping-supplies\", label: \"Office & Gift Wrapping Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219596/premium_photo-1685287730155-67d1c3740c7b_bl80rr.avif\" },\n      { slug: \"foot-health\", label: \"Foot Health\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219678/photo-1638859471856-c6793be39109_cienv1.avif\" },\n      { slug: \"wellness-relaxation\", label: \"Wellness & Relaxation\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219703/premium_photo-1663051004613-40a643b4d9a8_dhsi6v.avif\" },\n      { slug: \"lighters-utility-tools\", label: \"Lighters & Utility Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219718/photo-1547747005-42e1436197e4_kucbky.avif\" },\n      { slug: \"massage-tools-equipment\", label: \"Massage Tools & Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219740/premium_photo-1661583880955-7b21fe8f7f00_g13fhb.avif\" },\n      { slug: \"personal-care-products\", label: \"Personal Care Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219765/photo-1601612628452-9e99ced43524_e9hug2.avif\" },\n      { slug: \"vision-care\", label: \"Vision Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219805/premium_photo-1715889658723-5a6466cab011_bf9xof.avif\" },\n      { slug: \"bath-accessories\", label: \"Bath Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219808/premium_photo-1750860247667-32aef8a96f05_jwxlwy.avif\" },\n      { slug: \"pest-control\", label: \"Pest Control\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219857/premium_photo-1661306479139-2ba81f1a5cd6_kmfz3x.avif\" },\n    ],\n  },\n  {\n    slug: \"home-kitchen\",\n    label: \"Home & Kitchen\",\n    image: \"https://images.unsplash.com/photo-1556911220-bff31c812dba?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"home-decor-products\", label: \"Home Decor Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137191/photo-1754288191539-13205bf82563_cp80ly.avif\" },\n      { slug: \"kitchen-storage-organization\", label: \"Kitchen Storage & Organization\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137334/premium_photo-1727183904698-7a7963066170_y0xxy2.avif\" },\n      { slug: \"kitchen-tools-supplies\", label: \"Kitchen Tools & Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137368/premium_photo-1716113144044-5969877f8f90_ofplpk.avif\" },\n      { slug: \"home-storage-organization\", label: \"Home Storage & Organization\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137406/photo-1757087997434-9e07ce7cf9f2_agswaa.avif\" },\n      { slug: \"bathroom\", label: \"Bathroom\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137604/photo-1742569636193-2ce10bce0eab_rjp58y.avif\" },\n      { slug: \"clothing-laundry-storage\", label: \"Clothing & Laundry Storage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137633/photo-1757087824089-bdb33ecc3439_jgvjbp.avif\" },\n      { slug: \"sofa-decor\", label: \"Sofa Decor\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137670/photo-1545454760-a8e55231441c_tmwxbj.avif\" },\n      { slug: \"party-supplies\", label: \"Party Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137796/premium_photo-1697910940636-a8c30da8dd5c_itamst.avif\" },\n      { slug: \"seasonal-decor\", label: \"Seasonal Decor\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758137930/premium_photo-1734095822913-c027bf7af041_tsqa3g.avif\" },\n      { slug: \"rugs-carpets\", label: \"Rugs & Carpets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758139085/photo-1597665863042-47e00964d899_iq4yyn.avif\" },\n      { slug: \"table-serveware\", label: \"Table & Serveware\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138016/premium_photo-1714702845510-e65f6ae711c2_uihhqj.avif\" },\n      { slug: \"curtains-accessories\", label: \"Curtains & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138036/photo-1731772835226-956c9641cdef_akrett.avif\" },\n      { slug: \"towels-shower-curtains\", label: \"Towels & Shower Curtains\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138084/premium_photo-1675799687068-3ab62c25d778_a10ema.avif\" },\n      { slug: \"cleaning-equipment\", label: \"Cleaning Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138109/premium_photo-1678718605794-e21935e9fda1_ceqvz5.avif\" },\n      { slug: \"blankets-bedspreads\", label: \"Blankets & Bedspreads\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138180/premium_photo-1726866151455-472848123a5a_sbvohs.avif\" },\n      { slug: \"kitchen-table-textiles\", label: \"Kitchen & Table Textiles\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138187/premium_photo-1675230746823-b00987d476eb_fpdq2g.avif\" },\n      { slug: \"cookware\", label: \"Cookware\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758139718/photo-1584990347163-2b86b71390d6_kvyp1x.avif\" },\n      { slug: \"bakeware\", label: \"Bakeware\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138240/premium_photo-1714785786689-ed6b64e28917_v3u7oi.avif\" },\n      { slug: \"small-appliances-accessories\", label: \"Small Appliances & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138288/photo-1636803793861-f8f6aa7a27d0_nqfqzw.avif\" },\n      { slug: \"wall-art\", label: \"Wall Art\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138297/photo-1714859100411-74b0b9a6bf15_mq9yac.avif\" },\n      { slug: \"lighting-accessories\", label: \"Lighting & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138341/photo-1639160570272-21abb8985693_ugrf9v.avif\" },\n      { slug: \"glassware-drinkware\", label: \"Glassware & Drinkware\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138362/photo-1605760291099-f75d92e645fd_e8vlo6.avif\" },\n      { slug: \"vacuums-floor-care\", label: \"Vacuums & Floor Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138394/premium_photo-1677234147781-6c7d0f5a14bc_iqfzy0.avif\" },\n      { slug: \"travel-drinkware\", label: \"Travel Drinkware\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138435/photo-1681876838779-8453972c63f6_bydjq3.avif\" },\n      { slug: \"coffee-tea-espresso\", label: \"Coffee, Tea & Espresso\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138469/photo-1739987789532-304f100eb4f1_mmmgot.avif\" },\n      { slug: \"serving-equipment-supplies\", label: \"Serving Equipment & Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138506/photo-1756996270112-e0b09b3a2d22_htmdi7.avif\" },\n      { slug: \"irons-steamers\", label: \"Irons & Steamers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138569/premium_photo-1674273912595-18a20c0cc9bf_l66xsl.avif\" },\n      { slug: \"fans-ac-heaters\", label: \"Fans, AC & Heaters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138643/photo-1601084195907-44baaa49dabd_y6z8xi.avif\" },\n      { slug: \"air-quality\", label: \"Air Quality\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138680/photo-1552847357-969b1fe01e97_xdqqhd.avif\" },\n      { slug: \"kids-home-storage\", label: \"Kids' Home Storage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758138765/premium_photo-1685276206600-125206420879_jkyoj2.avif\" },\n    ],\n  },\n  {\n    slug: \"furniture\",\n    label: \"Furniture\",\n    image: \"https://images.unsplash.com/photo-1505692794403-34f34a3eb48e?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"living-room-furniture\", label: \"Living Room Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216107/photo-1750639258774-9a714379a093_q3lc3t.avif\" },\n      { slug: \"patio-furniture\", label: \"Patio Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216116/photo-1754399005619-fc8e19e32443_b5fhcn.avif\" },\n      { slug: \"bedroom-furniture\", label: \"Bedroom Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216132/photo-1737467026661-31b5a87098fe_ihmtrg.avif\" },\n      { slug: \"kitchen-dining-furniture\", label: \"Kitchen & Dining Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216140/photo-1752254873481-6b6095601f38_optsa4.avif\" },\n      { slug: \"home-office-furniture\", label: \"Home Office Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216362/photo-1632119289059-793dd347950f_bg2puf.avif\" },\n      { slug: \"bathroom-furniture\", label: \"Bathroom Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216155/premium_photo-1674758182838-226584707569_pfowqf.avif\" },\n      { slug: \"kids-baby-furniture\", label: \"Kids & Baby Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216163/photo-1705042086793-e89c28b2e2f6_j2dzmj.avif\" },\n    ],\n  },\n  \n  {\n    slug: \"appliances\",\n    label: \"Appliances\",\n    image: \"https://images.unsplash.com/photo-1626806819282-2c1dc01a5e0c?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"hair-care\", label: \"Hair Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229407/photo-1620331309205-b5a4669ac526_y1i4f6.avif\" },\n      { slug: \"kitchen-appliances\", label: \"Kitchen Appliances\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229418/photo-1693875161720-b0c2401c1874_nd9sk5.avif\" },\n      { slug: \"vacuums-floor-care\", label: \"Vacuums & Floor Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229427/premium_photo-1678118776730-69c211336de1_nxknnu.avif\" },\n      { slug: \"juicers-food-processors\", label: \"Juicers & Food Processors\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229449/photo-1685131701280-d397c3de43db_otkggy.avif\" },\n      { slug: \"fans-air-conditioners\", label: \"Fans & Air Conditioners\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229499/premium_photo-1700350181228-c1ffe99dee5b_b9iwnc.avif\" },\n      { slug: \"laundry-supplies\", label: \"Laundry Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229522/photo-1626806787461-102c1bfaaea1_hhyhvt.avif\" },\n      { slug: \"electric-massagers\", label: \"Electric Massagers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229533/premium_photo-1732836190115-e998d9b012e1_bih3ly.avif\" },\n      { slug: \"oral-care-electronics\", label: \"Oral Care Electronics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229544/photo-1641130331708-dd0cc94ae8e5_ed9mz8.avif\" },\n      { slug: \"coffee-tea-makers\", label: \"Coffee & Tea Makers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229553/photo-1707241358597-bafcc8a8e73d_op8vyp.avif\" },\n      { slug: \"personal-care-electronics\", label: \"Personal Care Electronics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229581/photo-1647900893846-e6ab4048e824_rz62ki.avif\" },\n      { slug: \"air-purifiers\", label: \"Air Purifiers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229590/premium_photo-1690291494818-068ed0f63c42_chdtpz.avif\" },\n      { slug: \"refrigerators-freezers-accessories\", label: \"Refrigerators, Freezers & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229670/photo-1754063258077-9bfd1c2eda9d_zfk3ry.avif\" },\n      { slug: \"health-wellness-monitors\", label: \"Health & Wellness Monitors\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229698/photo-1615486511484-92e172cc4fe0_rpx3s6.avif\" },\n      { slug: \"home-appliances-general\", label: \"Home Appliances\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229720/photo-1713514022505-fb1f65d476a7_a9b48m.avif\" },\n      { slug: \"pest-repellent-electronics\", label: \"Pest Repellent Electronics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229803/photo-1628352081506-83c43123ed6d_h16rhd.avif\" },\n      { slug: \"heaters\", label: \"Heaters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229860/photo-1626880494339-5a5d5ec8f17a_met5id.avif\" },\n      { slug: \"ice-maker\", label: \"Ice Makers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229881/photo-1727947478281-1576560f10aa_avqbbf.avif\" },\n    ],\n  },\n  {\n    slug: \"electronics\",\n    label: \"Electronics\",\n    image: \"https://images.unsplash.com/photo-1525547719571-a2d4ac8945e2?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"tablets-laptops-accessories\", label: \"Tablets, Laptops & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236342/photo-1533193045359-7855d8ed65f8_bfb5mw.avif\" },\n      { slug: \"headphones-headsets-accessories\", label: \"Headphones, Headsets & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236349/photo-1618366712010-f4ae9c647dcb_au33mm.avif\" },\n      { slug: \"photo-imaging-optics\", label: \"Photo, Imaging & Optics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236367/photo-1757845366142-e5929f71c7bb_eenqmr.avif\" },\n      { slug: \"speakers-radios\", label: \"Speakers & Radios\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236375/photo-1645536729183-33ad0e767aef_xqzxfz.avif\" },\n      { slug: \"computers-accessories\", label: \"Computers & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236413/premium_photo-1683141486694-4aa9d60803b6_xry5br.avif\" },\n      { slug: \"data-storage\", label: \"Data Storage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236474/premium_photo-1673696508153-01cf0dbcf60a_xn5lxz.avif\" },\n      { slug: \"keyboards-mice-accessories\", label: \"Keyboards, Mice & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236605/photo-1668096202611-d236ccbd6741_sxgygv.avif\" },\n      { slug: \"video-games\", label: \"Video Games\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236610/premium_photo-1752882065826-a32929f60197_kuvvyt.avif\" },\n      { slug: \"batteries-accessories\", label: \"Batteries & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237529/photo-1564286026458-876d16aed365_zuce20.avif\" },\n      { slug: \"hubs-adapters\", label: \"Hubs & Adapters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237476/premium_photo-1675024298717-02d612d9cc82_shgmuv.avif\" },\n      { slug: \"electronics-lighting\", label: \"Lighting\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237388/premium_photo-1679430106455-e5ab13a9007b_uyquzt.avif\" },\n      { slug: \"computer-components\", label: \"Computer Components\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237423/photo-1625633979481-bcbaa10165f0_xiwwzy.avif\" },\n      { slug: \"power-strips\", label: \"Power Strips\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236636/photo-1647884440187-574c6c77c7e7_b5wmwc.avif\" },\n      { slug: \"gps-trackers-accessories\", label: \"GPS Trackers & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236651/photo-1691318043266-4c673ed13b8f_isqfqv.avif\" },\n      { slug: \"laptop-tablet-stickers\", label: \"Laptop & Tablet Stickers\" },\n      { slug: \"usb-tools\", label: \"USB Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758236573/photo-1720048170512-d5d4fb0fff88_tnb36o.avif\" },\n    ],\n  },\n  {\n    slug: \"arts-crafts-sewing\",\n    label: \"Arts, Crafts & Sewing\",\n    image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237674/photo-1749573642956-e894c165f55b_mtyjeu.avif\",\n    children: [\n      { slug: \"crafts\", label: \"Crafts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237674/photo-1749573642956-e894c165f55b_mtyjeu.avif\" },\n      { slug: \"sewing\", label: \"Sewing\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237683/premium_photo-1664195857591-968c2a9f2c03_vxjage.avif\" },\n      { slug: \"coloring-drawing-art-supplies\", label: \"Coloring, Drawing & Art Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237696/photo-1753200468785-eecdd7f6014c_cspn6j.avif\" },\n      { slug: \"decor-jewelry-making\", label: \"Decor & Jewelry Making\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237703/premium_photo-1723575629992-b22e8782e7c9_iuityq.avif\" },\n      { slug: \"jewelry-forming-supplies\", label: \"Jewelry Forming Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237717/photo-1526388962-91cb484efdc7_egdq3t.avif\" },\n      { slug: \"cutting-engraving\", label: \"Cutting & Engraving\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758237898/premium_photo-1663045914445-6372b893e230_w6omwf.avif\" },\n      { slug: \"yarn\", label: \"Yarn\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238015/photo-1700170726155-fe844921b8b3_jtspgz.avif\" },\n      { slug: \"model-building-hobbies\", label: \"Model Building & Hobbies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238022/premium_photo-1705717314175-948a60cf6966_mug7wx.avif\" },\n      { slug: \"fabric\", label: \"Fabric\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238332/istockphoto-2168005603-612x612_eikvct.webp\" },\n      { slug: \"knitting-crochet-tools\", label: \"Knitting & Crochet Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238050/photo-1745095034955-1019067b7ce4_vcef3o.avif\" },\n      { slug: \"bead-storage-packaging\", label: \"Bead Storage & Packaging\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238068/premium_photo-1747763107471-d25bae7853df_tzaqws.avif\" },\n      { slug: \"embroidery\", label: \"Embroidery\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238363/photo-1641320197434-6ae0ca235048_czegcw.avif\" },\n    ],\n  },\n  {\n    slug: \"musical-instruments\",\n    label: \"Musical Instruments\",\n    image: \"https://images.unsplash.com/photo-1511376777868-611b54f68947?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"studio-stage-recording\", label: \"Studio & Stage Recording Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216798/photo-1642552645652-d5f411cf59e0_cymzo9.avif\" },\n      { slug: \"microphones\", label: \"Microphones\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216810/premium_photo-1709007738214-13af8f6e1718_lpka4n.avif\" },\n      { slug: \"string-instruments\", label: \"String Instruments\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216820/photo-1627905818392-a421fab203e6_oirdmh.avif\" },\n      { slug: \"drums-percussion\", label: \"Drums & Percussion\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216830/photo-1681855018254-a54babc49ea3_cgjj5k.avif\" },\n      { slug: \"dj-equipment\", label: \"DJ Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216838/photo-1757612550685-d15d473f2e85_ekgb0r.avif\" },\n      { slug: \"keyboards-midi\", label: \"Keyboards & MIDI\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216847/photo-1527953594273-291a5d4f7d39_gy7sod.avif\" },\n      { slug: \"brass-woodwinds\", label: \"Brass & Woodwinds\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216865/photo-1511192336575-5a79af67a629_ssflzw.avif\" },\n      { slug: \"guitars\", label: \"Guitars\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216897/photo-1643386155957-e548dd1dfe14_xctmn0.avif\" },\n      { slug: \"music-instruments-accessories\", label: \"Musical Instruments Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758216908/photo-1672830597652-c4477cfac124_ibidgv.avif\" },\n    ],\n  },\n  {\n    slug: \"smart-home\",\n    label: \"Smart Home\",\n    image: \"https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"smartwatches-accessories\", label: \"Smartwatches & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217149/photo-1598516802414-50a01bee818d_jxgnqn.avif\" },\n      { slug: \"security-surveillance\", label: \"Security & Surveillance\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217159/premium_photo-1749631947909-f50a36ef4c4b_hnkk80.avif\" },\n      { slug: \"smart-lights\", label: \"Smart Lights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217461/premium_photo-1756142935130-a993672ddae8_rixaul.avif\" },\n      { slug: \"smart-devices\", label: \"Smart Devices\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217187/photo-1717323454555-f053c31ff4b4_rlxnj1.avif\" },\n      { slug: \"home-entertainment\", label: \"Home Entertainment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217208/photo-1721733259332-6cf31a73bb0d_j9eimy.avif\" },\n      { slug: \"wifi-networking\", label: \"WiFi & Networking\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217217/photo-1750711158632-5273ec9b9b86_raknja.avif\" },\n      { slug: \"smart-bells-locks\", label: \"Smart Doorbells & Locks\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217226/photo-1754550335297-01b57926077c_fnaa1c.avif\" },\n      { slug: \"plugs-outlets\", label: \"Plugs & Outlets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217240/premium_photo-1723489229927-de29ff7392f5_xywwqm.avif\" },\n    ],\n  },\n  {\n    slug: \"mobile-accessories\",\n    label: \"Cell Phones & Accessories\",\n    image: \"https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"phones\", label: \"Cell Phones\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217311/photo-1700451761309-656bd9439443_dnk87k.avif\" },\n      { slug: \"bags-sleeves-cases\", label: \"Bags, Sleeves & Cases\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758217332/photo-1570970506632-cd2834876c2c_xdcmyv.avif\" },\n      { slug: \"chargers\", label: \"Chargers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218059/photo-1557767382-97b28f5488e7_c8o4cr.avif\" },\n      { slug: \"mounts\", label: \"Mounts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218071/photo-1647434824011-6d613da91b1d_qaye2q.avif\" },\n      { slug: \"cables-adapters\", label: \"Cables & Adapters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218085/photo-1525972231415-e52a7a56c905_vcdslq.avif\" },\n      { slug: \"phone-accessories\", label: \"Phone Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218129/photo-1566793474285-2decf0fc182a_cdpegr.avif\" },\n      { slug: \"mobile-photography\", label: \"Mobile Photography\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218151/photo-1569609782629-8e323d62582e_vlwao9.avif\" },\n      { slug: \"wireless-chargers\", label: \"Wireless Chargers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218168/photo-1543472750-506bacbf5808_t6msgg.avif\" },\n    ],\n  },\n  {\n    slug: \"toys\",\n    label: \"Toys\",\n    image: \"https://images.unsplash.com/photo-1550171509-552147343552?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"building-toys\", label: \"Building Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758204382/premium_photo-1682124223120-b6271246994c_tuypfg.avif\" },\n      { slug: \"vehicles\", label: \"Vehicles\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758204445/premium_photo-1736291279761-e7b402ffc1ce_v9srae.avif\" },\n      { slug: \"prank-toys\", label: \"Prank Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758204527/photo-1636558706545-3f83b8ce99b8_dj6r3f.avif\" },\n      { slug: \"toys-accessories\", label: \"Toys & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206430/photo-1700975928909-da4a46227a47_uclgjo.avif\" },\n      { slug: \"learning-education\", label: \"Learning & Education\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206439/photo-1685358268305-c621b38e75d8_ovbfgf.avif\" },\n      { slug: \"fashion-novelty\", label: \"Fashion & Novelty\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206496/photo-1738261544450-dac9cc4e5631_rf8svu.avif\" },\n      { slug: \"drones-flying-toys\", label: \"Drones & Flying Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206525/photo-1594538883504-e7720dda6bd8_dgpvb4.avif\" },\n      { slug: \"stuffed-animals-plush\", label: \"Stuffed Animals & Plush Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206534/photo-1559454403-b8fb88521f11_tihijp.avif\" },\n      { slug: \"sports-outdoor-play\", label: \"Sports & Outdoor Play\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206579/photo-1680024436315-fb06267264b2_wunylw.avif\" },\n      { slug: \"dolls-accessories\", label: \"Dolls & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206596/photo-1747940177050-da5cc3aa611e_cgyz6p.avif\" },\n      { slug: \"crafts-stickers\", label: \"Crafts & Stickers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206645/premium_photo-1684189484739-53e15f8e1181_f7bai5.avif\" },\n      { slug: \"dress-up-pretend-play\", label: \"Dress Up & Pretend Play\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206662/premium_photo-1661964395584-af7de384e27f_ovtsye.avif\" },\n      { slug: \"baby-dolls\", label: \"Baby Dolls\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206671/photo-1675622988617-793a6dac8778_zz5n2j.avif\" },\n      { slug: \"puzzles\", label: \"Puzzles\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206682/photo-1704027689069-747471f0a40a_s3ip1j.avif\" },\n      { slug: \"drawing-coloring\", label: \"Drawing & Coloring\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206693/photo-1722962495638-9bb77508c118_kuthlw.avif\" },\n      { slug: \"party-supplies\", label: \"Party Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206702/premium_photo-1661310068657-f8e77bb5258d_a1c2gy.avif\" },\n      { slug: \"electronic-toys\", label: \"Electronic Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206727/photo-1635105748121-d2464c710d7c_ood6hg.avif\" },\n      { slug: \"toy-guns-accessories\", label: \"Toy Guns & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206738/photo-1594950981383-6eb659d18fbf_va8rfl.avif\" },\n      { slug: \"action-figures-playsets\", label: \"Action Figures & Playsets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206750/photo-1561994508-07f91d13a9ff_bqmyas.avif\" },\n      { slug: \"water-toys\", label: \"Water Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206784/photo-1636581884219-d6fd5ed8de15_mifuqf.avif\" },\n      { slug: \"kids-musical-instruments\", label: \"Kids' Musical Instruments\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206797/premium_photo-1681912326211-8da051b94458_xnhhnq.avif\" },\n      { slug: \"puppets-puppet-theaters\", label: \"Puppets & Puppet Theaters\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758206820/photo-1601171908937-4e1ed267b407_nh5ua1.avif\" },\n    ],\n  },\n  {\n    slug: \"office-school\",\n    label: \"Office & School Supplies\",\n    image: \"https://images.unsplash.com/photo-1456735180827-f004d2b2a04b?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"office-electronics\", label: \"Office Electronics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758227791/photo-1698663371785-677d13f21570_bwnllr.avif\" },\n      { slug: \"storage-organization\", label: \"Storage & Organization\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758227925/photo-1611758497398-5224931d155a_i1296e.avif\" },\n      { slug: \"writing-correction-supplies\", label: \"Writing & Correction Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228265/photo-1542435503-956c469947f6_xhygxx.avif\" },\n      { slug: \"papers-stickers-lists\", label: \"Papers, Stickers & Lists\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228286/photo-1588773182630-055e7f141ffd_hh3bph.avif\" },\n      { slug: \"office-school-supplies\", label: \"Office & School Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228293/photo-1754039984995-a91721ce1870_m2rj5e.avif\" },\n      { slug: \"office-furniture-accessories\", label: \"Office Furniture & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228315/photo-1741279356442-881e0935e230_edugee.avif\" },\n      { slug: \"office-lighting\", label: \"Office Lighting\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228323/photo-1533090161767-e6ffed986c88_d6cc1h.avif\" },\n      { slug: \"office-accessories\", label: \"Office Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228329/photo-1652498196118-4577d5f6abd5_ay2dhe.avif\" },\n      { slug: \"tapes-adhesives-fasteners\", label: \"Tapes, Adhesives & Fasteners\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758228340/photo-1518975835519-4de8028b1917_rpwl6r.avif\" },\n      { slug: \"desks-worktables\", label: \"Desks & Worktables\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229012/photo-1742198810079-49bb51d1c5af_ogphed.avif\" },\n      { slug: \"gift-wrapping-crafts\", label: \"Gift Wrapping & Crafts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229025/photo-1716540103530-cc33cdd20cde_xujzqb.avif\" },\n      { slug: \"office-stickers\", label: \"Office Stickers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229078/photo-1714859100552-3e432e8f3981_jpv5jj.avif\" },\n      { slug: \"chairs-sofas\", label: \"Chairs & Sofas\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229105/photo-1685712689090-d71127dab4ba_vyuztm.avif\" },\n      { slug: \"laptop-bags\", label: \"Laptop Bags\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229111/photo-1544141161-30fef2b4ba6a_q9ecqx.avif\" },\n      { slug: \"greeting-postcards\", label: \"Greeting Cards & Postcards\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229146/premium_photo-1719584881335-6e3d846e0930_xlhasr.avif\" },\n      { slug: \"classroom-decorations\", label: \"Classroom Decorations\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758229183/premium_photo-1723618869794-7b9b36d9d150_jqsmm8.avif\" },\n    ],\n  },\n  {\n    slug: \"tools-home-improvement\",\n    label: \"Tools & Home Improvement\",\n    image: \"https://images.unsplash.com/photo-1600256059584-91866a87a094?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"wallpaper\", label: \"Wallpaper\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230944/premium_photo-1676478746576-a3e1a9496c23_iqwogt.avif\" },\n      { slug: \"lighting-ceiling-fans\", label: \"Lighting & Ceiling Fans\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230142/photo-1668784866344-2b61b31d9b9e_zh3sb3.avif\" },\n      { slug: \"building-materials\", label: \"Building Materials\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230161/photo-1631856956423-2b95dae0ba74_mbfgyy.avif\" },\n      { slug: \"equipment\", label: \"Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230182/photo-1581783898377-1c85bf937427_jrwpp5.avif\" },\n      { slug: \"power-tools\", label: \"Power Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230311/photo-1546827209-a218e99fdbe9_akaelk.avif\" },\n      { slug: \"maintenance-tools\", label: \"Maintenance Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230330/photo-1671543565338-8b22a87b8359_qnmtae.avif\" },\n      { slug: \"bathroom-fixtures\", label: \"Bathroom Fixtures\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230348/premium_photo-1664392069421-3e19471c54fe_tdkttc.avif\" },\n      { slug: \"power-tool-parts-accessories\", label: \"Power Tool Parts & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230379/photo-1617916768115-2bcf8944e354_vp6bnq.avif\" },\n      { slug: \"electrical\", label: \"Electrical\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230412/photo-1605818245175-a2cdda1e7b0c_qurnnd.avif\" },\n      { slug: \"security-cameras\", label: \"Security Cameras\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230426/premium_photo-1728848993113-69c351ec7264_ad54w7.avif\" },\n      { slug: \"hardware-accessories\", label: \"Hardware & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230452/photo-1727107463139-97f6911ad4a9_aiovdx.avif\" },\n      { slug: \"holiday-lighting\", label: \"Holiday Lighting\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230475/premium_photo-1661765878003-fe4fae900a5b_tqiohr.avif\" },\n      { slug: \"wall-decals-murals\", label: \"Wall Decals & Murals\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230507/photo-1696960456960-d28ade09ef0e_is3qyo.avif\" },\n      { slug: \"flashlights\", label: \"Flashlights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230522/photo-1561916960-dea3b9b0355a_qfrorn.avif\" },\n      { slug: \"measuring-layout-tools\", label: \"Measuring & Layout Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230579/photo-1501516069922-a9982bd6f3bd_bmayij.avif\" },\n      { slug: \"kitchen-fixtures\", label: \"Kitchen Fixtures\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230620/photo-1708915965975-2a950db0e215_ab0mrq.avif\" },\n      { slug: \"power-outlets-accessories\", label: \"Power Outlets & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230634/photo-1669876505507-b79a89b17ae9_dzmbnn.avif\" },\n      { slug: \"painting-tools\", label: \"Painting Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230655/photo-1607355237291-c2bb971ffacd_hndehy.avif\" },\n      { slug: \"tool-organizers\", label: \"Tool Organizers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230669/premium_photo-1677009834523-367c2e9b281c_q9nhor.avif\" },\n      { slug: \"welding-soldering\", label: \"Welding & Soldering\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230682/photo-1504328345606-18bbc8c9d7d1_ne9xof.avif\" },\n      { slug: \"home-storage-organization\", label: \"Home Storage & Organization\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230692/photo-1516455207990-7a41ce80f7ee_kycyxd.avif\" },\n      { slug: \"plumbing-rough-in\", label: \"Plumbing Rough-In\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230723/photo-1676210134188-4c05dd172f89_klna8v.avif\" },\n      { slug: \"gardening-tools\", label: \"Gardening Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230755/photo-1621460248083-6271cc4437a8_woqx3i.avif\" },\n      { slug: \"led-strip-lights\", label: \"LED Strip Lights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230770/photo-1532529867795-3c83442c1e5c_ocarry.avif\" },\n      { slug: \"safety-security\", label: \"Safety & Security\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230796/photo-1633194883650-df448a10d554_auejub.avif\" },\n      { slug: \"personal-protective-equipment\", label: \"Personal Protective Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230823/photo-1651499910684-b6b82c2da504_hag7qw.avif\" },\n      { slug: \"adhesives-sealants\", label: \"Adhesives & Sealants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230856/photo-1665750373596-f5008ce81951_eotqvf.avif\" },\n      { slug: \"light-bulbs\", label: \"Light Bulbs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758230870/premium_photo-1669380425820-57bbbcc9f712_tytaiq.avif\" },\n    ],\n  },\n  {\n    slug: \"automotive\",\n    label: \"Automotive\",\n    image: \"https://images.unsplash.com/photo-1552519507-da3b142c6e3d?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"tools-equipment\", label: \"Tools & Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758208654/photo-1672659605632-895c18f09563_fdn8jv.avif\" },\n      { slug: \"spare-parts\", label: \"Spare Parts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758208700/photo-1739488754789-5a2e85ee6a79_mjfujc.avif\" },\n      { slug: \"covers-mats-cushions\", label: \"Covers, Mats & Cushions\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758208825/photo-1586199175084-bdd5724a70b9_pvcrki.avif\" },\n      { slug: \"motorcycle-motorsports-accessories\", label: \"Motorcycle & Motorsports Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758208878/photo-1689007969725-33d716cc35aa_x91c7p.avif\" },\n      { slug: \"interior-accessories\", label: \"Interior Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758208948/photo-1655007481917-a94afe515ba5_jggzh9.avif\" },\n      { slug: \"car-audio-video\", label: \"Car Audio & Video\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209166/photo-1734686832415-86abfc6933e7_vrtsj6.avif\" },\n      { slug: \"exterior-accessories\", label: \"Exterior Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209182/photo-1488646953014-85cb44e25828_b8dm38.avif\" },\n      { slug: \"exterior-car-care\", label: \"Exterior Car Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209869/premium_photo-1661443402703-a7e48f84ceec_xqympl.avif\" },\n      { slug: \"lighting-accessories\", label: \"Lighting Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209213/photo-1621696306273-542abbd50d55_oajl5m.avif\" },\n      { slug: \"tires-wheels\", label: \"Tires & Wheels\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209264/photo-1725208037337-55623ac2ee0f_z2nfi3.avif\" },\n      { slug: \"interior-car-care\", label: \"Interior Car Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209317/premium_photo-1661909961389-7d501737abde_rugvsx.avif\" },\n      { slug: \"hand-tools\", label: \"Hand Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209361/photo-1625055930842-b9ad84b7facd_ew8l0f.avif\" },\n      { slug: \"rv-parts-accessories\", label: \"RV Parts & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209413/premium_photo-1697906269831-8cb76e610b62_ccirg6.avif\" },\n      { slug: \"car-sunshades\", label: \"Car Sunshades\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209450/photo-1717659020898-c07d3793539e_ubk8hs.avif\" },\n      { slug: \"car-storage-organizers\", label: \"Car Storage & Organizers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209511/premium_photo-1723618879460-3178cb0a0acd_zxiena.avif\" },\n      { slug: \"chains-car-accessories\", label: \"Chains & Car Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209604/photo-1633818807431-14d29e583bcb_zxdesu.avif\" },\n      { slug: \"rv-furniture\", label: \"RV Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209652/photo-1642437446945-9d4ae9feb47b_kxmetx.avif\" },\n      { slug: \"car-safety-security\", label: \"Car Safety & Security\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209683/premium_photo-1683120825375-a145f07a0862_oluldd.avif\" },\n      { slug: \"gps-accessories\", label: \"GPS Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758209719/premium_photo-1693840238993-5536350d6c57_zvctff.avif\" },\n    ],\n  },\n  {\n    slug: \"pet-supplies\",\n    label: \"Pet Supplies\",\n    image: \"https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"pet-furniture\", label: \"Pet Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218261/photo-1701252969717-116738063b4b_ktimgn.avif\" },\n      { slug: \"pet-beds-bedding\", label: \"Pet Beds & Bedding\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218289/photo-1601758123927-4f7acc7da589_zcbjzm.avif\" },\n      { slug: \"pet-cleaning\", label: \"Pet Cleaning\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218320/photo-1625321150203-cea4bee44b54_mg7cun.avif\" },\n      { slug: \"pet-toys\", label: \"Pet Toys\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218367/istockphoto-1308733142-612x612_tlimar.webp\" },\n      { slug: \"bowls-feeding-tools\", label: \"Bowls & Feeding Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218420/photo-1734654901149-02a9a5f7993b_jlg2tt.avif\" },\n      { slug: \"pet-clothes-accessories\", label: \"Pet Clothes & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218445/photo-1605092116196-404f5b8caa15_dqkzpd.avif\" },\n      { slug: \"pet-care\", label: \"Pet Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218508/photo-1581888475780-27b6b0bc3690_m7cb0m.avif\" },\n      { slug: \"pet-collars-leashes-harnesses\", label: \"Pet Collars, Leashes & Harnesses\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218635/photo-1722456481489-274e9a40a5ff_fun0cs.avif\" },\n      { slug: \"fish-reptiles-amphibians\", label: \"Fish, Reptiles & Amphibians\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218645/photo-1689052261675-ca5cc80a2a67_mhjf27.avif\" },\n      { slug: \"pet-carriers-travel\", label: \"Pet Carriers & Travel\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218698/photo-1608060375223-c5ab552bc9a9_kzrhri.avif\" },\n      { slug: \"bird-supplies\", label: \"Bird Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218826/photo-1717528749613-e8b517ca57ef_m9aukn.avif\" },\n      { slug: \"pet-training-behavior\", label: \"Pet Training & Behavior\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218906/photo-1558371731-b2ee7b6fe882_nwqdzd.avif\" },\n      { slug: \"horse-supplies\", label: \"Horse Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758218924/photo-1557374800-8ba4ccd60e9d_pnbbhj.avif\" },\n      { slug: \"pet-food\", label: \"Pet Food\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219007/photo-1608408891486-f5cade977d19_ntxqwj.avif\" },\n      { slug: \"other-pet-supplies\", label: \"Other Pet Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758219026/photo-1625141976586-ff3f03d2f4d5_jyzv5b.avif\" },\n    ],\n  },\n  {\n    slug: \"yard-garden\",\n    label: \"Yard & Garden\",\n    image: \"https://images.unsplash.com/photo-1501004318641-b39e6451bec6?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"outdoor-lighting\", label: \"Outdoor Lighting\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234763/premium_photo-1675027775616-e61937ca8201_ntyfzq.avif\" },\n      { slug: \"outdoor-decor\", label: \"Outdoor Decor\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234786/photo-1722958093147-b9f0b900780b_fr1cac.avif\" },\n      { slug: \"lawn-mowers-outdoor-power\", label: \"Lawn Mowers & Outdoor Power\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234797/photo-1690068023694-053da714f95f_huxixf.avif\" },\n      { slug: \"planters-containers\", label: \"Planters & Containers\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234807/photo-1662199514706-e48eecaf7a8e_uzc6mi.avif\" },\n      { slug: \"irrigation-watering\", label: \"Irrigation & Watering\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234819/photo-1743742566156-f1745850281a_vxzasx.avif\" },\n      { slug: \"grow-tents-grow-lights\", label: \"Grow Tents & Grow Lights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234835/photo-1636775861341-9acbbdcdf976_yc7bpw.avif\" },\n      { slug: \"plant-support-care\", label: \"Plant Support & Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234935/premium_photo-1664200630491-5f0bda86db50_b1uyhr.avif\" },\n      { slug: \"gardening-tools\", label: \"Gardening Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234957/photo-1526381805515-3fec2d69e7cc_efxdeb.avif\" },\n      { slug: \"pools-hot-tubs\", label: \"Pools & Hot Tubs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234966/photo-1711110065918-388182f86e00_vrdsuz.avif\" },\n      { slug: \"generators-portable-power\", label: \"Generators & Portable Power\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758234994/photo-1681263576605-9eda564bcfcc_nx3ltk.avif\" },\n      { slug: \"garden-statues\", label: \"Garden Statues\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235001/photo-1735611733070-62c0f3669f77_zjjxo6.avif\" },\n      { slug: \"backyard-livestock-beekeeping\", label: \"Backyard Livestock & Beekeeping\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235039/photo-1675110577141-19572eb35624_tfrw7d.avif\" },\n      { slug: \"pest-control\", label: \"Pest Control\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235077/istockphoto-2198514188-612x612_fos96x.webp\" },\n      { slug: \"outdoor-cooking-bbq\", label: \"Outdoor Cooking & BBQ\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235096/photo-1605495121546-5bd6c3fbfeec_me7dmk.avif\" },\n      { slug: \"decorative-garden-stakes\", label: \"Decorative Garden Stakes\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235104/photo-1727378639282-86cd0c0a1ec8_vnkv9c.avif\" },\n      { slug: \"picnic-baskets\", label: \"Picnic Baskets\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235118/photo-1744835897246-1d27f8a8f223_ypkax6.avif\" },\n      { slug: \"holiday-outdoor-lights\", label: \"Holiday Outdoor Lights\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235138/photo-1737171300502-8b771efe86b2_ap5r44.avif\" },\n      { slug: \"thermometers-weather-tools\", label: \"Thermometers & Weather Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235180/photo-1650530224492-f5a8b6e77fae_fucpr9.avif\" },\n      { slug: \"umbrellas-gazebos-pergolas\", label: \"Umbrellas, Gazebos & Pergolas\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235219/photo-1755816764913-bd1104a26d78_vlx50s.avif\" },\n      { slug: \"water-gardens-ponds\", label: \"Water Gardens & Ponds\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235275/photo-1699104888722-06a372b7085f_nfx1dh.avif\" },\n      { slug: \"outdoor-heating-cooling\", label: \"Outdoor Heating & Cooling\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235352/premium_photo-1715620329655-b61bec83764c_ich7cd.avif\" },\n      { slug: \"garden-signs-wall-art\", label: \"Garden Signs & Wall Art\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235386/photo-1748864788316-c4d0a26003c8_bizz0e.avif\" },\n      { slug: \"bird-wildlife-care\", label: \"Bird & Wildlife Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235418/premium_photo-1723622429467-0ba746897e62_db8fu8.avif\" },\n      { slug: \"outdoor-storage\", label: \"Outdoor Storage\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235468/photo-1570008449662-b18b94866a1c_z3qyk1.avif\" },\n      { slug: \"plants-seeds-bulbs\", label: \"Plants, Seeds & Bulbs\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235517/photo-1616078206521-5d7e6dc51545_z7vjvg.avif\" },\n      { slug: \"snow-removal\", label: \"Snow Removal\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758235545/photo-1676768881129-4b353236cb1c_ztpzt6.avif\" },\n    ],\n  },\n  {\n    slug: \"business-industry-science\",\n    label: \"Business, Industry & Science\",\n    image: \"https://images.unsplash.com/photo-1503387762-592deb58ef4e?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"catering-equipment-supplies\", label: \"Catering Equipment & Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231670/premium_photo-1754262063340-7866b9829f79_zq3kqm.avif\" },\n      { slug: \"maintenance-tools\", label: \"Maintenance Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231724/photo-1606676539940-12768ce0e762_ukmk37.avif\" },\n      { slug: \"test-measure-inspection-devices\", label: \"Test, Measure & Inspection Devices\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231728/premium_photo-1683141381544-390e29f842fb_ozt3jy.avif\" },\n      { slug: \"sanitation-supplies\", label: \"Sanitation Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231763/photo-1649073005971-37babef31983_qoz5d8.avif\" },\n      { slug: \"cutting-tools\", label: \"Cutting Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231784/photo-1685320198649-781e83a61de4_norypg.avif\" },\n      { slug: \"professional-medical-supplies\", label: \"Professional Medical Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231796/photo-1700832082152-0416a3ee5e60_stayqx.avif\" },\n      { slug: \"retail-store-equipment\", label: \"Retail Store Equipment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231848/photo-1546213290-e1b492ab3eee_ovqipw.avif\" },\n      { slug: \"industrial-electronics\", label: \"Industrial Electronics\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231917/photo-1756402751986-15f343b1437f_lxvfnk.avif\" },\n      { slug: \"occupational-health-safety-products\", label: \"Occupational Health & Safety Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232454/premium_photo-1682097268251-c441286ff9bf_p7eoaa.avif\" },\n      { slug: \"adhesives-sealants\", label: \"Adhesives & Sealants\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231945/photo-1665750373596-f5008ce81951_qq5gp0.avif\" },\n      { slug: \"industrial-construction-tools\", label: \"Industrial Construction Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231974/photo-1426927308491-6380b6a9936f_sjgvej.avif\" },\n      { slug: \"abrasives-finishing-products\", label: \"Abrasives & Finishing Products\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758231993/photo-1613206485477-34b2b17fa93f_fadgo4.avif\" },\n      { slug: \"equipment-material-handling\", label: \"Equipment & Material Handling\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232014/premium_photo-1681487516403-773ca29231e0_brbkj7.avif\" },\n      { slug: \"hydraulic-pneumatic-plumbing-tools\", label: \"Hydraulic, Pneumatic & Plumbing Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232029/premium_photo-1682144538950-d2595484bc07_kyqnen.avif\" },\n      { slug: \"packaging-shipping-supplies\", label: \"Packaging & Shipping Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232400/photo-1585221330389-24fb30535ec7_mtbbmh.avif\" },\n      { slug: \"fastening-tools\", label: \"Fastening Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232050/premium_photo-1726873518372-dd139d99b7f7_ifata6.avif\" },\n      { slug: \"lab-science-tools\", label: \"Lab & Science Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232059/istockphoto-2167417147-612x612_p23gvh.webp\" },\n      { slug: \"industrial-materials\", label: \"Industrial Materials\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232080/photo-1631856956334-35db20cb7748_exqoe7.avif\" },\n      { slug: \"science-teaching-tools\", label: \"Science Teaching Tools\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232090/photo-1595256899816-bb1d65a24d2a_loixmq.avif\" },\n      { slug: \"professional-dental-supplies\", label: \"Professional Dental Supplies\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232104/photo-1626878880028-0438b1403b3f_tcalpy.avif\" },\n      { slug: \"3d-printers-accessories\", label: \"3D Printers & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232119/premium_photo-1714859729114-e3f8a3ca8e69_to6hrm.avif\" },\n      { slug: \"commercial-furniture\", label: \"Commercial Furniture\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758232147/photo-1595846265893-f433f6cca81d_o1kia4.avif\" },\n    ],\n  },\n  {\n    slug: \"baby-maternity\",\n    label: \"Baby & Maternity\",\n    image: \"https://images.unsplash.com/photo-1546015720-6939e13843b2?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"feeding\", label: \"Feeding\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238802/photo-1570560558077-45ad028193e5_iczx07.avif\" },\n      { slug: \"nursery-decor\", label: \"Nursery Decor\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238819/photo-1745636624761-8173b91e8334_ovgmzp.avif\" },\n      { slug: \"nursery\", label: \"Nursery\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238841/premium_photo-1723291295209-cb2c2e2ce296_hjsfdo.avif\" },\n      { slug: \"baby-care\", label: \"Baby Care\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238892/premium_photo-1661780612169-8d58ad9a2949_zqqid9.avif\" },\n      { slug: \"baby-dolls\", label: \"Baby Dolls\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238927/premium_photo-1664303422171-3105788b61a0_sxrusm.avif\" },\n      { slug: \"baby-activities-entertainment\", label: \"Baby Activities & Entertainment\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758238970/photo-1563181406-c7df754d1f2e_rttbn1.avif\" },\n      { slug: \"baby-travel-gear\", label: \"Baby Travel Gear\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239001/premium_photo-1661458128036-bcf19e191421_mlkwdf.avif\" },\n      { slug: \"child-safety\", label: \"Child Safety\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239001/premium_photo-1661458128036-bcf19e191421_mlkwdf.avif\" },\n      { slug: \"strollers-accessories\", label: \"Strollers & Accessories\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239043/premium_photo-1661423810145-8a5cdd8f7986_oykd6h.avif\" },\n      { slug: \"potty-training\", label: \"Potty Training\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239097/premium_photo-1729097011511-6788137052ab_k5ismt.avif\" },\n      { slug: \"baby-storage-organization\", label: \"Baby Storage & Organization\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239129/premium_photo-1675744019226-469d159d1bf0_ayx7mr.avif\" },\n      { slug: \"baby-gifts\", label: \"Baby Gifts\", image: \"https://res.cloudinary.com/dkwh8kbgr/image/upload/v1758239156/premium_photo-1723924804318-59a35f3c9e8c_yy7xuf.avif\" },\n    ],\n  },\n\n  // Special / Trend / Collections\n  {\n    slug: \"special-collections\",\n    label: \"Special Collections / Trends\",\n    image: \"https://images.unsplash.com/photo-1570823635306-2a54224d3521?q=80&w=640&auto=format&fit=crop\",\n    children: [\n      { slug: \"ramadan\", label: \"Ramadan Collection\", image: \"https://images.unsplash.com/photo-1617137968429-90d5d3b61463?q=80&w=640&auto=format&fit=crop\" },\n      { slug: \"eid\", label: \"Eid Collection\", image: \"https://images.unsplash.com/photo-1590393748494-096c684f354a?q=80&w=640&auto=format&fit=crop\" },\n      { slug: \"summer\", label: \"Summer Collection\", image: \"https://images.unsplash.com/photo-1470240731273-7821a6eeb6bd?q=80&w=640&auto=format&fit=crop\" },\n      { slug: \"new-in\", label: \"New In\", image: \"https://images.unsplash.com/photo-1445205170230-053b83016050?q=80&w=640&auto=format&fit=crop\" },\n      { slug: \"flash-sale\", label: \"Flash Sale\", image: \"https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=640&auto=format&fit=crop\" },\n      { slug: \"clearance\", label: \"Clearance\", image: \"https://images.unsplash.com/photo-1508873660763-1c2153ecf215?q=80&w=640&auto=format&fit=crop\" },\n    ],\n  },\n  { slug: \"sale\", label: \"Sale\", image: \"https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=640&auto=format&fit=crop\" },\n  { slug: \"new-in\", label: \"New In\", image: \"https://images.unsplash.com/photo-1441986300917-64674bd600d8?q=80&w=640&auto=format&fit=crop\" },\n  { slug: \"general\", label: \"General\", image: \"https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=640&auto=format&fit=crop\" },\n];\n","path":null,"size_bytes":111577,"size_tokens":null},"src/lib/cart-actions.ts":{"content":"\"use server\";\n\nimport { createServerComponentClient } from \"@supabase/auth-helpers-nextjs\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport { z } from \"zod\";\nimport { revalidatePath } from \"next/cache\";\nimport type { CartItem, Product } from \"./types\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\n// Fetch product with graceful fallback if `is_active` column is missing (pre-migration)\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function getProductById(admin: any, id: number) {\n  // Try selecting with is_active first\n  const { data, error } = await admin\n    .from(\"products\")\n    .select(\"id, stock, title, is_active\")\n    .eq(\"id\", id)\n    .single();\n\n  if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n    const fb = await admin\n      .from(\"products\")\n      .select(\"id, stock, title\")\n      .eq(\"id\", id)\n      .single();\n    return (fb.data as any) ?? null;\n  }\n\n  return (data as any) ?? null;\n}\n\nconst addItemSchema = z.object({\n  productId: z.number(),\n  quantity: z.number().min(1),\n  productSlug: z.string().min(1).optional(),\n});\n\nfunction parseSelectedOption(formData: FormData): { name: string; value: string } | null {\n  const known = new Set([\"productId\", \"quantity\", \"productSlug\"]);\n  for (const [k, v] of formData.entries()) {\n    if (known.has(k)) continue;\n    const val = typeof v === \"string\" ? v : String(v);\n    const clean = val.trim();\n    if (clean.length > 0) {\n      return { name: k, value: clean };\n    }\n  }\n  return null;\n}\n\nasync function getOrCreateCart() {\n  const supabaseAuth = createServerComponentClient({ cookies });\n  const { data: { user } } = await supabaseAuth.auth.getUser();\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    throw new Error(\"Could not create a cart.\");\n  }\n\n  // If user is logged in, try to find their existing cart\n  if (user) {\n    const { data: cart, error } = await supabaseAdmin\n      .from('cart_sessions')\n      .select('id')\n      .eq('user_id', user.id)\n      .single();\n    \n    if (cart) {\n      // Set cookie and return existing cart ID\n      cookies().set(\"cart_id\", cart.id, {\n        httpOnly: true,\n        sameSite: \"lax\",\n        path: \"/\",\n        secure: process.env.NODE_ENV === 'production',\n      });\n      return { id: cart.id };\n    }\n  }\n\n  const cartId = cookies().get(\"cart_id\")?.value;\n\n  if (cartId) {\n    const { data: cart } = await supabaseAdmin\n      .from(\"cart_sessions\")\n      .select(\"id, user_id\")\n      .eq(\"id\", cartId)\n      .single();\n    if (cart) {\n        // If user is now logged in, associate the cart with them\n        if (user && !cart.user_id) {\n          await supabaseAdmin.from('cart_sessions').update({ user_id: user.id }).eq('id', cart.id);\n        }\n        return { id: cart.id };\n    }\n  }\n\n  // If no cart_id cookie or cart not found, create a new one\n  const { data: newCart, error } = await supabaseAdmin\n    .from(\"cart_sessions\")\n    .insert({ user_id: user?.id })\n    .select(\"id\")\n    .single();\n\n  if (error || !newCart) {\n    throw new Error(\"Could not create a cart.\");\n  }\n\n  cookies().set(\"cart_id\", newCart.id, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    path: \"/\",\n    secure: process.env.NODE_ENV === \"production\",\n  });\n\n  return newCart;\n}\n\nexport async function getCart() {\n  const cartId = cookies().get(\"cart_id\")?.value;\n\n  if (!cartId) {\n    return [];\n  }\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    console.warn(\"getCart: Supabase service role env vars missing; returning empty cart.\");\n    return [];\n  }\n\n  const { data: items, error } = await supabaseAdmin\n    .from(\"cart_items\")\n    .select(`\n      id,\n      quantity,\n      variant_id,\n      variant:product_variants (*),\n      products (*)\n    `)\n    .eq(\"session_id\", cartId)\n    .order(\"created_at\", { ascending: true });\n\n  if (error) {\n    console.error(\"Error fetching cart:\", error);\n    return [];\n  }\n\n  if (!items) {\n    return [];\n  }\n\n  const cartItems = items.map((item: any) => ({\n    id: item.id,\n    quantity: item.quantity,\n    product: item.products, // Supabase returns 'products', so we map it to 'product'\n    variant: item.variant ?? null,\n  }));\n\n  return cartItems as CartItem[];\n}\n\nexport async function getCartItemsBySessionId(cartSessionId: string) {\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    console.warn(\"getCartItemsBySessionId: Supabase service role env vars missing; returning empty list.\");\n    return { items: [], error: null };\n  }\n\n  const { data: items, error } = await supabaseAdmin\n    .from(\"cart_items\")\n    .select(`\n      id,\n      quantity,\n      variant_id,\n      variant:product_variants (*),\n      products (*)\n    `)\n    .eq(\"session_id\", cartSessionId);\n\n  if (error) {\n    console.error(\"Error fetching cart items by session ID:\", error);\n    return { items: null, error };\n  }\n\n  if (!items) {\n    return { items: [], error: null };\n  }\n\n  const cartItems: CartItem[] = items.map((item: any) => ({\n    id: item.id,\n    quantity: item.quantity,\n    product: item.products as Product,\n    variant: (item.variant as any) ?? null,\n  }));\n\n  return { items: cartItems, error: null };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function getProductBySlug(admin: any, slug: string) {\n  const { data, error } = await admin\n    .from(\"products\")\n    .select(\"id, stock, title, is_active\")\n    .eq(\"slug\", slug)\n    .single();\n\n  if (error && (String((error as any).message || \"\").includes(\"is_active\") || (error as any).code === \"42703\")) {\n    const fb = await admin\n      .from(\"products\")\n      .select(\"id, stock, title\")\n      .eq(\"slug\", slug)\n      .single();\n    return (fb.data as any) ?? null;\n  }\n  return (data as any) ?? null;\n}\n\nexport async function addItem(prevState: any, formData: FormData) {\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { error: \"Server misconfiguration.\" };\n  }\n  const validatedFields = addItemSchema.safeParse({\n    productId: Number(formData.get(\"productId\")),\n    quantity: Number(formData.get(\"quantity\")),\n    productSlug: (() => {\n      const v = formData.get(\"productSlug\");\n      return typeof v === \"string\" && v.trim().length > 0 ? v : undefined;\n    })(),\n  });\n\n  if (!validatedFields.success) {\n    return { error: \"Invalid input.\" };\n  }\n\n  let { productId, quantity, productSlug } = validatedFields.data;\n  const selected = parseSelectedOption(formData); // e.g., { name: \"Size\", value: \"L\" }\n\n  try {\n    // 1. Fetch product and optional variant\n    let product = await getProductById(supabaseAdmin, productId);\n    if (!product && productSlug) {\n      const bySlug = await getProductBySlug(supabaseAdmin, productSlug);\n      if (bySlug) {\n        product = bySlug;\n        productId = bySlug.id as number; // normalize id for subsequent operations\n      }\n    }\n\n    if (!product) {\n      return { error: \"Product not found.\" };\n    }\n    if (Object.prototype.hasOwnProperty.call(product, \"is_active\") && (product as any).is_active === false) {\n      return { error: `This product is no longer available.` };\n    }\n\n    // Try resolve variant_id if option provided\n    let variantRow: any = null;\n    if (selected) {\n      const { data: vrow } = await supabaseAdmin\n        .from(\"product_variants\")\n        .select(\"*\")\n        .eq(\"product_id\", productId)\n        .eq(\"option_name\", selected.name)\n        .eq(\"option_value\", selected.value)\n        .maybeSingle();\n      variantRow = vrow ?? null;\n    }\n\n    const cart = await getOrCreateCart();\n\n    // Check if item already exists in cart\n    let existingItem: any = null;\n    if (variantRow && variantRow.id) {\n      const { data } = await supabaseAdmin\n        .from(\"cart_items\")\n        .select(\"id, quantity\")\n        .eq(\"session_id\", cart.id)\n        .eq(\"product_id\", productId)\n        .eq(\"variant_id\", variantRow.id)\n        .maybeSingle();\n      existingItem = data ?? null;\n    } else {\n      const { data } = await supabaseAdmin\n        .from(\"cart_items\")\n        .select(\"id, quantity\")\n        .eq(\"session_id\", cart.id)\n        .eq(\"product_id\", productId)\n        .is(\"variant_id\", null)\n        .maybeSingle();\n      existingItem = data ?? null;\n    }\n\n    if (existingItem) {\n      // Update quantity\n      const newQuantity = existingItem.quantity + quantity;\n\n      // 2a. Check stock before updating\n      if (variantRow && typeof variantRow.stock === 'number') {\n        if (newQuantity > variantRow.stock) {\n          return { error: `الكمية المطلوبة غير متوفرة للمقاس ${variantRow.option_value}. المتبقي ${variantRow.stock}.` };\n        }\n      } else if (newQuantity > product.stock) {\n        return { error: `Not enough stock for ${product.title}. Only ${product.stock} left.` };\n      }\n\n      const { error } = await supabaseAdmin\n        .from(\"cart_items\")\n        .update({ quantity: newQuantity })\n        .eq(\"id\", existingItem.id);\n      if (error) throw error;\n    } else {\n      // 2b. Check stock before inserting\n      if (variantRow && typeof variantRow.stock === 'number') {\n        if (quantity > variantRow.stock) {\n          return { error: `الكمية المطلوبة غير متوفرة للمقاس ${variantRow.option_value}. المتبقي ${variantRow.stock}.` };\n        }\n      } else if (quantity > product.stock) {\n        return { error: `Not enough stock for ${product.title}. Only ${product.stock} left.` };\n      }\n\n      // Insert new item\n      const insertPayload: any = { session_id: cart.id, product_id: productId, quantity };\n      if (variantRow && variantRow.id) insertPayload.variant_id = variantRow.id;\n      const { error } = await supabaseAdmin\n        .from(\"cart_items\")\n        .insert(insertPayload);\n      if (error) throw error;\n    }\n\n    revalidatePath(\"/cart\");\n    revalidatePath(\"/\");\n\n    return { success: \"Item added to cart.\" };\n  } catch (e) {\n    console.error(e);\n    return { error: \"An unexpected error occurred.\" };\n  }\n}\n\nexport async function clearCart() {\n  const cartId = cookies().get(\"cart_id\")?.value;\n\n  if (!cartId) return { success: true };\n\n  try {\n    const supabaseAdmin = getSupabaseAdmin();\n    if (!supabaseAdmin) {\n      return { success: false };\n    }\n    const { error } = await supabaseAdmin\n      .from(\"cart_items\")\n      .delete()\n      .eq(\"session_id\", cartId);\n    if (error) throw error;\n    revalidatePath(\"/cart\");\n    return { success: true };\n  } catch (e) {\n    console.error(e);\n    return { error: \"An unexpected error occurred.\" };\n  }\n}\n\nconst updateItemSchema = z.object({\n  itemId: z.number(),\n  quantity: z.number().min(0),\n});\n\nexport async function updateItemQuantity(prevState: any, formData: FormData) {\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { error: \"Server misconfiguration.\" };\n  }\n  const validatedFields = updateItemSchema.safeParse({\n    itemId: Number(formData.get(\"itemId\")),\n    quantity: Number(formData.get(\"quantity\")),\n  });\n\n  if (!validatedFields.success) {\n    return { error: \"Invalid input.\" };\n  }\n\n  const { itemId, quantity } = validatedFields.data;\n  const cartId = cookies().get(\"cart_id\")?.value;\n\n  if (!cartId) return { error: \"Cart not found.\" };\n\n  try {\n    if (quantity === 0) {\n      // Remove item if quantity is 0\n      const { error } = await supabaseAdmin\n        .from(\"cart_items\")\n        .delete()\n        .eq(\"id\", itemId)\n        .eq(\"session_id\", cartId);\n      if (error) throw error;\n    } else {\n      // Validate stock before updating quantity\n      const { data: itemRow, error: itemErr } = await supabaseAdmin\n        .from(\"cart_items\")\n        .select(\"id, product_id, variant_id\")\n        .eq(\"id\", itemId)\n        .eq(\"session_id\", cartId)\n        .single();\n      if (itemErr || !itemRow) {\n        return { error: \"Cart item not found.\" };\n      }\n\n      const product = await getProductById(supabaseAdmin, itemRow.product_id as number);\n      if (!product) {\n        return { error: \"Product not found.\" };\n      }\n      if (Object.prototype.hasOwnProperty.call(product, \"is_active\") && (product as any).is_active === false) {\n        return { error: `This product is no longer available.` };\n      }\n      if (typeof itemRow.variant_id === 'number') {\n        const { data: vrow } = await supabaseAdmin\n          .from(\"product_variants\")\n          .select(\"stock, option_value\")\n          .eq(\"id\", itemRow.variant_id)\n          .single();\n        const vstock = (vrow as any)?.stock ?? 0;\n        if (quantity > vstock) {\n          return { error: `الكمية المطلوبة غير متوفرة للمقاس ${(vrow as any)?.option_value ?? ''}. المتبقي ${vstock}.` };\n        }\n      } else if (quantity > product.stock) {\n        return { error: `Not enough stock for ${product.title}. Only ${product.stock} left.` };\n      }\n\n      // Update quantity\n      const { error } = await supabaseAdmin\n        .from(\"cart_items\")\n        .update({ quantity })\n        .eq(\"id\", itemId)\n        .eq(\"session_id\", cartId);\n      if (error) throw error;\n    }\n\n    revalidatePath(\"/cart\");\n    return { success: \"Cart updated.\" };\n  } catch (e) {\n    console.error(e);\n    return { error: \"An unexpected error occurred.\" };\n  }\n}\n\nconst removeItemSchema = z.object({\n  itemId: z.number(),\n});\n\nexport async function removeItem(prevState: any, formData: FormData) {\n  const supabaseAdmin = getSupabaseAdmin();\n  if (!supabaseAdmin) {\n    return { error: \"Server misconfiguration.\" };\n  }\n  const validatedFields = removeItemSchema.safeParse({\n    itemId: Number(formData.get(\"itemId\")),\n  });\n\n  if (!validatedFields.success) {\n    return { error: \"Invalid input.\" };\n  }\n\n  const { itemId } = validatedFields.data;\n  const cartId = cookies().get(\"cart_id\")?.value;\n\n  if (!cartId) return { error: \"Cart not found.\" };\n\n  try {\n    const { error } = await supabaseAdmin\n      .from(\"cart_items\")\n      .delete()\n      .eq(\"id\", itemId)\n      .eq(\"session_id\", cartId);\n\n    if (error) throw error;\n\n    revalidatePath(\"/cart\");\n    return { success: \"Item removed.\" };\n  } catch (e) {\n    console.error(e);\n    return { error: \"An unexpected error occurred.\" };\n  }\n}\n","path":null,"size_bytes":14455,"size_tokens":null},"src/app/admin/jobs/[id]/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\nimport { useParams } from \"next/navigation\";\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\ntype Job = { id: number; created_at: string; kind: string; status: string; started_at?: string|null; finished_at?: string|null; totals?: any; error_text?: string|null };\n\ntype JobItem = { id: number; status: string; step: string | null; cj_product_id?: string | null; cj_sku?: string | null; result?: any; error_text?: string | null };\n\ntype JobResp = { ok: boolean; job?: Job; items?: JobItem[]; error?: string };\n\ntype RunResp = { ok: boolean; done?: boolean; stepsRun?: number; candidatesAddedTotal?: number; error?: string };\n\ntype ActionResp = { ok: boolean; error?: string };\n\nexport default function JobDetailsPage() {\n  const params = useParams() as { id: string };\n  const id = Number(params?.id || 0);\n\n  const [job, setJob] = useState<Job | null>(null);\n  const [items, setItems] = useState<JobItem[]>([]);\n  const [error, setError] = useState<string | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [acting, setActing] = useState(false);\n\n  async function load() {\n    if (!id) return;\n    setLoading(true); setError(null);\n    try {\n      const r = await fetch(`/api/admin/jobs/${id}`, { cache: 'no-store' });\n      const j: JobResp = await r.json();\n      if (!r.ok || !j.ok || !j.job) throw new Error(j.error || `HTTP ${r.status}`);\n      setJob(j.job); setItems(j.items || []);\n    } catch (e: any) {\n      setError(e?.message || 'Failed to load job');\n    } finally { setLoading(false); }\n  }\n\n  async function run(mode: 'step'|'all') {\n    setActing(true); setError(null);\n    try {\n      const r = await fetch(`/api/admin/jobs/${id}/run`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ mode }) });\n      const j: RunResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await load();\n    } catch (e: any) {\n      setError(e?.message || 'Run failed');\n    } finally { setActing(false); }\n  }\n\n  async function cancel() {\n    setActing(true); setError(null);\n    try {\n      const r = await fetch(`/api/admin/jobs/${id}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'cancel' }) });\n      const j: ActionResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      await load();\n    } catch (e: any) {\n      setError(e?.message || 'Cancel failed');\n    } finally { setActing(false); }\n  }\n\n  useEffect(() => { load(); const t = setInterval(load, 5000); return () => clearInterval(t); }, [id]);\n\n  const candidates = items.filter(it => it.step === 'candidate');\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-baseline justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-semibold\">Job #{id}</h1>\n          {job && (\n            <div className=\"text-sm text-muted-foreground\">{job.kind} • {job.status} • created {new Date(job.created_at).toLocaleString()}</div>\n          )}\n        </div>\n        <Link href=\"/admin/jobs\" className=\"text-sm text-blue-600 hover:underline\">Back</Link>\n      </div>\n\n      {error && <div className=\"rounded border border-red-200 bg-red-50 p-3 text-sm text-red-800\">{error}</div>}\n\n      <div className=\"flex items-center gap-3\">\n        <button onClick={() => run('step')} disabled={acting || loading} className=\"rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700\">Run 1 step</button>\n        <button onClick={() => run('all')} disabled={acting || loading} className=\"rounded bg-blue-600 px-3 py-1.5 text-white hover:bg-blue-700\">Run to completion</button>\n        <button onClick={cancel} disabled={acting || loading} className=\"rounded bg-rose-600 px-3 py-1.5 text-white hover:bg-rose-700\">Cancel</button>\n      </div>\n\n      <section className=\"rounded border bg-white p-4\">\n        <h2 className=\"text-lg font-medium mb-2\">Items</h2>\n        <div className=\"rounded border bg-muted/20 overflow-auto\">\n          <table className=\"min-w-full text-sm\">\n            <thead>\n              <tr className=\"bg-muted\">\n                <th className=\"p-2 text-left\">ID</th>\n                <th className=\"p-2 text-left\">Step</th>\n                <th className=\"p-2 text-left\">CJ PID</th>\n                <th className=\"p-2 text-left\">CJ SKU</th>\n                <th className=\"p-2 text-left\">Status</th>\n                <th className=\"p-2 text-left\">Meta</th>\n              </tr>\n            </thead>\n            <tbody>\n              {items.map(it => (\n                <tr key={it.id} className=\"border-t align-top\">\n                  <td className=\"p-2 font-mono text-xs\">{it.id}</td>\n                  <td className=\"p-2\">{it.step || '-'}</td>\n                  <td className=\"p-2 font-mono text-xs\">{it.cj_product_id || '-'}</td>\n                  <td className=\"p-2 font-mono text-xs\">{it.cj_sku || '-'}</td>\n                  <td className=\"p-2\">{it.status}</td>\n                  <td className=\"p-2\"><pre className=\"max-w-[480px] whitespace-pre-wrap break-words text-xs\">{it.result ? JSON.stringify(it.result, null, 2) : (it.error_text || '-')}</pre></td>\n                </tr>\n              ))}\n              {(!items || items.length===0) && !loading && (\n                <tr><td colSpan={6} className=\"p-4 text-center text-sm text-muted-foreground\">No items</td></tr>\n              )}\n            </tbody>\n          </table>\n        </div>\n\n        {candidates.length > 0 && (\n          <div className=\"mt-4 text-sm text-muted-foreground\">Candidates collected: {candidates.length}</div>\n        )}\n      </section>\n\n      {loading && <div className=\"text-sm text-gray-500\">Loading…</div>}\n    </div>\n  );\n}\n","path":null,"size_bytes":5836,"size_tokens":null},"src/app/admin/orders/page.tsx":{"content":"import { createClient } from \"@supabase/supabase-js\";\nimport { format } from \"date-fns\";\nimport { formatCurrency } from \"@/lib/utils\";\nimport type { Order } from \"@/lib/types\";\nimport {\n  Table,\n  TableBody,\n  TableCaption,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport OrderStatusForm from \"@/app/admin/orders/status-form\";\nimport { AdminFulfillCjButton } from \"@/components/admin-fulfill-cj-button\";\n\n// Admin client to bypass RLS (lazy init to avoid build-time env requirements)\nlet supabaseAdmin: any = null;\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  if (!supabaseAdmin) {\n    supabaseAdmin = createClient(url, key);\n  }\n  return supabaseAdmin as ReturnType<typeof createClient> | null;\n}\n\nexport const dynamic = \"force-dynamic\";\nexport const revalidate = 0;\n\nasync function getOrders(): Promise<Order[]> {\n  const client = getSupabaseAdmin();\n  if (!client) return [];\n  const { data, error } = await client\n    .from(\"orders\")\n    .select(`*`)\n    .order(\"created_at\", { ascending: false });\n\n  if (error) {\n    console.error(\"Error fetching orders:\", error);\n    return [];\n  }\n  return data as Order[];\n}\n\nexport default async function OrdersPage() {\n  const orders = await getOrders();\n\n  return (\n    <div className=\"w-full\">\n      <h1 className=\"text-2xl font-bold mb-6\">Orders</h1>\n      <div className=\"rounded-md border\">\n        <Table>\n          <TableCaption>A list of recent orders.</TableCaption>\n          <TableHeader>\n            <TableRow>\n              <TableHead>Order</TableHead>\n              <TableHead>Date</TableHead>\n              <TableHead className=\"hidden md:table-cell\">User ID</TableHead>\n              <TableHead className=\"text-right\">Total</TableHead>\n              <TableHead className=\"text-center\">Status</TableHead>\n              <TableHead className=\"hidden lg:table-cell\">CJ Order</TableHead>\n              <TableHead className=\"hidden lg:table-cell\">Tracking</TableHead>\n              <TableHead className=\"hidden lg:table-cell\">Shipping</TableHead>\n            </TableRow>\n          </TableHeader>\n          <TableBody>\n            {orders.map((order) => (\n              <TableRow key={order.id}>\n                <TableCell className=\"font-medium\">#{order.id}</TableCell>\n                <TableCell>\n                  {format(new Date(order.created_at), \"MMM d, yyyy\")}\n                </TableCell>\n                <TableCell className=\"hidden md:table-cell text-xs font-mono\">{order.user_id}</TableCell>\n                <TableCell className=\"text-right\">\n                  {formatCurrency(order.total_amount)}\n                </TableCell>\n                <TableCell className=\"text-center\">\n                  <div className=\"flex items-center justify-center gap-2\">\n                    <Badge variant={order.status === 'paid' ? 'default' : 'secondary'}>\n                      {order.status}\n                    </Badge>\n                    <OrderStatusForm orderId={order.id} current={order.status} />\n                    {/* Manual CJ fulfillment trigger (in addition to automatic Stripe webhook) */}\n                    <AdminFulfillCjButton orderId={order.id} />\n                  </div>\n                </TableCell>\n                <TableCell className=\"hidden lg:table-cell text-xs font-mono\">{order.cj_order_no || '—'}</TableCell>\n                <TableCell className=\"hidden lg:table-cell text-xs\">{order.tracking_number || '—'}{order.carrier ? ` (${order.carrier})` : ''}</TableCell>\n                <TableCell className=\"hidden lg:table-cell text-xs\">{order.shipping_status || '—'}</TableCell>\n              </TableRow>\n            ))}\n          </TableBody>\n        </Table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3892,"size_tokens":null},"src/app/api/admin/cj/v2/search/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { searchProducts, type ProductSearchFilters, type CJProductSearchResult } from '@/lib/cj/product-discovery';\nimport { calculateKSAPrice, type PricingResult } from '@/lib/cj/ksa-pricing';\n\nexport const dynamic = 'force-dynamic';\n\ninterface SearchRequest {\n  keyword?: string;\n  categoryId?: string;\n  minPrice?: number;\n  maxPrice?: number;\n  minStock?: number;\n  minRating?: number;\n  freeShippingOnly?: boolean;\n  quantity?: number;\n  marginPercent?: number;\n  page?: number;\n  pageSize?: number;\n}\n\ninterface ProductWithPricing extends CJProductSearchResult {\n  shippingUSD: number;\n  shippingDays: string;\n  pricing: PricingResult;\n}\n\nfunction estimateShippingToKSA(cjPriceUSD: number): { shippingUSD: number; shippingDays: string } {\n  if (cjPriceUSD < 5) return { shippingUSD: 2.50, shippingDays: '10-20' };\n  if (cjPriceUSD < 15) return { shippingUSD: 3.50, shippingDays: '10-18' };\n  if (cjPriceUSD < 30) return { shippingUSD: 4.50, shippingDays: '8-15' };\n  if (cjPriceUSD < 50) return { shippingUSD: 5.50, shippingDays: '7-14' };\n  return { shippingUSD: 7.00, shippingDays: '7-12' };\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body: SearchRequest = await request.json();\n\n    const filters: ProductSearchFilters = {\n      keyword: body.keyword,\n      categoryId: body.categoryId,\n      minPrice: body.minPrice,\n      maxPrice: body.maxPrice,\n      minStock: body.minStock || 10,\n      freeShippingOnly: body.freeShippingOnly,\n      sortBy: 'listing_count',\n      sortDirection: 'desc',\n      page: body.page || 1,\n      pageSize: Math.min(body.pageSize || 20, 100),\n      includeDescription: true,\n      includeCategory: true,\n    };\n\n    const searchResult = await searchProducts(filters);\n\n    const productsWithPricing: ProductWithPricing[] = [];\n    const targetQuantity = body.quantity || searchResult.products.length;\n\n    for (const product of searchResult.products) {\n      if (productsWithPricing.length >= targetQuantity) break;\n\n      if (body.minRating && product.listedNum < (body.minRating * 100)) {\n        continue;\n      }\n\n      const cjPrice = parseFloat(product.discountPrice || product.nowPrice || product.sellPrice) || 0;\n      \n      if (cjPrice <= 0) continue;\n      \n      const { shippingUSD, shippingDays } = estimateShippingToKSA(cjPrice);\n      \n      const pricing = calculateKSAPrice({\n        cjPriceUSD: cjPrice,\n        shippingUSD,\n        categorySlug: product.threeCategoryName?.toLowerCase(),\n        marginPercent: body.marginPercent,\n      });\n\n      productsWithPricing.push({\n        ...product,\n        shippingUSD,\n        shippingDays,\n        pricing,\n      });\n    }\n\n    return NextResponse.json({\n      ok: true,\n      products: productsWithPricing,\n      totalFound: searchResult.totalRecords,\n      totalPages: searchResult.totalPages,\n      currentPage: searchResult.currentPage,\n      returned: productsWithPricing.length,\n    });\n  } catch (error) {\n    console.error('CJ Search error:', error);\n    return NextResponse.json(\n      {\n        ok: false,\n        error: error instanceof Error ? error.message : 'Search failed',\n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3226,"size_tokens":null},"src/app/admin/cj/import/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\n\ntype ConnectionStatus = {\n  ok: boolean;\n  message: string;\n  responseTime?: number;\n  categoriesCount?: number;\n};\n\ntype Category = {\n  id: string;\n  name: string;\n  fullPath: string;\n  level1: string;\n  level2: string;\n  level3: string;\n};\n\ntype PricingBreakdown = {\n  cjPriceUSD: number;\n  shippingUSD: number;\n  totalCostUSD: number;\n  totalCostSAR: number;\n  vatAmount: number;\n  paymentFeeAmount: number;\n  profitAmount: number;\n  rawTotal: number;\n  roundedTotal: number;\n};\n\ntype ProductResult = {\n  id: string;\n  nameEn: string;\n  sku: string;\n  bigImage: string;\n  sellPrice: string;\n  nowPrice?: string;\n  discountPrice?: string;\n  listedNum: number;\n  categoryId: string;\n  threeCategoryName?: string;\n  twoCategoryName?: string;\n  oneCategoryName?: string;\n  warehouseInventoryNum: number;\n  description?: string;\n  deliveryCycle?: string;\n  shippingUSD: number;\n  shippingDays: string;\n  pricing: {\n    baseCostUSD: number;\n    baseCostSAR: number;\n    vatSAR: number;\n    paymentFeeSAR: number;\n    profitSAR: number;\n    finalPriceSAR: number;\n    roundedPriceSAR: number;\n    actualMarginPercent: number;\n    breakdown: PricingBreakdown;\n    needsReview: boolean;\n    reviewReason?: string;\n  };\n};\n\nexport default function CJImportPage() {\n  const [connectionStatus, setConnectionStatus] = useState<ConnectionStatus | null>(null);\n  const [categories, setCategories] = useState<Category[]>([]);\n  const [loadingConnection, setLoadingConnection] = useState(true);\n  const [loadingCategories, setLoadingCategories] = useState(false);\n\n  const [keyword, setKeyword] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"\");\n  const [minPrice, setMinPrice] = useState<number | \"\">(\"\");\n  const [maxPrice, setMaxPrice] = useState<number | \"\">(\"\");\n  const [minStock, setMinStock] = useState(10);\n  const [quantity, setQuantity] = useState(50);\n  const [marginPercent, setMarginPercent] = useState(50);\n  const [freeShippingOnly, setFreeShippingOnly] = useState(false);\n\n  const [searching, setSearching] = useState(false);\n  const [products, setProducts] = useState<ProductResult[]>([]);\n  const [totalFound, setTotalFound] = useState(0);\n  const [error, setError] = useState<string | null>(null);\n\n  const [selectedProducts, setSelectedProducts] = useState<Set<string>>(new Set());\n  const [addingToQueue, setAddingToQueue] = useState(false);\n  const [queueSuccess, setQueueSuccess] = useState<string | null>(null);\n\n  useEffect(() => {\n    checkConnection();\n  }, []);\n\n  async function addToQueue() {\n    if (selectedProducts.size === 0) return;\n    \n    setAddingToQueue(true);\n    setError(null);\n    setQueueSuccess(null);\n    \n    try {\n      const selectedItems = products.filter(p => selectedProducts.has(p.id));\n      \n      const res = await fetch(\"/api/admin/cj/v2/queue\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          products: selectedItems,\n          batchName: `${keyword || \"CJ Products\"} - ${new Date().toLocaleDateString()}`,\n        }),\n      });\n      \n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      \n      setQueueSuccess(`Added ${data.addedCount} products to \"${data.batchName}\". Go to Review Queue to approve them.`);\n      setSelectedProducts(new Set());\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Failed to add to queue\");\n    } finally {\n      setAddingToQueue(false);\n    }\n  }\n\n  async function checkConnection() {\n    setLoadingConnection(true);\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/connection\");\n      const data = await res.json();\n      setConnectionStatus(data);\n    } catch (e) {\n      setConnectionStatus({\n        ok: false,\n        message: e instanceof Error ? e.message : \"Connection check failed\",\n      });\n    } finally {\n      setLoadingConnection(false);\n    }\n  }\n\n  async function loadCategories() {\n    setLoadingCategories(true);\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/categories\");\n      const data = await res.json();\n      if (data.ok) {\n        setCategories(data.flat || []);\n      }\n    } catch (e) {\n      console.error(\"Failed to load categories:\", e);\n    } finally {\n      setLoadingCategories(false);\n    }\n  }\n\n  async function searchProducts() {\n    setSearching(true);\n    setError(null);\n    setProducts([]);\n    setSelectedProducts(new Set());\n\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/search\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          keyword: keyword || undefined,\n          categoryId: selectedCategory || undefined,\n          minPrice: minPrice || undefined,\n          maxPrice: maxPrice || undefined,\n          minStock,\n          quantity,\n          marginPercent,\n          freeShippingOnly,\n          pageSize: Math.min(quantity, 100),\n        }),\n      });\n\n      const data = await res.json();\n      if (!data.ok) {\n        throw new Error(data.error || \"Search failed\");\n      }\n\n      setProducts(data.products || []);\n      setTotalFound(data.totalFound || 0);\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Search failed\");\n    } finally {\n      setSearching(false);\n    }\n  }\n\n  function toggleProduct(id: string) {\n    setSelectedProducts((prev) => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  }\n\n  function selectAll() {\n    setSelectedProducts(new Set(products.map((p) => p.id)));\n  }\n\n  function deselectAll() {\n    setSelectedProducts(new Set());\n  }\n\n  const selectedCount = selectedProducts.size;\n  const needsReviewCount = products.filter((p) => p.pricing.needsReview).length;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold\">CJ Product Import</h1>\n        <div className=\"flex items-center gap-3\">\n          <Link\n            href=\"/admin/cj/finder\"\n            className=\"text-sm text-blue-600 hover:underline\"\n          >\n            Old Finder\n          </Link>\n          <Link\n            href=\"/admin/cj\"\n            className=\"text-sm text-blue-600 hover:underline\"\n          >\n            CJ Dashboard\n          </Link>\n        </div>\n      </div>\n\n      {/* Connection Status */}\n      <div className=\"rounded-lg border bg-white p-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div\n              className={`h-3 w-3 rounded-full ${\n                loadingConnection\n                  ? \"bg-yellow-400 animate-pulse\"\n                  : connectionStatus?.ok\n                  ? \"bg-green-500\"\n                  : \"bg-red-500\"\n              }`}\n            />\n            <span className=\"font-medium\">CJ Dropshipping API</span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            {connectionStatus?.responseTime && (\n              <span className=\"text-sm text-gray-500\">\n                {connectionStatus.responseTime}ms\n              </span>\n            )}\n            <button\n              onClick={checkConnection}\n              disabled={loadingConnection}\n              className=\"rounded bg-gray-100 px-3 py-1 text-sm hover:bg-gray-200\"\n            >\n              Test Connection\n            </button>\n          </div>\n        </div>\n        {connectionStatus && (\n          <p\n            className={`mt-2 text-sm ${\n              connectionStatus.ok ? \"text-green-600\" : \"text-red-600\"\n            }`}\n          >\n            {connectionStatus.message}\n          </p>\n        )}\n      </div>\n\n      {/* Search Filters */}\n      <div className=\"rounded-lg border bg-white p-4 space-y-4\">\n        <h2 className=\"font-semibold text-lg\">Search Products</h2>\n\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Keyword\n            </label>\n            <input\n              type=\"text\"\n              value={keyword}\n              onChange={(e) => setKeyword(e.target.value)}\n              placeholder=\"e.g., women blouse, men shirt\"\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Category\n            </label>\n            <div className=\"flex gap-2\">\n              <select\n                value={selectedCategory}\n                onChange={(e) => setSelectedCategory(e.target.value)}\n                className=\"flex-1 rounded border px-3 py-2\"\n              >\n                <option value=\"\">All Categories</option>\n                {categories.map((cat) => (\n                  <option key={cat.id} value={cat.id}>\n                    {cat.fullPath}\n                  </option>\n                ))}\n              </select>\n              {categories.length === 0 && (\n                <button\n                  onClick={loadCategories}\n                  disabled={loadingCategories}\n                  className=\"rounded bg-blue-600 px-3 py-2 text-white text-sm hover:bg-blue-700\"\n                >\n                  {loadingCategories ? \"...\" : \"Load\"}\n                </button>\n              )}\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Quantity to Find\n            </label>\n            <input\n              type=\"number\"\n              value={quantity}\n              onChange={(e) =>\n                setQuantity(Math.max(1, parseInt(e.target.value) || 1))\n              }\n              min={1}\n              max={500}\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Min Price (USD)\n            </label>\n            <input\n              type=\"number\"\n              value={minPrice}\n              onChange={(e) =>\n                setMinPrice(e.target.value ? parseFloat(e.target.value) : \"\")\n              }\n              placeholder=\"0\"\n              min={0}\n              step={0.01}\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Max Price (USD)\n            </label>\n            <input\n              type=\"number\"\n              value={maxPrice}\n              onChange={(e) =>\n                setMaxPrice(e.target.value ? parseFloat(e.target.value) : \"\")\n              }\n              placeholder=\"100\"\n              min={0}\n              step={0.01}\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Min Stock\n            </label>\n            <input\n              type=\"number\"\n              value={minStock}\n              onChange={(e) =>\n                setMinStock(Math.max(0, parseInt(e.target.value) || 0))\n              }\n              min={0}\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n              Profit Margin %\n            </label>\n            <input\n              type=\"number\"\n              value={marginPercent}\n              onChange={(e) =>\n                setMarginPercent(Math.max(0, parseInt(e.target.value) || 0))\n              }\n              min={0}\n              max={200}\n              className=\"w-full rounded border px-3 py-2\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <label className=\"flex items-center gap-2 cursor-pointer\">\n              <input\n                type=\"checkbox\"\n                checked={freeShippingOnly}\n                onChange={(e) => setFreeShippingOnly(e.target.checked)}\n                className=\"rounded\"\n              />\n              <span className=\"text-sm\">Free Shipping Only</span>\n            </label>\n          </div>\n        </div>\n\n        <div className=\"flex items-center gap-3 pt-2\">\n          <button\n            onClick={searchProducts}\n            disabled={searching || !connectionStatus?.ok}\n            className=\"rounded bg-blue-600 px-4 py-2 text-white font-medium hover:bg-blue-700 disabled:opacity-50\"\n          >\n            {searching ? \"Searching...\" : \"Search Products\"}\n          </button>\n          <Link\n            href=\"/admin/cj/queue\"\n            className=\"rounded border border-gray-300 px-4 py-2 text-gray-700 font-medium hover:bg-gray-50\"\n          >\n            Review Queue\n          </Link>\n          {error && <span className=\"text-red-600 text-sm\">{error}</span>}\n        </div>\n        \n        {queueSuccess && (\n          <div className=\"rounded-lg border border-green-300 bg-green-50 p-3 text-green-800 text-sm flex items-center justify-between\">\n            <span>{queueSuccess}</span>\n            <div className=\"flex items-center gap-2\">\n              <Link href=\"/admin/cj/queue\" className=\"text-green-700 underline font-medium\">\n                Go to Queue\n              </Link>\n              <button onClick={() => setQueueSuccess(null)} className=\"text-green-600 hover:text-green-800\">\n                Dismiss\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Results */}\n      {products.length > 0 && (\n        <div className=\"rounded-lg border bg-white p-4 space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h2 className=\"font-semibold text-lg\">\n                Results ({products.length} of {totalFound} found)\n              </h2>\n              {needsReviewCount > 0 && (\n                <p className=\"text-sm text-amber-600\">\n                  {needsReviewCount} products need pricing review\n                </p>\n              )}\n            </div>\n            <div className=\"flex items-center gap-3\">\n              <span className=\"text-sm text-gray-600\">\n                {selectedCount} selected\n              </span>\n              <button\n                onClick={selectAll}\n                className=\"rounded bg-gray-100 px-3 py-1 text-sm hover:bg-gray-200\"\n              >\n                Select All\n              </button>\n              <button\n                onClick={deselectAll}\n                className=\"rounded bg-gray-100 px-3 py-1 text-sm hover:bg-gray-200\"\n              >\n                Deselect All\n              </button>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {products.map((product) => (\n              <div\n                key={product.id}\n                className={`rounded-lg border p-3 cursor-pointer transition-colors ${\n                  selectedProducts.has(product.id)\n                    ? \"border-blue-500 bg-blue-50\"\n                    : \"border-gray-200 hover:border-gray-300\"\n                } ${product.pricing.needsReview ? \"ring-2 ring-amber-300\" : \"\"}`}\n                onClick={() => toggleProduct(product.id)}\n              >\n                {product.bigImage && (\n                  <img\n                    src={product.bigImage}\n                    alt={product.nameEn}\n                    className=\"w-full h-40 object-cover rounded mb-3\"\n                  />\n                )}\n                <h3 className=\"font-medium text-sm line-clamp-2 mb-2\">\n                  {product.nameEn}\n                </h3>\n\n                <div className=\"space-y-1 text-xs text-gray-600\">\n                  <div className=\"flex justify-between\">\n                    <span>CJ Price:</span>\n                    <span className=\"font-medium\">\n                      ${parseFloat(product.discountPrice || product.sellPrice).toFixed(2)}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Shipping to KSA:</span>\n                    <span>${product.shippingUSD.toFixed(2)} ({product.shippingDays} days)</span>\n                  </div>\n                  <div className=\"flex justify-between text-green-600 font-medium\">\n                    <span>Final Price:</span>\n                    <span>SAR {product.pricing.roundedPriceSAR}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Profit:</span>\n                    <span>SAR {product.pricing.profitSAR.toFixed(2)} ({product.pricing.actualMarginPercent.toFixed(0)}%)</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>Stock:</span>\n                    <span>{product.warehouseInventoryNum}</span>\n                  </div>\n                </div>\n\n                {product.pricing.needsReview && (\n                  <div className=\"mt-2 rounded bg-amber-100 px-2 py-1 text-xs text-amber-800\">\n                    {product.pricing.reviewReason}\n                  </div>\n                )}\n\n                <div className=\"mt-2 text-xs text-gray-500\">\n                  SKU: {product.sku}\n                </div>\n              </div>\n            ))}\n          </div>\n\n          {selectedCount > 0 && (\n            <div className=\"flex items-center justify-between pt-4 border-t\">\n              <div className=\"text-sm\">\n                <strong>{selectedCount}</strong> products selected for import\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <button\n                  className=\"rounded bg-green-600 px-4 py-2 text-white font-medium hover:bg-green-700 disabled:opacity-50\"\n                  disabled={addingToQueue}\n                  onClick={addToQueue}\n                >\n                  {addingToQueue ? \"Adding...\" : \"Add to Import Queue\"}\n                </button>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Pricing Info */}\n      <div className=\"rounded-lg border bg-gray-50 p-4\">\n        <h3 className=\"font-medium mb-2\">KSA Pricing Formula</h3>\n        <div className=\"text-sm text-gray-600 space-y-1\">\n          <p>Base Cost = CJ Product Price + Shipping to Saudi Arabia</p>\n          <p>+ VAT (15%)</p>\n          <p>+ Payment Gateway Fee (2.9%)</p>\n          <p>+ Your Profit Margin ({marginPercent}%)</p>\n          <p className=\"font-medium text-gray-800\">\n            = Final Price (rounded to 49/79/99/149/199/249/299 SAR)\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":18998,"size_tokens":null},"src/lib/cj/ksa-pricing.ts":{"content":"const VAT_RATE = 0.15;\nconst PAYMENT_FEE_RATE = 0.029;\nconst DEFAULT_USD_TO_SAR_RATE = 3.75;\n\nfunction getUsdToSarRate(): number {\n  const envRate = process.env.USD_TO_SAR_RATE;\n  if (envRate) {\n    const rate = parseFloat(envRate);\n    if (!isNaN(rate) && rate > 0) return rate;\n  }\n  return DEFAULT_USD_TO_SAR_RATE;\n}\n\nconst SMART_ROUND_VALUES = [\n  19, 29, 39, 49, 59, 69, 79, 89, 99,\n  109, 119, 129, 139, 149, 159, 169, 179, 189, 199,\n  219, 229, 249, 269, 279, 299,\n  319, 349, 379, 399,\n  449, 499, 549, 599, 649, 699, 749, 799, 849, 899, 949, 999,\n  1099, 1199, 1299, 1399, 1499, 1699, 1799, 1999\n];\n\nexport interface PricingRule {\n  categorySlug?: string;\n  marginPercent: number;\n  minProfitSAR: number;\n  maxPriceSAR?: number;\n}\n\nexport interface PricingInput {\n  cjPriceUSD: number;\n  shippingUSD: number;\n  marginPercent?: number;\n  minProfitSAR?: number;\n  categorySlug?: string;\n}\n\nexport interface PricingResult {\n  baseCostUSD: number;\n  baseCostSAR: number;\n  vatSAR: number;\n  paymentFeeSAR: number;\n  profitSAR: number;\n  finalPriceSAR: number;\n  roundedPriceSAR: number;\n  actualMarginPercent: number;\n  breakdown: {\n    cjPriceUSD: number;\n    shippingUSD: number;\n    totalCostUSD: number;\n    totalCostSAR: number;\n    vatAmount: number;\n    paymentFeeAmount: number;\n    profitAmount: number;\n    rawTotal: number;\n    roundedTotal: number;\n  };\n  needsReview: boolean;\n  reviewReason?: string;\n}\n\nconst DEFAULT_MARGINS: Record<string, PricingRule> = {\n  clothing: { marginPercent: 50, minProfitSAR: 25 },\n  shoes: { marginPercent: 55, minProfitSAR: 30 },\n  electronics: { marginPercent: 40, minProfitSAR: 35 },\n  home: { marginPercent: 60, minProfitSAR: 20 },\n  kitchen: { marginPercent: 55, minProfitSAR: 20 },\n  beauty: { marginPercent: 65, minProfitSAR: 15 },\n  jewelry: { marginPercent: 70, minProfitSAR: 20 },\n  bags: { marginPercent: 55, minProfitSAR: 25 },\n  watches: { marginPercent: 60, minProfitSAR: 35 },\n  default: { marginPercent: 50, minProfitSAR: 25 },\n};\n\nfunction smartRound(price: number): number {\n  if (price <= 0) return 29;\n  \n  for (const roundValue of SMART_ROUND_VALUES) {\n    if (price <= roundValue) {\n      return roundValue;\n    }\n  }\n  \n  return Math.ceil(price / 100) * 100 - 1;\n}\n\nexport function getMarginRule(categorySlug?: string): PricingRule {\n  if (!categorySlug) return DEFAULT_MARGINS.default;\n  \n  const normalized = categorySlug.toLowerCase().trim();\n  \n  for (const [key, rule] of Object.entries(DEFAULT_MARGINS)) {\n    if (normalized.includes(key)) {\n      return rule;\n    }\n  }\n  \n  return DEFAULT_MARGINS.default;\n}\n\nexport function calculateKSAPrice(input: PricingInput): PricingResult {\n  const rule = getMarginRule(input.categorySlug);\n  const marginPercent = input.marginPercent ?? rule.marginPercent;\n  const minProfitSAR = input.minProfitSAR ?? rule.minProfitSAR;\n  const usdToSar = getUsdToSarRate();\n\n  const totalCostUSD = input.cjPriceUSD + input.shippingUSD;\n  const totalCostSAR = totalCostUSD * usdToSar;\n\n  const costWithVAT = totalCostSAR * (1 + VAT_RATE);\n  const marginMultiplier = 1 + marginPercent / 100;\n  const priceBeforePaymentFee = costWithVAT * marginMultiplier;\n  const priceWithPaymentFee = priceBeforePaymentFee / (1 - PAYMENT_FEE_RATE);\n  \n  const vatAmount = totalCostSAR * VAT_RATE;\n  const paymentFeeAmount = priceWithPaymentFee * PAYMENT_FEE_RATE;\n  const rawTotal = priceWithPaymentFee;\n  const profitAmount = rawTotal - totalCostSAR - vatAmount - paymentFeeAmount;\n\n  let finalPrice = rawTotal;\n  let needsReview = false;\n  let reviewReason: string | undefined;\n\n  if (profitAmount < minProfitSAR) {\n    const requiredPrice = (totalCostSAR + vatAmount + minProfitSAR) / (1 - PAYMENT_FEE_RATE);\n    finalPrice = requiredPrice;\n    needsReview = true;\n    reviewReason = `Profit (${profitAmount.toFixed(2)} SAR) below minimum (${minProfitSAR} SAR). Price adjusted.`;\n  }\n\n  if (rule.maxPriceSAR && finalPrice > rule.maxPriceSAR) {\n    needsReview = true;\n    reviewReason = `Price (${finalPrice.toFixed(2)} SAR) exceeds category maximum (${rule.maxPriceSAR} SAR)`;\n  }\n\n  const roundedPrice = smartRound(finalPrice);\n  const actualPaymentFee = roundedPrice * PAYMENT_FEE_RATE;\n  const actualProfit = roundedPrice - totalCostSAR - vatAmount - actualPaymentFee;\n  const actualMargin = totalCostSAR > 0 ? (actualProfit / totalCostSAR) * 100 : 0;\n\n  return {\n    baseCostUSD: totalCostUSD,\n    baseCostSAR: totalCostSAR,\n    vatSAR: vatAmount,\n    paymentFeeSAR: paymentFeeAmount,\n    profitSAR: actualProfit,\n    finalPriceSAR: finalPrice,\n    roundedPriceSAR: roundedPrice,\n    actualMarginPercent: actualMargin,\n    breakdown: {\n      cjPriceUSD: input.cjPriceUSD,\n      shippingUSD: input.shippingUSD,\n      totalCostUSD,\n      totalCostSAR,\n      vatAmount,\n      paymentFeeAmount,\n      profitAmount: actualProfit,\n      rawTotal,\n      roundedTotal: roundedPrice,\n    },\n    needsReview,\n    reviewReason,\n  };\n}\n\nexport function calculateBulkPricing(\n  products: Array<{\n    id: string;\n    cjPriceUSD: number;\n    shippingUSD: number;\n    categorySlug?: string;\n  }>,\n  globalMarginPercent?: number,\n  globalMinProfitSAR?: number\n): Map<string, PricingResult> {\n  const results = new Map<string, PricingResult>();\n\n  for (const product of products) {\n    const result = calculateKSAPrice({\n      cjPriceUSD: product.cjPriceUSD,\n      shippingUSD: product.shippingUSD,\n      categorySlug: product.categorySlug,\n      marginPercent: globalMarginPercent,\n      minProfitSAR: globalMinProfitSAR,\n    });\n    results.set(product.id, result);\n  }\n\n  return results;\n}\n\nexport function formatPriceSAR(price: number): string {\n  return `${price.toFixed(2)} ر.س`;\n}\n\nexport function formatPriceDisplay(price: number): string {\n  return `SAR ${price.toFixed(0)}`;\n}\n\nexport { DEFAULT_USD_TO_SAR_RATE, VAT_RATE, PAYMENT_FEE_RATE, SMART_ROUND_VALUES, getUsdToSarRate };\n","path":null,"size_bytes":5871,"size_tokens":null},"src/app/admin/cj/queue/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\n\nexport const dynamic = \"force-dynamic\";\n\ntype QueuedProduct = {\n  id: number;\n  batch_id: string;\n  cj_product_id: string;\n  cj_sku: string;\n  name_en: string;\n  image_url: string;\n  cj_price_usd: number;\n  shipping_usd: number;\n  shipping_days: string;\n  final_price_sar: number;\n  profit_sar: number;\n  margin_percent: number;\n  stock: number;\n  category_path: string;\n  status: \"pending\" | \"approved\" | \"rejected\" | \"imported\" | \"skipped\";\n  created_at: string;\n};\n\ntype Batch = {\n  id: string;\n  name: string;\n  total_products: number;\n  status: string;\n  created_at: string;\n};\n\ntype QueueStats = {\n  pending: number;\n  approved: number;\n  rejected: number;\n  imported: number;\n  skipped: number;\n  total: number;\n};\n\nexport default function CJQueuePage() {\n  const [products, setProducts] = useState<QueuedProduct[]>([]);\n  const [batches, setBatches] = useState<Batch[]>([]);\n  const [stats, setStats] = useState<QueueStats>({ pending: 0, approved: 0, rejected: 0, imported: 0, skipped: 0, total: 0 });\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  \n  const [selectedProducts, setSelectedProducts] = useState<Set<number>>(new Set());\n  const [filterStatus, setFilterStatus] = useState<\"all\" | \"pending\" | \"approved\" | \"rejected\" | \"skipped\">(\"all\");\n  const [filterBatch, setFilterBatch] = useState<string>(\"\");\n  const [actionLoading, setActionLoading] = useState(false);\n\n  const [editingProduct, setEditingProduct] = useState<QueuedProduct | null>(null);\n  const [editPrice, setEditPrice] = useState<number>(0);\n  \n  const [importing, setImporting] = useState(false);\n  const [importResult, setImportResult] = useState<{\n    message: string;\n    stats?: { total: number; success: number; duplicates: number; errors: number };\n  } | null>(null);\n\n  const loadQueue = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/queue\");\n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      setProducts(data.products || []);\n      setBatches(data.batches || []);\n      setStats(data.stats || { pending: 0, approved: 0, total: 0 });\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Failed to load queue\");\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    loadQueue();\n  }, [loadQueue]);\n\n  const filteredProducts = products.filter(p => {\n    if (filterStatus !== \"all\" && p.status !== filterStatus) return false;\n    if (filterBatch && p.batch_id !== filterBatch) return false;\n    return true;\n  });\n\n  function toggleProduct(id: number) {\n    setSelectedProducts(prev => {\n      const next = new Set(prev);\n      if (next.has(id)) next.delete(id);\n      else next.add(id);\n      return next;\n    });\n  }\n\n  function selectAllVisible() {\n    setSelectedProducts(new Set(filteredProducts.map(p => p.id)));\n  }\n\n  function deselectAll() {\n    setSelectedProducts(new Set());\n  }\n\n  async function handleBulkAction(action: \"approve\" | \"reject\" | \"restore\") {\n    if (selectedProducts.size === 0) return;\n    \n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/queue\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          productIds: Array.from(selectedProducts),\n          action,\n        }),\n      });\n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      \n      setSelectedProducts(new Set());\n      await loadQueue();\n    } catch (e) {\n      setError(e instanceof Error ? e.message : `Failed to ${action} products`);\n    } finally {\n      setActionLoading(false);\n    }\n  }\n\n  async function handleDelete() {\n    if (selectedProducts.size === 0) return;\n    if (!confirm(`Delete ${selectedProducts.size} products from queue?`)) return;\n    \n    setActionLoading(true);\n    try {\n      const ids = Array.from(selectedProducts).join(\",\");\n      const res = await fetch(`/api/admin/cj/v2/queue?ids=${ids}`, {\n        method: \"DELETE\",\n      });\n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      \n      setSelectedProducts(new Set());\n      await loadQueue();\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Failed to delete products\");\n    } finally {\n      setActionLoading(false);\n    }\n  }\n\n  async function handlePriceUpdate() {\n    if (!editingProduct) return;\n    if (!editPrice || editPrice <= 0) {\n      setError(\"Price must be a positive number\");\n      return;\n    }\n    \n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/cj/v2/queue\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          productIds: [editingProduct.id],\n          action: \"update_price\",\n          newPriceSAR: editPrice,\n        }),\n      });\n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      \n      setEditingProduct(null);\n      await loadQueue();\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Failed to update price\");\n    } finally {\n      setActionLoading(false);\n    }\n  }\n\n  async function handleImportAll() {\n    if (approvedProducts.length === 0) return;\n    if (!confirm(`Import ${approvedProducts.length} products to your store? This will create products that are visible to customers.`)) return;\n    \n    setImporting(true);\n    setImportResult(null);\n    setError(null);\n    \n    try {\n      const res = await fetch(\"/api/admin/cj/v2/import\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ importAll: true }),\n      });\n      \n      const data = await res.json();\n      if (!data.ok) throw new Error(data.error);\n      \n      setImportResult({\n        message: data.message,\n        stats: data.stats,\n      });\n      await loadQueue();\n    } catch (e) {\n      setError(e instanceof Error ? e.message : \"Import failed\");\n    } finally {\n      setImporting(false);\n    }\n  }\n\n  const selectedCount = selectedProducts.size;\n  const pendingProducts = filteredProducts.filter(p => p.status === \"pending\");\n  const approvedProducts = filteredProducts.filter(p => p.status === \"approved\");\n  const rejectedProducts = filteredProducts.filter(p => p.status === \"rejected\");\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\">Review Queue</h1>\n          <p className=\"text-gray-600 text-sm mt-1\">\n            Review and approve products before importing to your store\n          </p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <Link\n            href=\"/admin/cj/import\"\n            className=\"text-sm text-blue-600 hover:underline\"\n          >\n            Search Products\n          </Link>\n          <Link\n            href=\"/admin/cj\"\n            className=\"text-sm text-blue-600 hover:underline\"\n          >\n            CJ Dashboard\n          </Link>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg border border-red-300 bg-red-50 p-4 text-red-800\">\n          {error}\n          <button onClick={() => setError(null)} className=\"ml-2 text-red-600 underline\">\n            Dismiss\n          </button>\n        </div>\n      )}\n\n      {importResult && (\n        <div className=\"rounded-lg border border-green-300 bg-green-50 p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"font-medium text-green-800\">{importResult.message}</p>\n              {importResult.stats && (\n                <div className=\"flex gap-4 mt-2 text-sm text-green-700\">\n                  <span>Imported: {importResult.stats.success}</span>\n                  <span>Duplicates: {importResult.stats.duplicates}</span>\n                  <span>Errors: {importResult.stats.errors}</span>\n                </div>\n              )}\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <Link href=\"/admin/products\" className=\"text-green-700 underline text-sm\">\n                View Products\n              </Link>\n              <button onClick={() => setImportResult(null)} className=\"text-green-600 hover:text-green-800\">\n                Dismiss\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n        <div className=\"rounded-lg border bg-white p-4\">\n          <div className=\"text-3xl font-bold text-amber-600\">{stats.pending}</div>\n          <div className=\"text-sm text-gray-600\">Pending Review</div>\n        </div>\n        <div className=\"rounded-lg border bg-white p-4\">\n          <div className=\"text-3xl font-bold text-green-600\">{stats.approved}</div>\n          <div className=\"text-sm text-gray-600\">Ready to Import</div>\n        </div>\n        <div className=\"rounded-lg border bg-white p-4\">\n          <div className=\"text-3xl font-bold text-blue-600\">{stats.skipped}</div>\n          <div className=\"text-sm text-gray-600\">Skipped (Duplicates)</div>\n        </div>\n        <div className=\"rounded-lg border bg-white p-4\">\n          <div className=\"text-3xl font-bold text-red-600\">{stats.rejected}</div>\n          <div className=\"text-sm text-gray-600\">Rejected</div>\n        </div>\n        <div className=\"rounded-lg border bg-white p-4\">\n          <div className=\"text-3xl font-bold text-gray-600\">{stats.total}</div>\n          <div className=\"text-sm text-gray-600\">Total in Queue</div>\n        </div>\n      </div>\n\n      <div className=\"rounded-lg border bg-white p-4 space-y-4\">\n        <div className=\"flex flex-wrap items-center gap-4\">\n          <div>\n            <label className=\"block text-xs text-gray-500 mb-1\">Status</label>\n            <select\n              value={filterStatus}\n              onChange={(e) => setFilterStatus(e.target.value as \"all\" | \"pending\" | \"approved\" | \"rejected\" | \"skipped\")}\n              className=\"rounded border px-3 py-2 text-sm\"\n            >\n              <option value=\"all\">All ({products.length})</option>\n              <option value=\"pending\">Pending ({stats.pending})</option>\n              <option value=\"approved\">Approved ({stats.approved})</option>\n              <option value=\"skipped\">Skipped ({stats.skipped})</option>\n              <option value=\"rejected\">Rejected ({stats.rejected})</option>\n            </select>\n          </div>\n\n          <div>\n            <label className=\"block text-xs text-gray-500 mb-1\">Batch</label>\n            <select\n              value={filterBatch}\n              onChange={(e) => setFilterBatch(e.target.value)}\n              className=\"rounded border px-3 py-2 text-sm\"\n            >\n              <option value=\"\">All Batches</option>\n              {batches.map((batch) => (\n                <option key={batch.id} value={batch.id}>\n                  {batch.name} ({batch.total_products})\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div className=\"flex-1\" />\n\n          <div className=\"flex items-center gap-2\">\n            <span className=\"text-sm text-gray-600\">{selectedCount} selected</span>\n            <button\n              onClick={selectAllVisible}\n              className=\"rounded bg-gray-100 px-3 py-2 text-sm hover:bg-gray-200\"\n            >\n              Select All\n            </button>\n            <button\n              onClick={deselectAll}\n              className=\"rounded bg-gray-100 px-3 py-2 text-sm hover:bg-gray-200\"\n            >\n              Deselect\n            </button>\n          </div>\n        </div>\n\n        {selectedCount > 0 && (\n          <div className=\"flex items-center gap-3 p-3 bg-blue-50 rounded-lg\">\n            <span className=\"text-sm font-medium\">{selectedCount} products selected</span>\n            <div className=\"flex-1\" />\n            <button\n              onClick={() => handleBulkAction(\"approve\")}\n              disabled={actionLoading}\n              className=\"rounded bg-green-600 px-4 py-2 text-white text-sm font-medium hover:bg-green-700 disabled:opacity-50\"\n            >\n              Approve\n            </button>\n            <button\n              onClick={() => handleBulkAction(\"reject\")}\n              disabled={actionLoading}\n              className=\"rounded bg-amber-600 px-4 py-2 text-white text-sm font-medium hover:bg-amber-700 disabled:opacity-50\"\n            >\n              Reject\n            </button>\n            <button\n              onClick={() => handleBulkAction(\"restore\")}\n              disabled={actionLoading}\n              className=\"rounded bg-blue-600 px-4 py-2 text-white text-sm font-medium hover:bg-blue-700 disabled:opacity-50\"\n            >\n              Restore to Pending\n            </button>\n            <button\n              onClick={handleDelete}\n              disabled={actionLoading}\n              className=\"rounded bg-red-600 px-4 py-2 text-white text-sm font-medium hover:bg-red-700 disabled:opacity-50\"\n            >\n              Delete\n            </button>\n          </div>\n        )}\n      </div>\n\n      {loading ? (\n        <div className=\"rounded-lg border bg-white p-8 text-center text-gray-500\">\n          Loading queue...\n        </div>\n      ) : filteredProducts.length === 0 ? (\n        <div className=\"rounded-lg border bg-white p-8 text-center\">\n          <p className=\"text-gray-500 mb-4\">No products in queue</p>\n          <Link\n            href=\"/admin/cj/import\"\n            className=\"inline-block rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700\"\n          >\n            Search & Add Products\n          </Link>\n        </div>\n      ) : (\n        <div className=\"space-y-4\">\n          {pendingProducts.length > 0 && filterStatus !== \"approved\" && (\n            <div className=\"rounded-lg border bg-white p-4\">\n              <h2 className=\"font-semibold text-lg mb-4 text-amber-700\">\n                Pending Review ({pendingProducts.length})\n              </h2>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n                {pendingProducts.map((product) => (\n                  <ProductCard\n                    key={product.id}\n                    product={product}\n                    selected={selectedProducts.has(product.id)}\n                    onToggle={() => toggleProduct(product.id)}\n                    onEdit={() => {\n                      setEditingProduct(product);\n                      setEditPrice(product.final_price_sar);\n                    }}\n                    onApprove={async () => {\n                      setActionLoading(true);\n                      try {\n                        await fetch(\"/api/admin/cj/v2/queue\", {\n                          method: \"PATCH\",\n                          headers: { \"Content-Type\": \"application/json\" },\n                          body: JSON.stringify({\n                            productIds: [product.id],\n                            action: \"approve\",\n                          }),\n                        });\n                        await loadQueue();\n                      } finally {\n                        setActionLoading(false);\n                      }\n                    }}\n                    onReject={async () => {\n                      setActionLoading(true);\n                      try {\n                        await fetch(\"/api/admin/cj/v2/queue\", {\n                          method: \"PATCH\",\n                          headers: { \"Content-Type\": \"application/json\" },\n                          body: JSON.stringify({\n                            productIds: [product.id],\n                            action: \"reject\",\n                          }),\n                        });\n                        await loadQueue();\n                      } finally {\n                        setActionLoading(false);\n                      }\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {approvedProducts.length > 0 && filterStatus !== \"pending\" && filterStatus !== \"rejected\" && (\n            <div className=\"rounded-lg border bg-white p-4\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h2 className=\"font-semibold text-lg text-green-700\">\n                  Ready to Import ({approvedProducts.length})\n                </h2>\n                <button\n                  onClick={handleImportAll}\n                  disabled={actionLoading || importing}\n                  className=\"rounded bg-green-600 px-4 py-2 text-white font-medium hover:bg-green-700 disabled:opacity-50\"\n                >\n                  {importing ? \"Importing...\" : \"Import All Approved\"}\n                </button>\n              </div>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n                {approvedProducts.map((product) => (\n                  <ProductCard\n                    key={product.id}\n                    product={product}\n                    selected={selectedProducts.has(product.id)}\n                    onToggle={() => toggleProduct(product.id)}\n                    onEdit={() => {\n                      setEditingProduct(product);\n                      setEditPrice(product.final_price_sar);\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n\n          {rejectedProducts.length > 0 && (filterStatus === \"all\" || filterStatus === \"rejected\") && (\n            <div className=\"rounded-lg border bg-white p-4\">\n              <h2 className=\"font-semibold text-lg text-red-700 mb-4\">\n                Rejected ({rejectedProducts.length})\n              </h2>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n                {rejectedProducts.map((product) => (\n                  <ProductCard\n                    key={product.id}\n                    product={product}\n                    selected={selectedProducts.has(product.id)}\n                    onToggle={() => toggleProduct(product.id)}\n                    onEdit={() => {\n                      setEditingProduct(product);\n                      setEditPrice(product.final_price_sar);\n                    }}\n                    onRestore={async () => {\n                      setActionLoading(true);\n                      try {\n                        await fetch(\"/api/admin/cj/v2/queue\", {\n                          method: \"PATCH\",\n                          headers: { \"Content-Type\": \"application/json\" },\n                          body: JSON.stringify({\n                            productIds: [product.id],\n                            action: \"restore\",\n                          }),\n                        });\n                        await loadQueue();\n                      } finally {\n                        setActionLoading(false);\n                      }\n                    }}\n                  />\n                ))}\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {editingProduct && (\n        <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50\">\n          <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n            <h3 className=\"font-semibold text-lg mb-4\">Edit Price</h3>\n            <div className=\"space-y-4\">\n              <div>\n                <label className=\"block text-sm text-gray-600 mb-1\">Product</label>\n                <p className=\"text-sm font-medium line-clamp-2\">{editingProduct.name_en}</p>\n              </div>\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <span className=\"text-gray-500\">CJ Price:</span>\n                  <span className=\"ml-2 font-medium\">${editingProduct.cj_price_usd.toFixed(2)}</span>\n                </div>\n                <div>\n                  <span className=\"text-gray-500\">Shipping:</span>\n                  <span className=\"ml-2 font-medium\">${editingProduct.shipping_usd.toFixed(2)}</span>\n                </div>\n              </div>\n              <div>\n                <label className=\"block text-sm text-gray-600 mb-1\">Final Price (SAR)</label>\n                <input\n                  type=\"number\"\n                  value={editPrice}\n                  onChange={(e) => setEditPrice(parseFloat(e.target.value) || 0)}\n                  className=\"w-full rounded border px-3 py-2\"\n                  min={0}\n                  step={1}\n                />\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  Current: SAR {editingProduct.final_price_sar} | \n                  Profit: SAR {editingProduct.profit_sar.toFixed(2)} ({editingProduct.margin_percent.toFixed(0)}%)\n                </p>\n              </div>\n              <div className=\"flex gap-3 pt-2\">\n                <button\n                  onClick={() => setEditingProduct(null)}\n                  className=\"flex-1 rounded border px-4 py-2 hover:bg-gray-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={handlePriceUpdate}\n                  disabled={actionLoading}\n                  className=\"flex-1 rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 disabled:opacity-50\"\n                >\n                  Save\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction ProductCard({\n  product,\n  selected,\n  onToggle,\n  onEdit,\n  onApprove,\n  onReject,\n  onRestore,\n}: {\n  product: QueuedProduct;\n  selected: boolean;\n  onToggle: () => void;\n  onEdit: () => void;\n  onApprove?: () => void;\n  onReject?: () => void;\n  onRestore?: () => void;\n}) {\n  const isPending = product.status === \"pending\";\n  const isRejected = product.status === \"rejected\";\n  \n  return (\n    <div\n      className={`rounded-lg border p-3 transition-colors ${\n        selected\n          ? \"border-blue-500 bg-blue-50\"\n          : isPending\n          ? \"border-amber-200 bg-amber-50/30\"\n          : isRejected\n          ? \"border-red-200 bg-red-50/30\"\n          : \"border-green-200 bg-green-50/30\"\n      }`}\n    >\n      <div className=\"flex items-start gap-2 mb-2\">\n        <input\n          type=\"checkbox\"\n          checked={selected}\n          onChange={onToggle}\n          className=\"mt-1 rounded\"\n        />\n        {product.image_url && (\n          <img\n            src={product.image_url}\n            alt={product.name_en}\n            className=\"w-16 h-16 object-cover rounded flex-shrink-0\"\n          />\n        )}\n        <div className=\"flex-1 min-w-0\">\n          <h3 className=\"font-medium text-xs line-clamp-2\">{product.name_en}</h3>\n          <p className=\"text-xs text-gray-500 mt-1\">{product.cj_sku}</p>\n        </div>\n      </div>\n\n      <div className=\"space-y-1 text-xs\">\n        <div className=\"flex justify-between\">\n          <span className=\"text-gray-500\">CJ Cost:</span>\n          <span>${product.cj_price_usd.toFixed(2)} + ${product.shipping_usd.toFixed(2)}</span>\n        </div>\n        <div className=\"flex justify-between font-medium text-green-700\">\n          <span>Sale Price:</span>\n          <span>SAR {product.final_price_sar}</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span className=\"text-gray-500\">Profit:</span>\n          <span>SAR {product.profit_sar.toFixed(2)} ({product.margin_percent.toFixed(0)}%)</span>\n        </div>\n        <div className=\"flex justify-between\">\n          <span className=\"text-gray-500\">Stock:</span>\n          <span>{product.stock}</span>\n        </div>\n      </div>\n\n      <div className=\"flex gap-2 mt-3\">\n        <button\n          onClick={onEdit}\n          className=\"flex-1 rounded border px-2 py-1 text-xs hover:bg-gray-50\"\n        >\n          Edit Price\n        </button>\n        {isPending && onApprove && onReject && (\n          <>\n            <button\n              onClick={onApprove}\n              className=\"flex-1 rounded bg-green-600 px-2 py-1 text-xs text-white hover:bg-green-700\"\n            >\n              Approve\n            </button>\n            <button\n              onClick={onReject}\n              className=\"flex-1 rounded bg-red-100 px-2 py-1 text-xs text-red-700 hover:bg-red-200\"\n            >\n              Reject\n            </button>\n          </>\n        )}\n        {isRejected && onRestore && (\n          <button\n            onClick={onRestore}\n            className=\"flex-1 rounded bg-blue-600 px-2 py-1 text-xs text-white hover:bg-blue-700\"\n          >\n            Restore\n          </button>\n        )}\n      </div>\n\n      {product.category_path && (\n        <p className=\"text-xs text-gray-400 mt-2 truncate\">{product.category_path}</p>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":25039,"size_tokens":null},"src/lib/cj/product-discovery.ts":{"content":"import { getAccessToken } from './v2';\n\nconst CJ_API_BASE = 'https://developers.cjdropshipping.com/api2.0/v1';\n\nexport interface ProductSearchFilters {\n  keyword?: string;\n  categoryId?: string;\n  minPrice?: number;\n  maxPrice?: number;\n  minStock?: number;\n  countryCode?: string;\n  freeShippingOnly?: boolean;\n  sortBy?: 'best_match' | 'listing_count' | 'price' | 'newest' | 'stock';\n  sortDirection?: 'asc' | 'desc';\n  page?: number;\n  pageSize?: number;\n  includeDescription?: boolean;\n  includeCategory?: boolean;\n}\n\nexport interface CJCategory {\n  categoryId: string;\n  categoryName: string;\n}\n\nexport interface CJCategoryGroup {\n  categoryFirstName: string;\n  categoryFirstList: {\n    categorySecondName: string;\n    categorySecondList: CJCategory[];\n  }[];\n}\n\nexport interface CJProductSearchResult {\n  id: string;\n  nameEn: string;\n  sku: string;\n  bigImage: string;\n  sellPrice: string;\n  nowPrice?: string;\n  discountPrice?: string;\n  listedNum: number;\n  categoryId: string;\n  threeCategoryName?: string;\n  twoCategoryName?: string;\n  oneCategoryName?: string;\n  addMarkStatus: number;\n  isVideo: number;\n  warehouseInventoryNum: number;\n  totalVerifiedInventory: number;\n  description?: string;\n  deliveryCycle?: string;\n  createAt?: number;\n}\n\nexport interface CJVariant {\n  vid: string;\n  pid: string;\n  variantNameEn: string;\n  variantSku: string;\n  variantKey: string;\n  variantWeight: number;\n  variantLength?: number;\n  variantWidth?: number;\n  variantHeight?: number;\n  variantSellPrice: number;\n  variantImage?: string;\n  variantStock?: number;\n}\n\nexport interface CJShippingOption {\n  logisticName: string;\n  logisticPrice: number;\n  logisticPriceCn?: number;\n  logisticAging: string;\n  taxesFee?: number;\n  clearanceOperationFee?: number;\n  totalPostageFee?: number;\n}\n\nasync function cjApiRequest<T>(\n  endpoint: string,\n  method: 'GET' | 'POST' = 'GET',\n  body?: Record<string, unknown>\n): Promise<T> {\n  const token = await getAccessToken();\n  const url = `${CJ_API_BASE}${endpoint}`;\n  \n  const headers: Record<string, string> = {\n    'Content-Type': 'application/json',\n    'CJ-Access-Token': token,\n  };\n\n  const options: RequestInit = {\n    method,\n    headers,\n    cache: 'no-store',\n  };\n\n  if (body && method === 'POST') {\n    options.body = JSON.stringify(body);\n  }\n\n  const response = await fetch(url, options);\n  \n  if (!response.ok) {\n    const text = await response.text();\n    throw new Error(`CJ API error ${response.status}: ${text}`);\n  }\n\n  const data = await response.json();\n  \n  if (data.code && data.code !== 200) {\n    throw new Error(`CJ API error ${data.code}: ${data.message || 'Unknown error'}`);\n  }\n  \n  if (data.result === false) {\n    throw new Error(`CJ API error: ${data.message || 'Request failed'}`);\n  }\n\n  return data;\n}\n\nfunction extractProductList(response: unknown): CJProductSearchResult[] {\n  if (!response || typeof response !== 'object') return [];\n  \n  const data = response as Record<string, unknown>;\n  \n  if (data.data && typeof data.data === 'object') {\n    const dataObj = data.data as Record<string, unknown>;\n    \n    if (Array.isArray(dataObj.content)) {\n      const allProducts: CJProductSearchResult[] = [];\n      for (const item of dataObj.content) {\n        if (item && typeof item === 'object') {\n          const itemObj = item as Record<string, unknown>;\n          if (Array.isArray(itemObj.productList)) {\n            allProducts.push(...(itemObj.productList as CJProductSearchResult[]));\n          }\n        }\n      }\n      return allProducts;\n    }\n    \n    if (Array.isArray(dataObj.list)) {\n      return dataObj.list as CJProductSearchResult[];\n    }\n    \n    if (Array.isArray(data.data)) {\n      return data.data as CJProductSearchResult[];\n    }\n  }\n  \n  if (Array.isArray(data.list)) {\n    return data.list as CJProductSearchResult[];\n  }\n  \n  return [];\n}\n\nexport async function getCategories(): Promise<CJCategoryGroup[]> {\n  const response = await cjApiRequest<{\n    code: number;\n    data: CJCategoryGroup[];\n  }>('/product/getCategory');\n  \n  return response.data || [];\n}\n\nexport async function searchProducts(\n  filters: ProductSearchFilters\n): Promise<{\n  products: CJProductSearchResult[];\n  totalRecords: number;\n  totalPages: number;\n  currentPage: number;\n}> {\n  const params = new URLSearchParams();\n  \n  if (filters.keyword) params.set('keyWord', filters.keyword);\n  if (filters.categoryId) params.set('categoryId', filters.categoryId);\n  if (filters.minPrice !== undefined) params.set('startSellPrice', String(filters.minPrice));\n  if (filters.maxPrice !== undefined) params.set('endSellPrice', String(filters.maxPrice));\n  if (filters.minStock !== undefined) params.set('startWarehouseInventory', String(filters.minStock));\n  if (filters.countryCode) params.set('countryCode', filters.countryCode);\n  if (filters.freeShippingOnly) params.set('addMarkStatus', '1');\n  \n  const sortMap: Record<string, number> = {\n    best_match: 0,\n    listing_count: 1,\n    price: 2,\n    newest: 3,\n    stock: 4,\n  };\n  params.set('orderBy', String(sortMap[filters.sortBy || 'best_match']));\n  params.set('sort', filters.sortDirection || 'desc');\n  \n  params.set('page', String(filters.page || 1));\n  params.set('size', String(Math.min(100, filters.pageSize || 20)));\n  \n  const features: string[] = ['enable_category'];\n  if (filters.includeDescription) features.push('enable_description');\n  params.set('features', features.join(','));\n\n  const response = await cjApiRequest<unknown>(`/product/listV2?${params.toString()}`);\n  const allProducts = extractProductList(response);\n  \n  const responseData = (response as Record<string, unknown>)?.data as Record<string, unknown> | undefined;\n\n  return {\n    products: allProducts,\n    totalRecords: (responseData?.totalRecords as number) || allProducts.length,\n    totalPages: (responseData?.totalPages as number) || 1,\n    currentPage: (responseData?.pageNumber as number) || 1,\n  };\n}\n\nexport async function getProductVariants(productId: string): Promise<CJVariant[]> {\n  const response = await cjApiRequest<{\n    code: number;\n    data: CJVariant[];\n  }>(`/product/variant/queryByVid?pid=${encodeURIComponent(productId)}`);\n  \n  return response.data || [];\n}\n\nexport async function getVariantById(variantId: string): Promise<CJVariant | null> {\n  try {\n    const response = await cjApiRequest<{\n      code: number;\n      data: CJVariant;\n    }>(`/product/variant/queryByVid?vid=${encodeURIComponent(variantId)}`);\n    \n    return response.data || null;\n  } catch {\n    return null;\n  }\n}\n\nexport async function calculateShipping(\n  variantId: string,\n  quantity: number,\n  destinationCountry: string = 'SA'\n): Promise<CJShippingOption[]> {\n  const response = await cjApiRequest<{\n    code: number;\n    data: CJShippingOption[];\n  }>('/logistic/freightCalculate', 'POST', {\n    startCountryCode: 'CN',\n    endCountryCode: destinationCountry,\n    products: [\n      {\n        vid: variantId,\n        quantity: quantity,\n      },\n    ],\n  });\n\n  return response.data || [];\n}\n\nexport async function calculateShippingBySku(\n  sku: string,\n  quantity: number,\n  destinationCountry: string = 'SA'\n): Promise<CJShippingOption[]> {\n  const response = await cjApiRequest<{\n    code: number;\n    data: Array<{\n      postage: string;\n      postageCNY?: string;\n      arrivalTime?: string;\n      option?: {\n        enName: string;\n        arrivalTime: string;\n      };\n      wrapPostage?: number;\n    }>;\n  }>('/logistic/freightCalculateTip', 'POST', {\n    reqDTOS: [\n      {\n        srcAreaCode: 'CN',\n        destAreaCode: destinationCountry,\n        skuList: [sku],\n        freightTrialSkuList: [\n          {\n            sku: sku,\n            skuQuantity: quantity,\n          },\n        ],\n        productProp: ['COMMON'],\n        platforms: ['Shopify'],\n      },\n    ],\n  });\n\n  return (response.data || []).map((item) => ({\n    logisticName: item.option?.enName || 'Standard Shipping',\n    logisticPrice: parseFloat(item.postage) || item.wrapPostage || 0,\n    logisticPriceCn: parseFloat(item.postageCNY || '0'),\n    logisticAging: item.option?.arrivalTime || item.arrivalTime || '7-15',\n  }));\n}\n\nexport async function getProductDetails(productId: string): Promise<{\n  product: CJProductSearchResult | null;\n  variants: CJVariant[];\n}> {\n  const searchResult = await searchProducts({\n    keyword: productId,\n    pageSize: 1,\n    includeDescription: true,\n    includeCategory: true,\n  });\n\n  const product = searchResult.products.find(\n    (p) => p.id === productId || p.sku === productId\n  ) || searchResult.products[0] || null;\n\n  let variants: CJVariant[] = [];\n  if (product) {\n    try {\n      variants = await getProductVariants(product.id);\n    } catch {\n      variants = [];\n    }\n  }\n\n  return { product, variants };\n}\n\nexport async function testConnection(): Promise<{\n  success: boolean;\n  message: string;\n  responseTime?: number;\n}> {\n  const start = Date.now();\n  try {\n    await getAccessToken();\n    const categories = await getCategories();\n    const responseTime = Date.now() - start;\n    \n    return {\n      success: true,\n      message: `Connected successfully. Found ${categories.length} category groups.`,\n      responseTime,\n    };\n  } catch (error) {\n    return {\n      success: false,\n      message: error instanceof Error ? error.message : 'Connection failed',\n      responseTime: Date.now() - start,\n    };\n  }\n}\n","path":null,"size_bytes":9374,"size_tokens":null},"src/app/api/admin/cj/v2/categories/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getCategories } from '@/lib/cj/product-discovery';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  try {\n    const categoryGroups = await getCategories();\n    \n    const flatCategories: Array<{\n      id: string;\n      name: string;\n      fullPath: string;\n      level1: string;\n      level2: string;\n      level3: string;\n    }> = [];\n\n    for (const group of categoryGroups) {\n      const level1 = group.categoryFirstName;\n      \n      for (const second of group.categoryFirstList || []) {\n        const level2 = second.categorySecondName;\n        \n        for (const third of second.categorySecondList || []) {\n          flatCategories.push({\n            id: third.categoryId,\n            name: third.categoryName,\n            fullPath: `${level1} > ${level2} > ${third.categoryName}`,\n            level1,\n            level2,\n            level3: third.categoryName,\n          });\n        }\n      }\n    }\n\n    const grouped = categoryGroups.map(group => ({\n      name: group.categoryFirstName,\n      subcategories: (group.categoryFirstList || []).map(sub => ({\n        name: sub.categorySecondName,\n        categories: (sub.categorySecondList || []).map(cat => ({\n          id: cat.categoryId,\n          name: cat.categoryName,\n        })),\n      })),\n    }));\n\n    return NextResponse.json({\n      ok: true,\n      flat: flatCategories,\n      grouped,\n      totalCategories: flatCategories.length,\n    });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        ok: false,\n        error: error instanceof Error ? error.message : 'Failed to fetch categories',\n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1693,"size_tokens":null},"replit.md":{"content":"# Overview\n\nShopixo is a modern, professional e-commerce platform designed for the USA market. It provides an English-only (LTR layout) shopping experience, secure payment processing via Stripe, and efficient dropshipping fulfillment through CJ Dropshipping. The platform offers a curated selection of products, emphasizing security, speed, and a strong content policy.\n\n# Recent Changes (December 2025)\n\n## Full Localization to USA Market (December 16, 2025)\n- **Change**: Converted platform from Saudi Arabia market (Arabic/RTL/SAR) to USA market (English/LTR/USD)\n- **Scope**: Complete translation of 150+ files including:\n  - Layout direction: RTL → LTR (root layout)\n  - All admin pages (sync, inventory, import, products, CJ settings)\n  - All 6 product preview pages (PreviewPageOne through PreviewPageSix)\n  - CATEGORIES array (35 main categories)\n  - FULL_CATEGORIES array (800+ lines including all subcategories)\n  - Currency display: SAR (ر.س) → USD ($)\n- **Note**: Shipping logic intentionally unchanged - will be updated separately for US shipping methods\n\n## Estimated Rating System for All Products (December 12, 2025)\n- **Issue**: CJ Dropshipping deprecated their reviews/comments API in June 2024 - no real rating data available\n- **Solution**: Implemented \"Shopixo Estimated Rating\" based on product popularity (listedNum)\n- **How it works**:\n  - All products now display star ratings (3.8 - 4.8 range)\n  - Rating is deterministic based on listedNum popularity metric\n  - Review count estimated as 15% of listings\n  - Tooltip explains it's an estimated rating based on supplier data\n- **Rating Algorithm** (listedNum thresholds):\n  - 2000+ → 4.8 stars, 1000-1999 → 4.7 stars, 500-999 → 4.5 stars\n  - 200-499 → 4.3 stars, 100-199 → 4.2 stars, 50-99 → 4.0 stars\n  - 20-49 → 3.9 stars, <20 → 3.8 stars\n- **Rating Filter on Discover Page**: Filter by minimum rating (3+, 3.5+, 4+, 4.5+ stars)\n- **Files Modified**:\n  - `src/components/admin/import/preview/PreviewPageOne.tsx` - Star rating display\n  - `src/app/admin/import/discover/page.tsx` - Rating filter dropdown\n  - `src/app/api/admin/cj/products/search-and-price/route.ts` - Rating filter logic\n\n## Real CJ Variant Sizes Display (December 13, 2025)\n- **Issue**: Static size filter showed wrong generic sizes instead of actual CJ variant data\n  - Example: Phone cases showed \"12, 8, 7, XS, 11\" instead of real sizes like \"iPhone 13Pro, iPhone 7/8/SE\"\n- **Solution**: Sizes are now extracted from real CJ variant data\n- **How it works**:\n  - API extracts sizes from explicit fields (v.size, v.sizeNameEn)\n  - Checks variant properties for size/model/type/version data\n  - Falls back to variantKey (captures phone models like \"iPhone 13Pro\")\n  - Final fallback to variantNameEn parsing\n- **UI Change**: Removed static pre-fetch size filter (sizes vary by product, not predictable)\n- **PreviewPageOne**: Shows actual `availableSizes` from CJ data\n- **Files Modified**:\n  - `src/app/api/admin/cj/products/search-and-price/route.ts` - Size extraction logic\n  - `src/app/admin/import/discover/page.tsx` - Removed static size filter\n\n## Fixed Search Rate Limiting (December 16, 2025)\n- **Issue**: Search was too restrictive with excessive delays and low product limits\n- **Root Cause**: Over-conservative rate limiting settings (1.2-1.5 second delays, 10 product limit)\n- **Solution**: Optimized settings for better balance of usability and API compliance\n- **Changes Made**:\n  - Product limit increased from 10 to 30 per search\n  - Delays reduced from 1.2-1.5s to 1.0s (matches CJ's 1 req/sec exactly)\n  - Variant checks increased from 3 to 5 per product\n  - Fixed bug where single-variant products used undefined variant ID\n  - Improved error handling for quota exhaustion\n- **Result**: Searches are now faster and return more products while still respecting CJ API limits\n\n## Accurate Shipping Cost Calculation (December 16, 2025)\n- **Issue**: Shipping costs were wildly inaccurate (e.g., CJPacket showed ~$2 vs CJ website ~$8.78)\n- **Root Cause**: Code was using a fake 100g default weight instead of real product weight\n- **Solution**: Implemented \"no weight, no quote\" policy with real CJ data only\n- **How it works**:\n  - Weight extracted from CJ fields: packWeight > packingWeight > productWeight (grams)\n  - Dimensions extracted from: packLength, packWidth, packHeight (cm)\n  - If weight is missing → returns explicit error \"CJ missing weight data\" (no fake values)\n  - Dimensions only used when ALL THREE are provided (no fabricated 15x10x5 cm defaults)\n- **FreightResult Type**: Discriminated union for proper error handling\n  - Success: `{ ok: true, options: [...], weightUsed: 350 }`\n  - Failure: `{ ok: false, reason: 'weight_missing', message: '...' }`\n- **Result**: CJPacket Ordinary now shows ~$9.16 (with 350g weight), closely matching CJ's ~$8.78\n- **Files Modified**:\n  - `src/lib/cj/v2.ts` - freightCalculate with real weight/dimension extraction\n  - `src/app/api/cj/shipping/calc/route.ts` - Handler for FreightResult type\n  - `src/app/api/admin/cj/products/search-and-price/route.ts` - Weight extraction and error handling\n\n## CJPacket Ordinary Only - 100% Accurate Shipping (December 16, 2025)\n- **Requirement**: Use only CJPacket Ordinary shipping method for 100% accuracy\n- **Previous Issue**: Multiple shipping options caused confusion and incorrect total calculations\n- **Solution**: Hardcoded to CJPacket Ordinary only\n- **How it works**:\n  - Discover page shows fixed \"CJPacket Ordinary (7-12 days)\" - no dropdown selection\n  - API searches for CJPacket Ordinary by checking both `name` and `code` fields (case-insensitive)\n  - Products/variants without CJPacket Ordinary available are skipped (marked unavailable)\n  - All pricing calculations use only CJPacket Ordinary shipping cost\n- **UI Changes**:\n  - Removed shipping method dropdown filter from Discover page\n  - Removed \"All Available Shipping Methods to USA\" table from PreviewPageFive\n  - PreviewPageFive shows only CJPacket Ordinary price breakdown\n  - PreviewPageSix totals now correctly sum CJPacket Ordinary shipping per variant\n- **Matching Logic**: Finds CJPacket Ordinary via:\n  - `name.includes('cjpacket ordinary')` OR\n  - `code.includes('cjpacket ordinary')` OR\n  - `code === 'cjpacketordinary'`\n- **Files Modified**:\n  - `src/app/admin/import/discover/page.tsx` - Removed filter, hardcoded CJPacket Ordinary\n  - `src/app/api/admin/cj/products/search-and-price/route.ts` - CJPacket Ordinary only selection\n  - `src/components/admin/import/preview/PreviewPageFive.tsx` - Removed multi-shipping table\n\n# User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n# System Architecture\n\n## Frontend Architecture\nShopixo utilizes Next.js 14 (App Router) with TypeScript for server-side rendering, streaming, and code splitting. Styling is managed with Tailwind CSS, incorporating a custom gold/navy HSL color palette and design tokens. UI components are built using Radix UI primitives, styled with shadcn/ui patterns and `class-variance-authority`, ensuring accessibility. It supports dark/light mode via `next-themes`. Lucide React provides consistent iconography.\n\n## Backend Architecture\nThe backend leverages Next.js API routes and React Server Components. Supabase (PostgreSQL with Row Level Security) is the primary database, handling data and authentication via Supabase Auth and `auth-helpers-nextjs`. Stripe processes payments, utilizing checkout sessions and webhooks for order fulfillment. Rate limiting for API protection is implemented with Upstash Redis and `@upstash/ratelimit`. Error tracking is optional via Sentry. Server Components directly fetch data from Supabase, Server Actions handle mutations, and webhooks trigger backend processes for orders and inventory.\n\n## Data Storage\nSupabase (PostgreSQL) is used for all data. Key schemas include `products`, `cart_sessions`/`cart_items`, `orders`/`order_items`, and `blog_posts`. An RPC function `decrement_stock` handles atomic inventory management. Row Level Security (RLS) policies enforce data access control: public read for products, service role only for cart, and user-specific order access.\n\n## Authentication & Authorization\nSupabase Auth manages user authentication, including OAuth and magic links, with session management handled by server-side cookies via `@supabase/auth-helpers-nextjs`. Middleware protects routes like `/account/*` and `/admin/*`. Admin access is role-based.\n\n## Security Architecture\nA strict Content Security Policy (CSP) is enforced using per-request nonces for inline scripts, blocking unsafe-inline/unsafe-eval. Allowed domains include Stripe, Supabase, Cloudinary, Plausible, Sentry, and OpenAI. Rate limiting is applied to API routes using Upstash Redis. The production environment uses HTTPS-only via Vercel, and sensitive data is stored in Vercel environment variables.\n\n## Testing Strategy\nThe project employs Jest and React Testing Library for unit tests on components, and Playwright for end-to-end testing of critical user flows (e.g., checkout, navigation). Mocks are used for Next.js components and Radix UI portals. Tests run on CI/CD with GitHub Actions, including production smoke tests.\n\n# External Dependencies\n\n## Third-Party Services\n\n**Supabase:**\n- **Purpose:** Database, authentication, real-time features.\n- **Integration:** Server-side client with service role for admin, anon key for public reads.\n- **Environment Variables:** `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`.\n\n**Stripe:**\n- **Purpose:** Payment processing (cards, Apple Pay), order confirmation via webhooks.\n- **Integration:** `@stripe/stripe-js` (client), `stripe` Node SDK (server), checkout sessions.\n- **Environment Variables:** `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`.\n\n**CJ Dropshipping:**\n- **Purpose:** Product sourcing, fulfillment, shipping calculation.\n- **Integration:** Custom API client for batch product sync, webhooks for tracking updates.\n- **Environment Variables:** `CJ_API_BASE`, `CJ_API_KEY` or `CJ_ACCESS_TOKEN`, `CJ_EMAIL`, `CJ_WEBHOOK_SECRET`.\n\n**Upstash Redis:**\n- **Purpose:** Rate limiting for API routes.\n- **Integration:** `@upstash/ratelimit` + `@upstash/redis`.\n- **Environment Variables:** `UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`.\n\n**Sentry (Optional):**\n- **Purpose:** Error tracking and performance monitoring.\n- **Integration:** Conditionally loaded based on `SENTRY_DSN`.\n- **Environment Variable:** `SENTRY_DSN`.\n\n**OpenAI (Optional):**\n- **Purpose:** AI-powered customer support chat widget.\n- **Integration:** `/api/chat` endpoint.\n- **Environment Variables:** `OPENAI_API_KEY`, `AI_MODEL_TEXT`.\n\n## Payment Gateways (KSA Focus)\n- **Primary:** Stripe (cards, Apple Pay).\n- **Future:** COD (Cash on Delivery) support.\n\n## Deployment & Hosting\n- **Platform:** Vercel.\n- **Build Command:** `npm run build`.\n- **Static Assets:** Served from `/public`.\n\n## Analytics & Monitoring\n- **Plausible Analytics (Optional):** Privacy-friendly web analytics.\n- **Sentry (Optional):** Application monitoring and error reporting.","path":null,"size_bytes":11148,"size_tokens":null},"src/app/api/admin/cj/v2/connection/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { testConnection, getCategories } from '@/lib/cj/product-discovery';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET() {\n  try {\n    const result = await testConnection();\n    \n    let categories: Array<{ id: string; name: string; level: number }> = [];\n    if (result.success) {\n      try {\n        const categoryGroups = await getCategories();\n        for (const group of categoryGroups) {\n          for (const second of group.categoryFirstList || []) {\n            for (const third of second.categorySecondList || []) {\n              categories.push({\n                id: third.categoryId,\n                name: `${group.categoryFirstName} > ${second.categorySecondName} > ${third.categoryName}`,\n                level: 3,\n              });\n            }\n          }\n        }\n      } catch {\n        // Categories optional\n      }\n    }\n\n    return NextResponse.json({\n      ok: result.success,\n      message: result.message,\n      responseTime: result.responseTime,\n      categoriesCount: categories.length,\n      categories: categories.slice(0, 50),\n    });\n  } catch (error) {\n    return NextResponse.json(\n      {\n        ok: false,\n        message: error instanceof Error ? error.message : 'Connection test failed',\n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1340,"size_tokens":null},"src/app/api/admin/cj/v2/queue/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { calculateKSAPrice, getUsdToSarRate, VAT_RATE, PAYMENT_FEE_RATE } from '@/lib/cj/ksa-pricing';\n\nexport const dynamic = 'force-dynamic';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ninterface QueuedProduct {\n  cj_product_id: string;\n  cj_sku: string;\n  name_en: string;\n  image_url: string;\n  cj_price_usd: number;\n  shipping_usd: number;\n  shipping_days: string;\n  final_price_sar: number;\n  profit_sar: number;\n  margin_percent: number;\n  stock: number;\n  category_path: string;\n  pricing_breakdown: Record<string, unknown>;\n  status: 'pending' | 'approved' | 'rejected' | 'imported' | 'skipped';\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const includeAll = searchParams.get('includeAll') === 'true';\n    \n    const { data: batches, error: batchError } = await supabase\n      .from('import_batches')\n      .select('*')\n      .order('created_at', { ascending: false })\n      .limit(10);\n\n    if (batchError) throw batchError;\n\n    let query = supabase\n      .from('product_queue')\n      .select('*')\n      .order('created_at', { ascending: false });\n    \n    if (!includeAll) {\n      query = query.in('status', ['pending', 'approved', 'rejected', 'skipped']);\n    }\n    \n    const { data: queuedProducts, error: queueError } = await query;\n\n    if (queueError) throw queueError;\n\n    const stats = {\n      pending: queuedProducts?.filter(p => p.status === 'pending').length || 0,\n      approved: queuedProducts?.filter(p => p.status === 'approved').length || 0,\n      rejected: queuedProducts?.filter(p => p.status === 'rejected').length || 0,\n      imported: queuedProducts?.filter(p => p.status === 'imported').length || 0,\n      skipped: queuedProducts?.filter(p => p.status === 'skipped').length || 0,\n      total: queuedProducts?.length || 0,\n    };\n\n    return NextResponse.json({\n      ok: true,\n      batches: batches || [],\n      products: queuedProducts || [],\n      stats,\n    });\n  } catch (error) {\n    console.error('Queue fetch error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Failed to fetch queue' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { products, batchName } = body as { \n      products: Array<{\n        id: string;\n        sku: string;\n        nameEn: string;\n        bigImage: string;\n        sellPrice: string;\n        discountPrice?: string;\n        warehouseInventoryNum: number;\n        threeCategoryName?: string;\n        twoCategoryName?: string;\n        oneCategoryName?: string;\n        shippingUSD: number;\n        shippingDays: string;\n        pricing: {\n          baseCostSAR: number;\n          vatSAR: number;\n          paymentFeeSAR: number;\n          profitSAR: number;\n          roundedPriceSAR: number;\n          actualMarginPercent: number;\n          breakdown: Record<string, unknown>;\n        };\n      }>;\n      batchName?: string;\n    };\n\n    if (!products || products.length === 0) {\n      return NextResponse.json(\n        { ok: false, error: 'No products provided' },\n        { status: 400 }\n      );\n    }\n\n    const { data: batch, error: batchError } = await supabase\n      .from('import_batches')\n      .insert({\n        name: batchName || `Import ${new Date().toISOString().slice(0, 16).replace('T', ' ')}`,\n        total_products: products.length,\n        status: 'pending',\n        search_params: {},\n      })\n      .select()\n      .single();\n\n    if (batchError) throw batchError;\n\n    const queueItems: QueuedProduct[] = products.map(product => {\n      const cjPrice = parseFloat(product.discountPrice || product.sellPrice) || 0;\n      const categoryPath = [\n        product.oneCategoryName,\n        product.twoCategoryName,\n        product.threeCategoryName,\n      ].filter(Boolean).join(' > ');\n\n      return {\n        cj_product_id: product.id,\n        cj_sku: product.sku,\n        name_en: product.nameEn,\n        image_url: product.bigImage,\n        cj_price_usd: cjPrice,\n        shipping_usd: product.shippingUSD,\n        shipping_days: product.shippingDays,\n        final_price_sar: product.pricing.roundedPriceSAR,\n        profit_sar: product.pricing.profitSAR,\n        margin_percent: product.pricing.actualMarginPercent,\n        stock: product.warehouseInventoryNum,\n        category_path: categoryPath,\n        pricing_breakdown: product.pricing.breakdown,\n        status: 'pending',\n      };\n    });\n\n    const { error: queueError } = await supabase\n      .from('product_queue')\n      .insert(queueItems.map(item => ({\n        ...item,\n        batch_id: batch.id,\n      })));\n\n    if (queueError) throw queueError;\n\n    return NextResponse.json({\n      ok: true,\n      batchId: batch.id,\n      batchName: batch.name,\n      addedCount: products.length,\n    });\n  } catch (error) {\n    console.error('Queue add error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Failed to add to queue' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { productIds, action, newPriceSAR } = body as {\n      productIds: number[];\n      action: 'approve' | 'reject' | 'restore' | 'update_price';\n      newPriceSAR?: number;\n    };\n\n    if (!productIds || productIds.length === 0) {\n      return NextResponse.json(\n        { ok: false, error: 'No product IDs provided' },\n        { status: 400 }\n      );\n    }\n\n    switch (action) {\n      case 'approve': {\n        const { error } = await supabase\n          .from('product_queue')\n          .update({ status: 'approved' })\n          .in('id', productIds);\n        if (error) throw error;\n        break;\n      }\n      \n      case 'reject': {\n        const { error } = await supabase\n          .from('product_queue')\n          .update({ status: 'rejected' })\n          .in('id', productIds);\n        if (error) throw error;\n        break;\n      }\n      \n      case 'restore': {\n        const { error } = await supabase\n          .from('product_queue')\n          .update({ status: 'pending' })\n          .in('id', productIds);\n        if (error) throw error;\n        break;\n      }\n      \n      case 'update_price': {\n        if (typeof newPriceSAR !== 'number' || isNaN(newPriceSAR) || newPriceSAR <= 0) {\n          return NextResponse.json(\n            { ok: false, error: 'Invalid price: must be a positive number' },\n            { status: 400 }\n          );\n        }\n\n        const { data: products, error: fetchError } = await supabase\n          .from('product_queue')\n          .select('id, cj_price_usd, shipping_usd')\n          .in('id', productIds);\n\n        if (fetchError) throw fetchError;\n        if (!products || products.length === 0) {\n          return NextResponse.json(\n            { ok: false, error: 'Products not found' },\n            { status: 404 }\n          );\n        }\n\n        const usdToSar = getUsdToSarRate();\n        \n        for (const product of products) {\n          const baseCostUSD = product.cj_price_usd + product.shipping_usd;\n          const baseCostSAR = baseCostUSD * usdToSar;\n          const costWithVAT = baseCostSAR * (1 + VAT_RATE);\n          const costWithFees = costWithVAT * (1 + PAYMENT_FEE_RATE);\n          \n          const profitSAR = newPriceSAR - costWithFees;\n          const marginPercent = (profitSAR / baseCostSAR) * 100;\n\n          const { error: updateError } = await supabase\n            .from('product_queue')\n            .update({\n              final_price_sar: newPriceSAR,\n              profit_sar: profitSAR,\n              margin_percent: marginPercent,\n            })\n            .eq('id', product.id);\n\n          if (updateError) throw updateError;\n        }\n        break;\n      }\n      \n      default:\n        return NextResponse.json(\n          { ok: false, error: 'Invalid action' },\n          { status: 400 }\n        );\n    }\n\n    return NextResponse.json({\n      ok: true,\n      updatedCount: productIds.length,\n      action,\n    });\n  } catch (error) {\n    console.error('Queue update error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Failed to update queue' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const productIds = searchParams.get('ids')?.split(',').map(Number).filter(n => !isNaN(n));\n\n    if (!productIds || productIds.length === 0) {\n      return NextResponse.json(\n        { ok: false, error: 'No product IDs provided' },\n        { status: 400 }\n      );\n    }\n\n    const { error } = await supabase\n      .from('product_queue')\n      .delete()\n      .in('id', productIds);\n\n    if (error) throw error;\n\n    return NextResponse.json({\n      ok: true,\n      deletedCount: productIds.length,\n    });\n  } catch (error) {\n    console.error('Queue delete error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Failed to delete from queue' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":9389,"size_tokens":null},"src/app/api/admin/cj/v2/import/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { getProductVariants, type CJVariant } from '@/lib/cj/product-discovery';\nimport { calculateKSAPrice } from '@/lib/cj/ksa-pricing';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\n\nexport const dynamic = 'force-dynamic';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\ninterface QueuedProduct {\n  id: number;\n  batch_id: string;\n  cj_product_id: string;\n  cj_sku: string;\n  name_en: string;\n  image_url: string;\n  cj_price_usd: number;\n  shipping_usd: number;\n  shipping_days: string;\n  final_price_sar: number;\n  profit_sar: number;\n  margin_percent: number;\n  stock: number;\n  category_path: string;\n  pricing_breakdown: Record<string, unknown>;\n  status: string;\n}\n\ninterface ImportResult {\n  cjProductId: string;\n  productId?: number;\n  success: boolean;\n  skipped?: boolean;\n  error?: string;\n  variantsCreated?: number;\n}\n\nfunction generateSlug(name: string, cjProductId: string): string {\n  const base = name\n    .toLowerCase()\n    .replace(/[^a-z0-9\\s-]/g, '')\n    .replace(/\\s+/g, '-')\n    .replace(/-+/g, '-')\n    .slice(0, 50);\n  \n  const suffix = cjProductId.slice(-6).toLowerCase();\n  return `${base}-${suffix}`;\n}\n\nfunction generateSKU(cjSku: string): string {\n  const timestamp = Date.now().toString(36).toUpperCase();\n  const cjPart = cjSku.slice(-8).toUpperCase();\n  return `SX-${cjPart}-${timestamp}`;\n}\n\nfunction mapCategoryPath(categoryPath: string): string {\n  const path = categoryPath.toLowerCase();\n  \n  const categoryMap: Record<string, string> = {\n    'women': 'womens-fashion',\n    'men': 'mens-fashion',\n    'clothing': 'fashion',\n    'jewelry': 'accessories',\n    'watches': 'accessories',\n    'bags': 'bags',\n    'home': 'home-living',\n    'garden': 'home-living',\n    'beauty': 'beauty',\n    'health': 'health-wellness',\n    'electronics': 'electronics',\n    'sports': 'sports',\n    'toys': 'toys-games',\n    'kids': 'kids',\n    'baby': 'kids',\n  };\n\n  for (const [keyword, category] of Object.entries(categoryMap)) {\n    if (path.includes(keyword)) {\n      return category;\n    }\n  }\n  \n  return 'general';\n}\n\nasync function importProduct(\n  product: QueuedProduct\n): Promise<ImportResult> {\n  const result: ImportResult = {\n    cjProductId: product.cj_product_id,\n    success: false,\n  };\n\n  try {\n    let variants: CJVariant[] = [];\n    try {\n      variants = await getProductVariants(product.cj_product_id);\n    } catch {\n      console.log(`No variants found for ${product.cj_product_id}, using stock only`);\n    }\n\n    const slug = generateSlug(product.name_en, product.cj_product_id);\n    const sku = generateSKU(product.cj_sku);\n    const category = mapCategoryPath(product.category_path);\n\n    const uiVariants: { name: string; options: string[] }[] = [];\n    if (variants.length > 0) {\n      const sizeOptions = new Set<string>();\n      const colorOptions = new Set<string>();\n      \n      for (const v of variants) {\n        if (v.variantSku?.includes('Size')) {\n          sizeOptions.add(v.variantNameEn || v.variantSku);\n        }\n        if (v.variantNameEn) {\n          const name = v.variantNameEn.toLowerCase();\n          if (name.includes('s') || name.includes('m') || name.includes('l') || name.includes('xl')) {\n            sizeOptions.add(v.variantNameEn);\n          } else {\n            colorOptions.add(v.variantNameEn);\n          }\n        }\n      }\n      \n      if (sizeOptions.size > 0) {\n        uiVariants.push({ name: 'Size', options: Array.from(sizeOptions) });\n      }\n      if (colorOptions.size > 0) {\n        uiVariants.push({ name: 'Color', options: Array.from(colorOptions) });\n      }\n    }\n\n    const totalStock = variants.length > 0 \n      ? variants.reduce((sum, v) => sum + (v.variantStock || 0), 0)\n      : product.stock;\n\n    const productVariants = variants.map(v => {\n      const variantPriceUSD = v.variantSellPrice || product.cj_price_usd;\n      const variantPricing = calculateKSAPrice({\n        cjPriceUSD: variantPriceUSD,\n        shippingUSD: product.shipping_usd,\n        marginPercent: product.margin_percent,\n      });\n      \n      return {\n        option_name: 'Variant',\n        option_value: v.variantNameEn || v.variantSku || 'Default',\n        cj_sku: v.variantSku || null,\n        cj_variant_id: v.vid || null,\n        price: variantPricing.roundedPriceSAR,\n        stock: v.variantStock || 0,\n      };\n    });\n\n    const { data: rpcResult, error: rpcError } = await supabase.rpc('import_cj_product', {\n      p_title: product.name_en,\n      p_slug: slug,\n      p_description: `Imported from CJ Dropshipping. SKU: ${sku}`,\n      p_price: product.final_price_sar,\n      p_images: product.image_url ? [product.image_url] : [],\n      p_category: category,\n      p_stock: totalStock,\n      p_variants: uiVariants,\n      p_cj_product_id: product.cj_product_id,\n      p_shipping_from: 'China',\n      p_delivery_time_hours: parseInt(product.shipping_days.split('-')[1] || '15') * 24,\n      p_product_variants: productVariants,\n      p_batch_id: product.batch_id,\n      p_queue_item_id: product.id,\n      p_import_details: {\n        finalPrice: product.final_price_sar,\n        category,\n        marginPercent: product.margin_percent,\n      },\n    });\n\n    if (rpcError) {\n      result.error = rpcError.message;\n      return result;\n    }\n\n    const rpcData = rpcResult as { \n      success: boolean; \n      skipped?: boolean; \n      productId?: number; \n      variantsCreated?: number;\n      error?: string;\n      message?: string;\n    };\n\n    if (rpcData.skipped) {\n      result.success = false;\n      result.skipped = true;\n      result.productId = rpcData.productId;\n      return result;\n    }\n\n    if (!rpcData.success) {\n      result.error = rpcData.error || 'Import failed';\n      return result;\n    }\n\n    result.success = true;\n    result.productId = rpcData.productId;\n    result.variantsCreated = rpcData.variantsCreated;\n    \n    return result;\n\n  } catch (error) {\n    result.error = error instanceof Error ? error.message : 'Import failed';\n    \n    try {\n      await supabase.from('import_logs').insert({\n        batch_id: product.batch_id,\n        queue_item_id: product.id,\n        cj_product_id: product.cj_product_id,\n        action: 'import',\n        status: 'error',\n        details: { error: result.error },\n      });\n    } catch {\n      console.error('Failed to log import error');\n    }\n\n    return result;\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const adminCheck = await ensureAdmin();\n    if (!adminCheck.ok) {\n      return NextResponse.json(\n        { ok: false, error: adminCheck.reason || 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n\n    const body = await request.json();\n    const { productIds, importAll } = body as {\n      productIds?: number[];\n      importAll?: boolean;\n    };\n\n    let query = supabase\n      .from('product_queue')\n      .select('*')\n      .eq('status', 'approved');\n\n    if (!importAll && productIds && productIds.length > 0) {\n      query = query.in('id', productIds);\n    }\n\n    const { data: approvedProducts, error: fetchError } = await query;\n\n    if (fetchError) throw fetchError;\n    if (!approvedProducts || approvedProducts.length === 0) {\n      return NextResponse.json({\n        ok: true,\n        message: 'No approved products to import',\n        results: [],\n      });\n    }\n\n    const results: ImportResult[] = [];\n    let successCount = 0;\n    let errorCount = 0;\n    let skippedCount = 0;\n\n    for (const product of approvedProducts) {\n      const result = await importProduct(product as QueuedProduct);\n      results.push(result);\n      \n      if (result.skipped) {\n        skippedCount++;\n      } else if (result.success) {\n        successCount++;\n      } else {\n        errorCount++;\n      }\n    }\n\n    return NextResponse.json({\n      ok: true,\n      message: `Import complete: ${successCount} imported, ${skippedCount} duplicates skipped, ${errorCount} errors`,\n      stats: {\n        total: approvedProducts.length,\n        success: successCount,\n        duplicates: skippedCount,\n        errors: errorCount,\n      },\n      results,\n    });\n\n  } catch (error) {\n    console.error('Import error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Import failed' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET() {\n  try {\n    const adminCheck = await ensureAdmin();\n    if (!adminCheck.ok) {\n      return NextResponse.json(\n        { ok: false, error: adminCheck.reason || 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n\n    const { data: logs, error } = await supabase\n      .from('import_logs')\n      .select('*')\n      .order('created_at', { ascending: false })\n      .limit(50);\n\n    if (error) throw error;\n\n    const { count: totalImported } = await supabase\n      .from('products')\n      .select('*', { count: 'exact', head: true })\n      .not('cj_product_id', 'is', null);\n\n    return NextResponse.json({\n      ok: true,\n      recentLogs: logs || [],\n      totalImportedProducts: totalImported || 0,\n    });\n  } catch (error) {\n    console.error('Import logs error:', error);\n    return NextResponse.json(\n      { ok: false, error: error instanceof Error ? error.message : 'Failed to fetch logs' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":9418,"size_tokens":null},"src/app/api/admin/import/execute/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { slugify } from \"@/lib/utils/slug\";\nimport { hasColumn, hasTable } from \"@/lib/db-features\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nconst USD_TO_SAR = 3.75;\nconst DEFAULT_SHIPPING_USD = 5;\nconst DEFAULT_VAT_PERCENT = 15;\nconst DEFAULT_PAYMENT_FEE_PERCENT = 2.9;\nconst DEFAULT_MARGIN_PERCENT = 40;\nconst DEFAULT_MIN_PROFIT_SAR = 35;\n\nasync function calculateRetailPrice(costUsd: number, shippingUsd: number | null, category: string, admin: any): Promise<{\n  retailSar: number;\n  marginApplied: number;\n  breakdown: Record<string, number>;\n}> {\n  const { data: categoryRule } = await admin\n    .from(\"pricing_rules\")\n    .select(\"*\")\n    .eq(\"category\", category)\n    .maybeSingle();\n\n  const { data: defaultRule } = await admin\n    .from(\"pricing_rules\")\n    .select(\"*\")\n    .eq(\"is_default\", true)\n    .maybeSingle();\n\n  const pricingRule = categoryRule || defaultRule || {\n    margin_percent: DEFAULT_MARGIN_PERCENT,\n    min_profit_sar: DEFAULT_MIN_PROFIT_SAR,\n    vat_percent: DEFAULT_VAT_PERCENT,\n    payment_fee_percent: DEFAULT_PAYMENT_FEE_PERCENT,\n    smart_rounding_enabled: true,\n    rounding_targets: [49, 79, 99, 149, 199, 249, 299],\n  };\n\n  const vatPercent = pricingRule.vat_percent ?? DEFAULT_VAT_PERCENT;\n  const paymentFeePercent = pricingRule.payment_fee_percent ?? DEFAULT_PAYMENT_FEE_PERCENT;\n  const marginPercent = pricingRule.margin_percent ?? DEFAULT_MARGIN_PERCENT;\n  const minProfitSar = pricingRule.min_profit_sar ?? DEFAULT_MIN_PROFIT_SAR;\n\n  const effectiveShippingUsd = shippingUsd ?? DEFAULT_SHIPPING_USD;\n\n  const baseSar = costUsd * USD_TO_SAR;\n  const shippingSar = effectiveShippingUsd * USD_TO_SAR;\n  const subtotal = baseSar + shippingSar;\n  \n  const vat = subtotal * (vatPercent / 100);\n  const afterVat = subtotal + vat;\n  const paymentFee = afterVat * (paymentFeePercent / 100);\n  const landed = afterVat + paymentFee;\n  const margin = landed * (marginPercent / 100);\n  let retailSar = landed + margin;\n\n  if (pricingRule.smart_rounding_enabled && pricingRule.rounding_targets?.length > 0) {\n    const targets = (pricingRule.rounding_targets as number[]).sort((a, b) => a - b);\n    const closest = targets.find(t => t >= retailSar) || targets[targets.length - 1];\n    retailSar = closest;\n  } else {\n    retailSar = Math.ceil(retailSar);\n  }\n\n  const profit = retailSar - landed;\n  if (profit < minProfitSar) {\n    retailSar = landed + minProfitSar;\n    if (pricingRule.smart_rounding_enabled && pricingRule.rounding_targets?.length > 0) {\n      const targets = (pricingRule.rounding_targets as number[]).sort((a, b) => a - b);\n      const closest = targets.find(t => t >= retailSar) || targets[targets.length - 1];\n      retailSar = closest;\n    }\n  }\n\n  return {\n    retailSar: Math.round(retailSar),\n    marginApplied: marginPercent,\n    breakdown: {\n      baseSar,\n      shippingSar,\n      vat,\n      paymentFee,\n      margin,\n      landed,\n      vatPercent,\n      paymentFeePercent,\n    },\n  };\n}\n\nfunction generateSku(prefix: string, productId: string, variantIndex: number): string {\n  const random = Math.random().toString(36).substring(2, 6).toUpperCase();\n  return `${prefix}-${productId.slice(-4).toUpperCase()}-${variantIndex + 1}-${random}`;\n}\n\nasync function ensureUniqueSlug(admin: any, base: string): Promise<string> {\n  const s = slugify(base);\n  let candidate = s;\n  for (let i = 2; i <= 50; i++) {\n    const { data } = await admin\n      .from('products')\n      .select('id')\n      .eq('slug', candidate)\n      .maybeSingle();\n    if (!data) return candidate;\n    candidate = `${s}-${i}`;\n  }\n  return `${s}-${Date.now()}`;\n}\n\nasync function omitMissingColumns(payload: Record<string, any>, cols: string[]) {\n  for (const c of cols) {\n    if (!(c in payload)) continue;\n    try {\n      const exists = await hasColumn('products', c);\n      if (!exists) delete payload[c];\n    } catch {\n      delete payload[c];\n    }\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { productIds } = body;\n\n    if (!productIds || !Array.isArray(productIds) || productIds.length === 0) {\n      return NextResponse.json({ ok: false, error: \"No product IDs provided\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Supabase not configured\" }, { status: 500 });\n    }\n\n    const { data: queueProducts, error: queueError } = await admin\n      .from('product_queue')\n      .select('*')\n      .in('id', productIds)\n      .eq('status', 'approved');\n\n    if (queueError) {\n      console.error(\"[Import Execute] Queue query error:\", queueError);\n      return NextResponse.json({ ok: false, error: queueError.message }, { status: 500 });\n    }\n\n    if (!queueProducts || queueProducts.length === 0) {\n      return NextResponse.json({ ok: false, error: \"No approved products found in queue\" }, { status: 400 });\n    }\n\n    const hasCjProductIdColumn = await hasColumn('products', 'cj_product_id');\n    const hasVariantsTable = await hasTable('product_variants');\n\n    const results: { id: number; success: boolean; shopixoId?: string; error?: string }[] = [];\n\n    for (const qp of queueProducts) {\n      try {\n        let existing: any = null;\n        if (hasCjProductIdColumn) {\n          const { data } = await admin\n            .from(\"products\")\n            .select(\"id\")\n            .eq(\"cj_product_id\", qp.cj_product_id)\n            .maybeSingle();\n          existing = data;\n        }\n\n        if (existing) {\n          await admin\n            .from('product_queue')\n            .update({\n              status: 'imported',\n              shopixo_product_id: existing.id,\n              imported_at: new Date().toISOString()\n            })\n            .eq('id', qp.id);\n\n          results.push({ id: qp.id, success: true, shopixoId: existing.id, error: \"Already imported\" });\n          continue;\n        }\n\n        const avgPrice = qp.cj_price_usd ?? 0;\n        const shippingCost = qp.shipping_cost_usd ?? DEFAULT_SHIPPING_USD;\n        const pricing = await calculateRetailPrice(avgPrice, shippingCost, qp.category || \"General\", admin);\n\n        const rawVariants = typeof qp.variants === 'string' ? JSON.parse(qp.variants) : (qp.variants || []);\n        const variants = rawVariants.map((v: any, i: number) => ({\n          sku: generateSku(\"CJ\", qp.cj_product_id, i),\n          cj_sku: v.cjSku || v.vid || null,\n          size: v.size || null,\n          color: v.color || null,\n          price_sar: pricing.retailSar,\n          cost_usd: v.price || avgPrice,\n          stock: Math.max(0, (v.stock || 0) - 5),\n          weight_g: v.weight || v.weightGrams || null,\n          image_url: v.imageUrl || v.image || v.whiteImage || null,\n        }));\n\n        const totalStock = variants.reduce((sum: number, v: any) => sum + (v.stock || 0), 0);\n        const rawImages = typeof qp.images === 'string' ? JSON.parse(qp.images) : (qp.images || []);\n        const baseSlug = await ensureUniqueSlug(admin, qp.name_en);\n\n        const productPayload: Record<string, any> = {\n          title: qp.name_en,\n          slug: baseSlug,\n          price: pricing.retailSar,\n          category: qp.category || \"General\",\n          stock: totalStock,\n        };\n\n        const optionalFields: Record<string, any> = {\n          description: qp.description_en || '',\n          images: rawImages,\n          video_url: qp.video_url || null,\n          is_active: totalStock > 0,\n          cj_product_id: qp.cj_product_id,\n          supplier_sku: qp.cj_sku || `CJ-${qp.cj_product_id}`,\n          free_shipping: true,\n          processing_time_hours: qp.processing_days ? qp.processing_days * 24 : null,\n          delivery_time_hours: qp.delivery_days_max ? qp.delivery_days_max * 24 : null,\n          variants: variants.length > 0 ? variants : null,\n        };\n\n        await omitMissingColumns(optionalFields, [\n          'description', 'images', 'video_url', 'is_active', 'cj_product_id',\n          'free_shipping', 'processing_time_hours', 'delivery_time_hours',\n          'supplier_sku', 'variants'\n        ]);\n\n        const fullPayload = { ...productPayload, ...optionalFields };\n\n        let productId: number;\n        try {\n          const { data: newProduct, error: insertErr } = await admin\n            .from(\"products\")\n            .insert(fullPayload)\n            .select(\"id\")\n            .single();\n\n          if (insertErr || !newProduct) {\n            throw insertErr || new Error(\"Failed to create product\");\n          }\n          productId = newProduct.id as number;\n        } catch (e: any) {\n          const msg = String(e?.message || e || '');\n          if (/duplicate key|unique constraint|unique violation|already exists/i.test(msg)) {\n            fullPayload.slug = await ensureUniqueSlug(admin, qp.name_en + '-' + Date.now());\n            const { data: newProduct2, error: err2 } = await admin\n              .from(\"products\")\n              .insert(fullPayload)\n              .select(\"id\")\n              .single();\n            if (err2 || !newProduct2) throw err2 || new Error(\"Failed to create product (retry)\");\n            productId = newProduct2.id as number;\n          } else {\n            throw e;\n          }\n        }\n\n        if (hasVariantsTable && variants.length > 0) {\n          const variantRows = variants.map((v: any) => ({\n            product_id: productId,\n            option_name: v.size ? 'Size' : (v.color ? 'Color' : 'Default'),\n            option_value: v.size || v.color || 'Default',\n            cj_sku: v.cj_sku || null,\n            price: v.price_sar,\n            stock: v.stock,\n          }));\n\n          await admin.from('product_variants').insert(variantRows);\n        }\n\n        await admin\n          .from('product_queue')\n          .update({\n            status: 'imported',\n            shopixo_product_id: productId,\n            imported_at: new Date().toISOString(),\n            calculated_retail_sar: pricing.retailSar,\n            margin_applied: pricing.marginApplied\n          })\n          .eq('id', qp.id);\n\n        results.push({ id: qp.id, success: true, shopixoId: String(productId) });\n\n      } catch (e: any) {\n        console.error(`Failed to import product ${qp.id}:`, e);\n        results.push({ id: qp.id, success: false, error: e?.message || \"Import failed\" });\n      }\n    }\n\n    const successCount = results.filter(r => r.success).length;\n    const failCount = results.filter(r => !r.success).length;\n\n    try {\n      await admin.from('import_logs').insert({\n        action: \"import_execute\",\n        status: failCount === 0 ? \"success\" : \"partial\",\n        details: { \n          requested: productIds.length, \n          imported: successCount, \n          failed: failCount,\n          results \n        }\n      });\n    } catch (logErr) {\n      console.error(\"Failed to log import:\", logErr);\n    }\n\n    return NextResponse.json({\n      ok: true,\n      imported: successCount,\n      failed: failCount,\n      results,\n    });\n  } catch (e: any) {\n    console.error(\"Import execute error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function GET(req: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: products, error } = await admin\n      .from('product_queue')\n      .select('id, name_en, cj_product_id')\n      .eq('status', 'approved')\n      .order('quality_score', { ascending: false })\n      .limit(100);\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({\n      ok: true,\n      products: products || [],\n      total: products?.length || 0,\n    });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":12209,"size_tokens":null},"src/app/api/admin/inventory/sync/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from \"@/lib/cj/v2\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nconst SAFETY_BUFFER = 5;\n\nexport async function POST(req: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: products } = await admin\n      .from(\"products\")\n      .select(\"id, title, stock, active, metadata\")\n      .not(\"metadata->cj_product_id\", \"is\", null)\n      .limit(100);\n\n    if (!products || products.length === 0) {\n      return NextResponse.json({ ok: true, message: \"No CJ products to sync\", updated: 0, outOfStock: 0 });\n    }\n\n    let updated = 0;\n    let outOfStock = 0;\n    let errors = 0;\n\n    for (const product of products) {\n      const cjProductId = product.metadata?.cj_product_id;\n      if (!cjProductId) continue;\n\n      try {\n        const result = await queryProductByPidOrKeyword({ pid: cjProductId });\n        const cjProducts = result?.data?.content || result?.data?.list || [];\n        \n        if (cjProducts.length === 0) {\n          errors++;\n          continue;\n        }\n\n        const mapped = mapCjItemToProductLike(cjProducts[0]);\n        if (!mapped) {\n          errors++;\n          continue;\n        }\n\n        const totalCjStock = mapped.variants.reduce((sum, v) => sum + (v.stock || 0), 0);\n        const adjustedStock = Math.max(0, totalCjStock - SAFETY_BUFFER);\n\n        const updateData: Record<string, any> = {\n          stock: adjustedStock,\n          \"metadata->last_stock_sync\": new Date().toISOString(),\n          updated_at: new Date().toISOString(),\n        };\n\n        if (adjustedStock === 0 && product.active) {\n          updateData.active = false;\n          outOfStock++;\n          \n          await admin.from(\"daily_sync_changes\").insert({\n            shopixo_product_id: product.id,\n            cj_product_id: cjProductId,\n            change_type: \"stock_out\",\n            field_changed: \"stock\",\n            old_value: String(product.stock || 0),\n            new_value: \"0\",\n            status: \"applied\",\n            sync_date: new Date().toISOString().split(\"T\")[0],\n            applied_at: new Date().toISOString(),\n          });\n        } else if (adjustedStock > 0 && !product.active && (product.stock || 0) === 0) {\n          updateData.active = true;\n          \n          await admin.from(\"daily_sync_changes\").insert({\n            shopixo_product_id: product.id,\n            cj_product_id: cjProductId,\n            change_type: \"stock_restored\",\n            field_changed: \"stock\",\n            old_value: \"0\",\n            new_value: String(adjustedStock),\n            status: \"applied\",\n            sync_date: new Date().toISOString().split(\"T\")[0],\n            applied_at: new Date().toISOString(),\n          });\n        }\n\n        const variants = mapped.variants.map((v, i) => ({\n          ...((product.metadata?.variants || [])[i] || {}),\n          stock: Math.max(0, (v.stock || 0) - SAFETY_BUFFER),\n          cj_stock: v.stock,\n        }));\n\n        const isStockRestored = adjustedStock > 0 && !product.active && (product.stock || 0) === 0;\n        await admin\n          .from(\"products\")\n          .update({\n            stock: adjustedStock,\n            active: adjustedStock === 0 ? false : (isStockRestored ? true : product.active),\n            metadata: {\n              ...product.metadata,\n              last_stock_sync: new Date().toISOString(),\n              variants,\n            },\n            updated_at: new Date().toISOString(),\n          })\n          .eq(\"id\", product.id);\n\n        updated++;\n\n      } catch (e) {\n        console.error(`Failed to sync product ${cjProductId}:`, e);\n        errors++;\n      }\n    }\n\n    await admin.from(\"import_logs\").insert({\n      action: \"inventory_sync\",\n      status: errors > 0 ? \"partial\" : \"success\",\n      details: { \n        products_checked: products.length, \n        updated, \n        outOfStock, \n        errors \n      },\n    });\n\n    await admin.from(\"kv_settings\").upsert({\n      key: \"last_inventory_sync\",\n      value: { timestamp: new Date().toISOString(), updated, outOfStock },\n      updated_at: new Date().toISOString(),\n    }, { onConflict: \"key\" });\n\n    return NextResponse.json({\n      ok: true,\n      checked: products.length,\n      updated,\n      outOfStock,\n      errors,\n    });\n  } catch (e: any) {\n    console.error(\"Inventory sync error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":4851,"size_tokens":null},"src/app/admin/import/pricing/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport {\n  Calculator,\n  Plus,\n  Edit,\n  Trash2,\n  Save,\n  X,\n  DollarSign,\n  Percent,\n  CheckCircle,\n  AlertCircle,\n  Loader2,\n} from \"lucide-react\";\n\ntype PricingRule = {\n  id: number;\n  category: string;\n  margin_percent: number;\n  min_profit_sar: number;\n  vat_percent: number;\n  payment_fee_percent: number;\n  smart_rounding_enabled: boolean;\n  rounding_targets: number[];\n  is_default: boolean;\n  created_at: string;\n  updated_at: string;\n};\n\nconst defaultCategories = [\n  \"General\",\n  \"Clothing\",\n  \"Electronics\",\n  \"Home & Garden\",\n  \"Beauty\",\n  \"Sports\",\n  \"Accessories\",\n  \"Jewelry\",\n  \"Kids\",\n  \"Shoes\",\n];\n\nexport default function PricingRulesPage() {\n  const [rules, setRules] = useState<PricingRule[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState<string | null>(null);\n\n  const [editingId, setEditingId] = useState<number | null>(null);\n  const [editData, setEditData] = useState<Partial<PricingRule>>({});\n  const [isAddingNew, setIsAddingNew] = useState(false);\n  const [saving, setSaving] = useState(false);\n\n  const [testCost, setTestCost] = useState(10);\n  const [testShipping, setTestShipping] = useState(5);\n  const [testCategory, setTestCategory] = useState(\"General\");\n  const [testResult, setTestResult] = useState<{\n    baseUsd: number;\n    shippingUsd: number;\n    baseSar: number;\n    shippingSar: number;\n    vat: number;\n    paymentFee: number;\n    margin: number;\n    retailSar: number;\n    profit: number;\n  } | null>(null);\n\n  const fetchRules = useCallback(async () => {\n    try {\n      const res = await fetch(\"/api/admin/pricing/rules\");\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to fetch rules\");\n      }\n      setRules(data.rules || []);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load pricing rules\");\n    } finally {\n      setLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    fetchRules();\n  }, [fetchRules]);\n\n  const startEdit = (rule: PricingRule) => {\n    setEditingId(rule.id);\n    setEditData({ ...rule });\n    setIsAddingNew(false);\n  };\n\n  const startNew = () => {\n    setIsAddingNew(true);\n    setEditingId(null);\n    setEditData({\n      category: \"\",\n      margin_percent: 40,\n      min_profit_sar: 35,\n      vat_percent: 15,\n      payment_fee_percent: 2.9,\n      smart_rounding_enabled: true,\n      rounding_targets: [49, 79, 99, 149, 199, 249, 299],\n      is_default: false,\n    });\n  };\n\n  const cancelEdit = () => {\n    setEditingId(null);\n    setIsAddingNew(false);\n    setEditData({});\n  };\n\n  const saveRule = async () => {\n    if (!editData.category?.trim()) {\n      setError(\"Category name is required\");\n      return;\n    }\n\n    setSaving(true);\n    setError(null);\n\n    try {\n      const method = isAddingNew ? \"POST\" : \"PUT\";\n      const body = isAddingNew ? editData : { id: editingId, ...editData };\n\n      const res = await fetch(\"/api/admin/pricing/rules\", {\n        method,\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(body),\n      });\n\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to save rule\");\n      }\n\n      setSuccess(isAddingNew ? \"Rule created successfully\" : \"Rule updated successfully\");\n      cancelEdit();\n      fetchRules();\n\n      setTimeout(() => setSuccess(null), 3000);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to save rule\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const deleteRule = async (id: number) => {\n    if (!confirm(\"Are you sure you want to delete this pricing rule?\")) return;\n\n    try {\n      const res = await fetch(`/api/admin/pricing/rules?id=${id}`, {\n        method: \"DELETE\",\n      });\n\n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to delete rule\");\n      }\n\n      setSuccess(\"Rule deleted successfully\");\n      fetchRules();\n      setTimeout(() => setSuccess(null), 3000);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to delete rule\");\n    }\n  };\n\n  const calculateTest = () => {\n    const rule = rules.find(r => r.category === testCategory) || rules.find(r => r.is_default);\n    if (!rule) {\n      setTestResult(null);\n      return;\n    }\n\n    const usdToSar = 3.75;\n    const baseSar = testCost * usdToSar;\n    const shippingSar = testShipping * usdToSar;\n    const subtotal = baseSar + shippingSar;\n    const vat = subtotal * (rule.vat_percent / 100);\n    const afterVat = subtotal + vat;\n    const paymentFee = afterVat * (rule.payment_fee_percent / 100);\n    const landed = afterVat + paymentFee;\n    const margin = landed * (rule.margin_percent / 100);\n    let retailSar = landed + margin;\n\n    if (rule.smart_rounding_enabled && rule.rounding_targets?.length > 0) {\n      const targets = rule.rounding_targets.sort((a, b) => a - b);\n      const closest = targets.find(t => t >= retailSar) || targets[targets.length - 1];\n      retailSar = closest;\n    } else {\n      retailSar = Math.ceil(retailSar);\n    }\n\n    const profit = retailSar - landed;\n\n    setTestResult({\n      baseUsd: testCost,\n      shippingUsd: testShipping,\n      baseSar,\n      shippingSar,\n      vat,\n      paymentFee,\n      margin,\n      retailSar,\n      profit: Math.max(profit, rule.min_profit_sar),\n    });\n  };\n\n  useEffect(() => {\n    if (rules.length > 0) {\n      calculateTest();\n    }\n  }, [testCost, testShipping, testCategory, rules]);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Pricing Rules</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">قواعد التسعير - Configure margins, VAT, and rounding per category</p>\n        </div>\n        <button\n          onClick={startNew}\n          className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700\"\n        >\n          <Plus className=\"h-4 w-4\" />\n          Add Rule\n        </button>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 flex items-center gap-3\">\n          <AlertCircle className=\"h-5 w-5 text-red-600 shrink-0\" />\n          <span className=\"text-red-800 text-sm\">{error}</span>\n          <button onClick={() => setError(null)} className=\"ml-auto text-red-600 hover:text-red-800\">\n            <X className=\"h-4 w-4\" />\n          </button>\n        </div>\n      )}\n\n      {success && (\n        <div className=\"rounded-lg bg-green-50 border border-green-200 p-4 flex items-center gap-3\">\n          <CheckCircle className=\"h-5 w-5 text-green-600 shrink-0\" />\n          <span className=\"text-green-800 text-sm\">{success}</span>\n        </div>\n      )}\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        <div className=\"lg:col-span-2 space-y-4\">\n          {isAddingNew && (\n            <div className=\"bg-blue-50 border-2 border-blue-200 rounded-xl p-6\">\n              <h3 className=\"font-medium text-gray-900 mb-4\">New Pricing Rule</h3>\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-xs font-medium text-gray-500 mb-1\">Category</label>\n                  <select\n                    value={editData.category || \"\"}\n                    onChange={(e) => setEditData(d => ({ ...d, category: e.target.value }))}\n                    className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                  >\n                    <option value=\"\">Select category...</option>\n                    {defaultCategories.map(cat => (\n                      <option key={cat} value={cat} disabled={rules.some(r => r.category === cat)}>\n                        {cat}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n                <div>\n                  <label className=\"block text-xs font-medium text-gray-500 mb-1\">Margin %</label>\n                  <input\n                    type=\"number\"\n                    value={editData.margin_percent || 40}\n                    onChange={(e) => setEditData(d => ({ ...d, margin_percent: Number(e.target.value) }))}\n                    className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                    min={0}\n                    max={200}\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs font-medium text-gray-500 mb-1\">Min Profit SAR</label>\n                  <input\n                    type=\"number\"\n                    value={editData.min_profit_sar || 35}\n                    onChange={(e) => setEditData(d => ({ ...d, min_profit_sar: Number(e.target.value) }))}\n                    className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                    min={0}\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs font-medium text-gray-500 mb-1\">VAT %</label>\n                  <input\n                    type=\"number\"\n                    value={editData.vat_percent || 15}\n                    onChange={(e) => setEditData(d => ({ ...d, vat_percent: Number(e.target.value) }))}\n                    className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                    min={0}\n                    max={100}\n                    step={0.1}\n                  />\n                </div>\n                <div>\n                  <label className=\"block text-xs font-medium text-gray-500 mb-1\">Payment Fee %</label>\n                  <input\n                    type=\"number\"\n                    value={editData.payment_fee_percent || 2.9}\n                    onChange={(e) => setEditData(d => ({ ...d, payment_fee_percent: Number(e.target.value) }))}\n                    className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                    min={0}\n                    max={100}\n                    step={0.1}\n                  />\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"smart-rounding-new\"\n                    checked={editData.smart_rounding_enabled || false}\n                    onChange={(e) => setEditData(d => ({ ...d, smart_rounding_enabled: e.target.checked }))}\n                    className=\"rounded\"\n                  />\n                  <label htmlFor=\"smart-rounding-new\" className=\"text-sm text-gray-700\">Smart Rounding</label>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 mt-4\">\n                <button\n                  onClick={saveRule}\n                  disabled={saving}\n                  className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50\"\n                >\n                  {saving ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Save className=\"h-4 w-4\" />}\n                  Create Rule\n                </button>\n                <button onClick={cancelEdit} className=\"px-4 py-2 border rounded-lg text-sm hover:bg-gray-50\">\n                  Cancel\n                </button>\n              </div>\n            </div>\n          )}\n\n          {loading ? (\n            <div className=\"text-center py-12 text-gray-500\">\n              <Loader2 className=\"h-8 w-8 animate-spin mx-auto mb-3\" />\n              Loading pricing rules...\n            </div>\n          ) : rules.length === 0 ? (\n            <div className=\"text-center py-12 text-gray-500 bg-white rounded-xl border\">\n              <Calculator className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n              <p>No pricing rules configured</p>\n              <button onClick={startNew} className=\"text-blue-600 hover:underline text-sm mt-2\">\n                Create your first rule\n              </button>\n            </div>\n          ) : (\n            <div className=\"bg-white rounded-xl border shadow-sm overflow-hidden\">\n              <table className=\"w-full\">\n                <thead>\n                  <tr className=\"bg-gray-50 border-b\">\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Category</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Margin</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Min Profit</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">VAT</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Rounding</th>\n                    <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n                  </tr>\n                </thead>\n                <tbody className=\"divide-y\">\n                  {rules.map((rule) => (\n                    editingId === rule.id ? (\n                      <tr key={rule.id} className=\"bg-blue-50\">\n                        <td colSpan={6} className=\"px-4 py-4\">\n                          <div className=\"grid grid-cols-5 gap-3\">\n                            <div>\n                              <label className=\"block text-xs text-gray-500 mb-1\">Category</label>\n                              <input\n                                type=\"text\"\n                                value={editData.category || \"\"}\n                                onChange={(e) => setEditData(d => ({ ...d, category: e.target.value }))}\n                                className=\"w-full px-2 py-1.5 border rounded text-sm\"\n                                disabled={rule.is_default}\n                              />\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-gray-500 mb-1\">Margin %</label>\n                              <input\n                                type=\"number\"\n                                value={editData.margin_percent || 0}\n                                onChange={(e) => setEditData(d => ({ ...d, margin_percent: Number(e.target.value) }))}\n                                className=\"w-full px-2 py-1.5 border rounded text-sm\"\n                              />\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-gray-500 mb-1\">Min Profit</label>\n                              <input\n                                type=\"number\"\n                                value={editData.min_profit_sar || 0}\n                                onChange={(e) => setEditData(d => ({ ...d, min_profit_sar: Number(e.target.value) }))}\n                                className=\"w-full px-2 py-1.5 border rounded text-sm\"\n                              />\n                            </div>\n                            <div>\n                              <label className=\"block text-xs text-gray-500 mb-1\">VAT %</label>\n                              <input\n                                type=\"number\"\n                                value={editData.vat_percent || 0}\n                                onChange={(e) => setEditData(d => ({ ...d, vat_percent: Number(e.target.value) }))}\n                                className=\"w-full px-2 py-1.5 border rounded text-sm\"\n                              />\n                            </div>\n                            <div className=\"flex items-end gap-2\">\n                              <button\n                                onClick={saveRule}\n                                disabled={saving}\n                                className=\"px-3 py-1.5 bg-blue-600 text-white rounded text-sm disabled:opacity-50\"\n                              >\n                                {saving ? \"...\" : \"Save\"}\n                              </button>\n                              <button onClick={cancelEdit} className=\"px-3 py-1.5 border rounded text-sm\">\n                                Cancel\n                              </button>\n                            </div>\n                          </div>\n                        </td>\n                      </tr>\n                    ) : (\n                      <tr key={rule.id} className=\"hover:bg-gray-50\">\n                        <td className=\"px-4 py-3\">\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-medium text-gray-900\">{rule.category}</span>\n                            {rule.is_default && (\n                              <span className=\"px-1.5 py-0.5 bg-gray-100 rounded text-xs text-gray-500\">Default</span>\n                            )}\n                          </div>\n                        </td>\n                        <td className=\"px-4 py-3\">\n                          <span className=\"text-blue-600 font-medium\">{rule.margin_percent}%</span>\n                        </td>\n                        <td className=\"px-4 py-3\">\n                          <span className=\"text-green-600\">SAR {rule.min_profit_sar}</span>\n                        </td>\n                        <td className=\"px-4 py-3\">\n                          <span className=\"text-gray-600\">{rule.vat_percent}%</span>\n                        </td>\n                        <td className=\"px-4 py-3\">\n                          {rule.smart_rounding_enabled ? (\n                            <span className=\"text-emerald-600\">Enabled</span>\n                          ) : (\n                            <span className=\"text-gray-400\">Disabled</span>\n                          )}\n                        </td>\n                        <td className=\"px-4 py-3\">\n                          <div className=\"flex items-center gap-1\">\n                            <button\n                              onClick={() => startEdit(rule)}\n                              className=\"p-1.5 text-gray-600 hover:bg-gray-100 rounded\"\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </button>\n                            {!rule.is_default && (\n                              <button\n                                onClick={() => deleteRule(rule.id)}\n                                className=\"p-1.5 text-red-600 hover:bg-red-50 rounded\"\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </button>\n                            )}\n                          </div>\n                        </td>\n                      </tr>\n                    )\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          )}\n        </div>\n\n        <div className=\"space-y-4\">\n          <div className=\"bg-white rounded-xl border shadow-sm p-6\">\n            <h3 className=\"font-medium text-gray-900 mb-4 flex items-center gap-2\">\n              <Calculator className=\"h-5 w-5 text-blue-600\" />\n              Price Calculator\n            </h3>\n            <p className=\"text-sm text-gray-500 mb-4\">حاسبة الأسعار - Test your pricing formula</p>\n            \n            <div className=\"space-y-3\">\n              <div>\n                <label className=\"block text-xs font-medium text-gray-500 mb-1\">Category</label>\n                <select\n                  value={testCategory}\n                  onChange={(e) => setTestCategory(e.target.value)}\n                  className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                >\n                  {rules.map(r => (\n                    <option key={r.category} value={r.category}>{r.category}</option>\n                  ))}\n                </select>\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-gray-500 mb-1\">Product Cost (USD)</label>\n                <input\n                  type=\"number\"\n                  value={testCost}\n                  onChange={(e) => setTestCost(Number(e.target.value))}\n                  className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                  min={0}\n                  step={0.01}\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs font-medium text-gray-500 mb-1\">Shipping Cost (USD)</label>\n                <input\n                  type=\"number\"\n                  value={testShipping}\n                  onChange={(e) => setTestShipping(Number(e.target.value))}\n                  className=\"w-full px-3 py-2 border rounded-lg text-sm\"\n                  min={0}\n                  step={0.01}\n                />\n              </div>\n            </div>\n\n            {testResult && (\n              <div className=\"mt-6 pt-4 border-t space-y-2\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-500\">Base Cost</span>\n                  <span>SAR {testResult.baseSar.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-500\">Shipping</span>\n                  <span>SAR {testResult.shippingSar.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-500\">VAT (15%)</span>\n                  <span>SAR {testResult.vat.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-500\">Payment Fee</span>\n                  <span>SAR {testResult.paymentFee.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"text-gray-500\">Margin</span>\n                  <span>SAR {testResult.margin.toFixed(2)}</span>\n                </div>\n                <div className=\"flex justify-between text-lg font-bold border-t pt-2\">\n                  <span className=\"text-gray-900\">Retail Price</span>\n                  <span className=\"text-green-600\">SAR {testResult.retailSar.toFixed(0)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm text-green-600\">\n                  <span>Profit</span>\n                  <span>SAR {testResult.profit.toFixed(2)}</span>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <div className=\"bg-amber-50 rounded-xl border border-amber-200 p-4\">\n            <h4 className=\"font-medium text-amber-800 mb-2\">Pricing Formula</h4>\n            <div className=\"text-xs text-amber-700 space-y-1 font-mono\">\n              <p>Base Cost (SAR) = CJ Price × 3.75</p>\n              <p>+ DDP Shipping (SAR)</p>\n              <p>+ VAT (15%)</p>\n              <p>+ Payment Fee (2.9%)</p>\n              <p>+ Margin (%)</p>\n              <p className=\"pt-1 border-t border-amber-200\">= Final Price → Smart Rounded</p>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":23227,"size_tokens":null},"src/app/admin/inventory/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport type { Route } from \"next\";\nimport {\n  Package,\n  AlertTriangle,\n  CheckCircle,\n  RefreshCw,\n  Eye,\n  EyeOff,\n  TrendingDown,\n  TrendingUp,\n  Search,\n  Filter,\n  Loader2,\n  Settings,\n  ImageIcon,\n  Images,\n} from \"lucide-react\";\n\ntype InventoryProduct = {\n  id: string;\n  title: string;\n  title_ar: string | null;\n  category: string;\n  price: number;\n  stock: number;\n  active: boolean;\n  images: string[];\n  supplier_sku: string | null;\n  product_code: string | null;\n  metadata: {\n    cj_product_id?: string;\n    cj_sku?: string;\n    variants?: Array<{\n      sku: string;\n      stock: number;\n      color?: string;\n      size?: string;\n    }>;\n    last_stock_sync?: string;\n  };\n  updated_at: string;\n};\n\ntype InventoryStats = {\n  total: number;\n  inStock: number;\n  lowStock: number;\n  outOfStock: number;\n  hidden: number;\n  cjProducts: number;\n};\n\nconst SAFETY_BUFFER = 5;\nconst LOW_STOCK_THRESHOLD = 10;\n\nexport default function InventoryPage() {\n  const [products, setProducts] = useState<InventoryProduct[]>([]);\n  const [stats, setStats] = useState<InventoryStats>({\n    total: 0,\n    inStock: 0,\n    lowStock: 0,\n    outOfStock: 0,\n    hidden: 0,\n    cjProducts: 0,\n  });\n  const [loading, setLoading] = useState(true);\n  const [syncing, setSyncing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState<string | null>(null);\n  \n  const [filter, setFilter] = useState(\"all\");\n  const [search, setSearch] = useState(\"\");\n  const [page, setPage] = useState(0);\n  const limit = 20;\n  \n  const [refreshingImages, setRefreshingImages] = useState<string | null>(null);\n  const [bulkRefreshing, setBulkRefreshing] = useState(false);\n\n  const fetchInventory = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const params = new URLSearchParams({\n        filter,\n        search,\n        limit: limit.toString(),\n        offset: (page * limit).toString(),\n      });\n      \n      const res = await fetch(`/api/admin/inventory?${params}`);\n      const data = await res.json();\n      \n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to fetch inventory\");\n      }\n      \n      setProducts(data.products || []);\n      setStats(data.stats || {});\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load inventory\");\n    } finally {\n      setLoading(false);\n    }\n  }, [filter, search, page]);\n\n  useEffect(() => {\n    fetchInventory();\n  }, [fetchInventory]);\n\n  const toggleVisibility = async (id: string, active: boolean) => {\n    try {\n      const res = await fetch(\"/api/admin/inventory\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ id, active: !active }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to update\");\n      }\n      \n      fetchInventory();\n    } catch (e: any) {\n      setError(e?.message || \"Failed to update\");\n    }\n  };\n\n  const syncAllStock = async () => {\n    if (!confirm(\"Sync stock levels from CJ for all products? This may take a few minutes.\")) return;\n    \n    setSyncing(true);\n    setError(null);\n    \n    try {\n      const res = await fetch(\"/api/admin/inventory/sync\", {\n        method: \"POST\",\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Sync failed\");\n      }\n      \n      setSuccess(`Synced ${data.updated} products, ${data.outOfStock} marked as out of stock`);\n      fetchInventory();\n      \n      setTimeout(() => setSuccess(null), 5000);\n    } catch (e: any) {\n      setError(e?.message || \"Sync failed\");\n    } finally {\n      setSyncing(false);\n    }\n  };\n\n  const getStockStatus = (stock: number) => {\n    if (stock === 0) return { label: \"Out of Stock\", color: \"bg-red-100 text-red-800\", icon: AlertTriangle };\n    if (stock <= LOW_STOCK_THRESHOLD) return { label: \"Low Stock\", color: \"bg-amber-100 text-amber-800\", icon: TrendingDown };\n    return { label: \"In Stock\", color: \"bg-green-100 text-green-800\", icon: CheckCircle };\n  };\n\n  const getImageCountStatus = (images: string[] | null | undefined) => {\n    const count = Array.isArray(images) ? images.length : 0;\n    if (count === 0) return { count, color: \"text-red-600 bg-red-50\", label: \"No images\" };\n    if (count === 1) return { count, color: \"text-amber-600 bg-amber-50\", label: \"1 image\" };\n    return { count, color: \"text-green-600 bg-green-50\", label: `${count} images` };\n  };\n\n  const refreshSingleProductImages = async (productId: string) => {\n    setRefreshingImages(productId);\n    setError(null);\n    \n    try {\n      const res = await fetch(\"/api/admin/products/refresh-images\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ productId: Number(productId) }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to refresh images\");\n      }\n      \n      setSuccess(`Refreshed ${data.imagesCount} images for product`);\n      fetchInventory();\n      \n      setTimeout(() => setSuccess(null), 5000);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to refresh images\");\n    } finally {\n      setRefreshingImages(null);\n    }\n  };\n\n  const refreshAllProductImages = async () => {\n    if (!confirm(\"Refresh images for ALL products from CJ? This may take a few minutes.\")) return;\n    \n    setBulkRefreshing(true);\n    setError(null);\n    \n    try {\n      const res = await fetch(\"/api/admin/products/refresh-images\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ all: true }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Bulk refresh failed\");\n      }\n      \n      setSuccess(`Refreshed images for ${data.successfulProducts}/${data.totalProducts} products (${data.totalImages} total images)`);\n      fetchInventory();\n      \n      setTimeout(() => setSuccess(null), 8000);\n    } catch (e: any) {\n      setError(e?.message || \"Bulk refresh failed\");\n    } finally {\n      setBulkRefreshing(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Inventory Management</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">Monitor and sync stock levels</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            onClick={refreshAllProductImages}\n            disabled={bulkRefreshing || syncing}\n            className=\"flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-700 disabled:opacity-50\"\n          >\n            {bulkRefreshing ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Images className=\"h-4 w-4\" />}\n            {bulkRefreshing ? \"Refreshing All...\" : \"Refresh All Images\"}\n          </button>\n          <button\n            onClick={syncAllStock}\n            disabled={syncing || bulkRefreshing}\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50\"\n          >\n            {syncing ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <RefreshCw className=\"h-4 w-4\" />}\n            Sync Stock\n          </button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-6 gap-4\">\n        <button\n          onClick={() => { setFilter(\"all\"); setPage(0); }}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            filter === \"all\" ? \"border-gray-900 bg-gray-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <Package className=\"h-5 w-5 text-gray-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.total}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Total Products</p>\n        </button>\n\n        <button\n          onClick={() => { setFilter(\"in_stock\"); setPage(0); }}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            filter === \"in_stock\" ? \"border-green-500 bg-green-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <CheckCircle className=\"h-5 w-5 text-green-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.inStock}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">In Stock</p>\n        </button>\n\n        <button\n          onClick={() => { setFilter(\"low_stock\"); setPage(0); }}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            filter === \"low_stock\" ? \"border-amber-500 bg-amber-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <TrendingDown className=\"h-5 w-5 text-amber-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.lowStock}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Low Stock</p>\n        </button>\n\n        <button\n          onClick={() => { setFilter(\"out_of_stock\"); setPage(0); }}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            filter === \"out_of_stock\" ? \"border-red-500 bg-red-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <AlertTriangle className=\"h-5 w-5 text-red-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.outOfStock}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Out of Stock</p>\n        </button>\n\n        <button\n          onClick={() => { setFilter(\"hidden\"); setPage(0); }}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            filter === \"hidden\" ? \"border-gray-500 bg-gray-100\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <EyeOff className=\"h-5 w-5 text-gray-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.hidden}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Hidden</p>\n        </button>\n\n        <div className=\"p-4 rounded-xl border bg-blue-50\">\n          <div className=\"flex items-center justify-between\">\n            <TrendingUp className=\"h-5 w-5 text-blue-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.cjProducts}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">CJ Products</p>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-800\">\n          {error}\n        </div>\n      )}\n\n      {success && (\n        <div className=\"rounded-lg bg-green-50 border border-green-200 p-4 text-sm text-green-800 flex items-center gap-2\">\n          <CheckCircle className=\"h-5 w-5\" />\n          {success}\n        </div>\n      )}\n\n      <div className=\"flex items-center gap-4\">\n        <div className=\"flex-1 relative\">\n          <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400\" />\n          <input\n            type=\"text\"\n            value={search}\n            onChange={(e) => { setSearch(e.target.value); setPage(0); }}\n            placeholder=\"Search products...\"\n            className=\"w-full pl-10 pr-4 py-2.5 rounded-lg border focus:border-blue-500 focus:ring-1 focus:ring-blue-500\"\n          />\n        </div>\n      </div>\n\n      <div className=\"bg-white rounded-xl border shadow-sm overflow-hidden\">\n        {loading ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <Loader2 className=\"h-8 w-8 animate-spin mx-auto mb-3\" />\n            Loading inventory...\n          </div>\n        ) : products.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n            <p>No products found</p>\n          </div>\n        ) : (\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"bg-gray-50 border-b\">\n                <th className=\"w-20 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Image</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Product</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Supplier SKU</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Images</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Stock</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Status</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Visibility</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y\">\n              {products.map((product) => {\n                const status = getStockStatus(product.stock);\n                const StatusIcon = status.icon;\n                \n                return (\n                  <tr key={product.id} className={!product.active ? \"bg-gray-50 opacity-75\" : \"hover:bg-gray-50\"}>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"w-14 h-14 rounded-lg overflow-hidden bg-gray-100\">\n                        {product.images?.[0] ? (\n                          <img src={product.images[0]} alt={product.title} className=\"w-full h-full object-cover\" />\n                        ) : (\n                          <div className=\"w-full h-full flex items-center justify-center\">\n                            <Package className=\"h-6 w-6 text-gray-400\" />\n                          </div>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <p className=\"font-medium text-gray-900 line-clamp-2\">{product.title}</p>\n                      {product.title_ar && (\n                        <p className=\"text-sm text-gray-500 line-clamp-1\" dir=\"rtl\">{product.title_ar}</p>\n                      )}\n                      <p className=\"text-xs text-gray-400 mt-1\">{product.category}</p>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {product.supplier_sku ? (\n                        <span className=\"font-mono text-xs text-blue-600\" title={product.supplier_sku}>\n                          {product.supplier_sku.length > 12 ? `...${product.supplier_sku.slice(-8)}` : product.supplier_sku}\n                        </span>\n                      ) : product.metadata?.cj_product_id ? (\n                        <span className=\"font-mono text-xs text-blue-600\" title={product.metadata.cj_product_id}>\n                          {product.metadata.cj_product_id.length > 12 ? `...${product.metadata.cj_product_id.slice(-8)}` : product.metadata.cj_product_id}\n                        </span>\n                      ) : (\n                        <span className=\"text-gray-400 text-xs\">Manual</span>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {(() => {\n                        const imgStatus = getImageCountStatus(product.images);\n                        const hasCjLink = !!(product.supplier_sku || product.metadata?.cj_product_id);\n                        return (\n                          <div className=\"flex items-center gap-2\">\n                            <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${imgStatus.color}`}>\n                              <ImageIcon className=\"h-3 w-3\" />\n                              {imgStatus.count}\n                            </span>\n                            {hasCjLink && (\n                              <button\n                                onClick={() => refreshSingleProductImages(product.id)}\n                                disabled={refreshingImages === product.id || bulkRefreshing}\n                                className=\"p-1 rounded hover:bg-gray-100 disabled:opacity-50\"\n                                title=\"Refresh images from CJ\"\n                              >\n                                {refreshingImages === product.id ? (\n                                  <Loader2 className=\"h-3.5 w-3.5 animate-spin text-purple-600\" />\n                                ) : (\n                                  <RefreshCw className=\"h-3.5 w-3.5 text-gray-400 hover:text-purple-600\" />\n                                )}\n                              </button>\n                            )}\n                          </div>\n                        );\n                      })()}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-2\">\n                        <span className={`text-lg font-bold ${\n                          product.stock === null ? \"text-gray-400\" :\n                          product.stock === 0 ? \"text-red-600\" :\n                          product.stock <= LOW_STOCK_THRESHOLD ? \"text-amber-600\" : \"text-green-600\"\n                        }`}>\n                          {product.stock === null ? \"-\" : product.stock}\n                        </span>\n                        {product.metadata?.variants && product.metadata.variants.length > 1 && (\n                          <span className=\"text-xs text-gray-400\">\n                            ({product.metadata.variants.length} variants)\n                          </span>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${status.color}`}>\n                        <StatusIcon className=\"h-3 w-3\" />\n                        {status.label}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <button\n                        onClick={() => toggleVisibility(product.id, product.active)}\n                        className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${\n                          product.active ? \"bg-green-100 text-green-800\" : \"bg-gray-100 text-gray-600\"\n                        }`}\n                      >\n                        {product.active ? <Eye className=\"h-3 w-3\" /> : <EyeOff className=\"h-3 w-3\" />}\n                        {product.active ? \"Visible\" : \"Hidden\"}\n                      </button>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <Link\n                        href={`/admin/products/${product.id}` as Route}\n                        className=\"text-blue-600 hover:underline text-sm\"\n                      >\n                        Edit\n                      </Link>\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        )}\n      </div>\n\n      <div className=\"bg-amber-50 rounded-xl border border-amber-200 p-6\">\n        <h3 className=\"font-medium text-amber-900 mb-2 flex items-center gap-2\">\n          <Settings className=\"h-5 w-5\" />\n          Inventory Settings\n        </h3>\n        <div className=\"grid grid-cols-3 gap-4 text-sm mt-4\">\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Safety Buffer</p>\n            <p className=\"font-medium text-gray-900\">{SAFETY_BUFFER} units</p>\n            <p className=\"text-xs text-gray-400 mt-1\">Reserved from CJ stock</p>\n          </div>\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Low Stock Alert</p>\n            <p className=\"font-medium text-gray-900\">&lt; {LOW_STOCK_THRESHOLD} units</p>\n            <p className=\"text-xs text-gray-400 mt-1\">Highlighted as low stock</p>\n          </div>\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Auto-Hide</p>\n            <p className=\"font-medium text-gray-900\">0 units</p>\n            <p className=\"text-xs text-gray-400 mt-1\">Hidden from store when OOS</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20956,"size_tokens":null},"src/lib/i18n/translations.ts":{"content":"export type Language = 'en' | 'ar';\n\nexport const translations = {\n  en: {\n    admin: {\n      title: 'Shopixo Admin',\n      overview: 'Overview',\n      dashboard: 'Dashboard',\n      orders: 'Orders',\n      products: 'Products',\n      allProducts: 'All Products',\n      inventory: 'Inventory',\n      productImport: 'Product Import',\n      discoverProducts: 'Discover Products',\n      importQueue: 'Import Queue',\n      pricingRules: 'Pricing Rules',\n      shippingCalculator: 'Shipping Calculator',\n      cjSettings: 'CJ Settings',\n      automation: 'Automation',\n      dailySync: 'Daily Sync',\n      backgroundJobs: 'Background Jobs',\n      content: 'Content',\n      blog: 'Blog',\n      settings: 'Settings',\n      systemSettings: 'System Settings',\n      admin: 'Admin',\n    },\n    discover: {\n      title: 'Discover Products',\n      subtitle: 'Search CJ Dropshipping catalog for products to import',\n      searchPlaceholder: 'Search for products...',\n      category: 'Category',\n      allCategories: 'All Categories',\n      minPrice: 'Min Price ($)',\n      maxPrice: 'Max Price ($)',\n      search: 'Search',\n      searching: 'Searching...',\n      results: 'Results',\n      addToQueue: 'Add to Queue',\n      qualityScore: 'Quality Score',\n      price: 'Price',\n      stock: 'Stock',\n      rating: 'Rating',\n      reviews: 'Reviews',\n      supplier: 'Supplier',\n      selected: 'Selected',\n      addSelectedToQueue: 'Add Selected to Queue',\n      noProductsFound: 'No products found',\n      tryDifferentSearch: 'Try a different search term or category',\n    },\n    queue: {\n      title: 'Import Queue',\n      subtitle: 'Review and approve products before importing to your store',\n      status: 'Status',\n      all: 'All',\n      pending: 'Pending',\n      approved: 'Approved',\n      rejected: 'Rejected',\n      imported: 'Imported',\n      refresh: 'Refresh',\n      export: 'Export CSV',\n      importSelected: 'Import Selected',\n      product: 'Product',\n      category: 'Category',\n      costPrice: 'Cost Price',\n      retailPrice: 'Retail Price',\n      margin: 'Margin',\n      actions: 'Actions',\n      approve: 'Approve',\n      reject: 'Reject',\n      edit: 'Edit',\n      noProducts: 'No products in queue',\n      addFromDiscover: 'Add products from the Discover page',\n    },\n    pricing: {\n      title: 'Pricing Rules',\n      subtitle: 'Configure pricing rules and margins for different product categories',\n      addRule: 'Add Pricing Rule',\n      category: 'Category',\n      marginPercent: 'Margin %',\n      minProfit: 'Min Profit (USD)',\n      vatPercent: 'VAT %',\n      paymentFeePercent: 'Payment Fee %',\n      smartRounding: 'Smart Rounding',\n      enabled: 'Enabled',\n      disabled: 'Disabled',\n      roundingTargets: 'Rounding Targets',\n      isDefault: 'Default Rule',\n      actions: 'Actions',\n      save: 'Save',\n      cancel: 'Cancel',\n      delete: 'Delete',\n      testPricing: 'Test Pricing',\n      costUsd: 'Cost (USD)',\n      shippingUsd: 'Shipping (USD)',\n      calculate: 'Calculate',\n      retailPrice: 'Retail Price',\n      breakdown: 'Breakdown',\n    },\n    sync: {\n      title: 'Daily Sync',\n      subtitle: 'Monitor and apply price and stock changes from CJ Dropshipping',\n      runSync: 'Run Sync Now',\n      running: 'Running...',\n      lastSync: 'Last Sync',\n      productsChecked: 'Products Checked',\n      changesDetected: 'Changes Detected',\n      priceUpdates: 'Price Updates',\n      stockUpdates: 'Stock Updates',\n      errors: 'Errors',\n      recentChanges: 'Recent Changes',\n      date: 'Date',\n      product: 'Product',\n      changeType: 'Change Type',\n      field: 'Field',\n      oldValue: 'Old Value',\n      newValue: 'New Value',\n      status: 'Status',\n      applied: 'Applied',\n      noChanges: 'No changes detected yet',\n      autoApply: 'Auto-Apply Changes',\n    },\n    inventory: {\n      title: 'Inventory Management',\n      subtitle: 'Monitor stock levels and sync inventory with CJ Dropshipping',\n      syncNow: 'Sync Now',\n      syncing: 'Syncing...',\n      lowStock: 'Low Stock',\n      outOfStock: 'Out of Stock',\n      inStock: 'In Stock',\n      product: 'Product',\n      sku: 'SKU',\n      currentStock: 'Current Stock',\n      cjStock: 'CJ Stock',\n      safetyBuffer: 'Safety Buffer',\n      status: 'Status',\n      autoHide: 'Auto-Hide',\n      visible: 'Visible',\n      hidden: 'Hidden',\n      noProducts: 'No products with inventory tracking',\n    },\n    common: {\n      loading: 'Loading...',\n      error: 'Error',\n      success: 'Success',\n      save: 'Save',\n      cancel: 'Cancel',\n      delete: 'Delete',\n      edit: 'Edit',\n      view: 'View',\n      close: 'Close',\n      confirm: 'Confirm',\n      yes: 'Yes',\n      no: 'No',\n      sar: 'SAR',\n      usd: 'USD',\n      items: 'items',\n      of: 'of',\n      showing: 'Showing',\n      page: 'Page',\n      next: 'Next',\n      previous: 'Previous',\n      search: 'Search',\n      filter: 'Filter',\n      sort: 'Sort',\n      refresh: 'Refresh',\n      export: 'Export',\n      import: 'Import',\n    },\n  },\n  ar: {\n    admin: {\n      title: 'لوحة التحكم',\n      overview: 'نظرة عامة',\n      dashboard: 'لوحة التحكم',\n      orders: 'الطلبات',\n      products: 'المنتجات',\n      allProducts: 'جميع المنتجات',\n      inventory: 'المخزون',\n      productImport: 'استيراد المنتجات',\n      discoverProducts: 'اكتشاف المنتجات',\n      importQueue: 'قائمة الاستيراد',\n      pricingRules: 'قواعد التسعير',\n      shippingCalculator: 'حاسبة الشحن',\n      cjSettings: 'إعدادات CJ',\n      automation: 'الأتمتة',\n      dailySync: 'المزامنة اليومية',\n      backgroundJobs: 'المهام الخلفية',\n      content: 'المحتوى',\n      blog: 'المدونة',\n      settings: 'الإعدادات',\n      systemSettings: 'إعدادات النظام',\n      admin: 'مدير',\n    },\n    discover: {\n      title: 'اكتشاف المنتجات',\n      subtitle: 'ابحث في كتالوج CJ Dropshipping للمنتجات للاستيراد',\n      searchPlaceholder: 'ابحث عن المنتجات...',\n      category: 'الفئة',\n      allCategories: 'جميع الفئات',\n      minPrice: 'أقل سعر ($)',\n      maxPrice: 'أعلى سعر ($)',\n      search: 'بحث',\n      searching: 'جاري البحث...',\n      results: 'النتائج',\n      addToQueue: 'إضافة للقائمة',\n      qualityScore: 'نقاط الجودة',\n      price: 'السعر',\n      stock: 'المخزون',\n      rating: 'التقييم',\n      reviews: 'المراجعات',\n      supplier: 'المورد',\n      selected: 'محدد',\n      addSelectedToQueue: 'إضافة المحدد للقائمة',\n      noProductsFound: 'لم يتم العثور على منتجات',\n      tryDifferentSearch: 'جرب مصطلح بحث أو فئة مختلفة',\n    },\n    queue: {\n      title: 'قائمة الاستيراد',\n      subtitle: 'راجع ووافق على المنتجات قبل استيرادها إلى متجرك',\n      status: 'الحالة',\n      all: 'الكل',\n      pending: 'قيد الانتظار',\n      approved: 'معتمد',\n      rejected: 'مرفوض',\n      imported: 'مستورد',\n      refresh: 'تحديث',\n      export: 'تصدير CSV',\n      importSelected: 'استيراد المحدد',\n      product: 'المنتج',\n      category: 'الفئة',\n      costPrice: 'سعر التكلفة',\n      retailPrice: 'سعر البيع',\n      margin: 'الهامش',\n      actions: 'الإجراءات',\n      approve: 'موافقة',\n      reject: 'رفض',\n      edit: 'تعديل',\n      noProducts: 'لا توجد منتجات في القائمة',\n      addFromDiscover: 'أضف منتجات من صفحة الاكتشاف',\n    },\n    pricing: {\n      title: 'قواعد التسعير',\n      subtitle: 'تكوين قواعد التسعير والهوامش لفئات المنتجات المختلفة',\n      addRule: 'إضافة قاعدة تسعير',\n      category: 'الفئة',\n      marginPercent: 'نسبة الهامش %',\n      minProfit: 'الحد الأدنى للربح (ر.س)',\n      vatPercent: 'ضريبة القيمة المضافة %',\n      paymentFeePercent: 'رسوم الدفع %',\n      smartRounding: 'التقريب الذكي',\n      enabled: 'مفعل',\n      disabled: 'معطل',\n      roundingTargets: 'أهداف التقريب',\n      isDefault: 'القاعدة الافتراضية',\n      actions: 'الإجراءات',\n      save: 'حفظ',\n      cancel: 'إلغاء',\n      delete: 'حذف',\n      testPricing: 'اختبار التسعير',\n      costUsd: 'التكلفة (دولار)',\n      shippingUsd: 'الشحن (دولار)',\n      calculate: 'حساب',\n      retailPrice: 'سعر البيع',\n      breakdown: 'التفاصيل',\n    },\n    sync: {\n      title: 'المزامنة اليومية',\n      subtitle: 'مراقبة وتطبيق تغييرات الأسعار والمخزون من CJ Dropshipping',\n      runSync: 'تشغيل المزامنة الآن',\n      running: 'جاري التشغيل...',\n      lastSync: 'آخر مزامنة',\n      productsChecked: 'المنتجات المفحوصة',\n      changesDetected: 'التغييرات المكتشفة',\n      priceUpdates: 'تحديثات الأسعار',\n      stockUpdates: 'تحديثات المخزون',\n      errors: 'الأخطاء',\n      recentChanges: 'التغييرات الأخيرة',\n      date: 'التاريخ',\n      product: 'المنتج',\n      changeType: 'نوع التغيير',\n      field: 'الحقل',\n      oldValue: 'القيمة القديمة',\n      newValue: 'القيمة الجديدة',\n      status: 'الحالة',\n      applied: 'تم التطبيق',\n      noChanges: 'لم يتم اكتشاف أي تغييرات بعد',\n      autoApply: 'تطبيق التغييرات تلقائياً',\n    },\n    inventory: {\n      title: 'إدارة المخزون',\n      subtitle: 'مراقبة مستويات المخزون ومزامنة المخزون مع CJ Dropshipping',\n      syncNow: 'مزامنة الآن',\n      syncing: 'جاري المزامنة...',\n      lowStock: 'مخزون منخفض',\n      outOfStock: 'نفد المخزون',\n      inStock: 'متوفر',\n      product: 'المنتج',\n      sku: 'رقم المنتج',\n      currentStock: 'المخزون الحالي',\n      cjStock: 'مخزون CJ',\n      safetyBuffer: 'هامش الأمان',\n      status: 'الحالة',\n      autoHide: 'إخفاء تلقائي',\n      visible: 'مرئي',\n      hidden: 'مخفي',\n      noProducts: 'لا توجد منتجات مع تتبع المخزون',\n    },\n    common: {\n      loading: 'جاري التحميل...',\n      error: 'خطأ',\n      success: 'نجاح',\n      save: 'حفظ',\n      cancel: 'إلغاء',\n      delete: 'حذف',\n      edit: 'تعديل',\n      view: 'عرض',\n      close: 'إغلاق',\n      confirm: 'تأكيد',\n      yes: 'نعم',\n      no: 'لا',\n      sar: 'ر.س',\n      usd: 'دولار',\n      items: 'عناصر',\n      of: 'من',\n      showing: 'عرض',\n      page: 'صفحة',\n      next: 'التالي',\n      previous: 'السابق',\n      search: 'بحث',\n      filter: 'تصفية',\n      sort: 'ترتيب',\n      refresh: 'تحديث',\n      export: 'تصدير',\n      import: 'استيراد',\n    },\n  },\n};\n\nexport function getTranslations(lang: Language = 'en') {\n  return translations[lang] || translations.en;\n}\n\nexport function isRtl(lang: Language): boolean {\n  return lang === 'ar';\n}\n","path":null,"size_bytes":11606,"size_tokens":null},"src/app/admin/settings/page.tsx":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport Link from \"next/link\";\nimport type { Route } from \"next\";\nimport { ArrowLeft, Save, RefreshCw, Shield, Bell, Palette } from \"lucide-react\";\n\ntype SettingsResp = {\n  ok: boolean;\n  mode?: \"monitor\" | \"copilot\" | \"autopilot\";\n  killSwitch?: boolean;\n  hasKv?: boolean;\n  error?: string;\n};\n\nexport default function SystemSettingsPage() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState<string | null>(null);\n  const [mode, setMode] = useState<\"monitor\" | \"copilot\" | \"autopilot\">(\"monitor\");\n  const [killSwitch, setKillSwitch] = useState(false);\n\n  async function load() {\n    setLoading(true);\n    setError(null);\n    try {\n      const r = await fetch(\"/api/admin/settings\", { cache: \"no-store\" });\n      const j: SettingsResp = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setMode((j.mode as any) || \"monitor\");\n      setKillSwitch(!!j.killSwitch);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load settings\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function saveSettings(updates: Partial<{ mode: string; killSwitch: boolean }>) {\n    setSaving(true);\n    setError(null);\n    setSuccess(null);\n    try {\n      const r = await fetch(\"/api/admin/settings\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(updates),\n      });\n      const j = await r.json();\n      if (!r.ok || !j.ok) throw new Error(j.error || `HTTP ${r.status}`);\n      setSuccess(\"Settings saved\");\n      await load();\n    } catch (e: any) {\n      setError(e?.message || \"Failed to save settings\");\n    } finally {\n      setSaving(false);\n    }\n  }\n\n  useEffect(() => {\n    load();\n  }, []);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <Link href=\"/admin\" className=\"text-gray-500 hover:text-gray-700\">\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Link>\n          <div>\n            <h1 className=\"text-2xl font-bold text-gray-900\">System Settings</h1>\n            <p className=\"text-sm text-gray-500 mt-1\">\n              Configure store behavior and automation\n            </p>\n          </div>\n        </div>\n        <button\n          onClick={load}\n          disabled={loading}\n          className=\"inline-flex items-center gap-2 rounded-lg border px-4 py-2 text-sm font-medium hover:bg-gray-50\"\n        >\n          <RefreshCw className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`} />\n          Refresh\n        </button>\n      </div>\n\n      {loading && (\n        <div className=\"rounded-xl border bg-white p-8 text-center text-gray-500\">\n          Loading settings...\n        </div>\n      )}\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-700\">\n          {error}\n        </div>\n      )}\n\n      {success && (\n        <div className=\"rounded-lg bg-green-50 border border-green-200 p-4 text-sm text-green-700\">\n          {success}\n        </div>\n      )}\n\n      {!loading && (\n        <>\n          <div className=\"rounded-xl border bg-white shadow-sm overflow-hidden\">\n            <div className=\"border-b px-5 py-4 flex items-center gap-3\">\n              <Shield className=\"h-5 w-5 text-blue-500\" />\n              <div>\n                <h2 className=\"font-semibold text-gray-900\">Automation Mode</h2>\n                <p className=\"text-sm text-gray-500\">\n                  Control how the system handles automatic actions\n                </p>\n              </div>\n            </div>\n            <div className=\"p-5\">\n              <div className=\"flex flex-wrap gap-3\">\n                {([\"monitor\", \"copilot\", \"autopilot\"] as const).map((m) => (\n                  <button\n                    key={m}\n                    onClick={() => {\n                      setMode(m);\n                      saveSettings({ mode: m });\n                    }}\n                    disabled={saving}\n                    className={`rounded-lg px-4 py-2 text-sm font-medium border transition-colors ${\n                      mode === m\n                        ? \"bg-blue-600 text-white border-blue-600\"\n                        : \"bg-white text-gray-700 border-gray-300 hover:bg-gray-50\"\n                    }`}\n                  >\n                    {m.charAt(0).toUpperCase() + m.slice(1)}\n                  </button>\n                ))}\n              </div>\n              <div className=\"mt-4 text-sm text-gray-600\">\n                <p>\n                  <strong>Monitor:</strong> View proposals only, no automatic actions\n                </p>\n                <p>\n                  <strong>Copilot:</strong> Requires approval for all changes\n                </p>\n                <p>\n                  <strong>Autopilot:</strong> Low-risk actions happen automatically\n                </p>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"rounded-xl border bg-white shadow-sm overflow-hidden\">\n            <div className=\"border-b px-5 py-4 flex items-center gap-3\">\n              <Bell className=\"h-5 w-5 text-red-500\" />\n              <div>\n                <h2 className=\"font-semibold text-gray-900\">Emergency Controls</h2>\n                <p className=\"text-sm text-gray-500\">\n                  Stop all automated operations if needed\n                </p>\n              </div>\n            </div>\n            <div className=\"p-5\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"font-medium text-gray-900\">Kill Switch</p>\n                  <p className=\"text-sm text-gray-500\">\n                    {killSwitch\n                      ? \"All write operations are currently blocked\"\n                      : \"System is operating normally\"}\n                  </p>\n                </div>\n                <button\n                  onClick={() => {\n                    setKillSwitch(!killSwitch);\n                    saveSettings({ killSwitch: !killSwitch });\n                  }}\n                  disabled={saving}\n                  className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${\n                    killSwitch\n                      ? \"bg-red-600 text-white hover:bg-red-700\"\n                      : \"bg-gray-200 text-gray-700 hover:bg-gray-300\"\n                  }`}\n                >\n                  {killSwitch ? \"Deactivate\" : \"Activate\"}\n                </button>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"rounded-xl border bg-white shadow-sm overflow-hidden\">\n            <div className=\"border-b px-5 py-4 flex items-center gap-3\">\n              <Palette className=\"h-5 w-5 text-purple-500\" />\n              <div>\n                <h2 className=\"font-semibold text-gray-900\">Store Information</h2>\n                <p className=\"text-sm text-gray-500\">\n                  Basic store configuration\n                </p>\n              </div>\n            </div>\n            <div className=\"p-5\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm\">\n                <div>\n                  <p className=\"text-gray-500\">Store Name</p>\n                  <p className=\"font-medium text-gray-900\">Shopixo</p>\n                </div>\n                <div>\n                  <p className=\"text-gray-500\">Currency</p>\n                  <p className=\"font-medium text-gray-900\">SAR (Saudi Riyal)</p>\n                </div>\n                <div>\n                  <p className=\"text-gray-500\">Market</p>\n                  <p className=\"font-medium text-gray-900\">Saudi Arabia</p>\n                </div>\n                <div>\n                  <p className=\"text-gray-500\">Languages</p>\n                  <p className=\"font-medium text-gray-900\">Arabic, English</p>\n                </div>\n              </div>\n            </div>\n          </div>\n\n          <div className=\"rounded-xl border bg-white shadow-sm overflow-hidden\">\n            <div className=\"border-b px-5 py-4\">\n              <h2 className=\"font-semibold text-gray-900\">Quick Links</h2>\n            </div>\n            <div className=\"p-5\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <Link\n                  href={\"/admin/supplier/settings\" as Route}\n                  className=\"rounded-lg border p-4 hover:bg-gray-50 transition-colors\"\n                >\n                  <p className=\"font-medium text-gray-900\">Supplier Settings</p>\n                  <p className=\"text-sm text-gray-500\">Configure dropshipping API</p>\n                </Link>\n                <Link\n                  href={\"/admin/pricing\" as Route}\n                  className=\"rounded-lg border p-4 hover:bg-gray-50 transition-colors\"\n                >\n                  <p className=\"font-medium text-gray-900\">Pricing Rules</p>\n                  <p className=\"text-sm text-gray-500\">Set margins and pricing</p>\n                </Link>\n                <Link\n                  href={\"/admin/jobs\" as Route}\n                  className=\"rounded-lg border p-4 hover:bg-gray-50 transition-colors\"\n                >\n                  <p className=\"font-medium text-gray-900\">Background Jobs</p>\n                  <p className=\"text-sm text-gray-500\">View job history</p>\n                </Link>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9661,"size_tokens":null},"src/app/admin/import/page.tsx":{"content":"import Link from \"next/link\";\nimport type { Route } from \"next\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport {\n  Download,\n  ListChecks,\n  Calculator,\n  RefreshCw,\n  Package,\n  TrendingUp,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  ArrowRight,\n} from \"lucide-react\";\n\nexport const dynamic = \"force-dynamic\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nasync function getStats() {\n  const admin = getSupabaseAdmin();\n  if (!admin) return null;\n\n  try {\n    const { data: queueData } = await admin.from(\"product_queue\").select(\"status\");\n    const { data: syncData } = await admin.from(\"daily_sync_changes\").select(\"status\");\n    const { data: batchData } = await admin.from(\"import_batches\").select(\"id\").limit(1);\n\n    const queueStats = { pending: 0, approved: 0, imported: 0, rejected: 0 };\n    (queueData || []).forEach((p: any) => {\n      queueStats[p.status as keyof typeof queueStats] = (queueStats[p.status as keyof typeof queueStats] || 0) + 1;\n    });\n\n    const syncStats = { pending: 0 };\n    (syncData || []).forEach((c: any) => {\n      if (c.status === \"pending\") syncStats.pending++;\n    });\n\n    return {\n      queue: queueStats,\n      sync: syncStats,\n      hasBatches: (batchData || []).length > 0,\n    };\n  } catch {\n    return null;\n  }\n}\n\nexport default async function ImportDashboardPage() {\n  const stats = await getStats();\n\n  const quickActions = [\n    {\n      href: \"/admin/import/discover\" as Route,\n      icon: Download,\n      title: \"Discover Products\",\n      titleAr: \"Discover Products\",\n      description: \"Search CJ catalog and add products to queue\",\n      color: \"blue\",\n    },\n    {\n      href: \"/admin/import/queue\" as Route,\n      icon: ListChecks,\n      title: \"Import Queue\",\n      titleAr: \"Import Queue\",\n      description: \"Review and approve products for import\",\n      color: \"green\",\n      badge: stats?.queue?.pending || 0,\n    },\n    {\n      href: \"/admin/import/pricing\" as Route,\n      icon: Calculator,\n      title: \"Pricing Rules\",\n      titleAr: \"Pricing Rules\",\n      description: \"Configure margins, VAT, and smart rounding\",\n      color: \"purple\",\n    },\n    {\n      href: \"/admin/sync\" as Route,\n      icon: RefreshCw,\n      title: \"Daily Sync\",\n      titleAr: \"Daily Sync\",\n      description: \"Monitor price and stock changes\",\n      color: \"amber\",\n      badge: stats?.sync?.pending || 0,\n    },\n  ];\n\n  const colorClasses: Record<string, { bg: string; text: string; border: string }> = {\n    blue: { bg: \"bg-blue-100\", text: \"text-blue-600\", border: \"border-blue-200\" },\n    green: { bg: \"bg-green-100\", text: \"text-green-600\", border: \"border-green-200\" },\n    purple: { bg: \"bg-purple-100\", text: \"text-purple-600\", border: \"border-purple-200\" },\n    amber: { bg: \"bg-amber-100\", text: \"text-amber-600\", border: \"border-amber-200\" },\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h1 className=\"text-2xl font-bold text-gray-900\">Product Import System</h1>\n        <p className=\"text-sm text-gray-500 mt-1\">Discover, review, and import products from CJ Dropshipping</p>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4\">\n        <div className=\"bg-white rounded-xl border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center\">\n              <Clock className=\"h-5 w-5 text-amber-600\" />\n            </div>\n            <span className=\"text-2xl font-bold text-gray-900\">{stats?.queue?.pending || 0}</span>\n          </div>\n          <p className=\"mt-2 text-sm text-gray-600\">Pending Review</p>\n        </div>\n        \n        <div className=\"bg-white rounded-xl border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center\">\n              <CheckCircle className=\"h-5 w-5 text-green-600\" />\n            </div>\n            <span className=\"text-2xl font-bold text-gray-900\">{stats?.queue?.approved || 0}</span>\n          </div>\n          <p className=\"mt-2 text-sm text-gray-600\">Approved</p>\n        </div>\n\n        <div className=\"bg-white rounded-xl border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center\">\n              <Package className=\"h-5 w-5 text-blue-600\" />\n            </div>\n            <span className=\"text-2xl font-bold text-gray-900\">{stats?.queue?.imported || 0}</span>\n          </div>\n          <p className=\"mt-2 text-sm text-gray-600\">Imported</p>\n        </div>\n\n        <div className=\"bg-white rounded-xl border p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center\">\n              <AlertTriangle className=\"h-5 w-5 text-amber-600\" />\n            </div>\n            <span className=\"text-2xl font-bold text-gray-900\">{stats?.sync?.pending || 0}</span>\n          </div>\n          <p className=\"mt-2 text-sm text-gray-600\">Sync Changes</p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n        {quickActions.map((action) => {\n          const Icon = action.icon;\n          const colors = colorClasses[action.color];\n          \n          return (\n            <Link\n              key={action.href}\n              href={action.href}\n              className={`bg-white rounded-xl border-2 ${colors.border} p-6 hover:shadow-md transition-all group`}\n            >\n              <div className=\"flex items-start justify-between\">\n                <div className={`w-12 h-12 rounded-xl ${colors.bg} flex items-center justify-center`}>\n                  <Icon className={`h-6 w-6 ${colors.text}`} />\n                </div>\n                {action.badge !== undefined && action.badge > 0 && (\n                  <span className={`px-2 py-1 ${colors.bg} ${colors.text} rounded-full text-sm font-medium`}>\n                    {action.badge}\n                  </span>\n                )}\n              </div>\n              \n              <div className=\"mt-4\">\n                <h3 className=\"font-semibold text-gray-900 group-hover:text-blue-600 transition-colors flex items-center gap-2\">\n                  {action.title}\n                  <ArrowRight className=\"h-4 w-4 opacity-0 -translate-x-2 group-hover:opacity-100 group-hover:translate-x-0 transition-all\" />\n                </h3>\n                <p className=\"text-xs text-gray-500 mt-0.5\">{action.titleAr}</p>\n                <p className=\"text-sm text-gray-600 mt-2\">{action.description}</p>\n              </div>\n            </Link>\n          );\n        })}\n      </div>\n\n      <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-6\">\n        <h2 className=\"font-semibold text-gray-900 mb-4\">How Product Import Works</h2>\n        <div className=\"grid grid-cols-4 gap-4\">\n          <div className=\"text-center\">\n            <div className=\"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center mx-auto font-bold\">1</div>\n            <p className=\"text-sm font-medium text-gray-900 mt-2\">Discover</p>\n            <p className=\"text-xs text-gray-500\">Search CJ catalog</p>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center mx-auto font-bold\">2</div>\n            <p className=\"text-sm font-medium text-gray-900 mt-2\">Review</p>\n            <p className=\"text-xs text-gray-500\">Check quality & pricing</p>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center mx-auto font-bold\">3</div>\n            <p className=\"text-sm font-medium text-gray-900 mt-2\">Approve</p>\n            <p className=\"text-xs text-gray-500\">Confirm for import</p>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center mx-auto font-bold\">4</div>\n            <p className=\"text-sm font-medium text-gray-900 mt-2\">Import</p>\n            <p className=\"text-xs text-gray-500\">Add to your store</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8547,"size_tokens":null},"src/app/admin/import/discover/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport type { Route } from \"next\";\nimport { Package, Loader2, CheckCircle, Star, Trash2, Eye, X, Play, TrendingUp, ChevronLeft, ChevronRight, Image as ImageIcon, BarChart3, DollarSign, Grid3X3, FileText, Truck } from \"lucide-react\";\nimport PreviewPageOne from \"@/components/admin/import/preview/PreviewPageOne\";\nimport PreviewPageThree from \"@/components/admin/import/preview/PreviewPageThree\";\nimport PreviewPageFour from \"@/components/admin/import/preview/PreviewPageFour\";\nimport PreviewPageFive from \"@/components/admin/import/preview/PreviewPageFive\";\nimport PreviewPageSix from \"@/components/admin/import/preview/PreviewPageSix\";\nimport type { PricedProduct, PricedVariant } from \"@/components/admin/import/preview/types\";\n\ntype Category = {\n  categoryId: string;\n  categoryName: string;\n  children?: Category[];\n};\n\ntype FeatureOption = {\n  id: string;\n  name: string;\n  parentId?: string;\n  level: number;\n};\n\nexport default function ProductDiscoveryPage() {\n  const [category, setCategory] = useState(\"all\");\n  const [selectedFeatures, setSelectedFeatures] = useState<string[]>([]);\n  const [quantity, setQuantity] = useState(50);\n  const [minStock, setMinStock] = useState(0);\n  const [maxPrice, setMaxPrice] = useState(100);\n  const [minPrice, setMinPrice] = useState(0);\n  const [profitMargin, setProfitMargin] = useState(8);\n  const [popularity, setPopularity] = useState(\"any\");\n  const [minRating, setMinRating] = useState(\"any\");\n  // Always use CJPacket Ordinary - no filter option (100% accuracy requirement)\n  const shippingMethod = \"cjpacket ordinary\";\n  const [freeShippingOnly, setFreeShippingOnly] = useState(false);\n  \n  const [loading, setLoading] = useState(false);\n  const [searchProgress, setSearchProgress] = useState(\"\");\n  const [error, setError] = useState<string | null>(null);\n  const [products, setProducts] = useState<PricedProduct[]>([]);\n  const [selected, setSelected] = useState<Set<string>>(new Set());\n  \n  const [categories, setCategories] = useState<Category[]>([]);\n  const [features, setFeatures] = useState<FeatureOption[]>([]);\n  const [connectionStatus, setConnectionStatus] = useState<{\n    connected: boolean;\n    latency: number;\n    categoryCount: number;\n    message: string;\n  } | null>(null);\n  \n  const [batchName, setBatchName] = useState(\"\");\n  const [saving, setSaving] = useState(false);\n  const [savedBatchId, setSavedBatchId] = useState<number | null>(null);\n  \n  const [previewProduct, setPreviewProduct] = useState<PricedProduct | null>(null);\n  const [previewPage, setPreviewPage] = useState(1);\n  const TOTAL_PREVIEW_PAGES = 6;\n\n  const quantityPresets = [1000, 500, 250, 100, 50, 25, 10];\n  const profitPresets = [100, 50, 25, 15, 8];\n  \n\n  const testConnection = async () => {\n    const start = Date.now();\n    try {\n      const res = await fetch(\"/api/admin/cj/categories\");\n      const data = await res.json();\n      const latency = Date.now() - start;\n      \n      if (data.ok && data.categories) {\n        setCategories(data.categories);\n        setConnectionStatus({\n          connected: true,\n          latency,\n          categoryCount: data.categories.length,\n          message: `Connected successfully. Found ${data.categories.length} category groups.`\n        });\n        \n        const allFeatures: FeatureOption[] = [];\n        const extractFeatures = (cats: Category[], level: number = 0, parentId?: string) => {\n          for (const cat of cats) {\n            allFeatures.push({\n              id: cat.categoryId,\n              name: cat.categoryName,\n              parentId,\n              level,\n            });\n            if (cat.children && cat.children.length > 0) {\n              extractFeatures(cat.children, level + 1, cat.categoryId);\n            }\n          }\n        };\n        extractFeatures(data.categories);\n        setFeatures(allFeatures);\n      } else {\n        setConnectionStatus({\n          connected: false,\n          latency,\n          categoryCount: 0,\n          message: data.error || \"Connection failed\"\n        });\n      }\n    } catch (e: any) {\n      setConnectionStatus({\n        connected: false,\n        latency: Date.now() - start,\n        categoryCount: 0,\n        message: e?.message || \"Connection failed\"\n      });\n    }\n  };\n\n  useEffect(() => {\n    testConnection();\n  }, []);\n\n  const loadFeatures = async (categoryId: string) => {\n    if (categoryId === \"all\") {\n      setSelectedFeatures([]);\n      return;\n    }\n    \n    try {\n      const res = await fetch(`/api/admin/cj/categories?parentId=${categoryId}`);\n      const data = await res.json();\n      if (data.ok && data.categories) {\n        const newFeatures: FeatureOption[] = data.categories.map((cat: Category) => ({\n          id: cat.categoryId,\n          name: cat.categoryName,\n          parentId: categoryId,\n          level: 2,\n        }));\n        setFeatures(prev => {\n          const filtered = prev.filter(f => f.parentId !== categoryId);\n          return [...filtered, ...newFeatures];\n        });\n      }\n    } catch (e) {\n      console.error(\"Failed to load features:\", e);\n    }\n  };\n\n  const searchProducts = async () => {\n    if (category === \"all\" && selectedFeatures.length === 0) {\n      setError(\"Please select a category or feature to search\");\n      return;\n    }\n    \n    setLoading(true);\n    setError(null);\n    setProducts([]);\n    setSelected(new Set());\n    setSavedBatchId(null);\n    setSearchProgress(\"Searching products and calculating prices (estimated 2 min)...\");\n    \n    try {\n      const categoryIds = selectedFeatures.length > 0 ? selectedFeatures : [category];\n      \n      const params = new URLSearchParams({\n        categoryIds: categoryIds.join(\",\"),\n        quantity: quantity.toString(),\n        minPrice: minPrice.toString(),\n        maxPrice: maxPrice.toString(),\n        minStock: minStock.toString(),\n        profitMargin: profitMargin.toString(),\n        popularity: popularity,\n        minRating: minRating,\n        shippingMethod: shippingMethod,\n        freeShippingOnly: freeShippingOnly ? \"1\" : \"0\",\n      });\n      \n      const res = await fetch(`/api/admin/cj/products/search-and-price?${params}`, {\n        method: 'GET',\n      });\n      \n      // Check content-type before parsing JSON to avoid parse errors on timeouts/errors\n      const contentType = res.headers.get('content-type') || '';\n      if (!contentType.includes('application/json')) {\n        const text = await res.text();\n        throw new Error(`Server error: ${text.slice(0, 100)}...`);\n      }\n      \n      const data = await res.json();\n      \n      if (!res.ok || !data.ok) {\n        if (data.quotaExhausted || res.status === 429) {\n          throw new Error(\"CJ Dropshipping API daily limit reached. Please try again tomorrow.\");\n        }\n        throw new Error(data.error || `Search failed: ${res.status}`);\n      }\n      \n      const pricedProducts: PricedProduct[] = data.products || [];\n      setProducts(pricedProducts);\n      \n      // Show warning if quota was hit during processing but some products were retrieved\n      if (data.quotaExhausted && pricedProducts.length > 0) {\n        setError(\"Warning: CJ API limit reached during search. Some products may be missing. Results shown have exact pricing.\");\n      }\n      \n      if (pricedProducts.length === 0) {\n        const debug = data.debug;\n        if (debug) {\n          let msg = `No products with CJPacket Ordinary shipping found.`;\n          if (debug.shippingErrors && Object.keys(debug.shippingErrors).length > 0) {\n            const errorSummary = Object.entries(debug.shippingErrors as Record<string, number>)\n              .map(([err, count]) => `${err}: ${count}`)\n              .join('; ');\n            msg += ` Errors: ${errorSummary}.`;\n          }\n          msg += ' Try a different category.';\n          setError(msg);\n          console.log('Search debug:', debug);\n        } else {\n          setError(\"No products found. Try different filters.\");\n        }\n      }\n      \n    } catch (e: any) {\n      setError(e?.message || \"Search failed\");\n    } finally {\n      setLoading(false);\n      setSearchProgress(\"\");\n    }\n  };\n\n  const toggleSelect = (productId: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setSelected(prev => {\n      const next = new Set(prev);\n      if (next.has(productId)) {\n        next.delete(productId);\n      } else {\n        next.add(productId);\n      }\n      return next;\n    });\n  };\n\n  const selectAll = () => {\n    setSelected(new Set(products.map(p => p.pid)));\n  };\n\n  const deselectAll = () => {\n    setSelected(new Set());\n  };\n\n  const removeProduct = (productId: string, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setProducts(prev => prev.filter(p => p.pid !== productId));\n    setSelected(prev => {\n      const next = new Set(prev);\n      next.delete(productId);\n      return next;\n    });\n  };\n\n  const openPreview = (product: PricedProduct, e: React.MouseEvent) => {\n    e.stopPropagation();\n    setPreviewProduct(product);\n    setPreviewPage(1);\n  };\n\n  const nextPage = () => {\n    if (previewPage < TOTAL_PREVIEW_PAGES) {\n      setPreviewPage(previewPage + 1);\n    }\n  };\n\n  const prevPage = () => {\n    if (previewPage > 1) {\n      setPreviewPage(previewPage - 1);\n    }\n  };\n\n  const getPageTitle = (page: number) => {\n    switch (page) {\n      case 1: return \"Overview\";\n      case 2: return \"Image Gallery\";\n      case 3: return \"Specifications\";\n      case 4: return \"Stock & Popularity\";\n      case 5: return \"Shipping & Delivery\";\n      case 6: return \"Price Details\";\n      default: return \"Product Preview\";\n    }\n  };\n\n  const getPageIcon = (page: number) => {\n    switch (page) {\n      case 1: return <Package className=\"h-4 w-4\" />;\n      case 2: return <Grid3X3 className=\"h-4 w-4\" />;\n      case 3: return <FileText className=\"h-4 w-4\" />;\n      case 4: return <BarChart3 className=\"h-4 w-4\" />;\n      case 5: return <Truck className=\"h-4 w-4\" />;\n      case 6: return <DollarSign className=\"h-4 w-4\" />;\n      default: return null;\n    }\n  };\n\n  const saveBatch = async () => {\n    if (selected.size === 0) return;\n    \n    setSaving(true);\n    try {\n      const selectedProducts = products.filter(p => selected.has(p.pid));\n      const res = await fetch(\"/api/admin/import/batch\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          name: batchName || `Discovery ${new Date().toLocaleDateString()}`,\n          products: selectedProducts.map(p => ({\n            cjProductId: p.pid,\n            cjSku: p.cjSku,\n            name: p.name,\n            images: p.images,\n            minPriceSAR: p.minPriceSAR,\n            maxPriceSAR: p.maxPriceSAR,\n            avgPriceSAR: p.avgPriceSAR,\n            stock: p.stock,\n            variants: p.variants,\n          })),\n        }),\n      });\n      \n      const data = await res.json();\n      if (data.ok && data.batchId) {\n        setSavedBatchId(data.batchId);\n      } else {\n        throw new Error(data.error || \"Failed to save batch\");\n      }\n    } catch (e: any) {\n      setError(e?.message || \"Failed to save batch\");\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const toggleFeature = (featureId: string) => {\n    setSelectedFeatures(prev => {\n      if (prev.includes(featureId)) {\n        return prev.filter(f => f !== featureId);\n      } else {\n        return [...prev, featureId];\n      }\n    });\n  };\n\n  const getFeatureName = (id: string) => {\n    const feature = features.find(f => f.id === id);\n    return feature?.name || id;\n  };\n\n  const getCategoryChildren = (parentId: string) => {\n    return features.filter(f => f.parentId === parentId);\n  };\n\n  const selectedCategory = categories.find(c => c.categoryId === category);\n\n  return (\n    <div className=\"p-6 max-w-7xl mx-auto space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold text-gray-900\">Search Products</h1>\n      </div>\n\n      {connectionStatus && (\n        <div className={`flex items-center gap-3 px-4 py-3 rounded-lg border ${\n          connectionStatus.connected \n            ? \"bg-green-50 border-green-200\" \n            : \"bg-red-50 border-red-200\"\n        }`}>\n          <button\n            onClick={testConnection}\n            className=\"px-4 py-1.5 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50\"\n          >\n            Test Connection\n          </button>\n          <span className=\"text-sm text-gray-600\">{connectionStatus.latency}ms</span>\n          <span className={`text-sm ${connectionStatus.connected ? \"text-green-700\" : \"text-red-700\"}`}>\n            CJ Dropshipping API {connectionStatus.connected ? \"●\" : \"○\"} {connectionStatus.message}\n          </span>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-xl border border-gray-200 p-6 space-y-6\">\n        <div className=\"grid grid-cols-3 gap-6\">\n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Category</label>\n            <select\n              value={category}\n              onChange={(e) => {\n                setCategory(e.target.value);\n                setSelectedFeatures([]);\n                loadFeatures(e.target.value);\n              }}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded\"\n            >\n              <option value=\"all\">All Categories</option>\n              {categories.map(cat => (\n                <option key={cat.categoryId} value={cat.categoryId}>\n                  {cat.categoryName}\n                </option>\n              ))}\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Features ({selectedFeatures.length} selected)</label>\n            <div className=\"relative\">\n              <select\n                onChange={(e) => {\n                  if (e.target.value) toggleFeature(e.target.value);\n                  e.target.value = \"\";\n                }}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded appearance-none\"\n              >\n                <option value=\"\">Select features...</option>\n                {selectedCategory?.children?.map(child => (\n                  <optgroup key={child.categoryId} label={child.categoryName}>\n                    {child.children?.map(subChild => (\n                      <option \n                        key={subChild.categoryId} \n                        value={subChild.categoryId}\n                        disabled={selectedFeatures.includes(subChild.categoryId)}\n                      >\n                        {subChild.categoryName}\n                      </option>\n                    ))}\n                  </optgroup>\n                ))}\n              </select>\n            </div>\n            <div className=\"flex flex-wrap gap-1 mt-2\">\n              {selectedFeatures.map(featureId => (\n                <span\n                  key={featureId}\n                  className=\"inline-flex items-center gap-1 px-2 py-1 bg-amber-100 text-amber-800 rounded-full text-xs\"\n                >\n                  {getFeatureName(featureId)}\n                  <button\n                    onClick={() => toggleFeature(featureId)}\n                    className=\"hover:text-amber-900\"\n                  >\n                    <X className=\"h-3 w-3\" />\n                  </button>\n                </span>\n              ))}\n            </div>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Quantity to Find</label>\n            <div className=\"flex gap-1 mb-2\">\n              {quantityPresets.map(preset => (\n                <button\n                  key={preset}\n                  onClick={() => setQuantity(preset)}\n                  className={`px-2 py-1 text-xs rounded ${\n                    quantity === preset\n                      ? \"bg-amber-500 text-white\"\n                      : \"bg-gray-100 text-gray-700 hover:bg-gray-200\"\n                  }`}\n                >\n                  {preset}\n                </button>\n              ))}\n            </div>\n            <input\n              type=\"number\"\n              value={quantity}\n              onChange={(e) => setQuantity(Number(e.target.value))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-left\"\n              dir=\"ltr\"\n            />\n          </div>\n        </div>\n\n        <div className=\"grid grid-cols-6 gap-4\">\n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Min Price (USD)</label>\n            <input\n              type=\"number\"\n              value={minPrice}\n              onChange={(e) => setMinPrice(Number(e.target.value))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-left\"\n              dir=\"ltr\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Max Price (USD)</label>\n            <input\n              type=\"number\"\n              value={maxPrice}\n              onChange={(e) => setMaxPrice(Number(e.target.value))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-left\"\n              dir=\"ltr\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Min Stock</label>\n            <input\n              type=\"number\"\n              value={minStock}\n              onChange={(e) => setMinStock(Number(e.target.value))}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded text-left\"\n              dir=\"ltr\"\n            />\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2\">Popularity</label>\n            <select\n              value={popularity}\n              onChange={(e) => setPopularity(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded\"\n            >\n              <option value=\"any\">Any Popularity</option>\n              <option value=\"high\">High (1000+ listed)</option>\n              <option value=\"medium\">Medium (100-999 listed)</option>\n              <option value=\"low\">Low (&lt;100 listed)</option>\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2 flex items-center gap-1\">\n              <Star className=\"h-4 w-4 text-amber-500\" />\n              Min Rating\n            </label>\n            <select\n              value={minRating}\n              onChange={(e) => setMinRating(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded\"\n            >\n              <option value=\"any\">Any Rating</option>\n              <option value=\"4.5\">4.5+ Stars</option>\n              <option value=\"4\">4+ Stars</option>\n              <option value=\"3.5\">3.5+ Stars</option>\n              <option value=\"3\">3+ Stars</option>\n            </select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm text-gray-600 mb-2 flex items-center gap-1\">\n              <Truck className=\"h-4 w-4 text-blue-500\" />\n              Shipping Method\n            </label>\n            <div className=\"w-full px-3 py-2 border border-blue-300 rounded bg-blue-50 text-blue-800 font-medium\">\n              CJPacket Ordinary (7-12 days)\n            </div>\n            <p className=\"text-xs text-gray-500 mt-1\">Fixed for 100% accuracy</p>\n          </div>\n          \n        </div>\n        \n\n        <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <span className=\"text-sm text-amber-700 font-medium\">*Profit Margin % ({profitMargin}%)</span>\n              <div className=\"flex gap-1\">\n                {profitPresets.map(preset => (\n                  <button\n                    key={preset}\n                    onClick={() => setProfitMargin(preset)}\n                    className={`px-3 py-1.5 text-sm rounded ${\n                      profitMargin === preset\n                        ? \"bg-amber-500 text-white font-medium\"\n                        : \"bg-white border border-gray-300 text-gray-700 hover:bg-gray-50\"\n                    }`}\n                  >\n                    {preset}%\n                  </button>\n                ))}\n              </div>\n              <span className=\"text-gray-400\">%</span>\n              <input\n                type=\"number\"\n                value={profitMargin}\n                onChange={(e) => setProfitMargin(Number(e.target.value))}\n                className=\"w-16 px-2 py-1.5 border border-gray-300 rounded text-center\"\n                dir=\"ltr\"\n              />\n            </div>\n            \n            <div className=\"flex items-center gap-4\">\n              <input\n                type=\"checkbox\"\n                checked={freeShippingOnly}\n                onChange={(e) => setFreeShippingOnly(e.target.checked)}\n                className=\"w-4 h-4 border-gray-300 rounded\"\n              />\n              <label className=\"text-sm text-gray-700\">Free Shipping Only</label>\n            </div>\n          </div>\n          <p className=\"text-xs text-amber-600 mt-2 text-right\">\n            Set your desired profit margin. Products will display final USD sell prices including shipping + profit when search completes.\n          </p>\n        </div>\n\n        <div className=\"flex items-center justify-end gap-3 pt-4 border-t border-gray-200\">\n          <Link\n            href={\"/admin/import/queue\" as Route}\n            className=\"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm\"\n          >\n            Review Queue\n          </Link>\n          <button\n            onClick={searchProducts}\n            disabled={loading}\n            className=\"flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm font-medium\"\n          >\n            {loading && <Loader2 className=\"h-4 w-4 animate-spin\" />}\n            Search Products\n          </button>\n        </div>\n      </div>\n\n      {loading && searchProgress && (\n        <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4\">\n          <div className=\"flex items-center gap-3\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-amber-600\" />\n            <div className=\"flex-1\">\n              <div className=\"h-2 bg-amber-200 rounded-full overflow-hidden\">\n                <div className=\"h-full bg-amber-500 rounded-full animate-pulse\" style={{ width: '60%' }} />\n              </div>\n            </div>\n            <span className=\"text-sm text-amber-700\">{searchProgress}</span>\n          </div>\n          <p className=\"text-xs text-amber-600 mt-2\">\n            Searching products, calculating shipping costs, and applying {profitMargin}% profit margin. Products will display final USD sell prices including shipping + profit when search completes.\n          </p>\n        </div>\n      )}\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-800 flex items-center justify-between\">\n          <span>{error}</span>\n          <button onClick={() => setError(null)} className=\"text-red-600 hover:text-red-800\">\n            <X className=\"h-4 w-4\" />\n          </button>\n        </div>\n      )}\n\n      {products.length > 0 && (\n        <>\n          <div className=\"flex items-center justify-between bg-white border border-gray-200 rounded-lg p-4\">\n            <div className=\"flex items-center gap-4\">\n              <span className=\"text-sm text-gray-900\">\n                Found <strong>{products.length}</strong> products with prices\n              </span>\n              <span className=\"text-sm text-gray-400\">|</span>\n              <span className=\"text-sm text-gray-600\">\n                <strong>{selected.size}</strong> selected\n              </span>\n            </div>\n            <div className=\"flex items-center gap-3\">\n              <button onClick={selectAll} className=\"text-sm text-blue-600 hover:underline\">Select All</button>\n              <button onClick={deselectAll} className=\"text-sm text-gray-500 hover:underline\">Clear</button>\n            </div>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n            {products.map((product) => {\n              const isSelected = selected.has(product.pid);\n              \n              return (\n                <div\n                  key={product.pid}\n                  className={`bg-white rounded-xl border-2 overflow-hidden transition-all ${\n                    isSelected ? \"border-blue-500 ring-2 ring-blue-100\" : \"border-gray-100 hover:border-gray-200\"\n                  }`}\n                >\n                  <div className=\"relative aspect-square bg-gray-100\">\n                    {product.images?.[0] ? (\n                      <img\n                        src={product.images[0]}\n                        alt={product.name}\n                        className=\"w-full h-full object-cover\"\n                        onError={(e) => {\n                          (e.target as HTMLImageElement).style.display = 'none';\n                        }}\n                      />\n                    ) : (\n                      <div className=\"w-full h-full flex items-center justify-center text-gray-400\">\n                        <Package className=\"h-12 w-12\" />\n                      </div>\n                    )}\n                    \n                    <div className=\"absolute top-2 right-2 flex items-center gap-1\">\n                      <button\n                        onClick={(e) => toggleSelect(product.pid, e)}\n                        className={`w-6 h-6 rounded-full flex items-center justify-center transition-colors ${\n                          isSelected ? \"bg-blue-500\" : \"bg-white border border-gray-300 hover:bg-gray-100\"\n                        }`}\n                      >\n                        {isSelected && <CheckCircle className=\"h-4 w-4 text-white\" />}\n                      </button>\n                    </div>\n                    \n                    <div className=\"absolute top-2 left-2 flex gap-1\">\n                      <button\n                        onClick={(e) => openPreview(product, e)}\n                        className=\"w-7 h-7 bg-white/90 rounded-full flex items-center justify-center hover:bg-white\"\n                        title=\"Preview\"\n                      >\n                        <Eye className=\"h-3.5 w-3.5 text-gray-700\" />\n                      </button>\n                      <button\n                        onClick={(e) => removeProduct(product.pid, e)}\n                        className=\"w-7 h-7 bg-white/90 rounded-full flex items-center justify-center hover:bg-red-50\"\n                        title=\"Remove\"\n                      >\n                        <Trash2 className=\"h-3.5 w-3.5 text-red-500\" />\n                      </button>\n                    </div>\n                    \n                    <div className=\"absolute bottom-2 right-2 flex items-center gap-1 px-2 py-1 bg-black/70 rounded text-xs text-white\">\n                      <TrendingUp className=\"h-3 w-3\" />\n                      {product.listedNum || 0}\n                    </div>\n                  </div>\n                  \n                  <div className=\"p-3 space-y-2\">\n                    <h3 className=\"font-medium text-gray-900 text-sm line-clamp-2 leading-tight\" dir=\"ltr\">\n                      {product.name}\n                    </h3>\n                    <p className=\"text-xs text-gray-400 font-mono\" title={product.cjSku}>\n                      SKU: {product.cjSku.length > 12 ? `...${product.cjSku.slice(-8)}` : product.cjSku}\n                    </p>\n                    \n                    <div className=\"bg-green-50 rounded-lg p-2\">\n                      <div className=\"flex justify-between items-center\">\n                        <span className=\"text-xs text-gray-600\">Sell Price</span>\n                        <span className=\"font-bold text-green-700 text-lg\">\n                          {(() => {\n                            // Calculate final sell price from first available variant\n                            const availableVariants = product.variants.filter((v: any) => v.shippingAvailable);\n                            const firstVariant = availableVariants[0];\n                            if (firstVariant) {\n                              const productCostUSD = firstVariant.variantPriceUSD || 0;\n                              const shippingCostUSD = firstVariant.shippingPriceUSD || 0;\n                              const totalCostUSD = productCostUSD + shippingCostUSD;\n                              const sellPriceUSD = totalCostUSD / (1 - 0.08);\n                              return `$${sellPriceUSD.toFixed(2)}`;\n                            }\n                            return \"N/A\";\n                          })()}\n                        </span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                      <div className=\"flex flex-col\">\n                        <span className=\"text-gray-500\">Stock</span>\n                        <span className={`font-semibold ${(product.stock ?? 0) > 0 ? \"text-gray-900\" : \"text-red-500\"}`}>\n                          {product.stock ?? \"-\"}\n                        </span>\n                      </div>\n                      <div className=\"flex flex-col\">\n                        <span className=\"text-gray-500\">Variants</span>\n                        <span className=\"font-semibold text-gray-900\">\n                          {product.successfulVariants}/{product.totalVariants}\n                        </span>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          {selected.size > 0 && (\n            <div className=\"sticky bottom-4 bg-white rounded-xl border shadow-lg p-4 flex items-center justify-between\">\n              <div className=\"flex items-center gap-4\">\n                <div className=\"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center\">\n                  <Package className=\"h-5 w-5 text-blue-600\" />\n                </div>\n                <div>\n                  <p className=\"font-medium text-gray-900\">{selected.size} products selected</p>\n                  <p className=\"text-sm text-gray-500\">Ready to add to import queue</p>\n                </div>\n              </div>\n              \n              <div className=\"flex items-center gap-3\">\n                <input\n                  type=\"text\"\n                  value={batchName}\n                  onChange={(e) => setBatchName(e.target.value)}\n                  placeholder=\"Batch name (optional)\"\n                  className=\"px-3 py-2 border rounded-lg text-sm w-48\"\n                  dir=\"ltr\"\n                />\n                <button\n                  onClick={saveBatch}\n                  disabled={saving}\n                  className=\"flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50\"\n                >\n                  {saving ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <CheckCircle className=\"h-4 w-4\" />}\n                  Add to Queue\n                </button>\n              </div>\n            </div>\n          )}\n\n          {savedBatchId && (\n            <div className=\"rounded-lg bg-green-50 border border-green-200 p-4 flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <CheckCircle className=\"h-5 w-5 text-green-600\" />\n                <span className=\"text-green-800\">\n                  {selected.size} products added to queue successfully!\n                </span>\n              </div>\n              <Link\n                href={\"/admin/import/queue\" as Route}\n                className=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm\"\n              >\n                View Queue\n              </Link>\n            </div>\n          )}\n        </>\n      )}\n\n      {previewProduct && (\n        <div className=\"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4\" onClick={() => setPreviewProduct(null)}>\n          <div className=\"bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col\" onClick={(e) => e.stopPropagation()}>\n            {/* Header with page navigation */}\n            <div className=\"bg-white border-b p-4 flex items-center justify-between shrink-0\">\n              <div className=\"flex items-center gap-3\">\n                {getPageIcon(previewPage)}\n                <h3 className=\"text-lg font-semibold\">{getPageTitle(previewPage)}</h3>\n              </div>\n              \n              {/* Page indicator and navigation */}\n              <div className=\"flex items-center gap-4\">\n                <div className=\"flex items-center gap-2\">\n                  <button \n                    onClick={prevPage}\n                    disabled={previewPage === 1}\n                    className={`p-2 rounded-full transition-colors ${\n                      previewPage === 1 \n                        ? \"text-gray-300 cursor-not-allowed\" \n                        : \"text-gray-600 hover:bg-gray-100\"\n                    }`}\n                  >\n                    <ChevronLeft className=\"h-5 w-5\" />\n                  </button>\n                  \n                  {/* Page dots */}\n                  <div className=\"flex items-center gap-1.5\">\n                    {Array.from({ length: TOTAL_PREVIEW_PAGES }, (_, i) => (\n                      <button\n                        key={i}\n                        onClick={() => setPreviewPage(i + 1)}\n                        className={`w-2.5 h-2.5 rounded-full transition-all ${\n                          previewPage === i + 1 \n                            ? \"bg-blue-600 w-6\" \n                            : \"bg-gray-300 hover:bg-gray-400\"\n                        }`}\n                      />\n                    ))}\n                  </div>\n                  \n                  <button \n                    onClick={nextPage}\n                    disabled={previewPage === TOTAL_PREVIEW_PAGES}\n                    className={`p-2 rounded-full transition-colors ${\n                      previewPage === TOTAL_PREVIEW_PAGES \n                        ? \"text-gray-300 cursor-not-allowed\" \n                        : \"text-gray-600 hover:bg-gray-100\"\n                    }`}\n                  >\n                    <ChevronRight className=\"h-5 w-5\" />\n                  </button>\n                </div>\n                \n                <span className=\"text-sm text-gray-500 font-medium\">\n                  {previewPage} / {TOTAL_PREVIEW_PAGES}\n                </span>\n                \n                <button onClick={() => setPreviewProduct(null)} className=\"p-2 hover:bg-gray-100 rounded-full ml-2\">\n                  <X className=\"h-5 w-5\" />\n                </button>\n              </div>\n            </div>\n            \n            {/* Page content */}\n            <div className=\"p-6 overflow-y-auto flex-1\">\n              {/* Page 1: Product Overview */}\n              {previewPage === 1 && (\n                <PreviewPageOne product={previewProduct} />\n              )}\n              \n              {/* Page 2: Image Gallery */}\n              {previewPage === 2 && (\n                <div className=\"space-y-4\">\n                  <div className=\"flex items-center justify-between mb-4\">\n                    <h4 className=\"font-medium text-gray-900\">All Product Images ({previewProduct.images?.length || 0})</h4>\n                  </div>\n                  \n                  {previewProduct.images && previewProduct.images.length > 0 ? (\n                    <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                      {previewProduct.images.map((img, index) => (\n                        <div key={index} className=\"relative aspect-square bg-gray-100 rounded-lg overflow-hidden group\">\n                          <img \n                            src={img} \n                            alt={`${previewProduct.name} - Image ${index + 1}`}\n                            className=\"w-full h-full object-cover transition-transform group-hover:scale-105\"\n                            onError={(e) => {\n                              (e.target as HTMLImageElement).style.display = 'none';\n                            }}\n                          />\n                          <div className=\"absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded\">\n                            {index + 1}\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"flex flex-col items-center justify-center py-12 text-gray-400\">\n                      <ImageIcon className=\"h-12 w-12 mb-3\" />\n                      <p>No images available</p>\n                    </div>\n                  )}\n                </div>\n              )}\n              \n              {/* Page 3: Product Specifications */}\n              {previewPage === 3 && (\n                <PreviewPageThree product={previewProduct} />\n              )}\n              \n              {/* Page 4: Stock & Popularity */}\n              {previewPage === 4 && (\n                <PreviewPageFour product={previewProduct} />\n              )}\n\n              {/* Page 5: Shipping & Delivery */}\n              {previewPage === 5 && (\n                <PreviewPageFive product={previewProduct} />\n              )}\n              \n              {/* Page 6: Variant Pricing */}\n              {previewPage === 6 && (\n                <PreviewPageSix product={previewProduct} />\n              )}\n            </div>\n            \n            {/* Footer navigation */}\n            <div className=\"bg-gray-50 border-t p-4 flex items-center justify-between shrink-0\">\n              <button \n                onClick={prevPage}\n                disabled={previewPage === 1}\n                className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${\n                  previewPage === 1 \n                    ? \"text-gray-400 cursor-not-allowed\" \n                    : \"text-gray-700 hover:bg-gray-200\"\n                }`}\n              >\n                <ChevronLeft className=\"h-4 w-4\" />\n                Previous\n              </button>\n              \n              <div className=\"text-sm text-gray-500\">\n                Page {previewPage} of {TOTAL_PREVIEW_PAGES}\n              </div>\n              \n              <button \n                onClick={nextPage}\n                disabled={previewPage === TOTAL_PREVIEW_PAGES}\n                className={`flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${\n                  previewPage === TOTAL_PREVIEW_PAGES \n                    ? \"text-gray-400 cursor-not-allowed\" \n                    : \"bg-blue-600 text-white hover:bg-blue-700\"\n                }`}\n              >\n                Next\n                <ChevronRight className=\"h-4 w-4\" />\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":39481,"size_tokens":null},"src/app/api/admin/cj/products/variants/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { queryVariantInventory } from \"@/lib/cj/v2\";\nimport { ensureAdmin } from \"@/lib/auth/admin-guard\";\n\nexport const dynamic = \"force-dynamic\";\n\nexport async function GET(req: NextRequest) {\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json({ ok: false, error: guard.reason }, { status: 401 });\n    }\n    \n    const { searchParams } = new URL(req.url);\n    const pid = searchParams.get(\"pid\");\n    const warehouse = searchParams.get(\"warehouse\") || undefined;\n    \n    if (!pid) {\n      return NextResponse.json({ ok: false, error: \"Missing pid parameter\" }, { status: 400 });\n    }\n    \n    const variants = await queryVariantInventory(pid, warehouse);\n    \n    return NextResponse.json({\n      ok: true,\n      pid,\n      variants,\n      total: variants.length,\n    });\n  } catch (e: any) {\n    console.error(\"Variant inventory fetch error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Failed to fetch variants\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":1075,"size_tokens":null},"src/app/api/webhooks/stripe/route.ts":{"content":"export const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\nexport const revalidate = 0;\n\nimport { handleStripeWebhook } from \"@/lib/webhooks/stripe-handler\";\n\nexport async function POST(req: Request) {\n  return handleStripeWebhook(req);\n}\n\nexport async function GET() {\n  return new Response('OK');\n}\n","path":null,"size_bytes":315,"size_tokens":null},"src/lib/webhooks/stripe-handler.ts":{"content":"import Stripe from 'stripe'\n\nfunction getStripe() {\n  return new Stripe(process.env.STRIPE_SECRET_KEY || '')\n}\n\nexport async function handleStripeWebhook(req: Request): Promise<Response> {\n  const secret = process.env.STRIPE_WEBHOOK_SECRET\n  if (!secret || !process.env.STRIPE_SECRET_KEY) return new Response('Stripe not configured', { status: 501 })\n  \n  const stripe = getStripe()\n  const sig = req.headers.get('stripe-signature') || ''\n  const body = await req.text()\n  let event: Stripe.Event\n  try {\n    event = stripe.webhooks.constructEvent(body, sig, secret)\n  } catch {\n    return new Response('Invalid signature', { status: 400 })\n  }\n  try {\n    switch (event.type) {\n      case 'checkout.session.completed':\n      case 'payment_intent.succeeded':\n      case 'charge.refunded':\n      default:\n        break\n    }\n    return new Response('ok')\n  } catch {\n    return new Response('Webhook error', { status: 500 })\n  }\n}\n","path":null,"size_bytes":930,"size_tokens":null},"src/lib/i18n/LanguageContext.tsx":{"content":"\"use client\";\n\nimport { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { translations, Language, getTranslations, isRtl } from './translations';\n\ntype TranslationType = typeof translations.en;\n\ninterface LanguageContextType {\n  lang: Language;\n  setLang: (lang: Language) => void;\n  t: TranslationType;\n  isRtl: boolean;\n  dir: 'ltr' | 'rtl';\n}\n\nconst LanguageContext = createContext<LanguageContextType | undefined>(undefined);\n\nexport function LanguageProvider({ children }: { children: ReactNode }) {\n  const [lang, setLangState] = useState<Language>('en');\n\n  useEffect(() => {\n    const stored = localStorage.getItem('admin_lang') as Language;\n    if (stored && (stored === 'en' || stored === 'ar')) {\n      setLangState(stored);\n    }\n  }, []);\n\n  const setLang = (newLang: Language) => {\n    setLangState(newLang);\n    localStorage.setItem('admin_lang', newLang);\n  };\n\n  const t = getTranslations(lang);\n  const rtl = isRtl(lang);\n\n  return (\n    <LanguageContext.Provider value={{ \n      lang, \n      setLang, \n      t, \n      isRtl: rtl, \n      dir: rtl ? 'rtl' : 'ltr' \n    }}>\n      {children}\n    </LanguageContext.Provider>\n  );\n}\n\nexport function useLanguage() {\n  const context = useContext(LanguageContext);\n  if (context === undefined) {\n    throw new Error('useLanguage must be used within a LanguageProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":1389,"size_tokens":null},"src/app/api/admin/import/batch/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { ensureAdmin } from \"@/lib/auth/admin-guard\";\nimport { \n  isImportDbConfigured, \n  testImportDbConnection, \n  createImportBatch, \n  addProductToQueue, \n  logImportAction,\n  getBatches \n} from \"@/lib/db/import-db\";\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req: NextRequest) {\n  console.log('[Import Batch] POST request received');\n  try {\n    const guard = await ensureAdmin();\n    console.log('[Import Batch] Admin guard result:', guard.ok ? 'authenticated' : guard.reason);\n    if (!guard.ok) {\n      return NextResponse.json({ ok: false, error: guard.reason }, { status: 401 });\n    }\n    \n    if (!isImportDbConfigured()) {\n      console.error('[Import Batch] Supabase not configured');\n      return NextResponse.json({ ok: false, error: \"Database not configured. Please contact support.\" }, { status: 500 });\n    }\n    \n    console.log('[Import Batch] Database configured, testing connection...');\n    const connTest = await testImportDbConnection();\n    if (!connTest.ok) {\n      console.error('[Import Batch] Database connection test failed:', connTest.error);\n      return NextResponse.json({ ok: false, error: connTest.error || \"Database connection failed\" }, { status: 500 });\n    }\n    \n    console.log('[Import Batch] Database connection verified, processing batch...');\n    \n    const body = await req.json();\n    const { name, keywords, category, filters, products } = body;\n    \n    if (!products || !Array.isArray(products) || products.length === 0) {\n      return NextResponse.json({ ok: false, error: \"No products provided\" }, { status: 400 });\n    }\n\n    const batch = await createImportBatch({\n      name: name || `Import ${new Date().toISOString()}`,\n      keywords: keywords || \"\",\n      category: category || \"General\",\n      filters: filters || {},\n      productsFound: products.length,\n    });\n\n    if (!batch) {\n      console.error(\"Failed to create batch\");\n      return NextResponse.json({ ok: false, error: \"Failed to create batch\" }, { status: 500 });\n    }\n\n    let addedCount = 0;\n    let failedCount = 0;\n    const failedProducts: string[] = [];\n    const errorMessages: string[] = [];\n    \n    for (const p of products) {\n      // Calculate average price from variants, or use provided avgPriceSAR\n      let avgPrice = p.avgPriceSAR || 0;\n      if (!avgPrice && p.variants?.length > 0) {\n        avgPrice = p.variants.reduce((sum: number, v: any) => sum + (v.price || v.variantSellPrice || 0), 0) / p.variants.length;\n      }\n      \n      // Calculate total stock from variants, or use provided stock\n      let totalStock = p.stock || 0;\n      if (!totalStock && p.variants?.length > 0) {\n        totalStock = p.variants.reduce((sum: number, v: any) => sum + (v.stock || v.variantQuantity || 0), 0);\n      }\n      \n      const productId = p.cjProductId || p.pid || p.productId;\n      \n      // Handle images - could be array or single image\n      let images: string[] = [];\n      if (Array.isArray(p.images)) {\n        images = p.images;\n      } else if (p.image) {\n        images = [p.image];\n      }\n\n      const result = await addProductToQueue(batch.id, {\n        productId,\n        cjSku: p.cjSku || p.variants?.[0]?.cjSku || p.variants?.[0]?.variantSku || undefined,\n        name: p.name || \"Untitled\",\n        description: p.description || undefined,\n        category: category || \"General\",\n        images,\n        videoUrl: p.videoUrl || undefined,\n        variants: p.variants || [],\n        avgPrice,\n        supplierRating: p.supplierRating || 4.0,\n        totalSales: p.totalSales || 0,\n        totalStock,\n        processingDays: p.processingDays || 3,\n        deliveryDaysMin: p.deliveryDaysMin || 7,\n        deliveryDaysMax: p.deliveryDaysMax || 15,\n        qualityScore: p.qualityScore || 0.75,\n      });\n\n      if (result.success) {\n        addedCount++;\n      } else {\n        failedCount++;\n        failedProducts.push(productId);\n        if (result.error && errorMessages.length < 3) {\n          errorMessages.push(result.error);\n        }\n      }\n    }\n    \n    if (addedCount === 0 && products.length > 0) {\n      const errorDetail = errorMessages.length > 0 \n        ? ` First error: ${errorMessages[0]}`\n        : '';\n      return NextResponse.json({ \n        ok: false, \n        error: `Failed to add any products to queue. ${failedCount} products failed.${errorDetail}`,\n        failedProducts: failedProducts.slice(0, 10),\n        errorDetails: errorMessages\n      }, { status: 500 });\n    }\n\n    await logImportAction(batch.id, \"batch_created\", \"success\", { \n      products_count: products.length, \n      keywords, \n      category \n    });\n\n    return NextResponse.json({\n      ok: true,\n      batchId: batch.id,\n      productsAdded: addedCount,\n      productsFailed: failedCount,\n      ...(failedCount > 0 && { warning: `${failedCount} products failed to add` }),\n    });\n  } catch (e: any) {\n    console.error(\"Batch creation error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function GET() {\n  try {\n    const batches = await getBatches(50);\n    return NextResponse.json({ ok: true, batches });\n  } catch (e: any) {\n    console.error(\"Failed to fetch batches:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":5444,"size_tokens":null},"src/app/api/admin/import/queue/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { calculateRetailSar, usdToSar } from \"@/lib/pricing\";\n\nexport const runtime = 'nodejs';\nexport const dynamic = 'force-dynamic';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nfunction isDbConfigured(): boolean {\n  return !!(process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.SUPABASE_SERVICE_ROLE_KEY);\n}\n\nexport async function GET(req: NextRequest) {\n  try {\n    if (!isDbConfigured()) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return NextResponse.json({ ok: false, error: \"Database connection failed\" }, { status: 500 });\n    }\n\n    const { searchParams } = new URL(req.url);\n    const status = searchParams.get(\"status\") || \"pending\";\n    const batchId = searchParams.get(\"batch_id\");\n    const category = searchParams.get(\"category\");\n    const limit = Math.min(100, Number(searchParams.get(\"limit\") || 50));\n    const offset = Number(searchParams.get(\"offset\") || 0);\n\n    let query = supabase.from('product_queue').select('*');\n    \n    if (status !== \"all\") {\n      query = query.eq('status', status);\n    }\n    if (batchId) {\n      query = query.eq('batch_id', Number(batchId));\n    }\n    if (category && category !== \"all\") {\n      query = query.eq('category', category);\n    }\n\n    query = query.order('quality_score', { ascending: false })\n                 .order('created_at', { ascending: false })\n                 .range(offset, offset + limit - 1);\n\n    const { data: products, error: queryError } = await query;\n\n    if (queryError) {\n      console.error(\"[Queue GET] Query error:\", queryError);\n      if (queryError.message.includes('does not exist')) {\n        return NextResponse.json({ \n          ok: false, \n          error: \"Import tables not found. Please run the database migration first.\" \n        }, { status: 500 });\n      }\n      return NextResponse.json({ ok: false, error: queryError.message }, { status: 500 });\n    }\n\n    const { count: totalCount } = await supabase\n      .from('product_queue')\n      .select('*', { count: 'exact', head: true })\n      .eq('status', status === \"all\" ? \"pending\" : status);\n\n    const [pendingRes, approvedRes, rejectedRes, importedRes] = await Promise.all([\n      supabase.from('product_queue').select('*', { count: 'exact', head: true }).eq('status', 'pending'),\n      supabase.from('product_queue').select('*', { count: 'exact', head: true }).eq('status', 'approved'),\n      supabase.from('product_queue').select('*', { count: 'exact', head: true }).eq('status', 'rejected'),\n      supabase.from('product_queue').select('*', { count: 'exact', head: true }).eq('status', 'imported'),\n    ]);\n\n    const stats = {\n      pending: pendingRes.count || 0,\n      approved: approvedRes.count || 0,\n      rejected: rejectedRes.count || 0,\n      imported: importedRes.count || 0,\n    };\n\n    return NextResponse.json({\n      ok: true,\n      products: products || [],\n      total: totalCount || 0,\n      stats,\n    });\n  } catch (e: any) {\n    console.error(\"[Queue GET] Error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function PATCH(req: NextRequest) {\n  try {\n    if (!isDbConfigured()) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return NextResponse.json({ ok: false, error: \"Database connection failed\" }, { status: 500 });\n    }\n\n    const body = await req.json();\n    const { ids, action, data } = body;\n\n    if (!ids || !Array.isArray(ids) || ids.length === 0) {\n      return NextResponse.json({ ok: false, error: \"No product IDs provided\" }, { status: 400 });\n    }\n\n    let updateData: Record<string, any> = { updated_at: new Date().toISOString() };\n\n    switch (action) {\n      case \"approve\":\n        updateData.status = 'approved';\n        updateData.reviewed_at = new Date().toISOString();\n        break;\n      case \"reject\":\n        updateData.status = 'rejected';\n        updateData.reviewed_at = new Date().toISOString();\n        break;\n      case \"pending\":\n        updateData.status = 'pending';\n        updateData.reviewed_at = null;\n        break;\n      case \"update\":\n        if (data) {\n          if (data.name_en) updateData.name_en = data.name_en;\n          if (data.name_ar) updateData.name_ar = data.name_ar;\n          if (data.description_en) updateData.description_en = data.description_en;\n          if (data.description_ar) updateData.description_ar = data.description_ar;\n          if (data.category) updateData.category = data.category;\n          if (data.admin_notes !== undefined) updateData.admin_notes = data.admin_notes;\n          if (data.calculated_retail_sar) updateData.calculated_retail_sar = data.calculated_retail_sar;\n          if (data.margin_applied) updateData.margin_applied = data.margin_applied;\n        }\n        break;\n      default:\n        return NextResponse.json({ ok: false, error: \"Invalid action\" }, { status: 400 });\n    }\n\n    const { error: updateError } = await supabase\n      .from('product_queue')\n      .update(updateData)\n      .in('id', ids);\n\n    if (updateError) {\n      console.error(\"[Queue PATCH] Update error:\", updateError);\n      return NextResponse.json({ ok: false, error: updateError.message }, { status: 500 });\n    }\n\n    try {\n      await supabase.from('import_logs').insert({\n        action: `queue_${action}`,\n        status: 'success',\n        details: { ids, action, data }\n      });\n    } catch (logErr) {\n      console.error(\"[Queue PATCH] Log error:\", logErr);\n    }\n\n    return NextResponse.json({ ok: true, updated: ids.length });\n  } catch (e: any) {\n    console.error(\"[Queue PATCH] Error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function DELETE(req: NextRequest) {\n  try {\n    if (!isDbConfigured()) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return NextResponse.json({ ok: false, error: \"Database connection failed\" }, { status: 500 });\n    }\n\n    const { searchParams } = new URL(req.url);\n    const idsParam = searchParams.get(\"ids\");\n\n    if (!idsParam) {\n      return NextResponse.json({ ok: false, error: \"No IDs provided\" }, { status: 400 });\n    }\n\n    const ids = idsParam.split(\",\").map(Number).filter(n => !isNaN(n));\n    if (ids.length === 0) {\n      return NextResponse.json({ ok: false, error: \"Invalid IDs\" }, { status: 400 });\n    }\n\n    const { error: deleteError } = await supabase\n      .from('product_queue')\n      .delete()\n      .in('id', ids);\n\n    if (deleteError) {\n      console.error(\"[Queue DELETE] Delete error:\", deleteError);\n      return NextResponse.json({ ok: false, error: deleteError.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true, deleted: ids.length });\n  } catch (e: any) {\n    console.error(\"[Queue DELETE] Error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":7489,"size_tokens":null},"src/app/api/admin/sync/run/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\nimport { queryProductByPidOrKeyword, mapCjItemToProductLike } from \"@/lib/cj/v2\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nconst SAFETY_BUFFER = 5;\nconst USD_TO_SAR = 3.75;\nconst DEFAULT_VAT_PERCENT = 15;\nconst DEFAULT_PAYMENT_FEE_PERCENT = 2.9;\nconst DEFAULT_MARGIN_PERCENT = 40;\nconst DEFAULT_MIN_PROFIT_SAR = 35;\nconst DEFAULT_SHIPPING_USD = 5;\n\nasync function recalculatePrice(costUsd: number, shippingUsd: number, category: string, admin: any): Promise<number> {\n  const { data: categoryRule } = await admin\n    .from(\"pricing_rules\")\n    .select(\"*\")\n    .eq(\"category\", category)\n    .maybeSingle();\n\n  const { data: defaultRule } = await admin\n    .from(\"pricing_rules\")\n    .select(\"*\")\n    .eq(\"is_default\", true)\n    .maybeSingle();\n\n  const rule = categoryRule || defaultRule || {\n    margin_percent: DEFAULT_MARGIN_PERCENT,\n    min_profit_sar: DEFAULT_MIN_PROFIT_SAR,\n    vat_percent: DEFAULT_VAT_PERCENT,\n    payment_fee_percent: DEFAULT_PAYMENT_FEE_PERCENT,\n    smart_rounding_enabled: true,\n    rounding_targets: [49, 79, 99, 149, 199, 249, 299],\n  };\n  const vatPercent = rule.vat_percent ?? DEFAULT_VAT_PERCENT;\n  const paymentFeePercent = rule.payment_fee_percent ?? DEFAULT_PAYMENT_FEE_PERCENT;\n  const marginPercent = rule.margin_percent ?? DEFAULT_MARGIN_PERCENT;\n  const minProfitSar = rule.min_profit_sar ?? DEFAULT_MIN_PROFIT_SAR;\n\n  const baseSar = costUsd * USD_TO_SAR;\n  const shippingSar = shippingUsd * USD_TO_SAR;\n  const subtotal = baseSar + shippingSar;\n  const vat = subtotal * (vatPercent / 100);\n  const afterVat = subtotal + vat;\n  const paymentFee = afterVat * (paymentFeePercent / 100);\n  const landed = afterVat + paymentFee;\n  const margin = landed * (marginPercent / 100);\n  let retailSar = landed + margin;\n\n  if (rule.smart_rounding_enabled && rule.rounding_targets?.length > 0) {\n    const targets = (rule.rounding_targets as number[]).sort((a, b) => a - b);\n    const closest = targets.find(t => t >= retailSar) || targets[targets.length - 1];\n    retailSar = closest;\n  } else {\n    retailSar = Math.ceil(retailSar);\n  }\n\n  const profit = retailSar - landed;\n  if (profit < minProfitSar) {\n    retailSar = landed + minProfitSar;\n    if (rule.smart_rounding_enabled && rule.rounding_targets?.length > 0) {\n      const targets = (rule.rounding_targets as number[]).sort((a, b) => a - b);\n      const closest = targets.find(t => t >= retailSar) || targets[targets.length - 1];\n      retailSar = closest;\n    }\n  }\n\n  return Math.round(retailSar);\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const body = await req.json().catch(() => ({}));\n    const autoApply = body.autoApply !== false;\n\n    const { data: products } = await admin\n      .from(\"products\")\n      .select(\"id, title, price, stock, active, category, metadata\")\n      .not(\"metadata->cj_product_id\", \"is\", null)\n      .order(\"updated_at\", { ascending: true })\n      .limit(200);\n\n    if (!products || products.length === 0) {\n      return NextResponse.json({ ok: true, message: \"No CJ products to sync\", changes: 0 });\n    }\n\n    let changesDetected = 0;\n    let priceUpdates = 0;\n    let stockUpdates = 0;\n    let errors = 0;\n\n    for (const product of products) {\n      const cjProductId = product.metadata?.cj_product_id;\n      if (!cjProductId) continue;\n\n      try {\n        const result = await queryProductByPidOrKeyword({ pid: cjProductId });\n        const cjProducts = result?.data?.content || result?.data?.list || [];\n        \n        if (cjProducts.length === 0) {\n          errors++;\n          continue;\n        }\n\n        const mapped = mapCjItemToProductLike(cjProducts[0]);\n        if (!mapped) {\n          errors++;\n          continue;\n        }\n\n        const avgCostUsd = mapped.variants.length > 0\n          ? mapped.variants.reduce((sum, v) => sum + (v.price || 0), 0) / mapped.variants.length\n          : 0;\n        const totalCjStock = mapped.variants.reduce((sum, v) => sum + (v.stock || 0), 0);\n        const adjustedStock = Math.max(0, totalCjStock - SAFETY_BUFFER);\n\n        const currentPrice = product.price ?? 0;\n        const currentStock = product.stock ?? 0;\n        const shippingUsd = product.metadata?.shipping_usd ?? DEFAULT_SHIPPING_USD;\n\n        if (avgCostUsd > 0) {\n          const newRetailSar = await recalculatePrice(avgCostUsd, shippingUsd, product.category || \"General\", admin);\n          \n          if (Math.abs(newRetailSar - currentPrice) > 1) {\n            const changeType = newRetailSar > currentPrice ? \"price_increase\" : \"price_decrease\";\n            \n            await admin.from(\"daily_sync_changes\").insert({\n              shopixo_product_id: product.id,\n              cj_product_id: cjProductId,\n              change_type: changeType,\n              field_changed: \"price\",\n              old_value: currentPrice.toFixed(2),\n              new_value: newRetailSar.toFixed(2),\n              status: autoApply ? \"applied\" : \"pending\",\n              sync_date: new Date().toISOString().split(\"T\")[0],\n              applied_at: autoApply ? new Date().toISOString() : null,\n            });\n\n            if (autoApply) {\n              await admin\n                .from(\"products\")\n                .update({ \n                  price: newRetailSar,\n                  metadata: { ...product.metadata, last_price_sync: new Date().toISOString(), cost_usd: avgCostUsd },\n                  updated_at: new Date().toISOString(),\n                })\n                .eq(\"id\", product.id);\n              priceUpdates++;\n            }\n            \n            changesDetected++;\n          }\n        }\n\n        if (adjustedStock !== currentStock) {\n          let changeType = \"stock_change\";\n          let shouldAutoApply = autoApply;\n          \n          if (adjustedStock === 0 && currentStock > 0) {\n            changeType = \"stock_out\";\n            shouldAutoApply = true;\n          } else if (adjustedStock > 0 && currentStock === 0) {\n            changeType = \"stock_restored\";\n          } else if (adjustedStock < 10 && currentStock >= 10) {\n            changeType = \"stock_low\";\n          }\n          \n          await admin.from(\"daily_sync_changes\").insert({\n            shopixo_product_id: product.id,\n            cj_product_id: cjProductId,\n            change_type: changeType,\n            field_changed: \"stock\",\n            old_value: String(currentStock),\n            new_value: String(adjustedStock),\n            status: shouldAutoApply ? \"applied\" : \"pending\",\n            sync_date: new Date().toISOString().split(\"T\")[0],\n            applied_at: shouldAutoApply ? new Date().toISOString() : null,\n          });\n\n          if (shouldAutoApply) {\n            const shouldReactivate = changeType === \"stock_restored\";\n            await admin\n              .from(\"products\")\n              .update({ \n                stock: adjustedStock,\n                active: adjustedStock === 0 ? false : (shouldReactivate ? true : product.active),\n                metadata: { ...product.metadata, last_stock_sync: new Date().toISOString() },\n                updated_at: new Date().toISOString(),\n              })\n              .eq(\"id\", product.id);\n            stockUpdates++;\n          }\n          \n          changesDetected++;\n        }\n      } catch (e) {\n        console.error(`Failed to sync product ${cjProductId}:`, e);\n        errors++;\n      }\n    }\n\n    await admin.from(\"kv_settings\").upsert({\n      key: \"last_sync_run\",\n      value: { \n        timestamp: new Date().toISOString(), \n        products_checked: products.length, \n        changes: changesDetected,\n        price_updates: priceUpdates,\n        stock_updates: stockUpdates,\n        errors,\n      },\n      updated_at: new Date().toISOString(),\n    }, { onConflict: \"key\" });\n\n    await admin.from(\"import_logs\").insert({\n      action: \"daily_sync\",\n      status: errors > 0 ? \"partial\" : \"success\",\n      details: { \n        products_checked: products.length, \n        changes_detected: changesDetected,\n        price_updates: priceUpdates,\n        stock_updates: stockUpdates,\n        errors,\n        auto_apply: autoApply,\n      },\n    });\n\n    return NextResponse.json({\n      ok: true,\n      productsChecked: products.length,\n      changesDetected,\n      priceUpdates,\n      stockUpdates,\n      errors,\n    });\n  } catch (e: any) {\n    console.error(\"Sync run error:\", e);\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":8854,"size_tokens":null},"src/lib/i18n/index.ts":{"content":"export { translations, getTranslations, isRtl, type Language } from './translations';\nexport { LanguageProvider, useLanguage } from './LanguageContext';\n","path":null,"size_bytes":153,"size_tokens":null},"src/app/api/admin/cj/categories/route.ts":{"content":"import { NextResponse } from \"next/server\";\nimport { getAccessToken } from \"@/lib/cj/v2\";\n\nexport const dynamic = \"force-dynamic\";\n\ntype CategoryNode = { \n  categoryId: string; \n  categoryName: string;\n  children?: CategoryNode[];\n};\n\nfunction buildCategoryTree(nodes: any[]): CategoryNode[] {\n  if (!Array.isArray(nodes)) return [];\n  \n  const result: CategoryNode[] = [];\n  \n  for (let i = 0; i < nodes.length; i++) {\n    const firstLevel = nodes[i];\n    if (!firstLevel || typeof firstLevel !== 'object') continue;\n    \n    const firstName = firstLevel.categoryFirstName;\n    if (!firstName) continue;\n    \n    const firstNode: CategoryNode = {\n      categoryId: `first-${i}`,\n      categoryName: String(firstName),\n      children: [],\n    };\n    \n    const firstList = firstLevel.categoryFirstList;\n    if (Array.isArray(firstList)) {\n      for (let j = 0; j < firstList.length; j++) {\n        const secondLevel = firstList[j];\n        if (!secondLevel || typeof secondLevel !== 'object') continue;\n        \n        const secondName = secondLevel.categorySecondName;\n        if (!secondName) continue;\n        \n        const secondNode: CategoryNode = {\n          categoryId: `second-${i}-${j}`,\n          categoryName: String(secondName),\n          children: [],\n        };\n        \n        const secondList = secondLevel.categorySecondList;\n        if (Array.isArray(secondList)) {\n          for (const thirdLevel of secondList) {\n            if (!thirdLevel || typeof thirdLevel !== 'object') continue;\n            \n            const thirdId = thirdLevel.categoryId;\n            const thirdName = thirdLevel.categoryName;\n            \n            if (thirdId && thirdName) {\n              secondNode.children!.push({\n                categoryId: String(thirdId),\n                categoryName: String(thirdName),\n              });\n            }\n          }\n        }\n        \n        if (secondNode.children!.length > 0) {\n          firstNode.children!.push(secondNode);\n        }\n      }\n    }\n    \n    if (firstNode.children!.length > 0) {\n      result.push(firstNode);\n    }\n  }\n  \n  return result;\n}\n\nfunction countAllCategories(nodes: CategoryNode[]): number {\n  let count = 0;\n  for (const node of nodes) {\n    count++;\n    if (node.children) {\n      count += countAllCategories(node.children);\n    }\n  }\n  return count;\n}\n\nexport async function GET() {\n  try {\n    const apiKey = process.env.CJ_API_KEY;\n    if (!apiKey) {\n      return NextResponse.json({ ok: false, error: \"CJ API key not configured\" });\n    }\n\n    const token = await getAccessToken();\n    if (!token) {\n      return NextResponse.json({ ok: false, error: \"Failed to authenticate with CJ\" });\n    }\n\n    const base = process.env.CJ_API_BASE || \"https://developers.cjdropshipping.com/api2.0/v1\";\n    const res = await fetch(`${base}/product/getCategory`, {\n      headers: {\n        \"CJ-Access-Token\": token,\n        \"Content-Type\": \"application/json\",\n      },\n      cache: \"no-store\",\n    });\n\n    const data = await res.json();\n    console.log(\"[CJ Categories] Response code:\", data.code, \"result:\", data.result);\n    \n    if (data.code === 200 && data.data) {\n      const rawCategories = Array.isArray(data.data) ? data.data : [];\n      \n      if (rawCategories.length > 0) {\n        console.log(\"[CJ Categories] Sample first category:\", rawCategories[0]?.categoryFirstName);\n        const firstList = rawCategories[0]?.categoryFirstList;\n        if (Array.isArray(firstList) && firstList.length > 0) {\n          console.log(\"[CJ Categories] Sample second category:\", firstList[0]?.categorySecondName);\n          const secondList = firstList[0]?.categorySecondList;\n          if (Array.isArray(secondList) && secondList.length > 0) {\n            console.log(\"[CJ Categories] Sample third category:\", secondList[0]?.categoryId, secondList[0]?.categoryName);\n          }\n        }\n      }\n      \n      const categories = buildCategoryTree(rawCategories);\n      const totalCount = countAllCategories(categories);\n      console.log(\"[CJ Categories] Tree built:\", categories.length, \"top-level categories,\", totalCount, \"total nodes\");\n      \n      if (categories.length > 0 && categories[0].children && categories[0].children.length > 0) {\n        const firstLevel2 = categories[0].children[0];\n        console.log(\"[CJ Categories] Sample Level 2:\", firstLevel2.categoryId, firstLevel2.categoryName);\n        if (firstLevel2.children && firstLevel2.children.length > 0) {\n          const firstLevel3 = firstLevel2.children[0];\n          console.log(\"[CJ Categories] Sample Level 3 (REAL ID):\", firstLevel3.categoryId, firstLevel3.categoryName);\n        }\n      }\n      \n      if (categories.length === 0 && rawCategories.length > 0) {\n        console.log(\"[CJ Categories] WARNING: Raw data exists but tree is empty. Check parsing logic.\");\n        console.log(\"[CJ Categories] Raw sample:\", JSON.stringify(rawCategories[0]).slice(0, 500));\n      }\n      \n      return NextResponse.json({ \n        ok: true, \n        categories,\n        total: totalCount,\n        rawCount: rawCategories.length,\n      });\n    }\n\n    console.log(\"[CJ Categories] API error:\", data.code, data.message);\n    return NextResponse.json({ \n      ok: true, \n      categories: [],\n      message: \"Connected but no categories found\",\n      debug: { code: data.code, message: data.message }\n    });\n  } catch (e: any) {\n    console.error(\"[CJ Categories] Error:\", e?.message);\n    return NextResponse.json({ ok: false, error: e?.message || \"Connection failed\" });\n  }\n}\n","path":null,"size_bytes":5520,"size_tokens":null},"src/app/admin/AdminLayoutClient.tsx":{"content":"\"use client\";\n\nimport Link from \"next/link\";\nimport type { Route } from \"next\";\nimport { ReactNode } from \"react\";\nimport { usePathname } from \"next/navigation\";\nimport {\n  LayoutDashboard,\n  Package,\n  ShoppingCart,\n  Download,\n  ListChecks,\n  RefreshCw,\n  Boxes,\n  Clock,\n  FileText,\n  LucideIcon\n} from \"lucide-react\";\n\ntype NavItem = {\n  href: string;\n  label: string;\n  icon: LucideIcon;\n};\n\ntype NavSection = {\n  title: string;\n  items: NavItem[];\n};\n\nconst navSections: NavSection[] = [\n  {\n    title: \"OVERVIEW\",\n    items: [\n      { href: \"/admin\", label: \"Dashboard\", icon: LayoutDashboard },\n      { href: \"/admin/orders\", label: \"Orders\", icon: ShoppingCart },\n    ]\n  },\n  {\n    title: \"PRODUCTS\",\n    items: [\n      { href: \"/admin/products\", label: \"All Products\", icon: Package },\n      { href: \"/admin/inventory\", label: \"Inventory\", icon: Boxes },\n    ]\n  },\n  {\n    title: \"CJ DROPSHIPPING\",\n    items: [\n      { href: \"/admin/import/discover\", label: \"Product Discovery\", icon: Download },\n      { href: \"/admin/import/queue\", label: \"Review Queue\", icon: ListChecks },\n    ]\n  },\n  {\n    title: \"AUTOMATION\",\n    items: [\n      { href: \"/admin/sync\", label: \"Daily Sync\", icon: RefreshCw },\n      { href: \"/admin/jobs\", label: \"Background Jobs\", icon: Clock },\n      { href: \"/admin/import/pricing\", label: \"Pricing Rules\", icon: FileText },\n    ]\n  }\n];\n\ninterface AdminLayoutClientProps {\n  children: ReactNode;\n  email: string;\n}\n\nexport function AdminLayoutClient({ children, email }: AdminLayoutClientProps) {\n  const pathname = usePathname();\n\n  return (\n    <div className=\"flex min-h-screen bg-gray-100\">\n      <main className=\"flex-1 overflow-auto\">\n        <div className=\"p-6\">\n          {children}\n        </div>\n      </main>\n\n      <aside className=\"w-56 bg-white border-l border-gray-200 flex flex-col shadow-sm\">\n        <div className=\"p-4 border-b border-gray-100\">\n          <Link href=\"/admin\" className=\"flex items-center gap-2 justify-end\">\n            <span className=\"font-bold text-gray-800\">Shopixo Admin</span>\n            <div className=\"w-8 h-8 rounded-full bg-gradient-to-br from-amber-400 to-amber-500 flex items-center justify-center\">\n              <span className=\"text-white font-bold text-sm\">S</span>\n            </div>\n          </Link>\n        </div>\n        \n        <nav className=\"flex-1 overflow-y-auto py-4\">\n          {navSections.map((section) => (\n            <div key={section.title} className=\"mb-4\">\n              <p className=\"px-4 mb-2 text-[10px] font-semibold tracking-wider text-gray-400 text-right\">\n                {section.title}\n              </p>\n              <ul className=\"space-y-0.5\">\n                {section.items.map((item) => {\n                  const Icon = item.icon;\n                  const isActive = pathname === item.href || \n                    (item.href !== \"/admin\" && pathname?.startsWith(item.href));\n                  return (\n                    <li key={item.href}>\n                      <Link\n                        href={item.href as Route}\n                        className={`flex items-center gap-2 px-4 py-2 text-sm transition-colors justify-end ${\n                          isActive \n                            ? \"text-amber-600 bg-amber-50 font-medium\" \n                            : \"text-gray-600 hover:bg-gray-50 hover:text-gray-900\"\n                        }`}\n                      >\n                        {item.label}\n                        <Icon className=\"h-4 w-4\" />\n                      </Link>\n                    </li>\n                  );\n                })}\n              </ul>\n            </div>\n          ))}\n        </nav>\n\n        <div className=\"p-3 border-t border-gray-100\">\n          <div className=\"flex items-center gap-2 justify-end\">\n            <div className=\"text-right\">\n              <p className=\"text-xs font-medium text-gray-700 truncate max-w-[120px]\">{email}</p>\n              <p className=\"text-[10px] text-gray-400\">Admin</p>\n            </div>\n            <div className=\"w-7 h-7 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0\">\n              <span className=\"text-xs font-medium text-amber-600\">\n                {email ? email[0].toUpperCase() : \"?\"}\n              </span>\n            </div>\n          </div>\n        </div>\n      </aside>\n    </div>\n  );\n}\n","path":null,"size_bytes":4341,"size_tokens":null},"src/app/api/admin/pricing/rules/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nexport async function GET() {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: rules, error } = await admin\n      .from(\"pricing_rules\")\n      .select(\"*\")\n      .order(\"is_default\", { ascending: false })\n      .order(\"category\", { ascending: true });\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true, rules: rules || [] });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { category, margin_percent, min_profit_sar, vat_percent, payment_fee_percent, smart_rounding_enabled, rounding_targets } = body;\n\n    if (!category?.trim()) {\n      return NextResponse.json({ ok: false, error: \"Category is required\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: existing } = await admin\n      .from(\"pricing_rules\")\n      .select(\"id\")\n      .eq(\"category\", category.trim())\n      .maybeSingle();\n\n    if (existing) {\n      return NextResponse.json({ ok: false, error: \"Category already exists\" }, { status: 400 });\n    }\n\n    const { data: rule, error } = await admin\n      .from(\"pricing_rules\")\n      .insert({\n        category: category.trim(),\n        margin_percent: margin_percent || 40,\n        min_profit_sar: min_profit_sar || 35,\n        vat_percent: vat_percent || 15,\n        payment_fee_percent: payment_fee_percent || 2.9,\n        smart_rounding_enabled: smart_rounding_enabled !== false,\n        rounding_targets: rounding_targets || [49, 79, 99, 149, 199, 249, 299],\n        is_default: false,\n      })\n      .select()\n      .single();\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true, rule });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function PUT(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { id, category, margin_percent, min_profit_sar, vat_percent, payment_fee_percent, smart_rounding_enabled, rounding_targets } = body;\n\n    if (!id) {\n      return NextResponse.json({ ok: false, error: \"Rule ID is required\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const updateData: Record<string, any> = { updated_at: new Date().toISOString() };\n    \n    if (category !== undefined) updateData.category = category;\n    if (margin_percent !== undefined) updateData.margin_percent = margin_percent;\n    if (min_profit_sar !== undefined) updateData.min_profit_sar = min_profit_sar;\n    if (vat_percent !== undefined) updateData.vat_percent = vat_percent;\n    if (payment_fee_percent !== undefined) updateData.payment_fee_percent = payment_fee_percent;\n    if (smart_rounding_enabled !== undefined) updateData.smart_rounding_enabled = smart_rounding_enabled;\n    if (rounding_targets !== undefined) updateData.rounding_targets = rounding_targets;\n\n    const { data: rule, error } = await admin\n      .from(\"pricing_rules\")\n      .update(updateData)\n      .eq(\"id\", id)\n      .select()\n      .single();\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true, rule });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function DELETE(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const id = searchParams.get(\"id\");\n\n    if (!id) {\n      return NextResponse.json({ ok: false, error: \"Rule ID is required\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: rule } = await admin\n      .from(\"pricing_rules\")\n      .select(\"is_default\")\n      .eq(\"id\", Number(id))\n      .single();\n\n    if (rule?.is_default) {\n      return NextResponse.json({ ok: false, error: \"Cannot delete default rule\" }, { status: 400 });\n    }\n\n    const { error } = await admin\n      .from(\"pricing_rules\")\n      .delete()\n      .eq(\"id\", Number(id));\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":5351,"size_tokens":null},"src/app/api/admin/inventory/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nconst LOW_STOCK_THRESHOLD = 10;\n\nexport async function GET(req: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { searchParams } = new URL(req.url);\n    const filter = searchParams.get(\"filter\") || \"all\";\n    const search = searchParams.get(\"search\") || \"\";\n    const limit = Math.min(100, Number(searchParams.get(\"limit\") || 20));\n    const offset = Number(searchParams.get(\"offset\") || 0);\n\n    let query = admin\n      .from(\"products\")\n      .select(\"id, title, title_ar, category, price, stock, active, images, metadata, updated_at, supplier_sku, product_code\", { count: \"exact\" })\n      .order(\"stock\", { ascending: true })\n      .order(\"updated_at\", { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    if (search) {\n      query = query.or(`title.ilike.%${search}%,title_ar.ilike.%${search}%`);\n    }\n\n    switch (filter) {\n      case \"in_stock\":\n        query = query.gt(\"stock\", LOW_STOCK_THRESHOLD).eq(\"active\", true);\n        break;\n      case \"low_stock\":\n        query = query.gt(\"stock\", 0).lte(\"stock\", LOW_STOCK_THRESHOLD);\n        break;\n      case \"out_of_stock\":\n        query = query.eq(\"stock\", 0);\n        break;\n      case \"hidden\":\n        query = query.eq(\"active\", false);\n        break;\n    }\n\n    const { data: products, error, count } = await query;\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    const { data: allProducts } = await admin\n      .from(\"products\")\n      .select(\"stock, active, metadata\");\n\n    const stats = {\n      total: 0,\n      inStock: 0,\n      lowStock: 0,\n      outOfStock: 0,\n      hidden: 0,\n      cjProducts: 0,\n    };\n\n    (allProducts || []).forEach((p: any) => {\n      stats.total++;\n      const stock = p.stock ?? 0; // null stock treated as 0 for stats\n      if (stock > LOW_STOCK_THRESHOLD) stats.inStock++;\n      else if (stock > 0) stats.lowStock++;\n      else stats.outOfStock++;\n      if (!p.active) stats.hidden++;\n      if (p.metadata?.cj_product_id) stats.cjProducts++;\n    });\n\n    return NextResponse.json({\n      ok: true,\n      products: products || [],\n      total: count || 0,\n      stats,\n    });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function PATCH(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { id, active, stock } = body;\n\n    if (!id) {\n      return NextResponse.json({ ok: false, error: \"Product ID required\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const updateData: Record<string, any> = { updated_at: new Date().toISOString() };\n    \n    if (active !== undefined) updateData.active = active;\n    if (stock !== undefined) updateData.stock = stock;\n\n    const { error } = await admin\n      .from(\"products\")\n      .update(updateData)\n      .eq(\"id\", id);\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":3744,"size_tokens":null},"src/app/admin/sync/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport {\n  RefreshCw,\n  TrendingUp,\n  TrendingDown,\n  Package,\n  AlertTriangle,\n  CheckCircle,\n  Clock,\n  Eye,\n  ArrowRight,\n  Loader2,\n  Calendar,\n  DollarSign,\n} from \"lucide-react\";\n\ntype SyncChange = {\n  id: number;\n  shopixo_product_id: string;\n  cj_product_id: string;\n  change_type: string;\n  field_changed: string;\n  old_value: string;\n  new_value: string;\n  status: string;\n  sync_date: string;\n  created_at: string;\n};\n\ntype SyncStats = {\n  pending: number;\n  applied: number;\n  dismissed: number;\n  price_changes: number;\n  stock_changes: number;\n  out_of_stock: number;\n};\n\nconst changeTypeIcons: Record<string, any> = {\n  price_increase: TrendingUp,\n  price_decrease: TrendingDown,\n  stock_low: AlertTriangle,\n  stock_out: Package,\n  stock_restored: CheckCircle,\n  default: RefreshCw,\n};\n\nconst changeTypeColors: Record<string, { bg: string; text: string }> = {\n  price_increase: { bg: \"bg-red-100\", text: \"text-red-800\" },\n  price_decrease: { bg: \"bg-green-100\", text: \"text-green-800\" },\n  stock_low: { bg: \"bg-amber-100\", text: \"text-amber-800\" },\n  stock_out: { bg: \"bg-red-100\", text: \"text-red-800\" },\n  stock_restored: { bg: \"bg-green-100\", text: \"text-green-800\" },\n  default: { bg: \"bg-gray-100\", text: \"text-gray-800\" },\n};\n\nexport default function DailySyncPage() {\n  const [changes, setChanges] = useState<SyncChange[]>([]);\n  const [stats, setStats] = useState<SyncStats>({\n    pending: 0,\n    applied: 0,\n    dismissed: 0,\n    price_changes: 0,\n    stock_changes: 0,\n    out_of_stock: 0,\n  });\n  const [loading, setLoading] = useState(true);\n  const [syncing, setSyncing] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [lastSyncTime, setLastSyncTime] = useState<string | null>(null);\n  const [statusFilter, setStatusFilter] = useState(\"pending\");\n\n  const fetchChanges = useCallback(async () => {\n    try {\n      const res = await fetch(`/api/admin/sync/changes?status=${statusFilter}`);\n      const data = await res.json();\n      \n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to fetch changes\");\n      }\n      \n      setChanges(data.changes || []);\n      setStats(data.stats || {});\n      setLastSyncTime(data.lastSync || null);\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load sync changes\");\n    } finally {\n      setLoading(false);\n    }\n  }, [statusFilter]);\n\n  useEffect(() => {\n    fetchChanges();\n  }, [fetchChanges]);\n\n  const runSync = async () => {\n    setSyncing(true);\n    setError(null);\n    \n    try {\n      const res = await fetch(\"/api/admin/sync/run\", {\n        method: \"POST\",\n      });\n      const data = await res.json();\n      \n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Sync failed\");\n      }\n      \n      fetchChanges();\n    } catch (e: any) {\n      setError(e?.message || \"Sync failed\");\n    } finally {\n      setSyncing(false);\n    }\n  };\n\n  const handleAction = async (id: number, action: \"apply\" | \"dismiss\") => {\n    try {\n      const res = await fetch(\"/api/admin/sync/changes\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ id, action }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Action failed\");\n      }\n      \n      fetchChanges();\n    } catch (e: any) {\n      setError(e?.message || \"Action failed\");\n    }\n  };\n\n  const applyAll = async () => {\n    if (!confirm(\"Apply all pending changes?\")) return;\n    \n    try {\n      const res = await fetch(\"/api/admin/sync/changes\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ action: \"apply_all\" }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Action failed\");\n      }\n      \n      fetchChanges();\n    } catch (e: any) {\n      setError(e?.message || \"Action failed\");\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Daily Sync</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">Monitor price and stock changes from CJ</p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          {lastSyncTime && (\n            <span className=\"text-sm text-gray-500 flex items-center gap-1\">\n              <Clock className=\"h-4 w-4\" />\n              Last sync: {new Date(lastSyncTime).toLocaleString()}\n            </span>\n          )}\n          <button\n            onClick={runSync}\n            disabled={syncing}\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 disabled:opacity-50\"\n          >\n            {syncing ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <RefreshCw className=\"h-4 w-4\" />}\n            Run Sync Now\n          </button>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-3 md:grid-cols-6 gap-4\">\n        <button\n          onClick={() => setStatusFilter(\"pending\")}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            statusFilter === \"pending\" ? \"border-amber-500 bg-amber-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <Clock className=\"h-5 w-5 text-amber-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.pending}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Pending</p>\n        </button>\n        \n        <button\n          onClick={() => setStatusFilter(\"applied\")}\n          className={`p-4 rounded-xl border-2 transition-all ${\n            statusFilter === \"applied\" ? \"border-green-500 bg-green-50\" : \"border-gray-100 hover:border-gray-200\"\n          }`}\n        >\n          <div className=\"flex items-center justify-between\">\n            <CheckCircle className=\"h-5 w-5 text-green-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.applied}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Applied</p>\n        </button>\n\n        <div className=\"p-4 rounded-xl border bg-white\">\n          <div className=\"flex items-center justify-between\">\n            <DollarSign className=\"h-5 w-5 text-blue-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.price_changes}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Price Changes</p>\n        </div>\n\n        <div className=\"p-4 rounded-xl border bg-white\">\n          <div className=\"flex items-center justify-between\">\n            <Package className=\"h-5 w-5 text-purple-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.stock_changes}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Stock Changes</p>\n        </div>\n\n        <div className=\"p-4 rounded-xl border bg-white\">\n          <div className=\"flex items-center justify-between\">\n            <AlertTriangle className=\"h-5 w-5 text-red-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{stats.out_of_stock}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Out of Stock</p>\n        </div>\n\n        <div className=\"p-4 rounded-xl border bg-white\">\n          <div className=\"flex items-center justify-between\">\n            <Calendar className=\"h-5 w-5 text-gray-600\" />\n            <span className=\"text-xl font-bold text-gray-900\">{new Date().toLocaleDateString(\"en-SA\")}</span>\n          </div>\n          <p className=\"text-xs text-gray-600 mt-1\">Today</p>\n        </div>\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-800\">\n          {error}\n        </div>\n      )}\n\n      {stats.pending > 0 && statusFilter === \"pending\" && (\n        <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <AlertTriangle className=\"h-5 w-5 text-amber-600\" />\n            <span className=\"text-amber-800\">{stats.pending} changes require review</span>\n          </div>\n          <button\n            onClick={applyAll}\n            className=\"px-4 py-2 bg-amber-600 text-white rounded-lg text-sm hover:bg-amber-700\"\n          >\n            Apply All Updates\n          </button>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-xl border shadow-sm overflow-hidden\">\n        {loading ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <Loader2 className=\"h-8 w-8 animate-spin mx-auto mb-3\" />\n            Loading changes...\n          </div>\n        ) : changes.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <CheckCircle className=\"h-12 w-12 mx-auto mb-3 text-green-500\" />\n            <p className=\"font-medium text-gray-900\">All synced!</p>\n            <p className=\"text-sm mt-1\">No {statusFilter} changes to review</p>\n          </div>\n        ) : (\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"bg-gray-50 border-b\">\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Product</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Change Type</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Field</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Old Value</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">New Value</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Date</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y\">\n              {changes.map((change) => {\n                const Icon = changeTypeIcons[change.change_type] || changeTypeIcons.default;\n                const colors = changeTypeColors[change.change_type] || changeTypeColors.default;\n                \n                return (\n                  <tr key={change.id} className=\"hover:bg-gray-50\">\n                    <td className=\"px-4 py-3\">\n                      <p className=\"font-mono text-xs text-gray-500\">{change.cj_product_id}</p>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${colors.bg} ${colors.text}`}>\n                        <Icon className=\"h-3 w-3\" />\n                        {change.change_type.replace(/_/g, \" \")}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-gray-600\">\n                      {change.field_changed}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className=\"text-red-600 line-through text-sm\">{change.old_value}</span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-1\">\n                        <ArrowRight className=\"h-3 w-3 text-gray-400\" />\n                        <span className=\"text-green-600 font-medium text-sm\">{change.new_value}</span>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3 text-sm text-gray-500\">\n                      {new Date(change.created_at).toLocaleDateString()}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      {change.status === \"pending\" && (\n                        <div className=\"flex items-center gap-1\">\n                          <button\n                            onClick={() => handleAction(change.id, \"apply\")}\n                            className=\"px-2 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700\"\n                          >\n                            Apply\n                          </button>\n                          <button\n                            onClick={() => handleAction(change.id, \"dismiss\")}\n                            className=\"px-2 py-1 border rounded text-xs hover:bg-gray-50\"\n                          >\n                            Dismiss\n                          </button>\n                        </div>\n                      )}\n                      {change.status === \"applied\" && (\n                        <span className=\"text-green-600 text-xs flex items-center gap-1\">\n                          <CheckCircle className=\"h-3 w-3\" />\n                          Applied\n                        </span>\n                      )}\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        )}\n      </div>\n\n      <div className=\"bg-blue-50 rounded-xl border border-blue-200 p-6\">\n        <h3 className=\"font-medium text-blue-900 mb-2\">Automatic Sync Schedule</h3>\n        <p className=\"text-sm text-blue-700\">\n          The system automatically checks for price and stock changes every day at 8:00 AM (KSA time).\n          Products with 0 stock are automatically hidden from the store.\n        </p>\n        <div className=\"mt-4 grid grid-cols-3 gap-4 text-sm\">\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Stock Check</p>\n            <p className=\"font-medium text-gray-900\">Every 4 hours</p>\n          </div>\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Price Check</p>\n            <p className=\"font-medium text-gray-900\">Daily at 8:00 AM</p>\n          </div>\n          <div className=\"bg-white rounded-lg p-3\">\n            <p className=\"text-gray-500\">Safety Buffer</p>\n            <p className=\"font-medium text-gray-900\">Stock - 5 units</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14321,"size_tokens":null},"src/app/admin/import/queue/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport {\n  CheckCircle,\n  XCircle,\n  Clock,\n  Package,\n  Download,\n  Edit,\n  Trash2,\n  Star,\n  ChevronLeft,\n  ChevronRight,\n  Loader2,\n  Filter,\n  MoreHorizontal,\n  Eye,\n} from \"lucide-react\";\n\ntype QueueProduct = {\n  id: number;\n  batch_id: number | null;\n  cj_product_id: string;\n  name_en: string;\n  name_ar: string | null;\n  category: string;\n  images: string[];\n  variants: any[];\n  cj_price_usd: number;\n  shipping_cost_usd: number | null;\n  calculated_retail_sar: number | null;\n  supplier_rating: number;\n  stock_total: number;\n  quality_score: number;\n  status: string;\n  admin_notes: string | null;\n  delivery_days_min: number;\n  delivery_days_max: number;\n  created_at: string;\n};\n\ntype Stats = {\n  pending: number;\n  approved: number;\n  rejected: number;\n  imported: number;\n};\n\nconst statusColors: Record<string, { bg: string; text: string; icon: any }> = {\n  pending: { bg: \"bg-amber-100\", text: \"text-amber-800\", icon: Clock },\n  approved: { bg: \"bg-green-100\", text: \"text-green-800\", icon: CheckCircle },\n  rejected: { bg: \"bg-red-100\", text: \"text-red-800\", icon: XCircle },\n  imported: { bg: \"bg-blue-100\", text: \"text-blue-800\", icon: Package },\n};\n\nexport default function QueuePage() {\n  const [products, setProducts] = useState<QueueProduct[]>([]);\n  const [stats, setStats] = useState<Stats>({ pending: 0, approved: 0, rejected: 0, imported: 0 });\n  const [total, setTotal] = useState(0);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  \n  const [statusFilter, setStatusFilter] = useState(\"pending\");\n  const [categoryFilter, setCategoryFilter] = useState(\"all\");\n  const [page, setPage] = useState(0);\n  const limit = 20;\n\n  const [selected, setSelected] = useState<Set<number>>(new Set());\n  const [actionLoading, setActionLoading] = useState(false);\n  const [editingId, setEditingId] = useState<number | null>(null);\n  const [editData, setEditData] = useState<Partial<QueueProduct>>({});\n\n  const fetchProducts = useCallback(async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const params = new URLSearchParams({\n        status: statusFilter,\n        category: categoryFilter,\n        limit: limit.toString(),\n        offset: (page * limit).toString(),\n      });\n      \n      const res = await fetch(`/api/admin/import/queue?${params}`);\n      const data = await res.json();\n      \n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Failed to fetch queue\");\n      }\n      \n      setProducts(data.products || []);\n      setTotal(data.total || 0);\n      setStats(data.stats || { pending: 0, approved: 0, rejected: 0, imported: 0 });\n    } catch (e: any) {\n      setError(e?.message || \"Failed to load queue\");\n    } finally {\n      setLoading(false);\n    }\n  }, [statusFilter, categoryFilter, page]);\n\n  useEffect(() => {\n    fetchProducts();\n  }, [fetchProducts]);\n\n  const toggleSelect = (id: number) => {\n    setSelected(prev => {\n      const next = new Set(prev);\n      if (next.has(id)) {\n        next.delete(id);\n      } else {\n        next.add(id);\n      }\n      return next;\n    });\n  };\n\n  const selectAll = () => {\n    setSelected(new Set(products.map(p => p.id)));\n  };\n\n  const deselectAll = () => {\n    setSelected(new Set());\n  };\n\n  const handleBulkAction = async (action: string) => {\n    if (selected.size === 0) return;\n    \n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/import/queue\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ids: Array.from(selected), action }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Action failed\");\n      }\n      \n      setSelected(new Set());\n      fetchProducts();\n    } catch (e: any) {\n      setError(e?.message || \"Action failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const handleImport = async () => {\n    const approvedIds = products.filter(p => p.status === \"approved\" && selected.has(p.id)).map(p => p.id);\n    if (approvedIds.length === 0) {\n      setError(\"Select approved products to import\");\n      return;\n    }\n    \n    if (!confirm(`Import ${approvedIds.length} products to your store?`)) return;\n    \n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/import/execute\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ productIds: approvedIds }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Import failed\");\n      }\n      \n      setSelected(new Set());\n      fetchProducts();\n      alert(`Successfully imported ${data.imported} products!`);\n    } catch (e: any) {\n      setError(e?.message || \"Import failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const handleSingleAction = async (id: number, action: string) => {\n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/import/queue\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ids: [id], action }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Action failed\");\n      }\n      \n      fetchProducts();\n    } catch (e: any) {\n      setError(e?.message || \"Action failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const startEdit = (product: QueueProduct) => {\n    setEditingId(product.id);\n    setEditData({\n      name_en: product.name_en,\n      name_ar: product.name_ar || \"\",\n      category: product.category,\n      admin_notes: product.admin_notes || \"\",\n    });\n  };\n\n  const saveEdit = async () => {\n    if (!editingId) return;\n    \n    setActionLoading(true);\n    try {\n      const res = await fetch(\"/api/admin/import/queue\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ ids: [editingId], action: \"update\", data: editData }),\n      });\n      \n      const data = await res.json();\n      if (!res.ok || !data.ok) {\n        throw new Error(data.error || \"Update failed\");\n      }\n      \n      setEditingId(null);\n      setEditData({});\n      fetchProducts();\n    } catch (e: any) {\n      setError(e?.message || \"Update failed\");\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const exportCsv = () => {\n    const headers = [\"ID\", \"CJ Product ID\", \"Name\", \"Category\", \"Price USD\", \"Stock\", \"Rating\", \"Status\", \"Created\"];\n    const rows = products.map(p => [\n      p.id,\n      p.cj_product_id,\n      `\"${p.name_en.replace(/\"/g, '\"\"')}\"`,\n      p.category,\n      p.cj_price_usd,\n      p.stock_total,\n      p.supplier_rating,\n      p.status,\n      new Date(p.created_at).toLocaleDateString(),\n    ]);\n    \n    const csv = [headers.join(\",\"), ...rows.map(r => r.join(\",\"))].join(\"\\n\");\n    const blob = new Blob([csv], { type: \"text/csv\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `queue-export-${new Date().toISOString().slice(0, 10)}.csv`;\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n\n  const totalPages = Math.ceil(total / limit);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold text-gray-900\">Import Queue</h1>\n          <p className=\"text-sm text-gray-500 mt-1\">قائمة انتظار الاستيراد - Review and approve products</p>\n        </div>\n        <div className=\"flex items-center gap-3\">\n          <button\n            onClick={exportCsv}\n            className=\"flex items-center gap-2 px-4 py-2 border rounded-lg text-sm hover:bg-gray-50\"\n          >\n            <Download className=\"h-4 w-4\" />\n            Export CSV\n          </button>\n          <Link\n            href=\"/admin/import/discover\"\n            className=\"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700\"\n          >\n            Discover Products\n          </Link>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4\">\n        {Object.entries(stats).map(([status, count]) => {\n          const colors = statusColors[status] || statusColors.pending;\n          const Icon = colors.icon;\n          return (\n            <button\n              key={status}\n              onClick={() => { setStatusFilter(status); setPage(0); }}\n              className={`p-4 rounded-xl border-2 transition-all ${\n                statusFilter === status ? \"border-gray-900 bg-gray-50\" : \"border-gray-100 hover:border-gray-200\"\n              }`}\n            >\n              <div className=\"flex items-center justify-between\">\n                <div className={`w-10 h-10 rounded-lg ${colors.bg} flex items-center justify-center`}>\n                  <Icon className={`h-5 w-5 ${colors.text}`} />\n                </div>\n                <span className=\"text-2xl font-bold text-gray-900\">{count}</span>\n              </div>\n              <p className=\"mt-2 text-sm text-gray-600 capitalize\">{status}</p>\n            </button>\n          );\n        })}\n      </div>\n\n      {error && (\n        <div className=\"rounded-lg bg-red-50 border border-red-200 p-4 text-sm text-red-800\">\n          {error}\n        </div>\n      )}\n\n      {selected.size > 0 && (\n        <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between\">\n          <span className=\"text-blue-800 font-medium\">{selected.size} products selected</span>\n          <div className=\"flex items-center gap-2\">\n            {statusFilter === \"pending\" && (\n              <>\n                <button\n                  onClick={() => handleBulkAction(\"approve\")}\n                  disabled={actionLoading}\n                  className=\"flex items-center gap-1 px-3 py-1.5 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:opacity-50\"\n                >\n                  <CheckCircle className=\"h-4 w-4\" />\n                  Approve All\n                </button>\n                <button\n                  onClick={() => handleBulkAction(\"reject\")}\n                  disabled={actionLoading}\n                  className=\"flex items-center gap-1 px-3 py-1.5 bg-red-600 text-white rounded text-sm hover:bg-red-700 disabled:opacity-50\"\n                >\n                  <XCircle className=\"h-4 w-4\" />\n                  Reject All\n                </button>\n              </>\n            )}\n            {statusFilter === \"approved\" && (\n              <button\n                onClick={handleImport}\n                disabled={actionLoading}\n                className=\"flex items-center gap-1 px-3 py-1.5 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:opacity-50\"\n              >\n                <Package className=\"h-4 w-4\" />\n                Import to Store\n              </button>\n            )}\n            <button onClick={deselectAll} className=\"text-sm text-gray-500 hover:underline ml-2\">\n              Clear Selection\n            </button>\n          </div>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-xl border shadow-sm overflow-hidden\">\n        <div className=\"p-4 border-b flex items-center justify-between\">\n          <div className=\"flex items-center gap-4\">\n            <button onClick={selectAll} className=\"text-sm text-blue-600 hover:underline\">Select All</button>\n            <span className=\"text-gray-300\">|</span>\n            <span className=\"text-sm text-gray-500\">\n              Showing {products.length} of {total} products\n            </span>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <button\n              onClick={() => setPage(Math.max(0, page - 1))}\n              disabled={page === 0}\n              className=\"p-1.5 border rounded hover:bg-gray-50 disabled:opacity-30\"\n            >\n              <ChevronLeft className=\"h-4 w-4\" />\n            </button>\n            <span className=\"text-sm text-gray-600\">\n              Page {page + 1} of {totalPages || 1}\n            </span>\n            <button\n              onClick={() => setPage(Math.min(totalPages - 1, page + 1))}\n              disabled={page >= totalPages - 1}\n              className=\"p-1.5 border rounded hover:bg-gray-50 disabled:opacity-30\"\n            >\n              <ChevronRight className=\"h-4 w-4\" />\n            </button>\n          </div>\n        </div>\n\n        {loading ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <Loader2 className=\"h-8 w-8 animate-spin mx-auto mb-3\" />\n            Loading...\n          </div>\n        ) : products.length === 0 ? (\n          <div className=\"p-12 text-center text-gray-500\">\n            <Package className=\"h-12 w-12 mx-auto mb-3 opacity-50\" />\n            <p>No products in queue</p>\n            <Link href=\"/admin/import/discover\" className=\"text-blue-600 hover:underline text-sm mt-2 inline-block\">\n              Discover products to import\n            </Link>\n          </div>\n        ) : (\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"bg-gray-50 border-b\">\n                <th className=\"w-10 px-4 py-3\"></th>\n                <th className=\"w-20 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Image</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Product</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Supplier SKU</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Category</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Price</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Stock</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Rating</th>\n                <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Status</th>\n                <th className=\"w-32 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y\">\n              {products.map((product) => {\n                const isSelected = selected.has(product.id);\n                const colors = statusColors[product.status] || statusColors.pending;\n                const StatusIcon = colors.icon;\n                \n                return editingId === product.id ? (\n                  <tr key={product.id} className=\"bg-blue-50\">\n                    <td colSpan={10} className=\"px-4 py-4\">\n                      <div className=\"space-y-3\">\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div>\n                            <label className=\"block text-xs font-medium text-gray-500 mb-1\">English Name</label>\n                            <input\n                              type=\"text\"\n                              value={editData.name_en || \"\"}\n                              onChange={(e) => setEditData(d => ({ ...d, name_en: e.target.value }))}\n                              className=\"w-full px-3 py-2 border rounded text-sm\"\n                            />\n                          </div>\n                          <div>\n                            <label className=\"block text-xs font-medium text-gray-500 mb-1\">Arabic Name</label>\n                            <input\n                              type=\"text\"\n                              value={editData.name_ar || \"\"}\n                              onChange={(e) => setEditData(d => ({ ...d, name_ar: e.target.value }))}\n                              className=\"w-full px-3 py-2 border rounded text-sm\"\n                              dir=\"rtl\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"grid grid-cols-2 gap-4\">\n                          <div>\n                            <label className=\"block text-xs font-medium text-gray-500 mb-1\">Category</label>\n                            <input\n                              type=\"text\"\n                              value={editData.category || \"\"}\n                              onChange={(e) => setEditData(d => ({ ...d, category: e.target.value }))}\n                              className=\"w-full px-3 py-2 border rounded text-sm\"\n                            />\n                          </div>\n                          <div>\n                            <label className=\"block text-xs font-medium text-gray-500 mb-1\">Admin Notes</label>\n                            <input\n                              type=\"text\"\n                              value={editData.admin_notes || \"\"}\n                              onChange={(e) => setEditData(d => ({ ...d, admin_notes: e.target.value }))}\n                              className=\"w-full px-3 py-2 border rounded text-sm\"\n                            />\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <button\n                            onClick={saveEdit}\n                            disabled={actionLoading}\n                            className=\"px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 disabled:opacity-50\"\n                          >\n                            Save Changes\n                          </button>\n                          <button\n                            onClick={() => { setEditingId(null); setEditData({}); }}\n                            className=\"px-4 py-2 border rounded text-sm hover:bg-gray-50\"\n                          >\n                            Cancel\n                          </button>\n                        </div>\n                      </div>\n                    </td>\n                  </tr>\n                ) : (\n                  <tr key={product.id} className={isSelected ? \"bg-blue-50\" : \"hover:bg-gray-50\"}>\n                    <td className=\"px-4 py-3\">\n                      <input\n                        type=\"checkbox\"\n                        checked={isSelected}\n                        onChange={() => toggleSelect(product.id)}\n                        className=\"rounded border-gray-300\"\n                      />\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"w-14 h-14 rounded-lg overflow-hidden bg-gray-100\">\n                        {product.images[0] ? (\n                          <img\n                            src={product.images[0]}\n                            alt={product.name_en}\n                            className=\"w-full h-full object-cover\"\n                          />\n                        ) : (\n                          <div className=\"w-full h-full flex items-center justify-center text-gray-400\">\n                            <Package className=\"h-6 w-6\" />\n                          </div>\n                        )}\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <p className=\"font-medium text-gray-900 line-clamp-2\">{product.name_en}</p>\n                      {product.name_ar && (\n                        <p className=\"text-sm text-gray-500 line-clamp-1\" dir=\"rtl\">{product.name_ar}</p>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className=\"font-mono text-xs text-blue-600\" title={product.cj_product_id}>\n                        {product.cj_product_id.length > 12 ? `...${product.cj_product_id.slice(-8)}` : product.cj_product_id}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className=\"px-2 py-1 bg-gray-100 rounded text-xs text-gray-700\">{product.category}</span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <p className=\"font-medium text-green-600\">${product.cj_price_usd?.toFixed(2) || \"0.00\"}</p>\n                      {product.calculated_retail_sar && (\n                        <p className=\"text-xs text-gray-500\">Retail: ${product.calculated_retail_sar}</p>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <p className=\"text-gray-900\">{product.stock_total}</p>\n                      <p className=\"text-xs text-gray-500\">{product.variants?.length || 0} variants</p>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-1\">\n                        <Star className=\"h-4 w-4 text-amber-400\" />\n                        <span>{product.supplier_rating?.toFixed(1) || \"4.0\"}</span>\n                      </div>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <span className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${colors.bg} ${colors.text}`}>\n                        <StatusIcon className=\"h-3 w-3\" />\n                        {product.status}\n                      </span>\n                    </td>\n                    <td className=\"px-4 py-3\">\n                      <div className=\"flex items-center gap-1\">\n                        {product.status === \"pending\" && (\n                          <>\n                            <button\n                              onClick={() => handleSingleAction(product.id, \"approve\")}\n                              disabled={actionLoading}\n                              className=\"p-1.5 text-green-600 hover:bg-green-50 rounded\"\n                              title=\"Approve\"\n                            >\n                              <CheckCircle className=\"h-4 w-4\" />\n                            </button>\n                            <button\n                              onClick={() => handleSingleAction(product.id, \"reject\")}\n                              disabled={actionLoading}\n                              className=\"p-1.5 text-red-600 hover:bg-red-50 rounded\"\n                              title=\"Reject\"\n                            >\n                              <XCircle className=\"h-4 w-4\" />\n                            </button>\n                          </>\n                        )}\n                        <button\n                          onClick={() => startEdit(product)}\n                          className=\"p-1.5 text-gray-600 hover:bg-gray-100 rounded\"\n                          title=\"Edit\"\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </button>\n                        <Link\n                          href={`/admin/cj/product/${product.cj_product_id}`}\n                          className=\"p-1.5 text-gray-600 hover:bg-gray-100 rounded\"\n                          title=\"View Details\"\n                        >\n                          <Eye className=\"h-4 w-4\" />\n                        </Link>\n                      </div>\n                    </td>\n                  </tr>\n                );\n              })}\n            </tbody>\n          </table>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":23589,"size_tokens":null},"src/lib/search/keyword-lexicon.ts":{"content":"type GenderClass = 'neutral' | 'female' | 'male';\n\ntype ProductConcept = {\n  id: string;\n  canonical: string;\n  synonyms: string[];\n  required: boolean;\n  genderClass: GenderClass;\n};\n\nconst PRODUCT_CONCEPTS: ProductConcept[] = [\n  { id: 'dress', canonical: 'dress', synonyms: ['dresses', 'gown', 'gowns', 'frock', 'frocks', 'maxi dress', 'midi dress', 'mini dress', 'evening dress', 'cocktail dress', 'sundress', 'sundresses', 'party dress', 'summer dress', 'casual dress', 'formal dress', 'long dress', 'short dress', 'bodycon', 'bodycon dress', 'wrap dress', 'shift dress', 'a line dress', 'a-line dress', 'sheath dress', 'slip dress', 'shirt dress', 'tunic dress', 'skater dress', 'fit and flare', 'mermaid dress', 'ball gown', 'prom dress', 'wedding dress', 'bridesmaid dress', 'maternity dress', 'beach dress', 'bohemian dress', 'boho dress', 'lace dress', 'floral dress', 'printed dress', 'solid dress', 'elegant dress', 'sexy dress', 'vintage dress', 'retro dress'], required: true, genderClass: 'neutral' },\n  { id: 'shirt', canonical: 'shirt', synonyms: ['shirts', 'button up', 'button down', 'dress shirt', 'oxford shirt', 'flannel shirt'], required: true, genderClass: 'neutral' },\n  { id: 'blouse', canonical: 'blouse', synonyms: ['blouses', 'womens blouse', 'chiffon blouse', 'silk blouse', 'satin blouse', 'office blouse', 'elegant blouse', 'casual blouse', 'ruffle blouse', 'wrap blouse', 'tie blouse', 'bow blouse'], required: true, genderClass: 'neutral' },\n  { id: 'top', canonical: 'top', synonyms: ['tops', 'tee', 'tees', 't-shirt', 't-shirts', 'tshirt', 'tshirts', 'tank top', 'tank tops', 'camisole', 'cami'], required: true, genderClass: 'neutral' },\n  { id: 'pants', canonical: 'pants', synonyms: ['pant', 'trousers', 'trouser', 'slacks', 'chinos'], required: true, genderClass: 'neutral' },\n  { id: 'jeans', canonical: 'jeans', synonyms: ['jean', 'denim', 'denims', 'denim pants'], required: true, genderClass: 'neutral' },\n  { id: 'shorts', canonical: 'shorts', synonyms: ['short', 'bermuda', 'bermudas', 'hot pants'], required: true, genderClass: 'neutral' },\n  { id: 'skirt', canonical: 'skirt', synonyms: ['skirts', 'miniskirt', 'miniskirts', 'maxiskirt', 'midi skirt', 'maxi skirt', 'pencil skirt', 'a-line skirt'], required: true, genderClass: 'neutral' },\n  { id: 'blazer', canonical: 'blazer', synonyms: ['blazers', 'sport coat', 'suit jacket', 'formal blazer', 'business blazer', 'office blazer', 'casual blazer', 'slim blazer', 'fitted blazer', 'oversized blazer', 'plaid blazer', 'tweed blazer', 'single breasted blazer', 'double breasted blazer', 'ladies blazer', 'womens blazer', 'mens blazer'], required: true, genderClass: 'neutral' },\n  { id: 'jacket', canonical: 'jacket', synonyms: ['jackets', 'bomber jacket', 'bomber', 'denim jacket', 'leather jacket', 'windbreaker', 'rain jacket', 'flight jacket', 'varsity jacket', 'trucker jacket', 'motorcycle jacket', 'biker jacket', 'casual jacket', 'light jacket', 'spring jacket', 'fall jacket', 'jean jacket'], required: true, genderClass: 'neutral' },\n  { id: 'coat', canonical: 'coat', synonyms: ['coats', 'overcoat', 'overcoats', 'trench', 'trench coat', 'parka', 'parkas', 'wool coat', 'long coat', 'fur coat', 'faux fur coat', 'peacoat', 'duffle coat', 'camel coat', 'topcoat', 'cape coat', 'cocoon coat'], required: true, genderClass: 'neutral' },\n  { id: 'puffer', canonical: 'puffer', synonyms: ['puffers', 'puffer jacket', 'puffer coat', 'down jacket', 'down coat', 'padded jacket', 'padded coat', 'quilted jacket', 'quilted coat', 'puffy jacket', 'puffy coat', 'bubble jacket', 'bubble coat', 'winter jacket', 'winter coat', 'warm jacket', 'warm coat'], required: true, genderClass: 'neutral' },\n  { id: 'outerwear', canonical: 'outerwear', synonyms: ['outer wear', 'outdoor jacket', 'outdoor coat'], required: true, genderClass: 'neutral' },\n  { id: 'sweater', canonical: 'sweater', synonyms: ['sweaters', 'pullover', 'pullovers', 'jumper', 'jumpers', 'knitwear', 'knit', 'knits', 'cardigan', 'cardigans'], required: true, genderClass: 'neutral' },\n  { id: 'hoodie', canonical: 'hoodie', synonyms: ['hoodies', 'sweatshirt', 'sweatshirts', 'hooded sweatshirt'], required: true, genderClass: 'neutral' },\n  { id: 'vest', canonical: 'vest', synonyms: ['vests', 'waistcoat', 'waistcoats', 'gilet', 'gilets'], required: true, genderClass: 'neutral' },\n  { id: 'suit', canonical: 'suit', synonyms: ['suits', 'tuxedo', 'tuxedos', 'tux', 'blazer set', 'formal suit'], required: true, genderClass: 'neutral' },\n  { id: 'jumpsuit', canonical: 'jumpsuit', synonyms: ['jumpsuits', 'romper', 'rompers', 'playsuit', 'playsuits', 'one piece', 'onesie', 'onesies', 'overall', 'overalls'], required: true, genderClass: 'neutral' },\n  { id: 'legging', canonical: 'legging', synonyms: ['leggings', 'tights', 'yoga pants', 'yoga leggings', 'activewear pants'], required: true, genderClass: 'neutral' },\n  { id: 'jogger', canonical: 'jogger', synonyms: ['joggers', 'sweatpant', 'sweatpants', 'track pants', 'trackpants'], required: true, genderClass: 'neutral' },\n  { id: 'shoes', canonical: 'shoes', synonyms: ['shoe', 'footwear'], required: true, genderClass: 'neutral' },\n  { id: 'sneakers', canonical: 'sneakers', synonyms: ['sneaker', 'trainer', 'trainers', 'tennis shoes', 'athletic shoes', 'running shoes'], required: true, genderClass: 'neutral' },\n  { id: 'boots', canonical: 'boots', synonyms: ['boot', 'bootie', 'booties', 'ankle boots', 'knee boots', 'combat boots', 'chelsea boots'], required: true, genderClass: 'neutral' },\n  { id: 'sandals', canonical: 'sandals', synonyms: ['sandal', 'flip flop', 'flip flops', 'slides', 'slide', 'thong sandal', 'strappy sandal'], required: true, genderClass: 'neutral' },\n  { id: 'heels', canonical: 'heels', synonyms: ['heel', 'high heel', 'high heels', 'pump', 'pumps', 'stiletto', 'stilettos', 'wedge', 'wedges', 'platform heels'], required: true, genderClass: 'neutral' },\n  { id: 'loafers', canonical: 'loafers', synonyms: ['loafer', 'moccasin', 'moccasins', 'slip on', 'slip ons'], required: true, genderClass: 'neutral' },\n  { id: 'bag', canonical: 'bag', synonyms: ['bags', 'handbag', 'handbags', 'purse', 'purses', 'clutch', 'clutches', 'tote', 'totes', 'satchel', 'satchels', 'shoulder bag', 'crossbody', 'crossbody bag', 'messenger bag', 'backpack', 'backpacks'], required: true, genderClass: 'neutral' },\n  { id: 'wallet', canonical: 'wallet', synonyms: ['wallets', 'billfold', 'card holder', 'card case', 'coin purse'], required: true, genderClass: 'neutral' },\n  { id: 'watch', canonical: 'watch', synonyms: ['watches', 'timepiece', 'timepieces', 'wristwatch', 'wristwatches', 'smartwatch', 'smart watch'], required: true, genderClass: 'neutral' },\n  { id: 'ring', canonical: 'ring', synonyms: ['rings', 'band', 'bands', 'wedding ring', 'engagement ring', 'cocktail ring'], required: true, genderClass: 'neutral' },\n  { id: 'necklace', canonical: 'necklace', synonyms: ['necklaces', 'pendant', 'pendants', 'chain', 'chains', 'choker', 'chokers', 'locket'], required: true, genderClass: 'neutral' },\n  { id: 'earring', canonical: 'earring', synonyms: ['earrings', 'ear ring', 'ear rings', 'stud', 'studs', 'hoop', 'hoops', 'drop earring', 'dangle earring'], required: true, genderClass: 'neutral' },\n  { id: 'bracelet', canonical: 'bracelet', synonyms: ['bracelets', 'bangle', 'bangles', 'wristband', 'wristbands', 'cuff', 'cuffs', 'charm bracelet'], required: true, genderClass: 'neutral' },\n  { id: 'sunglasses', canonical: 'sunglasses', synonyms: ['sunglass', 'shades', 'eyewear', 'glasses', 'aviator', 'aviators'], required: true, genderClass: 'neutral' },\n  { id: 'hat', canonical: 'hat', synonyms: ['hats', 'cap', 'caps', 'beanie', 'beanies', 'fedora', 'fedoras', 'baseball cap', 'bucket hat', 'sun hat'], required: true, genderClass: 'neutral' },\n  { id: 'scarf', canonical: 'scarf', synonyms: ['scarfs', 'scarves', 'wrap', 'wraps', 'shawl', 'shawls', 'pashmina'], required: true, genderClass: 'neutral' },\n  { id: 'belt', canonical: 'belt', synonyms: ['belts', 'waist belt', 'leather belt'], required: true, genderClass: 'neutral' },\n  { id: 'tie', canonical: 'tie', synonyms: ['ties', 'necktie', 'neckties', 'bow tie', 'bowtie'], required: true, genderClass: 'neutral' },\n  { id: 'bikini', canonical: 'bikini', synonyms: ['bikinis', 'swimsuit', 'swimsuits', 'swimming suit', 'bathing suit', 'two piece', 'one piece swimsuit', 'swimwear', 'beachwear'], required: true, genderClass: 'neutral' },\n  { id: 'lingerie', canonical: 'lingerie', synonyms: ['underwear', 'intimates', 'bra', 'bras', 'panty', 'panties', 'thong', 'thongs', 'brief', 'briefs', 'boxer', 'boxers', 'nightgown', 'nightgowns', 'sleepwear', 'pajama', 'pajamas', 'pjs'], required: true, genderClass: 'neutral' },\n];\n\nconst GENDER_CONCEPTS: { id: string; canonical: string; synonyms: string[]; genderClass: GenderClass }[] = [\n  { id: 'female', canonical: 'women', synonyms: ['woman', 'womens', \"women's\", 'female', 'lady', 'ladies', 'girl', 'girls', 'feminine'], genderClass: 'female' },\n  { id: 'male', canonical: 'men', synonyms: ['man', 'mens', \"men's\", 'male', 'gentleman', 'gentlemen', 'boy', 'boys', 'masculine'], genderClass: 'male' },\n  { id: 'kids', canonical: 'kids', synonyms: ['kid', 'child', 'children', 'baby', 'babies', 'infant', 'infants', 'toddler', 'toddlers', 'teen', 'teens', 'teenager'], genderClass: 'neutral' },\n];\n\nconst OPTIONAL_DESCRIPTORS: string[] = [\n  'plus', 'size', 'large', 'small', 'medium', 'xl', 'xxl', 'xs',\n  'casual', 'formal', 'elegant', 'sexy', 'cute', 'vintage', 'boho', 'bohemian', 'classic', 'modern', 'trendy',\n  'summer', 'winter', 'spring', 'autumn', 'fall', 'seasonal',\n  'long', 'short', 'midi', 'maxi', 'mini', 'slim', 'fitted', 'loose', 'oversized',\n  'fashion', 'new', 'hot', 'sale', 'cheap', 'luxury', 'designer', 'brand',\n  'party', 'wedding', 'work', 'office', 'beach', 'gym', 'workout', 'outdoor',\n  'lace', 'cotton', 'silk', 'leather', 'velvet', 'satin', 'chiffon', 'denim', 'wool', 'linen',\n  'floral', 'striped', 'solid', 'printed', 'embroidered', 'sequin', 'ruffle',\n  'black', 'white', 'red', 'blue', 'green', 'pink', 'purple', 'yellow', 'orange', 'brown', 'grey', 'gray', 'beige', 'navy', 'gold', 'silver',\n];\n\ntype AliasMapEntry = {\n  conceptId: string;\n  canonical: string;\n  isProduct: boolean;\n  isGender: boolean;\n  genderClass: GenderClass;\n  required: boolean;\n};\n\nconst aliasMap: Map<string, AliasMapEntry> = new Map();\nconst optionalSet: Set<string> = new Set();\n\nconst COMPOUND_WORDS: Record<string, string> = {\n  'smartwatch': 'smart watch',\n  'smartwatches': 'smart watches',\n  'cardholder': 'card holder',\n  'cardholders': 'card holders',\n  'cardcase': 'card case',\n  'coinpurse': 'coin purse',\n  'handbag': 'hand bag',\n  'handbags': 'hand bags',\n  'crossbody': 'cross body',\n  'backpack': 'back pack',\n  'backpacks': 'back packs',\n  'miniskirt': 'mini skirt',\n  'miniskirts': 'mini skirts',\n  'maxidress': 'maxi dress',\n  'mididress': 'midi dress',\n  'minidress': 'mini dress',\n  'tshirt': 't shirt',\n  'tshirts': 't shirts',\n  'sweatshirt': 'sweat shirt',\n  'sweatshirts': 'sweat shirts',\n  'sweatpants': 'sweat pants',\n  'sweatpant': 'sweat pant',\n  'trackpants': 'track pants',\n  'yogapants': 'yoga pants',\n  'flipflop': 'flip flop',\n  'flipflops': 'flip flops',\n  'highheels': 'high heels',\n  'highheel': 'high heel',\n  'ankleboot': 'ankle boot',\n  'ankleboots': 'ankle boots',\n  'kneeboot': 'knee boot',\n  'kneeboots': 'knee boots',\n  'onepiece': 'one piece',\n  'twopiece': 'two piece',\n  'wristwatch': 'wrist watch',\n  'wristwatches': 'wrist watches',\n  'timepiece': 'time piece',\n  'timepieces': 'time pieces',\n  'neckchain': 'neck chain',\n  'sunglasses': 'sun glasses',\n  'eyewear': 'eye wear',\n  'footwear': 'foot wear',\n  'sleepwear': 'sleep wear',\n  'swimwear': 'swim wear',\n  'activewear': 'active wear',\n  'beachwear': 'beach wear',\n  'knitwear': 'knit wear',\n  'nightgown': 'night gown',\n  'nightgowns': 'night gowns',\n  'bathrobe': 'bath robe',\n  'bathrobes': 'bath robes',\n};\n\nfunction splitCompoundWords(text: string): string {\n  let result = text;\n  for (const [compound, spaced] of Object.entries(COMPOUND_WORDS)) {\n    const regex = new RegExp(`\\\\b${compound}\\\\b`, 'gi');\n    result = result.replace(regex, spaced);\n  }\n  return result;\n}\n\nfunction normalizeForMap(text: string): string {\n  let normalized = text.toLowerCase().replace(/[^a-z0-9\\s]/g, ' ').replace(/\\s+/g, ' ').trim();\n  normalized = splitCompoundWords(normalized);\n  return normalized.replace(/\\s+/g, ' ').trim();\n}\n\nfunction initializeLexicon() {\n  for (const concept of PRODUCT_CONCEPTS) {\n    const allVariants = [concept.canonical, ...concept.synonyms];\n    for (const variant of allVariants) {\n      const normalized = normalizeForMap(variant);\n      if (normalized && !aliasMap.has(normalized)) {\n        aliasMap.set(normalized, {\n          conceptId: concept.id,\n          canonical: concept.canonical,\n          isProduct: true,\n          isGender: false,\n          genderClass: concept.genderClass,\n          required: concept.required,\n        });\n      }\n    }\n  }\n\n  for (const concept of GENDER_CONCEPTS) {\n    const allVariants = [concept.canonical, ...concept.synonyms];\n    for (const variant of allVariants) {\n      const normalized = normalizeForMap(variant);\n      if (normalized && !aliasMap.has(normalized)) {\n        aliasMap.set(normalized, {\n          conceptId: concept.id,\n          canonical: concept.canonical,\n          isProduct: false,\n          isGender: true,\n          genderClass: concept.genderClass,\n          required: false,\n        });\n      }\n    }\n  }\n\n  for (const desc of OPTIONAL_DESCRIPTORS) {\n    optionalSet.add(normalizeForMap(desc));\n  }\n}\n\ninitializeLexicon();\n\nexport function lookupKeyword(keyword: string): AliasMapEntry | null {\n  const normalized = normalizeForMap(keyword);\n  return aliasMap.get(normalized) || null;\n}\n\nexport function isOptionalDescriptor(keyword: string): boolean {\n  const normalized = normalizeForMap(keyword);\n  return optionalSet.has(normalized);\n}\n\nexport function getGenderExclusions(genderClass: GenderClass): string[] {\n  if (genderClass === 'female') {\n    return ['men', 'mens', 'man', 'boy', 'boys', 'male', 'gentleman', 'gentlemen', 'masculine'];\n  }\n  if (genderClass === 'male') {\n    return ['women', 'womens', 'woman', 'girl', 'girls', 'female', 'lady', 'ladies', 'feminine'];\n  }\n  return [];\n}\n\nexport function classifyQuery(rawQuery: string): {\n  requiredConcepts: Set<string>;\n  optionalTokens: string[];\n  genderFilter: GenderClass;\n  genderExclusions: string[];\n} {\n  const requiredConcepts = new Set<string>();\n  const optionalTokens: string[] = [];\n  let genderFilter: GenderClass = 'neutral';\n  \n  const normalizedQuery = normalizeForMap(rawQuery);\n  const tokens = normalizedQuery.split(' ').filter(t => t.length >= 1);\n  const consumed = new Array(tokens.length).fill(false);\n  \n  for (let n = 3; n >= 1; n--) {\n    for (let i = 0; i <= tokens.length - n; i++) {\n      if (consumed.slice(i, i + n).some(c => c)) continue;\n      \n      const phrase = tokens.slice(i, i + n).join(' ');\n      const entry = lookupKeyword(phrase);\n      \n      if (entry) {\n        if (entry.isProduct && entry.required) {\n          requiredConcepts.add(entry.conceptId);\n        }\n        if (entry.isGender && entry.genderClass !== 'neutral') {\n          genderFilter = entry.genderClass;\n        }\n        \n        for (let j = i; j < i + n; j++) {\n          consumed[j] = true;\n        }\n      }\n    }\n  }\n\n  for (let i = 0; i < tokens.length; i++) {\n    if (!consumed[i] && isOptionalDescriptor(tokens[i])) {\n      optionalTokens.push(tokens[i]);\n    }\n  }\n\n  const genderExclusions = getGenderExclusions(genderFilter);\n\n  return { requiredConcepts, optionalTokens, genderFilter, genderExclusions };\n}\n\nexport function classifyTokens(tokens: string[]): {\n  requiredConcepts: Set<string>;\n  optionalTokens: string[];\n  genderFilter: GenderClass;\n  genderExclusions: string[];\n} {\n  return classifyQuery(tokens.join(' '));\n}\n\nfunction hasWordBoundaryMatch(text: string, phrase: string): boolean {\n  if (phrase.includes(' ')) {\n    const phraseTokens = phrase.split(' ');\n    const textTokens = text.split(' ');\n    \n    for (let i = 0; i <= textTokens.length - phraseTokens.length; i++) {\n      let allMatch = true;\n      for (let j = 0; j < phraseTokens.length; j++) {\n        if (textTokens[i + j] !== phraseTokens[j]) {\n          allMatch = false;\n          break;\n        }\n      }\n      if (allMatch) return true;\n    }\n    return false;\n  } else {\n    const regex = new RegExp(`\\\\b${phrase}\\\\b`);\n    return regex.test(text);\n  }\n}\n\nexport function matchProductName(productName: string, requiredConcepts: Set<string>, genderExclusions: string[]): {\n  matches: boolean;\n  score: number;\n  matchedConcepts: Set<string>;\n} {\n  const normalizedName = normalizeForMap(productName);\n  const nameTokens = normalizedName.split(' ').filter(t => t.length >= 1);\n\n  for (const exclusion of genderExclusions) {\n    if (hasWordBoundaryMatch(normalizedName, exclusion)) {\n      return { matches: false, score: 0, matchedConcepts: new Set() };\n    }\n  }\n\n  const matchedConcepts = new Set<string>();\n\n  for (let n = 3; n >= 1; n--) {\n    for (let i = 0; i <= nameTokens.length - n; i++) {\n      const phrase = nameTokens.slice(i, i + n).join(' ');\n      const entry = lookupKeyword(phrase);\n      if (entry && entry.isProduct) {\n        matchedConcepts.add(entry.conceptId);\n      }\n    }\n  }\n\n  let requiredMatches = 0;\n  for (const concept of requiredConcepts) {\n    if (matchedConcepts.has(concept)) {\n      requiredMatches++;\n    }\n  }\n\n  const requiredCount = requiredConcepts.size;\n  const allRequiredMatch = requiredCount === 0 || requiredMatches === requiredCount;\n  const score = requiredCount > 0 \n    ? (requiredMatches / requiredCount) * 0.8 + (matchedConcepts.size > 0 ? 0.2 : 0)\n    : (matchedConcepts.size > 0 ? 0.7 : 0.3);\n\n  return { matches: allRequiredMatch, score, matchedConcepts };\n}\n\nexport function smartProductMatch(productName: string, searchQuery: string): {\n  matches: boolean;\n  score: number;\n} {\n  const { requiredConcepts, genderExclusions } = classifyQuery(searchQuery);\n  const result = matchProductName(productName, requiredConcepts, genderExclusions);\n  \n  return { matches: result.matches, score: result.score };\n}\n","path":null,"size_bytes":18309,"size_tokens":null},"src/lib/db/replit-pg.ts":{"content":"import { Pool, PoolClient } from 'pg';\n\nlet pool: Pool | null = null;\nlet lastPoolError: string | null = null;\n\nexport function getPool(): Pool {\n  const connectionString = process.env.DATABASE_URL;\n  if (!connectionString) {\n    console.error('[DB] DATABASE_URL environment variable is not set');\n    throw new Error('Database connection not available. Please ensure DATABASE_URL is configured.');\n  }\n  \n  if (!pool) {\n    console.log('[DB] Creating new connection pool...');\n    const sslRequired = connectionString.includes('sslmode=require') || \n                        connectionString.includes('.supabase.co') ||\n                        connectionString.includes('.neon.tech') ||\n                        process.env.NODE_ENV === 'production';\n    \n    pool = new Pool({\n      connectionString,\n      ssl: sslRequired ? { rejectUnauthorized: false } : false,\n      max: 10,\n      idleTimeoutMillis: 30000,\n      connectionTimeoutMillis: 15000,\n    });\n    \n    pool.on('error', (err) => {\n      console.error('[DB] Unexpected database pool error:', err?.message || err);\n      lastPoolError = err?.message || 'Unknown pool error';\n      pool = null;\n    });\n    \n    pool.on('connect', () => {\n      console.log('[DB] New client connected to pool');\n      lastPoolError = null;\n    });\n  }\n  return pool;\n}\n\nexport function isDatabaseConfigured(): boolean {\n  return !!process.env.DATABASE_URL;\n}\n\nexport function getLastPoolError(): string | null {\n  return lastPoolError;\n}\n\nexport async function testConnection(): Promise<{ ok: boolean; error?: string }> {\n  try {\n    if (!isDatabaseConfigured()) {\n      return { ok: false, error: 'DATABASE_URL not configured' };\n    }\n    const client = await getPool().connect();\n    try {\n      await client.query('SELECT 1');\n      return { ok: true };\n    } finally {\n      client.release();\n    }\n  } catch (e: any) {\n    console.error('[DB] Connection test failed:', e?.message);\n    return { ok: false, error: e?.message || 'Connection failed' };\n  }\n}\n\nexport async function query<T = any>(sql: string, params?: any[]): Promise<T[]> {\n  let client: PoolClient | null = null;\n  try {\n    client = await getPool().connect();\n    const result = await client.query(sql, params);\n    return result.rows as T[];\n  } catch (e: any) {\n    console.error('[DB] Query error:', e?.message, 'SQL:', sql.slice(0, 100));\n    throw e;\n  } finally {\n    if (client) client.release();\n  }\n}\n\nexport async function queryOne<T = any>(sql: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(sql, params);\n  return rows[0] || null;\n}\n\nexport async function execute(sql: string, params?: any[]): Promise<{ rowCount: number }> {\n  let client: PoolClient | null = null;\n  try {\n    client = await getPool().connect();\n    const result = await client.query(sql, params);\n    return { rowCount: result.rowCount || 0 };\n  } catch (e: any) {\n    console.error('[DB] Execute error:', e?.message, 'SQL:', sql.slice(0, 100));\n    throw e;\n  } finally {\n    if (client) client.release();\n  }\n}\n","path":null,"size_bytes":3039,"size_tokens":null},"src/app/api/admin/sync/changes/route.ts":{"content":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nexport async function GET(req: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { searchParams } = new URL(req.url);\n    const status = searchParams.get(\"status\") || \"pending\";\n    const limit = Math.min(100, Number(searchParams.get(\"limit\") || 50));\n\n    let query = admin\n      .from(\"daily_sync_changes\")\n      .select(\"*\")\n      .order(\"created_at\", { ascending: false })\n      .limit(limit);\n\n    if (status !== \"all\") {\n      query = query.eq(\"status\", status);\n    }\n\n    const { data: changes, error } = await query;\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    const { data: allChanges } = await admin\n      .from(\"daily_sync_changes\")\n      .select(\"status, change_type\");\n\n    const stats = {\n      pending: 0,\n      applied: 0,\n      dismissed: 0,\n      price_changes: 0,\n      stock_changes: 0,\n      out_of_stock: 0,\n    };\n\n    (allChanges || []).forEach((c: any) => {\n      if (c.status === \"pending\") stats.pending++;\n      else if (c.status === \"applied\") stats.applied++;\n      else if (c.status === \"dismissed\") stats.dismissed++;\n      \n      if (c.change_type?.includes(\"price\")) stats.price_changes++;\n      if (c.change_type?.includes(\"stock\")) stats.stock_changes++;\n      if (c.change_type === \"stock_out\") stats.out_of_stock++;\n    });\n\n    const { data: lastSyncRow } = await admin\n      .from(\"kv_settings\")\n      .select(\"value\")\n      .eq(\"key\", \"last_sync_run\")\n      .maybeSingle();\n\n    return NextResponse.json({\n      ok: true,\n      changes: changes || [],\n      stats,\n      lastSync: lastSyncRow?.value?.timestamp || null,\n    });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function PATCH(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { id, action } = body;\n\n    if (!id || !action) {\n      return NextResponse.json({ ok: false, error: \"Missing id or action\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    let updateData: Record<string, any> = {};\n\n    if (action === \"apply\") {\n      updateData = { status: \"applied\", applied_at: new Date().toISOString() };\n      \n      const { data: change } = await admin\n        .from(\"daily_sync_changes\")\n        .select(\"*\")\n        .eq(\"id\", id)\n        .single();\n\n      if (change && change.shopixo_product_id) {\n        if (change.field_changed === \"price\") {\n          await admin\n            .from(\"products\")\n            .update({ price: Number(change.new_value) })\n            .eq(\"id\", change.shopixo_product_id);\n        } else if (change.field_changed === \"stock\") {\n          const newStock = Number(change.new_value);\n          await admin\n            .from(\"products\")\n            .update({ \n              stock: newStock,\n              active: newStock > 0,\n            })\n            .eq(\"id\", change.shopixo_product_id);\n        }\n      }\n    } else if (action === \"dismiss\") {\n      updateData = { status: \"dismissed\" };\n    } else {\n      return NextResponse.json({ ok: false, error: \"Invalid action\" }, { status: 400 });\n    }\n\n    const { error } = await admin\n      .from(\"daily_sync_changes\")\n      .update(updateData)\n      .eq(\"id\", id);\n\n    if (error) {\n      return NextResponse.json({ ok: false, error: error.message }, { status: 500 });\n    }\n\n    return NextResponse.json({ ok: true });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { action } = body;\n\n    if (action !== \"apply_all\") {\n      return NextResponse.json({ ok: false, error: \"Invalid action\" }, { status: 400 });\n    }\n\n    const admin = getSupabaseAdmin();\n    if (!admin) {\n      return NextResponse.json({ ok: false, error: \"Database not configured\" }, { status: 500 });\n    }\n\n    const { data: pendingChanges } = await admin\n      .from(\"daily_sync_changes\")\n      .select(\"*\")\n      .eq(\"status\", \"pending\");\n\n    let appliedCount = 0;\n\n    for (const change of (pendingChanges || [])) {\n      if (change.shopixo_product_id) {\n        if (change.field_changed === \"price\") {\n          await admin\n            .from(\"products\")\n            .update({ price: Number(change.new_value) })\n            .eq(\"id\", change.shopixo_product_id);\n        } else if (change.field_changed === \"stock\") {\n          const newStock = Number(change.new_value);\n          await admin\n            .from(\"products\")\n            .update({ \n              stock: newStock,\n              active: newStock > 0,\n            })\n            .eq(\"id\", change.shopixo_product_id);\n        }\n      }\n\n      await admin\n        .from(\"daily_sync_changes\")\n        .update({ status: \"applied\", applied_at: new Date().toISOString() })\n        .eq(\"id\", change.id);\n      \n      appliedCount++;\n    }\n\n    return NextResponse.json({ ok: true, applied: appliedCount });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || \"Server error\" }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":5720,"size_tokens":null},"src/lib/db/import-db.ts":{"content":"import { createClient, SupabaseClient } from '@supabase/supabase-js';\n\nlet supabaseAdmin: SupabaseClient | null = null;\n\nfunction getSupabaseAdmin(): SupabaseClient | null {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) {\n    console.error('[Import DB] Missing Supabase credentials:', { url: !!url, key: !!key });\n    return null;\n  }\n  if (!supabaseAdmin) {\n    supabaseAdmin = createClient(url, key);\n  }\n  return supabaseAdmin;\n}\n\nexport function isImportDbConfigured(): boolean {\n  return !!(process.env.NEXT_PUBLIC_SUPABASE_URL && process.env.SUPABASE_SERVICE_ROLE_KEY);\n}\n\nexport async function testImportDbConnection(): Promise<{ ok: boolean; error?: string }> {\n  try {\n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return { ok: false, error: 'Supabase not configured' };\n    }\n    const { error } = await supabase.from('import_batches').select('id').limit(1);\n    if (error) {\n      if (error.message.includes('does not exist')) {\n        return { ok: false, error: 'Import tables not found. Please run the database migration.' };\n      }\n      return { ok: false, error: error.message };\n    }\n    return { ok: true };\n  } catch (e: any) {\n    return { ok: false, error: e?.message || 'Connection failed' };\n  }\n}\n\nexport async function createImportBatch(data: {\n  name: string;\n  keywords: string;\n  category: string;\n  filters: any;\n  productsFound: number;\n}): Promise<{ id: number } | null> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return null;\n\n  const { data: batch, error } = await supabase\n    .from('import_batches')\n    .insert({\n      name: data.name,\n      keywords: data.keywords,\n      category: data.category,\n      filters: data.filters,\n      status: 'active',\n      products_found: data.productsFound,\n      products_approved: 0,\n      products_imported: 0,\n    })\n    .select('id')\n    .single();\n\n  if (error) {\n    console.error('[Import DB] Failed to create batch:', error.message);\n    return null;\n  }\n  return batch;\n}\n\nexport async function addProductToQueue(batchId: number, product: {\n  productId: string;\n  cjSku?: string;\n  name: string;\n  description?: string;\n  category: string;\n  images: string[];\n  videoUrl?: string;\n  variants: any[];\n  avgPrice: number;\n  supplierRating?: number;\n  totalSales?: number;\n  totalStock: number;\n  processingDays?: number;\n  deliveryDaysMin?: number;\n  deliveryDaysMax?: number;\n  qualityScore?: number;\n}): Promise<{ success: boolean; error?: string }> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return { success: false, error: 'Supabase not configured' };\n\n  const productData = {\n    batch_id: batchId,\n    cj_product_id: product.productId,\n    cj_sku: product.cjSku || null,\n    name_en: product.name,\n    name_ar: null,\n    description_en: product.description || null,\n    description_ar: null,\n    category: product.category,\n    images: product.images,\n    video_url: product.videoUrl || null,\n    variants: product.variants,\n    cj_price_usd: product.avgPrice,\n    shipping_cost_usd: null,\n    calculated_retail_sar: null,\n    margin_applied: null,\n    supplier_rating: product.supplierRating || 4.0,\n    total_sales: product.totalSales || 0,\n    stock_total: product.totalStock,\n    processing_days: product.processingDays || 3,\n    delivery_days_min: product.deliveryDaysMin || 7,\n    delivery_days_max: product.deliveryDaysMax || 15,\n    quality_score: product.qualityScore || 0.75,\n    status: 'pending',\n    admin_notes: null,\n    reviewed_by: null,\n    reviewed_at: null,\n    shopixo_product_id: null,\n    imported_at: null,\n    updated_at: new Date().toISOString(),\n  };\n\n  // First check if product already exists\n  const { data: existing } = await supabase\n    .from('product_queue')\n    .select('id')\n    .eq('cj_product_id', product.productId)\n    .maybeSingle();\n\n  let error;\n  if (existing) {\n    // Update existing product\n    const result = await supabase\n      .from('product_queue')\n      .update(productData)\n      .eq('cj_product_id', product.productId);\n    error = result.error;\n  } else {\n    // Insert new product\n    const result = await supabase\n      .from('product_queue')\n      .insert(productData);\n    error = result.error;\n  }\n\n  if (error) {\n    const errorMsg = `${error.message} (code: ${error.code})${error.details ? ` - ${error.details}` : ''}`;\n    console.error('[Import DB] Failed to add product to queue:', {\n      message: error.message,\n      code: error.code,\n      details: error.details,\n      hint: error.hint,\n      productId: product.productId\n    });\n    return { success: false, error: errorMsg };\n  }\n  return { success: true };\n}\n\nexport async function logImportAction(batchId: number, action: string, status: string, details: any): Promise<void> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return;\n\n  await supabase.from('import_logs').insert({\n    batch_id: batchId,\n    action,\n    status,\n    details,\n  });\n}\n\nexport async function getQueuedProducts(options: {\n  status?: string;\n  batchId?: number;\n  limit?: number;\n  offset?: number;\n}): Promise<any[]> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return [];\n\n  let query = supabase.from('product_queue').select('*');\n\n  if (options.status) {\n    query = query.eq('status', options.status);\n  }\n  if (options.batchId) {\n    query = query.eq('batch_id', options.batchId);\n  }\n  \n  query = query.order('created_at', { ascending: false });\n  \n  if (options.limit) {\n    query = query.limit(options.limit);\n  }\n  if (options.offset) {\n    query = query.range(options.offset, options.offset + (options.limit || 50) - 1);\n  }\n\n  const { data, error } = await query;\n  if (error) {\n    console.error('[Import DB] Failed to get queued products:', error.message);\n    return [];\n  }\n  return data || [];\n}\n\nexport async function updateProductStatus(productId: string, status: string, notes?: string): Promise<boolean> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return false;\n\n  const { error } = await supabase\n    .from('product_queue')\n    .update({\n      status,\n      admin_notes: notes || null,\n      reviewed_at: new Date().toISOString(),\n    })\n    .eq('cj_product_id', productId);\n\n  if (error) {\n    console.error('[Import DB] Failed to update product status:', error.message);\n    return false;\n  }\n  return true;\n}\n\nexport async function getBatches(limit: number = 50): Promise<any[]> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return [];\n\n  const { data, error } = await supabase\n    .from('import_batches')\n    .select('*')\n    .order('created_at', { ascending: false })\n    .limit(limit);\n\n  if (error) {\n    console.error('[Import DB] Failed to get batches:', error.message);\n    return [];\n  }\n  return data || [];\n}\n\nexport async function getQueueStats(): Promise<{ pending: number; approved: number; rejected: number; imported: number }> {\n  const supabase = getSupabaseAdmin();\n  if (!supabase) return { pending: 0, approved: 0, rejected: 0, imported: 0 };\n\n  const [pending, approved, rejected, imported] = await Promise.all([\n    supabase.from('product_queue').select('id', { count: 'exact', head: true }).eq('status', 'pending'),\n    supabase.from('product_queue').select('id', { count: 'exact', head: true }).eq('status', 'approved'),\n    supabase.from('product_queue').select('id', { count: 'exact', head: true }).eq('status', 'rejected'),\n    supabase.from('product_queue').select('id', { count: 'exact', head: true }).eq('status', 'imported'),\n  ]);\n\n  return {\n    pending: pending.count || 0,\n    approved: approved.count || 0,\n    rejected: rejected.count || 0,\n    imported: imported.count || 0,\n  };\n}\n","path":null,"size_bytes":7711,"size_tokens":null},"src/lib/cj/rate-limit.ts":{"content":"const CJ_REQUEST_INTERVAL_MS = 1100;\n\nlet lastRequestTime = 0;\n\nexport async function throttleCjRequest<T>(fn: () => Promise<T>): Promise<T> {\n  const now = Date.now();\n  const elapsed = now - lastRequestTime;\n  const waitTime = Math.max(0, CJ_REQUEST_INTERVAL_MS - elapsed);\n  \n  if (waitTime > 0) {\n    await new Promise(resolve => setTimeout(resolve, waitTime));\n  }\n  \n  lastRequestTime = Date.now();\n  return fn();\n}\n","path":null,"size_bytes":422,"size_tokens":null},"src/app/api/admin/cj/products/enrich/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { loggerForRequest } from '@/lib/log';\nimport { getAccessToken, queryVariantInventory, freightCalculate } from '@/lib/cj/v2';\nimport { fetchJson } from '@/lib/http';\n\nconst CJ_BASE = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n\nexport type EnrichedProduct = {\n  pid: string;\n  nameEn: string;\n  nameAr: string | null;\n  descriptionEn: string | null;\n  descriptionAr: string | null;\n  image: string | null;\n  images: string[];\n  supplierRating: number;\n  colors: string[];\n  sizes: string[];\n  variants: Array<{\n    sku: string;\n    color: string | null;\n    size: string | null;\n    price: number;\n    cjStock: number;\n    factoryStock: number;\n    totalStock: number;\n  }>;\n  totalCjStock: number;\n  totalFactoryStock: number;\n  totalStock: number;\n  processingTimeHours: number | null;\n  processingTimeDisplay: string | null;\n  shippingToSA: {\n    estimatedDays: { min?: number; max?: number } | null;\n    shippingCost: number | null;\n    shippingMethod: string | null;\n  } | null;\n  notes: string | null;\n  sourceUrl: string | null;\n  categoryId: string | null;\n  categoryName: string | null;\n};\n\nasync function fetchProductDetail(token: string, pid: string): Promise<any> {\n  try {\n    const res = await fetchJson<any>(`${CJ_BASE}/product/query?pid=${encodeURIComponent(pid)}`, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 15000,\n    });\n    return res?.data || null;\n  } catch (e: any) {\n    console.log(`[Enrich] Error fetching product detail for ${pid}:`, e?.message);\n    return null;\n  }\n}\n\nasync function fetchProductVariants(token: string, pid: string): Promise<any[]> {\n  try {\n    const res = await fetchJson<any>(`${CJ_BASE}/product/variant/query?pid=${encodeURIComponent(pid)}`, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 15000,\n    });\n    const data = res?.data;\n    return Array.isArray(data) ? data : (data?.list || data?.variants || []);\n  } catch (e: any) {\n    console.log(`[Enrich] Error fetching variants for ${pid}:`, e?.message);\n    return [];\n  }\n}\n\nfunction extractColorAndSize(variant: any): { color: string | null; size: string | null } {\n  let color: string | null = null;\n  let size: string | null = null;\n  \n  color = variant.color || variant.colour || variant.Color || null;\n  size = variant.size || variant.Size || null;\n  \n  if (variant.attributes) {\n    if (typeof variant.attributes === 'object' && !Array.isArray(variant.attributes)) {\n      color = color || variant.attributes.color || variant.attributes.Color || variant.attributes.colour || null;\n      size = size || variant.attributes.size || variant.attributes.Size || null;\n    } else if (Array.isArray(variant.attributes)) {\n      for (const attr of variant.attributes) {\n        const key = String(attr?.name || attr?.key || '').toLowerCase();\n        const val = String(attr?.value || attr?.v || '');\n        if (key.includes('color') || key.includes('colour')) color = color || val;\n        if (key.includes('size')) size = size || val;\n      }\n    }\n  }\n  \n  if (Array.isArray(variant.attributeList)) {\n    for (const attr of variant.attributeList) {\n      const key = String(attr?.name || attr?.key || '').toLowerCase();\n      const val = String(attr?.value || '');\n      if (key.includes('color') || key.includes('colour')) color = color || val;\n      if (key.includes('size')) size = size || val;\n    }\n  }\n  \n  const variantKey = variant.variantKey || variant.variantName || variant.skuName || variant.variantNameEn || '';\n  if (typeof variantKey === 'string' && variantKey && (!color || !size)) {\n    const parts = variantKey.split(/[\\-\\/|,;:&]+/).map(s => s.trim()).filter(Boolean);\n    const sizeTokens = new Set(['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL', '2XL', '3XL', '4XL', '5XL', 'ONE SIZE', 'FREE SIZE', 'OS', 'ONESIZE']);\n    const sizePatterns = [\n      /^\\d+(\\.\\d+)?$/, // numeric sizes like \"38\", \"42.5\"\n      /^\\d+[A-Z]?$/, // sizes like \"32A\", \"36B\"\n      /^\\d+[-x]\\d+$/i, // ranges like \"32-34\", \"10x12\"\n      /^(EU|US|UK)\\s*\\d+/i, // EU38, US7, UK5\n    ];\n    for (const p of parts) {\n      const upper = p.toUpperCase();\n      const isSize = sizeTokens.has(upper) || sizePatterns.some(pat => pat.test(p));\n      if (!size && isSize) {\n        size = p;\n      } else if (!color && p.length > 1 && !isSize) {\n        color = p;\n      }\n    }\n  }\n  \n  return { color, size };\n}\n\nfunction formatProcessingTime(hours: number | null): string | null {\n  if (hours === null || hours <= 0) return null;\n  if (hours < 24) return `${hours} hours`;\n  const days = Math.round(hours / 24);\n  return days === 1 ? '1 day' : `${days} days`;\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json({ ok: false, error: guard.reason }, { status: 401 });\n    }\n    \n    const { searchParams } = new URL(req.url);\n    const pid = searchParams.get('pid');\n    \n    if (!pid) {\n      return NextResponse.json({ ok: false, error: 'Missing pid parameter' }, { status: 400 });\n    }\n    \n    const token = await getAccessToken();\n    \n    const [productDetail, rawVariants, inventoryData] = await Promise.all([\n      fetchProductDetail(token, pid),\n      fetchProductVariants(token, pid),\n      queryVariantInventory(pid).catch(() => []),\n    ]);\n    \n    if (!productDetail) {\n      return NextResponse.json({ ok: false, error: 'Product not found' }, { status: 404 });\n    }\n    \n    const inventoryBySku = new Map<string, { cjStock: number; factoryStock: number; totalStock: number }>();\n    for (const inv of inventoryData) {\n      inventoryBySku.set(inv.variantSku, {\n        cjStock: inv.cjStock,\n        factoryStock: inv.factoryStock,\n        totalStock: inv.totalStock,\n      });\n    }\n    \n    const colorsSet = new Set<string>();\n    const sizesSet = new Set<string>();\n    const variants: EnrichedProduct['variants'] = [];\n    \n    for (const v of rawVariants) {\n      const sku = v.variantSku || v.vid || v.sku || v.skuId || '';\n      const { color, size } = extractColorAndSize(v);\n      const price = Number(v.variantSellPrice || v.sellPrice || v.variantPrice || v.price || 0);\n      \n      if (color) colorsSet.add(color);\n      if (size) sizesSet.add(size);\n      \n      const inv = inventoryBySku.get(sku);\n      variants.push({\n        sku,\n        color,\n        size,\n        price,\n        cjStock: inv?.cjStock || 0,\n        factoryStock: inv?.factoryStock || 0,\n        totalStock: inv?.totalStock || 0,\n      });\n    }\n    \n    const totalCjStock = variants.reduce((sum, v) => sum + v.cjStock, 0);\n    const totalFactoryStock = variants.reduce((sum, v) => sum + v.factoryStock, 0);\n    const totalStock = totalCjStock + totalFactoryStock;\n    \n    const processingTimeRaw = Number(productDetail.processingTime || productDetail.handleTime || productDetail.handlingTime || 0);\n    const processingTimeHours = processingTimeRaw > 0 ? (processingTimeRaw <= 60 ? processingTimeRaw * 24 : processingTimeRaw) : null;\n    \n    let shippingToSA: EnrichedProduct['shippingToSA'] = null;\n    try {\n      const freight = await freightCalculate({\n        countryCode: 'SA',\n        pid: pid,\n        quantity: 1,\n      });\n      if (freight.options.length > 0) {\n        const best = freight.options.sort((a, b) => (a.logisticAgingDays?.min || 999) - (b.logisticAgingDays?.min || 999))[0];\n        shippingToSA = {\n          estimatedDays: best.logisticAgingDays || null,\n          shippingCost: best.price,\n          shippingMethod: best.name,\n        };\n      }\n    } catch (e: any) {\n      console.log(`[Enrich] Shipping calculation failed for ${pid}:`, e?.message);\n    }\n    \n    const nameEn = productDetail.productNameEn || productDetail.nameEn || productDetail.englishName || productDetail.productName || productDetail.name || 'Untitled';\n    const nameAr = productDetail.productNameAr || productDetail.nameAr || productDetail.arabicName || null;\n    const descriptionEn = productDetail.productDescEn || productDetail.descriptionEn || productDetail.description || productDetail.productDesc || null;\n    const descriptionAr = productDetail.productDescAr || productDetail.descriptionAr || null;\n    \n    const images: string[] = [];\n    const mainImage = productDetail.productImage || productDetail.bigImage || productDetail.image || productDetail.mainImage || null;\n    if (mainImage) images.push(mainImage);\n    \n    const imageArrays = [productDetail.imageList, productDetail.productImageList, productDetail.productImages];\n    for (const arr of imageArrays) {\n      if (Array.isArray(arr)) {\n        for (const img of arr) {\n          const url = typeof img === 'string' ? img : (img?.imageUrl || img?.url || null);\n          if (url && !images.includes(url)) images.push(url);\n        }\n      }\n    }\n    \n    const supplierRating = Number(productDetail.supplierScore || productDetail.supplierRating || productDetail.score || productDetail.rating || 0);\n    \n    const enriched: EnrichedProduct = {\n      pid,\n      nameEn,\n      nameAr,\n      descriptionEn,\n      descriptionAr,\n      image: images[0] || null,\n      images,\n      supplierRating,\n      colors: Array.from(colorsSet).sort(),\n      sizes: Array.from(sizesSet).sort((a, b) => {\n        const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL', '2XL', '3XL', '4XL', '5XL'];\n        const aIdx = sizeOrder.indexOf(a.toUpperCase());\n        const bIdx = sizeOrder.indexOf(b.toUpperCase());\n        if (aIdx >= 0 && bIdx >= 0) return aIdx - bIdx;\n        if (aIdx >= 0) return -1;\n        if (bIdx >= 0) return 1;\n        return a.localeCompare(b);\n      }),\n      variants,\n      totalCjStock,\n      totalFactoryStock,\n      totalStock,\n      processingTimeHours,\n      processingTimeDisplay: formatProcessingTime(processingTimeHours),\n      shippingToSA,\n      notes: productDetail.notes || productDetail.remark || productDetail.memo || null,\n      sourceUrl: productDetail.productUrl || productDetail.url || null,\n      categoryId: productDetail.categoryId || null,\n      categoryName: productDetail.categoryName || null,\n    };\n    \n    const r = NextResponse.json({ ok: true, data: enriched }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n    \n  } catch (e: any) {\n    console.error('[Enrich] Error:', e);\n    const r = NextResponse.json({ ok: false, error: e?.message || 'Unknown error' }, { status: 500 });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":10804,"size_tokens":null},"src/app/api/admin/health/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getAccessToken } from '@/lib/cj/v2';\nimport { getSupabaseAnonServer } from '@/lib/supabase-server';\n\nexport const dynamic = 'force-dynamic';\n\ntype ServiceStatus = 'ok' | 'error' | 'unknown';\n\ninterface HealthCheckResult {\n  service: string;\n  status: ServiceStatus;\n  message: string;\n  latencyMs?: number;\n}\n\nasync function checkCJApi(): Promise<HealthCheckResult> {\n  const start = Date.now();\n  try {\n    const token = await getAccessToken();\n    const latency = Date.now() - start;\n    \n    if (token) {\n      return {\n        service: 'CJ Dropshipping API',\n        status: 'ok',\n        message: 'Connected and authenticated',\n        latencyMs: latency,\n      };\n    } else {\n      return {\n        service: 'CJ Dropshipping API',\n        status: 'error',\n        message: 'Failed to get access token',\n        latencyMs: latency,\n      };\n    }\n  } catch (e: any) {\n    return {\n      service: 'CJ Dropshipping API',\n      status: 'error',\n      message: e?.message || 'Connection failed',\n      latencyMs: Date.now() - start,\n    };\n  }\n}\n\nasync function checkDatabase(): Promise<HealthCheckResult> {\n  const start = Date.now();\n  try {\n    const supabase = getSupabaseAnonServer();\n    if (!supabase) {\n      return {\n        service: 'Database',\n        status: 'error',\n        message: 'Supabase not configured',\n      };\n    }\n    \n    // Use products table which is more reliable in schema cache\n    const { error } = await supabase.from('products').select('id').limit(1);\n    const latency = Date.now() - start;\n    \n    if (error) {\n      // Check if it's just an empty table vs real error\n      if (error.message.includes('schema cache')) {\n        return {\n          service: 'Database',\n          status: 'ok',\n          message: 'Connected (schema caching)',\n          latencyMs: latency,\n        };\n      }\n      return {\n        service: 'Database',\n        status: 'error',\n        message: error.message,\n        latencyMs: latency,\n      };\n    }\n    \n    return {\n      service: 'Database',\n      status: 'ok',\n      message: 'Connected',\n      latencyMs: latency,\n    };\n  } catch (e: any) {\n    return {\n      service: 'Database',\n      status: 'error',\n      message: e?.message || 'Connection failed',\n      latencyMs: Date.now() - start,\n    };\n  }\n}\n\nasync function checkStripe(): Promise<HealthCheckResult> {\n  const start = Date.now();\n  try {\n    const stripeKey = process.env.STRIPE_SECRET_KEY;\n    \n    if (!stripeKey) {\n      return {\n        service: 'Stripe Payments',\n        status: 'unknown',\n        message: 'API key not configured',\n      };\n    }\n    \n    return {\n      service: 'Stripe Payments',\n      status: 'ok',\n      message: 'API key configured',\n      latencyMs: Date.now() - start,\n    };\n  } catch (e: any) {\n    return {\n      service: 'Stripe Payments',\n      status: 'error',\n      message: e?.message || 'Check failed',\n      latencyMs: Date.now() - start,\n    };\n  }\n}\n\nexport async function GET() {\n  try {\n    const [cjResult, dbResult, stripeResult] = await Promise.all([\n      checkCJApi(),\n      checkDatabase(),\n      checkStripe(),\n    ]);\n    \n    const allServices = [cjResult, dbResult, stripeResult];\n    const overallStatus = allServices.every(s => s.status === 'ok') ? 'ok' :\n                         allServices.some(s => s.status === 'error') ? 'error' : 'unknown';\n    \n    return NextResponse.json({\n      ok: true,\n      status: overallStatus,\n      services: allServices,\n      timestamp: new Date().toISOString(),\n    });\n  } catch (e: any) {\n    return NextResponse.json({\n      ok: false,\n      status: 'error',\n      error: e?.message || 'Health check failed',\n    }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":3733,"size_tokens":null},"src/lib/error-logger.ts":{"content":"\"use server\";\n\nimport { getSupabaseAnonServer } from \"@/lib/supabase-server\";\n\nexport type ErrorType = \n  | 'cj_api'\n  | 'search'\n  | 'shipping'\n  | 'pricing'\n  | 'database'\n  | 'auth'\n  | 'payment'\n  | 'general';\n\nexport interface ErrorLogEntry {\n  error_type: ErrorType;\n  error_code?: string;\n  message: string;\n  details?: Record<string, any>;\n  page?: string;\n  user_email?: string;\n}\n\nexport async function logError(entry: ErrorLogEntry): Promise<{ ok: boolean; id?: number }> {\n  try {\n    const supabase = getSupabaseAnonServer();\n    if (!supabase) {\n      console.error('[ErrorLogger] Supabase not configured');\n      return { ok: false };\n    }\n    \n    const { data, error } = await supabase\n      .from('error_logs')\n      .insert({\n        error_type: entry.error_type,\n        error_code: entry.error_code || null,\n        message: entry.message,\n        details: entry.details || {},\n        page: entry.page || null,\n        user_email: entry.user_email || null,\n      })\n      .select('id')\n      .single();\n    \n    if (error) {\n      console.error('[ErrorLogger] Failed to log error:', error);\n      return { ok: false };\n    }\n    \n    return { ok: true, id: data?.id };\n  } catch (e) {\n    console.error('[ErrorLogger] Exception while logging:', e);\n    return { ok: false };\n  }\n}\n\nexport async function getRecentErrors(limit: number = 50): Promise<any[]> {\n  try {\n    const supabase = getSupabaseAnonServer();\n    if (!supabase) return [];\n    \n    const { data, error } = await supabase\n      .from('error_logs')\n      .select('*')\n      .order('created_at', { ascending: false })\n      .limit(limit);\n    \n    if (error) {\n      console.error('[ErrorLogger] Failed to fetch errors:', error);\n      return [];\n    }\n    \n    return data || [];\n  } catch (e) {\n    console.error('[ErrorLogger] Exception while fetching:', e);\n    return [];\n  }\n}\n\nexport async function getErrorNotificationMode(): Promise<'visible' | 'silent'> {\n  try {\n    const supabase = getSupabaseAnonServer();\n    if (!supabase) return 'visible';\n    \n    const { data } = await supabase\n      .from('kv_settings')\n      .select('value')\n      .eq('key', 'error_notifications_mode')\n      .single();\n    \n    if (data?.value) {\n      const mode = JSON.parse(data.value);\n      return mode === 'silent' ? 'silent' : 'visible';\n    }\n    \n    return 'visible';\n  } catch {\n    return 'visible';\n  }\n}\n\nexport async function setErrorNotificationMode(mode: 'visible' | 'silent'): Promise<boolean> {\n  try {\n    const supabase = getSupabaseAnonServer();\n    if (!supabase) return false;\n    \n    const { error } = await supabase\n      .from('kv_settings')\n      .upsert({\n        key: 'error_notifications_mode',\n        value: JSON.stringify(mode),\n        updated_at: new Date().toISOString(),\n      }, { onConflict: 'key' });\n    \n    return !error;\n  } catch {\n    return false;\n  }\n}\n","path":null,"size_bytes":2883,"size_tokens":null},"src/app/api/admin/cj/shipping/calculate/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { calculateShippingToSA, calculateFinalPricingSAR, getAccessToken } from '@/lib/cj/v2';\nimport { fetchJson } from '@/lib/http';\nimport { logError } from '@/lib/error-logger';\n\nexport const dynamic = 'force-dynamic';\n\nconst USD_TO_SAR_RATE = 3.75;\nconst CJ_BASE = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n\n// Look up actual vid from variantSku using variant query API\nasync function lookupVariantVid(productId: string, variantSku: string): Promise<string | null> {\n  try {\n    const token = await getAccessToken();\n    const response = await fetchJson<any>(`${CJ_BASE}/product/variant/query?pid=${encodeURIComponent(productId)}`, {\n      headers: {\n        'Content-Type': 'application/json',\n        'CJ-Access-Token': token,\n      },\n      cache: 'no-store',\n      timeoutMs: 10000,\n    });\n    \n    if (response?.code !== 200 || !response?.data) {\n      console.log(`[Vid Lookup] Failed to get variants for product ${productId}`);\n      return null;\n    }\n    \n    const variants = Array.isArray(response.data) ? response.data : (response.data?.list || response.data?.variants || []);\n    \n    // Normalize the input SKU for comparison (trim + uppercase)\n    const normalizedInputSku = variantSku.trim().toUpperCase();\n    \n    // Find the variant matching our SKU (case-insensitive, trimmed)\n    for (const v of variants) {\n      const sku = String(v.variantSku || v.sku || '').trim().toUpperCase();\n      if (sku === normalizedInputSku) {\n        const vid = v.vid || v.variantId || null;\n        if (vid) {\n          console.log(`[Vid Lookup] Found vid=${vid} for SKU=${variantSku}`);\n          return String(vid);\n        }\n      }\n    }\n    \n    // CRITICAL: Do NOT fallback to first variant - this violates per-variant accuracy\n    // Return null to mark this variant as unavailable rather than pricing the wrong variant\n    console.warn(`[Vid Lookup] No exact SKU match found for ${variantSku} in product ${productId}. Returning null to preserve accuracy.`);\n    return null;\n  } catch (e: any) {\n    console.error(`[Vid Lookup] Error for ${productId}/${variantSku}:`, e?.message);\n    return null;\n  }\n}\n\n// Per-variant input for accurate pricing\ntype VariantInput = {\n  productId: string;\n  variantId: string; // CJ variant ID (vid)\n  variantPriceUSD: number; // EXACT price for THIS variant\n};\n\n// Per-variant shipping/pricing result\ntype VariantShippingResult = {\n  productId: string;\n  variantId: string;\n  shipping: {\n    available: boolean;\n    priceUSD: number;\n    priceSAR: number;\n    deliveryDays: string;\n    logisticName?: string;\n    error?: string;\n  };\n  // pricing is only included when shipping is available (CJPacket Ordinary found)\n  // null = shipping unavailable, do not use this variant for pricing\n  pricing: {\n    variantPriceUSD: number;\n    variantPriceSAR: number;\n    shippingPriceSAR: number;\n    totalCostSAR: number;\n    profitSAR: number;\n    sellPriceSAR: number;\n  } | null;\n};\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { variants, profitMarginPercent = 50 } = body as { \n      variants: VariantInput[]; \n      profitMarginPercent: number;\n    };\n    \n    if (!variants || !Array.isArray(variants) || variants.length === 0) {\n      return NextResponse.json(\n        { ok: false, error: 'variants array is required' },\n        { status: 400 }\n      );\n    }\n    \n    console.log(`[Shipping API] Starting per-variant shipping calculation for ${variants.length} variants with ${profitMarginPercent}% profit margin`);\n    \n    // Results keyed by variantId for per-variant accuracy\n    const results: Record<string, VariantShippingResult> = {};\n    let successCount = 0;\n    let failCount = 0;\n    \n    for (let i = 0; i < variants.length; i++) {\n      const variant = variants[i];\n      const { productId, variantId, variantPriceUSD } = variant;\n      \n      console.log(`[Shipping API] Processing ${i + 1}/${variants.length}: variant ${variantId} (product ${productId})`);\n      \n      // CRITICAL: Require both variantId AND valid price for accurate pricing\n      if (!variantId) {\n        console.log(`[Shipping API] Skipping: No variant ID`);\n        results[variantId || `unknown_${i}`] = {\n          productId,\n          variantId: variantId || '',\n          shipping: {\n            available: false,\n            priceUSD: 0,\n            priceSAR: 0,\n            deliveryDays: '',\n            error: 'No variant ID provided'\n          },\n          pricing: null\n        };\n        failCount++;\n        continue;\n      }\n      \n      if (!variantPriceUSD || variantPriceUSD <= 0) {\n        console.log(`[Shipping API] Skipping ${variantId}: Invalid variant price`);\n        results[variantId] = {\n          productId,\n          variantId,\n          shipping: {\n            available: false,\n            priceUSD: 0,\n            priceSAR: 0,\n            deliveryDays: '',\n            error: 'Invalid variant price'\n          },\n          pricing: null\n        };\n        failCount++;\n        continue;\n      }\n      \n      try {\n        // CRITICAL: The variantId we receive might be a SKU, not an actual vid\n        // First, try to look up the actual vid from the variant query API\n        let actualVid = variantId;\n        const normalizedVariantId = variantId.trim().toUpperCase();\n        \n        // Detect if variantId looks like a valid vid (long numeric or UUID format)\n        // Valid vid formats: \"1796078021431009280\" (19 digits) or \"1D72A20A-D113-4FAB-B4BA-6FE1A6A14A3A\" (UUID)\n        const isValidVidFormat = \n          /^\\d{10,}$/.test(normalizedVariantId) || \n          /^[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}$/i.test(normalizedVariantId);\n        \n        // If it doesn't look like a valid vid, attempt lookup\n        if (!isValidVidFormat && productId) {\n          console.log(`[Shipping API] variantId ${variantId} doesn't look like valid vid format, looking up actual vid...`);\n          const lookedUpVid = await lookupVariantVid(productId, variantId);\n          if (lookedUpVid) {\n            actualVid = lookedUpVid;\n            console.log(`[Shipping API] Using looked-up vid: ${actualVid}`);\n          } else {\n            // CRITICAL: Vid lookup failed - mark as unavailable to preserve accuracy\n            console.warn(`[Shipping API] Could not find vid for SKU ${variantId}, marking as unavailable`);\n            results[variantId] = {\n              productId,\n              variantId,\n              shipping: {\n                available: false,\n                priceUSD: 0,\n                priceSAR: 0,\n                deliveryDays: '',\n                error: 'Could not resolve variant ID - SKU not found in variant query'\n              },\n              pricing: null\n            };\n            failCount++;\n            continue;\n          }\n        } else if (isValidVidFormat) {\n          console.log(`[Shipping API] variantId ${variantId} looks like valid vid format, using directly`);\n        }\n        \n        const shippingResult = await calculateShippingToSA(actualVid, 1);\n        \n        if (shippingResult.available && shippingResult.shippingPriceUSD > 0) {\n          const pricing = calculateFinalPricingSAR(\n            variantPriceUSD, \n            shippingResult.shippingPriceUSD, \n            profitMarginPercent\n          );\n          \n          results[variantId] = {\n            productId,\n            variantId,\n            shipping: {\n              available: true,\n              priceUSD: shippingResult.shippingPriceUSD,\n              priceSAR: shippingResult.shippingPriceSAR,\n              deliveryDays: shippingResult.deliveryDays,\n              logisticName: shippingResult.logisticName,\n            },\n            pricing: {\n              variantPriceUSD,\n              variantPriceSAR: pricing.productPriceSAR,\n              shippingPriceSAR: pricing.shippingPriceSAR,\n              totalCostSAR: pricing.totalCostSAR,\n              profitSAR: pricing.profitSAR,\n              sellPriceSAR: pricing.sellPriceSAR,\n            }\n          };\n          successCount++;\n          console.log(`[Shipping API] Success for variant ${variantId}: $${shippingResult.shippingPriceUSD} shipping, ${pricing.sellPriceSAR.toFixed(2)} SAR sell price`);\n        } else {\n          results[variantId] = {\n            productId,\n            variantId,\n            shipping: {\n              available: false,\n              priceUSD: 0,\n              priceSAR: 0,\n              deliveryDays: '',\n              error: shippingResult.error || 'CJPacket Ordinary not available'\n            },\n            pricing: null\n          };\n          failCount++;\n          console.log(`[Shipping API] Unavailable for variant ${variantId}: ${shippingResult.error}`);\n        }\n        \n      } catch (error: any) {\n        console.error(`[Shipping API] Error for variant ${variantId}:`, error?.message);\n        results[variantId] = {\n          productId,\n          variantId,\n          shipping: {\n            available: false,\n            priceUSD: 0,\n            priceSAR: 0,\n            deliveryDays: '',\n            error: error?.message || 'Failed to calculate shipping'\n          },\n          pricing: null\n        };\n        failCount++;\n      }\n      \n      // Rate limiting - wait 1.2 seconds between CJ API calls\n      if (i < variants.length - 1) {\n        await new Promise(resolve => setTimeout(resolve, 1200));\n      }\n    }\n    \n    console.log(`[Shipping API] Completed: ${successCount} success, ${failCount} failed out of ${variants.length} variants`);\n    \n    return NextResponse.json({ \n      ok: true, \n      results,\n      stats: {\n        total: variants.length,\n        success: successCount,\n        failed: failCount\n      }\n    });\n    \n  } catch (error: any) {\n    console.error('[Shipping API] Fatal error:', error?.message);\n    \n    await logError({\n      error_type: 'shipping',\n      message: error?.message || 'Failed to calculate shipping',\n      details: {\n        stack: error?.stack,\n      },\n      page: '/api/admin/cj/shipping/calculate',\n    });\n    \n    return NextResponse.json(\n      { ok: false, error: error?.message || 'Failed to calculate shipping' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":10305,"size_tokens":null},"src/components/error-provider.tsx":{"content":"\"use client\";\n\nimport React, { createContext, useCallback, useContext, useEffect, useState } from \"react\";\nimport { useToast } from \"@/components/ui/toast-provider\";\n\ntype ErrorMode = 'visible' | 'silent';\n\ntype ErrorContextType = {\n  mode: ErrorMode;\n  showError: (message: string, errorType?: string, details?: any) => void;\n  showWarning: (message: string) => void;\n  showSuccess: (message: string) => void;\n};\n\nconst ErrorContext = createContext<ErrorContextType | null>(null);\n\nexport function ErrorProvider({ children }: { children: React.ReactNode }) {\n  const { toast } = useToast();\n  const [mode, setMode] = useState<ErrorMode>('visible');\n  \n  useEffect(() => {\n    const fetchMode = async () => {\n      try {\n        const res = await fetch('/api/admin/errors?limit=0');\n        const data = await res.json();\n        if (data.ok && data.notificationMode) {\n          setMode(data.notificationMode);\n        }\n      } catch {\n      }\n    };\n    \n    fetchMode();\n  }, []);\n  \n  const showError = useCallback((message: string, errorType: string = 'general', details?: any) => {\n    if (mode === 'visible') {\n      toast({\n        title: \"Error\",\n        description: message,\n        variant: \"error\",\n        duration: 8000,\n      });\n    }\n    \n    fetch('/api/admin/errors/log', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        error_type: errorType,\n        message,\n        details,\n        page: typeof window !== 'undefined' ? window.location.pathname : undefined,\n      }),\n    }).catch(() => {});\n  }, [mode, toast]);\n  \n  const showWarning = useCallback((message: string) => {\n    if (mode === 'visible') {\n      toast({\n        title: \"Warning\",\n        description: message,\n        variant: \"warning\",\n        duration: 6000,\n      });\n    }\n  }, [mode, toast]);\n  \n  const showSuccess = useCallback((message: string) => {\n    toast({\n      title: \"Success\",\n      description: message,\n      variant: \"success\",\n      duration: 3000,\n    });\n  }, [toast]);\n  \n  return (\n    <ErrorContext.Provider value={{ mode, showError, showWarning, showSuccess }}>\n      {children}\n    </ErrorContext.Provider>\n  );\n}\n\nexport function useError() {\n  const ctx = useContext(ErrorContext);\n  if (!ctx) throw new Error(\"useError must be used within ErrorProvider\");\n  return ctx;\n}\n","path":null,"size_bytes":2359,"size_tokens":null},"src/app/api/admin/errors/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getRecentErrors, getErrorNotificationMode, setErrorNotificationMode } from '@/lib/error-logger';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: Request) {\n  const adminCheck = await ensureAdmin();\n  if (!adminCheck.ok) {\n    return NextResponse.json({ ok: false, error: 'Not authenticated' }, { status: 401 });\n  }\n  \n  try {\n    const url = new URL(req.url);\n    const limit = parseInt(url.searchParams.get('limit') || '50', 10);\n    \n    const [errors, mode] = await Promise.all([\n      getRecentErrors(limit),\n      getErrorNotificationMode(),\n    ]);\n    \n    return NextResponse.json({ \n      ok: true, \n      errors,\n      notificationMode: mode,\n    });\n  } catch (e: any) {\n    console.error('[Error API] Exception:', e);\n    return NextResponse.json({ ok: false, error: e?.message || 'Unknown error' }, { status: 500 });\n  }\n}\n\nexport async function POST(req: Request) {\n  const adminCheck = await ensureAdmin();\n  if (!adminCheck.ok) {\n    return NextResponse.json({ ok: false, error: 'Not authenticated' }, { status: 401 });\n  }\n  \n  try {\n    const body = await req.json();\n    const { notificationMode } = body;\n    \n    if (notificationMode && (notificationMode === 'visible' || notificationMode === 'silent')) {\n      const success = await setErrorNotificationMode(notificationMode);\n      return NextResponse.json({ ok: success });\n    }\n    \n    return NextResponse.json({ ok: false, error: 'Invalid mode' }, { status: 400 });\n  } catch (e: any) {\n    console.error('[Error API] Exception:', e);\n    return NextResponse.json({ ok: false, error: e?.message || 'Unknown error' }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":1752,"size_tokens":null},"src/app/api/admin/errors/log/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { logError, ErrorType } from '@/lib/error-logger';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    \n    const { error_type, error_code, message, details, page } = body;\n    \n    if (!error_type || !message) {\n      return NextResponse.json({ ok: false, error: 'Missing required fields' }, { status: 400 });\n    }\n    \n    const result = await logError({\n      error_type: error_type as ErrorType,\n      error_code,\n      message,\n      details,\n      page,\n    });\n    \n    return NextResponse.json(result);\n  } catch (e: any) {\n    console.error('[Error Log API] Exception:', e);\n    return NextResponse.json({ ok: false, error: e?.message || 'Unknown error' }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":822,"size_tokens":null},"src/app/api/admin/cj/clear-token/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { clearTokenCache } from '@/lib/cj/v2';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function POST() {\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json({ ok: false, error: guard.reason }, { status: 401 });\n    }\n    \n    clearTokenCache();\n    \n    return NextResponse.json({ \n      ok: true, \n      message: 'Token cache cleared. Next CJ API call will authenticate with new credentials.' \n    });\n  } catch (e: any) {\n    return NextResponse.json({ \n      ok: false, \n      error: e?.message || 'Failed to clear token cache' \n    }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":723,"size_tokens":null},"src/app/admin/errors/page.tsx":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { AlertCircle, CheckCircle, XCircle, RefreshCw, Settings } from \"lucide-react\";\n\ntype ErrorLog = {\n  id: number;\n  error_type: string;\n  error_code?: string;\n  message: string;\n  details?: any;\n  page?: string;\n  user_email?: string;\n  created_at: string;\n};\n\ntype ServiceHealth = {\n  service: string;\n  status: 'ok' | 'error' | 'unknown';\n  message: string;\n  latencyMs?: number;\n};\n\nexport default function ErrorDashboardPage() {\n  const [errors, setErrors] = useState<ErrorLog[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [notificationMode, setNotificationMode] = useState<'visible' | 'silent'>('visible');\n  const [savingMode, setSavingMode] = useState(false);\n  const [health, setHealth] = useState<{ status: string; services: ServiceHealth[] } | null>(null);\n  const [healthLoading, setHealthLoading] = useState(true);\n\n  const fetchErrors = async () => {\n    setLoading(true);\n    try {\n      const res = await fetch('/api/admin/errors?limit=100');\n      const data = await res.json();\n      if (data.ok) {\n        setErrors(data.errors || []);\n        setNotificationMode(data.notificationMode || 'visible');\n      }\n    } catch (e) {\n      console.error('Failed to fetch errors:', e);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchHealth = async () => {\n    setHealthLoading(true);\n    try {\n      const res = await fetch('/api/admin/health');\n      const data = await res.json();\n      if (data.ok) {\n        setHealth({\n          status: data.status,\n          services: data.services || [],\n        });\n      }\n    } catch (e) {\n      console.error('Failed to fetch health:', e);\n    } finally {\n      setHealthLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchErrors();\n    fetchHealth();\n  }, []);\n\n  const toggleMode = async () => {\n    const newMode = notificationMode === 'visible' ? 'silent' : 'visible';\n    setSavingMode(true);\n    try {\n      const res = await fetch('/api/admin/errors', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ notificationMode: newMode }),\n      });\n      const data = await res.json();\n      if (data.ok) {\n        setNotificationMode(newMode);\n      }\n    } catch (e) {\n      console.error('Failed to update mode:', e);\n    } finally {\n      setSavingMode(false);\n    }\n  };\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr);\n    return date.toLocaleString('en-US', {\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  const getTypeColor = (type: string) => {\n    switch (type) {\n      case 'cj_api': return 'bg-purple-100 text-purple-800';\n      case 'search': return 'bg-blue-100 text-blue-800';\n      case 'shipping': return 'bg-cyan-100 text-cyan-800';\n      case 'pricing': return 'bg-amber-100 text-amber-800';\n      case 'database': return 'bg-red-100 text-red-800';\n      case 'auth': return 'bg-orange-100 text-orange-800';\n      case 'payment': return 'bg-green-100 text-green-800';\n      default: return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'ok': return <CheckCircle className=\"w-5 h-5 text-green-500\" />;\n      case 'error': return <XCircle className=\"w-5 h-5 text-red-500\" />;\n      default: return <AlertCircle className=\"w-5 h-5 text-yellow-500\" />;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 p-6\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <h1 className=\"text-2xl font-bold text-gray-900\">Error Dashboard</h1>\n          <div className=\"flex items-center gap-4\">\n            <button\n              onClick={fetchErrors}\n              disabled={loading}\n              className=\"flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50\"\n            >\n              <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />\n              Refresh\n            </button>\n          </div>\n        </div>\n\n        {/* Health Status */}\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <h2 className=\"text-lg font-semibold text-gray-900\">System Health</h2>\n            <button\n              onClick={fetchHealth}\n              disabled={healthLoading}\n              className=\"text-sm text-blue-600 hover:text-blue-800\"\n            >\n              Check Now\n            </button>\n          </div>\n          \n          {healthLoading ? (\n            <div className=\"text-gray-500\">Checking services...</div>\n          ) : health ? (\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n              {health.services.map((service, i) => (\n                <div\n                  key={i}\n                  className={`p-4 rounded-lg border ${\n                    service.status === 'ok' ? 'border-green-200 bg-green-50' :\n                    service.status === 'error' ? 'border-red-200 bg-red-50' :\n                    'border-yellow-200 bg-yellow-50'\n                  }`}\n                >\n                  <div className=\"flex items-center gap-2 mb-1\">\n                    {getStatusIcon(service.status)}\n                    <span className=\"font-medium\">{service.service}</span>\n                  </div>\n                  <div className=\"text-sm text-gray-600\">{service.message}</div>\n                  {service.latencyMs !== undefined && (\n                    <div className=\"text-xs text-gray-400 mt-1\">{service.latencyMs}ms</div>\n                  )}\n                </div>\n              ))}\n            </div>\n          ) : (\n            <div className=\"text-red-500\">Failed to check health</div>\n          )}\n        </div>\n\n        {/* Settings */}\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <h2 className=\"text-lg font-semibold text-gray-900 flex items-center gap-2\">\n                <Settings className=\"w-5 h-5\" />\n                Notification Settings\n              </h2>\n              <p className=\"text-sm text-gray-600 mt-1\">\n                {notificationMode === 'visible' \n                  ? 'Errors are shown immediately on screen (recommended)'\n                  : 'Errors are logged silently without notifications'}\n              </p>\n            </div>\n            <button\n              onClick={toggleMode}\n              disabled={savingMode}\n              className={`px-4 py-2 rounded-lg font-medium transition-colors ${\n                notificationMode === 'visible'\n                  ? 'bg-green-100 text-green-800 hover:bg-green-200'\n                  : 'bg-gray-100 text-gray-800 hover:bg-gray-200'\n              }`}\n            >\n              {savingMode ? 'Saving...' : notificationMode === 'visible' ? 'Visible Mode' : 'Silent Mode'}\n            </button>\n          </div>\n        </div>\n\n        {/* Error Logs */}\n        <div className=\"bg-white rounded-lg shadow-sm border border-gray-200\">\n          <div className=\"p-6 border-b border-gray-200\">\n            <h2 className=\"text-lg font-semibold text-gray-900\">Recent Errors</h2>\n            <p className=\"text-sm text-gray-600\">Last 100 errors logged in the system</p>\n          </div>\n          \n          {loading ? (\n            <div className=\"p-6 text-center text-gray-500\">Loading errors...</div>\n          ) : errors.length === 0 ? (\n            <div className=\"p-6 text-center\">\n              <CheckCircle className=\"w-12 h-12 text-green-500 mx-auto mb-2\" />\n              <div className=\"text-gray-600\">No errors logged yet</div>\n              <div className=\"text-sm text-gray-400\">Everything is running smoothly</div>\n            </div>\n          ) : (\n            <div className=\"divide-y divide-gray-100\">\n              {errors.map((error) => (\n                <div key={error.id} className=\"p-4 hover:bg-gray-50\">\n                  <div className=\"flex items-start justify-between gap-4\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span className={`px-2 py-0.5 rounded text-xs font-medium ${getTypeColor(error.error_type)}`}>\n                          {error.error_type}\n                        </span>\n                        {error.error_code && (\n                          <span className=\"text-xs text-gray-500\">#{error.error_code}</span>\n                        )}\n                        <span className=\"text-xs text-gray-400\">{formatDate(error.created_at)}</span>\n                      </div>\n                      <div className=\"text-sm text-gray-900\">{error.message}</div>\n                      {error.page && (\n                        <div className=\"text-xs text-gray-500 mt-1\">Page: {error.page}</div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9255,"size_tokens":null},"src/app/api/admin/cj/products/search-and-price/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getAccessToken, freightCalculate, fetchProductDetailsBatch, getProductRatings, findCJPacketOrdinary, getInventoryByPid, queryVariantInventory, waitForCjRateLimit } from '@/lib/cj/v2';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { fetchJson } from '@/lib/http';\nimport { loggerForRequest } from '@/lib/log';\nimport { usdToSar, computeRetailFromLanded } from '@/lib/pricing';\n\nexport const dynamic = 'force-dynamic';\nexport const revalidate = 0;\nexport const runtime = 'nodejs';\n\ntype ShippingOption = {\n  name: string;\n  code: string;\n  priceUSD: number;\n  deliveryDays: string;\n};\n\ntype PricedVariant = {\n  variantId: string;\n  variantSku: string;\n  variantPriceUSD: number;\n  shippingAvailable: boolean;\n  shippingPriceUSD: number;\n  shippingPriceSAR: number;\n  deliveryDays: string;\n  logisticName?: string;\n  sellPriceSAR: number;\n  totalCostSAR: number;\n  profitSAR: number;\n  error?: string;\n  stock?: number;\n  cjStock?: number;          // CJ warehouse stock (verified)\n  factoryStock?: number;     // Factory/supplier stock (unverified)\n  variantName?: string;\n  variantImage?: string;\n  size?: string;\n  color?: string;\n  allShippingOptions?: ShippingOption[];\n};\n\ntype WarehouseStock = {\n  areaId: number;\n  areaName: string;\n  countryCode: string;\n  totalInventory: number;\n  cjInventory: number;\n  factoryInventory: number;\n};\n\ntype ProductInventory = {\n  totalCJ: number;\n  totalFactory: number;\n  totalAvailable: number;\n  warehouses: WarehouseStock[];\n};\n\ntype InventoryVariant = {\n  variantId: string;\n  sku: string;\n  shortName: string;\n  priceUSD: number;\n  cjStock: number;\n  factoryStock: number;\n  totalStock: number;\n};\n\ntype PricedProduct = {\n  pid: string;\n  cjSku: string;\n  name: string;\n  images: string[];\n  minPriceSAR: number;\n  maxPriceSAR: number;\n  avgPriceSAR: number;\n  stock: number;\n  listedNum: number;\n  // Inventory breakdown from CJ's dedicated inventory API\n  totalVerifiedInventory?: number;    // CJ warehouse stock (verified)\n  totalUnVerifiedInventory?: number;  // Factory/supplier stock (unverified)\n  // Full warehouse inventory object for detailed display\n  inventory?: ProductInventory;\n  // Inventory status: 'ok' = successfully fetched, 'error' = failed to fetch, 'partial' = some data missing\n  inventoryStatus?: 'ok' | 'error' | 'partial';\n  inventoryErrorMessage?: string;\n  variants: PricedVariant[];\n  inventoryVariants?: InventoryVariant[];\n  successfulVariants: number;\n  totalVariants: number;\n  description?: string;\n  overview?: string;\n  productInfo?: string;\n  sizeInfo?: string;\n  productNote?: string;\n  packingList?: string;\n  rating?: number;\n  reviewCount?: number;\n  categoryName?: string;\n  productWeight?: number;\n  packLength?: number;\n  packWidth?: number;\n  packHeight?: number;\n  material?: string;\n  productType?: string;\n  sizeChartImages?: string[];\n  processingTimeHours?: number;\n  deliveryTimeHours?: number;\n  estimatedProcessingDays?: string;\n  estimatedDeliveryDays?: string;\n  originCountry?: string;\n  hsCode?: string;\n  videoUrl?: string;\n  availableSizes?: string[];\n  availableColors?: string[];\n  availableModels?: string[];\n};\n\nasync function fetchCjProductPage(\n  token: string, \n  base: string, \n  categoryId: string | null,\n  pageNum: number\n): Promise<{ list: any[]; total: number }> {\n  // Use /product/list for category filtering (stable and reliable)\n  const params = new URLSearchParams();\n  params.set('pageNum', String(pageNum));\n  \n  if (categoryId && categoryId !== 'all' && !categoryId.startsWith('first-') && !categoryId.startsWith('second-')) {\n    params.set('categoryId', categoryId);\n  }\n  \n  const url = `${base}/product/list?${params}`;\n  console.log(`[Search&Price] Fetching product/list: ${url}`);\n  \n  try {\n    const res = await fetchJson<any>(url, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 30000,\n    });\n    \n    const list = res?.data?.list || [];\n    const total = res?.data?.total || 0;\n    console.log(`[Search&Price] Page ${pageNum} returned ${list.length} items (total: ${total})`);\n    \n    return { list, total };\n  } catch (e: any) {\n    console.error(`[Search&Price] Fetch error:`, e?.message);\n    return { list: [], total: 0 };\n  }\n}\n\n// Fetch inventory data from listV2 by PID keyword search\nasync function enrichWithListV2Inventory(\n  token: string,\n  base: string, \n  pid: string\n): Promise<{ warehouseInventoryNum?: number; listedNum?: number; totalVerifiedInventory?: number; totalUnVerifiedInventory?: number } | null> {\n  try {\n    const url = `${base}/product/listV2?keyWord=${encodeURIComponent(pid)}&page=1&size=5&features=enable_description`;\n    const res = await fetchJson<any>(url, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 10000,\n    });\n    \n    // Extract product list from response\n    const data = res?.data;\n    let productList: any[] = [];\n    if (Array.isArray(data)) {\n      productList = data;\n    } else if (data?.list) {\n      productList = data.list;\n    } else if (data?.products) {\n      productList = data.products;\n    }\n    \n    // Find matching product by PID\n    const match = productList.find((p: any) => p.id === pid || p.pid === pid);\n    if (match) {\n      return {\n        warehouseInventoryNum: Number(match.warehouseInventoryNum || 0),\n        listedNum: Number(match.listedNum || 0),\n        totalVerifiedInventory: Number(match.totalVerifiedInventory || 0),\n        totalUnVerifiedInventory: Number(match.totalUnVerifiedInventory || 0),\n      };\n    }\n    return null;\n  } catch (e: any) {\n    console.log(`[Search&Price] listV2 enrichment failed for ${pid}:`, e?.message);\n    return null;\n  }\n}\n\nasync function getVariantsForProduct(token: string, base: string, pid: string): Promise<any[]> {\n  try {\n    const res = await fetchJson<any>(`${base}/product/variant/query?pid=${encodeURIComponent(pid)}`, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 15000,\n    });\n    const data = res?.data;\n    const variants = Array.isArray(data) ? data : (data?.list || data?.variants || []);\n    \n    // Log first variant to see what fields are available\n    if (variants.length > 0) {\n      const sample = variants[0];\n      const keys = Object.keys(sample);\n      const imageKeys = keys.filter(k => /image|img|photo|pic/i.test(k));\n      console.log(`[Variants] Product ${pid}: ${variants.length} variants`);\n      console.log(`[Variants] ALL fields: [${keys.join(', ')}]`);\n      console.log(`[Variants] Image fields: [${imageKeys.join(', ')}]`);\n      \n      // Log actual values for image fields\n      for (const k of imageKeys) {\n        const val = sample[k];\n        if (val) {\n          console.log(`[Variants] ${k} = ${typeof val === 'string' ? val.slice(0, 100) : JSON.stringify(val).slice(0, 100)}`);\n        }\n      }\n      \n      // Log shipping-critical fields: vid is needed for \"According to Shipping Method\" freight calculation\n      console.log(`[Variants] vid = ${sample.vid || 'NOT_FOUND'}`);\n      console.log(`[Variants] variantSku = ${sample.variantSku || 'NOT_FOUND'}`);\n      if (sample.variantKey) console.log(`[Variants] variantKey = ${sample.variantKey}`);\n      if (sample.variantNameEn) console.log(`[Variants] variantNameEn = ${sample.variantNameEn}`);\n    }\n    \n    return variants;\n  } catch (e: any) {\n    console.log(`[Variants] Error for ${pid}:`, e?.message);\n    return [];\n  }\n}\n\nfunction calculateSellPriceWithMargin(landedCostSAR: number, profitMarginPercent: number): number {\n  const margin = profitMarginPercent / 100;\n  return computeRetailFromLanded(landedCostSAR, { margin });\n}\n\nfunction extractAllImages(item: any): string[] {\n  if (!item) return [];\n  \n  const imageList: string[] = [];\n  const seen = new Set<string>();\n  \n  const pushUrl = (val: any, source?: string) => {\n    if (typeof val === 'string' && val.trim()) {\n      const url = val.trim();\n      // Must look like a valid image URL\n      if (url.startsWith('http') && !seen.has(url)) {\n        seen.add(url);\n        imageList.push(url);\n      }\n    }\n  };\n  \n  // Main image fields\n  const mainFields = ['productImage', 'bigImage', 'image', 'mainImage', 'mainImageUrl'];\n  for (const field of mainFields) {\n    pushUrl(item[field], `main.${field}`);\n  }\n  \n  // Array fields containing images\n  const arrFields = ['imageList', 'productImageList', 'detailImageList', 'pictureList', 'productImages'];\n  for (const key of arrFields) {\n    const arr = item[key];\n    if (Array.isArray(arr)) {\n      for (const it of arr) {\n        if (typeof it === 'string') pushUrl(it, `arr.${key}`);\n        else if (it && typeof it === 'object') {\n          pushUrl(it.imageUrl || it.url || it.imgUrl || it.big || it.origin || it.src, `arr.${key}.obj`);\n        }\n      }\n    }\n  }\n  \n  // Extract color images from productPropertyList (CJ color options)\n  const propertyList = item.productPropertyList || item.propertyList || item.productOptions || [];\n  if (Array.isArray(propertyList)) {\n    for (const prop of propertyList) {\n      // Each property may have an image (e.g., color swatch with product image)\n      pushUrl(prop?.image || prop?.imageUrl || prop?.propImage || prop?.optionImage, 'prop');\n      \n      // Property values may also have images\n      const propValues = prop?.propertyValueList || prop?.values || prop?.options || [];\n      if (Array.isArray(propValues)) {\n        for (const pv of propValues) {\n          pushUrl(pv?.image || pv?.imageUrl || pv?.propImage || pv?.bigImage, 'propValue');\n        }\n      }\n    }\n  }\n  \n  // Variants may have images too - comprehensive extraction\n  const variantList = item.variantList || item.skuList || item.variants || [];\n  if (Array.isArray(variantList)) {\n    for (const v of variantList) {\n      // Standard variant image fields\n      pushUrl(v?.whiteImage, 'variant.whiteImage');\n      pushUrl(v?.image, 'variant.image');\n      pushUrl(v?.imageUrl, 'variant.imageUrl');\n      pushUrl(v?.imgUrl, 'variant.imgUrl');\n      pushUrl(v?.variantImage, 'variant.variantImage');\n      pushUrl(v?.attributeImage, 'variant.attributeImage');\n      pushUrl(v?.skuImage, 'variant.skuImage');\n      pushUrl(v?.bigImage, 'variant.bigImage');\n      pushUrl(v?.originImage, 'variant.originImage');\n      pushUrl(v?.mainImage, 'variant.mainImage');\n      \n      // Variant image list/array\n      const variantImages = v?.variantImageList || v?.skuImageList || v?.imageList || [];\n      if (Array.isArray(variantImages)) {\n        for (const vi of variantImages) {\n          if (typeof vi === 'string') pushUrl(vi, 'variantArr');\n          else if (vi && typeof vi === 'object') {\n            pushUrl(vi.image || vi.big || vi.small || vi.url || vi.imageUrl, 'variantArr.obj');\n          }\n        }\n      }\n      \n      // Variant properties with images (color-specific images)\n      const variantProps = v?.variantPropertyList || v?.propertyList || [];\n      if (Array.isArray(variantProps)) {\n        for (const vp of variantProps) {\n          pushUrl(vp?.image || vp?.propImage || vp?.imageUrl, 'variantProp');\n        }\n      }\n    }\n  }\n  \n  // Deep scan: look for any URL-like strings in the entire object\n  // This catches any image fields we might have missed\n  const deepScan = (obj: any, depth: number = 0) => {\n    if (depth > 3 || !obj || typeof obj !== 'object') return;\n    \n    for (const key of Object.keys(obj)) {\n      const val = obj[key];\n      // Look for keys that contain 'image' or 'img' or 'photo' or 'pic'\n      if (/image|img|photo|pic/i.test(key)) {\n        if (typeof val === 'string') {\n          pushUrl(val, `deep.${key}`);\n        } else if (Array.isArray(val)) {\n          for (const v of val) {\n            if (typeof v === 'string') pushUrl(v, `deep.${key}[]`);\n            else if (v && typeof v === 'object') {\n              pushUrl(v.url || v.src || v.imageUrl || v.image, `deep.${key}[].obj`);\n            }\n          }\n        }\n      } else if (Array.isArray(val)) {\n        for (const v of val) {\n          deepScan(v, depth + 1);\n        }\n      } else if (typeof val === 'object') {\n        deepScan(val, depth + 1);\n      }\n    }\n  };\n  \n  deepScan(item);\n  \n  // Filter out non-product images (badges, icons, etc.)\n  const deny = /(sprite|icon|favicon|logo|placeholder|blank|loading|alipay|wechat|whatsapp|kefu|service|avatar|thumb|thumbnail|small|tiny|mini|sizechart|size\\s*chart|chart|table|guide|tips|hot|badge|flag|promo|banner|sale|discount|qr)/i;\n  \n  const finalImages = imageList.filter(url => !deny.test(url)).slice(0, 50);\n  console.log(`[ExtractImages] Found ${imageList.length} raw images, ${finalImages.length} after filtering`);\n  \n  return finalImages;\n}\n\nexport async function GET(req: Request) {\n  const log = loggerForRequest(req);\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      const r = NextResponse.json(\n        { ok: false, error: guard.reason }, \n        { status: 401, headers: { 'Cache-Control': 'no-store' } }\n      );\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n\n    const { searchParams } = new URL(req.url);\n    const categoryIdsParam = searchParams.get('categoryIds') || 'all';\n    const categoryIds = categoryIdsParam.split(',').filter(Boolean);\n    const quantity = Math.max(1, Math.min(1000, Number(searchParams.get('quantity') || 50)));\n    const minPrice = Number(searchParams.get('minPrice') || 0);\n    const maxPrice = Number(searchParams.get('maxPrice') || 1000);\n    const minStock = Number(searchParams.get('minStock') || 0);\n    const profitMargin = Math.max(1, Number(searchParams.get('profitMargin') || 8));\n    const popularity = searchParams.get('popularity') || 'any';\n    const minRating = searchParams.get('minRating') || 'any';\n    const freeShippingOnly = searchParams.get('freeShippingOnly') === '1';\n    const shippingMethod = searchParams.get('shippingMethod') || 'any';\n    const sizesParam = searchParams.get('sizes') || '';\n    \n    // Rating estimation function (same algorithm as preview)\n    function calculateEstimatedRating(listedNum: number): number {\n      if (listedNum >= 2000) return 4.8;\n      if (listedNum >= 1000) return 4.7;\n      if (listedNum >= 500) return 4.5;\n      if (listedNum >= 200) return 4.3;\n      if (listedNum >= 100) return 4.2;\n      if (listedNum >= 50) return 4.0;\n      if (listedNum >= 20) return 3.9;\n      return 3.8;\n    }\n    const requestedSizes = sizesParam ? sizesParam.split(',').map(s => s.trim().toUpperCase()).filter(Boolean) : [];\n\n    console.log(`[Search&Price] ========================================`);\n    console.log(`[Search&Price] Starting search with params:`);\n    console.log(`[Search&Price]   categories: ${categoryIds.join(',')}`);\n    console.log(`[Search&Price]   quantity: ${quantity}`);\n    console.log(`[Search&Price]   price range: $${minPrice} - $${maxPrice}`);\n    console.log(`[Search&Price]   minStock: ${minStock}`);\n    console.log(`[Search&Price]   popularity: ${popularity}`);\n    console.log(`[Search&Price]   minRating: ${minRating}`);\n    console.log(`[Search&Price]   profitMargin: ${profitMargin}%`);\n    console.log(`[Search&Price]   shippingMethod: ${shippingMethod}`);\n    console.log(`[Search&Price]   sizes filter: ${requestedSizes.length > 0 ? requestedSizes.join(',') : 'none'}`);\n    console.log(`[Search&Price] ========================================`);\n\n    const token = await getAccessToken();\n    if (!token) {\n      console.error('[Search&Price] Failed to get access token');\n      return NextResponse.json(\n        { ok: false, error: 'Failed to authenticate with CJ API' },\n        { status: 500, headers: { 'Cache-Control': 'no-store' } }\n      );\n    }\n    \n    const base = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n    \n    const candidateProducts: any[] = [];\n    const seenPids = new Set<string>();\n    const startTime = Date.now();\n    const maxDurationMs = 55000; // 55 sec to stay under production function timeout\n    \n    let totalFiltered = { price: 0, stock: 0, popularity: 0, rating: 0 };\n    \n    for (const catId of categoryIds) {\n      if (candidateProducts.length >= quantity * 2) break;\n      if (Date.now() - startTime > maxDurationMs) {\n        console.log(`[Search&Price] Timeout reached`);\n        break;\n      }\n      \n      console.log(`[Search&Price] Searching category: ${catId}`);\n      \n      const maxPages = 50;\n      \n      for (let page = 1; page <= maxPages; page++) {\n        if (Date.now() - startTime > maxDurationMs) break;\n        if (candidateProducts.length >= quantity * 2) break;\n        \n        const pageResult = await fetchCjProductPage(token, base, catId, page);\n        \n        if (pageResult.list.length === 0) {\n          console.log(`[Search&Price] No more products at page ${page}`);\n          break;\n        }\n        \n        for (const item of pageResult.list) {\n          const pid = String(item.pid || item.productId || '');\n          if (!pid || seenPids.has(pid)) continue;\n          seenPids.add(pid);\n          \n          const sellPrice = Number(item.sellPrice || item.price || 0);\n          if (sellPrice < minPrice || sellPrice > maxPrice) {\n            totalFiltered.price++;\n            continue;\n          }\n          \n          // NOTE: /product/list doesn't return stock/listedNum data\n          // We'll fetch inventory from listV2 during processing phase\n          // Skip early filtering on stock/popularity here - do it after enrichment\n          \n          candidateProducts.push(item);\n        }\n      }\n    }\n    \n    console.log(`[Search&Price] ----------------------------------------`);\n    console.log(`[Search&Price] Search complete:`);\n    console.log(`[Search&Price]   Total candidates: ${candidateProducts.length}`);\n    console.log(`[Search&Price]   Filtered by price: ${totalFiltered.price}`);\n    console.log(`[Search&Price]   Filtered by stock: ${totalFiltered.stock}`);\n    console.log(`[Search&Price]   Filtered by popularity: ${totalFiltered.popularity}`);\n    console.log(`[Search&Price]   Filtered by rating: ${totalFiltered.rating}`);\n    console.log(`[Search&Price] ----------------------------------------`);\n    \n    if (candidateProducts.length === 0) {\n      console.log(`[Search&Price] No candidates found! Returning empty result.`);\n      const r = NextResponse.json({\n        ok: true,\n        products: [],\n        count: 0,\n        duration: Date.now() - startTime,\n        debug: {\n          categoriesSearched: categoryIds,\n          totalSeen: seenPids.size,\n          filtered: totalFiltered,\n        }\n      }, { headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    \n    // RATE LIMIT: CJ API allows 1 req/sec and 1000/day\n    // Limit to 15 products max per search to stay under production timeout\n    const productsToPrice = candidateProducts.slice(0, Math.min(quantity, 15));\n    console.log(`[Search&Price] Pricing ${productsToPrice.length} products...`);\n    \n    // Fetch full product details to get all images\n    const pidsToHydrate = productsToPrice.map(p => String(p.pid || p.productId || '')).filter(Boolean);\n    console.log(`[Search&Price] Hydrating ${pidsToHydrate.length} products with full details...`);\n    \n    // Fetch product details and ratings in parallel\n    const [productDetailsMap, productRatingsMap] = await Promise.all([\n      fetchProductDetailsBatch(pidsToHydrate, 5),\n      getProductRatings(pidsToHydrate)\n    ]);\n    \n    console.log(`[Search&Price] Successfully hydrated ${productDetailsMap.size} products`);\n    console.log(`[Search&Price] Successfully fetched ratings for ${productRatingsMap.size} products`);\n    \n    const pricedProducts: PricedProduct[] = [];\n    let skippedNoVariants = 0;\n    let skippedNoShipping = 0;\n    const shippingErrors: Record<string, number> = {}; // Track error reasons\n    let productIndex = 0;\n    let consecutiveRateLimitErrors = 0; // Track consecutive rate limit errors to detect real quota issues\n    \n    for (const item of productsToPrice) {\n      // Add delay between products to respect CJ API rate limit (1 req/sec)\n      if (productIndex > 0) {\n        await new Promise(resolve => setTimeout(resolve, 1000)); // 1 sec between products\n      }\n      productIndex++;\n      const pid = String(item.pid || item.productId || '');\n      const cjSku = String(item.productSku || item.sku || `CJ-${pid}`);\n      const name = String(item.productNameEn || item.name || item.productName || '');\n      \n      // Get full product details for all images and additional info\n      const fullDetails = productDetailsMap.get(pid);\n      \n      // CRITICAL: Fetch REAL inventory data from CJ's dedicated inventory API\n      // This is the ONLY reliable way to get per-warehouse stock breakdown\n      // GET /product/stock/getInventoryByPid returns: inventories[].{areaId, areaEn, cjInventoryNum, factoryInventoryNum}\n      let realInventory: { \n        totalCJ: number; \n        totalFactory: number; \n        totalAvailable: number; \n        warehouses: Array<{ areaId: number; areaName: string; countryCode: string; totalInventory: number; cjInventory: number; factoryInventory: number }>;\n      } | null = null;\n      \n      // Map to store per-variant inventory with MULTIPLE KEYS for reliable matching\n      // Store same stock data under: normalized SKU, vid, variantId, variantKey\n      const variantStockMap = new Map<string, { cjStock: number; factoryStock: number; totalStock: number }>();\n      \n      // Normalize key for matching: lowercase, trim, remove special chars\n      const normalizeKey = (s: string | undefined | null): string => {\n        if (!s) return '';\n        return String(s).toLowerCase().trim().replace(/[\\s\\-_\\.]/g, '');\n      };\n      \n      // Function to look up variant stock by multiple possible keys\n      // Uses the SAME normalization as storage\n      const getVariantStock = (identifiers: {\n        vid?: string;\n        variantId?: string;\n        sku?: string;\n        variantKey?: string;\n        variantName?: string;\n      }): { cjStock: number; factoryStock: number; totalStock: number } | undefined => {\n        // Try ALL possible keys in priority order\n        const keysToTry = [\n          normalizeKey(identifiers.sku),         // Try SKU first (most common match)\n          normalizeKey(identifiers.vid),          // Try vid (variant ID)\n          normalizeKey(identifiers.variantId),    // Try variantId\n          normalizeKey(identifiers.variantKey),   // Try variantKey (e.g., \"White-L\")\n          normalizeKey(identifiers.variantName),  // Try variant name\n        ].filter(k => k.length > 0);\n        \n        for (const key of keysToTry) {\n          const stock = variantStockMap.get(key);\n          if (stock) return stock;\n        }\n        \n        // Fallback: scan all stored entries for partial match\n        if (keysToTry.length > 0) {\n          for (const [storedKey, stockData] of variantStockMap.entries()) {\n            for (const searchKey of keysToTry) {\n              if (searchKey && (storedKey.includes(searchKey) || searchKey.includes(storedKey))) {\n                return stockData;\n              }\n            }\n          }\n        }\n        \n        return undefined;\n      };\n      \n      // Track inventory fetch status for UI feedback\n      let inventoryStatus: 'ok' | 'error' | 'partial' = 'ok';\n      let inventoryErrorMessage: string | undefined;\n      \n      // Declare variantInventory outside try block so it's accessible for inventoryVariants building\n      let variantInventory: Awaited<ReturnType<typeof queryVariantInventory>> = [];\n      \n      try {\n        // Fetch product-level inventory from dedicated API\n        realInventory = await getInventoryByPid(pid);\n        if (realInventory) {\n          console.log(`[Search&Price] Product ${pid} - Inventory from getInventoryByPid:`);\n          console.log(`  - Total: ${realInventory.totalAvailable} (CJ: ${realInventory.totalCJ}, Factory: ${realInventory.totalFactory})`);\n          console.log(`  - Warehouses: ${realInventory.warehouses.length}`);\n          for (const wh of realInventory.warehouses) {\n            console.log(`    - ${wh.areaName}: CJ=${wh.cjInventory}, Factory=${wh.factoryInventory}, Total=${wh.totalInventory}`);\n          }\n        } else {\n          console.log(`[Search&Price] Product ${pid} - No inventory data returned from getInventoryByPid`);\n          inventoryStatus = 'partial';\n          inventoryErrorMessage = 'Could not fetch warehouse inventory';\n        }\n        \n        // Also fetch per-variant inventory (CJ vs Factory breakdown per variant)\n        // This matches CJ's \"Inventory Details\" modal showing: White-L (CJ:0, Factory:6714), etc.\n        // Use shared rate limiter to respect CJ's 1 rps limit across all concurrent requests\n        const rateLimitAcquired = await waitForCjRateLimit();\n        if (!rateLimitAcquired) {\n          console.warn(`[Search&Price] Product ${pid} - Rate limit timeout for queryVariantInventory`);\n          inventoryStatus = 'error';\n          inventoryErrorMessage = 'Rate limit timeout - too many concurrent requests';\n        }\n        \n        try {\n          variantInventory = await queryVariantInventory(pid);\n        } catch (e: any) {\n          const errorMsg = e?.message || 'Failed to fetch variant inventory';\n          console.log(`[Search&Price] Product ${pid} - queryVariantInventory error: ${errorMsg}`);\n          inventoryStatus = inventoryStatus === 'ok' ? 'partial' : 'error';\n          inventoryErrorMessage = inventoryErrorMessage ? `${inventoryErrorMessage}; ${errorMsg}` : errorMsg;\n        }\n        if (variantInventory && variantInventory.length > 0) {\n          console.log(`[Search&Price] Product ${pid} - Per-variant inventory: ${variantInventory.length} variants`);\n          for (const vi of variantInventory) {\n            const stockData = {\n              cjStock: vi.cjStock,\n              factoryStock: vi.factoryStock,\n              totalStock: vi.totalStock,\n            };\n            // Store under ALL possible normalized keys for robust matching\n            // This ensures we can match by ANY identifier CJ uses\n            const keysToStore = [\n              normalizeKey(vi.variantSku),\n              normalizeKey(vi.vid),\n              normalizeKey(vi.variantId),\n              normalizeKey(vi.variantKey),\n              normalizeKey(vi.variantName),\n            ].filter(k => k && k.length > 0);\n            \n            for (const key of keysToStore) {\n              variantStockMap.set(key, stockData);\n            }\n            console.log(`    - ${vi.variantName || vi.variantSku}: CJ=${vi.cjStock}, Factory=${vi.factoryStock}, Total=${vi.totalStock} (${keysToStore.length} keys stored)`);\n          }\n          console.log(`[Search&Price] Product ${pid} - Stored ${variantStockMap.size} total stock keys`);\n        } else if (!inventoryErrorMessage) {\n          // No variants returned but no error - mark as partial\n          inventoryStatus = inventoryStatus === 'ok' ? 'partial' : inventoryStatus;\n        }\n      } catch (e: any) {\n        console.log(`[Search&Price] Product ${pid} - Error fetching inventory: ${e?.message}`);\n        inventoryStatus = 'error';\n        inventoryErrorMessage = e?.message || 'Failed to fetch inventory data';\n      }\n      \n      // Build inventoryVariants array from ALL variant inventory data\n      // This is for the blue Inventory Details box on Page 4 - shows ALL variants\n      const inventoryVariants: InventoryVariant[] = [];\n      if (variantInventory && variantInventory.length > 0) {\n        for (const vi of variantInventory) {\n          // Only include variants with stock > 0\n          if (vi.totalStock <= 0) continue;\n          \n          // Parse short name from variantKey or variantName (format: \"Black-L\", \"HA0127-XXL\")\n          const variantKeyRaw = String(vi.variantKey || vi.variantName || vi.variantSku || '');\n          let shortName = variantKeyRaw;\n          \n          // Clean up the name - remove any Chinese characters\n          shortName = shortName.replace(/[\\u4e00-\\u9fff]/g, '').trim();\n          \n          // If still empty, use SKU\n          if (!shortName) {\n            shortName = vi.variantSku || `Variant-${vi.vid || vi.variantId || '?'}`;\n          }\n          \n          inventoryVariants.push({\n            variantId: String(vi.vid || vi.variantId || ''),\n            sku: vi.variantSku,\n            shortName,\n            priceUSD: vi.price,\n            cjStock: vi.cjStock,\n            factoryStock: vi.factoryStock,\n            totalStock: vi.totalStock,\n          });\n        }\n        console.log(`[Search&Price] Product ${pid} - Built ${inventoryVariants.length} inventoryVariants for display`);\n      }\n      \n      // Fallback: if no inventoryVariants but we have product-level stock,\n      // try to build from product's variant list (from fullDetails or item)\n      // IMPORTANT: We show real variant names/prices but mark stock as -1 (unknown)\n      // to maintain 100% accuracy - we never fabricate per-variant stock counts\n      if (inventoryVariants.length === 0 && (realInventory?.totalAvailable || 0) > 0) {\n        const productSource = fullDetails || item;\n        const productVariantList = productSource?.variantList || productSource?.skuList || productSource?.variants || [];\n        \n        if (Array.isArray(productVariantList) && productVariantList.length > 0) {\n          // Build inventoryVariants from product's variant list\n          // Show real names and prices, but use -1 for stock (indicates \"per-variant unknown\")\n          // The UI can display total stock from product-level data separately\n          for (const pv of productVariantList) {\n            const sku = pv.variantSku || pv.sku || pv.vid || '';\n            // IMPORTANT: variantKey is the SHORT name like \"Black And Silver-2XL\"\n            // variantNameEn is the LONG descriptive name - use as fallback\n            const variantKeyShort = pv.variantKey || '';\n            const variantNameLong = pv.variantNameEn || pv.variantName || pv.skuName || '';\n            const price = Number(pv.variantSellPrice || pv.sellPrice || pv.variantPrice || pv.price || 0);\n            const vid = pv.vid || '';\n            \n            // Parse a clean short name - prioritize variantKey (short) over variantNameEn (long)\n            let shortName = variantKeyShort || variantNameLong;\n            shortName = shortName.replace(/[\\u4e00-\\u9fff]/g, '').trim();\n            if (!shortName) {\n              shortName = sku || `Variant-${vid || '?'}`;\n            }\n            \n            // Use -1 to indicate \"per-variant stock unknown\" \n            // This maintains accuracy - we don't fabricate numbers\n            inventoryVariants.push({\n              variantId: vid || sku,\n              sku,\n              shortName,\n              priceUSD: price,\n              cjStock: -1,      // Unknown per-variant\n              factoryStock: -1, // Unknown per-variant\n              totalStock: -1,   // Unknown per-variant\n            });\n          }\n          console.log(`[Search&Price] Product ${pid} - Built ${inventoryVariants.length} inventoryVariants from product variant list (stock marked unknown)`);\n        } else {\n          // True single-variant product - show actual totals\n          inventoryVariants.push({\n            variantId: cjSku,\n            sku: cjSku,\n            shortName: 'Default',\n            priceUSD: 0,\n            cjStock: realInventory?.totalCJ ?? 0,\n            factoryStock: realInventory?.totalFactory ?? 0,\n            totalStock: realInventory?.totalAvailable ?? 0,\n          });\n          console.log(`[Search&Price] Product ${pid} - Used product-level inventory as single inventoryVariant`);\n        }\n      }\n      \n      // Use REAL inventory data from dedicated API (most accurate)\n      const stock = realInventory?.totalAvailable ?? Number(item.stock || 0);\n      const totalVerifiedInventory = realInventory?.totalCJ ?? 0;\n      const totalUnVerifiedInventory = realInventory?.totalFactory ?? 0;\n      \n      // listedNum comes from listV2 or fullDetails - not inventory API\n      const listedNum = fullDetails?.listedNum ?? Number(item.listedNum || 0);\n      \n      console.log(`[Search&Price] Product ${pid} => Final: stock=${stock}, listedNum=${listedNum}, CJ=${totalVerifiedInventory}, Factory=${totalUnVerifiedInventory}`);\n      \n      let images = extractAllImages(fullDetails || item);\n      console.log(`[Search&Price] Product ${pid}: ${images.length} images from details`);\n      \n      // Extract additional product info from fullDetails or item\n      const source = fullDetails || item;\n      const rawDescriptionHtml = String(source.description || source.productDescription || source.descriptionEn || source.productDescEn || source.desc || '').trim();\n      \n      // Get rating from productComments API (reliable source)\n      let rating: number | undefined = undefined;\n      let reviewCount = 0;\n      const ratingData = productRatingsMap.get(pid);\n      if (ratingData && ratingData.rating !== null && ratingData.rating !== undefined) {\n        // Ensure rating is a number (CJ API may return strings)\n        const parsedRating = Number(ratingData.rating);\n        if (Number.isFinite(parsedRating) && parsedRating > 0) {\n          rating = parsedRating;\n          reviewCount = Number(ratingData.reviewCount) || 0;\n          console.log(`[Search&Price] Product ${pid}: Rating ${rating} from comments API (${reviewCount} reviews)`);\n        } else {\n          console.log(`[Search&Price] Product ${pid}: Invalid rating value: ${ratingData.rating}`);\n        }\n      } else {\n        console.log(`[Search&Price] Product ${pid}: No rating available from comments API`);\n      }\n      \n      const categoryName = String(source.categoryName || source.categoryNameEn || source.category || '').trim() || undefined;\n      \n      // Extract product weight - check all possible CJ field names\n      // For shipping, use packWeight (product + packaging) which is what carriers charge for\n      // CJ API returns: packWeight/packingWeight (total) and productWeight (net)\n      const weightCandidates: Array<{ field: string; value: any }> = [\n        { field: 'packWeight', value: source.packWeight },           // Total weight (preferred for shipping)\n        { field: 'packingWeight', value: source.packingWeight },     // Same as packWeight\n        { field: 'productWeight', value: source.productWeight },     // Net weight only\n        { field: 'weight', value: source.weight },                   // Alternative field name\n        { field: 'grossWeight', value: source.grossWeight },\n        { field: 'netWeight', value: source.netWeight },\n      ];\n      \n      // Find the first valid weight value\n      let productWeight: number | undefined = undefined;\n      let weightSource = 'none';\n      for (const { field, value } of weightCandidates) {\n        if (value !== undefined && value !== null && value !== '') {\n          const numVal = Number(value);\n          if (Number.isFinite(numVal) && numVal > 0) {\n            // CJ typically returns weight in grams, but check if it might be kg\n            productWeight = numVal < 30 ? Math.round(numVal * 1000) : Math.round(numVal);\n            weightSource = field;\n            break;\n          }\n        }\n      }\n      \n      const packLength = source.packLength !== undefined ? Number(source.packLength) : (source.length !== undefined ? Number(source.length) : undefined);\n      const packWidth = source.packWidth !== undefined ? Number(source.packWidth) : (source.width !== undefined ? Number(source.width) : undefined);\n      const packHeight = source.packHeight !== undefined ? Number(source.packHeight) : (source.height !== undefined ? Number(source.height) : undefined);\n      \n      // Debug: Log extracted weight/dimensions for shipping calculation accuracy\n      console.log(`[Search&Price] Product ${pid} dimensions: weight=${productWeight}g (from ${weightSource}), L=${packLength}cm, W=${packWidth}cm, H=${packHeight}cm`);\n      \n      // Log all available weight-related fields for debugging if weight not found\n      if (!productWeight) {\n        const weightFields = Object.entries(source).filter(([k, v]) => \n          /weight/i.test(k) && v !== undefined && v !== null && v !== ''\n        );\n        if (weightFields.length > 0) {\n          console.log(`[Search&Price] Product ${pid} available weight fields: ${JSON.stringify(Object.fromEntries(weightFields))}`);\n        }\n      }\n      const productType = String(source.productType || source.type || source.productTypeName || '').trim() || undefined;\n      \n      // Helper: Parse CJ JSON array fields like '[\"\",\"metal\"]' into readable string\n      const parseCjJsonArray = (val: any): string => {\n        if (!val) return '';\n        if (Array.isArray(val)) return val.filter(Boolean).map(String).join(', ');\n        if (typeof val === 'string') {\n          const trimmed = val.trim();\n          if (trimmed.startsWith('[')) {\n            try {\n              const arr = JSON.parse(trimmed);\n              if (Array.isArray(arr)) return arr.filter(Boolean).map(String).join(', ');\n            } catch {}\n          }\n          return trimmed;\n        }\n        return '';\n      };\n      \n      // Try to get material - first try parsed arrays (from fullDetails), then raw field, then parse locally\n      let material = source.materialParsed || '';\n      if (!material) {\n        const rawMaterial = source.material || source.productMaterial || source.materialNameEn || source.materialName || '';\n        material = parseCjJsonArray(rawMaterial);\n      }\n      material = material.trim() || undefined;\n      \n      // Try to get packing info similarly\n      let packingInfo = source.packingParsed || '';\n      if (!packingInfo) {\n        const rawPacking = source.packingNameEn || source.packingName || source.packingList || '';\n        packingInfo = parseCjJsonArray(rawPacking);\n      }\n      packingInfo = packingInfo.trim() || undefined;\n      \n      // Helper: Sanitize HTML - remove supplier links/contacts but keep usable content\n      const sanitizeHtml = (html: string): string | undefined => {\n        if (!html || typeof html !== 'string') return undefined;\n        let cleaned = html\n          // Remove 1688.com and other supplier links\n          .replace(/<a[^>]*href=[^>]*(1688|taobao|alibaba|aliexpress|tmall)[^>]*>.*?<\\/a>/gi, '')\n          .replace(/https?:\\/\\/[^\\s<>\"]*?(1688|taobao|alibaba|aliexpress|tmall)[^\\s<>\"]*/gi, '')\n          // Remove WeChat/QQ/supplier contact info\n          .replace(/<[^>]*>(.*?(微信|QQ|联系|客服|淘宝|阿里巴巴|天猫|拼多多|抖音|快手).*?)<\\/[^>]*>/gi, '')\n          // Remove emoji patterns\n          .replace(/[\\u{1F300}-\\u{1F9FF}]|[\\u{2600}-\\u{26FF}]|[\\u{2700}-\\u{27BF}]/gu, '')\n          // Remove empty elements\n          .replace(/<(\\w+)[^>]*>\\s*<\\/\\1>/g, '')\n          // Remove multiple whitespace and line breaks\n          .replace(/\\s+/g, ' ')\n          .trim();\n        \n        // Check if remaining content has any useful content\n        const textOnly = cleaned.replace(/<[^>]*>/g, '').trim();\n        const hasEnglish = /[a-zA-Z]/.test(textOnly); // Single letter is enough\n        const hasArabic = /[\\u0600-\\u06FF]/.test(textOnly);\n        const hasNumbers = /\\d/.test(textOnly);\n        const hasUnits = /\\b(cm|mm|m|kg|g|ml|l|inch|oz|lb)\\b/i.test(textOnly);\n        \n        // If no useful content remains, return undefined\n        if (!hasEnglish && !hasArabic && !hasNumbers && textOnly.length === 0) return undefined;\n        \n        // Accept content if it has numbers or units (likely specs) even if Chinese-heavy\n        if (hasNumbers || hasUnits) {\n          return cleaned.length > 0 ? cleaned : undefined;\n        }\n        \n        // For pure text, if >90% Chinese with no English, skip it\n        const chineseChars = (textOnly.match(/[\\u4e00-\\u9fff]/g) || []).length;\n        if (textOnly.length > 0 && !hasEnglish && !hasArabic && chineseChars > textOnly.length * 0.9) return undefined;\n        \n        // Return cleaned content if it has any text\n        return cleaned.length > 0 ? cleaned : undefined;\n      };\n      \n      // Helper: Build product info from productPropertyList if description is empty\n      // CJ propertyList structure: { propertyName, propertyNameEn, propertyValueList: [{propertyValueName, propertyValueNameEn}] }\n      const buildInfoFromProperties = (props: any[]): string => {\n        if (!Array.isArray(props) || props.length === 0) return '';\n        const lines: string[] = [];\n        \n        // Helper to clean a value - strip pure Chinese, keep mixed/numeric content\n        const cleanValue = (val: string): string => {\n          if (!val) return '';\n          const trimmed = val.trim();\n          // If it has numbers or units, keep it even with Chinese\n          if (/\\d/.test(trimmed) || /\\b(cm|mm|m|kg|g|ml|l|inch|oz|lb|pcs|pc|set)\\b/i.test(trimmed)) {\n            // Remove pure Chinese segments but keep numbers and English\n            return trimmed.replace(/^[\\u4e00-\\u9fff\\s]+(?=\\d)/g, '').replace(/[\\u4e00-\\u9fff]+$/g, '').trim();\n          }\n          // If it has English letters, keep it\n          if (/[a-zA-Z]/.test(trimmed)) {\n            return trimmed;\n          }\n          // Pure Chinese with no useful content\n          return '';\n        };\n        \n        for (const prop of props) {\n          // Try EN name first, then fallback to base name\n          let name = String(prop.propertyNameEn || '').trim();\n          if (!name) {\n            name = String(prop.propertyName || prop.name || prop.key || '').trim();\n            // Skip if name is pure Chinese\n            if (/^[\\u4e00-\\u9fff\\s]+$/.test(name)) continue;\n          }\n          if (!name) continue;\n          \n          // Handle nested propertyValueList array (common CJ structure)\n          const valueList = prop.propertyValueList || prop.values || prop.options || [];\n          if (Array.isArray(valueList) && valueList.length > 0) {\n            const values: string[] = [];\n            for (const v of valueList) {\n              // Try multiple value fields with fallbacks\n              const raw = String(v.propertyValueNameEn || v.propertyValueName || v.valueNameEn || v.valueName || v.name || v.value || '').trim();\n              const cleaned = cleanValue(raw);\n              if (cleaned) {\n                values.push(cleaned);\n              }\n            }\n            if (values.length > 0) {\n              lines.push(`${name}: ${values.join(', ')}`);\n            }\n          } else {\n            // Handle scalar value (fallback) - try multiple fields\n            const raw = String(prop.propertyValueNameEn || prop.propertyValueName || prop.propertyValue || prop.value || prop.valueName || '').trim();\n            const cleaned = cleanValue(raw);\n            if (cleaned) {\n              lines.push(`${name}: ${cleaned}`);\n            }\n          }\n        }\n        return lines.join('<br/>');\n      };\n      \n      // Helper: Extract specs from HTML description (tables, lists, key:value patterns)\n      const extractSpecsFromHtml = (html: string): string => {\n        if (!html || typeof html !== 'string') return '';\n        const lines: string[] = [];\n        \n        // Remove supplier junk first\n        let cleaned = html\n          .replace(/<a[^>]*href=[^>]*(1688|taobao|alibaba|aliexpress|tmall)[^>]*>.*?<\\/a>/gi, '')\n          .replace(/https?:\\/\\/[^\\s<>\"]*?(1688|taobao|alibaba|aliexpress|tmall)[^\\s<>\"]*/gi, '')\n          .replace(/<[^>]*>(.*?(微信|QQ|联系|客服|淘宝|阿里巴巴).*?)<\\/[^>]*>/gi, '');\n        \n        // Extract key:value patterns like \"Material: Cotton\" or \"Size: S-XL\"\n        const kvPatterns = cleaned.match(/([A-Za-z][A-Za-z\\s]{2,30})[\\s]*[:\\-：][\\s]*([A-Za-z0-9][A-Za-z0-9\\s,.\\-\\/×xX%]+)/g) || [];\n        for (const kv of kvPatterns) {\n          const match = kv.match(/([A-Za-z][A-Za-z\\s]{2,30})[\\s]*[:\\-：][\\s]*(.+)/);\n          if (match && match[1] && match[2]) {\n            const key = match[1].trim();\n            const value = match[2].trim();\n            // Skip if mostly Chinese in value\n            const chineseChars = (value.match(/[\\u4e00-\\u9fff]/g) || []).length;\n            if (chineseChars < value.length * 0.5 && value.length > 1) {\n              lines.push(`${key}: ${value}`);\n            }\n          }\n        }\n        \n        // Extract from <li> items that look like specs\n        const liItems = cleaned.match(/<li[^>]*>([^<]+)<\\/li>/gi) || [];\n        for (const li of liItems) {\n          const text = li.replace(/<[^>]*>/g, '').trim();\n          // Must have English letters and not be too long\n          if (/[a-zA-Z]/.test(text) && text.length > 3 && text.length < 100) {\n            const chineseChars = (text.match(/[\\u4e00-\\u9fff]/g) || []).length;\n            if (chineseChars < text.length * 0.3) {\n              lines.push(text);\n            }\n          }\n        }\n        \n        // Deduplicate\n        const seen = new Set<string>();\n        const uniqueLines: string[] = [];\n        for (const line of lines) {\n          const normalized = line.toLowerCase().replace(/\\s+/g, ' ');\n          if (!seen.has(normalized)) {\n            seen.add(normalized);\n            uniqueLines.push(line);\n          }\n        }\n        \n        return uniqueLines.slice(0, 20).join('<br/>');\n      };\n      \n      // Helper: Build basic specs from product fields (only meaningful customer-facing data)\n      const buildBasicSpecs = (): string => {\n        const specs: string[] = [];\n        if (material && material.length > 1) specs.push(`Material: ${material}`);\n        if (packingInfo && packingInfo.length > 1) specs.push(`Package: ${packingInfo}`);\n        if (productWeight && productWeight > 0) specs.push(`Weight: ${productWeight}g`);\n        if (packLength && packWidth && packHeight) {\n          specs.push(`Package Size: ${packLength} × ${packWidth} × ${packHeight} cm`);\n        }\n        // Add delivery cycle if available\n        const deliveryCycle = source.deliveryCycle;\n        if (deliveryCycle) {\n          specs.push(`Delivery: ${deliveryCycle} days`);\n        }\n        // Only include category if we have other specs too\n        if (specs.length > 0 && categoryName && !categoryName.includes('_')) {\n          specs.push(`Category: ${categoryName}`);\n        }\n        return specs.join('<br/>');\n      };\n      \n      // Sanitize the description HTML (apply after sanitizeHtml is defined)\n      const description = sanitizeHtml(rawDescriptionHtml);\n      \n      // Extract Product Information - check multiple sources\n      let rawProductInfo = String(source.description || source.productDescription || source.descriptionEn || source.productDescEn || source.desc || '').trim();\n      const descriptionHtml = rawProductInfo; // Save for later extraction\n      \n      // First try productPropertyList (best quality specs)\n      const propList = source.productPropertyList || source.propertyList || source.properties || source.specs || source.attributes || [];\n      const propsInfo = buildInfoFromProperties(propList);\n      if (propsInfo && propsInfo.length > 10) {\n        rawProductInfo = propsInfo;\n      }\n      \n      // If no specs from property list, try to extract from HTML description\n      if (!rawProductInfo || rawProductInfo.length < 10) {\n        const htmlSpecs = extractSpecsFromHtml(descriptionHtml);\n        if (htmlSpecs && htmlSpecs.length > 10) {\n          rawProductInfo = htmlSpecs;\n        }\n      }\n      \n      // If still nothing, check nested data structures\n      if (!rawProductInfo || rawProductInfo.length < 10) {\n        const nested = source.data || source.product || source.detail || source.info || {};\n        if (typeof nested === 'object') {\n          const nestedDesc = String(nested.description || nested.productDescription || nested.descriptionEn || '').trim();\n          if (nestedDesc) {\n            const nestedSpecs = extractSpecsFromHtml(nestedDesc);\n            if (nestedSpecs && nestedSpecs.length > 10) {\n              rawProductInfo = nestedSpecs;\n            }\n          }\n        }\n      }\n      \n      // Try synthesizedInfo from fetchProductDetailsByPid (contains parsed material, packing, weight, etc.)\n      if (!rawProductInfo || rawProductInfo.length < 10) {\n        if (source.synthesizedInfo) {\n          rawProductInfo = source.synthesizedInfo;\n          console.log(`[Search&Price] Product ${pid}: Using synthesizedInfo as productInfo fallback`);\n        }\n      }\n      \n      // Last resort: build basic specs from known fields\n      if (!rawProductInfo || rawProductInfo.length < 10) {\n        const basicSpecs = buildBasicSpecs();\n        if (basicSpecs) {\n          rawProductInfo = basicSpecs;\n        }\n      }\n      \n      const productInfo = sanitizeHtml(rawProductInfo);\n      \n      // Extract Product Note (sizing/color notes from CJ) - heavily sanitize\n      const rawProductNote = String(source.productNote || source.note || source.notes || source.remark || source.memo || source.comment || source.remarkEn || '').trim();\n      const productNote = sanitizeHtml(rawProductNote);\n      \n      // Extract Packing List - check multiple field names\n      let rawPackingList = String(source.packingList || source.packing || source.packageContent || source.packageList || source.packingNameEn || source.packingName || source.packageInfo || '').trim();\n      \n      // If packingList is empty, check if it's in a nested structure or property list\n      if (!rawPackingList) {\n        const propList = source.productPropertyList || source.propertyList || [];\n        if (Array.isArray(propList)) {\n          for (const prop of propList) {\n            const name = String(prop.propertyNameEn || prop.propertyName || prop.name || '').toLowerCase();\n            if (name.includes('pack') || name.includes('includ') || name.includes('content') || name.includes('box')) {\n              // Handle nested propertyValueList array\n              const valueList = prop.propertyValueList || prop.values || [];\n              if (Array.isArray(valueList) && valueList.length > 0) {\n                const values: string[] = [];\n                for (const v of valueList) {\n                  const val = String(v.propertyValueNameEn || v.propertyValueName || v.value || '').trim();\n                  if (val && !/[\\u4e00-\\u9fff]/.test(val)) values.push(val);\n                }\n                if (values.length > 0) {\n                  rawPackingList = values.join(', ');\n                  break;\n                }\n              } else {\n                // Scalar value fallback\n                rawPackingList = String(prop.propertyValueNameEn || prop.propertyValueName || prop.value || '').trim();\n                if (rawPackingList) break;\n              }\n            }\n          }\n        }\n      }\n      \n      const packingList = sanitizeHtml(rawPackingList) || (rawPackingList && rawPackingList.length > 2 && !/[\\u4e00-\\u9fff]/.test(rawPackingList) ? rawPackingList : undefined);\n      \n      // Extract Overview - short product summary from name/category\n      // ALWAYS build overview with whatever data we have - this ensures Page 3 shows something\n      let overview: string | undefined;\n      const categoryDisplay = source.threeCategoryName || source.twoCategoryName || source.oneCategoryName || categoryName || '';\n      const overviewParts: string[] = [];\n      \n      // Category - always include if available\n      if (categoryDisplay && !categoryDisplay.includes('_')) {\n        overviewParts.push(`Category: ${categoryDisplay}`);\n      }\n      \n      // Material - include if available and not Chinese-only\n      if (material && material.length > 1 && !/[\\u4e00-\\u9fff]/.test(material)) {\n        overviewParts.push(`Material: ${material}`);\n      }\n      \n      // Packing/Package info\n      if (packingInfo && packingInfo.length > 1 && !/[\\u4e00-\\u9fff]/.test(packingInfo)) {\n        overviewParts.push(`Package: ${packingInfo}`);\n      }\n      \n      // Weight\n      if (productWeight && productWeight > 0) {\n        overviewParts.push(`Weight: ${productWeight}g`);\n      }\n      \n      // Dimensions\n      if (packLength && packWidth && packHeight) {\n        overviewParts.push(`Dimensions: ${packLength} × ${packWidth} × ${packHeight} cm`);\n      }\n      \n      // Delivery cycle\n      if (source.deliveryCycle) {\n        overviewParts.push(`Delivery: ${source.deliveryCycle} days`);\n      }\n      \n      // HS Code for customs info\n      if (source.entryCode && source.entryNameEn) {\n        overviewParts.push(`HS Code: ${source.entryCode}`);\n      }\n      \n      // Product type\n      if (productType && productType.length > 1 && productType !== 'ORDINARY_PRODUCT') {\n        overviewParts.push(`Type: ${productType}`);\n      }\n      \n      if (overviewParts.length > 0) {\n        overview = overviewParts.join('<br/>');\n      }\n      \n      // If Overview only has Category (meaning we didn't find material/weight/etc from raw fields),\n      // try to use synthesizedInfo which was built in fetchProductDetailsByPid with this data\n      if (overviewParts.length <= 1 && source.synthesizedInfo) {\n        // synthesizedInfo contains Material, Package, Weight, Dimensions, Category, Delivery, HS Code\n        // Split on <br/> BEFORE sanitizing to preserve line structure, then sanitize each line\n        const synthLines = String(source.synthesizedInfo).split(/<br\\s*\\/?>/i);\n        const cleanedLines: string[] = [];\n        for (const line of synthLines) {\n          const cleaned = sanitizeHtml(line);\n          if (cleaned && cleaned.length > 2) {\n            cleanedLines.push(cleaned);\n          }\n        }\n        if (cleanedLines.length > 1) {\n          overview = cleanedLines.join('<br/>');\n          console.log(`[Search&Price] Product ${pid}: Using synthesizedInfo as Overview (${cleanedLines.length} lines)`);\n        }\n      }\n      \n      // Extract Size Info - dimensions, size options from properties and variants\n      let sizeInfo: string | undefined;\n      const sizeLines: string[] = [];\n      \n      // Add pack dimensions if available\n      if (packLength && packWidth && packHeight) {\n        sizeLines.push(`Package Size: ${packLength} × ${packWidth} × ${packHeight} cm`);\n      }\n      \n      // Extract size properties from propertyList\n      const sizePropList = source.productPropertyList || source.propertyList || [];\n      if (Array.isArray(sizePropList)) {\n        for (const prop of sizePropList) {\n          const propName = String(prop.propertyNameEn || prop.propertyName || prop.name || '').toLowerCase();\n          if (propName.includes('size') || propName.includes('dimension') || propName.includes('length') || \n              propName.includes('width') || propName.includes('height') || propName.includes('bust') || \n              propName.includes('waist') || propName.includes('hip')) {\n            const valueList = prop.propertyValueList || prop.values || [];\n            if (Array.isArray(valueList) && valueList.length > 0) {\n              const values: string[] = [];\n              for (const v of valueList) {\n                const val = String(v.propertyValueNameEn || v.propertyValueName || v.value || '').trim();\n                if (val && !/^[\\u4e00-\\u9fff]+$/.test(val)) values.push(val);\n              }\n              if (values.length > 0) {\n                const displayName = prop.propertyNameEn || prop.propertyName || 'Size';\n                sizeLines.push(`${displayName}: ${values.join(', ')}`);\n              }\n            }\n          }\n        }\n      }\n      \n      if (sizeLines.length > 0) {\n        sizeInfo = sizeLines.join('<br/>');\n      }\n      \n      // Extract Size Chart Images (CJ provides these as separate images)\n      const sizeChartImages: string[] = [];\n      const sizeChartFields = ['sizeChartImage', 'sizeChart', 'sizeImage', 'measurementImage', 'chartImage'];\n      for (const field of sizeChartFields) {\n        const val = source[field];\n        if (typeof val === 'string' && val.startsWith('http')) {\n          sizeChartImages.push(val);\n        } else if (Array.isArray(val)) {\n          for (const img of val) {\n            if (typeof img === 'string' && img.startsWith('http')) {\n              sizeChartImages.push(img);\n            }\n          }\n        }\n      }\n      // Also check detailImageList for size chart images (often contain measurement diagrams)\n      const detailImages = source.detailImageList || source.descriptionImages || [];\n      if (Array.isArray(detailImages)) {\n        for (const img of detailImages) {\n          const url = typeof img === 'string' ? img : (img?.url || img?.imageUrl || '');\n          if (typeof url === 'string' && url.startsWith('http') && /size|chart|measure|dimension/i.test(url)) {\n            sizeChartImages.push(url);\n          }\n        }\n      }\n      \n      // Log what we found for debugging - all 6 Page 3 fields\n      console.log(`[Search&Price] Product ${pid} Page 3 fields:`);\n      console.log(`  - description: ${description ? `YES (${description.length} chars)` : 'NO'}`);\n      console.log(`  - overview: ${overview ? `YES (${overview.length} chars)` : 'NO'}`);\n      console.log(`  - productInfo: ${productInfo ? `YES (${productInfo.length} chars)` : 'NO'}`);\n      console.log(`  - sizeInfo: ${sizeInfo ? `YES (${sizeInfo.length} chars)` : 'NO'}`);\n      console.log(`  - productNote: ${productNote ? `YES (${productNote.length} chars)` : 'NO'}`);\n      console.log(`  - packingList: ${packingList ? `YES (${packingList.length} chars)` : 'NO'}`);\n      console.log(`  - sizeChartImages: ${sizeChartImages.length}`);\n      \n      // Fetch variants - CJ returns only purchasable variants in this API\n      const variants = await getVariantsForProduct(token, base, pid);\n      \n      // Build set of images from variants (these are the purchasable color options)\n      const variantImages: string[] = [];\n      const seenUrls = new Set<string>();\n      \n      // First, add the main product image (this is always the hero image)\n      const mainImage = item.productImage || item.image || item.bigImage;\n      if (typeof mainImage === 'string' && mainImage.startsWith('http')) {\n        seenUrls.add(mainImage);\n        variantImages.push(mainImage);\n      }\n      \n      // Extract images from ALL variants (CJ only returns purchasable ones)\n      // Check all possible image field names\n      const imgFields = ['variantImage', 'whiteImage', 'image', 'imageUrl', 'imgUrl', 'bigImage', 'variantImg', 'skuImage', 'pic', 'picture', 'photo'];\n      \n      for (const v of variants) {\n        for (const field of imgFields) {\n          const url = v[field];\n          if (typeof url === 'string' && url.startsWith('http') && !seenUrls.has(url)) {\n            seenUrls.add(url);\n            variantImages.push(url);\n          }\n        }\n        \n        // Also check nested structures like variantProperty\n        const variantProps = v.variantPropertyList || v.propertyList || v.properties || [];\n        if (Array.isArray(variantProps)) {\n          for (const prop of variantProps) {\n            const propImg = prop?.image || prop?.propImage || prop?.imageUrl || prop?.pic;\n            if (typeof propImg === 'string' && propImg.startsWith('http') && !seenUrls.has(propImg)) {\n              seenUrls.add(propImg);\n              variantImages.push(propImg);\n            }\n          }\n        }\n      }\n      \n      console.log(`[Search&Price] Product ${pid}: ${variantImages.length} images from ${variants.length} variants`);\n      \n      // Build combined product info: start with productInfo, then add variant colors/sizes\n      // This ensures we show BOTH material/packing specs AND variant options\n      const allSpecs: string[] = [];\n      \n      // Initialize extracted sizes/colors for filtering\n      let extractedSizes: string[] = [];\n      let extractedColors: string[] = [];\n      \n      // First, add base product specs (material, packing, weight, etc.)\n      let baseSpecs = productInfo;\n      if (!baseSpecs && source.synthesizedInfo) {\n        // Split on <br/> BEFORE sanitizing to preserve line structure\n        const synthLines = String(source.synthesizedInfo).split(/<br\\s*\\/?>/i);\n        const cleanedLines: string[] = [];\n        for (const line of synthLines) {\n          const cleaned = sanitizeHtml(line);\n          if (cleaned && cleaned.length > 2) {\n            cleanedLines.push(cleaned);\n          }\n        }\n        if (cleanedLines.length > 0) {\n          baseSpecs = cleanedLines.join('<br/>');\n          console.log(`[Search&Price] Product ${pid}: Using synthesizedInfo for base specs (${cleanedLines.length} lines)`);\n        }\n      }\n      if (!baseSpecs) {\n        const basicSpecs = buildBasicSpecs();\n        if (basicSpecs && basicSpecs.length > 10) {\n          baseSpecs = basicSpecs;\n          console.log(`[Search&Price] Product ${pid}: Using buildBasicSpecs for base specs`);\n        }\n      }\n      \n      // Add base specs to allSpecs\n      if (baseSpecs) {\n        allSpecs.push(baseSpecs);\n      }\n      \n      // Now extract variant colors/sizes/models and ADD them (not replace)\n      let extractedModels: string[] = [];\n      \n      if (variants.length > 0) {\n        // Debug: Log first variant structure to understand CJ format\n        const sampleVariant = variants[0];\n        console.log(`[Search&Price] Product ${pid}: Sample variant keys: ${Object.keys(sampleVariant).join(', ')}`);\n        console.log(`[Search&Price] Product ${pid}: Sample variant data: ${JSON.stringify(sampleVariant).substring(0, 500)}`);\n        \n        const colors = new Set<string>();\n        const sizes = new Set<string>();\n        const models = new Set<string>();\n        \n        // Extended color list for matching\n        const colorList = ['Black', 'White', 'Red', 'Blue', 'Green', 'Yellow', 'Pink', 'Purple', 'Orange', 'Brown', 'Grey', 'Gray', 'Beige', 'Navy', 'Khaki', 'Apricot', 'Wine', 'Coffee', 'Camel', 'Cream', 'Rose', 'Gold', 'Silver', 'Ivory', 'Mint', 'Coral', 'Burgundy', 'Maroon', 'Olive', 'Teal', 'Turquoise', 'Lavender', 'Lilac', 'Peach', 'Tan', 'Charcoal', 'Violet', 'Nude', 'Dark Grey', 'Light Grey', 'Dark Blue', 'Light Blue', 'Sky Blue', 'Dark Green', 'Light Green', 'Dark Pink', 'Light Pink', 'Off White'];\n        const colorSet = new Set(colorList.map(c => c.toLowerCase()));\n        const colorPattern = /\\b(Black|White|Red|Blue|Green|Yellow|Pink|Purple|Orange|Brown|Grey|Gray|Beige|Navy|Khaki|Apricot|Wine|Coffee|Camel|Cream|Rose|Gold|Silver|Ivory|Mint|Coral|Burgundy|Maroon|Olive|Teal|Turquoise|Lavender|Lilac|Peach|Tan|Charcoal|Sky Blue|Dark Blue|Light Blue|Light Green|Dark Green|Light Pink|Dark Pink|Off White|Nude|Violet|Dark Grey|Light Grey)\\b/gi;\n        \n        // Device model patterns (phones, tablets, etc.)\n        const deviceModelPattern = /\\b(iPhone\\s*\\d+\\s*(?:Pro|Plus|Max|mini|SE)?(?:\\s*Max)?|Samsung\\s*(?:S|A|Note|Galaxy)\\s*\\d+(?:\\s*(?:Plus|Ultra|FE))?|Xiaomi|Huawei|Redmi|OPPO|Vivo|OnePlus|Pixel|iPad|Galaxy\\s*Tab)/i;\n        \n        // Standard clothing/shoe size pattern\n        const clothingSizePattern = /^(XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL|5XL|6XL|One Size|Free Size)$/i;\n        const shoeSizePattern = /^(EU\\s*\\d+|US\\s*\\d+|\\d{2,3}(?:cm)?)$/i;\n        \n        // Helper function to check if a string is a known color (use non-global regex to avoid lastIndex issues)\n        const isColor = (s: string): boolean => {\n          const lower = s.toLowerCase().trim();\n          if (colorSet.has(lower)) return true;\n          // Use non-global regex for test() to avoid lastIndex state issues\n          const colorTestPattern = /\\b(Black|White|Red|Blue|Green|Yellow|Pink|Purple|Orange|Brown|Grey|Gray|Beige|Navy|Khaki|Apricot|Wine|Coffee|Camel|Cream|Rose|Gold|Silver|Ivory|Mint|Coral|Burgundy|Maroon|Olive|Teal|Turquoise|Lavender|Lilac|Peach|Tan|Charcoal|Sky Blue|Dark Blue|Light Blue|Light Green|Dark Green|Light Pink|Dark Pink|Off White|Nude|Violet|Dark Grey|Light Grey)\\b/i;\n          return colorTestPattern.test(s);\n        };\n        \n        // Helper function to check if a string is a device model (use non-global regex)\n        const isDeviceModel = (s: string): boolean => {\n          const deviceTestPattern = /\\b(iPhone\\s*\\d+\\s*(?:Pro|Plus|Max|mini|SE)?(?:\\s*Max)?|Samsung\\s*(?:S|A|Note|Galaxy)\\s*\\d+(?:\\s*(?:Plus|Ultra|FE))?|Xiaomi|Huawei|Redmi|OPPO|Vivo|OnePlus|Pixel|iPad|Galaxy\\s*Tab)/i;\n          return deviceTestPattern.test(s);\n        };\n        \n        // Helper function to check if a string is a clothing/shoe size\n        const isClothingSize = (s: string): boolean => {\n          return clothingSizePattern.test(s.trim()) || shoeSizePattern.test(s.trim());\n        };\n        \n        // Helper to parse a combined value like \"Violet-iPhone 11Pro Max\"\n        const parseVariantValue = (value: string) => {\n          if (!value) return;\n          \n          // Clean Chinese characters\n          let cleanVal = value.replace(/[\\u4e00-\\u9fff]/g, '').trim();\n          if (!cleanVal || cleanVal.length > 60) return;\n          \n          // Try to split on common delimiters\n          const delimiters = ['-', '/', '|', '_'];\n          let parts: string[] = [cleanVal];\n          \n          for (const delim of delimiters) {\n            if (cleanVal.includes(delim)) {\n              // Split and check if first part looks like a color\n              const splitParts = cleanVal.split(delim).map(p => p.trim()).filter(Boolean);\n              if (splitParts.length >= 2 && isColor(splitParts[0])) {\n                parts = splitParts;\n                break;\n              }\n            }\n          }\n          \n          if (parts.length >= 2 && isColor(parts[0])) {\n            // First part is color, rest is model/size\n            colors.add(parts[0].charAt(0).toUpperCase() + parts[0].slice(1).toLowerCase());\n            const remainder = parts.slice(1).join(' ').trim();\n            if (remainder) {\n              if (isDeviceModel(remainder)) {\n                models.add(remainder);\n              } else if (isClothingSize(remainder)) {\n                sizes.add(remainder.toUpperCase());\n              } else {\n                // Could be a model or size - check further\n                if (/iPhone|Samsung|Xiaomi|Huawei|Redmi|OPPO|Vivo|OnePlus|Pixel|iPad|Galaxy/i.test(remainder)) {\n                  models.add(remainder);\n                } else {\n                  sizes.add(remainder);\n                }\n              }\n            }\n          } else if (parts.length === 1) {\n            // Single value - classify it\n            const val = parts[0];\n            if (isColor(val)) {\n              colors.add(val.charAt(0).toUpperCase() + val.slice(1).toLowerCase());\n            } else if (isDeviceModel(val)) {\n              models.add(val);\n            } else if (isClothingSize(val)) {\n              sizes.add(val.toUpperCase());\n            } else {\n              // Unknown - check if it looks like a device\n              if (/iPhone|Samsung|Xiaomi|Huawei|Redmi|OPPO|Vivo|OnePlus|Pixel|iPad|Galaxy/i.test(val)) {\n                models.add(val);\n              } else {\n                sizes.add(val);\n              }\n            }\n          }\n        };\n        \n        for (const v of variants) {\n          // 1. First try explicit fields (most reliable)\n          const explicitSize = v.size || v.sizeNameEn || v.sizeName;\n          const explicitColor = v.color || v.colour || v.colorNameEn || v.colorName;\n          const explicitModel = v.model || v.modelNameEn || v.modelName;\n          \n          if (explicitColor) {\n            const cleanColor = String(explicitColor).replace(/[\\u4e00-\\u9fff]/g, '').trim();\n            if (cleanColor && cleanColor.length > 0 && cleanColor.length < 50 && /[a-zA-Z]/.test(cleanColor)) {\n              colors.add(cleanColor);\n            }\n          }\n          \n          if (explicitSize) {\n            const cleanSize = String(explicitSize).replace(/[\\u4e00-\\u9fff]/g, '').trim();\n            if (cleanSize && cleanSize.length > 0 && cleanSize.length < 50) {\n              if (isDeviceModel(cleanSize)) {\n                models.add(cleanSize);\n              } else {\n                sizes.add(cleanSize);\n              }\n            }\n          }\n          \n          if (explicitModel) {\n            const cleanModel = String(explicitModel).replace(/[\\u4e00-\\u9fff]/g, '').trim();\n            if (cleanModel && cleanModel.length > 0 && cleanModel.length < 50) {\n              models.add(cleanModel);\n            }\n          }\n          \n          // 2. Check variant properties (structured data)\n          const vProps = v.variantPropertyList || v.propertyList || v.properties || [];\n          if (Array.isArray(vProps)) {\n            for (const p of vProps) {\n              const propName = String(p.propertyNameEn || p.propertyName || p.name || '').toLowerCase();\n              const propValue = String(p.propertyValueNameEn || p.propertyValueName || p.value || p.name || '').trim();\n              if (propValue && propValue.length > 0 && propValue.length < 50) {\n                const cleanValue = propValue.replace(/[\\u4e00-\\u9fff]/g, '').trim();\n                if (!cleanValue) continue;\n                \n                if (propName.includes('color') || propName.includes('colour')) {\n                  if (/[a-zA-Z]/.test(cleanValue)) {\n                    colors.add(cleanValue);\n                  }\n                } else if (propName.includes('model') || propName.includes('device') || propName.includes('phone')) {\n                  models.add(cleanValue);\n                } else if (propName.includes('size') || propName.includes('type') || propName.includes('version')) {\n                  if (isDeviceModel(cleanValue)) {\n                    models.add(cleanValue);\n                  } else {\n                    sizes.add(cleanValue);\n                  }\n                }\n              }\n            }\n          }\n          \n          // 3. Parse variantKey (may contain combined color-model like \"Violet-iPhone 11Pro\")\n          if (v.variantKey) {\n            parseVariantValue(String(v.variantKey));\n          }\n          \n          // 4. Parse variantNameEn as fallback\n          if (v.variantNameEn) {\n            parseVariantValue(String(v.variantNameEn));\n          }\n        }\n        \n        // Sanitize values - strip any HTML/script tags\n        const stripHtml = (s: string) => s.replace(/<[^>]*>/g, '').replace(/&[a-z]+;/gi, ' ').trim();\n        const safeColors = [...colors].map(stripHtml).filter(c => c.length > 0 && c.length < 50);\n        const safeSizes = [...sizes].map(stripHtml).filter(s => s.length > 0 && s.length < 50);\n        const safeModels = [...models].map(stripHtml).filter(m => m.length > 0 && m.length < 50);\n        \n        // Only add to specs if not already present (avoid duplicates)\n        const baseSpecsLower = (baseSpecs || '').toLowerCase();\n        if (safeColors.length > 0 && !baseSpecsLower.includes('colors:')) {\n          allSpecs.push(`Colors: ${safeColors.slice(0, 15).join(', ')}`);\n        }\n        if (safeModels.length > 0) {\n          allSpecs.push(`Compatible Devices: ${safeModels.slice(0, 25).join(', ')}`);\n        }\n        if (safeSizes.length > 0 && !baseSpecsLower.includes('sizes:')) {\n          allSpecs.push(`Sizes: ${safeSizes.slice(0, 15).join(', ')}`);\n        }\n        \n        console.log(`[Search&Price] Product ${pid}: ${safeColors.length} colors, ${safeSizes.length} sizes, ${safeModels.length} models from ${variants.length} variants`);\n        \n        // Store for later use\n        extractedSizes = safeSizes;\n        extractedColors = safeColors;\n        extractedModels = safeModels;\n      }\n      \n      // Combine all specs into finalProductInfo\n      // Note: productInfo should contain variant specs (colors, sizes) while Overview has basic product specs\n      // This prevents duplication between the two sections\n      let finalProductInfo: string | undefined = allSpecs.length > 0 ? allSpecs.join('<br/>') : undefined;\n      \n      // Don't add duplicate fallback here - Overview already shows Category, Material, Weight etc.\n      // productInfo is specifically for variant/specification details not shown in Overview\n      \n      // Use variant images if we have them, otherwise keep original images\n      if (variantImages.length > 1) {\n        images = variantImages.slice(0, 50);\n      } else if (variantImages.length === 1) {\n        // Only main image found from variants - combine with original images but limit\n        const combinedImages = [...variantImages];\n        for (const img of images) {\n          if (!seenUrls.has(img)) {\n            seenUrls.add(img);\n            combinedImages.push(img);\n          }\n        }\n        images = combinedImages.slice(0, 50);\n      }\n      // else keep original images as fallback\n      \n      const pricedVariants: PricedVariant[] = [];\n      \n      \n      if (variants.length === 0) {\n        // Single variant product - try to get exact shipping using product-level vid\n        const sellPrice = Number(item.sellPrice || item.price || 0);\n        const costSAR = usdToSar(sellPrice);\n        \n        // For single-variant products, use pid or product-level vid\n        const variantVid = String(item.vid || item.variants?.[0]?.vid || pid || '');\n        \n        let shippingPriceUSD = 0;\n        let shippingPriceSAR = 0;\n        let shippingAvailable = false;\n        let deliveryDays = 'Unknown';\n        let logisticName: string | undefined;\n        let shippingError: string | undefined;\n        \n        if (variantVid) {\n          // Add delay to respect rate limit (1 req/sec) - use 1200ms for safety margin\n          await new Promise(resolve => setTimeout(resolve, 1200));\n          \n          try {\n            const freight = await freightCalculate({\n              countryCode: 'US',\n              vid: variantVid,\n              quantity: 1,\n            });\n            \n            if (!freight.ok) {\n              shippingError = freight.message;\n              // Check for rate limit error (code 1600200)\n              if (freight.message.includes('1600200') || freight.message.includes('Too Many Requests')) {\n                consecutiveRateLimitErrors++;\n                console.log(`[Search&Price] Rate limit error #${consecutiveRateLimitErrors}: ${freight.message}`);\n              }\n            } else if (freight.options.length > 0) {\n              consecutiveRateLimitErrors = 0; // Reset on success\n              const cjPacketOrdinary = findCJPacketOrdinary(freight.options);\n              if (cjPacketOrdinary) {\n                shippingPriceUSD = cjPacketOrdinary.price;\n                shippingPriceSAR = usdToSar(shippingPriceUSD);\n                shippingAvailable = true;\n                logisticName = cjPacketOrdinary.name;\n                if (cjPacketOrdinary.logisticAgingDays) {\n                  const { min, max } = cjPacketOrdinary.logisticAgingDays;\n                  deliveryDays = max ? `${min}-${max} days` : `${min} days`;\n                }\n              } else {\n                shippingError = 'CJPacket Ordinary not available';\n              }\n            } else {\n              shippingError = 'No shipping options to USA';\n            }\n          } catch (e: any) {\n            shippingError = e?.message || 'Shipping failed';\n            if (shippingError && (shippingError.includes('429') || shippingError.includes('Too Many'))) {\n              consecutiveRateLimitErrors++;\n            }\n          }\n        } else {\n          shippingError = 'No variant ID available';\n        }\n        \n        if (shippingAvailable) {\n          const totalCostSAR = costSAR + shippingPriceSAR;\n          const sellPriceSAR = calculateSellPriceWithMargin(totalCostSAR, profitMargin);\n          const profitSAR = sellPriceSAR - totalCostSAR;\n          \n          // Get variant stock from the inventory map using multiple key fallbacks\n          // Single-variant product: try productSku, pid, or first available stock entry (aggregate if multiple rows)\n          let variantStock = getVariantStock({\n            vid: pid,\n            sku: item.productSku,\n          });\n          if (!variantStock && variantStockMap.size > 0) {\n            // For single-variant products with multiple inventory rows (e.g., different warehouses),\n            // aggregate all entries to get the total stock\n            const allStocks = Array.from(variantStockMap.values());\n            variantStock = {\n              cjStock: allStocks.reduce((sum, s) => sum + s.cjStock, 0),\n              factoryStock: allStocks.reduce((sum, s) => sum + s.factoryStock, 0),\n              totalStock: allStocks.reduce((sum, s) => sum + s.totalStock, 0),\n            };\n          }\n          // FALLBACK: For single-variant products, use product-level inventory if per-variant lookup failed\n          // This ensures we don't show 0/0 when product-level data is available\n          if (!variantStock && realInventory) {\n            console.log(`[Search&Price] Product ${pid}: Using product-level inventory for single variant`);\n            variantStock = {\n              cjStock: realInventory.totalCJ,\n              factoryStock: realInventory.totalFactory,\n              totalStock: realInventory.totalAvailable,\n            };\n          }\n          \n          pricedVariants.push({\n            variantId: pid,\n            variantSku: item.productSku || pid,\n            variantPriceUSD: sellPrice,\n            shippingAvailable,\n            shippingPriceUSD,\n            shippingPriceSAR,\n            deliveryDays,\n            logisticName,\n            sellPriceSAR,\n            totalCostSAR,\n            profitSAR,\n            error: shippingError,\n            stock: variantStock?.totalStock,\n            cjStock: variantStock?.cjStock,\n            factoryStock: variantStock?.factoryStock,\n          });\n        }\n        \n        // Stop processing if we hit 3+ consecutive rate limit errors (likely real quota issue)\n        if (consecutiveRateLimitErrors >= 3) {\n          console.log(`[Search&Price] Stopping after ${consecutiveRateLimitErrors} consecutive rate limit errors`);\n          break;\n        }\n      } else {\n        // Multi-variant product - check heaviest variants first to find HIGHEST shipping cost\n        // This ensures we match CJ's \"According to Shipping Method\" which uses the heaviest variant\n        const MAX_VARIANTS_TO_CHECK = 2; // Only check 2 variants (heaviest first) to stay within timeout\n        \n        // Sort variants by weight (descending) to check heaviest first\n        // CJ shipping cost is primarily driven by weight, so heaviest = highest shipping\n        const sortedVariants = [...variants].sort((a, b) => {\n          const weightA = Number(a.packWeight || a.variantWeight || a.weight || 0);\n          const weightB = Number(b.packWeight || b.variantWeight || b.weight || 0);\n          return weightB - weightA; // Descending (heaviest first)\n        });\n        \n        // Collect all valid shipping quotes, then pick the highest\n        const variantShippingQuotes: Array<{\n          variantIndex: number;\n          variant: any;\n          shippingPriceUSD: number;\n          shippingPriceSAR: number;\n          deliveryDays: string;\n          logisticName: string;\n        }> = [];\n        \n        for (let i = 0; i < Math.min(sortedVariants.length, MAX_VARIANTS_TO_CHECK); i++) {\n          // Stop checking if we hit rate limit or time budget exceeded\n          if (consecutiveRateLimitErrors >= 3) break;\n          if (Date.now() - startTime > 50000) {\n            console.log(`[Search&Price] Time budget exceeded (50s), stopping variant checks`);\n            break;\n          }\n          \n          const variant = sortedVariants[i];\n          const variantId = String(variant.vid || variant.variantId || variant.id || '');\n          const variantSku = String(variant.variantSku || variant.sku || variantId);\n          const variantPriceUSD = Number(variant.variantSellPrice || variant.sellPrice || variant.price || 0);\n          const costSAR = usdToSar(variantPriceUSD);\n          \n          const variantName = String(variant.variantNameEn || variant.variantName || '').replace(/[\\u4e00-\\u9fff]/g, '').trim() || undefined;\n          const variantImage = variant.variantImage || variant.whiteImage || variant.image || undefined;\n          const size = variant.size || variant.sizeNameEn || undefined;\n          const color = variant.color || variant.colorNameEn || undefined;\n          \n          let shippingPriceUSD = 0;\n          let shippingPriceSAR = 0;\n          let shippingAvailable = false;\n          let deliveryDays = 'Unknown';\n          let logisticName: string | undefined;\n          let shippingError: string | undefined;\n          \n          if (variantId) {\n            // Add delay to respect rate limit (1 req/sec) - use 1200ms for safety margin\n            await new Promise(resolve => setTimeout(resolve, 1200));\n            \n            try {\n              const freight = await freightCalculate({\n                countryCode: 'US',\n                vid: variantId,\n                quantity: 1,\n              });\n              \n              if (!freight.ok) {\n                shippingError = freight.message;\n                shippingErrors[shippingError] = (shippingErrors[shippingError] || 0) + 1;\n                // Check for rate limit error\n                if (freight.message.includes('1600200') || freight.message.includes('Too Many Requests')) {\n                  consecutiveRateLimitErrors++;\n                  console.log(`[Search&Price] Rate limit error #${consecutiveRateLimitErrors}: ${freight.message}`);\n                }\n              } else if (freight.options.length > 0) {\n                consecutiveRateLimitErrors = 0; // Reset on success\n                const cjPacketOrdinary = findCJPacketOrdinary(freight.options);\n                if (cjPacketOrdinary) {\n                  shippingPriceUSD = cjPacketOrdinary.price;\n                  shippingPriceSAR = usdToSar(shippingPriceUSD);\n                  shippingAvailable = true;\n                  logisticName = cjPacketOrdinary.name;\n                  if (cjPacketOrdinary.logisticAgingDays) {\n                    const { min, max } = cjPacketOrdinary.logisticAgingDays;\n                    deliveryDays = max ? `${min}-${max} days` : `${min} days`;\n                  }\n                } else {\n                  shippingError = 'CJPacket Ordinary not available';\n                  shippingErrors[shippingError] = (shippingErrors[shippingError] || 0) + 1;\n                }\n              } else {\n                shippingError = 'No shipping options to USA';\n                shippingErrors[shippingError] = (shippingErrors[shippingError] || 0) + 1;\n              }\n            } catch (e: any) {\n              shippingError = e?.message || 'Shipping failed';\n              if (shippingError) {\n                shippingErrors[shippingError] = (shippingErrors[shippingError] || 0) + 1;\n                if (shippingError.includes('429') || shippingError.includes('Too Many')) {\n                  consecutiveRateLimitErrors++;\n                }\n              }\n            }\n          }\n          \n          // Stop checking variants if we hit too many consecutive rate limit errors\n          if (consecutiveRateLimitErrors >= 3) {\n            console.log(`[Search&Price] Stopping variant check after ${consecutiveRateLimitErrors} consecutive rate limit errors`);\n            break;\n          }\n          \n          if (shippingAvailable && logisticName) {\n            // Collect this quote - we'll pick the highest later\n            variantShippingQuotes.push({\n              variantIndex: i,\n              variant,\n              shippingPriceUSD,\n              shippingPriceSAR,\n              deliveryDays,\n              logisticName,\n            });\n            console.log(`[Search&Price] Product ${pid} variant ${i+1}: CJPacket Ordinary $${shippingPriceUSD.toFixed(2)}`);\n          } else {\n            console.log(`[Search&Price] Product ${pid} variant ${i+1}: ${shippingError}`);\n          }\n        }\n        \n        // Now pick the variant with the HIGHEST shipping cost (matches CJ's heaviest variant logic)\n        if (variantShippingQuotes.length > 0) {\n          // Sort by shipping price descending and take the highest\n          variantShippingQuotes.sort((a, b) => b.shippingPriceUSD - a.shippingPriceUSD);\n          const highest = variantShippingQuotes[0];\n          const variant = highest.variant;\n          \n          console.log(`[Search&Price] Product ${pid}: Using HIGHEST shipping $${highest.shippingPriceUSD.toFixed(2)} from variant ${highest.variantIndex + 1} of ${variantShippingQuotes.length} checked`);\n          \n          const variantId = String(variant.vid || variant.variantId || variant.id || '');\n          const variantSku = String(variant.variantSku || variant.sku || variantId);\n          const variantPriceUSD = Number(variant.variantSellPrice || variant.sellPrice || variant.price || 0);\n          const costSAR = usdToSar(variantPriceUSD);\n          const variantName = String(variant.variantNameEn || variant.variantName || '').replace(/[\\u4e00-\\u9fff]/g, '').trim() || undefined;\n          const variantImage = variant.variantImage || variant.whiteImage || variant.image || undefined;\n          \n          // Extract color and size - first try explicit fields, then parse from variantKey\n          let size = variant.size || variant.sizeNameEn || undefined;\n          let color = variant.color || variant.colorNameEn || undefined;\n          const variantKeyRaw = String(variant.variantKey || variant.variantNameEn || variantName || '');\n          \n          // If color/size not explicitly provided, parse from variantKey (format: \"Color-Size\" or \"Model-Size\")\n          if ((!color || !size) && variantKeyRaw.includes('-')) {\n            const parts = variantKeyRaw.split('-');\n            if (parts.length >= 2) {\n              // Last part is usually size (L, XL, XXL, M, S, etc.)\n              const lastPart = parts[parts.length - 1].trim();\n              const firstPart = parts.slice(0, -1).join('-').trim();\n              \n              // Check if last part looks like a size\n              const sizePattern = /^(XS|S|M|L|XL|XXL|XXXL|2XL|3XL|4XL|5XL|6XL|One Size|Free Size|\\d{2,3})$/i;\n              if (sizePattern.test(lastPart)) {\n                if (!size) size = lastPart;\n                if (!color) color = firstPart;\n              } else {\n                // Fallback: use whole variantKey as display name\n                if (!color) color = variantKeyRaw;\n              }\n            }\n          }\n          \n          // If still no values, use variantKey as display name\n          if (!color && !size && variantKeyRaw) {\n            color = variantKeyRaw;\n          }\n          \n          const totalCostSAR = costSAR + highest.shippingPriceSAR;\n          const sellPriceSAR = calculateSellPriceWithMargin(totalCostSAR, profitMargin);\n          const profitSAR = sellPriceSAR - totalCostSAR;\n          \n          // Get variant stock from the inventory map using multiple key fallbacks\n          const variantKey = String(variant.variantKey || '');\n          const variantStock = getVariantStock({\n            vid: variantId,\n            variantId: variantId,\n            sku: variantSku,\n            variantKey: variantKey,\n            variantName: variantName,\n          });\n          \n          pricedVariants.push({\n            variantId,\n            variantSku,\n            variantPriceUSD,\n            shippingAvailable: true,\n            shippingPriceUSD: highest.shippingPriceUSD,\n            shippingPriceSAR: highest.shippingPriceSAR,\n            deliveryDays: highest.deliveryDays,\n            logisticName: highest.logisticName,\n            sellPriceSAR,\n            totalCostSAR,\n            profitSAR,\n            variantName,\n            variantImage,\n            size,\n            color,\n            stock: variantStock?.totalStock,\n            cjStock: variantStock?.cjStock,\n            factoryStock: variantStock?.factoryStock,\n          });\n        }\n      }\n      \n      // Stop processing more products if we hit too many consecutive rate limit errors\n      if (consecutiveRateLimitErrors >= 3) {\n        console.log(`[Search&Price] Stopping product processing after ${consecutiveRateLimitErrors} consecutive rate limit errors`);\n        break;\n      }\n      \n      if (pricedVariants.length === 0) {\n        console.log(`[Search&Price] SKIPPING product ${pid} - no CJPacket Ordinary shipping`);\n        skippedNoShipping++;\n        continue;\n      }\n      \n      const successfulVariants = pricedVariants.filter(v => v.shippingAvailable).length;\n      const prices = pricedVariants.map(v => v.sellPriceSAR);\n      const minPriceSAR = Math.min(...prices);\n      const maxPriceSAR = Math.max(...prices);\n      const avgPriceSAR = Math.round(prices.reduce((a, b) => a + b, 0) / prices.length);\n      \n      // Extract processing/delivery time estimates from CJ data\n      const deliveryCycle = source.deliveryCycle;\n      const processDay = source.processDay || source.processingTime || source.processTime || source.prepareDay;\n      \n      // Helper to parse time values (can be \"3\", \"2-7\", \"3-7 days\", etc.)\n      const parseTimeValue = (val: any): { display: string | undefined; hours: number | undefined } => {\n        if (!val) return { display: undefined, hours: undefined };\n        const strVal = String(val).trim();\n        if (!strVal) return { display: undefined, hours: undefined };\n        \n        // Check if already has time units\n        const hasUnits = /day|hour|week/i.test(strVal);\n        const display = hasUnits ? strVal : `${strVal} days`;\n        \n        // Extract first number for hours calculation (if pure number or range start)\n        const numMatch = strVal.match(/^(\\d+)/);\n        const hours = numMatch ? Number(numMatch[1]) * 24 : undefined;\n        \n        return { display, hours: (hours && !isNaN(hours)) ? hours : undefined };\n      };\n      \n      const processingParsed = parseTimeValue(processDay);\n      const deliveryParsed = parseTimeValue(deliveryCycle);\n      \n      const estimatedProcessingDays = processingParsed.display;\n      const estimatedDeliveryDays = deliveryParsed.display;\n      const processingTimeHours = processingParsed.hours;\n      const deliveryTimeHours = deliveryParsed.hours;\n      \n      // Extract origin country and HS code\n      const originCountry = String(source.originCountry || source.countryOrigin || source.originArea || '').trim() || undefined;\n      const hsCode = source.entryCode ? `${source.entryCode}${source.entryNameEn ? ` (${source.entryNameEn})` : ''}` : undefined;\n      \n      // Extract video URL if available\n      const videoUrl = String(source.videoUrl || source.video || source.productVideo || '').trim() || undefined;\n      \n      pricedProducts.push({\n        pid,\n        cjSku,\n        name,\n        images,\n        minPriceSAR,\n        maxPriceSAR,\n        avgPriceSAR,\n        stock,\n        listedNum,\n        // Inventory breakdown from CJ's dedicated inventory API (most accurate)\n        totalVerifiedInventory: totalVerifiedInventory > 0 ? totalVerifiedInventory : undefined,\n        totalUnVerifiedInventory: totalUnVerifiedInventory > 0 ? totalUnVerifiedInventory : undefined,\n        // Full warehouse inventory object (for detailed display on Page 4)\n        inventory: realInventory ? {\n          totalCJ: realInventory.totalCJ,\n          totalFactory: realInventory.totalFactory,\n          totalAvailable: realInventory.totalAvailable,\n          warehouses: realInventory.warehouses,\n        } : undefined,\n        // Inventory fetch status for UI feedback\n        inventoryStatus,\n        inventoryErrorMessage: inventoryErrorMessage || undefined,\n        variants: pricedVariants,\n        // ALL variant inventory data for Page 4 blue box display\n        inventoryVariants: inventoryVariants.length > 0 ? inventoryVariants : undefined,\n        successfulVariants,\n        totalVariants: pricedVariants.length,\n        description,\n        overview,\n        productInfo: finalProductInfo,\n        sizeInfo,\n        productNote,\n        packingList,\n        rating,\n        reviewCount,\n        categoryName,\n        productWeight,\n        packLength,\n        packWidth,\n        packHeight,\n        material,\n        productType,\n        sizeChartImages: sizeChartImages.length > 0 ? sizeChartImages : undefined,\n        processingTimeHours,\n        deliveryTimeHours,\n        estimatedProcessingDays,\n        estimatedDeliveryDays,\n        originCountry,\n        hsCode,\n        videoUrl,\n        availableSizes: extractedSizes,\n        availableColors: extractedColors,\n        availableModels: extractedModels,\n      });\n    }\n    \n    // Apply post-hydration filters (sizes)\n    let filteredProducts = pricedProducts;\n    let filteredBySizes = 0;\n    \n    // Filter by requested sizes\n    if (requestedSizes.length > 0) {\n      const beforeCount = filteredProducts.length;\n      filteredProducts = filteredProducts.filter(p => {\n        const productSizes = (p as any).availableSizes || [];\n        // Products without sizes (e.g., electronics) pass through\n        if (productSizes.length === 0) return true;\n        // Check if any requested size matches product sizes\n        const normalizedProductSizes = productSizes.map((s: string) => s.toUpperCase());\n        return requestedSizes.some(rs => normalizedProductSizes.includes(rs));\n      });\n      filteredBySizes = beforeCount - filteredProducts.length;\n      console.log(`[Search&Price] Filtered ${filteredBySizes} products not matching sizes: ${requestedSizes.join(',')}`);\n    }\n    \n    // NOTE: Inventory is now fetched DURING product processing loop via getInventoryByPid\n    // This ensures each product has inventory data before being pushed to pricedProducts\n    \n    const duration = Date.now() - startTime;\n    console.log(`[Search&Price] Complete: ${filteredProducts.length} products returned (${pricedProducts.length} priced, ${skippedNoShipping} skipped no shipping, ${filteredBySizes} filtered by size) in ${duration}ms`);\n    console.log(`[Search&Price] Shipping error breakdown:`, shippingErrors);\n    \n    // Check if we hit rate limit issues during processing\n    const hitRateLimit = consecutiveRateLimitErrors >= 3;\n    if (hitRateLimit && filteredProducts.length === 0) {\n      // No products with exact pricing due to rate limits - return error response\n      console.log(`[Search&Price] Rate limit hit (${consecutiveRateLimitErrors} consecutive errors) and no products priced - returning error`);\n      const r = NextResponse.json({\n        ok: false,\n        error: 'CJ API rate limit reached. Please wait a minute and try again with fewer products.',\n        quotaExhausted: true,\n        products: [],\n        count: 0,\n        duration,\n        debug: {\n          candidatesFound: candidateProducts.length,\n          productsProcessed: productsToPrice.length,\n          pricedSuccessfully: 0,\n          skippedNoShipping,\n          shippingErrors,\n          consecutiveRateLimitErrors,\n        }\n      }, { status: 429, headers: { 'Cache-Control': 'no-store' } });\n      r.headers.set('x-request-id', log.requestId);\n      return r;\n    }\n    \n    const r = NextResponse.json({\n      ok: true,\n      products: filteredProducts,\n      count: filteredProducts.length,\n      duration,\n      quotaExhausted: hitRateLimit, // Flag if rate limit was hit during processing\n      debug: {\n        candidatesFound: candidateProducts.length,\n        productsProcessed: productsToPrice.length,\n        pricedSuccessfully: pricedProducts.length,\n        skippedNoShipping,\n        filteredBySizes,\n        shippingErrors,\n      }\n    }, { headers: { 'Cache-Control': 'no-store' } });\n    r.headers.set('x-request-id', log.requestId);\n    return r;\n    \n  } catch (e: any) {\n    console.error('[Search&Price] Error:', e?.message, e?.stack);\n    const r = NextResponse.json(\n      { ok: false, error: e?.message || 'Search and price failed' }, \n      { status: 500, headers: { 'Cache-Control': 'no-store' } }\n    );\n    r.headers.set('x-request-id', loggerForRequest(req).requestId);\n    return r;\n  }\n}\n","path":null,"size_bytes":96637,"size_tokens":null},"src/app/api/admin/cj/test-variant/route.ts":{"content":"import { NextRequest, NextResponse } from 'next/server';\nimport { getAccessToken } from '@/lib/cj/v2';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\n\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\n\nconst CJ_BASE = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n\nexport async function GET(req: NextRequest) {\n  const auth = await ensureAdmin();\n  if (!auth.ok) {\n    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n  }\n\n  const pid = req.nextUrl.searchParams.get('pid');\n  \n  if (!pid) {\n    return NextResponse.json({ error: 'Missing pid parameter' }, { status: 400 });\n  }\n\n  try {\n    const token = await getAccessToken();\n    if (!token) {\n      return NextResponse.json({ error: 'Failed to get CJ access token' }, { status: 500 });\n    }\n\n    // Use /product/query instead of /product/variant/query\n    // /variant/query ONLY works for \"My Products\", /product/query works for ALL products\n    const url = `${CJ_BASE}/product/query?pid=${encodeURIComponent(pid)}`;\n    \n    console.log(`[Test Variant] Fetching variants for pid=${pid}`);\n    console.log(`[Test Variant] URL: ${url}`);\n    \n    const res = await fetch(url, {\n      method: 'GET',\n      headers: {\n        'Content-Type': 'application/json',\n        'CJ-Access-Token': token,\n      },\n      cache: 'no-store',\n    });\n    \n    const response = await res.json();\n    \n    console.log(`[Test Variant] Response:`, JSON.stringify(response, null, 2));\n    \n    // Extract variants from product/query response\n    const productData = response?.data;\n    let variants: any[] = [];\n    \n    if (productData) {\n      if (Array.isArray(productData.variants)) {\n        variants = productData.variants;\n      } else if (Array.isArray(productData.variantList)) {\n        variants = productData.variantList;\n      } else if (Array.isArray(productData.skuList)) {\n        variants = productData.skuList;\n      }\n    }\n    \n    return NextResponse.json({\n      pid,\n      url,\n      response,\n      analysis: {\n        code: response?.code,\n        result: response?.result,\n        message: response?.message,\n        productDataKeys: productData ? Object.keys(productData) : [],\n        variantsFound: variants.length,\n        firstVariant: variants[0] ? {\n          vid: variants[0].vid,\n          variantId: variants[0].variantId,\n          variantSku: variants[0].variantSku,\n          variantSellPrice: variants[0].variantSellPrice,\n          allKeys: Object.keys(variants[0]),\n        } : null,\n        productLevelVid: productData?.vid || productData?.variantId || productData?.defaultVid || null,\n      },\n    });\n  } catch (err: any) {\n    console.error(`[Test Variant] Error:`, err);\n    return NextResponse.json({ \n      error: err?.message,\n      stack: err?.stack \n    }, { status: 500 });\n  }\n}\n","path":null,"size_bytes":2850,"size_tokens":null},"src/app/api/admin/cj/test-search/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getAccessToken } from '@/lib/cj/v2';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: Request) {\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json({ ok: false, error: guard.reason }, { status: 401 });\n    }\n\n    const { searchParams } = new URL(req.url);\n    const categoryId = searchParams.get('categoryId') || '';\n    const pageNum = Number(searchParams.get('pageNum') || 1);\n\n    console.log('[TestSearch] Getting access token...');\n    const token = await getAccessToken();\n    if (!token) {\n      return NextResponse.json({ ok: false, error: 'Failed to get access token' });\n    }\n    console.log('[TestSearch] Got token:', token.slice(0, 20) + '...');\n\n    const base = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n    \n    const params = new URLSearchParams();\n    params.set('pageNum', String(pageNum));\n    if (categoryId) {\n      params.set('categoryId', categoryId);\n    }\n    \n    const url = `${base}/product/list?${params}`;\n    console.log('[TestSearch] Calling URL:', url);\n\n    const response = await fetch(url, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n    });\n\n    const data = await response.json();\n    console.log('[TestSearch] Response code:', data.code, 'result:', data.result);\n    console.log('[TestSearch] Message:', data.message);\n    \n    if (data.data) {\n      console.log('[TestSearch] Total products:', data.data.total);\n      console.log('[TestSearch] Page size:', data.data.pageSize);\n      console.log('[TestSearch] List length:', data.data.list?.length);\n      \n      if (data.data.list && data.data.list.length > 0) {\n        const sample = data.data.list[0];\n        console.log('[TestSearch] Sample product:', {\n          pid: sample.pid,\n          name: sample.productNameEn?.slice(0, 50),\n          price: sample.sellPrice,\n          stock: sample.stock,\n          categoryId: sample.categoryId,\n          categoryName: sample.categoryName,\n          listedNum: sample.listedNum,\n        });\n      }\n    }\n\n    return NextResponse.json({\n      ok: true,\n      requestUrl: url,\n      apiResponse: {\n        code: data.code,\n        result: data.result,\n        message: data.message,\n        total: data.data?.total,\n        pageSize: data.data?.pageSize,\n        listLength: data.data?.list?.length,\n        sampleProducts: data.data?.list?.slice(0, 3).map((p: any) => ({\n          pid: p.pid,\n          name: p.productNameEn,\n          price: p.sellPrice,\n          stock: p.stock,\n          categoryId: p.categoryId,\n          categoryName: p.categoryName,\n          listedNum: p.listedNum,\n        })),\n      },\n    });\n  } catch (e: any) {\n    console.error('[TestSearch] Error:', e?.message, e?.stack);\n    return NextResponse.json({ ok: false, error: e?.message });\n  }\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"src/app/api/test/cj-products/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { getAccessToken } from '@/lib/cj/v2';\nimport { fetchJson } from '@/lib/http';\n\nexport const dynamic = 'force-dynamic';\n\nexport async function GET(req: Request) {\n  const { searchParams } = new URL(req.url);\n  const categoryId = searchParams.get('categoryId') || '';\n  const pageNum = searchParams.get('page') || '1';\n  \n  try {\n    const token = await getAccessToken();\n    if (!token) {\n      return NextResponse.json({ ok: false, error: 'Failed to get CJ access token' });\n    }\n    \n    const base = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n    \n    const params = new URLSearchParams();\n    params.set('pageNum', pageNum);\n    params.set('pageSize', '20');\n    \n    if (categoryId && categoryId !== 'all' && !categoryId.startsWith('first-') && !categoryId.startsWith('second-')) {\n      params.set('categoryId', categoryId);\n    }\n    \n    const url = `${base}/product/list?${params}`;\n    console.log('[TEST] Fetching:', url);\n    \n    const res = await fetchJson<any>(url, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 30000,\n    });\n    \n    console.log('[TEST] Response code:', res?.code, 'result:', res?.result);\n    console.log('[TEST] Data keys:', res?.data ? Object.keys(res.data) : 'no data');\n    \n    const list = res?.data?.list || [];\n    const total = res?.data?.total || 0;\n    \n    console.log('[TEST] List length:', list.length, 'Total:', total);\n    \n    if (list.length > 0) {\n      console.log('[TEST] Full first product keys:', Object.keys(list[0]));\n      console.log('[TEST] Full first product:', JSON.stringify(list[0]).slice(0, 2000));\n    }\n    \n    return NextResponse.json({\n      ok: true,\n      categoryIdUsed: categoryId || 'all',\n      total,\n      count: list.length,\n      fullProductKeys: list.length > 0 ? Object.keys(list[0]) : [],\n      fullFirstProduct: list.length > 0 ? list[0] : null,\n      sample: list.slice(0, 5).map((p: any) => ({\n        pid: p.pid,\n        name: p.productNameEn?.slice(0, 60),\n        price: p.sellPrice,\n        stock: p.stock,\n        listedNum: p.listedNum,\n        categoryId: p.categoryId,\n      })),\n      rawResponse: {\n        code: res?.code,\n        result: res?.result,\n        message: res?.message,\n      }\n    });\n  } catch (e: any) {\n    console.error('[TEST] Error:', e?.message);\n    return NextResponse.json({ ok: false, error: e?.message });\n  }\n}\n","path":null,"size_bytes":2527,"size_tokens":null},"src/app/api/admin/products/refresh-images/route.ts":{"content":"import { NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport { ensureAdmin } from '@/lib/auth/admin-guard';\nimport { fetchProductDetailsByPid, getAccessToken } from '@/lib/cj/v2';\nimport { fetchJson } from '@/lib/http';\n\nexport const dynamic = 'force-dynamic';\nexport const runtime = 'nodejs';\n\nfunction getSupabaseAdmin() {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const key = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  if (!url || !key) return null;\n  return createClient(url, key);\n}\n\nfunction extractAllImages(item: any): string[] {\n  if (!item) return [];\n  \n  const imageList: string[] = [];\n  const seen = new Set<string>();\n  \n  const pushUrl = (val: any) => {\n    if (typeof val === 'string' && val.trim()) {\n      const url = val.trim();\n      if (!seen.has(url)) {\n        seen.add(url);\n        imageList.push(url);\n      }\n    }\n  };\n  \n  const mainFields = ['productImage', 'bigImage', 'image', 'mainImage', 'mainImageUrl'];\n  for (const field of mainFields) {\n    pushUrl(item[field]);\n  }\n  \n  const arrFields = ['imageList', 'productImageList', 'detailImageList', 'pictureList', 'productImages'];\n  for (const key of arrFields) {\n    const arr = item[key];\n    if (Array.isArray(arr)) {\n      for (const it of arr) {\n        if (typeof it === 'string') pushUrl(it);\n        else if (it && typeof it === 'object') {\n          pushUrl(it.imageUrl || it.url || it.imgUrl || it.big || it.origin || it.src);\n        }\n      }\n    }\n  }\n  \n  // Extract color images from productPropertyList (CJ color options)\n  const propertyList = item.productPropertyList || item.propertyList || item.productOptions || [];\n  if (Array.isArray(propertyList)) {\n    for (const prop of propertyList) {\n      pushUrl(prop?.image || prop?.imageUrl || prop?.propImage || prop?.optionImage);\n      \n      const propValues = prop?.propertyValueList || prop?.values || prop?.options || [];\n      if (Array.isArray(propValues)) {\n        for (const pv of propValues) {\n          pushUrl(pv?.image || pv?.imageUrl || pv?.propImage || pv?.bigImage);\n        }\n      }\n    }\n  }\n  \n  // Variants - comprehensive extraction including color images\n  const variantList = item.variantList || item.skuList || item.variants || [];\n  if (Array.isArray(variantList)) {\n    for (const v of variantList) {\n      pushUrl(v?.whiteImage || v?.image || v?.imageUrl || v?.imgUrl);\n      pushUrl(v?.variantImage || v?.attributeImage || v?.skuImage);\n      pushUrl(v?.bigImage || v?.originImage || v?.mainImage);\n      \n      const variantImages = v?.variantImageList || v?.skuImageList || v?.imageList || [];\n      if (Array.isArray(variantImages)) {\n        for (const vi of variantImages) {\n          if (typeof vi === 'string') pushUrl(vi);\n          else if (vi && typeof vi === 'object') {\n            pushUrl(vi.image || vi.big || vi.small || vi.url || vi.imageUrl);\n          }\n        }\n      }\n      \n      const variantProps = v?.variantPropertyList || v?.propertyList || [];\n      if (Array.isArray(variantProps)) {\n        for (const vp of variantProps) {\n          pushUrl(vp?.image || vp?.propImage || vp?.imageUrl);\n        }\n      }\n    }\n  }\n  \n  const deny = /(sprite|icon|favicon|logo|placeholder|blank|loading|alipay|wechat|whatsapp|kefu|service|avatar|thumb|thumbnail|small|tiny|mini|sizechart|size\\s*chart|chart|table|guide|tips|hot|badge|flag|promo|banner|sale|discount|qr)/i;\n  \n  return imageList.filter(url => !deny.test(url)).slice(0, 50);\n}\n\nfunction removeDuplicateImages(images: string[]): string[] {\n  const seen = new Set<string>();\n  const result: string[] = [];\n  \n  for (const img of images) {\n    const normalized = img.toLowerCase()\n      .replace(/\\?.*$/, '')\n      .replace(/_\\d+x\\d+/, '')\n      .replace(/-\\d+x\\d+/, '');\n    \n    if (!seen.has(normalized)) {\n      seen.add(normalized);\n      result.push(img);\n    }\n  }\n  \n  return result;\n}\n\nfunction scoreImageQuality(url: string): number {\n  let score = 50;\n  \n  const lowerUrl = url.toLowerCase();\n  \n  if (lowerUrl.includes('_800') || lowerUrl.includes('800x')) score += 20;\n  else if (lowerUrl.includes('_600') || lowerUrl.includes('600x')) score += 15;\n  else if (lowerUrl.includes('_400') || lowerUrl.includes('400x')) score += 10;\n  \n  if (lowerUrl.includes('/original/') || lowerUrl.includes('/big/')) score += 15;\n  \n  if (lowerUrl.includes('model') || lowerUrl.includes('lifestyle')) score += 10;\n  \n  if (lowerUrl.includes('detail') || lowerUrl.includes('close')) score -= 5;\n  \n  return score;\n}\n\nfunction selectBestHeroImage(images: string[]): string[] {\n  if (images.length <= 1) return images;\n  \n  const scored = images.map((url, index) => ({\n    url,\n    originalIndex: index,\n    score: scoreImageQuality(url) - (index * 0.5)\n  }));\n  \n  scored.sort((a, b) => b.score - a.score);\n  \n  const bestUrl = scored[0].url;\n  const result = [bestUrl, ...images.filter(url => url !== bestUrl)];\n  \n  return result;\n}\n\nasync function fetchProductFromCj(cjProductId: string): Promise<any | null> {\n  try {\n    const details = await fetchProductDetailsByPid(cjProductId);\n    return details;\n  } catch (e: any) {\n    console.log(`[Refresh Images] Failed to fetch CJ product ${cjProductId}:`, e?.message);\n    return null;\n  }\n}\n\nasync function fetchProductByVariantSku(variantSku: string): Promise<any | null> {\n  try {\n    const token = await getAccessToken();\n    const base = process.env.CJ_API_BASE || 'https://developers.cjdropshipping.com/api2.0/v1';\n    \n    const res = await fetchJson<any>(`${base}/product/variant/queryByVid?vid=${encodeURIComponent(variantSku)}`, {\n      headers: {\n        'CJ-Access-Token': token,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n      timeoutMs: 15000,\n    });\n    \n    const pid = res?.data?.pid || res?.data?.productId;\n    if (pid) {\n      return await fetchProductDetailsByPid(pid);\n    }\n    return null;\n  } catch (e: any) {\n    console.log(`[Refresh Images] Failed to fetch by variant SKU ${variantSku}:`, e?.message);\n    return null;\n  }\n}\n\nasync function refreshProductImages(\n  supabase: any,\n  productId: number\n): Promise<{ success: boolean; imagesCount: number; error?: string }> {\n  const { data: product, error: fetchError } = await supabase\n    .from('products')\n    .select('id, title, cj_product_id, supplier_sku, images')\n    .eq('id', productId)\n    .single();\n  \n  if (fetchError || !product) {\n    return { success: false, imagesCount: 0, error: 'Product not found' };\n  }\n  \n  let cjDetails: any = null;\n  \n  if ((product as any).cj_product_id) {\n    cjDetails = await fetchProductFromCj((product as any).cj_product_id);\n  }\n  \n  if (!cjDetails && (product as any).supplier_sku) {\n    const sku = ((product as any).supplier_sku as string).replace(/^CJ-/, '');\n    \n    if (sku.length > 15 && !sku.includes('-')) {\n      cjDetails = await fetchProductFromCj(sku);\n    }\n    \n    if (!cjDetails) {\n      cjDetails = await fetchProductByVariantSku(sku);\n    }\n  }\n  \n  if (!cjDetails) {\n    return { \n      success: false, \n      imagesCount: Array.isArray((product as any).images) ? (product as any).images.length : 0, \n      error: 'No CJ product ID or valid supplier SKU found' \n    };\n  }\n  \n  let allImages = extractAllImages(cjDetails);\n  \n  allImages = removeDuplicateImages(allImages);\n  \n  allImages = selectBestHeroImage(allImages);\n  \n  if (allImages.length === 0) {\n    return { \n      success: false, \n      imagesCount: 0, \n      error: 'No images found in CJ response' \n    };\n  }\n  \n  const { error: updateError } = await supabase\n    .from('products')\n    .update({ \n      images: allImages,\n      updated_at: new Date().toISOString()\n    })\n    .eq('id', productId);\n  \n  if (updateError) {\n    return { success: false, imagesCount: 0, error: updateError.message };\n  }\n  \n  console.log(`[Refresh Images] Product ${productId} \"${(product as any).title}\": ${allImages.length} images synced`);\n  \n  return { success: true, imagesCount: allImages.length };\n}\n\nexport async function POST(req: Request) {\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json(\n        { ok: false, error: guard.reason },\n        { status: 401 }\n      );\n    }\n    \n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return NextResponse.json(\n        { ok: false, error: 'Database not configured' },\n        { status: 500 }\n      );\n    }\n    \n    const body = await req.json().catch(() => ({}));\n    const { productId, productIds, all } = body;\n    \n    if (all === true) {\n      const { data: products, error } = await supabase\n        .from('products')\n        .select('id')\n        .or('cj_product_id.not.is.null,supplier_sku.not.is.null')\n        .order('id', { ascending: true });\n      \n      if (error) {\n        return NextResponse.json(\n          { ok: false, error: error.message },\n          { status: 500 }\n        );\n      }\n      \n      const results: { id: number; success: boolean; imagesCount: number; error?: string }[] = [];\n      \n      for (const p of (products || [])) {\n        const result = await refreshProductImages(supabase, p.id);\n        results.push({ id: p.id, ...result });\n        \n        await new Promise(resolve => setTimeout(resolve, 200));\n      }\n      \n      const successful = results.filter(r => r.success).length;\n      const totalImages = results.reduce((sum, r) => sum + r.imagesCount, 0);\n      \n      return NextResponse.json({\n        ok: true,\n        message: `Refreshed images for ${successful}/${results.length} products`,\n        totalProducts: results.length,\n        successfulProducts: successful,\n        totalImages,\n        results\n      });\n    }\n    \n    if (Array.isArray(productIds) && productIds.length > 0) {\n      const results: { id: number; success: boolean; imagesCount: number; error?: string }[] = [];\n      \n      for (const id of productIds) {\n        const result = await refreshProductImages(supabase, Number(id));\n        results.push({ id: Number(id), ...result });\n        \n        await new Promise(resolve => setTimeout(resolve, 200));\n      }\n      \n      const successful = results.filter(r => r.success).length;\n      \n      return NextResponse.json({\n        ok: true,\n        message: `Refreshed images for ${successful}/${results.length} products`,\n        results\n      });\n    }\n    \n    if (productId) {\n      const result = await refreshProductImages(supabase, Number(productId));\n      \n      return NextResponse.json({\n        ok: result.success,\n        ...result\n      });\n    }\n    \n    return NextResponse.json(\n      { ok: false, error: 'Provide productId, productIds array, or all: true' },\n      { status: 400 }\n    );\n    \n  } catch (e: any) {\n    console.error('[Refresh Images] Error:', e);\n    return NextResponse.json(\n      { ok: false, error: e?.message || 'Internal error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(req: Request) {\n  try {\n    const guard = await ensureAdmin();\n    if (!guard.ok) {\n      return NextResponse.json(\n        { ok: false, error: guard.reason },\n        { status: 401 }\n      );\n    }\n    \n    const supabase = getSupabaseAdmin();\n    if (!supabase) {\n      return NextResponse.json(\n        { ok: false, error: 'Database not configured' },\n        { status: 500 }\n      );\n    }\n    \n    const { data: products, error } = await supabase\n      .from('products')\n      .select('id, title, images, cj_product_id, supplier_sku')\n      .or('cj_product_id.not.is.null,supplier_sku.not.is.null')\n      .order('id', { ascending: true });\n    \n    if (error) {\n      return NextResponse.json(\n        { ok: false, error: error.message },\n        { status: 500 }\n      );\n    }\n    \n    const stats = {\n      totalProducts: products?.length || 0,\n      withOneImage: 0,\n      withMultipleImages: 0,\n      noImages: 0,\n      products: (products || []).map(p => {\n        const imgCount = Array.isArray(p.images) ? p.images.length : 0;\n        if (imgCount === 0) stats.noImages++;\n        else if (imgCount === 1) stats.withOneImage++;\n        else stats.withMultipleImages++;\n        \n        return {\n          id: p.id,\n          title: p.title,\n          imageCount: imgCount,\n          hasCjId: !!p.cj_product_id,\n          hasSupplierSku: !!p.supplier_sku\n        };\n      })\n    };\n    \n    return NextResponse.json({ ok: true, ...stats });\n    \n  } catch (e: any) {\n    console.error('[Refresh Images] GET Error:', e);\n    return NextResponse.json(\n      { ok: false, error: e?.message || 'Internal error' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":12581,"size_tokens":null},"src/components/admin/import/preview/PreviewPageFour.tsx":{"content":"\"use client\";\n\nimport type { ReactNode } from \"react\";\nimport { Package, TrendingUp, Layers, AlertTriangle, CheckCircle, XCircle, Globe, ShoppingBag } from \"lucide-react\";\nimport type { PricedProduct } from \"./types\";\n\ntype PreviewPageFourProps = {\n  product: PricedProduct;\n};\n\nfunction getStockStatus(stock: number): { label: string; color: string; icon: ReactNode } {\n  if (stock === 0) {\n    return {\n      label: \"Out of Stock\",\n      color: \"text-red-600 bg-red-50 border-red-200\",\n      icon: <XCircle className=\"h-5 w-5 text-red-500\" />,\n    };\n  }\n  if (stock < 10) {\n    return {\n      label: \"Low Stock\",\n      color: \"text-amber-600 bg-amber-50 border-amber-200\",\n      icon: <AlertTriangle className=\"h-5 w-5 text-amber-500\" />,\n    };\n  }\n  if (stock < 50) {\n    return {\n      label: \"Limited Stock\",\n      color: \"text-blue-600 bg-blue-50 border-blue-200\",\n      icon: <Package className=\"h-5 w-5 text-blue-500\" />,\n    };\n  }\n  return {\n    label: \"In Stock\",\n    color: \"text-green-600 bg-green-50 border-green-200\",\n    icon: <CheckCircle className=\"h-5 w-5 text-green-500\" />,\n  };\n}\n\nfunction getPopularityLevel(listedNum: number): { label: string; level: number; color: string } {\n  if (listedNum >= 1000) {\n    return { label: \"Very Popular\", level: 5, color: \"bg-green-500\" };\n  }\n  if (listedNum >= 500) {\n    return { label: \"Popular\", level: 4, color: \"bg-emerald-500\" };\n  }\n  if (listedNum >= 100) {\n    return { label: \"Moderate Popularity\", level: 3, color: \"bg-blue-500\" };\n  }\n  if (listedNum >= 20) {\n    return { label: \"Low Popularity\", level: 2, color: \"bg-amber-500\" };\n  }\n  return { label: \"New\", level: 1, color: \"bg-gray-400\" };\n}\n\nexport default function PreviewPageFour({ product }: PreviewPageFourProps) {\n  const detailedInventory = product.inventory;\n  const totalStock = detailedInventory?.totalAvailable ?? product.stock;\n  const cjStock = detailedInventory?.totalCJ ?? product.totalVerifiedInventory ?? 0;\n  const factoryStock = detailedInventory?.totalFactory ?? product.totalUnVerifiedInventory ?? 0;\n  const hasInventoryData = totalStock > 0 || cjStock > 0 || factoryStock > 0;\n  \n  const stockStatus = getStockStatus(totalStock);\n  const popularity = getPopularityLevel(product.listedNum);\n  \n  const warehouses = detailedInventory?.warehouses || [];\n  const hasWarehouses = warehouses.length > 0;\n  \n  // Use inventoryVariants for the blue Inventory Details box (contains ALL variant stock data)\n  // This comes from queryVariantInventory API and includes all 54+ variants for multi-variant products\n  const inventoryVariants = product.inventoryVariants || [];\n  const hasInventoryVariants = inventoryVariants.length > 0;\n  const inventoryVariantsCount = inventoryVariants.length;\n  \n  // Count variants with ACTUAL stock (> 0) - only these should be counted as \"in stock\"\n  // Variants with cjStock or factoryStock = -1 have unknown per-variant stock\n  // Variants with cjStock and factoryStock = 0 are known to be out of stock\n  const variantsWithActualStock = inventoryVariants.filter(v => (v.cjStock > 0 || v.factoryStock > 0));\n  const inStockCount = variantsWithActualStock.length;\n  \n  // Check if any variant has unknown stock (-1)\n  const hasUnknownVariantStock = inventoryVariants.some(v => v.cjStock < 0 || v.factoryStock < 0);\n  \n  // Check for inventory fetch errors\n  const inventoryHasError = product.inventoryStatus === 'error' || product.inventoryStatus === 'partial';\n\n  return (\n    <div className=\"space-y-6\">\n      {inventoryHasError && (\n        <div className=\"bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3\">\n          <AlertTriangle className=\"h-5 w-5 text-amber-500 flex-shrink-0 mt-0.5\" />\n          <div>\n            <p className=\"font-medium text-amber-800\">Inventory Data Incomplete</p>\n            <p className=\"text-sm text-amber-700 mt-1\">\n              {product.inventoryErrorMessage || 'Could not fetch complete inventory data from CJ. Stock values shown may not be accurate.'}\n            </p>\n          </div>\n        </div>\n      )}\n      \n      <div className=\"grid md:grid-cols-2 gap-5\">\n        <div className={`rounded-xl border p-5 ${stockStatus.color}`}>\n          <div className=\"flex items-center gap-3 mb-4\">\n            {stockStatus.icon}\n            <h3 className=\"text-lg font-bold\">Stock Status</h3>\n          </div>\n          \n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-gray-600\">Total Available:</span>\n              <span className=\"text-2xl font-bold\">{totalStock.toLocaleString()}</span>\n            </div>\n            \n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-gray-600\">Status:</span>\n              <span className=\"font-semibold\">{stockStatus.label}</span>\n            </div>\n            \n            {hasInventoryData && (\n              <div className=\"border-t border-gray-200 pt-3 mt-3\">\n                <div className=\"flex justify-between items-center text-sm\">\n                  <span className=\"text-gray-500 flex items-center gap-1\">\n                    🏭 CJ Warehouse:\n                  </span>\n                  <span className=\"font-semibold text-blue-600\">{cjStock.toLocaleString()}</span>\n                </div>\n                <div className=\"flex justify-between items-center text-sm mt-1\">\n                  <span className=\"text-gray-500 flex items-center gap-1\">\n                    🏭 Factory:\n                  </span>\n                  <span className=\"font-semibold text-orange-600\">{factoryStock.toLocaleString()}</span>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Layers className=\"h-5 w-5 text-indigo-500\" />\n            <h3 className=\"text-lg font-bold text-gray-900\">Variants</h3>\n          </div>\n          \n          <div className=\"space-y-4\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-gray-600\">Total Variants:</span>\n              <span className=\"text-2xl font-bold text-gray-900\">{product.totalVariants}</span>\n            </div>\n            \n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-gray-600\">\n                {hasUnknownVariantStock ? 'Listed Variants:' : 'Available Variants:'}\n              </span>\n              <span className={`font-semibold ${hasUnknownVariantStock ? 'text-gray-600' : 'text-green-600'}`}>\n                {hasUnknownVariantStock ? inventoryVariantsCount : inStockCount}\n              </span>\n            </div>\n\n            {!hasUnknownVariantStock && product.totalVariants !== inStockCount && inStockCount > 0 && (\n              <div className=\"text-sm text-amber-600 bg-amber-50 rounded-lg p-2\">\n                {product.totalVariants - inStockCount} variants out of stock or unavailable\n              </div>\n            )}\n            \n            {hasUnknownVariantStock && (\n              <div className=\"text-sm text-amber-600 bg-amber-50 rounded-lg p-2\">\n                Per-variant stock data not available from CJ. Product has {totalStock.toLocaleString()} total units.\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      {hasWarehouses && (\n        <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Globe className=\"h-5 w-5 text-green-500\" />\n            <h3 className=\"text-lg font-bold text-gray-900\">Inventory by Warehouse</h3>\n          </div>\n          \n          <div className=\"max-h-60 overflow-y-auto overflow-x-auto border border-gray-100 rounded-lg\">\n            <table className=\"w-full text-sm\">\n              <thead className=\"sticky top-0 bg-white border-b border-gray-200\">\n                <tr>\n                  <th className=\"text-left py-2 px-3 font-semibold text-gray-700\">Warehouse Location</th>\n                  <th className=\"text-right py-2 px-3 font-semibold text-blue-600\">\n                    <span className=\"flex items-center justify-end gap-1\">\n                      🏭 CJ\n                    </span>\n                  </th>\n                  <th className=\"text-right py-2 px-3 font-semibold text-orange-600\">\n                    <span className=\"flex items-center justify-end gap-1\">\n                      🏭 Factory\n                    </span>\n                  </th>\n                  <th className=\"text-right py-2 px-3 font-semibold text-gray-700\">Total</th>\n                </tr>\n              </thead>\n              <tbody>\n                {warehouses.map((wh, idx) => (\n                  <tr key={idx} className=\"border-b border-gray-100 last:border-b-0\">\n                    <td className=\"py-2 px-3 text-gray-700\">\n                      {wh.areaName}\n                      {wh.countryCode && <span className=\"text-gray-400 ml-1\">({wh.countryCode})</span>}\n                    </td>\n                    <td className=\"py-2 px-3 text-right font-medium text-blue-600\">\n                      {wh.cjInventory.toLocaleString()}\n                    </td>\n                    <td className=\"py-2 px-3 text-right font-medium text-orange-600\">\n                      {wh.factoryInventory.toLocaleString()}\n                    </td>\n                    <td className=\"py-2 px-3 text-right font-bold text-gray-900\">\n                      {wh.totalInventory.toLocaleString()}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n          \n          <div className=\"mt-3 pt-3 border-t border-gray-200\">\n            <div className=\"flex justify-between text-sm font-bold\">\n              <span className=\"text-gray-900\">Total</span>\n              <div className=\"flex gap-6\">\n                <span className=\"text-blue-600\">{cjStock.toLocaleString()}</span>\n                <span className=\"text-orange-600\">{factoryStock.toLocaleString()}</span>\n                <span className=\"text-gray-900\">{totalStock.toLocaleString()}</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {hasInventoryVariants && (\n        <div className=\"rounded-xl border-2 border-blue-400 overflow-hidden shadow-lg\">\n          <div className=\"bg-blue-600 text-white px-5 py-3 flex items-center justify-between\">\n            <div className=\"flex items-center gap-3\">\n              <ShoppingBag className=\"h-5 w-5\" />\n              <h3 className=\"text-lg font-bold\">Inventory Details</h3>\n            </div>\n            <span className={`text-sm px-3 py-1 rounded-full ${hasUnknownVariantStock ? 'bg-amber-500' : 'bg-blue-500'}`}>\n              {hasUnknownVariantStock \n                ? `${inventoryVariantsCount} variants listed`\n                : `${inStockCount} variants in stock`}\n            </span>\n          </div>\n          \n          <div className=\"bg-blue-50\">\n            <div className=\"max-h-80 overflow-y-auto\">\n              <table className=\"w-full text-sm\">\n                <thead className=\"sticky top-0 bg-blue-100 border-b-2 border-blue-300\">\n                  <tr>\n                    <th className=\"text-left py-3 px-4 font-bold text-blue-900\">Products</th>\n                    <th className=\"text-right py-3 px-4 font-bold text-blue-900\">Price</th>\n                    <th className=\"text-right py-3 px-4 font-bold text-blue-700 border-l border-blue-300\">\n                      <span className=\"flex items-center justify-end gap-1\">\n                        🏭 CJ\n                      </span>\n                    </th>\n                    <th className=\"text-right py-3 px-4 font-bold text-blue-700\">\n                      <span className=\"flex items-center justify-end gap-1\">\n                        🏭 Factory\n                      </span>\n                    </th>\n                  </tr>\n                </thead>\n                <tbody className=\"bg-white\">\n                  {inventoryVariants.map((v, idx) => {\n                    // Handle unknown per-variant stock (-1 means per-variant data not available)\n                    const cjDisplay = v.cjStock < 0 ? '-' : v.cjStock.toLocaleString();\n                    const factoryDisplay = v.factoryStock < 0 ? '-' : v.factoryStock.toLocaleString();\n                    const isUnknownStock = v.cjStock < 0 || v.factoryStock < 0;\n                    \n                    return (\n                      <tr key={idx} className=\"border-b border-blue-100 hover:bg-blue-50 transition-colors\">\n                        <td className=\"py-3 px-4\">\n                          <div className=\"font-medium text-blue-800\">{v.shortName}</div>\n                          <span className=\"text-blue-400 text-xs\">SKU: {v.sku}</span>\n                        </td>\n                        <td className=\"py-3 px-4 text-right font-medium text-gray-900\">\n                          ${(v.priceUSD || 0).toFixed(2)}\n                        </td>\n                        <td className={`py-3 px-4 text-right font-bold border-l border-blue-100 ${isUnknownStock ? 'text-gray-400' : 'text-blue-600'}`}>\n                          {cjDisplay}\n                        </td>\n                        <td className={`py-3 px-4 text-right font-bold ${isUnknownStock ? 'text-gray-400' : 'text-orange-500'}`}>\n                          {factoryDisplay}\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n          \n          <div className=\"bg-blue-50 border-t border-blue-200 px-4 py-3 text-xs text-blue-700\">\n            <p><strong>CJ:</strong> Stock in CJ warehouse, ready for immediate shipping.</p>\n            <p><strong>Factory:</strong> Stock at supplier. May require 1-3 days processing before shipping.</p>\n            {inventoryVariants.some(v => v.cjStock < 0) && (\n              <p className=\"mt-2 text-amber-600\">\n                <strong>Note:</strong> \"-\" indicates per-variant stock not available from CJ. See total stock in \"Stock Status\" above.\n              </p>\n            )}\n          </div>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n        <div className=\"flex items-center gap-3 mb-5\">\n          <TrendingUp className=\"h-5 w-5 text-purple-500\" />\n          <h3 className=\"text-lg font-bold text-gray-900\">Popularity</h3>\n        </div>\n\n        <div className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <span className=\"text-gray-600\">Number of stores selling this product:</span>\n            <span className=\"text-xl font-bold text-gray-900\">{product.listedNum.toLocaleString()}</span>\n          </div>\n\n          <div className=\"space-y-2\">\n            <div className=\"flex justify-between items-center\">\n              <span className=\"text-gray-600\">Popularity Level:</span>\n              <span className=\"font-semibold\">{popularity.label}</span>\n            </div>\n            \n            <div className=\"flex gap-1\">\n              {[1, 2, 3, 4, 5].map((level) => (\n                <div\n                  key={level}\n                  className={`h-2 flex-1 rounded-full ${\n                    level <= popularity.level ? popularity.color : \"bg-gray-200\"\n                  }`}\n                />\n              ))}\n            </div>\n          </div>\n\n          <div className=\"text-sm text-gray-500 bg-gray-50 rounded-lg p-3\">\n            {popularity.level >= 4 ? (\n              <>Popular and in high demand. There may be high competition.</>\n            ) : popularity.level >= 2 ? (\n              <>Moderate demand. Good opportunity to enter the market.</>\n            ) : (\n              <>New or low demand product. May need additional marketing.</>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16068,"size_tokens":null},"src/components/admin/import/preview/PreviewPageSix.tsx":{"content":"\"use client\";\n\nimport { DollarSign, TrendingUp, AlertCircle, Truck, Package } from \"lucide-react\";\nimport type { PricedProduct } from \"./types\";\n\ntype PreviewPageSixProps = {\n  product: PricedProduct;\n};\n\nexport default function PreviewPageSix({ product }: PreviewPageSixProps) {\n  const availableVariants = product.variants.filter((v) => v.shippingAvailable);\n  const unavailableVariants = product.variants.filter((v) => !v.shippingAvailable);\n\n  const profitMargin = 0.08;\n\n  const computedVariants = availableVariants.map(v => {\n    const productCost = v.variantPriceUSD;\n    const shippingCost = v.shippingPriceUSD;\n    const totalCost = productCost + shippingCost;\n    const sellPrice = totalCost / (1 - profitMargin);\n    const profit = sellPrice - totalCost;\n    const marginPercent = sellPrice > 0 ? (profit / sellPrice) * 100 : 0;\n    return { ...v, productCost, shippingCost, totalCost, sellPrice, profit, marginPercent };\n  });\n\n  const avgProfit = computedVariants.length > 0\n    ? computedVariants.reduce((sum, v) => sum + v.profit, 0) / computedVariants.length\n    : 0;\n\n  const avgMarginPercent = computedVariants.length > 0\n    ? computedVariants.reduce((sum, v) => sum + v.marginPercent, 0) / computedVariants.length\n    : 0;\n\n  const totalProductCost = computedVariants.reduce((sum, v) => sum + v.productCost, 0);\n  const totalShippingCost = computedVariants.reduce((sum, v) => sum + v.shippingCost, 0);\n  const totalRevenue = computedVariants.reduce((sum, v) => sum + v.sellPrice, 0);\n  const totalProfit = computedVariants.reduce((sum, v) => sum + v.profit, 0);\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Package className=\"h-4 w-4 text-blue-600\" />\n            <span className=\"text-xs text-blue-700\">Total Product Cost</span>\n          </div>\n          <p className=\"text-2xl font-bold text-blue-700\">\n            ${totalProductCost.toFixed(2)}\n          </p>\n        </div>\n\n        <div className=\"bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl border border-purple-200 p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Truck className=\"h-4 w-4 text-purple-600\" />\n            <span className=\"text-xs text-purple-700\">Total Shipping</span>\n          </div>\n          <p className=\"text-2xl font-bold text-purple-700\">\n            ${totalShippingCost.toFixed(2)}\n          </p>\n        </div>\n\n        <div className=\"bg-gradient-to-br from-orange-50 to-amber-50 rounded-xl border border-orange-200 p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <DollarSign className=\"h-4 w-4 text-orange-600\" />\n            <span className=\"text-xs text-orange-700\">Total Revenue</span>\n          </div>\n          <p className=\"text-2xl font-bold text-orange-700\">\n            ${totalRevenue.toFixed(2)}\n          </p>\n        </div>\n\n        <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-4\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n            <span className=\"text-xs text-green-700\">Total Profit</span>\n          </div>\n          <p className=\"text-2xl font-bold text-green-700\">\n            ${totalProfit.toFixed(2)}\n          </p>\n        </div>\n      </div>\n\n      <div className=\"grid md:grid-cols-2 gap-5\">\n        <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-3\">\n            <DollarSign className=\"h-5 w-5 text-green-600\" />\n            <h3 className=\"text-lg font-bold text-green-900\">Average Profit</h3>\n          </div>\n          <p className=\"text-3xl font-bold text-green-700\">\n            ${avgProfit.toFixed(2)}\n          </p>\n          <p className=\"text-sm text-green-600 mt-1\">per variant sold</p>\n        </div>\n\n        <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-3\">\n            <TrendingUp className=\"h-5 w-5 text-blue-600\" />\n            <h3 className=\"text-lg font-bold text-blue-900\">Average Profit Margin</h3>\n          </div>\n          <p className=\"text-3xl font-bold text-blue-700\">\n            {avgMarginPercent.toFixed(1)}%\n          </p>\n          <p className=\"text-sm text-blue-600 mt-1\">of selling price</p>\n        </div>\n      </div>\n\n      {computedVariants.length > 0 && (\n        <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-gray-50 to-slate-50 px-5 py-4 border-b border-gray-200\">\n            <h3 className=\"text-lg font-bold text-gray-900\">\n              Detailed Pricing per Variant ({computedVariants.length})\n            </h3>\n          </div>\n\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full text-sm\">\n              <thead className=\"bg-gray-50 border-b border-gray-200\">\n                <tr>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Variant</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Product Cost</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Shipping</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Total Cost</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Sell Price</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Profit</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Margin</th>\n                  <th className=\"text-left px-4 py-3 font-semibold text-gray-700\">Shipping Method</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-100\">\n                {computedVariants.slice(0, 20).map((variant, idx) => {\n                  const variantLabel = variant.variantName || variant.size || variant.color || variant.variantSku || `Variant ${idx + 1}`;\n                  \n                  return (\n                    <tr key={variant.variantId || idx} className=\"hover:bg-gray-50\">\n                      <td className=\"px-4 py-3\">\n                        <div className=\"flex items-center gap-2\">\n                          {variant.variantImage && (\n                            <img \n                              src={variant.variantImage} \n                              alt={variantLabel}\n                              className=\"w-8 h-8 object-cover rounded\"\n                            />\n                          )}\n                          <span className=\"text-gray-700 font-medium truncate max-w-[120px]\" title={variantLabel}>\n                            {variantLabel}\n                          </span>\n                        </div>\n                      </td>\n                      <td className=\"px-4 py-3 text-gray-700\">\n                        ${variant.productCost.toFixed(2)}\n                      </td>\n                      <td className=\"px-4 py-3 text-blue-600 font-medium\">\n                        ${variant.shippingCost.toFixed(2)}\n                      </td>\n                      <td className=\"px-4 py-3 font-medium text-orange-600\">\n                        ${variant.totalCost.toFixed(2)}\n                      </td>\n                      <td className=\"px-4 py-3 font-bold text-gray-800\">\n                        ${variant.sellPrice.toFixed(2)}\n                      </td>\n                      <td className=\"px-4 py-3 font-bold text-green-600\">\n                        ${variant.profit.toFixed(2)}\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <span className={`font-medium ${\n                          variant.marginPercent >= 30 ? \"text-green-600\" :\n                          variant.marginPercent >= 20 ? \"text-blue-600\" :\n                          variant.marginPercent >= 10 ? \"text-amber-600\" :\n                          \"text-red-600\"\n                        }`}>\n                          {variant.marginPercent.toFixed(1)}%\n                        </span>\n                      </td>\n                      <td className=\"px-4 py-3\">\n                        <div className=\"flex items-center gap-1\">\n                          <Truck className=\"h-3 w-3 text-gray-400\" />\n                          <span className=\"text-xs text-gray-500 truncate max-w-[80px]\" title={variant.logisticName || 'N/A'}>\n                            {variant.logisticName || 'N/A'}\n                          </span>\n                        </div>\n                        {variant.deliveryDays && variant.deliveryDays !== 'Unknown' && (\n                          <span className=\"text-xs text-gray-400 block\">{variant.deliveryDays}</span>\n                        )}\n                      </td>\n                    </tr>\n                  );\n                })}\n              </tbody>\n            </table>\n            {computedVariants.length > 20 && (\n              <div className=\"px-4 py-3 bg-gray-50 border-t border-gray-200 text-center text-sm text-gray-500\">\n                Showing 20 of {computedVariants.length} variants\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {unavailableVariants.length > 0 && (\n        <div className=\"bg-red-50 rounded-xl border border-red-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-3\">\n            <AlertCircle className=\"h-5 w-5 text-red-600\" />\n            <h3 className=\"text-lg font-bold text-red-900\">\n              Variants Unavailable for Shipping ({unavailableVariants.length})\n            </h3>\n          </div>\n          \n          <div className=\"space-y-2\">\n            {unavailableVariants.slice(0, 5).map((variant, idx) => (\n              <div\n                key={variant.variantId || idx}\n                className=\"bg-white/70 rounded-lg px-4 py-2 text-sm\"\n              >\n                <span className=\"font-medium text-red-700\">\n                  {variant.variantName || variant.size || variant.color || variant.variantSku || `Variant ${idx + 1}`}\n                </span>\n                {variant.error && (\n                  <span className=\"text-red-600 ml-2\">- {variant.error}</span>\n                )}\n              </div>\n            ))}\n            {unavailableVariants.length > 5 && (\n              <p className=\"text-sm text-red-600 italic\">\n                and {unavailableVariants.length - 5} more variants...\n              </p>\n            )}\n          </div>\n        </div>\n      )}\n\n      {availableVariants.length === 0 && (\n        <div className=\"bg-amber-50 rounded-xl border border-amber-200 p-8 text-center\">\n          <AlertCircle className=\"h-12 w-12 text-amber-500 mx-auto mb-4\" />\n          <h3 className=\"text-lg font-bold text-amber-900 mb-2\">\n            No Variants Available for Shipping\n          </h3>\n          <p className=\"text-amber-700\">\n            All variants of this product are currently unavailable for shipping to the USA.\n          </p>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":11365,"size_tokens":null},"src/components/admin/import/preview/PreviewPageOne.tsx":{"content":"\"use client\";\n\nimport { Star, TrendingUp, Image as ImageIcon, Tag, Ruler, FolderOpen, DollarSign, Info, Palette, Smartphone } from \"lucide-react\";\nimport type { PricedProduct } from \"./types\";\n\ntype PreviewPageOneProps = {\n  product: PricedProduct;\n};\n\nfunction calculateEstimatedRating(listedNum: number): { rating: number; reviewCount: number } {\n  let rating: number;\n  if (listedNum >= 2000) {\n    rating = 4.8;\n  } else if (listedNum >= 1000) {\n    rating = 4.7;\n  } else if (listedNum >= 500) {\n    rating = 4.5;\n  } else if (listedNum >= 200) {\n    rating = 4.3;\n  } else if (listedNum >= 100) {\n    rating = 4.2;\n  } else if (listedNum >= 50) {\n    rating = 4.0;\n  } else if (listedNum >= 20) {\n    rating = 3.9;\n  } else {\n    rating = 3.8;\n  }\n  \n  const reviewCount = listedNum >= 10 \n    ? Math.round(listedNum * 0.15) \n    : Math.max(5, Math.round(listedNum * 0.5 + 3));\n  \n  return { rating, reviewCount };\n}\n\nfunction StarRating({ rating, reviewCount }: { rating: number; reviewCount: number }) {\n  const fullStars = Math.floor(rating);\n  const hasHalfStar = rating - fullStars >= 0.3;\n  const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);\n\n  return (\n    <div className=\"flex flex-col gap-3\">\n      <div className=\"flex items-center gap-4\">\n        <div className=\"flex items-center gap-1\">\n          {[...Array(fullStars)].map((_, i) => (\n            <Star key={`full-${i}`} className=\"h-6 w-6 fill-amber-400 text-amber-400\" />\n          ))}\n          {hasHalfStar && (\n            <div className=\"relative\">\n              <Star className=\"h-6 w-6 text-gray-300\" />\n              <div className=\"absolute inset-0 overflow-hidden w-1/2\">\n                <Star className=\"h-6 w-6 fill-amber-400 text-amber-400\" />\n              </div>\n            </div>\n          )}\n          {[...Array(emptyStars)].map((_, i) => (\n            <Star key={`empty-${i}`} className=\"h-6 w-6 text-gray-300\" />\n          ))}\n        </div>\n        <span className=\"text-2xl font-bold text-gray-800\">{rating.toFixed(1)}</span>\n      </div>\n      <div className=\"flex items-center gap-2 text-gray-600\">\n        <span className=\"font-medium\">{reviewCount.toLocaleString()} reviews</span>\n        <div className=\"group relative\">\n          <Info className=\"h-4 w-4 text-gray-400 cursor-help\" />\n          <div className=\"absolute bottom-full left-0 mb-2 hidden group-hover:block w-64 p-3 bg-gray-800 text-white text-sm rounded-lg shadow-lg z-10\">\n            Shopixo estimated rating based on supplier data and product popularity\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction getPopularityInfo(listedNum: number): { label: string; level: number; color: string; bgColor: string } {\n  if (listedNum >= 1000) {\n    return { label: \"Very Popular\", level: 5, color: \"text-green-700\", bgColor: \"bg-green-100\" };\n  }\n  if (listedNum >= 500) {\n    return { label: \"Popular\", level: 4, color: \"text-emerald-700\", bgColor: \"bg-emerald-100\" };\n  }\n  if (listedNum >= 100) {\n    return { label: \"Moderate Popularity\", level: 3, color: \"text-blue-700\", bgColor: \"bg-blue-100\" };\n  }\n  if (listedNum >= 20) {\n    return { label: \"Low Popularity\", level: 2, color: \"text-amber-700\", bgColor: \"bg-amber-100\" };\n  }\n  return { label: \"New\", level: 1, color: \"text-gray-700\", bgColor: \"bg-gray-100\" };\n}\n\nfunction PopularityDisplay({ listedNum }: { listedNum: number }) {\n  const info = getPopularityInfo(listedNum);\n  \n  return (\n    <div className=\"flex flex-col gap-3\">\n      <div className=\"flex items-center gap-4\">\n        <span className={`px-4 py-2 rounded-lg font-semibold ${info.bgColor} ${info.color}`}>\n          {info.label}\n        </span>\n        <span className=\"text-xl font-bold text-gray-800\">{listedNum.toLocaleString()}</span>\n        <span className=\"text-gray-500 text-sm\">times listed</span>\n      </div>\n      <div className=\"flex gap-1\">\n        {[1, 2, 3, 4, 5].map((i) => (\n          <div\n            key={i}\n            className={`h-2 w-8 rounded ${i <= info.level ? 'bg-amber-400' : 'bg-gray-200'}`}\n          />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nexport default function PreviewPageOne({ product }: PreviewPageOneProps) {\n  const uniqueSizes = product.availableSizes && product.availableSizes.length > 0\n    ? product.availableSizes\n    : [];\n  const uniqueColors = product.availableColors && product.availableColors.length > 0\n    ? product.availableColors\n    : [];\n  const uniqueModels = product.availableModels && product.availableModels.length > 0\n    ? product.availableModels\n    : [];\n\n  const imageCount = product.images?.length || 0;\n  const { rating, reviewCount } = calculateEstimatedRating(product.listedNum);\n  \n  console.log(`[PreviewPageOne] Product ${product.cjSku}: listedNum=${product.listedNum}, colors=${uniqueColors.length}, sizes=${uniqueSizes.length}, models=${uniqueModels.length}`);\n\n  return (\n    <div className=\"flex flex-col lg:flex-row gap-8 p-4\">\n      {/* Main Image Section */}\n      <div className=\"lg:w-1/2 flex flex-col items-center\">\n        <div className=\"relative w-full max-w-md aspect-square bg-gray-50 rounded-2xl overflow-hidden shadow-md border border-gray-100\">\n          {product.images?.[0] ? (\n            <img\n              src={product.images[0]}\n              alt=\"Product image\"\n              className=\"w-full h-full object-cover\"\n              onError={(e) => {\n                (e.target as HTMLImageElement).src = \"/placeholder-product.png\";\n              }}\n            />\n          ) : (\n            <div className=\"w-full h-full flex items-center justify-center\">\n              <ImageIcon className=\"h-20 w-20 text-gray-300\" />\n            </div>\n          )}\n        </div>\n        \n        {/* Image Count */}\n        <div className=\"mt-4 flex items-center gap-2 bg-blue-50 text-blue-700 px-4 py-2 rounded-full\">\n          <ImageIcon className=\"h-5 w-5\" />\n          <span className=\"font-medium\">{imageCount} images available</span>\n        </div>\n      </div>\n\n      {/* Product Details Section */}\n      <div className=\"lg:w-1/2 space-y-8\">\n        \n        {/* Rating */}\n        <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Star className=\"h-5 w-5 text-amber-500\" />\n            <span className=\"text-gray-500 font-medium\">Rating</span>\n          </div>\n          <StarRating rating={rating} reviewCount={reviewCount} />\n        </div>\n\n        {/* SKU */}\n        <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n          <div className=\"flex items-center gap-3 mb-3\">\n            <Tag className=\"h-5 w-5 text-blue-600\" />\n            <span className=\"text-gray-500 font-medium\">Product SKU</span>\n          </div>\n          <p className=\"font-mono text-2xl font-bold text-blue-700 bg-blue-50 px-4 py-3 rounded-lg\">\n            {product.cjSku}\n          </p>\n        </div>\n\n        {/* Colors */}\n        {uniqueColors.length > 0 && (\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <Palette className=\"h-5 w-5 text-pink-600\" />\n              <span className=\"text-gray-500 font-medium\">Available Colors</span>\n              <span className=\"text-sm text-gray-400\">({uniqueColors.length})</span>\n            </div>\n            <div className=\"flex flex-wrap gap-3\">\n              {uniqueColors.map((color, idx) => (\n                <span\n                  key={idx}\n                  className=\"bg-pink-50 text-pink-700 px-4 py-2 rounded-lg font-semibold text-lg border border-pink-200\"\n                >\n                  {color}\n                </span>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Compatible Devices/Models */}\n        {uniqueModels.length > 0 && (\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <Smartphone className=\"h-5 w-5 text-blue-600\" />\n              <span className=\"text-gray-500 font-medium\">Compatible Devices</span>\n              <span className=\"text-sm text-gray-400\">({uniqueModels.length})</span>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {uniqueModels.map((model, idx) => (\n                <span\n                  key={idx}\n                  className=\"bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg font-medium text-sm border border-blue-200\"\n                >\n                  {model}\n                </span>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* Sizes (for clothing/shoes) */}\n        {uniqueSizes.length > 0 && (\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n            <div className=\"flex items-center gap-3 mb-4\">\n              <Ruler className=\"h-5 w-5 text-purple-600\" />\n              <span className=\"text-gray-500 font-medium\">Available Sizes</span>\n              <span className=\"text-sm text-gray-400\">({uniqueSizes.length})</span>\n            </div>\n            <div className=\"flex flex-wrap gap-3\">\n              {uniqueSizes.map((size, idx) => (\n                <span\n                  key={idx}\n                  className=\"bg-purple-50 text-purple-700 px-4 py-2 rounded-lg font-semibold text-lg border border-purple-200\"\n                >\n                  {size}\n                </span>\n              ))}\n            </div>\n          </div>\n        )}\n\n        {/* No variants message */}\n        {uniqueColors.length === 0 && uniqueModels.length === 0 && uniqueSizes.length === 0 && (\n          <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n            <div className=\"flex items-center gap-3 mb-3\">\n              <Ruler className=\"h-5 w-5 text-purple-600\" />\n              <span className=\"text-gray-500 font-medium\">Available Sizes</span>\n            </div>\n            <p className=\"text-gray-400 text-lg\">One Size</p>\n          </div>\n        )}\n\n        {/* Category */}\n        <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n          <div className=\"flex items-center gap-3 mb-3\">\n            <FolderOpen className=\"h-5 w-5 text-green-600\" />\n            <span className=\"text-gray-500 font-medium\">Category</span>\n          </div>\n          <p className=\"text-lg text-gray-800 font-medium\">\n            {product.categoryName || \"Not specified\"}\n          </p>\n        </div>\n\n        {/* Popularity */}\n        <div className=\"bg-white rounded-xl border border-gray-200 p-6 shadow-sm\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <TrendingUp className=\"h-5 w-5 text-amber-500\" />\n            <span className=\"text-gray-500 font-medium\">Popularity</span>\n          </div>\n          <PopularityDisplay listedNum={product.listedNum} />\n        </div>\n\n        {/* Price - Single Final Sell Price */}\n        <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-6 shadow-sm\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <DollarSign className=\"h-5 w-5 text-green-600\" />\n            <span className=\"text-gray-600 font-medium\">Price</span>\n          </div>\n          {(() => {\n            // Calculate final sell price from first available variant (highest shipping)\n            const availableVariants = product.variants.filter(v => v.shippingAvailable);\n            const firstVariant = availableVariants[0];\n            \n            if (firstVariant) {\n              const productCostUSD = firstVariant.variantPriceUSD || 0;\n              const shippingCostUSD = firstVariant.shippingPriceUSD || 0;\n              const totalCostUSD = productCostUSD + shippingCostUSD;\n              const profitMargin = 0.08;\n              const sellPriceUSD = totalCostUSD / (1 - profitMargin);\n              \n              return (\n                <div className=\"text-center py-2\">\n                  <span className=\"text-4xl font-bold text-green-700\">\n                    ${sellPriceUSD.toFixed(2)}\n                  </span>\n                  <p className=\"text-sm text-gray-500 mt-2\">\n                    Final price (includes product, shipping & 8% margin)\n                  </p>\n                </div>\n              );\n            } else {\n              return (\n                <p className=\"text-gray-500 italic text-center\">Price unavailable</p>\n              );\n            }\n          })()}\n        </div>\n\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12572,"size_tokens":null},"src/components/admin/import/preview/PreviewPageThree.tsx":{"content":"\"use client\";\n\nimport type { ReactNode } from \"react\";\nimport { FileText, Ruler, Package, AlertCircle, Info, BookOpen, List } from \"lucide-react\";\nimport type { PricedProduct } from \"./types\";\n\ntype PreviewPageThreeProps = {\n  product: PricedProduct;\n};\n\ntype SectionCardProps = {\n  title: string;\n  icon: ReactNode;\n  children: ReactNode;\n  bgColor?: string;\n  borderColor?: string;\n  iconBgColor?: string;\n  iconColor?: string;\n  fullWidth?: boolean;\n};\n\nfunction SectionCard({ \n  title, \n  icon, \n  children, \n  bgColor = \"bg-white\",\n  borderColor = \"border-gray-200\",\n  iconBgColor = \"bg-blue-100\",\n  iconColor = \"text-blue-600\",\n  fullWidth = false,\n}: SectionCardProps) {\n  return (\n    <div className={`${bgColor} rounded-xl border ${borderColor} overflow-hidden shadow-sm hover:shadow-md transition-shadow ${fullWidth ? 'col-span-full' : ''}`}>\n      <div className=\"px-4 py-3 border-b border-gray-100 flex items-center gap-3\">\n        <div className={`${iconBgColor} ${iconColor} p-2 rounded-lg`}>\n          {icon}\n        </div>\n        <h3 className=\"text-base font-bold text-gray-800\">{title}</h3>\n      </div>\n      <div className=\"p-4\">\n        {children}\n      </div>\n    </div>\n  );\n}\n\nfunction HtmlContent({ html }: { html: string }) {\n  return (\n    <div \n      className=\"prose prose-sm max-w-none text-gray-700 leading-relaxed\n        [&_table]:w-full [&_table]:border-collapse [&_table]:my-3 [&_table]:text-sm\n        [&_th]:border [&_th]:border-gray-200 [&_th]:bg-gray-50 [&_th]:px-3 [&_th]:py-2 [&_th]:text-right [&_th]:font-semibold\n        [&_td]:border [&_td]:border-gray-200 [&_td]:px-3 [&_td]:py-2\n        [&_img]:max-w-full [&_img]:h-auto [&_img]:my-2 [&_img]:rounded-lg\n        [&_p]:mb-2 [&_ul]:list-disc [&_ul]:mr-4 [&_ol]:list-decimal [&_ol]:mr-4\n        [&_strong]:font-semibold [&_strong]:text-gray-800\"\n      dangerouslySetInnerHTML={{ __html: html }}\n    />\n  );\n}\n\nfunction NoDataFallback({ product }: { product?: PricedProduct }) {\n  // Even with no structured data, show basic info from product fields if available\n  const basicInfo: string[] = [];\n  if (product?.material) basicInfo.push(`Material: ${product.material}`);\n  if (product?.productWeight) basicInfo.push(`Weight: ${product.productWeight}g`);\n  if (product?.packLength && product?.packWidth && product?.packHeight) {\n    basicInfo.push(`Dimensions: ${product.packLength} × ${product.packWidth} × ${product.packHeight} cm`);\n  }\n  if (product?.categoryName) basicInfo.push(`Category: ${product.categoryName}`);\n  if (product?.hsCode) basicInfo.push(`HS Code: ${product.hsCode}`);\n  if (product?.originCountry) basicInfo.push(`Origin Country: ${product.originCountry}`);\n\n  if (basicInfo.length > 0) {\n    return (\n      <div className=\"bg-white rounded-xl border border-gray-200 p-6\">\n        <div className=\"flex items-center gap-3 mb-4\">\n          <div className=\"bg-blue-100 text-blue-600 p-2 rounded-lg\">\n            <Info className=\"h-5 w-5\" />\n          </div>\n          <h3 className=\"text-base font-bold text-gray-800\">Basic Information</h3>\n        </div>\n        <div className=\"space-y-2\">\n          {basicInfo.map((info, idx) => (\n            <p key={idx} className=\"text-gray-700 text-sm\">{info}</p>\n          ))}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col items-center justify-center py-16 px-8\">\n      <div className=\"bg-gray-100 p-4 rounded-full mb-4\">\n        <Info className=\"h-8 w-8 text-gray-400\" />\n      </div>\n      <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">No Additional Information</h3>\n      <p className=\"text-gray-400 text-center text-sm max-w-md\">\n        Detailed information for this product is not available from the supplier. You can add information manually after import.\n      </p>\n    </div>\n  );\n}\n\nexport default function PreviewPageThree({ product }: PreviewPageThreeProps) {\n  const hasDescription = product.description && product.description.trim().length > 0;\n  const hasOverview = product.overview && product.overview.trim().length > 0;\n  const hasProductInfo = product.productInfo && product.productInfo.trim().length > 0;\n  const hasSizeInfo = product.sizeInfo && product.sizeInfo.trim().length > 0;\n  const hasSizeChartImages = product.sizeChartImages && product.sizeChartImages.length > 0;\n  const hasProductNote = product.productNote && product.productNote.trim().length > 0;\n  const hasPackingList = product.packingList && product.packingList.trim().length > 0;\n  \n  const hasAnyContent = hasDescription || hasOverview || hasProductInfo || hasSizeInfo || hasSizeChartImages || hasProductNote || hasPackingList;\n\n  if (!hasAnyContent) {\n    return <NoDataFallback product={product} />;\n  }\n\n  return (\n    <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n      {hasDescription && (\n        <SectionCard\n          title=\"Product Description\"\n          icon={<BookOpen className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-indigo-100\"\n          iconBgColor=\"bg-indigo-50\"\n          iconColor=\"text-indigo-600\"\n          fullWidth\n        >\n          <HtmlContent html={product.description!} />\n        </SectionCard>\n      )}\n\n      {hasOverview && (\n        <SectionCard\n          title=\"Overview\"\n          icon={<List className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-teal-100\"\n          iconBgColor=\"bg-teal-50\"\n          iconColor=\"text-teal-600\"\n        >\n          <HtmlContent html={product.overview!} />\n        </SectionCard>\n      )}\n\n      {hasProductInfo && (\n        <SectionCard\n          title=\"Product Information\"\n          icon={<FileText className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-blue-100\"\n          iconBgColor=\"bg-blue-50\"\n          iconColor=\"text-blue-600\"\n        >\n          <HtmlContent html={product.productInfo!} />\n        </SectionCard>\n      )}\n\n      {(hasSizeInfo || hasSizeChartImages) && (\n        <SectionCard\n          title=\"Size Information\"\n          icon={<Ruler className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-purple-100\"\n          iconBgColor=\"bg-purple-50\"\n          iconColor=\"text-purple-600\"\n          fullWidth={hasSizeChartImages && (product.sizeChartImages?.length ?? 0) > 1}\n        >\n          <div className=\"space-y-4\">\n            {hasSizeInfo && (\n              <HtmlContent html={product.sizeInfo!} />\n            )}\n            {hasSizeChartImages && (\n              <div className={`grid gap-3 ${(product.sizeChartImages?.length ?? 0) > 1 ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1'}`}>\n                {product.sizeChartImages!.map((imgUrl, index) => (\n                  <div key={index} className=\"rounded-lg overflow-hidden border border-gray-100 bg-gray-50\">\n                    <img\n                      src={imgUrl}\n                      alt={`Size Chart ${index + 1}`}\n                      className=\"w-full h-auto object-contain\"\n                      loading=\"lazy\"\n                    />\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n        </SectionCard>\n      )}\n\n      {hasProductNote && (\n        <SectionCard\n          title=\"Product Notes\"\n          icon={<AlertCircle className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-amber-100\"\n          iconBgColor=\"bg-amber-50\"\n          iconColor=\"text-amber-600\"\n        >\n          <HtmlContent html={product.productNote!} />\n        </SectionCard>\n      )}\n\n      {hasPackingList && (\n        <SectionCard\n          title=\"Package Contents\"\n          icon={<Package className=\"h-5 w-5\" />}\n          bgColor=\"bg-white\"\n          borderColor=\"border-green-100\"\n          iconBgColor=\"bg-green-50\"\n          iconColor=\"text-green-600\"\n        >\n          <HtmlContent html={product.packingList!} />\n        </SectionCard>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7908,"size_tokens":null},"src/components/admin/import/preview/PreviewPageFive.tsx":{"content":"\"use client\";\n\nimport { Truck, Clock, DollarSign, CheckCircle, XCircle, MapPin, Timer, Package, TrendingUp } from \"lucide-react\";\nimport type { PricedProduct } from \"./types\";\n\ntype PreviewPageFiveProps = {\n  product: PricedProduct;\n};\n\nexport default function PreviewPageFive({ product }: PreviewPageFiveProps) {\n  const availableVariants = product.variants.filter((v) => v.shippingAvailable);\n  const unavailableVariants = product.variants.filter((v) => !v.shippingAvailable);\n\n  const minShipping = availableVariants.length > 0\n    ? Math.min(...availableVariants.map((v) => v.shippingPriceUSD))\n    : 0;\n  const maxShipping = availableVariants.length > 0\n    ? Math.max(...availableVariants.map((v) => v.shippingPriceUSD))\n    : 0;\n\n  const deliveryTimes = availableVariants\n    .map((v) => v.deliveryDays)\n    .filter((d) => d && d.trim() !== \"\" && d !== \"Unknown\");\n  const uniqueDeliveryTimes = [...new Set(deliveryTimes)];\n\n  const logisticNames = availableVariants\n    .map((v) => v.logisticName)\n    .filter((n): n is string => !!n && n.trim() !== \"\");\n  const uniqueLogistics = [...new Set(logisticNames)];\n\n  const availabilityRate = product.totalVariants > 0\n    ? Math.round((availableVariants.length / product.totalVariants) * 100)\n    : 0;\n\n  // CJPacket Ordinary only - no multiple shipping methods\n  const firstVariant = availableVariants[0];\n  const productCostUSD = firstVariant?.variantPriceUSD || 0;\n  const shippingCostUSD = firstVariant?.shippingPriceUSD || 0;\n  const totalCostUSD = productCostUSD + shippingCostUSD;\n  const profitMargin = 0.08;\n  const sellPriceUSD = totalCostUSD / (1 - profitMargin);\n  const profitUSD = sellPriceUSD - totalCostUSD;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl border border-indigo-200 p-5\">\n        <div className=\"flex items-center gap-3 mb-4\">\n          <DollarSign className=\"h-5 w-5 text-indigo-600\" />\n          <h3 className=\"text-lg font-bold text-indigo-900\">Price Breakdown (CJPacket Ordinary)</h3>\n        </div>\n        \n        {firstVariant ? (\n          <div className=\"space-y-4\">\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <div className=\"bg-white/70 rounded-lg p-4 text-center\">\n                <span className=\"text-xs text-gray-500 block mb-1\">Product Cost</span>\n                <span className=\"text-2xl font-bold text-gray-800\">${productCostUSD.toFixed(2)}</span>\n              </div>\n              <div className=\"bg-white/70 rounded-lg p-4 text-center\">\n                <span className=\"text-xs text-gray-500 block mb-1\">Shipping Cost</span>\n                <span className=\"text-2xl font-bold text-blue-600\">${shippingCostUSD.toFixed(2)}</span>\n              </div>\n              <div className=\"bg-white/70 rounded-lg p-4 text-center\">\n                <span className=\"text-xs text-gray-500 block mb-1\">Total Cost</span>\n                <span className=\"text-2xl font-bold text-orange-600\">${totalCostUSD.toFixed(2)}</span>\n              </div>\n              <div className=\"bg-white/70 rounded-lg p-4 text-center\">\n                <span className=\"text-xs text-gray-500 block mb-1\">Sell Price</span>\n                <span className=\"text-2xl font-bold text-green-600\">${sellPriceUSD.toFixed(2)}</span>\n              </div>\n            </div>\n            \n            <div className=\"bg-green-100 rounded-lg p-4 flex items-center justify-between\">\n              <div className=\"flex items-center gap-2\">\n                <TrendingUp className=\"h-5 w-5 text-green-600\" />\n                <span className=\"text-green-800 font-medium\">Your Profit (8% margin)</span>\n              </div>\n              <span className=\"text-3xl font-bold text-green-700\">${profitUSD.toFixed(2)}</span>\n            </div>\n            \n            {firstVariant.logisticName && (\n              <div className=\"text-sm text-indigo-600 flex items-center gap-2\">\n                <Truck className=\"h-4 w-4\" />\n                <span>Selected: {firstVariant.logisticName} ({firstVariant.deliveryDays})</span>\n              </div>\n            )}\n            <div className=\"text-xs text-gray-500 mt-2 italic\">\n              * Using highest shipping cost variant for 100% accuracy with CJ website\n            </div>\n          </div>\n        ) : (\n          <p className=\"text-indigo-600 italic\">No pricing data available</p>\n        )}\n      </div>\n\n      {(product.estimatedProcessingDays || product.estimatedDeliveryDays) && (\n        <div className=\"bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl border border-amber-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Timer className=\"h-5 w-5 text-amber-600\" />\n            <h3 className=\"text-lg font-bold text-amber-900\">Processing & Handling Time</h3>\n          </div>\n          <div className=\"grid grid-cols-2 gap-4\">\n            {product.estimatedProcessingDays && (\n              <div className=\"bg-white/70 rounded-lg px-4 py-3\">\n                <span className=\"text-sm text-amber-700 block mb-1\">Processing Time</span>\n                <span className=\"text-lg font-bold text-amber-800\">{product.estimatedProcessingDays}</span>\n              </div>\n            )}\n            {product.estimatedDeliveryDays && (\n              <div className=\"bg-white/70 rounded-lg px-4 py-3\">\n                <span className=\"text-sm text-amber-700 block mb-1\">Delivery Cycle</span>\n                <span className=\"text-lg font-bold text-amber-800\">{product.estimatedDeliveryDays}</span>\n              </div>\n            )}\n          </div>\n          {product.originCountry && (\n            <div className=\"mt-3 flex items-center gap-2 text-sm text-amber-700\">\n              <Package className=\"h-4 w-4\" />\n              <span>Origin Country: {product.originCountry}</span>\n            </div>\n          )}\n        </div>\n      )}\n\n      <div className=\"grid md:grid-cols-2 gap-5\">\n        <div className=\"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border border-blue-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <Clock className=\"h-5 w-5 text-blue-600\" />\n            <h3 className=\"text-lg font-bold text-blue-900\">Delivery Time</h3>\n          </div>\n\n          {uniqueDeliveryTimes.length > 0 ? (\n            <div className=\"space-y-2\">\n              {uniqueDeliveryTimes.map((time, idx) => (\n                <div\n                  key={idx}\n                  className=\"bg-white/70 rounded-lg px-4 py-2 text-blue-800 font-medium\"\n                >\n                  {time}\n                </div>\n              ))}\n            </div>\n          ) : product.estimatedDeliveryDays ? (\n            <div className=\"bg-white/70 rounded-lg px-4 py-2 text-blue-800 font-medium\">\n              {product.estimatedDeliveryDays}\n            </div>\n          ) : (\n            <p className=\"text-blue-600 italic\">Not specified</p>\n          )}\n        </div>\n\n        <div className=\"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border border-green-200 p-5\">\n          <div className=\"flex items-center gap-3 mb-4\">\n            <DollarSign className=\"h-5 w-5 text-green-600\" />\n            <h3 className=\"text-lg font-bold text-green-900\">Shipping Cost Range</h3>\n          </div>\n\n          {availableVariants.length > 0 ? (\n            <div className=\"space-y-3\">\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-green-700\">Minimum:</span>\n                <span className=\"text-xl font-bold text-green-800\">\n                  ${minShipping.toFixed(2)}\n                </span>\n              </div>\n              <div className=\"flex justify-between items-center\">\n                <span className=\"text-green-700\">Maximum:</span>\n                <span className=\"text-xl font-bold text-green-800\">\n                  ${maxShipping.toFixed(2)}\n                </span>\n              </div>\n            </div>\n          ) : (\n            <p className=\"text-green-600 italic\">No shipping options available</p>\n          )}\n        </div>\n      </div>\n\n      <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n        <div className=\"flex items-center gap-3 mb-5\">\n          <Truck className=\"h-5 w-5 text-purple-500\" />\n          <h3 className=\"text-lg font-bold text-gray-900\">Selected Shipping Provider</h3>\n        </div>\n\n        {uniqueLogistics.length > 0 ? (\n          <div className=\"flex flex-wrap gap-2\">\n            {uniqueLogistics.map((name, idx) => (\n              <span\n                key={idx}\n                className=\"bg-purple-50 text-purple-700 px-4 py-2 rounded-lg font-medium border border-purple-200\"\n              >\n                {name}\n              </span>\n            ))}\n          </div>\n        ) : (\n          <p className=\"text-gray-400 italic\">Not specified</p>\n        )}\n      </div>\n\n      <div className=\"bg-white rounded-xl border border-gray-200 p-5\">\n        <div className=\"flex items-center gap-3 mb-5\">\n          <MapPin className=\"h-5 w-5 text-orange-500\" />\n          <h3 className=\"text-lg font-bold text-gray-900\">Shipping Availability to USA</h3>\n        </div>\n\n        <div className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <span className=\"text-gray-600\">Availability Rate:</span>\n            <span className=\"text-2xl font-bold text-gray-900\">{availabilityRate}%</span>\n          </div>\n\n          <div className=\"w-full bg-gray-200 rounded-full h-3\">\n            <div\n              className={`h-3 rounded-full transition-all ${\n                availabilityRate === 100\n                  ? \"bg-green-500\"\n                  : availabilityRate >= 50\n                  ? \"bg-blue-500\"\n                  : availabilityRate > 0\n                  ? \"bg-amber-500\"\n                  : \"bg-red-500\"\n              }`}\n              style={{ width: `${availabilityRate}%` }}\n            />\n          </div>\n\n          <div className=\"grid grid-cols-2 gap-4 mt-4\">\n            <div className=\"bg-green-50 rounded-lg p-4 border border-green-200\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <CheckCircle className=\"h-4 w-4 text-green-600\" />\n                <span className=\"text-sm text-green-700\">Available for Shipping</span>\n              </div>\n              <span className=\"text-2xl font-bold text-green-800\">\n                {availableVariants.length}\n              </span>\n              <span className=\"text-sm text-green-600 ml-1\">variants</span>\n            </div>\n\n            <div className=\"bg-red-50 rounded-lg p-4 border border-red-200\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <XCircle className=\"h-4 w-4 text-red-600\" />\n                <span className=\"text-sm text-red-700\">Not Available</span>\n              </div>\n              <span className=\"text-2xl font-bold text-red-800\">\n                {unavailableVariants.length}\n              </span>\n              <span className=\"text-sm text-red-600 ml-1\">variants</span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11156,"size_tokens":null},"src/components/admin/import/preview/types.ts":{"content":"export type ShippingOption = {\n  name: string;\n  code: string;\n  priceUSD: number;\n  deliveryDays: string;\n};\n\nexport type PricedVariant = {\n  variantId: string;\n  variantSku: string;\n  variantPriceUSD: number;\n  shippingAvailable: boolean;\n  shippingPriceUSD: number;\n  shippingPriceSAR: number;\n  deliveryDays: string;\n  logisticName?: string;\n  sellPriceSAR: number;\n  totalCostSAR: number;\n  profitSAR: number;\n  error?: string;\n  stock?: number;\n  cjStock?: number;\n  factoryStock?: number;\n  variantName?: string;\n  variantImage?: string;\n  size?: string;\n  color?: string;\n  allShippingOptions?: ShippingOption[];\n};\n\nexport type WarehouseStock = {\n  areaId: number;\n  areaName: string;\n  countryCode: string;\n  totalInventory: number;\n  cjInventory: number;\n  factoryInventory: number;\n};\n\nexport type ProductInventory = {\n  totalCJ: number;\n  totalFactory: number;\n  totalAvailable: number;\n  warehouses: WarehouseStock[];\n};\n\nexport type InventoryVariant = {\n  variantId: string;\n  sku: string;\n  shortName: string;\n  priceUSD: number;\n  cjStock: number;\n  factoryStock: number;\n  totalStock: number;\n};\n\nexport type PricedProduct = {\n  pid: string;\n  cjSku: string;\n  name: string;\n  images: string[];\n  minPriceSAR: number;\n  maxPriceSAR: number;\n  avgPriceSAR: number;\n  stock: number;\n  listedNum: number;\n  totalVerifiedInventory?: number;\n  totalUnVerifiedInventory?: number;\n  inventory?: ProductInventory;\n  inventoryStatus?: 'ok' | 'error' | 'partial';\n  inventoryErrorMessage?: string;\n  variants: PricedVariant[];\n  inventoryVariants?: InventoryVariant[];\n  successfulVariants: number;\n  totalVariants: number;\n  description?: string;\n  overview?: string;\n  productInfo?: string;\n  sizeInfo?: string;\n  productNote?: string;\n  packingList?: string;\n  rating?: number;\n  reviewCount?: number;\n  categoryName?: string;\n  productWeight?: number;\n  packLength?: number;\n  packWidth?: number;\n  packHeight?: number;\n  material?: string;\n  productType?: string;\n  sizeChartImages?: string[];\n  processingTimeHours?: number;\n  deliveryTimeHours?: number;\n  estimatedProcessingDays?: string;\n  estimatedDeliveryDays?: string;\n  originCountry?: string;\n  hsCode?: string;\n  videoUrl?: string;\n  availableSizes?: string[];\n  availableColors?: string[];\n  availableModels?: string[];\n};\n","path":null,"size_bytes":2297,"size_tokens":null}},"version":2}